var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,i=(t,a,o)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[a]=o,l=(e,t)=>{for(var a in t||(t={}))n.call(t,a)&&i(e,a,t[a]);if(o)for(var a of o(t))s.call(t,a)&&i(e,a,t[a]);return e},r=(e,o)=>t(e,a(o));import{d as c,y as d,r as u,o as p,t as y,b as f,e as g,f as m,h as b,j as h,k as v,l as w,x as I,n as x,q as S,F as _,a as C,G as k,i as T,w as P,s as V,v as $,g as j,at as D,c as A,a3 as O,a4 as N,a9 as B,aa as U,V as L,p as F}from"./index-7e9c327e.js";import{C as W,P as M}from"./PayStatusDialog-9d0b7522.js";import{_ as z}from"./plugin-vue_export-helper-46f75680.js";const R=c({name:"PayDialog",components:{},props:{visible:{type:Boolean,default:!1},versionInfo:{type:Object,default:null}},emits:["close","update","contact"],setup(e,t){const{proxy:a}=j(),o=d();let n=u({payTypeList:[{value:"0",label:"支付宝",icon:"alipay",color:"#447df6"},{value:"1",label:"微信",icon:"wx",color:"#2cac30"}],payInfo:{payType:"0",status:"0",outTradeNo:"",totalAmount:"",subject:"",version:"",uid:"",orderType:""},loading:!1,dialogVisible:e.visible,wxPayData:null});const s=C((()=>e=>new URL(`svg/${e}.svg`,window.location.href).href));let i={handleSelect(e,t){n.payInfo.payType=e.value},handleClose(){n.dialogVisible=!1,t.emit("close")},handleGenerateOrder(){n.payInfo.outTradeNo=k();const e=a.$bmob.Query("Order");e.set("payType",n.payInfo.payType),e.set("status",n.payInfo.status),e.set("subject",n.payInfo.subject),e.set("totalAmount",n.payInfo.totalAmount),e.set("uid",n.payInfo.uid),e.set("version",n.payInfo.version),e.set("outTradeNo",n.payInfo.outTradeNo),e.set("orderType",n.payInfo.orderType),e.save().then((async e=>{"0"===n.payInfo.payType?i.handleAliPay(e):i.handleWxPay()})).catch((e=>{n.loading=!1,a.$message.error("购买失败，请联系作者")}))},async handleAliPay(e){try{let t=r(l({},e),{returnUrl:window.location.origin+"/price"}),o=T()?"wap":"page";const n=await a.$http.alipay(t,o);i.handleClose(),window.open(n.data.url,"_blank")}catch(t){n.loading=!1,a.$message.error("跳转支付失败，请联系作者")}},async handleWxPay(){try{let e=n.payInfo.outTradeNo,t=Math.floor((new Date).getTime()/1e3),o=P({mch_id:a.$config.WX_MCH_ID,out_trade_no:e,total_fee:n.payInfo.totalAmount,body:n.payInfo.subject,timestamp:String(t),notify_url:"https://api.zwpyyds.com/px/api/wxpay/notify"},a.$config.WX_KEY),s={mch_id:a.$config.WX_MCH_ID,out_trade_no:e,total_fee:n.payInfo.totalAmount,body:n.payInfo.subject,timestamp:String(t),notify_url:"https://api.zwpyyds.com/px/api/wxpay/notify",return_url:`${window.location.origin}/price?payType=wx&out_trade_no=${e}`,sign:o,time_expire:"2m"};const i=await a.$http.wxPay(s);n.loading=!1,0===i.data.code?window.open(i.data.data,"_blank"):a.$message.error("请求支付失败，请联系作者")}catch(e){n.loading=!1,a.$message.error("请求支付失败，请联系作者")}},async handleConfirm(){if(o.checkIsLogin())return i.handleClose();n.loading=!0,i.handleGenerateOrder()}};return p((()=>{n.payInfo.subject=e.versionInfo.subject,n.payInfo.totalAmount=e.versionInfo.totalAmount,n.payInfo.uid=e.versionInfo.uid,n.payInfo.version=e.versionInfo.version,n.payInfo.orderType=e.versionInfo.orderType})),r(l(l({},y(n)),i),{getIcon:s})}}),E={class:"flex-between full-w",style:{margin:"20px 0"}},G={style:{margin:"10px 0"}},X={class:"page-box"},q=["onClick"],H=["src"],J={class:"dialog-footer"};var K=c({name:"price",components:{ContactAuthorDialog:W,PayDialog:z(R,[["render",function(e,t,a,o,n,s){const i=f("el-button"),l=f("el-dialog");return g(),m(l,{modelValue:e.dialogVisible,"onUpdate:modelValue":t[0]||(t[0]=t=>e.dialogVisible=t),title:"升级"+e.payInfo.subject,"before-close":e.handleClose,class:"z-dialog",center:"","close-on-click-modal":!1,width:350},{footer:b((()=>[h("span",J,[v(i,{onClick:e.handleClose},{default:b((()=>t[3]||(t[3]=[w("取 消")]))),_:1,__:[3]},8,["onClick"]),v(i,{type:"primary",onClick:e.handleConfirm,loading:e.loading},{default:b((()=>t[4]||(t[4]=[w("确 定")]))),_:1,__:[4]},8,["onClick","loading"])])])),default:b((()=>[h("div",E,[t[1]||(t[1]=h("p",null,"支付金额",-1)),h("p",null,"￥"+I(e.payInfo.totalAmount),1)]),h("div",G,[t[2]||(t[2]=h("p",null,"支付类型",-1)),h("div",X,[(g(!0),x(_,null,S(e.payTypeList,((t,a)=>(g(),x("div",{class:V(["page-icon flex-column-center pointer",{active:a==e.payInfo.payType}]),key:t.value,onClick:o=>e.handleSelect(t,a)},[h("img",{src:e.getIcon(t.icon),style:$({backgroundColor:t.color})},null,12,H),h("span",null,I(t.label),1)],10,q)))),128))])])])),_:1},8,["modelValue","title","before-close"])}],["__scopeId","data-v-1c8bdc26"]]),PayStatusDialog:M},props:{},emits:[],setup(e,t){const a=d(),{proxy:o}=j();let n=u({priceList:[],visible:!1,count:0,versionInfo:{subject:"",totalAmount:"",version:"",orderType:"",uid:""},buyVisible:!1,isloading:!1,loadingText:"正在加载",payStatusVisible:!1,payStatus:!1,payStatusContent:"",contactMsg:"请添加作者微信购买密钥（备注 - 像素格子）"});const s=C((()=>function(e){return 0===e?{backgroundColor:"#ebb105d9",color:"#ffffff"}:1===e?{backgroundColor:"#00a870d9",color:"#ffffff"}:2===e?{backgroundColor:"#0052d9d9",color:"#ffffff"}:3===e?{backgroundColor:"#f56c6cd9",color:"#fff"}:{backgroundColor:"#f1f1f1d9",color:"#7f7f7f"}})),i=C((()=>function(e){return 1===e?"success":2===e?"primary":3===e?"danger":void 0}));let c={handleContactAuthor(e){n.contactMsg=e,a.contactAuthorVisible=!0},handleFinishPay(e){n.payStatus=e.data.status,n.payStatusContent=e.data.content,n.payStatusVisible=!0},async handleBuy(e,t){if(A())return a.contactAuthorVisible=!0;if(!a.checkIsLogin()){if(1===e.id&&"0"===t)return o.$message.warning("当前版本无需升级");if("0"===t)try{let s=await a.getRemoteUserInfo(o,a.userData.objectId);if(a.saveUserInfo(s),a.userData.vip==e.id-1)o.$message.warning("当前版本无需升级");else if(e.id-1>a.userData.vip){let o=n.priceList.find((e=>e.id-1==a.userData.vip)),s=o.disCountPrice?o.disCountPrice:o.price,i=e.disCountPrice?e.disCountPrice:e.price,l=s.slice(1),r=parseFloat((Number(i.slice(1))-Number(l)).toFixed(1));n.versionInfo={subject:e.label,totalAmount:String(r),version:String(e.id-1),orderType:t,uid:a.userData.uid},n.buyVisible=!0}}catch(s){o.$message.error("网络异常")}"1"===t&&(n.versionInfo={subject:`云备份数量套餐（${e.cloudBackupPrice.split("/")[1]}）`,totalAmount:e.cloudBackupPrice.split("/")[0].slice(1),version:e.cloudBackupPrice.split("/")[1].split("(")[0],orderType:t,uid:a.userData.uid},n.buyVisible=!0)}},handleOpen(e){a.contactAuthorVisible=!0},getData(){O.get(`${N()}json/price.json`).then((e=>{n.priceList=e.data})).catch((e=>{o.$message.error(e)}))},getBmobData(){const e=o.$bmob.Query("Key");e.equalTo("isUse","==","1"),e.count().then((e=>{n.count=50-(e.count-2)})).catch((e=>{}))},async handleWxPayStatus(e){if(e.out_trade_no)try{n.isloading=!0,n.loadingText="正在处理订单...",delete e.payType;let t=JSON.parse(JSON.stringify(e));const s=await o.$http.wxPayVerify(t);if(s.data.status){o.$message.success(s.data.msg);let e=await a.getRemoteUserInfo(o,a.userData.objectId);a.saveUserInfo(e)}else o.$message.error(s.data.msg);n.payStatus=s.data.status,n.payStatusContent=s.data.content||s.data.msg,n.payStatusVisible=!0,n.isloading=!1,window.localStorage.setItem("orderNo",e.out_trade_no)}catch(t){o.$message.error("订单查询异常，请联系作者解决"),n.isloading=!1}},async handleBuyStatus(){let e=window.location.search?decodeURIComponent(window.location.search.substring(1)):"";if(""===e)return;let t=B(e);if(!window.localStorage.getItem("orderNo")||window.localStorage.getItem("orderNo")!==t.out_trade_no)if("wx"!==t.payType){if(t.out_trade_no)try{n.isloading=!0,n.loadingText="正在处理订单...";const e=await o.$http.alipayVerify(window.location.search);if(e.data.status){o.$message.success(e.data.msg);let t=await a.getRemoteUserInfo(o,a.userData.objectId);a.saveUserInfo(t)}else o.$message.error(e.data.msg);n.payStatus=e.data.status,n.payStatusContent=e.data.content||e.data.msg,n.payStatusVisible=!0,n.isloading=!1,window.localStorage.setItem("orderNo",t.out_trade_no)}catch(s){o.$message.error("订单查询异常，请联系作者解决"),n.isloading=!1}}else c.handleWxPayStatus(t)}};return p((()=>{c.getData(),c.handleBuyStatus()})),r(l(l({},y(n)),c),{Download:D,editSpaceStore:a,computedStyle:s,computedType:i})}});const Q=["element-loading-text"],Y={key:0,style:{"margin-bottom":"20px",padding:"0 20px"},class:"full-w"},Z={class:"price-title flex-center"},ee={class:"flex-column-center price-content full-w"},te={class:"flex-between full-w"},ae={class:"version-name"},oe={key:0,class:"price-box"},ne={key:1,class:"price-box"},se={class:"price-delete"},ie={style:{"font-size":"1rem","margin-top":"10px","line-height":"1.5"},class:"full-w text-justify"},le={class:"flex-end full-w"},re={class:"flex-column-center",style:{gap:"20px","margin-top":"30px"}},ce={class:"flex-center flex-nowarp",style:{gap:"5px"}};var de=z(K,[["render",function(e,t,a,o,n,s){const i=f("van-notice-bar"),l=f("van-divider"),r=f("el-button"),c=f("ContactAuthorDialog"),d=f("PayDialog"),u=f("PayStatusDialog"),p=U("loading");return L((g(),x("div",{class:"full-layout scrollbar routerview flex-center section-1","element-loading-text":e.loadingText,"element-loading-background":"#00000020"},[(new Date).getTime()>17450784e5&&(new Date).getTime()<17463744e5?(g(),x("div",Y,[v(i,{class:"full-w notice-tag",color:"#ffffff",background:"#EBB105","left-icon":"volume-o",scrollable:"",text:"2025/4/20 至 2025/5/5，版本限时优惠特价，专业版 （￥12.9/永久）高级版（￥23.9/永久）"})])):F("",!0),h("div",Z,[h("h2",null,I(e.$t("message.purchaseNotes")),1)]),h("div",ee,[(g(!0),x(_,null,S(e.priceList,(a=>(g(),x("div",{class:"price-item flex-center full-w",key:a.id,style:$(e.computedStyle(a.id))},[h("div",te,[h("p",ae,I(a.label),1),a.disCountPrice?(g(),x("div",ne,[h("span",se,I(a.price),1),w(" "+I(a.disCountPrice)+"/永久 ",1)])):(g(),x("div",oe,I(a.price)+"/永久 ",1))]),h("div",ie,"包含服务： "+I(a.content),1),a.id>1?(g(),m(l,{key:0,dashed:"",class:"full-w"})):F("",!0),h("div",le,[a.id>1?(g(),m(r,{key:0,type:e.computedType(a.id),onClick:t=>e.handleBuy(a,"0")},{default:b((()=>t[4]||(t[4]=[w("去升级")]))),_:2,__:[4]},1032,["type","onClick"])):F("",!0)])],4)))),128))]),h("div",re,[t[6]||(t[6]=h("h2",{style:{"font-size":"1.8rem"}}," 云备份数量套餐 ",-1)),h("div",ce,[(g(!0),x(_,null,S(e.priceList,(a=>(g(),x("div",{class:"cloudCount-item flex-column-center",key:a.id,style:$(e.computedStyle(a.id))},[h("div",null,I(a.cloudBackupPrice),1),h("div",null,[v(r,{type:e.computedType(a.id),onClick:t=>e.handleBuy(a,"1")},{default:b((()=>t[5]||(t[5]=[w("去购买")]))),_:2,__:[5]},1032,["type","onClick"])])],4)))),128))])]),e.editSpaceStore.contactAuthorVisible?(g(),m(c,{key:1,visible:e.editSpaceStore.contactAuthorVisible,onClose:t[0]||(t[0]=t=>e.editSpaceStore.contactAuthorVisible=!1),msg:e.contactMsg},null,8,["visible","msg"])):F("",!0),e.buyVisible?(g(),m(d,{key:2,visible:e.buyVisible,onFinish:e.handleFinishPay,onClose:t[1]||(t[1]=t=>e.buyVisible=!1),onContact:t[2]||(t[2]=t=>e.editSpaceStore.contactAuthorVisible=!0),versionInfo:e.versionInfo},null,8,["visible","onFinish","versionInfo"])):F("",!0),e.payStatusVisible?(g(),m(u,{key:3,content:e.payStatusContent,visible:e.payStatusVisible,onClose:t[3]||(t[3]=t=>e.payStatusVisible=!1),payStatus:e.payStatus,onContact:e.handleContactAuthor},null,8,["content","visible","payStatus","onContact"])):F("",!0)],8,Q)),[[p,e.isloading]])}],["__scopeId","data-v-dc2f03f0"]]);export{de as default};
