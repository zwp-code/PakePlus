var e=Object.defineProperty,a=Object.defineProperties,t=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,i=(a,t,l)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[t]=l,o=(e,a)=>{for(var t in a||(a={}))n.call(a,t)&&i(e,t,a[t]);if(l)for(var t of l(a))r.call(a,t)&&i(e,t,a[t]);return e},s=(e,l)=>a(e,t(l));import{c,E as d,M as h,a as u,P as g,R as p,b as m,L as y,d as f,U as v,S as C,V as w,e as x,u as L,p as D,_ as S,f as b,g as I,h as k,i as R,j as M,k as F,l as P,m as B,n as A,o as T,q as O,r as j,s as E,t as H,v as W,w as $,x as V,y as z,z as Y,A as X,B as U,C as N,D as _,F as K,G,H as J,I as q,J as Z,K as Q,N as ee,O as ae,Q as te,T as le,W as ne,X as re,Y as ie,Z as oe,$ as se,a0 as ce,a1 as de,a2 as he,a3 as ue,a4 as ge,a5 as pe,a6 as me,a7 as ye,a8 as fe,a9 as ve,aa as Ce,ab as we,ac as xe,ad as Le,ae as De,af as Se,ag as be,ah as Ie,ai as ke,aj as Re,ak as Me,al as Fe,am as Pe,an as Be,ao as Ae,ap as Te,aq as Oe}from"./pica-e7209953.js";import{_ as je,d as Ee,A as He,r as We,o as $e,t as Ve,b as ze,l as Ye,k as Xe,O as Ue,P as Ne,j as _e,n as Ke,h as Ge,q as Je,X as qe,F as Ze,x as Qe,y as ea,e as aa,z as ta,v as la,g as na,aa as ra,D as ia,ag as oa,E as sa,a7 as ca,s as da,N as ha,a2 as ua,p as ga,f as pa,aT as ma,c as ya,V as fa,aG as va,az as Ca,aA as wa,a8 as xa,aS as La,C as Da,K as Sa,ay as ba,u as Ia,aX as ka,aZ as Ra,bn as Ma,bo as Fa,bp as Pa,b0 as Ba,b1 as Aa,b4 as Ta,aU as Oa,aV as ja,aK as Ea,bq as Ha,b3 as Wa,br as $a,bs as Va,b5 as za,aO as Ya,b6 as Xa,bt as Ua,bu as Na,at as _a,bv as Ka,b7 as Ga,b8 as Ja,bw as qa,ae as Za,aE as Qa,ax as et,aD as at,bx as tt,by as lt,bz as nt,aC as rt,ba as it,b9 as ot,T as st,ah as ct}from"./index-371f133f.js";import{u as dt}from"./useWindow-4404eab5.js";import{w as ht}from"./windowHeader-812834b0.js";import{W as ut}from"./worker-cecf3bdf.js";import{r as gt}from"./xlsx-eef54bab.js";import{e as pt}from"./binary-10212f2f.js";const mt=Ee({name:"CanvasRotateDialog",components:{windowHeader:ht},props:{visible:{type:Boolean,default:!1},selected:{type:String,default:""}},emits:["close","confirm"],setup(e,a){const t=dt();He();let l=We({dataSource:{id:4,name:"旋转",type:"slot",isIsland:!1,isOut:!1,link:"",component:"CanvasRotateDialog",background:"",icon:""},dialogVisible:!1,rotateAngle:90,imageSmoothingEnabled:!0,loading:!1}),n={handleSelect(){t.methods.handleSelect(l.dataSource)},handleZoom(){t.methods.handleZoom(l.dataSource)},handleClose(){l.dialogVisible=!1,l.rotateAngle=90,a.emit("close")},handleHide(){l.dialogVisible=!1,a.emit("close")},handleOpen(){l.dialogVisible=!0,n.handleSelect()},handleConfirm(){l.loading=!0,a.emit("confirm",{rotateAngle:l.rotateAngle},(()=>l.loading=!1))}};return $e((()=>{})),o(o({},Ve(l)),n)}}),yt=e=>(Qe("data-v-f49f813c"),e=e(),ea(),e),ft={style:{padding:"6px",height:"calc(100% - 40px)"}},vt={class:"full-layout-1 scrollbar"},Ct={class:"content scrollbar"},wt={class:"full-w flex-between"},xt=yt((()=>_e("p",null,"旋转角度",-1))),Lt={class:"flex-center full-w footer-btn"},Dt=yt((()=>_e("div",{style:{display:"none"},class:"absolute-full"},null,-1)));var St=je(mt,[["render",function(e,a,t,l,n,r){const i=ze("windowHeader"),o=ze("el-input-number"),s=ze("el-button");return aa(),Ye(Ze,null,[Xe(' <el-dialog v-model="dialogVisible" title="旋转"\r\n    :width="300"\r\n    draggable="true"\r\n    :modal="false"\r\n    :lock-scroll="false"\r\n    :close-on-click-modal="false"\r\n    :before-close="handleClose"\r\n    class="z-dialog z-dialog-1" center> '),Ue(_e("div",{onClick:a[1]||(a[1]=a=>e.handleSelect(e.dataSource)),class:Je({window:!0,"window-active":e.dataSource.id===e.selected}),onContextmenu:a[2]||(a[2]=qe((()=>{}),["stop"]))},[Ke(i,{value:e.dataSource,onHide:e.handleHide,onZoom:e.handleZoom,onClose:e.handleClose},null,8,["value","onHide","onZoom","onClose"]),_e("div",ft,[_e("div",vt,[_e("div",Ct,[_e("div",wt,[xt,Ke(o,{modelValue:e.rotateAngle,"onUpdate:modelValue":a[0]||(a[0]=a=>e.rotateAngle=a),min:-360,max:360},null,8,["modelValue"])]),Xe(' <div class="full-w flex-between">\r\n                        <p>启用抗锯齿</p>\r\n                        <el-switch v-model="imageSmoothingEnabled"></el-switch>\r\n                    </div> '),_e("div",Lt,[Ke(s,{onClick:e.handleClose},{default:Ge((()=>[ta(la(e.$t("message.cancel")),1)])),_:1},8,["onClick"]),Ke(s,{type:"primary",onClick:e.handleConfirm,loading:e.loading},{default:Ge((()=>[ta(la(e.$t("message.confirm")),1)])),_:1},8,["onClick","loading"])])]),Dt])])],34),[[Ne,e.dialogVisible]]),Xe(" </el-dialog> ")],2112)}],["__scopeId","data-v-f49f813c"],["__file","D:/project/pixel-grid/src/components/dialog/CanvasRotateDialog.vue"]]);const bt=Ee({name:"IntelligentStrokeDialog",components:{windowHeader:ht},props:{visible:{type:Boolean,default:!1},selected:{type:String,default:""}},emits:["close","confirm"],setup(e,a){const t=dt();let{proxy:l}=na();He();let n=We({dataSource:{id:7,name:"智能描边",type:"slot",isIsland:!1,isOut:!1,link:"",component:"IntelligentStrokeDialog",background:"",icon:""},dialogVisible:!1,strokeColor:"#000000",loading:!1}),r={handleSelect(){t.methods.handleSelect(n.dataSource)},handleZoom(){t.methods.handleZoom(n.dataSource)},handleClose(){n.dialogVisible=!1,a.emit("close"),n.strokeColor="#000000"},handleHide(){n.dialogVisible=!1,a.emit("close")},handleOpen(){n.dialogVisible=!0,r.handleSelect()},handleConfirm(){if(""===n.strokeColor.trim())return l.$message.warning("颜色不能为空");a.emit("confirm",{strokeColor:n.strokeColor})}};return $e((()=>{})),o(o({},Ve(n)),r)}}),It=e=>(Qe("data-v-6e9bafe0"),e=e(),ea(),e),kt={style:{padding:"6px",height:"calc(100% - 40px)"}},Rt={class:"full-layout-1 scrollbar"},Mt={class:"content scrollbar"},Ft={class:"color flex-center"},Pt=It((()=>_e("p",null,"描边颜色",-1))),Bt={class:"flex-center full-w footer-btn"},At=It((()=>_e("div",{style:{display:"none"},class:"absolute-full"},null,-1)));var Tt=je(bt,[["render",function(e,a,t,l,n,r){const i=ze("windowHeader"),o=ze("el-color-picker"),s=ze("el-button");return aa(),Ye(Ze,null,[Xe(' <el-dialog v-model="dialogVisible" title="智能描边"\r\n    :width="300"\r\n    draggable="true"\r\n    :modal="false"\r\n    :lock-scroll="false"\r\n    :close-on-click-modal="false"\r\n    :before-close="handleClose"\r\n    class="z-dialog z-dialog-1" center> '),Ue(_e("div",{onClick:a[2]||(a[2]=a=>e.handleSelect(e.dataSource)),class:Je({window:!0,"window-active":e.dataSource.id===e.selected}),onContextmenu:a[3]||(a[3]=qe((()=>{}),["stop"]))},[Ke(i,{value:e.dataSource,onHide:e.handleHide,onZoom:e.handleZoom,onClose:e.handleClose},null,8,["value","onHide","onZoom","onClose"]),_e("div",kt,[_e("div",Rt,[_e("div",Mt,[_e("div",Ft,[Pt,Ke(o,{modelValue:e.strokeColor,"onUpdate:modelValue":a[0]||(a[0]=a=>e.strokeColor=a),onActiveChange:a[1]||(a[1]=a=>e.strokeColor=a)},null,8,["modelValue"])]),_e("div",Bt,[Ke(s,{onClick:e.handleClose},{default:Ge((()=>[ta(la(e.$t("message.cancel")),1)])),_:1},8,["onClick"]),Ke(s,{type:"primary",onClick:e.handleConfirm,loading:e.loading},{default:Ge((()=>[ta(la(e.$t("message.confirm")),1)])),_:1},8,["onClick","loading"])])]),At])])],34),[[Ne,e.dialogVisible]]),Xe(' <template #footer>\r\n            <span class="dialog-footer">\r\n                <el-button  @click="handleClose"\r\n                >{{ $t(\'message.cancel\') }}</el-button>\r\n                <el-button type="primary" @click="handleConfirm" :loading="loading"\r\n                >{{ $t(\'message.confirm\') }}</el-button>\r\n            </span>\r\n        </template>\r\n    </el-dialog> ')],2112)}],["__scopeId","data-v-6e9bafe0"],["__file","D:/project/pixel-grid/src/components/dialog/IntelligentStrokeDialog.vue"]]);const Ot=Ee({name:"IntelligentSliceDialog",components:{windowHeader:ht},props:{visible:{type:Boolean,default:!1},canvasOptions:{type:Object,default:()=>({canvasHeight:1,canvasWidth:1})},selected:{type:String,default:""}},emits:["close","confirm","change"],setup(e,a){const t=dt();He();let l=We({dataSource:{id:6,name:"智能切片",type:"slot",isIsland:!1,isOut:!1,link:"",component:"IntelligentSliceDialog",background:"",icon:""},dialogVisible:!1,vCount:1,hCount:1,loading:!1}),n={handleSelect(){t.methods.handleSelect(l.dataSource)},handleZoom(){t.methods.handleZoom(l.dataSource)},handleClose(){l.dialogVisible=!1,a.emit("close"),n.handleCloseSlice()},handleHide(){l.dialogVisible=!1,a.emit("close")},handleOpen(){l.dialogVisible=!0,n.handleSelect()},handleCloseSlice(){l.vCount=1,l.hCount=1,n.handleChange()},handleConfirm(){l.loading=!0,a.emit("confirm",{vCount:l.vCount,hCount:l.hCount},(()=>l.loading=!1))},handleChange(){a.emit("change",{vCount:l.vCount,hCount:l.hCount})}};return $e((()=>{})),o(o({},Ve(l)),n)}}),jt=e=>(Qe("data-v-7a660a6a"),e=e(),ea(),e),Et={style:{padding:"6px",height:"calc(100% - 40px)"}},Ht={class:"full-layout-1 scrollbar"},Wt={class:"content scrollbar"},$t={class:"color flex-center"},Vt=jt((()=>_e("p",null,"水平切片",-1))),zt={class:"color flex-center"},Yt=jt((()=>_e("p",null,"垂直切片",-1))),Xt={class:"flex-center full-w footer-btn"},Ut=ta("取消切片"),Nt=ta("导出切片"),_t=jt((()=>_e("div",{style:{display:"none"},class:"absolute-full"},null,-1)));var Kt=je(Ot,[["render",function(e,a,t,l,n,r){var i,o;const s=ze("windowHeader"),c=ze("el-input-number"),d=ze("el-button");return aa(),Ye(Ze,null,[Xe(' <el-dialog v-model="dialogVisible" title="智能切片"\r\n    :width="300"\r\n    draggable="true"\r\n    :modal="false"\r\n    :lock-scroll="false"\r\n    :close-on-click-modal="false"\r\n    :before-close="handleClose"\r\n    class="z-dialog z-dialog-1" center> '),Ue(_e("div",{onClick:a[4]||(a[4]=a=>e.handleSelect(e.dataSource)),class:Je({window:!0,"window-active":e.dataSource.id===e.selected}),onContextmenu:a[5]||(a[5]=qe((()=>{}),["stop"]))},[Ke(s,{value:e.dataSource,onHide:e.handleHide,onZoom:e.handleZoom,onClose:e.handleClose},null,8,["value","onHide","onZoom","onClose"]),_e("div",Et,[_e("div",Ht,[_e("div",Wt,[_e("div",$t,[Vt,Ke(c,{modelValue:e.hCount,"onUpdate:modelValue":a[0]||(a[0]=a=>e.hCount=a),onChange:a[1]||(a[1]=a=>e.handleChange(a,"h")),max:(null==(i=e.canvasOptions)?void 0:i.canvasHeight)||1,min:1},null,8,["modelValue","max"])]),_e("div",zt,[Yt,Ke(c,{modelValue:e.vCount,"onUpdate:modelValue":a[2]||(a[2]=a=>e.vCount=a),onChange:a[3]||(a[3]=a=>e.handleChange(a,"v")),max:(null==(o=e.canvasOptions)?void 0:o.canvasWidth)||1,min:1},null,8,["modelValue","max"])]),_e("div",Xt,[Ke(d,{onClick:e.handleClose},{default:Ge((()=>[Ut])),_:1},8,["onClick"]),Ke(d,{type:"primary",onClick:e.handleConfirm,loading:e.loading},{default:Ge((()=>[Nt])),_:1},8,["onClick","loading"])])]),_t])])],34),[[Ne,e.dialogVisible]]),Xe(' <template #footer>\r\n            <span class="dialog-footer">\r\n                <el-button  @click="handleClose"\r\n                >取消切片</el-button>\r\n                <el-button type="primary" @click="handleConfirm" :loading="loading"\r\n                >导出切片</el-button>\r\n            </span>\r\n        </template>\r\n    </el-dialog> ')],2112)}],["__scopeId","data-v-7a660a6a"],["__file","D:/project/pixel-grid/src/components/dialog/IntelligentSliceDialog.vue"]]);const Gt={name:"SpriteMenu",props:{visible:{type:Boolean,default:!1},left:{type:Number,default:0},top:{type:Number,default:0}},components:{},emits:["delete"],setup(e,a){let t=We({timer:null,newTop:e.top,newLeft:e.left}),l={handleDelete(){a.emit("delete")}};return $e((()=>{let a=document.body.offsetHeight,l=document.body.offsetWidth,n=document.querySelector("#contextMenu");e.top+n.offsetHeight>a?t.newTop=a-n.offsetHeight:e.left+n.offsetWidth>l&&(t.newLeft=l-5-n.offsetWidth)})),o(o({},Ve(t)),l)}},Jt=(e=>(Qe("data-v-2e5a90b4"),e=e(),ea(),e))((()=>_e("span",null,"删 除",-1)));const qt=Ee({name:"SpriteDialog",components:{SpriteMenu:je(Gt,[["render",function(e,a,t,l,n,r){const i=ze("Delete"),o=ze("el-icon");return t.visible?(aa(),Ye("ul",{key:0,id:"contextMenu",style:da({left:e.newLeft+"px",top:e.newTop+"px"}),class:"contextmenu"},[_e("li",{class:"flex-between",onClick:a[0]||(a[0]=(...a)=>e.handleDelete&&e.handleDelete(...a))},[Jt,Ke(o,null,{default:Ge((()=>[Ke(i)])),_:1})])],4)):Xe("v-if",!0)}],["__scopeId","data-v-2e5a90b4"],["__file","D:/project/pixel-grid/src/components/menu/SpriteMenu.vue"]]),windowHeader:ht},props:{visible:{type:Boolean,default:!1},selected:{type:String,default:""}},emits:["import"],setup(e,a){const t=dt();let{proxy:l}=na();const n=He();let r=We({dataSource:{id:5,name:"精灵资源",type:"slot",isIsland:!1,isOut:!1,link:"",component:"SpriteDialog",background:"",icon:""},dialogVisible:!1,loading:!1,currentSelectData:null,SpriteMenu:{visible:!1,top:0,left:0,contextData:null}}),i={handleSelect(){t.methods.handleSelect(r.dataSource)},handleZoom(){t.methods.handleZoom(r.dataSource)},closeMenu(){r.SpriteMenu.visible=!1},handleContextMenu(e,a){var t,l;r.SpriteMenu.visible=!0;let n=(null==(t=document.querySelector(".sprite-dialog"))?void 0:t.getBoundingClientRect().left)||0,o=(null==(l=document.querySelector(".sprite-dialog"))?void 0:l.getBoundingClientRect().top)||0;i.closeMenu(),setTimeout((()=>{r.SpriteMenu.visible=!0,r.SpriteMenu.left=e.clientX-n,r.SpriteMenu.top=e.clientY-o,r.SpriteMenu.contextData=a}),100)},handleDelete(){n.deleteSpriteById(r.SpriteMenu.contextData.id).then((e=>{l.$message.success("删除成功")})).catch((e=>{l.$message.error("删除失败")}))},handleOpen(){r.dialogVisible=!0,i.handleSelect()},handleClose(){r.dialogVisible=!1},handleImport(){r.currentSelectData&&a.emit("import",r.currentSelectData.spriteImg)},handleSelectSpirit(e){r.currentSelectData=e.data},getData(){r.loading=!0,n.getSpriteList().then((e=>{n.spriteList=e||[],r.loading=!1})).catch((e=>{l.$message.error("获取精灵资源失败")}))}};return ha((()=>{document.removeEventListener("click",i.closeMenu)})),$e((()=>{i.getData(),document.addEventListener("click",i.closeMenu)})),s(o(o({},Ve(r)),i),{editSpaceStore:n})}}),Zt=e=>(Qe("data-v-3f83c614"),e=e(),ea(),e),Qt={style:{padding:"6px",height:"calc(100% - 40px)"}},el={class:"full-layout-1 scrollbar"},al={class:"content scrollbar"},tl={class:"grid-content"},ll={class:"flex-center full-w footer-btn"},nl=ta("导 入"),rl=Zt((()=>_e("div",{style:{display:"none"},class:"absolute-full"},null,-1)));var il=Ee({name:"draw",components:{MyColorDialog:h,ExportDialog:u,PreviewAnimDialog:g,ReplaceColorDialog:p,PindouDialog:m,LayerMenu:y,LinmoModeDialog:f,UploadImageLayerDialog:v,"sketch-picker":C,VueDragScale:w,MyColorMenu:x,CanvasRotateDialog:St,SpriteDialog:je(qt,[["render",function(e,a,t,l,n,r){const i=ze("windowHeader"),o=ze("el-image"),s=ze("el-button"),c=ze("SpriteMenu"),d=ua("loading");return aa(),Ye(Ze,null,[Xe(' <el-dialog \r\n    v-model="dialogVisible" \r\n    title="精灵资源"\r\n    :width="500"\r\n    :lock-scroll="false"\r\n    :before-close="handleClose"\r\n    :close-on-click-modal="false"\r\n    :modal="false"\r\n    draggable="true"\r\n    class="z-dialog z-dialog-1 sprite-dialog" center> '),Ue(_e("div",{onClick:a[0]||(a[0]=a=>e.handleSelect(e.dataSource)),class:Je(["sprite-dialog",{window:!0,"window-active":e.dataSource.id===e.selected}]),onContextmenu:a[1]||(a[1]=qe((()=>{}),["stop"]))},[Ke(i,{value:e.dataSource,onHide:e.handleClose,onZoom:e.handleZoom,onClose:e.handleClose},null,8,["value","onHide","onZoom","onClose"]),_e("div",Qt,[_e("div",el,[Ue((aa(),Ye("div",al,[_e("div",tl,[(aa(!0),Ye(Ze,null,ga(e.editSpaceStore.spriteList,(a=>(aa(),pa(o,{onContextmenu:qe((t=>e.handleContextMenu(t,a)),["prevent"]),style:{width:"100px",height:"100px"},key:a.id,src:a.data.spriteImg,onClick:t=>e.handleSelectSpirit(a),class:Je({active:!!e.currentSelectData&&e.currentSelectData.spriteID===a.data.spriteID}),fit:"contain"},null,8,["onContextmenu","src","onClick","class"])))),128))]),_e("div",ll,[Ke(s,{onClick:e.handleClose},{default:Ge((()=>[ta(la(e.$t("message.cancel")),1)])),_:1},8,["onClick"]),Ke(s,{type:"primary",onClick:e.handleImport},{default:Ge((()=>[nl])),_:1},8,["onClick"])])])),[[d,e.loading]]),rl])]),e.SpriteMenu.visible?(aa(),pa(c,{key:0,visible:e.SpriteMenu.visible,left:e.SpriteMenu.left,top:e.SpriteMenu.top,onDelete:e.handleDelete},null,8,["visible","left","top","onDelete"])):Xe("v-if",!0)],34),[[Ne,e.dialogVisible]]),Xe(" </el-dialog> ")],2112)}],["__scopeId","data-v-3f83c614"],["__file","D:/project/pixel-grid/src/components/dialog/SpriteDialog.vue"]]),IntelligentStrokeDialog:Tt,IntelligentSliceDialog:Kt},props:{},emits:[],setup(e,a){const t=dt(),{proxy:l}=na(),n=function(){We({canvasWidth:0,canvasHeight:0});const e={handleFilter(a,t,l,n){1===a?e.transformBlackAndWhite(t,l):2===a?e.transformReverse(t,l):3===a&&e.transformBGRA(t,l)},transformBlackAndWhite(e,a){const t=e.layerCtx.getImageData(0,0,e.layerCanvas.width,e.layerCanvas.height),l=t.data;for(let n=0;n<l.length;n+=4){if(0===l[n+3])continue;let e=(l[n]+l[n+1]+l[n+2])/3;l[n]=e,l[n+1]=e,l[n+2]=e}a(t)},transformReverse(e,a){const t=e.layerCtx.getImageData(0,0,e.layerCanvas.width,e.layerCanvas.height),l=t.data;for(let n=0;n<l.length;n+=4){if(0===l[n+3])continue;let e=l[n],a=l[n+1],t=l[n+2];l[n]=255-e,l[n+1]=255-a,l[n+2]=255-t}a(t)},transformBGRA(e,a){const t=e.layerCtx.getImageData(0,0,e.layerCanvas.width,e.layerCanvas.height),l=t.data;for(let n=0;n<l.length;n+=4){if(0===l[n+3])continue;let e=l[n];l[n+1];let a=l[n+2];l[n]=a,l[n+2]=e}a(t)},transformIndexColor(e,a,t,l,n){let r=a.length>0?a:e;n.postMessage({type:8,currentIndexColorList:JSON.parse(JSON.stringify(c[l])),variables:JSON.parse(JSON.stringify(r))}),n.onmessage=e=>{t(e.data.variables)}}};return o({},e)}(),r=function(){const e=We({excelPinDouOptions:{1:{numberFontSize:4,rulerFontSize:6,pointFontSize:12,colWidth:1.36,rowHeight:7.9},2:{numberFontSize:6,rulerFontSize:10,pointFontSize:12,colWidth:2.66,rowHeight:14.8}}}),a={convertToExcelPosition({x:e,y:a}){let t="",l=e+1;for(;l>0;){let e=l%26;0===e?(t="Z"+t,l=Math.floor(l/26)-1):(t=String.fromCharCode(64+e)+t,l=Math.floor(l/26))}return t+(a+1)},handleExcelToPixel(e,t,l,n){if(!e)return l("文件不存在");const r=new FileReader;r.onload=function(e){const l=new Uint8Array(e.target.result),r=gt(l,{type:"array",cellStyles:!0});let i=r.SheetNames[0];const o=r.Sheets[i],s=document.createElement("canvas"),c=s.getContext("2d");let d=c.createImageData(n.canvasWidth,n.canvasHeight),h=d.data;for(let t=0;t<n.canvasHeight;t++)for(let e=0;e<n.canvasWidth;e++){let l="",r=a.convertToExcelPosition({x:e,y:t});if(l=o[r]&&o[r].s.fgColor?"#"+o[r].s.fgColor.rgb+"ff":"#00000000","#00000000"===l)continue;let i=ra(l),s=4*(e+t*n.canvasWidth);h[s]=i[0],h[s+1]=i[1],h[s+2]=i[2],h[s+3]=255*i[3]}c.putImageData(d,0,0),t({tempCanvas:s,tempCtx:c})},r.readAsArrayBuffer(e)},async handlePixelToExcel(e,a,t,l){const n=new d.Workbook;n.creator="by 像素格子",n.lastModifiedBy="by 像素格子";const r={},i=document.createElement("canvas");i.width=a.canvasWidth,i.height=a.canvasHeight;const o=i.getContext("2d"),s=(e,t,l)=>{const n=4*(t*a.canvasWidth+e);return ia([l[n],l[n+1],l[n+2],l[n+3]])};for(let c=0;c<e.length;c++){r[`frame${c+1}`]=n.addWorksheet(`frame${c+1}`);let t=[],l=[],d=0;o.clearRect(0,0,a.canvasWidth,a.canvasHeight);for(let n=e[c].layer.length-1;n>=0;n--)if(e[c].layer[n].isRender){let r=e[c].layer[n].layerId;o.drawImage(a.layerData[r].layerCanvas,0,0,i.width,i.height);for(let t=0;t<e[c].layer[n].mindLayerList.length;t++){let l=a.layerData[r].mindLayerList[e[c].layer[n].mindLayerList[t]];l.isHide||o.drawImage(l.mindCanvas,l.left,l.top)}let h=o.getImageData(0,0,a.canvasWidth,a.canvasHeight).data;for(let e=0;e<a.canvasHeight;e++){0===d&&(l[e]=[],t[e]=[]);for(let n=0;n<a.canvasWidth;n++){let a=s(n,e,h);0===d?(l[e][n]=a,t[e][n]=""):l[e][n]&&"#00000000"!==a&&(l[e][n]=a)}}d++}for(let e=0;e<t.length;e++)r[`frame${c+1}`].addRow(t[e]);for(let e=0;e<t[0].length;e++)r[`frame${c+1}`]._columns[e].width=3;r[`frame${c+1}`].eachRow(((e,t)=>{e.height=18,e.eachCell(((e,n)=>{if(a.isShowGrid){let t="FF",l=a.gridColor.slice(1).toUpperCase();e.border={top:{style:"thin",color:{argb:`${t}${l}`}},left:{style:"thin",color:{argb:`${t}${l}`}},bottom:{style:"thin",color:{argb:`${t}${l}`}},right:{style:"thin",color:{argb:`${t}${l}`}}}}let r=l[t-1][n-1];if("#00000000"!==r){let a=r.slice(7).toUpperCase(),t=r.slice(1,7).toUpperCase();e.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${a}${t}`}}}else if(a.isShowGrid){let t=a.gridBackgroundColor,l=t.slice(7).toUpperCase(),n=t.slice(1,7).toUpperCase();e.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${l}${n}`}}}}))}))}n.xlsx.writeBuffer().then((e=>{let l=new Blob([e],{type:"application/octet-stream"});oa.saveAs(l,a.filename+".xlsx"),t("导出成功")})).catch((e=>{l("导出失败")}))},handlePindouToExcel2(t,l){let{isShowGrid:n,isShowRulers:r,isShowCirclePoint:i,isShowRectPoint:o,rulersBackgroundColor:s,pointColor:c,rulersColor:h,gridColor:u,canvasWidth:g,canvasHeight:p,filename:m,excelSize:y,isShowTongji:f,isShowBrand:v,brandName:C,background:w,type:x,pindouWidth:L,pindouHeight:D,pindouScale:S,currentPindouIndex:b}=l;return new Promise(((g,p)=>{s=ia(sa(s)),w=ia(sa(w));const x=new d.Workbook;x.creator="by 像素格子",x.lastModifiedBy="by 像素格子";const S=(e,a,t)=>{const n=4*(a*l.pindouWidth+e);return ia([t[n],t[n+1],t[n+2],t[n+3]])},I=(e,a)=>{const n=a*l.pindouWidth+e;return t[b].colorArr[n]},k=x.addWorksheet(`拼豆${b+1}`);let R=[],M=[],F=0,P=t[b].blockArr;for(let e=0;e<D;e++){0===F&&(M[e]=[],R[e]=[]);for(let a=0;a<L;a++){let t=S(a,e,P),l=I(a,e);0===F?(M[e][a]=t,R[e][a]="#"!==l?l:i?"•":o?"▪":""):(M[e][a]&&"#00000000"!==t&&(M[e][a]=t),R[e][a]&&"#"!==l&&(R[e][a]=l))}}if(F++,r){let e=[];for(let a=0;a<L+2;a++){let t="";t=0===a||a===L+1?"":a+"",e.push(t)}k.addRow(e)}for(let e=0;e<R.length;e++){let a=String(e+1);k.addRow([a,...R[e],a])}if(r){let e=[];for(let a=0;a<L+2;a++){let t="";t=0===a||a===L+1?"":a+"",e.push(t)}k.addRow(e)}for(let a=0;a<R[0].length+2;a++)k._columns[a].width=e.excelPinDouOptions[y].colWidth;if(k.eachRow(((a,t)=>{a.height=e.excelPinDouOptions[y].rowHeight,!r||1!==t&&t!==D+2?a.eachCell(((a,l)=>{if(a.alignment={vertical:"middle",horizontal:"center"},n){let e="FF"+u.slice(1,7).toUpperCase();a.border={top:{style:"thin",color:{argb:`${e}`}},left:{style:"thin",color:{argb:`${e}`}},bottom:{style:"thin",color:{argb:`${e}`}},right:{style:"thin",color:{argb:`${e}`}}}}if(1===l||l===L+2){let t=s;if("#00000000"!==t){let e=t.slice(7).toUpperCase(),l=t.slice(1,7).toUpperCase();a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${e}${l}`}}}let l="FF"+h.slice(1,7).toUpperCase();a.font={name:"Microsoft YaHei UI",color:{argb:l},size:e.excelPinDouOptions[y].rulerFontSize}}else{let n=w.slice(7).toUpperCase(),r=w.slice(1,7).toUpperCase();a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${n}${r}`}};let i=M[t-2][l-2],o=R[t-2][l-2];if("#00000000"!==i){let t=i.slice(7).toUpperCase(),l=i.slice(1,7).toUpperCase();if(a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${t}${l}`}},o){let t=e.excelPinDouOptions[y].numberFontSize,l="#FFF"===ca(i)?"FFFFFFFF":"FF000000";o.length>=4&&(t-=1),a.font={name:"Microsoft YaHei UI",color:{argb:l},size:t}}}else{let t="FF"+c.slice(1,7).toUpperCase();a.font={name:"Microsoft YaHei UI",color:{argb:t},size:e.excelPinDouOptions[y].pointFontSize}}}})):a.eachCell(((a,t)=>{if(n){let e="FF"+u.slice(1,7).toUpperCase();a.border={top:{style:"thin",color:{argb:`${e}`}},left:{style:"thin",color:{argb:`${e}`}},bottom:{style:"thin",color:{argb:`${e}`}},right:{style:"thin",color:{argb:`${e}`}}}}a.alignment={vertical:"middle",horizontal:"center"};let l=s;if("#00000000"!==l){let e=l.slice(7).toUpperCase(),t=l.slice(1,7).toUpperCase();a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${e}${t}`}}}let r="FF"+h.slice(1,7).toUpperCase();a.font={name:"Microsoft YaHei UI",color:{argb:r},size:e.excelPinDouOptions[y].rulerFontSize}}))})),v){k.addRow([C]),k.lastRow.height=12;let e=a.convertToExcelPosition({x:k.columnCount-1,y:k.rowCount-1});k.mergeCells(`A${k.rowCount}:${e}`);const t=k.getCell(`A${D+3}`);t.font={name:"Arial",size:8,bold:!0,color:{argb:"FF101010"}},t.alignment={vertical:"middle",horizontal:"center"},t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFF00"}}}if(f){let e=t[b].colorStatList,l=Math.floor((L+2)/2),n=Math.ceil(e.size/l),r=Array.from(e),i=[],o=[],s=[],c=0;for(let a=0;a<n;a++){i[a]=[],o[a]=[],s[a]=[];for(let e=0;e<2*l&&!(c>r.length-1);e+=2)i[a][e]=r[c][1][0],s[a][e]=r[c][1][1]+"",o[a][e]=r[c][0],i[a][e+1]="",s[a][e+1]="",o[a][e+1]="",c++;k.addRow([...o[a]]),k.addRow([...s[a]])}const d=k.rowCount;for(let t=0;t<d-(D+3);t++)for(let e=0;e<L+2;e+=2){let l=D+3+t+1,n=a.convertToExcelPosition({x:e,y:l-1}),r=a.convertToExcelPosition({x:e+1,y:l-1});if(e+1>L+2-1)break;k.mergeCells(`${n}:${r}`)}for(let a=0;a<d-(D+3);a++){let e=D+3+(a+1),t=k.getRow(e);t.height=13,t.eachCell(((e,t)=>{if(e.alignment={vertical:"middle",horizontal:"center"},a%2==0&&t%2!=0){if(t>i[a/2].length)return;let l=t-1,n=i[a/2][l],r=o[a/2][l],s=n.slice(1,7).toUpperCase();if(e.fill={type:"pattern",pattern:"solid",fgColor:{argb:`FF${s}`}},r){let a=6,t="#FFF"===ca(n)?"FFFFFFFF":"FF000000";r.length>=4&&(a-=1),e.font={name:"Microsoft YaHei UI",color:{argb:t},size:a}}}let l="ffffff";const n=e.fill;n&&n.fgColor&&(l=n.fgColor.argb.slice(2));let r="#FFF"===ca(l)?"FFFFFFFF":"FF000000";e.font={name:"Microsoft YaHei UI",color:{argb:r},size:6}}))}}k.addRow(["图纸来源 像素格子"]),k.lastRow.height=15;let B=a.convertToExcelPosition({x:k.columnCount-1,y:k.rowCount});k.mergeCells(`A${k.rowCount}:${B}`);const A=k.getCell(`A${k.rowCount}`);A.font={name:"Arial",size:10,bold:!0,color:{argb:"FFFFFFFF"}},A.alignment={vertical:"middle",horizontal:"center"},A.fill={type:"pattern",pattern:"solid",fgColor:{argb:"0052D9"}},x.xlsx.writeBuffer().then((e=>{let a=new Blob([e],{type:"application/octet-stream"});oa.saveAs(a,m+".xlsx"),g(!0)})).catch((e=>{p(e)}))}))},handlePindouToExcel3(t,l){let{isShowGrid:n,isShowRulers:r,isShowCirclePoint:i,isShowRectPoint:o,rulersBackgroundColor:s,pointColor:c,rulersColor:h,gridColor:u,canvasWidth:g,canvasHeight:p,filename:m,excelSize:y,isShowTongji:f,isShowBrand:v,brandName:C,background:w,type:x,pindouWidth:L,pindouHeight:D,pindouScale:S,currentPindouIndex:b}=l;return new Promise(((g,p)=>{s=ia(sa(s)),w=ia(sa(w));const x=new d.Workbook;x.creator="by 像素格子",x.lastModifiedBy="by 像素格子";const S={},b=(e,a,t)=>{const n=4*(a*l.pindouWidth+e);return ia([t[n],t[n+1],t[n+2],t[n+3]])},I=(e,a,n)=>{const r=a*l.pindouWidth+e;return t[n].colorArr[r]};for(let l=0;l<t.length;l++){S[`拼豆分块${l+1}`]=x.addWorksheet(`拼豆分块${l+1}`);let d=[],g=[],p=0,m=t[l].blockArr;for(let e=0;e<D;e++){0===p&&(g[e]=[],d[e]=[]);for(let a=0;a<L;a++){let t=b(a,e,m),n=I(a,e,l);0===p?(g[e][a]=t,d[e][a]="#"!==n?n:i?"•":o?"▪":""):(g[e][a]&&"#00000000"!==t&&(g[e][a]=t),d[e][a]&&"#"!==n&&(d[e][a]=n))}}if(p++,r){let e=[];for(let a=0;a<L+2;a++){let t="";t=0===a||a===L+1?"":a+"",e.push(t)}S[`拼豆分块${l+1}`].addRow(e)}for(let e=0;e<d.length;e++){let a=String(e+1);S[`拼豆分块${l+1}`].addRow([a,...d[e],a])}if(r){let e=[];for(let a=0;a<L+2;a++){let t="";t=0===a||a===L+1?"":a+"",e.push(t)}S[`拼豆分块${l+1}`].addRow(e)}for(let a=0;a<d[0].length+2;a++)S[`拼豆分块${l+1}`]._columns[a].width=e.excelPinDouOptions[y].colWidth;if(S[`拼豆分块${l+1}`].eachRow(((a,t)=>{a.height=e.excelPinDouOptions[y].rowHeight,!r||1!==t&&t!==D+2?a.eachCell(((a,l)=>{if(a.alignment={vertical:"middle",horizontal:"center"},n){let e="FF"+u.slice(1,7).toUpperCase();a.border={top:{style:"thin",color:{argb:`${e}`}},left:{style:"thin",color:{argb:`${e}`}},bottom:{style:"thin",color:{argb:`${e}`}},right:{style:"thin",color:{argb:`${e}`}}}}if(1===l||l===L+2){let t=s;if("#00000000"!==t){let e=t.slice(7).toUpperCase(),l=t.slice(1,7).toUpperCase();a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${e}${l}`}}}let l="FF"+h.slice(1,7).toUpperCase();a.font={name:"Microsoft YaHei UI",color:{argb:l},size:e.excelPinDouOptions[y].rulerFontSize}}else{let n=w.slice(7).toUpperCase(),r=w.slice(1,7).toUpperCase();a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${n}${r}`}};let i=g[t-2][l-2],o=d[t-2][l-2];if("#00000000"!==i){let t=i.slice(7).toUpperCase(),l=i.slice(1,7).toUpperCase();if(a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${t}${l}`}},o){let t=e.excelPinDouOptions[y].numberFontSize,l="#FFF"===ca(i)?"FFFFFFFF":"FF000000";o.length>=4&&(t-=1),a.font={name:"Microsoft YaHei UI",color:{argb:l},size:t}}}else{let t="FF"+c.slice(1,7).toUpperCase();a.font={name:"Microsoft YaHei UI",color:{argb:t},size:e.excelPinDouOptions[y].pointFontSize}}}})):a.eachCell(((a,t)=>{if(n){let e="FF"+u.slice(1,7).toUpperCase();a.border={top:{style:"thin",color:{argb:`${e}`}},left:{style:"thin",color:{argb:`${e}`}},bottom:{style:"thin",color:{argb:`${e}`}},right:{style:"thin",color:{argb:`${e}`}}}}a.alignment={vertical:"middle",horizontal:"center"};let l=s;if("#00000000"!==l){let e=l.slice(7).toUpperCase(),t=l.slice(1,7).toUpperCase();a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${e}${t}`}}}let r="FF"+h.slice(1,7).toUpperCase();a.font={name:"Microsoft YaHei UI",color:{argb:r},size:e.excelPinDouOptions[y].rulerFontSize}}))})),v){S[`拼豆分块${l+1}`].addRow([C]),S[`拼豆分块${l+1}`].lastRow.height=12;let e=a.convertToExcelPosition({x:S[`拼豆分块${l+1}`].columnCount-1,y:S[`拼豆分块${l+1}`].rowCount-1});S[`拼豆分块${l+1}`].mergeCells(`A${S[`拼豆分块${l+1}`].rowCount}:${e}`);const t=S[`拼豆分块${l+1}`].getCell(`A${D+3}`);t.font={name:"Arial",size:8,bold:!0,color:{argb:"FF101010"}},t.alignment={vertical:"middle",horizontal:"center"},t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFF00"}}}if(f){let e=t[l].colorStatList,n=Math.floor((L+2)/2),r=Math.ceil(e.size/n),i=Array.from(e),o=[],s=[],c=[],d=0;for(let a=0;a<r;a++){o[a]=[],s[a]=[],c[a]=[];for(let e=0;e<2*n&&!(d>i.length-1);e+=2)o[a][e]=i[d][1][0],c[a][e]=i[d][1][1]+"",s[a][e]=i[d][0],o[a][e+1]="",c[a][e+1]="",s[a][e+1]="",d++;S[`拼豆分块${l+1}`].addRow([...s[a]]),S[`拼豆分块${l+1}`].addRow([...c[a]])}const h=S[`拼豆分块${l+1}`].rowCount;for(let t=0;t<h-(D+3);t++)for(let e=0;e<L+2;e+=2){let n=D+3+t+1,r=a.convertToExcelPosition({x:e,y:n-1}),i=a.convertToExcelPosition({x:e+1,y:n-1});if(e+1>L+2-1)break;S[`拼豆分块${l+1}`].mergeCells(`${r}:${i}`)}for(let a=0;a<h-(D+3);a++){let e=D+3+(a+1),t=S[`拼豆分块${l+1}`].getRow(e);t.height=13,t.eachCell(((e,t)=>{if(e.alignment={vertical:"middle",horizontal:"center"},a%2==0&&t%2!=0){if(t>o[a/2].length)return;let l=t-1,n=o[a/2][l],r=s[a/2][l],i=n.slice(1,7).toUpperCase();if(e.fill={type:"pattern",pattern:"solid",fgColor:{argb:`FF${i}`}},r){let a=6,t="#FFF"===ca(n)?"FFFFFFFF":"FF000000";r.length>=4&&(a-=1),e.font={name:"Microsoft YaHei UI",color:{argb:t},size:a}}}let l="ffffff";const n=e.fill;n&&n.fgColor&&(l=n.fgColor.argb.slice(2));let r="#FFF"===ca(l)?"FFFFFFFF":"FF000000";e.font={name:"Microsoft YaHei UI",color:{argb:r},size:6}}))}}S[`拼豆分块${l+1}`].addRow(["图纸来源 像素格子"]),S[`拼豆分块${l+1}`].lastRow.height=15;let k=a.convertToExcelPosition({x:S[`拼豆分块${l+1}`].columnCount-1,y:S[`拼豆分块${l+1}`].rowCount});S[`拼豆分块${l+1}`].mergeCells(`A${S[`拼豆分块${l+1}`].rowCount}:${k}`);const R=S[`拼豆分块${l+1}`].getCell(`A${S[`拼豆分块${l+1}`].rowCount}`);R.font={name:"Arial",size:10,bold:!0,color:{argb:"FFFFFFFF"}},R.alignment={vertical:"middle",horizontal:"center"},R.fill={type:"pattern",pattern:"solid",fgColor:{argb:"0052D9"}}}x.xlsx.writeBuffer().then((e=>{let a=new Blob([e],{type:"application/octet-stream"});oa.saveAs(a,m+".xlsx"),g(!0)})).catch((e=>{p(e)}))}))},async handlePindouToExcel(e,t){let{type:l}=t;if(0===l)return a.handlePindouToExcel2(e,t);if(1===l)return a.handlePindouToExcel3(e,t);if(2===l){const l=document.createElement("canvas"),n=l.getContext("2d");l.width=t.canvasWidth,l.height=t.canvasHeight;let r=new Map,i=[];for(let a=0;a<e.length;a++){const l=a%Math.ceil(t.canvasWidth/t.pindouWidth),o=Math.floor(a/Math.ceil(t.canvasWidth/t.pindouWidth)),s=document.createElement("canvas"),c=s.getContext("2d");s.width=t.pindouWidth,s.height=t.pindouHeight;let d=new ImageData(e[a].blockArr,t.pindouWidth,t.pindouHeight);null==c||c.putImageData(d,0,0),n.drawImage(s,t.pindouWidth*l,t.pindouHeight*o);for(let n=0;n<t.pindouHeight;n++)for(let r=0;r<t.pindouWidth;r++){const s=l*t.pindouWidth+r,c=o*t.pindouHeight+n;if(s<t.canvasWidth&&c<t.canvasHeight){const l=n*t.pindouWidth+r;i[c*t.canvasWidth+s]=e[a].colorArr[l]}}for(const[t,n]of e[a].colorStatList)if(r.has(t)){let e=n[1],a=r.get(t)[1],l=Number(e+a);r.set(t,[n[0],l])}else r.set(t,n);const h=Array.from(r.entries());h.sort(((e,a)=>a[1][1]-e[1][1])),r=new Map(h)}let c=s(o({},t),{currentPindouIndex:0,pindouWidth:t.canvasWidth,pindouHeight:t.canvasHeight}),d=[{blockArr:n.getImageData(0,0,t.canvasWidth,t.canvasHeight).data,colorStatList:r,colorArr:i}];return a.handlePindouToExcel2(d,c)}}};return o({},a)}(),i=L(),h=He(),u=(D||S)();let g=We(s(o({},Ve(i.data)),{isPreview:!1,projectData:ma(),emptyColor:"#00000000",brushColorVisible:!1,shapeFillColorVisible:!1,baseCanvas:null,bgCanvas:null,canvas:null,realCanvas:null,gridCanvas:null,scaleCanvas:null,scaleBoxDom:null,ctx0:null,ctx1:null,ctx2:null,ctx3:null,ctx4:null,ctx5:null,isDrawing:!1,isErasering:!1,isDrawShape:!1,isMoving:!1,isSelecting:!1,isSelectDraging:!1,isCopy:!1,isScale:!1,shapeFillColor:"#000000ff",brushColor:"#000000ff",brushSize:1,eraserSize:1,gridGapSize:1,canvasWidth:32,canvasHeight:32,scale:1,isCheckedRatio:!0,isShowReferenceLine:!1,isShowRuler:!1,widthHeightRatio:1,drawAreaList:[],currentTool:0,drawRecord:[],drawShapeList:[],gridInfo:"[]",currentDrawShape:"rect",currentDrawTransform:"hReverse",historyRecord:[],historyMaxLength:20,currentHistoryIndex:0,historyTimer:null,lastX:0,lastY:0,currentFrameIndex:0,currentLayerIndex:0,currentFrameId:"0",currentLayerId:"0",currentFrameLayerVisible:!0,currentEditLayer:{index:-1,name:"",mindIndex:-1,mindName:""},FrameTimer:null,maxFrame:30,maxLayer:30,exportVisible:!1,exportLoaidng:!1,importLayerVisible:!1,loading:!0,isSpace:!1,isShift:!1,isAlt:!1,isDragging:!1,dragData:{x:0,y:0},canvasBeginPos:{x:0,y:0,centerX:0,centerY:0},moveData:{x:0,y:0,moveLayerId:"",imageData:null,col:0,row:0,diffCol:0,diffRow:0,centerX:0,centerY:0,transformX:0,transformY:0,list:[],mapList:{},bitmap:"",isMoving:!1,newCenterX:0,newCenterY:0},selectData:{selectLayerId:"0",selectCanvasObj:null,isMoving:!1,isCopySelect:!1,x:-1,y:-1,endX:-1,endY:-1,isCancelSelect:!0,originList:[],selectList:[],selectOriginList:[],copyList:[],selectMapList:{},copySelectMapList:null},selectType:"select",previewLoading:!1,selectActiveColor:"#3100FC",isExpandColorSelector:!0,colorStatList:{},worker:null,isExportProject:!1,AnimationFrameId_1:null,zIndex:{max:13,min:8},isSaveProject:!0,pinDouMode:!1,pinDouDrawMode:!1,pinDouData:null,tolerance:0,curvature:4,curveType:{isPress:!1,pressKey:"0"},curveEndPos:[],isHorizontal:!1,isVertical:!1,isCenter:!1,drawList:[],removeDrawList:[],LayerMenu:{visible:!1,top:0,left:0,contextData:null},selectLayerList:[],pindouHighlight:null,isHidePindouMode:!1,pindouBrand:h.settingsOption.defaultPindou,isScaling:!1,scaleWhitePointPos:[],scaleAreaData:null,scaleRatio:0,emptyLayerData:[],exportStyleOptions:{isShowGrid:!1,gridBackgroundColor:"#ffffffff",gridColor:"#808080ff",gridSize:50},layerAlpha:100,isHideLinmoMode:!1,linmoMode:!1,linmoPhoto:null,linmoPhotoStyle:{width:"200px",height:"200px",transform:"translate3d(0px, 0px, 10px) rotate(0deg) scale(1, 1)",opacity:1,zIndex:0,display:"none",transformOrigin:"center center"},linmoPhotoDom:null,dragLinmoPhoto:{enable:!1,startX:0,startY:0,translateX:0,translateY:0},scaleTimer:null,canvasStyle:{transform:"scale(1)",transformOrigin:"center center"},isShowGridLine:!1,pindouScaleValue:0,drawAreaGridColor:{light:["rgba(204, 204, 204, 1)","rgba(153, 153, 153, 1)"],dark:["rgba(204, 204, 204, 1)","rgba(153, 153, 153, 1)"]},canvasRealTop:0,canvasRealLeft:0,isLockCanvas:!1,isHighPreview:!1,linmoFitCanvasTimer:null,gridLineTimer:null,mouseDrawData:{startX:0,startY:0,lastX:0,lastY:0,baseRect:null},drawShapeData:{list:[],startX:0,startY:0,endX:0,endY:0,maxX:0,maxY:0,minX:-1,minY:-1},historyLayerIndexRecord:[0],historyLayerNameIndex:[0],historyFrameIndexRecord:[0],drawAreaGridCanvas:null,layerGridImage:null,pindouHighlightOptions:null,menuType:0,layerScale:1,layerOriginRectData:{scale:1,width:0,height:0},maxScale:60,layerCrossList:{},currentSelectMindId:"0",isEnableCanvasGrid:!1,layerScaleStep:.5,isEnableCanvasSmooth:!1,isEnableEraserTrack:!0,scaleStyle:{width:"0px",height:"0px",left:"0px",top:"0px"},resizeStyle:{width:"0px",height:"0px",left:"0px",top:"0px"},resizeData:{startX:0,startY:0,direction:""},scaleImg:"",isControlMindObj:!1,mobileStartDistance:null,pindouBlockList:[],currentPindouIndex:0,pindouBlockHeight:64,pindouBlockWidth:64,currentPindouBlockSize:64,isShowPindouGridLine:!1,isShowPindouReferenceLine:!1,pindouReferenceLineGap:5,pindouReferenceLineColor:"#0052d9",isShowPindouRuler:!1,isShowPindouShadow:!1,isUpdateAllBlock:!1,isAutoChangeBrush:!1,exportSingleImage:"",exportSingleImageIndex:0,axisXStyle:{left:"0px"},axisYStyle:{top:"0px"},axisCStyle:{left:"0px"},XLineOffset:0,YLineOffset:0,CenterLineOffset:0,isMovingLine:!1,intelligentStrokeVisible:!1,exportFormat:"image/webp",intelligentSliceVisible:!1,intelligentSliceOptions:null,intelligentSliceObj:null,isEnablePindouBrushMode:!1,isEnablePindouEraserMode:!1,isMovingPindouBrush:!1,sharePermission:"1"}));const p={requireIcon:ya((()=>e=>h.themeValue?new URL({"../../assets/light/ai.png":I,"../../assets/light/brush.png":k,"../../assets/light/bucket.png":R,"../../assets/light/circle.png":M,"../../assets/light/clear.png":F,"../../assets/light/color.png":P,"../../assets/light/copy.png":B,"../../assets/light/cReverse.png":A,"../../assets/light/crop.png":T,"../../assets/light/curve.png":O,"../../assets/light/eraser.png":j,"../../assets/light/fillCircle.png":E,"../../assets/light/fillRect.png":H,"../../assets/light/filter.png":W,"../../assets/light/hidden.png":$,"../../assets/light/hReverse.png":V,"../../assets/light/line.png":z,"../../assets/light/magicStick.png":Y,"../../assets/light/more.png":X,"../../assets/light/move.png":U,"../../assets/light/nsz.png":N,"../../assets/light/pindou.png":_,"../../assets/light/quickSelect.png":K,"../../assets/light/rangeSelect.png":G,"../../assets/light/rect.png":J,"../../assets/light/rotate.png":q,"../../assets/light/scale.png":Z,"../../assets/light/select.png":Q,"../../assets/light/sprite.png":ee,"../../assets/light/straw.png":ae,"../../assets/light/visible.png":te,"../../assets/light/vReverse.png":le}[`../../assets/light/${e}.png`],self.location).href:new URL({"../../assets/dark/ai.png":ne,"../../assets/dark/brush.png":re,"../../assets/dark/bucket.png":ie,"../../assets/dark/circle.png":oe,"../../assets/dark/clear.png":se,"../../assets/dark/color.png":ce,"../../assets/dark/copy.png":de,"../../assets/dark/cReverse.png":he,"../../assets/dark/crop.png":ue,"../../assets/dark/curve.png":ge,"../../assets/dark/eraser.png":pe,"../../assets/dark/fillCircle.png":me,"../../assets/dark/fillRect.png":ye,"../../assets/dark/filter.png":fe,"../../assets/dark/hidden.png":ve,"../../assets/dark/hReverse.png":Ce,"../../assets/dark/line.png":we,"../../assets/dark/magicStick.png":xe,"../../assets/dark/more.png":Le,"../../assets/dark/move.png":De,"../../assets/dark/nsz.png":Se,"../../assets/dark/pindou.png":be,"../../assets/dark/quickSelect.png":Ie,"../../assets/dark/rangeSelect.png":ke,"../../assets/dark/rect.png":Re,"../../assets/dark/rotate.png":Me,"../../assets/dark/scale.png":Fe,"../../assets/dark/select.png":Pe,"../../assets/dark/sprite.png":Be,"../../assets/dark/straw.png":Ae,"../../assets/dark/visible.png":Te,"../../assets/dark/vReverse.png":Oe}[`../../assets/dark/${e}.png`],self.location).href)),requireShapeImg:ya((()=>h.themeValue?new URL({"../../assets/light/ai.png":I,"../../assets/light/brush.png":k,"../../assets/light/bucket.png":R,"../../assets/light/circle.png":M,"../../assets/light/clear.png":F,"../../assets/light/color.png":P,"../../assets/light/copy.png":B,"../../assets/light/cReverse.png":A,"../../assets/light/crop.png":T,"../../assets/light/curve.png":O,"../../assets/light/eraser.png":j,"../../assets/light/fillCircle.png":E,"../../assets/light/fillRect.png":H,"../../assets/light/filter.png":W,"../../assets/light/hidden.png":$,"../../assets/light/hReverse.png":V,"../../assets/light/line.png":z,"../../assets/light/magicStick.png":Y,"../../assets/light/more.png":X,"../../assets/light/move.png":U,"../../assets/light/nsz.png":N,"../../assets/light/pindou.png":_,"../../assets/light/quickSelect.png":K,"../../assets/light/rangeSelect.png":G,"../../assets/light/rect.png":J,"../../assets/light/rotate.png":q,"../../assets/light/scale.png":Z,"../../assets/light/select.png":Q,"../../assets/light/sprite.png":ee,"../../assets/light/straw.png":ae,"../../assets/light/visible.png":te,"../../assets/light/vReverse.png":le}[`../../assets/light/${g.currentDrawShape}.png`],self.location).href:new URL({"../../assets/dark/ai.png":ne,"../../assets/dark/brush.png":re,"../../assets/dark/bucket.png":ie,"../../assets/dark/circle.png":oe,"../../assets/dark/clear.png":se,"../../assets/dark/color.png":ce,"../../assets/dark/copy.png":de,"../../assets/dark/cReverse.png":he,"../../assets/dark/crop.png":ue,"../../assets/dark/curve.png":ge,"../../assets/dark/eraser.png":pe,"../../assets/dark/fillCircle.png":me,"../../assets/dark/fillRect.png":ye,"../../assets/dark/filter.png":fe,"../../assets/dark/hidden.png":ve,"../../assets/dark/hReverse.png":Ce,"../../assets/dark/line.png":we,"../../assets/dark/magicStick.png":xe,"../../assets/dark/more.png":Le,"../../assets/dark/move.png":De,"../../assets/dark/nsz.png":Se,"../../assets/dark/pindou.png":be,"../../assets/dark/quickSelect.png":Ie,"../../assets/dark/rangeSelect.png":ke,"../../assets/dark/rect.png":Re,"../../assets/dark/rotate.png":Me,"../../assets/dark/scale.png":Fe,"../../assets/dark/select.png":Pe,"../../assets/dark/sprite.png":Be,"../../assets/dark/straw.png":Ae,"../../assets/dark/visible.png":Te,"../../assets/dark/vReverse.png":Oe}[`../../assets/dark/${g.currentDrawShape}.png`],self.location).href)),requireTransformImg:ya((()=>h.themeValue?new URL({"../../assets/light/ai.png":I,"../../assets/light/brush.png":k,"../../assets/light/bucket.png":R,"../../assets/light/circle.png":M,"../../assets/light/clear.png":F,"../../assets/light/color.png":P,"../../assets/light/copy.png":B,"../../assets/light/cReverse.png":A,"../../assets/light/crop.png":T,"../../assets/light/curve.png":O,"../../assets/light/eraser.png":j,"../../assets/light/fillCircle.png":E,"../../assets/light/fillRect.png":H,"../../assets/light/filter.png":W,"../../assets/light/hidden.png":$,"../../assets/light/hReverse.png":V,"../../assets/light/line.png":z,"../../assets/light/magicStick.png":Y,"../../assets/light/more.png":X,"../../assets/light/move.png":U,"../../assets/light/nsz.png":N,"../../assets/light/pindou.png":_,"../../assets/light/quickSelect.png":K,"../../assets/light/rangeSelect.png":G,"../../assets/light/rect.png":J,"../../assets/light/rotate.png":q,"../../assets/light/scale.png":Z,"../../assets/light/select.png":Q,"../../assets/light/sprite.png":ee,"../../assets/light/straw.png":ae,"../../assets/light/visible.png":te,"../../assets/light/vReverse.png":le}[`../../assets/light/${g.currentDrawTransform}.png`],self.location).href:new URL({"../../assets/dark/ai.png":ne,"../../assets/dark/brush.png":re,"../../assets/dark/bucket.png":ie,"../../assets/dark/circle.png":oe,"../../assets/dark/clear.png":se,"../../assets/dark/color.png":ce,"../../assets/dark/copy.png":de,"../../assets/dark/cReverse.png":he,"../../assets/dark/crop.png":ue,"../../assets/dark/curve.png":ge,"../../assets/dark/eraser.png":pe,"../../assets/dark/fillCircle.png":me,"../../assets/dark/fillRect.png":ye,"../../assets/dark/filter.png":fe,"../../assets/dark/hidden.png":ve,"../../assets/dark/hReverse.png":Ce,"../../assets/dark/line.png":we,"../../assets/dark/magicStick.png":xe,"../../assets/dark/more.png":Le,"../../assets/dark/move.png":De,"../../assets/dark/nsz.png":Se,"../../assets/dark/pindou.png":be,"../../assets/dark/quickSelect.png":Ie,"../../assets/dark/rangeSelect.png":ke,"../../assets/dark/rect.png":Re,"../../assets/dark/rotate.png":Me,"../../assets/dark/scale.png":Fe,"../../assets/dark/select.png":Pe,"../../assets/dark/sprite.png":Be,"../../assets/dark/straw.png":Ae,"../../assets/dark/visible.png":Te,"../../assets/dark/vReverse.png":Oe}[`../../assets/dark/${g.currentDrawTransform}.png`],self.location).href)),requireSelectImg:ya((()=>h.themeValue?new URL({"../../assets/light/ai.png":I,"../../assets/light/brush.png":k,"../../assets/light/bucket.png":R,"../../assets/light/circle.png":M,"../../assets/light/clear.png":F,"../../assets/light/color.png":P,"../../assets/light/copy.png":B,"../../assets/light/cReverse.png":A,"../../assets/light/crop.png":T,"../../assets/light/curve.png":O,"../../assets/light/eraser.png":j,"../../assets/light/fillCircle.png":E,"../../assets/light/fillRect.png":H,"../../assets/light/filter.png":W,"../../assets/light/hidden.png":$,"../../assets/light/hReverse.png":V,"../../assets/light/line.png":z,"../../assets/light/magicStick.png":Y,"../../assets/light/more.png":X,"../../assets/light/move.png":U,"../../assets/light/nsz.png":N,"../../assets/light/pindou.png":_,"../../assets/light/quickSelect.png":K,"../../assets/light/rangeSelect.png":G,"../../assets/light/rect.png":J,"../../assets/light/rotate.png":q,"../../assets/light/scale.png":Z,"../../assets/light/select.png":Q,"../../assets/light/sprite.png":ee,"../../assets/light/straw.png":ae,"../../assets/light/visible.png":te,"../../assets/light/vReverse.png":le}[`../../assets/light/${g.selectType}.png`],self.location).href:new URL({"../../assets/dark/ai.png":ne,"../../assets/dark/brush.png":re,"../../assets/dark/bucket.png":ie,"../../assets/dark/circle.png":oe,"../../assets/dark/clear.png":se,"../../assets/dark/color.png":ce,"../../assets/dark/copy.png":de,"../../assets/dark/cReverse.png":he,"../../assets/dark/crop.png":ue,"../../assets/dark/curve.png":ge,"../../assets/dark/eraser.png":pe,"../../assets/dark/fillCircle.png":me,"../../assets/dark/fillRect.png":ye,"../../assets/dark/filter.png":fe,"../../assets/dark/hidden.png":ve,"../../assets/dark/hReverse.png":Ce,"../../assets/dark/line.png":we,"../../assets/dark/magicStick.png":xe,"../../assets/dark/more.png":Le,"../../assets/dark/move.png":De,"../../assets/dark/nsz.png":Se,"../../assets/dark/pindou.png":be,"../../assets/dark/quickSelect.png":Ie,"../../assets/dark/rangeSelect.png":ke,"../../assets/dark/rect.png":Re,"../../assets/dark/rotate.png":Me,"../../assets/dark/scale.png":Fe,"../../assets/dark/select.png":Pe,"../../assets/dark/sprite.png":Be,"../../assets/dark/straw.png":Ae,"../../assets/dark/visible.png":Te,"../../assets/dark/vReverse.png":Oe}[`../../assets/dark/${g.selectType}.png`],self.location).href)),requireVisibleImg:ya((()=>e=>e?h.themeValue?new URL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAwNJREFUeF7tmU2IjVEYx3//nYViJRbKCgtfxQIpasosDLFgMTGUMmQlWVGULdn5mJKPSWpmQUhRsvAxKVOSUjYsJsXKwsJC/jq69M51Z+577r3vNLdznnq7i3uej/d3nuec85xXJC5K/P3JAHIGJE4gl0DiCZAXwVwCuQQSJ5BLIPEEyLtALoFcAjNAwPYSYAuwGVgOzC88IYJvhecd8BgYkzRRdXiVlYDtVcAOYBuwvsUXGQMeAvckvW3RxrRqHQdg+yCwB9ja4YBDVoxIutpJux0DYLsXOAaE3yrlEXBBUvhtW9oGYHsecB4IMz+TEjLhpKQv7ThtC4DtlcA1YG07QbSh+wkYlBTKoyVpGYDtQ8CVSK/fw4IGvAfeAOPAL2A1EBbN8OwG5kTaPSHpXKTOn+EtAbB9Bjgd6fAlcFRSePEpxXYPcBFYGmm/X9LtSJ14ALaPA7G0L0s6EhOc7ZAp22N0wu4jaTRGJyoDbO8E7sQ4AO5LCueBaLF9CTgcqbhL0t2yOqUB2F4APAFWlDUOfJC0rH687X212d0A/ASeAc8lDTUY+wLYGOEznCR7JH0toxMDICx4YeErKz+APkkB2j+xPVJb6BrZGZe0rm78mhqguWUdA0OSBsuMLwXA9n7gehmDhTHDkgbqXuZ1iS1zVFI4SRah3QL6I/0fkHSjmU5ZACFFNzUzVvf/pK0pctsckDT8157tU8DZSP//ZVMj/aYAbIdm5kGk8zC8t3hAsX0TCLVfRiZlge2+sJiWUawbs1dSyJ4ppQyAp7VWNtb/wuIx1fZHILTFZWRC0uJCBiwCPpdRrBvzStK0nWgG0Ixq8iUQANlOdxGsAUh7G6xBSPcgVAOQ9lG4BiHdZqiwJ6fbDhcgpHshUoCQ7pVYAUK6l6IFCOleixeP0cl+GKnvJZL9NNYARJofRxt1l0l+Hm/WZs+W/5teiMyWQKuKIwOoimy32M0Z0C0zVVWcOQOqItstdnMGdMtMVRVnzoCqyHaL3ZwB3TJTVcWZM6Aqst1i9zeYIGJQFMquqwAAAABJRU5ErkJggg==",self.location).href:new URL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAtFJREFUeF7t2T/oVEcQwPGPnYWglWghpIoWiQpaJBKIIGgRE7TQQvwHAf+QSsQqgoKtYuc/kCSKCFooKoKCWPgPQUFEEGy0CEJSWVikCCGMvIPzeXq7d7+nnLsDjytuZ3bed2dmd/ZNU7hMK/z9VQA1AgonUFOg8ACoRbCmQE2BwgnUFCg8AOouUFOgpsDHIfAFluN7LMCsvic8eNX3PMF13MOfXbvXZQosxE/4Ad+M+CIB4Sou4fGINj6o1gWAn7EeK6fY4YiKczg5lXanEsAq7EL8dinXcBjxO7ZMBYCZOIRY+Y8pEQm/4q9xJh0XwNf4DUvGcWIM3RfY3hTNkcyMA2AbjmfO+ropaE/xCA/xHxYhimY86zA90+4eHMzUeTN8VAD7sS9zwrv4pXnxD6muwBF8mWl/A85m6owEYPcItI9hZ6ZzsfX9mKkTu8/5HJ3cCFiDCzkT4HJzHshUezP8KHZkKq7FxVSdHACzcQNfpRrHM8wfMH5Ts7rf4l/cwm2cGDD2DpZlzBknyUijv1N0cgBEwYvClyr/YHUDrV8nDjNR6AZJFMWlrT8WN4BmpE7cgIzdYaikAtiC34dae3vAaWxu6TxI2DIjhyOX++UMosjlyFb8MUwhFUCE6HfDjLX+b29NOdtmgAuAPdmLA5nzD4qmd0ykAIhm5krm5DE8jsRxfu/JKUTup0g7CiKVopjmykZE9LxXUgDcbFrZ3MnntI6pzxFtcYpEGzyvb+BcvExRbI25P6wTrQASqBafAsGo6CIYAIrfBgNC0QehAFD8UTggFN0M9TaMotvhHoSiL0R6EHLO9j2dz+ZKrPdCRV+K9iAUfS3ef5Iu9sNIu50o9tNYG0SxH0cHNZhFfh5P6LQ//ZCUC5FP72WHHlQAHcKdCNM1AiZimTp0skZAh3AnwnSNgIlYpg6drBHQIdyJMF0jYCKWqUMnawR0CHciTP8Phw+oQQpn1acAAAAASUVORK5CYII=",self.location).href:h.themeValue?new URL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABO1JREFUeF7tmkmoHVUQhr8fQVwI6sJhkYBujIITKqIiKATNwii6iIugURSNGgRHCLhIslNU4sIx4BhESBaKEcUJRaNRNE44oC4MGHACBxAREUrqcTr0venhVPd9l0e/W9DcxTl1qv7/VNepOn3FIhctcvzMCJhFwCJnYPYKLPIAmCXBQb8CZrZR0samKB8sAQ4e2ABsaiJhkASUwBeb75GwqSoSBkdABXjH/TVwmaQvxkkYFAE14L9L4D8ddATUgP8+gf+oLhEOIgJqwP+QwL8/6FOgBvyPCfzOtkJvKhFgZkcD5wHnAscBh5aefwHfrb2lxx1/W5KP1UoN+F8T+LfawPv4vBFgZicBFwMXAmfmOFMx5+NExC3jYzXgf0/gX8+1N3ECzOwadwK4INeJhnnbJflaI1ID/q8E/uWI3YkRYGYrAN8p/52ERMD/k8DviBruTYCZHQLcB/jOT0oi4P9L4J/rYrwXAWZ2IvAEcFoX4zU6EfC+hFd427va70yAmV0HPBo07O/pC6k09cpsN3AAcFZ6lgTe+bLp9ZLuDvoyN70TATVJqM3+e8A6SZUlaZ1ywFZj11e3fpgAM7sNuLcN7dj4I5JuCOoQAF8svULSqxE7IQLM7BIgmmx2SPJ6oFI8iUr6c3ywA/hiiTMkfZhLQjYBZnYE8AZwQu7iwLeSllWA8/xxNrCn6rKiB3g39RlwviSvCFslQoAnPHc8V/xsXinJSdsnZuadmZ8ale9sT/CFncclZR3LWQSY2ZXAk7nI07ytktaMgd8GrOoAfj1wV9C+J9yH2nRyCXgHOKdtsbHxOyTtS5ZmdgXwdAfwRSns5EXEm6tlkv5uUmolwMy8mXkxYjnNHcnIZvYasLPqbq4h7OeKHDPzV6b2UqPBt5skPdCXgDdTKxvl4ChJPxdKZrahC3jXN7PDgN+iDgCfSDq1LwHvpowdtb9UkofhHABJ3qqOSMPO75W0tETekcBPUQeADyQ1tuI5r8Bq4JkOxhtr9JZsP9IPmJm31q908OFySY2+5xBwEPAVcEzQgc2Sbq3SyTjq1kjaWoqA24F7gvZ3Szq9TaeVgBTCNwIPti02Nh7t6gr1/fTMzE8PP0UicpWkp9oUsghIJDwGXN22YBrvCv5LSSOVppktT6eQR2KubJG0NmdyhIDDAT/KTm5ZOAreE+Uuf81qyuJvgGNzwKQ5/vVnuaRfcnSyCUhRsBJounaKgm9LlH53cFEOkNKcSyU9n6sTIiCRsA6oKi4mDf5h4PpcIGle+HYoTEAi4WZgc8m5iYE3s1NSwvVuMSKrJT0bUfC5nQhIJHhT4/V5FLx/9PDHCyy/EnPxUteBH5++JRwcBDLSd0R0OxNQkFB1IZlxzkd8bJq7B1gbvQUqL9iLgCrPpgjej+U7y/1GF1YnSsCUwHtJ7FVml9J4P44mRsAUwPtl5zZJvvMTk4kQ0AD+/tRKe4LrIl4gveTfEiR93mWBNp3eBLRdZhQOmJl/HvdnSenxlvdA4I/S45Wc7/auop1uA9FnvBcBueD7ODjfup0JGAL4zoXQUMB3ImBI4MMEDA18iIAhgs8mYKjgswgYMvgsAlLX5zeyfjNbSPjiYb7P867rZ9cBZrYFuLbvf3K6OjpfetkEpEhY1ecPSfMFos+6IQL6GFqoujMCFurOTMuvWQRMi+mFaud/XhkSXwnoZssAAAAASUVORK5CYII=",self.location).href:new URL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABJ9JREFUeF7tmkuoVlUUx3+XQBwE6UBtkJCTSjALDdEIEqIcmFEDHYgvlCwVwV4QNMhmhYoOLDVQywihBoqKkg+UfJSYmVKJOTBIMA18gISIA/nLPnA4d5+z99rnfF927rfgcLnsvdba///eZz32+foY4NI3wPHTI6B3AgY4A71XYIAfgF4QbPsrsBzQUyptJkDAPwQ+qiKhrQRk4LOd1/8iop+0kYAieIE+C8wAfi0y0DYCfODPO/C/tP0E+MBfcOB/KouCbTkBPvB/OfA/tj0L+MBfcuCPhAq9bp2AR4HJwPPAE8CQ3HMb0G5dzD1a+PeAxqrEB/4fB/5QCLzGO0nAWOAVYCowMWYxnjk/OyLe8oz5wF9z4PfH+usEAQvcIl6KXUTFvG+dreIUH/ibbu4ei98mCZgCaKf0twmxgL/lwO+0Om6CgIeAVYB2vimxgL/jwG9LcV6XgCeBzcD4FOclOhbwMqEKTzpJUoeAhcAGo1e9pztcaarK7CTwADDJPY8Y3vm86/eBT4xruTc9lQBfEAr5PwYsAbwlaYVyrK/Krq/MfgoB7wArQ2gL4+uBRUYdTY8Fn5lWAN5r8WMl4FXAGmwUmVUPlImC6A3PoBV8ZmICcCKWBAsBw4EDwJhY48AfwOOe+YofzwJ/llxWpIKXq9PAi4AqwqBYCFDA08JjRbn5ZUdaXkedmbJG2TtbB3zmZ1NsWo4lYC7wRSxyN+8rYE5B5xtgegJ4RfmPjf4VcD8L6cQScBh4LmSsMP5eIVjOBrYkgFeel4g8i6i50uv3b5VSDAFqZnZZPLu5xYi8D1CX57ubKzv2WZGjV6b0UqNibUuBtXUJOOhaWSsHDwOXc0rZDW3RTgi85g8FrloXAJwCxtUl4KiL2Fb/I11/nwFQqxoLXsdX+pmMAP62LgA4HmrFY16BmcDXCc5DNXpVtC/2A2qtv0tYw6zQ2mMIGAz8DowyLmA18HaJTijVKXsoi2TyLrDC6F99xjMhnRgCZGMx8GnIWGHc2tVl6j49ZQ9lEYvMA74MKcQSIDsbgfkhg248FfxvnkrzBZeFdBJj5XPgjZjJFgKGAUplTwUMW8Er4P3gXjPfh8xzwGMxYNwcff0RaVdidCwEyJ5K26prJyv4UKDU3cG0GCC5Oa8B22N1rATIrkpMX3HRNPh1wJuxQNy8EKH9zKUQICPLAEX5qsClsZgip7iop13AVbdoEaXrrRYFzU0lQLpqalSfW3de5bAeFVhKVRKVugI+2t0dPGgEUuw7otXrEJCR4LuQDOX56AUGJuo+QdHedAuUt1mXAN/6ugVeafmDQr9hJrZpAroBXiWx4k9KadxYEPwvdl7HXDFHO9+YNHUCynZ+jWulFeBSRAXSbvct4UyKgZBOEwTEpjp9Htejjx/Zo5Z3EHA996iS024LvKrEjkpdAmLBdxREHeN1CPjfg69TCLUCfCoBrQGfQkCrwFsJaB14CwGtBB9LQGvBxxKgebqR1c1sJuaLhzq5upO6ljpAF42v1/1NTifBpNi2ECD7ugRJ/kFSygI7rWMloNPr6br9HgFdp/w+c9g7AffZhnR9OXcBC2PsQVriZsoAAAAASUVORK5CYII=",self.location).href)),checkTheme:ya((()=>h.themeValue)),checkzIndex:ya((()=>{let e={zIndex:0};return h.isFullWork?e.zIndex=g.zIndex.max:e.zIndex=g.zIndex.min,e}))};let m=s(o({},i),{handleChangeBrushColor(e){let a=e;a.length<=6&&"#"!==a.slice(0,1)&&(a=`#${a}ff`.toLowerCase()),g.brushColor=a},async handleSaveProject(){var e;if(g.isScaling&&m.handleCancelScale(),!g.isSaveProject)if(g.loading=!0,g.isSaveProject=!0,g.projectData.updateAt=Da(),g.projectData.height=g.canvasHeight,g.projectData.width=g.canvasWidth,g.projectData.tip="最近编辑",g.projectData.data=await m.compressDrawRecordData(),""===g.drawRecord[0].currentFrameImg?g.projectData.frameImg="":g.projectData.frameImg="@",g.projectData.isLocalFile&&["1","2"].includes(g.projectData.isLocalFile)){let t=null==(e=h.localProjectList.find((e=>e.id===g.projectData.projectId)))?void 0:e.entry;try{const e=await t.createWritable();let a=JSON.parse(JSON.stringify(g.projectData));if(delete a.isLocalFile,"1"===g.projectData.isLocalFile)await e.write(JSON.stringify(a));else{let t=await pt(a);t&&await e.write(t)}await e.close(),l.$message.success("保存成功"),g.loading=!1}catch(a){l.$message.error("保存失败"),g.loading=!1}}else h.saveProject(g.projectData,!0).then((e=>{e&&(l.$message.success(l.$t("message.saveSucceeded")),g.loading=!1)})).catch((e=>{l.$message.error(l.$t("message.saveFailed")),g.loading=!1}))},handleBack:()=>g.isPreview?(g.isPreview=!1,h.saveProjectId("0"),l.$router.back()):g.isSaveProject?(h.saveProjectId("0"),g.pinDouMode=!1,l.$router.replace("/project")):void Sa.confirm("项目未保存，是否离开该页面？","提 示",{confirmButtonText:"确 认",cancelButtonText:"取 消",type:"warning"}).then((()=>{h.saveProjectId("0"),g.pinDouMode=!1,l.$router.replace("/project")})).catch((()=>{})),handleScreenFull(){h.isFullWork=!h.isFullWork,setTimeout((()=>{m.handleResizeWindowEvent(""),h.isFullWork||m.handleResetCanvas()}),200)},handleSaveMoveData(e=!1,a){},handleMoveData(){},handleChangeTool(e){if(g.pinDouMode)return g.isUpdateAllBlock?l.$message.warning("请先关闭批量更新分块"):[0,1,2].includes(e)?g.currentTool=e:l.$message.warning("请先退出拼豆预览模式");if(8===g.currentTool&&8!==e){if(9===e)return;m.handleCancelSelect()}g.isScaling&&m.handleCancelScale(),8===e&&(g.selectData.selectCanvasObj||(g.selectData.selectCanvasObj={},g.selectData.selectCanvasObj.canvas=document.createElement("canvas"),g.selectData.selectCanvasObj.canvas.width=g.canvasWidth,g.selectData.selectCanvasObj.canvas.height=g.canvasHeight,g.selectData.selectCanvasObj.ctx=g.selectData.selectCanvasObj.canvas.getContext("2d"),g.selectData.selectCanvasObj.selectCanvas=document.createElement("canvas"),g.selectData.selectCanvasObj.selectCanvas.width=g.canvasWidth,g.selectData.selectCanvasObj.selectCanvas.height=g.canvasHeight,g.selectData.selectCanvasObj.selectCtx=g.selectData.selectCanvasObj.selectCanvas.getContext("2d")),g.selectData.selectLayerId=m.getCurrentLayerId()),10!==e?g.currentTool=e:l.$refs.SpriteDialog.handleOpen()},handleLinmoMode:()=>g.pinDouMode?l.$message.warning("请先退出拼豆预览模式"):g.isHideLinmoMode?(g.isHideLinmoMode=!1,void l.$refs.LinmoModeDialog.handleShow()):(g.linmoMode=!0,void l.$refs.LinmoModeDialog.handleOpen()),handlePindouMode(e){if(8===g.currentTool&&m.handleCancelSelect(),g.isScaling&&m.handleCancelScale(),!g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender)return l.$message.warning("请将图层设置显示状态");if("preview"===e&&g.pinDouMode)g.currentTool=5;else if("preview"!==e||g.pinDouMode){if("draw"===e&&!g.pinDouDrawMode){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");if(g.isHidePindouMode)return void m.handleShowPindou();g.pinDouDrawMode=!0,l.$refs.PindouDialog.handleOpen(e,0,g.pindouBrand);let a=g.ctx1.getImageData(0,0,g.canvasWidth,g.canvasHeight).data;g.worker.postMessage({type:105,currentFrameData:a,isPindouDrawMode:g.pinDouDrawMode,currentPindouBrandColorList:JSON.parse(JSON.stringify(h.pindouMaps[g.pindouBrand].data||h.pindouMaps[g.pindouBrand]))}),g.worker.onmessage=e=>{105===e.data.type&&(g.colorStatList=e.data.colorObj)}}}else{if(g.pinDouDrawMode)return l.$message.warning("请先退出拼豆绘图模式");if(g.linmoMode)return l.$message.warning("请先退出临摹模式");if(!g.drawRecord[g.currentFrameIndex].currentFrameImg||!g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].currentLayerImg)return l.$message.warning("当前图层为空");if(m.checkCurrentLayerMindLock(!0))return l.$message.warning("请将智能对象栅格化后编辑");g.isShowGridLine=!1,g.isShowReferenceLine=!1,g.isShowRuler=!1,g.currentPindouIndex=0,g.currentTool=5,m.handlePindouEvent()}},handleShowPindou(){g.isHidePindouMode=!1,l.$refs.PindouDialog.handleShow()},handlePindouEvent(e=g.pindouBrand){if(g.pinDouDrawMode){g.pindouBrand=e;let a=g.ctx1.getImageData(0,0,g.canvasWidth,g.canvasHeight).data;return g.worker.postMessage({type:105,currentFrameData:a,isPindouDrawMode:g.pinDouDrawMode,currentPindouBrandColorList:JSON.parse(JSON.stringify(h.pindouMaps[g.pindouBrand].data||h.pindouMaps[g.pindouBrand]))}),void(g.worker.onmessage=e=>{105===e.data.type&&(g.colorStatList=e.data.colorObj)})}g.loading=!0,g.canvasWidth+g.canvasHeight<=2*g.currentPindouBlockSize?(g.pindouBlockWidth=g.canvasWidth,g.pindouBlockHeight=g.canvasHeight):(g.pindouBlockWidth=Math.min(g.currentPindouBlockSize,g.canvasWidth),g.pindouBlockHeight=Math.min(g.currentPindouBlockSize,g.canvasHeight));const a=document.createElement("canvas");a.width=g.canvasWidth,a.height=g.canvasHeight;const t=a.getContext("2d"),n=new Image;n.src=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].currentLayerImg,n.onload=()=>{null==t||t.drawImage(n,0,0);const a=null==t?void 0:t.getImageData(0,0,g.canvasWidth,g.canvasHeight);g.worker.postMessage({type:106,options:{canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight,pindouBlockHeight:g.pindouBlockHeight,pindouBlockWidth:g.pindouBlockWidth,currentPindouBlockSize:g.currentPindouBlockSize,currentFrameImgData:a},currentPindouBrandColorList:JSON.parse(JSON.stringify(h.pindouMaps[e].data||h.pindouMaps[e]))}),g.worker.onmessage=a=>{if(106!==a.data.type)return;g.pindouBlockList=a.data.pindouData;const t=document.createElement("canvas"),n=t.getContext("2d");for(let e=0;e<g.pindouBlockList.length;e++)t.width=g.pindouBlockWidth,t.height=g.pindouBlockHeight,null==n||n.drawImage(g.pindouBlockList[e].blockBitmap,0,0),g.pindouBlockList[e].blockBitmap=t.toDataURL(g.exportFormat,1);m.handleCloseAllDialog(),g.pinDouMode=!0,ba((()=>{m.computeScale(!0),m.drawPixelArea(!0),m.handleSetCanvasScale(),m.handleDrawPindou(g.ctx1),m.handleDrawPindouGridLine(),m.handleDrawPindouRuler(),m.handleChangePindouBlock(0),g.pindouBrand=e,g.isHidePindouMode||l.$refs.PindouDialog.dialogVisible||(l.$refs.PindouDialog.handleOpen(a.data.pindouData,g.currentPindouIndex,e),l.$refs.PindouDialog.handleUpdateCanvasOptions({width:g.pindouBlockWidth,height:g.pindouBlockHeight}))}))}}},handleTransformColorToPindou(e){if(g.isUpdateAllBlock){let e=g.currentLayerIndex;if(!g.drawRecord[g.currentFrameIndex].layer[e].isRender)return;let a=g.drawRecord[g.currentFrameIndex].layer[e].layerId,t=g.layerCrossList[a].layerData;const l=Math.ceil(g.canvasWidth/g.pindouBlockWidth),n=Math.ceil(g.canvasHeight/g.pindouBlockHeight);let r=0;for(let o=0;o<n;o++)for(let e=0;e<l;e++){let a=g.pindouBlockList[r];for(let l=0;l<g.pindouBlockHeight;l++)for(let n=0;n<g.pindouBlockWidth;n++){const r=e*g.pindouBlockWidth+n,i=o*g.pindouBlockHeight+l;if(r<g.canvasWidth&&i<g.canvasHeight){const e=4*(l*g.pindouBlockWidth+n),o=4*(i*g.canvasWidth+r);t[o]=a.blockArr[e],t[o+1]=a.blockArr[e+1],t[o+2]=a.blockArr[e+2],t[o+3]=a.blockArr[e+3]}}r++}let i=new ImageData(t,g.canvasWidth,g.canvasHeight);g.layerCrossList[a].layerCtx.putImageData(i,0,0)}else{let e=g.pindouBlockList[g.currentPindouIndex],a=g.currentLayerIndex;if(!g.drawRecord[g.currentFrameIndex].layer[a].isRender)return;let t=g.drawRecord[g.currentFrameIndex].layer[a].layerId,l=g.layerCrossList[t].layerData,n=Math.ceil(g.canvasWidth/g.pindouBlockWidth);Math.ceil(g.canvasHeight/g.pindouBlockHeight);let r=g.currentPindouIndex%n,i=Math.floor(g.currentPindouIndex/n);for(let s=0;s<g.pindouBlockHeight;s++)for(let a=0;a<g.pindouBlockWidth;a++){const t=r*g.pindouBlockWidth+a,n=i*g.pindouBlockHeight+s;if(t<g.canvasWidth&&n<g.canvasHeight){const r=4*(s*g.pindouBlockWidth+a),i=4*(n*g.canvasWidth+t);l[i]=e.blockArr[r],l[i+1]=e.blockArr[r+1],l[i+2]=e.blockArr[r+2],l[i+3]=e.blockArr[r+3]}}let o=new ImageData(l,g.canvasWidth,g.canvasHeight);g.layerCrossList[t].layerCtx.putImageData(o,0,0)}e(),m.handleLayerImg(),l.$message.success("保存成功")},handleChangeCanvasSize(e,a,t=!0){e<l.$config.canvasMinSize||e>l.$config.canvasMaxSize?(g[a]=e<l.$config.canvasMinSize?l.$config.canvasMinSize:e>l.$config.canvasMaxSize?l.$config.canvasMaxSize:g[a],l.$message.warning(`画布大小必须${l.$config.canvasMinSize}-${l.$config.canvasMaxSize}像素区间`)):g[a]=Number(e),t&&g.isCheckedRatio&&("canvasWidth"===a?g.canvasHeight=parseInt(g[a]/g.widthHeightRatio):g.canvasWidth=parseInt(g[a]/g.widthHeightRatio)),(g.canvasHeight>100||g.canvasWidth>100)&&(g.isEnableCanvasGrid=!1),m.computeScale(),g.canvasBeginPos.centerX=g.canvasBeginPos.x+g.scale*g.canvasWidth/2,g.canvasBeginPos.centerY=g.canvasBeginPos.y+g.scale*g.canvasHeight/2,m.drawPixelArea(!0),m.initCanvasRecord("scale"),m.handleLayerAndFrameHighRender()},handleLayerAndFrameHighRender(){const e=document.querySelector(".frame-list"),a=document.querySelector(".layer-list");g.canvasHeight<66||g.canvasWidth<66?e.classList.add("image-pixelated"):e.classList.remove("image-pixelated"),g.canvasHeight<38||g.canvasWidth<38?a.classList.add("image-pixelated"):a.classList.remove("image-pixelated")},handleChangeRatio(e){e&&(g.widthHeightRatio=g.canvasWidth/g.canvasHeight)},async initCanvasRecord(e){if("init"===e){let e=Ia.v4();g.currentLayerId=e,await m.handleCreateLayerCrossData("add",{layerId:e}),g.drawRecord.push({frameId:Ia.v1(),currentFrameImg:null,layer:[{layerId:e,layerName:"图层1",alpha:100,isLock:!1,currentLayerImg:g.layerCrossList[e].thumbImg,isExpandMindList:!0,mindLayerList:[],isRender:!0}]}),m.handleAddHistory(),ba((()=>{m.handleLayerAndFrameHighRender()}))}else if("scale"===e){g.loading=!0,m.handleSetCanvasScale();for(let e=0;e<g.drawRecord.length;e++)for(let a=0;a<g.drawRecord[e].layer.length;a++)await m.handleCreateLayerCrossData("update",g.drawRecord[e].layer[a]);g.selectData.selectCanvasObj&&g.selectData.selectCanvasObj.ctx&&(g.selectData.selectCanvasObj.canvas.width=g.canvasWidth,g.selectData.selectCanvasObj.canvas.height=g.canvasHeight,g.selectData.selectCanvasObj.selectCanvas.width=g.canvasWidth,g.selectData.selectCanvasObj.selectCanvas.height=g.canvasHeight),m.reDraw(),g.loading=!1}},handleChangeCanvasGrid(){if(g.canvasHeight>100||g.canvasWidth>100)return g.isEnableCanvasGrid=!1,l.$message.warning("画布大小须小于100，才能开启画布格子");m.drawPixelArea(!0)},drawPixelArea(e=!1){if(!e&&g.drawAreaGridCanvas&&g.ctx2.drawImage(g.drawAreaGridCanvas,0,0,g.bgCanvas.width,g.bgCanvas.height),e){let e=h.themeValue?g.drawAreaGridColor.dark:g.drawAreaGridColor.light;if(g.ctx2.clearRect(0,0,g.bgCanvas.width,g.bgCanvas.height),g.ctx2.globalAlpha=.25,g.pinDouMode){let a=g.pindouBlockWidth,t=g.pindouBlockHeight;for(let l=0;l<t;l++)for(let t=0;t<a;t++){g.ctx2.fillStyle=(l+t)%2==0?e[1]:e[0];let a=t*g.pindouScaleValue,n=l*g.pindouScaleValue;g.ctx2.fillRect(a,n,g.pindouScaleValue,g.pindouScaleValue)}return}let a=g.isEnableCanvasGrid?g.canvasWidth:6,t=g.isEnableCanvasGrid?g.canvasHeight:6;g.drawAreaList=[];let l=Math.ceil(Math.max(g.bgCanvas.width,g.bgCanvas.height)/6);g.isEnableCanvasGrid&&(l=Math.ceil(Math.max(g.bgCanvas.width,g.bgCanvas.height)/Math.max(g.canvasWidth,g.canvasHeight)));for(let n=0;n<t;n++)for(let t=0;t<a;t++){g.ctx2.fillStyle=(n+t)%2==0?e[1]:e[0];let a=t*l,r=n*l;g.ctx2.fillRect(a,r,l,l),g.drawAreaList.push([a,r])}g.drawAreaGridCanvas=g.bgCanvas}m.handleDrawReferenceLine(),m.handleDrawGridLine(),m.handleIntelligentSlice(g.intelligentSliceObj)},handleDrawPindouRuler(e=g.isShowPindouRuler){g.isShowPindouRuler=e,m.handleDrawReferenceLine(),m.handleDrawPindouRulerLine()},handleDrawPindouRulerLine(){if(g.isShowPindouRuler){let e=ka(g.canvas),a=16,t=15;if(e<.3)return;g.pinDouMode&&(a=25,t=30);let l=e*t,n=e*g.pindouScaleValue,r=Math.floor(e*a)-10;g.canvasRealLeft=g.baseCanvas.getBoundingClientRect().left,g.canvasRealTop=g.baseCanvas.getBoundingClientRect().top,g.ctx0.setLineDash([]);let i=g.canvas.getBoundingClientRect().left-g.canvasRealLeft,o=g.canvas.getBoundingClientRect().top-g.canvasRealTop,s=g.canvas.getBoundingClientRect().width,c=g.canvas.getBoundingClientRect().height;g.ctx0.globalAlpha=1,g.ctx0.lineWidth=1,g.ctx0.strokeStyle="rgb(80, 80, 80)",g.ctx0.font=`${r}px PixelFont`,g.ctx0.textBaseline="middle";let d=o,u=i,p=o+c,m=i+s,y=5,f=5,v=5,C=5,w=l,x=l,L=l,D=l;o<=0&&(d=0,y=-5,w=-l),o+c>=g.baseCanvas.getBoundingClientRect().height&&(p=g.baseCanvas.getBoundingClientRect().height,f=-5,x=-l),i<=0&&(u=0,v=-5,L=-l),i+s>=g.baseCanvas.getBoundingClientRect().width&&(m=g.baseCanvas.getBoundingClientRect().width,C=-5,D=-l);let S=i<0?i:0,b=o<0?o:0;g.ctx0.beginPath(),g.ctx0.moveTo(u,d-y),g.ctx0.lineTo(u+(s+S),d-y),g.ctx0.moveTo(u,d-y-w),g.ctx0.lineTo(u+(s+S),d-y-w),g.ctx0.moveTo(u,p+f),g.ctx0.lineTo(u+(s+S),p+f),g.ctx0.moveTo(u,p+f+x),g.ctx0.lineTo(u+(s+S),p+f+x),g.ctx0.moveTo(u-v,d),g.ctx0.lineTo(u-v,d+c+b),g.ctx0.moveTo(u-v-L,d),g.ctx0.lineTo(u-v-L,d+c+b),g.ctx0.moveTo(m+C,d),g.ctx0.lineTo(m+C,d+c+b),g.ctx0.moveTo(m+C+D,d),g.ctx0.lineTo(m+C+D,d+c+b),g.ctx0.fillStyle=h.themeValue?"black":"white",g.ctx0.fillRect(u,d-y-w,s+S,w),g.ctx0.fillRect(u,p+f,s+S,x),g.ctx0.fillRect(u-v-L,d,L,c+b),g.ctx0.fillRect(m+C,d,D,c+b),g.ctx0.fillStyle=h.themeValue?"white":"black";for(let h=0;h<=g.pindouBlockWidth&&(g.ctx0.moveTo(u+h*g.pindouScaleValue*e+S,d-y),g.ctx0.lineTo(u+h*g.pindouScaleValue*e+S,d-y-w),g.ctx0.moveTo(u+h*g.pindouScaleValue*e+S,p+f),g.ctx0.lineTo(u+h*g.pindouScaleValue*e+S,p+f+x),h!==g.pindouBlockWidth);h++){let e=u+S+n*h+n/2-~~g.ctx0.measureText(h+1).width/2,a=d-w/2-y,t=u+S+n*h+n/2-~~g.ctx0.measureText(g.pindouBlockWidth-h).width/2,l=p+x/2+f;g.ctx0.fillText((h+1).toString(),e,a),g.ctx0.fillText((g.pindouBlockWidth-h).toString(),t,l)}for(let h=0;h<=g.pindouBlockHeight&&(g.ctx0.moveTo(u-v,d+h*g.pindouScaleValue*e+b),g.ctx0.lineTo(u-v-L,d+h*g.pindouScaleValue*e+b),g.ctx0.moveTo(m+C,d+h*g.pindouScaleValue*e+b),g.ctx0.lineTo(m+C+D,d+h*g.pindouScaleValue*e+b),h!==g.pindouBlockHeight);h++){let e=u-L/2-v-~~g.ctx0.measureText(h+1).width/2,a=d+b+h*n+n/2,t=m+D/2+C-~~g.ctx0.measureText(g.pindouBlockHeight-h).width/2,l=d+b+h*n+n/2;g.ctx0.fillText((h+1).toString(),e,a),g.ctx0.fillText((g.pindouBlockHeight-h).toString(),t,l)}g.ctx0.stroke()}},handleDrawPindouGridLine(e=g.isShowPindouGridLine){if(g.isShowPindouGridLine=e,g.ctx4.clearRect(0,0,g.gridCanvas.width,g.gridCanvas.height),g.gridCanvas.style.left=g.canvas.style.left,g.gridCanvas.style.top=g.canvas.style.top,g.gridCanvas.style.transform=g.canvasStyle.transform,g.isShowPindouGridLine){g.ctx4.strokeStyle=h.themeValue?"white":"black",g.ctx4.lineWidth=1,g.ctx4.beginPath();for(let e=0;e<=g.pindouBlockHeight;e++)g.ctx4.moveTo(0,e*g.pindouScaleValue),g.ctx4.lineTo(g.pindouBlockWidth*g.pindouScaleValue,e*g.pindouScaleValue);for(let e=0;e<=g.pindouBlockWidth;e++)g.ctx4.moveTo(e*g.pindouScaleValue,0),g.ctx4.lineTo(e*g.pindouScaleValue,g.pindouBlockHeight*g.pindouScaleValue);g.ctx4.stroke()}if(g.isShowPindouReferenceLine){let e=g.pindouReferenceLineGap;g.ctx4.strokeStyle=g.pindouReferenceLineColor,g.ctx4.lineWidth=4,g.ctx4.beginPath();let a=Math.floor(g.pindouBlockHeight/e),t=Math.floor(g.pindouBlockWidth/e);for(let l=0;l<=a;l++)0!==l&&(g.ctx4.moveTo(0,l*g.pindouScaleValue*e),g.ctx4.lineTo(g.pindouBlockWidth*g.pindouScaleValue,l*g.pindouScaleValue*e));for(let l=0;l<=t;l++)0!==l&&(g.ctx4.moveTo(l*g.pindouScaleValue*e,0),g.ctx4.lineTo(l*g.pindouScaleValue*e,g.pindouBlockHeight*g.pindouScaleValue));g.ctx4.stroke()}},handleDrawPindouReferenceLine(e=g.isShowPindouReferenceLine,a=g.pindouReferenceLineGap,t=g.pindouReferenceLineColor){g.isShowPindouReferenceLine=e,g.pindouReferenceLineGap=a,g.pindouReferenceLineColor=t,m.handleDrawPindouGridLine()},handleDrawGridLine(e=200){if(g.pinDouMode)return void m.handleDrawPindouGridLine(g.isShowPindouGridLine);g.gridLineTimer&&clearTimeout(g.gridLineTimer);let a=g.layerScale,t=g.canvasWidth*a,l=g.canvasHeight*a;g.ctx4.clearRect(0,0,t,l),g.gridCanvas.style.left="-9999px",g.gridCanvas.style.top="-9999px",g.isShowGridLine&&(a<15||(g.gridLineTimer=setTimeout((()=>{g.gridCanvas.width=t,g.gridCanvas.height=l,g.canvasRealLeft=g.baseCanvas.getBoundingClientRect().left,g.canvasRealTop=g.baseCanvas.getBoundingClientRect().top,g.gridCanvas.style.left=g.canvas.getBoundingClientRect().left-g.canvasRealLeft+"px",g.gridCanvas.style.top=g.canvas.getBoundingClientRect().top-g.canvasRealTop+"px",g.ctx4.strokeStyle=h.themeValue?"white":"black",g.ctx4.lineWidth=1;let e=a;g.ctx4.beginPath();let n=Math.floor(g.canvasHeight/g.gridGapSize),r=Math.floor(g.canvasWidth/g.gridGapSize);for(let a=0;a<=n;a++)g.ctx4.moveTo(0,a*e*g.gridGapSize),g.ctx4.lineTo(g.canvasWidth*e,a*e*g.gridGapSize);for(let a=0;a<=r;a++)g.ctx4.moveTo(a*e*g.gridGapSize,0),g.ctx4.lineTo(a*e*g.gridGapSize,g.canvasHeight*e);g.ctx4.stroke()}),e)))},handleDrawReferenceLine(e="vh"){if(g.ctx0.clearRect(0,0,g.baseCanvas.width,g.baseCanvas.height),g.isShowReferenceLine){let a=g.canvas.offsetLeft,t=g.canvas.offsetTop;g.ctx0.globalAlpha=1,g.ctx0.lineWidth=2,g.ctx0.lineCap="butt",g.ctx0.lineJoin="miter",g.ctx0.strokeStyle=h.themeValue?"white":"black",g.ctx0.setLineDash([5,3]),"vh"!==e&&"v"!==e||(g.ctx0.beginPath(),g.ctx0.moveTo(a+g.canvasWidth*g.scale/2,0),g.ctx0.lineTo(a+g.canvasWidth*g.scale/2,g.baseCanvas.height),g.ctx0.stroke()),"vh"!==e&&"h"!==e||(g.ctx0.beginPath(),g.ctx0.moveTo(0,t+g.canvasHeight*g.scale/2),g.ctx0.lineTo(g.baseCanvas.width,t+g.canvasHeight*g.scale/2),g.ctx0.stroke())}m.handleDrawRulerLine(),m.handleDrawPindouRulerLine()},handleDrawRulerLine(){if(g.isShowRuler){let e=g.baseCanvas.width,a=g.baseCanvas.height,t=16,l=10,n=16;const r=10,i=10;g.ctx0.strokeStyle=h.themeValue?"white":"black",g.ctx0.lineWidth=1,g.ctx0.setLineDash([0,0]);const o=e,s=0,c=a;for(let d=0;d<o;d+=r){const e=d%(r*i)==0?n:l;g.ctx0.beginPath(),g.ctx0.moveTo(d,0),g.ctx0.lineTo(d,e),g.ctx0.stroke(),d%(r*i)==0&&0!==d&&(g.ctx0.font=`${t} PixelFont`,g.ctx0.fillStyle=h.themeValue?"white":"black",g.ctx0.textAlign="center",g.ctx0.fillText(d,d,e+10))}for(let d=s;d<c;d+=r){const e=d%(r*i)==0?n:l;g.ctx0.beginPath(),g.ctx0.moveTo(0,d),g.ctx0.lineTo(e,d),g.ctx0.stroke(),d%(r*i)==0&&0!==d&&(g.ctx0.font=`${t} PixelFont`,g.ctx0.fillStyle=h.themeValue?"white":"black",g.ctx0.textAlign="center",g.ctx0.fillText(d,e+10,d+4))}}},drawLoop(){m.drawPixelArea(),g.AnimationFrameId_1=requestAnimationFrame(m.drawLoop)},drawShape(e){g.currentDrawShape=e},getCurrentLayerData:(e=g.currentFrameIndex,a=g.currentLayerIndex)=>g.drawRecord[e].layer[a].layerData,getCurrentLayerDataByLayerId(e=g.currentFrameIndex,a=g.currentLayerId){let t=g.drawRecord[e].layer.findIndex((e=>e.layerId===a));return g.drawRecord[e].layer[t]},getCurrentLayerId:(e=g.currentFrameIndex,a=g.currentLayerIndex)=>g.drawRecord[e].layer[a].layerId,getCurrentFrameId:(e=g.currentFrameIndex)=>g.drawRecord[e].frameId,getCurrentLayerIsLock:(e=g.currentFrameIndex,a=g.currentLayerIndex)=>g.drawRecord[e].layer[a].isLock,getCurrentLayerIndexById:(e=g.currentLayerId)=>g.drawRecord[g.currentFrameIndex].layer.findIndex((a=>a.layerId===e)),drawScaleFrame(){if(!g.isScaling)return;let e=0,a=0,t=[];t=8===g.currentTool?Ra(JSON.parse(JSON.stringify(g.selectData.selectList))):JSON.parse(JSON.stringify(m.getCurrentLayerData()));let n=1/0,r=1/0,i=-1/0,o=-1/0;for(let l=0;l<t.length;l++){if(t[l][2]===g.emptyColor)continue;const e=t[l][0],a=t[l][1];e<n&&(n=e),e>i&&(i=e),a<r&&(r=a),a>o&&(o=a)}if(n===1/0&&(n=0),r===1/0&&(r=0),i===-1/0&&(i=0),o===-1/0&&(o=0),n+r+i+o===0)return g.isScaling=!1,l.$message.warning("图层为空");let s=ka(g.canvas),c=i*g.scale*s+g.scale*s,d=n*g.scale*s,h=o*g.scale*s+g.scale*s,u=r*g.scale*s;e=c-d,a=h-u,g.scaleAreaData={},g.scaleAreaData={minX:n,maxX:i,minY:r,maxY:o,realmaxX:c,realminX:d,realmaxY:h,realminY:u,originArr:[],colorMaxtrix:[],coordMaxtrix:[],isRight:!1,isLeft:!1,isTop:!1,isBottom:!1},m.handleDrawScaleFrame(d-5,u-5,c+5,h+5);for(let l=0;l<t.length;l++)t[l][0]<=g.scaleAreaData.maxX&&t[l][0]>=g.scaleAreaData.minX&&t[l][1]<=g.scaleAreaData.maxY&&t[l][1]>=g.scaleAreaData.minY&&g.scaleAreaData.originArr.push(t[l]);let p=g.scaleAreaData.maxX-g.scaleAreaData.minX+1,y=g.scaleAreaData.maxY-g.scaleAreaData.minY+1;for(let l=0;l<y;l++){let e=[],a=[];for(let t=0;t<p;t++){let n=t+g.scaleAreaData.minX,r=l+g.scaleAreaData.minY,i=m.getCurrentLayerColorByCoords(n,r)||g.emptyColor;e.push([n,r]),a.push([i])}g.scaleAreaData.colorMaxtrix.push(a),g.scaleAreaData.coordMaxtrix.push(e)}},handleDrawScaleFrame(e,a,t,l,n=!0){n&&m.handleDrawReferenceLine(),g.canvasRealLeft=g.baseCanvas.getBoundingClientRect().left,g.canvasRealTop=g.baseCanvas.getBoundingClientRect().top;let r=g.canvas.getBoundingClientRect().left,i=g.canvas.getBoundingClientRect().top;e+=r-g.canvasRealLeft,t+=r-g.canvasRealLeft,a+=i-g.canvasRealTop,l+=i-g.canvasRealTop,g.ctx0.strokeStyle="blue",g.ctx0.fillStyle="white",g.ctx0.globalAlpha=.9,g.ctx0.lineWidth=2,g.ctx0.setLineDash([]),g.ctx0.beginPath(),g.ctx0.moveTo(e,a),g.ctx0.lineTo(t,a),g.ctx0.stroke(),g.ctx0.beginPath(),g.ctx0.moveTo(e,a),g.ctx0.lineTo(e,l),g.ctx0.stroke(),g.ctx0.beginPath(),g.ctx0.moveTo(e,l),g.ctx0.lineTo(t,l),g.ctx0.stroke(),g.ctx0.beginPath(),g.ctx0.moveTo(t,l),g.ctx0.lineTo(t,a),g.ctx0.stroke(),g.scaleWhitePointPos=[[t,l]],g.ctx0.beginPath(),g.ctx0.rect(t-4,l-4,8,8),g.ctx0.fill(),g.ctx0.stroke()},handleFinishScale(){if(g.isScaling=!1,8===g.currentTool){g.selectData.selectCanvasObj.ctx.clearRect(0,0,g.canvasWidth,g.canvasHeight),g.selectData.selectCanvasObj.ctx.drawImage(g.scaleCanvas,Math.round(parseFloat(g.scaleStyle.left)),Math.round(parseFloat(g.scaleStyle.top)));let e=g.selectData.selectCanvasObj.ctx.getImageData(0,0,g.canvasWidth,g.canvasHeight),a=e.data,t=ra(g.selectActiveColor);for(let l=0;l<a.length;l+=4)0!==a[l+3]&&(a[l]=t[0],a[l+1]=t[1],a[l+2]=t[2],a[l+3]=255*t[3]);g.selectData.selectCanvasObj.selectCtx.putImageData(e,0,0),m.reDraw(!1),g.ctx1.drawImage(g.selectData.selectCanvasObj.canvas,0,0),g.ctx1.drawImage(g.selectData.selectCanvasObj.selectCanvas,0,0),g.selectData.isCopySelect=!1,g.selectData.selectCanvasObj.croppedLayerData=null}else g.layerCrossList[m.getCurrentLayerId()].layerCtx.clearRect(0,0,g.canvasWidth,g.canvasHeight),g.layerCrossList[m.getCurrentLayerId()].layerCtx.drawImage(g.scaleCanvas,Math.round(parseFloat(g.scaleStyle.left)),Math.round(parseFloat(g.scaleStyle.top))),m.reDraw();g.scaleStyle.left="0px",g.scaleStyle.top="0px",g.scaleImg="",g.scaleCanvas.width=g.canvasWidth,g.scaleCanvas.height=g.canvasHeight,m.handleResizeStyle(),8!==g.currentTool&&m.handleChangeTool(0)},handleCancelScale(){g.isScaling=!1,g.scaleStyle.left="0px",g.scaleStyle.top="0px",g.scaleImg="",g.scaleCanvas.width=g.canvasWidth,g.scaleCanvas.height=g.canvasHeight,m.handleResizeStyle(),8===g.currentTool?(m.reDraw(!1),g.ctx1.drawImage(g.selectData.selectCanvasObj.canvas,0,0),g.ctx1.drawImage(g.selectData.selectCanvasObj.selectCanvas,0,0),g.selectData.isCopySelect=!1,g.selectData.selectCanvasObj.croppedLayerData=null):m.reDraw(!1),8!==g.currentTool&&m.handleChangeTool(0)},drawTransform(e){if(!g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender)return;if(g.isScaling&&"scale"!==e&&m.handleCancelScale(),g.isScaling&&"scale"===e)return;if(g.currentDrawTransform=e,"scale"===e){m.handleChangeTool(9),g.isScaling=!0;let e=g.canvasWidth,a=g.canvasHeight;if(8===g.currentTool){if(g.selectData.selectCanvasObj.croppedLayerData)for(let e=0;e<g.selectData.selectCanvasObj.croppedLayerData.length;e++)g.layerCrossList[g.currentLayerId].layerCtx.putImageData(g.selectData.selectCanvasObj.croppedLayerData[e].croppedImageData,g.selectData.selectCanvasObj.croppedLayerData[e].minX,g.selectData.selectCanvasObj.croppedLayerData[e].minY);g.scaleImg=g.selectData.selectCanvasObj.canvas.toDataURL(g.exportFormat,1)}else g.scaleImg=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].currentLayerImg;return g.resizeStyle.width=e*g.layerScale+"px",g.resizeStyle.height=a*g.layerScale+"px",g.scaleStyle.width=e+"px",g.scaleStyle.height=a+"px",g.scaleCanvas.width=e,g.scaleCanvas.height=a,g.ctx5.imageSmoothingEnabled=!1,g.ctx5.imageSmoothingQuality="none",8!==g.currentTool?m.reDraw(!1,!1,!1):m.reDraw(!1),m.handleResizeStyle(),void(g.scaleBoxDom.children[0].children[0].onload=()=>{g.ctx5.drawImage(g.scaleBoxDom.children[0].children[0],0,0)})}if(8===g.currentTool){if(g.selectData.selectCanvasObj.croppedLayerData)for(let e=0;e<g.selectData.selectCanvasObj.croppedLayerData.length;e++)g.layerCrossList[g.currentLayerId].layerCtx.putImageData(g.selectData.selectCanvasObj.croppedLayerData[e].croppedImageData,g.selectData.selectCanvasObj.croppedLayerData[e].minX,g.selectData.selectCanvasObj.croppedLayerData[e].minY);if("hReverse"===e){const e=Ma({layerCanvas:g.selectData.selectCanvasObj.canvas,layerCtx:g.selectData.selectCanvasObj.ctx}),a=Ma({layerCanvas:g.selectData.selectCanvasObj.selectCanvas,layerCtx:g.selectData.selectCanvasObj.selectCtx});g.selectData.selectCanvasObj.ctx.putImageData(e,0,0),g.selectData.selectCanvasObj.selectCtx.putImageData(a,0,0)}else if("vReverse"===e){const e=Fa({layerCanvas:g.selectData.selectCanvasObj.canvas,layerCtx:g.selectData.selectCanvasObj.ctx}),a=Fa({layerCanvas:g.selectData.selectCanvasObj.selectCanvas,layerCtx:g.selectData.selectCanvasObj.selectCtx});g.selectData.selectCanvasObj.ctx.putImageData(e,0,0),g.selectData.selectCanvasObj.selectCtx.putImageData(a,0,0)}else if("cReverse"===e){const e=Pa({layerCanvas:g.selectData.selectCanvasObj.canvas,layerCtx:g.selectData.selectCanvasObj.ctx}),a=Pa({layerCanvas:g.selectData.selectCanvasObj.selectCanvas,layerCtx:g.selectData.selectCanvasObj.selectCtx});g.selectData.selectCanvasObj.ctx.putImageData(e,0,0),g.selectData.selectCanvasObj.selectCtx.putImageData(a,0,0)}return m.reDraw(!1),g.ctx1.drawImage(g.selectData.selectCanvasObj.canvas,0,0),g.ctx1.drawImage(g.selectData.selectCanvasObj.selectCanvas,0,0),g.selectData.isCopySelect=!1,void(g.selectData.selectCanvasObj.croppedLayerData=null)}let a=m.getCurrentLayerId();if(g.isControlMindObj){if("hReverse"===e){const e=Ma({layerCanvas:g.scaleCanvas,layerCtx:g.ctx5});g.ctx5.putImageData(e,0,0)}else if("vReverse"===e){const e=Fa({layerCanvas:g.scaleCanvas,layerCtx:g.ctx5});g.ctx5.putImageData(e,0,0)}else if("cReverse"===e){const e=Pa({layerCanvas:g.scaleCanvas,layerCtx:g.ctx5});g.ctx5.putImageData(e,0,0)}}else{if("hReverse"===e){const e=Ma(g.layerCrossList[a]);g.layerCrossList[a].layerCtx.putImageData(e,0,0)}else if("vReverse"===e){const e=Fa(g.layerCrossList[a]);g.layerCrossList[a].layerCtx.putImageData(e,0,0)}else if("cReverse"===e){const e=Pa(g.layerCrossList[a]);g.layerCrossList[a].layerCtx.putImageData(e,0,0)}else{if("rotate"===e)return l.$refs.CanvasRotateDialog.handleOpen(),void m.handleCancelKeyboardEvent();"crop"===e&&m.handleChangeTool(11)}m.reDraw()}},handleConfirmCanvasRotate({rotateAngle:e,imageSmoothingEnabled:a},t){let l=g.layerCrossList[m.getCurrentLayerId()];const n=l.layerCanvas.width,r=l.layerCanvas.height,i=n/2,o=r/2;l.layerCtx.save(),l.layerCtx.translate(i,o),l.layerCtx.rotate(e*Math.PI/180),l.layerCtx.translate(-i,-o),l.layerCtx.clearRect(0,0,n,r);const s=new Image;s.src=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].currentLayerImg,s.onload=()=>{l.layerCtx.drawImage(s,0,0),l.layerCtx.restore(),m.reDraw(),t()}},handleLayerMapDataToLayerData(e=!1){let a=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData;e&&(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData=JSON.parse(JSON.stringify(g.emptyLayerData)));let t=Object.keys(a);for(let l=0;l<t.length;l++){let e=a[t[l]];for(const[a,n]of e){if(n[0]>=g.canvasWidth||n[1]>=g.canvasHeight||n[0]<0||n[1]<0)return;let e=n[0]+n[1]*g.canvasWidth;g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[e][2]=t[l]}}},handleAllLayerMapDataToLayerData(){let e=g.drawRecord[g.currentFrameIndex].layer;for(let a=0;a<e.length;a++){let e=g.drawRecord[g.currentFrameIndex].layer[a].layerNewData,t=Object.keys(e);for(let l=0;l<t.length;l++){let n=e[t[l]];for(const[e,r]of n){if(r[0]>=g.canvasWidth||r[1]>=g.canvasHeight||r[0]<0||r[1]<0)return;let e=r[0]+r[1]*g.canvasWidth;g.drawRecord[g.currentFrameIndex].layer[a].layerData[e][2]=t[l]}}}},handleCurrentLayerDataToLayerMapData(e){let a=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData,t={};for(let l=0;l<a.length;l++){if("#00000000"===a[l][2])continue;let e=a[l][0]+"/"+a[l][1];t[a[l][2]]||(t[a[l][2]]=new Map),t[a[l][2]].set(e,[a[l][0],a[l][1]])}g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData=t,e()},handleLayerDataToLayerMapData(e){let a=Ba(g.drawRecord[g.currentFrameIndex].layer);g.worker.postMessage({type:14,variables:a}),g.worker.onmessage=a=>{g.drawRecord[g.currentFrameIndex].layer=a.data,e()}},drawTransformSymmetric(){let e=[];for(let a=0;a<g.drawList.length;a++)if(g.isHorizontal){let t=g.canvasWidth-1-g.drawList[a][0],l=g.drawList[a][1];e.push([t,l,g.drawList[a][2]])}else if(g.isVertical){let t=g.drawList[a][0],l=g.canvasHeight-1-g.drawList[a][1];e.push([t,l,g.drawList[a][2]])}else if(g.isCenter){let t=g.drawList[a][0]*g.scale+g.canvasBeginPos.x,l=g.drawList[a][1]*g.scale+g.canvasBeginPos.y,n=2*g.canvasBeginPos.centerX-(t+g.scale/2),r=2*g.canvasBeginPos.centerY-(l+g.scale/2),i=Math.floor((n-g.canvasBeginPos.x)/g.scale),o=Math.floor((r-g.canvasBeginPos.y)/g.scale);e.push([i,o,g.drawList[a][2]])}for(let a=0;a<e.length;a++)m.addDrawList(e[a][0],e[a][1],e[a][2])},removeDrawTransformSymmetric(){let e=[];for(let a=0;a<g.removeDrawList.length;a++)if(g.isHorizontal){let t=g.canvasWidth-1-g.removeDrawList[a][0],l=g.removeDrawList[a][1];e.push([t,l,g.removeDrawList[a][2]])}else if(g.isVertical){let t=g.removeDrawList[a][0],l=g.canvasHeight-1-g.removeDrawList[a][1];e.push([t,l,g.removeDrawList[a][2]])}else if(g.isCenter){let t=g.removeDrawList[a][0]*g.scale+g.canvasBeginPos.x,l=g.removeDrawList[a][1]*g.scale+g.canvasBeginPos.y,n=2*g.canvasBeginPos.centerX-(t+g.scale/2),r=2*g.canvasBeginPos.centerY-(l+g.scale/2),i=Math.floor((n-g.canvasBeginPos.x)/g.scale),o=Math.floor((r-g.canvasBeginPos.y)/g.scale);e.push([i,o,g.removeDrawList[a][2]])}for(let a=0;a<e.length;a++){m.addRemoveDrawList(e[a][0],e[a][1],e[a][2]);let t=e[a][0]*g.scale,l=e[a][1]*g.scale;m.checkLayerEraseOrder(t,l,g.eraserSize*g.scale)}},handleChangeBrushSymmetric(e,a){"isHorizontal"===a&&g[a]?(g.isVertical=!1,g.isCenter=!1):"isCenter"===a&&g[a]?(g.isVertical=!1,g.isHorizontal=!1):"isVertical"===a&&g[a]&&(g.isHorizontal=!1,g.isCenter=!1)},handleWheelEvent(e){if(g.pinDouMode){const a=e.deltaY>0?-.02:.02;let t=ka(g.canvas);t+=a;let l=Math.max(.1,t);return l>g.maxScale&&(l=g.maxScale),g.layerScale=Number(l.toFixed(2)),g.canvasStyle.transform=`scale(${g.layerScale})`,m.handleDrawGridLine(),m.handleIntelligentSlice(g.intelligentSliceObj),g.linmoFitCanvasTimer&&clearTimeout(g.linmoFitCanvasTimer),void(g.linmoFitCanvasTimer=setTimeout((()=>{m.handleDrawReferenceLine(),m.handlePindouBlockHighlight(g.pindouHighlightOptions)}),250))}const a=e.deltaY>0?-g.layerScaleStep:g.layerScaleStep;let t=ka(g.canvas);t+=a;let l=Math.max(.1,t);l>g.maxScale&&(l=g.maxScale),g.layerScale=Number(l.toFixed(2)),g.canvasStyle.transform=`scale(${g.layerScale})`,m.handleDrawGridLine(),m.handleIntelligentSlice(g.intelligentSliceObj),g.linmoFitCanvasTimer&&clearTimeout(g.linmoFitCanvasTimer),g.linmoFitCanvasTimer=setTimeout((()=>{m.handleLinmoFitCanvas(),m.handleDrawReferenceLine(),m.handleScaleFrame1(),m.handleInitAxisOffset()}),250)},handleSetCanvasScale(){g.canvasStyle.transform=`scale(${g.layerScale})`,m.handleDrawGridLine(),m.handleIntelligentSlice(g.intelligentSliceObj),g.linmoFitCanvasTimer&&clearTimeout(g.linmoFitCanvasTimer),g.linmoFitCanvasTimer=setTimeout((()=>{m.handleLinmoFitCanvas(),m.handleDrawReferenceLine(),m.handleScaleFrame1(),m.handleInitAxisOffset()}),250)},handleResizeCanvas(e){if(g.pinDouMode){let a=ka(g.canvas);a+=e-.08;let t=Math.max(.1,a);return t>g.maxScale&&(t=g.maxScale),g.layerScale=Number(t.toFixed(2)),g.canvasStyle.transformOrigin="center center",g.canvasStyle.transform=`scale(${g.layerScale})`,m.handleDrawGridLine(),m.handleIntelligentSlice(g.intelligentSliceObj),g.linmoFitCanvasTimer&&clearTimeout(g.linmoFitCanvasTimer),void(g.linmoFitCanvasTimer=setTimeout((()=>{m.handleDrawReferenceLine(),m.handlePindouBlockHighlight(g.pindouHighlightOptions)}),250))}let a=ka(g.canvas);a+=e;let t=Math.max(.1,a);t>g.maxScale&&(t=g.maxScale),g.layerScale=Number(t.toFixed(2)),g.canvasStyle.transformOrigin="center center",g.canvasStyle.transform=`scale(${g.layerScale})`,m.handleDrawGridLine(),m.handleIntelligentSlice(g.intelligentSliceObj),g.linmoFitCanvasTimer&&clearTimeout(g.linmoFitCanvasTimer),g.linmoFitCanvasTimer=setTimeout((()=>{m.handleLinmoFitCanvas(),m.handleDrawReferenceLine(),m.handleScaleFrame1(),m.handleInitAxisOffset()}),250)},handleResizeDraw(){m.drawPixelArea(),g.isScaling?m.handleScaleFrame():g.pinDouMode?m.handleDrawPindou(g.ctx1):m.reDraw(!1)},startDrawing(){var e,a,t,l,n,r,i,o;g.canvas.addEventListener("mousedown",m.start),g.canvas.addEventListener("mousemove",m.draw),g.canvas.addEventListener("mouseup",m.stop),g.canvas.addEventListener("touchstart",m.mobileStart),g.canvas.addEventListener("touchmove",m.mobileDraw),g.canvas.addEventListener("touchend",m.mobileStop),g.canvas.addEventListener("mouseout",m.leave),g.canvas.addEventListener("wheel",m.handleWheelEvent);let s=document.getElementsByClassName("resize-handle");Array.from(s).forEach((e=>{e.addEventListener("mousedown",m.startResize),e.addEventListener("mouseup",m.stopResize),e.addEventListener("touchstart",m.mobileStartResize),e.addEventListener("touchend",m.mobileStopResize)})),null==(e=document.getElementById("ResizeBox"))||e.addEventListener("mousedown",m.handleScaleCanvasDown),null==(a=document.getElementById("ResizeBox"))||a.addEventListener("mouseup",m.handleScaleCanvasUp),null==(t=document.getElementById("ResizeBox"))||t.addEventListener("touchstart",m.handleMobileScaleCanvasDown),null==(l=document.getElementById("ResizeBox"))||l.addEventListener("touchend",m.handleMobileScaleCanvasUp),g.baseCanvas.parentNode.addEventListener("touchstart",m.handleMobileScaleStart),g.baseCanvas.parentNode.addEventListener("touchmove",m.handleMobileScaleMove),g.baseCanvas.parentNode.addEventListener("touchend",m.handleMobileScaleEnd),null==(n=document.querySelector(".X-line"))||n.addEventListener("mousedown",m.handleXYLineMouseDown),null==(r=document.querySelector(".Y-line"))||r.addEventListener("mousedown",m.handleXYLineMouseDown),null==(i=document.querySelector(".X-line"))||i.addEventListener("touchstart",m.handleXYLineMobileDown),null==(o=document.querySelector(".Y-line"))||o.addEventListener("touchstart",m.handleXYLineMobileDown)},handleLinmoFitCanvas(e=g.isLockCanvas){g.isLockCanvas=e,(g.linmoMode||g.linmoPhoto)&&g.isLockCanvas&&(l.$refs.LinmoModeDialog.posX=g.canvas.getBoundingClientRect().left-g.baseCanvas.getBoundingClientRect().left-10,l.$refs.LinmoModeDialog.posY=g.canvas.getBoundingClientRect().top-g.baseCanvas.getBoundingClientRect().top-10,l.$refs.LinmoModeDialog.width=g.canvas.getBoundingClientRect().width+20,l.$refs.LinmoModeDialog.height=g.canvas.getBoundingClientRect().height+20,l.$refs.LinmoModeDialog.updatelinmoPhotoStyle())},handleUpdateLinmoStyle(e){g.linmoPhotoStyle=e.style,l.$refs.LinmoModeDialog.posX=e.data.translateX,l.$refs.LinmoModeDialog.posY=e.data.translateY,l.$refs.LinmoModeDialog.width=e.data.width,l.$refs.LinmoModeDialog.height=e.data.height,l.$refs.LinmoModeDialog.rotate=e.data.rotate},handleMoveCanvasMouseDown(e){},handleMoveCanvasMouseMove(e){},handleMoveCanvasMouseUp(){},linmoPhotoStart(e){g.dragLinmoPhoto.enable=!0,g.dragLinmoPhoto.startX=e.offsetX,g.dragLinmoPhoto.startY=e.offsetY,g.dragLinmoPhoto.translateX=parseInt(getComputedStyle(g.linmoPhotoDom).transform.split(" ")[12]),g.dragLinmoPhoto.translateY=parseInt(getComputedStyle(g.linmoPhotoDom).transform.split(" ")[13]),document.addEventListener("mousemove",m.linmoPhotoMove),document.addEventListener("touchmove",m.linmoPhotoMobileMove),document.addEventListener("mouseup",m.linmoPhotoStop)},lnmoPhotoMobileStart(e){let a={offsetX:e.touches[0].clientX,offsetY:e.touches[0].clientY};m.linmoPhotoStart(a)},linmoPhotoMove(e){if(g.dragLinmoPhoto.enable){const a=e.offsetX-g.dragLinmoPhoto.startX,t=e.offsetY-g.dragLinmoPhoto.startY;g.dragLinmoPhoto.translateX+=a,g.dragLinmoPhoto.translateY+=t,l.$refs.LinmoModeDialog.posX=g.dragLinmoPhoto.translateX,l.$refs.LinmoModeDialog.posY=g.dragLinmoPhoto.translateY;let n=g.linmoPhotoStyle.transform.split(") ")[1]+")",r=g.linmoPhotoStyle.transform.split(") ")[2];g.linmoPhotoStyle.transform=`translate3d(${g.dragLinmoPhoto.translateX}px, ${g.dragLinmoPhoto.translateY}px, 10px) ${n} ${r}`}},linmoPhotoMobileMove(e){let a={offsetX:e.touches[0].clientX,offsetY:e.touches[0].clientY};m.linmoPhotoMove(a)},linmoPhotoStop(){g.dragLinmoPhoto.enable=!1,document.removeEventListener("mousemove",m.linmoPhotoMove),document.removeEventListener("touchmove",m.linmoPhotoMobileMove),document.removeEventListener("mouseup",m.linmoPhotoStop)},handleBrushColorAlpha(){let e=Aa(g.brushColor),a=e[0],t=e[1],l=e[2],n=g.layerAlpha/100;return Ea([a,t,l,n])},handleMobileScaleStart(e){if(2===e.touches.length&&g.isSpace){const a=e.touches[0].clientX-e.touches[1].clientX,t=e.touches[0].clientY-e.touches[1].clientY;g.mobileStartDistance=Math.sqrt(a*a+t*t)}},mobileStart(e){let a={offsetX:Math.round(Math.round(e.touches[0].clientX-g.canvas.getBoundingClientRect().left)/g.layerScale),offsetY:Math.round(Math.round(e.touches[0].clientY-g.canvas.getBoundingClientRect().top)/g.layerScale)};e.offsetX=a.offsetX,e.offsetY=a.offsetY,e.clientX=e.touches[0].clientX,e.clientY=e.touches[0].clientY,m.start(e)},mobileStop(e){e.clientX=e.changedTouches[0].clientX,e.clientY=e.changedTouches[0].clientY,m.stop(e)},checkCurrentLayerMindLock(e=!1){if(g.pinDouMode)return!1;let a=m.getCurrentLayerId();if(e){let e=!1;for(let t=0;t<g.drawRecord[g.currentFrameIndex].layer.length;t++){if(!g.drawRecord[g.currentFrameIndex].layer[t].mindLayerList.length)return e;if(g.drawRecord[g.currentFrameIndex].layer[t].mindLayerList.map((e=>!g.layerCrossList[a].mindLayerList[e].isHide)).length){e=!0;break}}return e}return g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].mindLayerList.map((e=>!g.layerCrossList[a].mindLayerList[e].isHide)).length>0},start(e){var a;if(e){m.stop(e);let t=g.canvas.getBoundingClientRect(),n=Math.floor((e.clientY-t.top)/g.layerScale),r=Math.floor((e.clientX-t.left)/g.layerScale);if(g.pinDouMode&&(n=Math.floor(e.offsetY/g.pindouScaleValue),r=Math.floor(e.offsetX/g.pindouScaleValue)),g.isSpace)return g.isDragging=!0,g.dragData.x=e.clientX-g.canvas.offsetLeft,void(g.dragData.y=e.clientY-g.canvas.offsetTop);let i=m.checkCurrentLayerMindLock();if(7!==g.currentTool&&i)return l.$message.warning("请将智能对象栅格化后编辑");if(g.pinDouMode){let e=r+n*g.pindouBlockWidth,a=g.pindouBlockList[g.currentPindouIndex].colorArr;if("#"===a[e]&&0!==g.currentTool)return;let t="#"===a[e]?"#00000000":g.pindouBlockList[g.currentPindouIndex].colorStatList.get(a[e])[0],i={name:a[e],color:t,col:r,row:n};if(0===g.currentTool){if(g.isUpdateAllBlock)return l.$message.warning("请先关闭批量更新分块");let e=l.$refs.PindouDialog.replaceObj;if(!e)return l.$message.warning("请先选择替换的新色号");g.isMovingPindouBrush=!0;let a={replaceObj:{color:"#"+e.color,name:e.name},originObj:i,type:1};m.handleReplacePindouColor(a,(()=>{}))}else if(1===g.currentTool){if(g.isUpdateAllBlock)return l.$message.warning("请先关闭批量更新分块");g.isMovingPindouBrush=!0;let e={replaceObj:{color:"#00000000",name:"#"},originObj:i,type:1};m.handleReplacePindouColor(e,(()=>{}))}else 2===g.currentTool?l.$refs.PindouDialog.replaceObj={name:i.name,color:i.color.slice(1)}:5===g.currentTool&&(l.$refs.PindouDialog.selectedObj=i);return}if(0===g.currentTool){if(e.button&&0!==e.button){if(2===e.button){if(g.isEnableEraserTrack){g.ctx0.lineWidth=g.eraserSize*g.layerScale,g.ctx0.lineCap="round",g.ctx0.lineJoin="round",g.ctx0.strokeStyle="#fff";let a=g.baseCanvas.getBoundingClientRect();g.mouseDrawData.lastX=e.clientX-a.left,g.mouseDrawData.lastY=e.clientY-a.top,g.mouseDrawData.baseRect={left:a.left,top:a.top}}g.mouseDrawData.startX=r-r%(g.scale*g.eraserSize),g.mouseDrawData.startY=n-n%(g.scale*g.eraserSize),g.isErasering=!0}}else{let e=m.handleBrushColorAlpha();g.ctx1.fillStyle=e,g.layerCrossList[m.getCurrentLayerId()].layerCtx.fillStyle=e,g.mouseDrawData.startX=r-r%(g.scale*g.brushSize),g.mouseDrawData.startY=n-n%(g.scale*g.brushSize),g.isDrawing=!0}m.draw(e)}else if(1===g.currentTool)if(g.isEnableEraserTrack&&(g.ctx0.lineWidth=g.eraserSize*g.layerScale,g.ctx0.lineCap="round",g.ctx0.lineJoin="round",g.ctx0.strokeStyle="#fff"),e.button&&0!==e.button){if(2===e.button){const e=m.getPixelColorByCoords(g.layerCrossList[m.getCurrentLayerId()].layerData,r,n);if("0000"===e.join(""))return;m.fillChunkSelectV2(r,n,e,!0)}}else{if(g.mouseDrawData.startX=r-r%(g.scale*g.eraserSize),g.mouseDrawData.startY=n-n%(g.scale*g.eraserSize),g.isEnableEraserTrack){let a=g.baseCanvas.getBoundingClientRect();g.mouseDrawData.lastX=e.clientX-a.left,g.mouseDrawData.lastY=e.clientY-a.top,g.mouseDrawData.baseRect={left:a.left,top:a.top}}g.isErasering=!0,m.draw(e)}else if(2===g.currentTool){const e=Array.from(g.ctx1.getImageData(r,n,1,1).data);if("0000"!==e.join("")&&(g.brushColor=ia(e),g.isAutoChangeBrush&&(m.handleChangeTool(0),g.canvas.classList="",m.addCursorClass()),l.$refs.ReplaceColorDialog.dialogVisible&&l.$refs.ReplaceColorDialog.handleUpdate(g.brushColor),g.pinDouDrawMode)){let e={color:g.brushColor,col:r,row:n};l.$refs.PindouDialog.selectedObj=e}}else if(3===g.currentTool){let e=m.handleBrushColorAlpha();g.ctx1.fillStyle=e,g.ctx1.strokeStyle=e,g.ctx1.lineWidth=g.brushSize,g.layerCrossList[m.getCurrentLayerId()].layerCtx.fillStyle=e,g.layerCrossList[m.getCurrentLayerId()].layerCtx.strokeStyle=e,g.layerCrossList[m.getCurrentLayerId()].layerCtx.lineWidth=g.brushSize,g.isDrawShape=!0,g.drawShapeData.startX=r,g.drawShapeData.startY=n}else if(4===g.currentTool){let e=Aa(g.brushColor);const a=Array.from(g.layerCrossList[m.getCurrentLayerId()].layerCtx.getImageData(r,n,1,1).data);if(m.fillChunkV2(r,n,a,e),g.isHorizontal){let t=Math.floor(g.XLineOffset/g.layerScale*2)-r,l=n;m.fillChunkV2(t,l,a,e)}else if(g.isVertical){let t=r,l=Math.floor(g.YLineOffset/g.layerScale*2)-n;m.fillChunkV2(t,l,a,e)}else if(g.isCenter){let t=2*g.canvasBeginPos.centerX-(r+g.scale/2),l=2*g.canvasBeginPos.centerY-(n+g.scale/2),i=Math.floor(t/g.scale),o=Math.floor(l/g.scale);m.fillChunkV2(i,o,a,e)}}else if(7===g.currentTool){if(i){let e=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex];for(let a=e.mindLayerList.length-1;a>=0;a--){let t=g.layerCrossList[e.layerId].mindLayerList[e.mindLayerList[a]];if(r>=t.left&&r<=t.width+t.left-1&&n>=t.top&&n<=t.height+t.top-1)return void m.handleSelectMindObj(t.mindId,g.currentLayerIndex)}return}for(let a=0;a<g.drawRecord[g.currentFrameIndex].layer.length;a++){let e=g.drawRecord[g.currentFrameIndex].layer[a].layerId,t=Array.from(g.layerCrossList[e].layerCtx.getImageData(r,n,1,1).data);if("0000"!==t.join("")){if("0000"!==t.join("")){g.moveData.moveLayerId=e;break}}else g.moveData.moveLayerId=""}if(""===g.moveData.moveLayerId)return;if(m.getCurrentLayerId()!==g.moveData.moveLayerId){let e=m.getCurrentLayerIndexById(g.moveData.moveLayerId);m.handleChangeLayer(e)}g.isMoving=!0,g.isShowReferenceLine=!0,g.moveData.x=r,g.moveData.y=n,g.moveData.imageData=g.layerCrossList[g.moveData.moveLayerId].layerCtx.getImageData(0,0,g.canvasWidth,g.canvasHeight);let e=null==(a=g.moveData.imageData)?void 0:a.data,t=1/0,l=1/0,o=-1/0,s=-1/0;for(let a=0;a<g.canvasHeight;a++)for(let n=0;n<g.canvasWidth;n++){e[4*(a*g.canvasWidth+n)+3]>0&&(n<t&&(t=n),n>o&&(o=n),a<l&&(l=a),a>s&&(s=a))}g.moveData.centerX=(o-t)/2+t,g.moveData.centerY=(s-l)/2+l,g.canvasBeginPos.centerX=(g.canvasWidth-1)/2,g.canvasBeginPos.centerY=(g.canvasHeight-1)/2}else if(8===g.currentTool&&"select"===g.selectType){g.isScaling&&m.handleCancelScale();let a=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex];if(!a.isRender)return;if(e.button&&0!==e.button){if(2===e.button){let e=g.selectData.selectCanvasObj.ctx.getImageData(0,0,g.canvasWidth,g.canvasHeight);const t=ia(m.getPixelColorByCoords(e.data,r,n));if(t===g.emptyColor)return;g.selectData.selectCanvasObj.selectCtx.clearRect(r,n,1,1),g.selectData.selectCanvasObj.ctx.clearRect(r,n,1,1),g.layerCrossList[a.layerId].layerCtx.fillStyle=t,g.layerCrossList[a.layerId].layerCtx.fillRect(r,n,1,1),g.ctx1.fillStyle=t,g.ctx1.fillRect(r,n,1,1)}}else{let t=ia(m.getPixelColorByCoords(g.layerCrossList[a.layerId].layerData,r,n));g.selectData.selectLayerId!==a.layerId&&t!==g.emptyColor&&(m.handleCancelSelect(),g.selectData.selectLayerId=a.layerId),g.isSelecting=!0,g.selectData.x=r,g.selectData.y=n,g.selectData.selectCanvasObj.selectCtx.fillStyle=g.selectActiveColor,g.ctx1.fillStyle=g.selectActiveColor;let l=g.selectData.selectCanvasObj.ctx.getImageData(0,0,g.canvasWidth,g.canvasHeight);if(ia(m.getPixelColorByCoords(l.data,r,n))!==g.emptyColor){if(g.selectData.selectCanvasObj.croppedLayerData)for(let e=0;e<g.selectData.selectCanvasObj.croppedLayerData.length;e++)g.layerCrossList[g.currentLayerId].layerCtx.putImageData(g.selectData.selectCanvasObj.croppedLayerData[e].croppedImageData,g.selectData.selectCanvasObj.croppedLayerData[e].minX,g.selectData.selectCanvasObj.croppedLayerData[e].minY);return g.selectData.isCopySelect&&g.layerCrossList[g.currentLayerId].layerCtx.drawImage(g.selectData.selectCanvasObj.canvas,0,0),g.canvas.style.cursor="move",g.selectData.selectCanvasObj.imageData=l,g.selectData.selectCanvasObj.selectImageData=g.selectData.selectCanvasObj.selectCtx.getImageData(0,0,g.canvasWidth,g.canvasHeight),void(g.selectData.isMoving=!0)}m.draw(e)}}else if(8===g.currentTool&&"quickSelect"===g.selectType){let a=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex];if(!a.isRender)return;if(e.button&&0!==e.button)2===e.button&&m.handleCancelSelect();else{let e=ia(m.getPixelColorByCoords(g.layerCrossList[a.layerId].layerData,r,n));g.selectData.selectLayerId!==a.layerId&&e!==g.emptyColor&&(m.handleCancelSelect(),g.selectData.selectLayerId=a.layerId),g.isSelecting=!0,g.selectData.x=r,g.selectData.y=n;let t=g.selectData.selectCanvasObj.ctx.getImageData(0,0,g.canvasWidth,g.canvasHeight);if(ia(m.getPixelColorByCoords(t.data,r,n))!==g.emptyColor){if(g.selectData.selectCanvasObj.croppedLayerData)for(let e=0;e<g.selectData.selectCanvasObj.croppedLayerData.length;e++)g.layerCrossList[g.currentLayerId].layerCtx.putImageData(g.selectData.selectCanvasObj.croppedLayerData[e].croppedImageData,g.selectData.selectCanvasObj.croppedLayerData[e].minX,g.selectData.selectCanvasObj.croppedLayerData[e].minY);return g.selectData.isCopySelect&&g.layerCrossList[g.currentLayerId].layerCtx.drawImage(g.selectData.selectCanvasObj.canvas,0,0),g.canvas.style.cursor="move",g.selectData.selectCanvasObj.imageData=t,g.selectData.selectCanvasObj.selectImageData=g.selectData.selectCanvasObj.selectCtx.getImageData(0,0,g.canvasWidth,g.canvasHeight),void(g.selectData.isMoving=!0)}if(e!==g.emptyColor){let a=ra(e);a[3]=255*a[3],m.fillChunkSelectV2(r,n,a)}}}else if(8===g.currentTool&&"rangeSelect"===g.selectType){if(!g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender)return;let a=g.selectData.selectCanvasObj.ctx.getImageData(0,0,g.canvasWidth,g.canvasHeight);if(ia(m.getPixelColorByCoords(a.data,r,n))!==g.emptyColor){if(g.isSelecting=!0,g.selectData.x=r,g.selectData.y=n,g.selectData.selectCanvasObj.croppedLayerData)for(let e=0;e<g.selectData.selectCanvasObj.croppedLayerData.length;e++)g.layerCrossList[g.currentLayerId].layerCtx.putImageData(g.selectData.selectCanvasObj.croppedLayerData[e].croppedImageData,g.selectData.selectCanvasObj.croppedLayerData[e].minX,g.selectData.selectCanvasObj.croppedLayerData[e].minY);return g.selectData.isCopySelect&&g.layerCrossList[g.currentLayerId].layerCtx.drawImage(g.selectData.selectCanvasObj.canvas,0,0),g.canvas.style.cursor="move",g.selectData.selectCanvasObj.imageData=a,g.selectData.selectCanvasObj.selectImageData=g.selectData.selectCanvasObj.selectCtx.getImageData(0,0,g.canvasWidth,g.canvasHeight),void(g.selectData.isMoving=!0)}g.isSelectDraging=!0,g.canvasRealLeft=g.baseCanvas.getBoundingClientRect().left,g.canvasRealTop=g.baseCanvas.getBoundingClientRect().top,g.lastX=e.clientX-g.canvasRealLeft,g.lastY=e.clientY-g.canvasRealTop,g.selectData.x=r,g.selectData.y=n,g.ctx0.lineWidth=2}else if(9===g.currentTool&&g.isScaling){if(!g.scaleAreaData)return;g.lastX=r,g.lastY=n,g.isScale=!0}else if(11===g.currentTool){if(!g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender)return;g.isSelectDraging=!0,g.canvasRealLeft=g.baseCanvas.getBoundingClientRect().left,g.canvasRealTop=g.baseCanvas.getBoundingClientRect().top,g.lastX=e.clientX-g.canvasRealLeft,g.lastY=e.clientY-g.canvasRealTop,g.selectData.x=r,g.selectData.y=n,g.ctx0.lineWidth=2}}},handleReplaceColor(e){for(let a=0;a<g.selectData.selectList.length;a++){g.selectData.selectList[a][2]=e;let t=g.selectData.selectList[a][0]+g.selectData.selectList[a][1]*g.canvasWidth;g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[t][2]=e}m.reDraw()},handleReplacePindouColor(e,a){if(g.pinDouDrawMode)return m.handleConfirmReplaceColor(e,a);let t=ra(e.replaceObj.color),n=ia(t),r=g.pindouBlockList[g.currentPindouIndex];if(1===e.type){if(void 0===e.originObj.col||void 0===e.originObj.row)return a(),l.$message.warning("缺少位置坐标无法替换当前像素颜色，请在画布中选择颜色具体位置");let i=[];if("#"!==e.originObj.name&&(i=r.colorStatList.get(e.originObj.name),!i))return l.$message.warning("当前选择颜色不存在"),void a();let o=e.originObj.col+e.originObj.row*g.pindouBlockWidth;if(r.colorArr[o]===e.replaceObj.name)return;if(r.colorArr[o]&&(r.colorArr[o]=e.replaceObj.name,r.blockArr[4*o]=t[0],r.blockArr[4*o+1]=t[1],r.blockArr[4*o+2]=t[2],r.blockArr[4*o+3]=255*t[3]),r.colorStatList.has(e.replaceObj.name)){let a=r.colorStatList.get(e.replaceObj.name)[1]+1;r.colorStatList.set(e.replaceObj.name,[n,a]),i.length&&(r.colorStatList.set(e.originObj.name,[i[0],i[1]-1]),i[1]-1<=0&&r.colorStatList.delete(e.originObj.name))}else i.length&&(r.colorStatList.set(e.originObj.name,[i[0],i[1]-1]),i[1]-1<=0&&r.colorStatList.delete(e.originObj.name)),"#"!==e.replaceObj.name&&r.colorStatList.set(e.replaceObj.name,[n,1]);r.ctx.fillStyle=n;let s=~~(g.pindouScaleValue/2);r.ctx.font=`400 ${s}px Arial`;let c=~~r.ctx.measureText(e.replaceObj.name).width;s=Ta(c,s),r.ctx.font=`400 ${s}px Arial`,c=~~r.ctx.measureText(e.replaceObj.name).width;let d=e.originObj.col*g.pindouScaleValue,h=e.originObj.row*g.pindouScaleValue;if("#00000000"===n?r.ctx.clearRect(d,h,g.pindouScaleValue,g.pindouScaleValue):r.ctx.fillRect(d,h,g.pindouScaleValue,g.pindouScaleValue),"#"!==e.replaceObj.name){const a=d+(g.pindouScaleValue-c)/2,t=h+(g.pindouScaleValue-s)/2+s;r.ctx.fillStyle=ca(n),r.ctx.fillText(e.replaceObj.name,~~a,~~t)}}else if(2===e.type)if(g.isUpdateAllBlock){for(let a=0;a<g.pindouBlockList.length;a++){r=g.pindouBlockList[a];let i=r.colorStatList.get(e.originObj.name);if(!i)continue;let o=0;for(let l=0;l<r.colorArr.length;l++){l%g.pindouBlockWidth==0&&(o=0);let i=Math.ceil((l+1)/g.pindouBlockWidth);if("#"!==r.colorArr[l]){if(r.colorArr[l]===e.originObj.name&&(r.colorArr[l]=e.replaceObj.name,r.blockArr[4*l]=t[0],r.blockArr[4*l+1]=t[1],r.blockArr[4*l+2]=t[2],r.blockArr[4*l+3]=255*t[3],g.currentPindouIndex===a)){let a=~~(g.pindouScaleValue/2);r.ctx.font=`400 ${a}px Arial`;let t=~~r.ctx.measureText(e.replaceObj.name).width;a=Ta(t,a),r.ctx.font=`400 ${a}px Arial`,t=~~r.ctx.measureText(e.replaceObj.name).width;let l=o*g.pindouScaleValue,s=(i-1)*g.pindouScaleValue;r.ctx.fillStyle=n,r.ctx.fillRect(l,s,g.pindouScaleValue,g.pindouScaleValue);const c=l+(g.pindouScaleValue-t)/2,d=s+(g.pindouScaleValue-a)/2+a;r.ctx.fillStyle=ca(n),r.ctx.fillText(e.replaceObj.name,~~c,~~d)}o++}else o++}if(r.colorStatList.has(e.replaceObj.name)){let a=r.colorStatList.get(e.replaceObj.name),t=i[1]+a[1];r.colorStatList.delete(e.originObj.name),r.colorStatList.set(e.replaceObj.name,[n,t])}else r.colorStatList.delete(e.originObj.name),r.colorStatList.set(e.replaceObj.name,[n,i[1]]);const s=Array.from(r.colorStatList);s.sort(((e,a)=>a[1][1]-e[1][1])),r.colorStatList=new Map(s),g.currentPindouIndex===a&&(l.$refs.PindouDialog.handleColorStatList(r.colorStatList),l.$refs.PindouDialog.handleUpdateCurrentPindouBlockColorList(r.colorStatList),m.handleDrawPindou(g.ctx1),r.blockBitmap=r.canvas.toDataURL(g.exportFormat,1));const c=new ImageData(r.blockArr,g.pindouBlockWidth,g.pindouBlockHeight),d=document.createElement("canvas");d.width=g.pindouBlockWidth,d.height=g.pindouBlockHeight;const h=d.getContext("2d");null==h||h.putImageData(c,0,0),r.blockBitmap=d.toDataURL(g.exportFormat,1)}a()}else{let i=r.colorStatList.get(e.originObj.name);if(!i)return l.$message.warning("当前选择颜色不存在"),void a();let o=~~(g.pindouScaleValue/2);r.ctx.font=`400 ${o}px Arial`;let s=~~r.ctx.measureText(e.replaceObj.name).width;o=Ta(s,o),r.ctx.font=`400 ${o}px Arial`,s=~~r.ctx.measureText(e.replaceObj.name).width;let c=0;for(let a=0;a<r.colorArr.length;a++){a%g.pindouBlockWidth==0&&(c=0);let l=Math.ceil((a+1)/g.pindouBlockWidth);if("#"!==r.colorArr[a]){if(r.colorArr[a]===e.originObj.name){r.colorArr[a]=e.replaceObj.name,r.blockArr[4*a]=t[0],r.blockArr[4*a+1]=t[1],r.blockArr[4*a+2]=t[2],r.blockArr[4*a+3]=255*t[3];let i=c*g.pindouScaleValue,d=(l-1)*g.pindouScaleValue;r.ctx.fillStyle=n,r.ctx.fillRect(i,d,g.pindouScaleValue,g.pindouScaleValue);const h=i+(g.pindouScaleValue-s)/2,u=d+(g.pindouScaleValue-o)/2+o;r.ctx.fillStyle=ca(n),r.ctx.fillText(e.replaceObj.name,~~h,~~u)}c++}else c++}if(r.colorStatList.has(e.replaceObj.name)){let a=r.colorStatList.get(e.replaceObj.name),t=i[1]+a[1];r.colorStatList.delete(e.originObj.name),r.colorStatList.set(e.replaceObj.name,[n,t])}else r.colorStatList.delete(e.originObj.name),r.colorStatList.set(e.replaceObj.name,[n,i[1]])}if(!g.isUpdateAllBlock){const e=Array.from(r.colorStatList);e.sort(((e,a)=>a[1][1]-e[1][1])),r.colorStatList=new Map(e),l.$refs.PindouDialog.handleColorStatList(r.colorStatList),l.$refs.PindouDialog.handleUpdateCurrentPindouBlockColorList(r.colorStatList),a(),1===g.currentTool?(g.ctx1.clearRect(0,0,g.canvas.width,g.canvas.height),g.ctx1.drawImage(r.canvas,0,0)):g.ctx1.drawImage(r.canvas,0,0),g.AnimationFrameId_1&&clearTimeout(g.AnimationFrameId_1),g.AnimationFrameId_1=setTimeout((()=>{const e=new ImageData(r.blockArr,g.pindouBlockWidth,g.pindouBlockHeight),a=document.createElement("canvas");a.width=g.pindouBlockWidth,a.height=g.pindouBlockHeight;const t=a.getContext("2d");null==t||t.putImageData(e,0,0),r.blockBitmap=a.toDataURL(g.exportFormat,1)}),1e3)}},getPixelColorByCoords(e,a,t,l=g.canvasWidth){const n=4*(t*l+a);return[e[n],e[n+1],e[n+2],e[n+3]]},isEmptyColorByCroods:(e,a,t)=>0===e[4*(t*g.canvasWidth+a)+3],getCurrentLayerColorByCoords:(e,a)=>g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[e+"/"+a]||g.emptyColor,fillChunkV2(e,a,t,l){if(t.join("")===l.join(""))return;let n=g.layerCrossList[m.getCurrentLayerId()].layerCtx.getImageData(0,0,g.canvasWidth,g.canvasHeight),r=n.data;const i=n.width,o=n.height,s=[];s.push({x:e,y:a});const c=new Set,d=g.tolerance,h=(e,a)=>{const t=4*(a*i+e);return[r[t],r[t+1],r[t+2],r[t+3]]},u=(e,a)=>{const[t,l,n,r]=e,[i,o,s,c]=a;return Math.abs(t-i)+Math.abs(l-o)+Math.abs(n-s)+Math.abs(r-c)<=d};for(;s.length>0;){const{x:e,y:a}=s.shift(),n=4*(a*i+e);if(c.has(n)||e<0||e>=i||a<0||a>=o)continue;u(h(e,a),t)&&(r[n]=l[0],r[n+1]=l[1],r[n+2]=l[2],r[n+3]=Math.round(g.layerAlpha/100*255),s.push({x:e+1,y:a}),s.push({x:e-1,y:a}),s.push({x:e,y:a+1}),s.push({x:e,y:a-1}),c.add(n))}g.layerCrossList[m.getCurrentLayerId()].layerCtx.putImageData(n,0,0),m.reDraw()},fillChunkSelectV2(e,a,t,l=!1){let n,r,i,o,s=g.layerCrossList[m.getCurrentLayerId()].layerCtx.getImageData(0,0,g.canvasWidth,g.canvasHeight),c=s.data;l||(n=g.selectData.selectCanvasObj.ctx.getImageData(0,0,g.canvasWidth,g.canvasHeight),r=g.selectData.selectCanvasObj.selectCtx.getImageData(0,0,g.canvasWidth,g.canvasHeight),i=n.data,o=r.data);const d=s.width,h=s.height,u=[];u.push({x:e,y:a});const p=new Set,y=g.tolerance,f=ra(g.selectActiveColor),v=(e,a)=>{const t=4*(a*d+e);return[c[t],c[t+1],c[t+2],c[t+3]]},C=(e,a)=>{const[t,l,n,r]=e,[i,o,s,c]=a;if("0000"===e.join(""))return!1;return Math.abs(t-i)+Math.abs(l-o)+Math.abs(n-s)+Math.abs(r-c)<=y};for(;u.length>0;){const{x:e,y:a}=u.shift(),n=4*(a*d+e);if(p.has(n)||e<0||e>=d||a<0||a>=h)continue;if(C(v(e,a),t)){if(!l){const e=c[n],a=c[n+1],t=c[n+2],l=c[n+3];i[n]=e,i[n+1]=a,i[n+2]=t,i[n+3]=l,o[n]=f[0],o[n+1]=f[1],o[n+2]=f[2],o[n+3]=255*f[3]}c[n]=0,c[n+1]=0,c[n+2]=0,c[n+3]=0,u.push({x:e+1,y:a}),u.push({x:e-1,y:a}),u.push({x:e,y:a+1}),u.push({x:e,y:a-1}),p.add(n)}}if(g.layerCrossList[m.getCurrentLayerId()].layerCtx.putImageData(s,0,0),l)return m.reDraw();g.selectData.selectCanvasObj.ctx.putImageData(n,0,0),g.selectData.selectCanvasObj.selectCtx.putImageData(r,0,0),m.reDraw(!1),g.ctx1.drawImage(g.selectData.selectCanvasObj.canvas,0,0),g.ctx1.drawImage(g.selectData.selectCanvasObj.selectCanvas,0,0)},fillChunk(e,a,t,l){if(t===l)return;g.loading=!0;let n=Oa(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex]),r=s(o({},n),{layerNewData:ja(n.layerNewData)});g.worker.postMessage({type:103,variables:r,options:{x:e,y:a,targetColor:t,replacementColor:l},canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight,tolerance:g.tolerance}),g.worker.onmessage=e=>{g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData=e.data.layerData,g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData=e.data.layerNewData,m.handleLayerImg((()=>{g.loading=!1,m.reDraw()}))}},fillChunkSelect(e,a,t,l=!1){if(t===g.emptyColor)return;if(g.selectData.selectMapList[t]&&g.selectData.selectMapList[t].has(`${e}/${a}`))return;g.loading=!0;let n=Oa(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData),r=Oa(g.selectData);g.worker.postMessage({type:10,variables:n,selectData:r,options:{x:e,y:a,targetColor:t},canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight,tolerance:g.tolerance}),g.worker.onmessage=e=>{g.selectData.selectList=e.data.variables.selectList,g.selectData.selectMapList=e.data.variables.selectMapList,g.loading=!1,l?m.handleRemoveSelect():m.reDrawSelectData()}},handleChangeMouseStyle(e){if(!e)return;if(!g.scaleWhitePointPos.length)return;g.canvasRealLeft=g.baseCanvas.getBoundingClientRect().left,g.canvasRealTop=g.baseCanvas.getBoundingClientRect().top;let a=e.clientX-g.canvasRealLeft,t=e.clientY-g.canvasRealTop;Math.abs(a-g.scaleWhitePointPos[0][0])<=15&&Math.abs(t-g.scaleWhitePointPos[0][1])<=15&&(g.canvas.style.cursor="se-resize",g.scaleAreaData.cursor="se-resize")},drawSquareLine(e,a,t,l){const n=g.scale*g.brushSize,r=Math.abs(t-e),i=Math.abs(l-a),o=e<t?n:-n,s=a<l?n:-n;let c=r-i;for(;;){for(let t=0;t<g.brushSize;t++){let l=a+g.scale*t;for(let a=0;a<g.brushSize;a++){let t=e+g.scale*a,n=t,r=l;m.checkLayerDrawOrder(t,l,g.scale);let i=-1,o=-1;if(g.isHorizontal)i=Math.floor(g.XLineOffset/g.layerScale*2)-n,o=r;else if(g.isVertical)i=n,o=Math.floor(g.YLineOffset/g.layerScale*2)-r;else if(g.isCenter){let e=2*g.canvasBeginPos.centerX-(n+g.scale/2),a=2*g.canvasBeginPos.centerY-(r+g.scale/2);i=Math.floor(e/g.scale),o=Math.floor(a/g.scale)}if(i>=0&&i<g.canvasWidth&&o>=0&&o<g.canvasHeight){let e=i*g.scale,a=o*g.scale;m.checkLayerDrawOrder(e,a,g.scale)}}}if(e===t&&a===l)break;const n=2*c;n>-i&&(c-=i,e+=o),n<r&&(c+=r,a+=s)}},checkLayerDrawOrder(e,a,t){if(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender){let l=4*(e+a*g.canvasWidth);if(g.currentLayerIndex>0){if(m.getCurrentLayerIsLock()){0===g.layerCrossList[g.currentLayerId].layerData[l+3]&&(g.ctx1.clearRect(e,a,t,t),g.ctx1.fillRect(e,a,t,t),g.layerCrossList[g.currentLayerId].layerCtx.clearRect(e,a,t,t),g.layerCrossList[g.currentLayerId].layerCtx.fillRect(e,a,t,t))}else g.ctx1.clearRect(e,a,t,t),g.ctx1.fillRect(e,a,t,t),g.layerCrossList[g.currentLayerId].layerCtx.clearRect(e,a,t,t),g.layerCrossList[g.currentLayerId].layerCtx.fillRect(e,a,t,t);m.reDrawV3("top")}else if(m.getCurrentLayerIsLock()){0===g.layerCrossList[g.currentLayerId].layerData[l+3]&&(g.ctx1.clearRect(e,a,t,t),g.layerCrossList[g.currentLayerId].layerCtx.clearRect(e,a,t,t),g.ctx1.fillRect(e,a,t,t),g.layerCrossList[g.currentLayerId].layerCtx.fillRect(e,a,t,t))}else g.ctx1.clearRect(e,a,t,t),g.layerCrossList[g.currentLayerId].layerCtx.clearRect(e,a,t,t),g.ctx1.fillRect(e,a,t,t),g.layerCrossList[g.currentLayerId].layerCtx.fillRect(e,a,t,t)}},eraseSquareLine(e,a,t,l){const n=g.scale*g.eraserSize,r=Math.abs(t-e),i=Math.abs(l-a),o=e<t?n:-n,s=a<l?n:-n;let c=r-i;for(;;){for(let t=0;t<g.eraserSize;t++){let l=a+g.scale*t;for(let t=0;t<g.eraserSize;t++){let n=e+g.scale*t,r=Math.floor(n/g.scale),i=Math.floor(l/g.scale);m.checkLayerEraseOrder(n,l,g.scale);let o=-1,s=-1;if(g.isHorizontal)o=Math.floor(g.XLineOffset/g.layerScale*2)-r,s=i;else if(g.isVertical)o=r,s=Math.floor(g.YLineOffset/g.layerScale*2)-i;else if(g.isCenter){let t=2*g.canvasBeginPos.centerX-(e+g.scale/2),l=2*g.canvasBeginPos.centerY-(a+g.scale/2);o=Math.floor(t/g.scale),s=Math.floor(l/g.scale)}if(o>=0&&o<g.canvasWidth&&s>=0&&s<g.canvasHeight){let e=o*g.scale,a=s*g.scale;m.checkLayerEraseOrder(e,a,g.scale)}}}if(e===t&&a===l)break;const n=2*c;n>-i&&(c-=i,e+=o),n<r&&(c+=r,a+=s)}},checkLayerEraseOrder(e,a,t){if(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender){let l=4*(e+a*g.canvasWidth);if(0!==g.layerCrossList[g.currentLayerId].layerData[l+3]){if(g.removeDrawList.push([e,a]),g.ctx1.clearRect(e,a,t,t),g.layerCrossList[g.currentLayerId].layerCtx.clearRect(e,a,t,t),g.currentLayerIndex>0)for(let n=0;n<g.currentLayerIndex;n++){let r=g.drawRecord[g.currentFrameIndex].layer[n];if(r.isRender){let n=r.layerId,i=g.layerCrossList[n].layerData;if(0===i[l+3])continue;g.ctx1.fillStyle=Ea([i[l],i[l+1],i[l+2],i[l+3]]),g.ctx1.fillRect(e,a,t,t)}}if(g.currentLayerIndex<g.drawRecord[g.currentFrameIndex].layer.length-1)for(let n=g.drawRecord[g.currentFrameIndex].layer.length-1;n>g.currentLayerIndex;n--){let r=g.drawRecord[g.currentFrameIndex].layer[n];if(r.isRender){let n=r.layerId,i=g.layerCrossList[n].layerData;if(0===i[l+3])continue;g.ctx1.fillStyle=Ea([i[l],i[l+1],i[l+2],i[l+3]]),g.ctx1.fillRect(e,a,t,t)}}}}},async handleEyeDropper(){if(!(null==window?void 0:window.EyeDropper))return l.$message.warning("当前浏览器暂不支持该功能");const e=new EyeDropper;try{const a=await e.open();g.brushColor=a.sRGBHex}catch(a){}},draw(e){if(e){let a=g.canvas.getBoundingClientRect(),t=Math.floor((e.clientY-a.top)/g.layerScale),n=Math.floor((e.clientX-a.left)/g.layerScale);if(g.pinDouMode?(t=Math.floor((e.clientY-a.top)/(g.pindouScaleValue*g.layerScale)),n=Math.floor((e.clientX-a.left)/(g.pindouScaleValue*g.layerScale)),g.gridInfo=`${t<0?1:t+1}行, ${n<0?1:n+1}列`):g.gridInfo=`${n<0?0:n}, ${t<0?0:t}`,g.isSpace){if(g.canvas.style.cursor="grabbing",g.isDragging){const a=e.clientX-g.dragData.x,t=e.clientY-g.dragData.y;g.canvas.style.left=`${a}px`,g.canvas.style.top=`${t}px`,g.scaleBoxDom.style.left=`${a}px`,g.scaleBoxDom.style.top=`${t}px`,g.bgCanvas.style.left=`${a}px`,g.bgCanvas.style.top=`${t}px`,m.handleDrawReferenceLine(),m.handleCheckAxisOffset(),g.pinDouMode||(m.handleDrawGridLine(),m.handleIntelligentSlice(g.intelligentSliceObj)),m.handleScaleFrame1(),m.handlePindouBlockHighlight(g.pindouHighlightOptions),g.linmoFitCanvasTimer&&clearTimeout(g.linmoFitCanvasTimer),g.linmoFitCanvasTimer=setTimeout((()=>{m.handleLinmoFitCanvas()}),250)}return}if(g.selectData.isMoving&&g.isSelecting?g.canvas.style.cursor="move":(g.canvas.style.cursor="",m.addCursorClass(e)),g.isDrawing){const e=n-n%(g.scale*g.brushSize),a=t-t%(g.scale*g.brushSize),l=g.mouseDrawData.startX,r=g.mouseDrawData.startY;m.drawSquareLine(l,r,e,a),g.mouseDrawData.startX=e,g.mouseDrawData.startY=a}else if(g.isErasering){const a=n-n%(g.scale*g.eraserSize),l=t-t%(g.scale*g.eraserSize),r=g.mouseDrawData.startX,i=g.mouseDrawData.startY;if(g.isEnableEraserTrack){let a=g.mouseDrawData.baseRect;const t=e.clientX-a.left,l=e.clientY-a.top;g.ctx0.beginPath(),g.ctx0.moveTo(g.mouseDrawData.lastX,g.mouseDrawData.lastY),g.ctx0.lineTo(e.clientX-a.left,e.clientY-a.top),g.ctx0.stroke(),g.mouseDrawData.lastX=t,g.mouseDrawData.lastY=l}m.eraseSquareLine(r,i,a,l),g.mouseDrawData.startX=a,g.mouseDrawData.startY=l}else if(g.isDrawShape){if("rect"===g.currentDrawShape){if(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender){g.drawShapeData.endX=n,g.drawShapeData.endY=t;const e=g.drawShapeData.endX-g.drawShapeData.startX,a=g.drawShapeData.endY-g.drawShapeData.startY;m.reDraw(!1),Ha(g.brushSize)?g.ctx1.strokeRect(g.drawShapeData.startX-.5,g.drawShapeData.startY-.5,e,a):g.ctx1.strokeRect(g.drawShapeData.startX,g.drawShapeData.startY,e,a)}}else if("fillRect"===g.currentDrawShape){if(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender){g.drawShapeData.endX=n,g.drawShapeData.endY=t;const e=g.drawShapeData.endX-g.drawShapeData.startX,a=g.drawShapeData.endY-g.drawShapeData.startY;m.reDraw(!1),g.ctx1.fillRect(g.drawShapeData.startX,g.drawShapeData.startY,e,a)}}else if("circle"===g.currentDrawShape){if(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender){g.drawShapeData.endX=n,g.drawShapeData.endY=t,m.reDraw(!1);let e=m.drawCircle(g.drawShapeData.startX,g.drawShapeData.startY,g.drawShapeData.endX,g.drawShapeData.endY,g.brushSize);for(let a=0;a<e.length;a++)e[a][0]>g.canvasWidth||e[a][1]>g.canvasHeight||e[a][0]<0||e[a][1]<0||g.ctx1.fillRect(e[a][0],e[a][1],g.scale,g.scale)}}else if("line"===g.currentDrawShape){if(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender){g.drawShapeData.endX=n,g.drawShapeData.endY=t,m.reDraw(!1);let e=m.drawLineV2(g.drawShapeData.startX,g.drawShapeData.startY,g.drawShapeData.endX,g.drawShapeData.endY,g.brushSize);for(let a=0;a<e.length;a++)e[a][0]>g.canvasWidth||e[a][1]>g.canvasHeight||e[a][0]<0||e[a][1]<0||g.ctx1.fillRect(e[a][0],e[a][1],g.scale,g.scale)}}else if("curve"===g.currentDrawShape&&g.curveType.isPress&&(m.addShapeList(n,t),g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender)){let e=g.drawShapeList[0][0],a=g.drawShapeList[0][1],l=n,r=t;if(e===l&&a===r)return;if(e===l||a===r){let t=0,n=0,i=0;if(e===l&&["3","4"].includes(g.curveType.pressKey)?(n=Math.round(Math.min(a,r)+Math.abs(r-a)/2),"3"===g.curveType.pressKey?t=Math.round(e-g.curvature)<=0?0:Math.round(e-g.curvature):"4"===g.curveType.pressKey&&(t=Math.round(e+g.curvature)>=g.canvasWidth?g.canvasWidth:Math.round(e+g.curvature)),i=Math.abs(r-a)):a===r&&["1","2"].includes(g.curveType.pressKey)&&(t=Math.round(Math.abs(l-e)/2+Math.min(e,l)),"1"===g.curveType.pressKey?n=Math.round(a-g.curvature)<=0?0:Math.round(a-g.curvature):"2"===g.curveType.pressKey&&(n=Math.round(a+g.curvature)>=g.canvasHeight?g.canvasHeight:Math.round(a+g.curvature)),i=Math.abs(l-e)),0===t&&0===n)return;let o=m.drawCurve({x:e,y:a},{x:t,y:n},{x:l,y:r},20+i);g.curveEndPos=[l,r],m.reDraw(!1);for(let e=0;e<o.length;e++){if(o[e][0]>g.canvasWidth||o[e][1]>g.canvasHeight)return;let a=o[e][0]*g.scale+g.canvasBeginPos.x,t=o[e][1]*g.scale+g.canvasBeginPos.y;g.ctx1.fillStyle=g.brushColor,g.ctx1.fillRect(a,t,g.scale,g.scale)}}}}else if(g.isMoving){let e=n-g.moveData.x,a=t-g.moveData.y;g.layerCrossList[g.moveData.moveLayerId].layerCtx.clearRect(0,0,g.canvasWidth,g.canvasHeight),g.layerCrossList[g.moveData.moveLayerId].layerCtx.putImageData(g.moveData.imageData,e,a),m.reDraw(!0,!1),g.moveData.newCenterX=g.moveData.centerX+e,g.moveData.newCenterY=g.moveData.centerY+a;let l=Math.abs(g.moveData.newCenterX-g.canvasBeginPos.centerX),r=Math.abs(g.moveData.newCenterY-g.canvasBeginPos.centerY);l<=2&&r>2?(g.isShowReferenceLine=!0,m.handleDrawReferenceLine("v")):r<=2&&l>2?(g.isShowReferenceLine=!0,m.handleDrawReferenceLine("h")):l<=2&&r<=2?(g.isShowReferenceLine=!0,m.handleDrawReferenceLine("vh")):(g.isShowReferenceLine=!1,m.handleDrawReferenceLine())}else if(g.isSelecting){if(g.selectData.isMoving){let e=n-g.selectData.x,a=t-g.selectData.y;if(0===e&&0===a)return;return g.selectData.isCopySelect,m.reDraw(!1),g.selectData.selectCanvasObj.ctx.clearRect(0,0,g.canvasWidth,g.canvasHeight),g.selectData.selectCanvasObj.selectCtx.clearRect(0,0,g.canvasWidth,g.canvasHeight),g.selectData.selectCanvasObj.ctx.putImageData(g.selectData.selectCanvasObj.imageData,e,a),g.selectData.selectCanvasObj.selectCtx.putImageData(g.selectData.selectCanvasObj.selectImageData,e,a),g.ctx1.drawImage(g.selectData.selectCanvasObj.canvas,0,0),void g.ctx1.drawImage(g.selectData.selectCanvasObj.selectCanvas,0,0)}if("rangeSelect"===g.selectType||"quickSelect"===g.selectType)return;let e=ia(m.getPixelColorByCoords(g.layerCrossList[g.currentLayerId].layerData,n,t));e!==g.emptyColor&&(g.selectData.selectCanvasObj.selectCtx.fillRect(n,t,1,1),g.layerCrossList[g.currentLayerId].layerCtx.clearRect(n,t,1,1),g.selectData.selectCanvasObj.ctx.fillStyle=e,g.selectData.selectCanvasObj.ctx.fillRect(n,t,1,1),g.ctx1.fillRect(n,t,1,1))}else if(g.isSelectDraging&&"rangeSelect"===g.selectType){const a=e.clientX-g.canvasRealLeft-g.lastX,l=e.clientY-g.canvasRealTop-g.lastY;m.handleDrawReferenceLine(),g.ctx0.strokeStyle="green",g.ctx0.setLineDash([]),g.ctx0.beginPath(),g.ctx0.globalCompositeOperation="destination-out",g.ctx0.fillRect(g.lastX,g.lastY,a,l),g.ctx0.globalCompositeOperation="source-over",g.ctx0.moveTo(g.lastX,g.lastY),g.ctx0.lineTo(g.lastX+a,g.lastY),g.ctx0.lineTo(g.lastX+a,g.lastY+l),g.ctx0.lineTo(g.lastX,g.lastY+l),g.ctx0.lineTo(g.lastX,g.lastY),g.ctx0.stroke(),g.ctx0.closePath(),g.selectData.endX=n,g.selectData.endY=t}else if(g.isSelectDraging&&11===g.currentTool){const a=e.clientX-g.canvasRealLeft-g.lastX,l=e.clientY-g.canvasRealTop-g.lastY;m.handleDrawReferenceLine(),g.ctx0.strokeStyle="green",g.ctx0.setLineDash([]),g.ctx0.beginPath(),g.ctx0.globalCompositeOperation="destination-out",g.ctx0.fillRect(g.lastX,g.lastY,a,l),g.ctx0.globalCompositeOperation="source-over",g.ctx0.moveTo(g.lastX,g.lastY),g.ctx0.lineTo(g.lastX+a,g.lastY),g.ctx0.lineTo(g.lastX+a,g.lastY+l),g.ctx0.lineTo(g.lastX,g.lastY+l),g.ctx0.lineTo(g.lastX,g.lastY),g.ctx0.stroke(),g.ctx0.closePath(),g.selectData.endX=n,g.selectData.endY=t}else if(g.pinDouMode&&g.isMovingPindouBrush&&[0,1].includes(g.currentTool)){let e=n+t*g.pindouBlockWidth,a=g.pindouBlockList[g.currentPindouIndex].colorArr;if("#"===a[e]&&0!==g.currentTool)return;let r="#"===a[e]?"#00000000":g.pindouBlockList[g.currentPindouIndex].colorStatList.get(a[e])[0],i={name:a[e],color:r,col:n,row:t};if(0===g.currentTool){let e=l.$refs.PindouDialog.replaceObj;if(!e)return l.$messgae.warning("请先选择需要替换的色号");let a={replaceObj:{color:"#"+e.color,name:e.name},originObj:i,type:1};m.handleReplacePindouColor(a,(()=>{}))}else if(1===g.currentTool){let e={replaceObj:{color:"#00000000",name:"#"},originObj:i,type:1};m.handleReplacePindouColor(e,(()=>{}))}}}else g.canvas.classList=""},handleMobileScaleMove(e){if(e.preventDefault(),2===e.touches.length&&g.isSpace){const a=e.touches[0].clientX-e.touches[1].clientX,t=e.touches[0].clientY-e.touches[1].clientY,l=Math.sqrt(a*a+t*t);if(null!==g.mobileStartDistance){let e;if(l/g.mobileStartDistance>1)if(g.pinDouMode){e=ka(g.canvas)+.02}else e=g.layerScale+g.layerScaleStep;else if(g.pinDouMode){e=ka(g.canvas)-.02}else e=g.layerScale-g.layerScaleStep;let a=Math.max(.1,e);a>g.maxScale&&(a=g.maxScale),g.layerScale=Number(a.toFixed(2)),m.handleSetCanvasScale()}}},handleMobileScaleEnd(){g.mobileStartDistance=null},mobileDraw(e){if(g.mobileStartDistance)return;e.preventDefault();let a={offsetX:Math.round(Math.round(e.touches[0].clientX-g.canvas.getBoundingClientRect().left)/g.layerScale),offsetY:Math.round(Math.round(e.touches[0].clientY-g.canvas.getBoundingClientRect().top)/g.layerScale)};e.offsetX=a.offsetX,e.offsetY=a.offsetY,e.clientX=e.touches[0].clientX,e.clientY=e.touches[0].clientY,m.draw(e)},handleCancelSelect(){8===g.currentTool&&($a(g.selectData.selectCanvasObj.canvas,g.selectData.selectCanvasObj.ctx)||(g.selectData.selectLayerId!==g.currentLayerId?g.layerCrossList[g.currentLayerId].layerCtx.drawImage(g.selectData.selectCanvasObj.canvas,0,0):g.layerCrossList[g.selectData.selectLayerId].layerCtx.drawImage(g.selectData.selectCanvasObj.canvas,0,0),g.selectData.selectCanvasObj.croppedLayerData=null,g.selectData.selectMapList={},g.selectData.isCopySelect=!1,g.selectData.selectCanvasObj.ctx.clearRect(0,0,g.canvasWidth,g.canvasHeight),g.selectData.selectCanvasObj.selectCtx.clearRect(0,0,g.canvasWidth,g.canvasHeight),m.reDraw()))},handleRemoveSelect(){if(8===g.currentTool){if($a(g.selectData.selectCanvasObj.canvas,g.selectData.selectCanvasObj.ctx))return l.$message.warning("选择区域为空");if(g.selectData.selectCanvasObj.croppedLayerData)for(let e=0;e<g.selectData.selectCanvasObj.croppedLayerData.length;e++)g.layerCrossList[g.currentLayerId].layerCtx.putImageData(g.selectData.selectCanvasObj.croppedLayerData[e].croppedImageData,g.selectData.selectCanvasObj.croppedLayerData[e].minX,g.selectData.selectCanvasObj.croppedLayerData[e].minY);g.selectData.selectMapList={},g.selectData.isCopySelect=!1,g.selectData.selectCanvasObj.croppedLayerData=null,g.selectData.selectCanvasObj.ctx.clearRect(0,0,g.canvasWidth,g.canvasHeight),g.selectData.selectCanvasObj.selectCtx.clearRect(0,0,g.canvasWidth,g.canvasHeight),m.reDraw(),l.$message.success("已删除选区")}},getRectIntersectV2(e){let a=g.drawRecord[g.currentFrameIndex].layer,t={};for(let l=a.length-1;l>=0;l--)if(a[l].isRender){let n=Object.keys(e);for(let r=0;r<n.length;r++){let i=e[n[r]];for(const[e,n]of i){let e=n,r=e[0]+e[1]*g.canvasWidth;if(!(r<0||r>a[l].layerData.length-1)&&(!(a[l].layerData[r][0]>=g.canvasWidth||a[l].layerData[r][1]>=g.canvasHeight||a[l].layerData[r][0]<0||a[l].layerData[r][1]<0)&&a[l].layerData[r]&&a[l].layerData[r][2]!==g.emptyColor)){t[a[l].layerData[r][2]]||(t[a[l].layerData[r][2]]=new Map);let e=a[l].layerData[r][0]+"/"+a[l].layerData[r][1];t[a[l].layerData[r][2]].set(e,[a[l].layerData[r][0],a[l].layerData[r][1]])}}}}return t},getRectIntersect(e){let a=g.drawRecord[g.currentFrameIndex].layer,t=[];for(let l=a.length-1;l>=0;l--)if(a[l].isRender)for(let n=0;n<e.length;n++){let r=e[n][0]+e[n][1]*g.canvasWidth;r<0||r>a[l].layerData.length-1||(a[l].layerData[r][0]>=g.canvasWidth||a[l].layerData[r][1]>=g.canvasHeight||a[l].layerData[r][0]<0||a[l].layerData[r][1]<0||a[l].layerData[r]&&a[l].layerData[r][2]!==g.emptyColor&&t.push(a[l].layerData[r]))}return t},startDrag(e,a){if(g.isDragging){const t=e-g.dragData.x,l=a-g.dragData.y;let n=g.drawAreaList[0][0]+t,r=g.drawAreaList[0][1]+l,i=n+g.scale*g.canvasWidth/2,o=r+g.scale*g.canvasHeight/2;m.drawPixelArea(),g.isScaling?m.handleScaleFrame({x:n,y:r,centerX:i,centerY:o}):g.pinDouMode?m.handleDrawPindou(g.ctx1,{x:n,y:r,centerX:i,centerY:o}):m.reDraw(!1,!1)}},handleScaleFrame1(){(g.isScaling||g.isControlMindObj)&&(g.isControlMindObj,g.resizeStyle.width=parseFloat(g.scaleStyle.width)*g.layerScale+"px",g.resizeStyle.height=parseFloat(g.scaleStyle.height)*g.layerScale+"px",m.handleResizeStyle())},handleScaleFrame(e=g.canvasBeginPos){},addDrawList(e,a,t){g.drawList.push([e,a,t])},addRemoveDrawList(e,a,t){g.removeDrawList.push([e,a,t])},addShapeList(e,a){g.drawShapeList.push([e,a])},drawCircle(e,a,t,l,n){let r,i,o,s,c=ot(e,a,t,l),d=[],h=Math.round((c.x0+c.x1)/2),u=Math.round((c.y0+c.y1)/2),g=(c.x0+c.x1)%2,p=(c.y0+c.y1)%2,m=c.x1-h,y=c.y1-u;if(1===n){for(r=c.x0;r<=h;r++)o=Math.acos((r-h)/m),i=Math.round(y*Math.sin(o)+u),d.push([r-g,i]),d.push([r-g,2*u-i-p]),d.push([2*h-r,i]),d.push([2*h-r,2*u-i-p]);for(i=c.y0;i<=u;i++)o=Math.asin((i-u)/y),r=Math.round(m*Math.cos(o)+h),d.push([r,i-p]),d.push([2*h-r-g,i-p]),d.push([r,2*u-i]),d.push([2*h-r-g,2*u-i]);return Wa(d)}let f=m-n,v=y-n;for(f<0&&(f=0),v<0&&(v=0),r=0;r<=m;r++)for(i=0;i<=y;i++)o=Math.atan(i/r),s=Math.sqrt(r*r+i*i),(m<=n||y<=n||s>f*v/Math.sqrt(v*v*Math.pow(Math.cos(o),2)+f*f*Math.pow(Math.sin(o),2))+.5)&&s<m*y/Math.sqrt(y*y*Math.pow(Math.cos(o),2)+m*m*Math.pow(Math.sin(o),2))+.5&&(d.push([h+r,u+i]),d.push([h-r-g,u+i]),d.push([h+r,u-i-p]),d.push([h-r-g,u-i-p]));return Wa(d)},drawCurve(e,a,t,l){const n=[];for(let i=0;i<=l;i++){let r=i/l,o=Math.round(Math.pow(1-r,2)*e.x+2*r*(1-r)*a.x+Math.pow(r,2)*t.x),s=Math.round(Math.pow(1-r,2)*e.y+2*r*(1-r)*a.y+Math.pow(r,2)*t.y);n.push([o,s])}let r=Wa(n);return r=r.filter((e=>e[0]>=0&&e[1]>=0)),r},drawLineV2(e,a,t,l,n){const r=Math.abs(t-e),i=e<t?n:-n,o=-Math.abs(l-a),s=a<l?n:-n;let c,d=r+o,h=!1,u=[];for(;!h;){for(let t=0;t<n;t++)for(let l=0;l<n;l++){const n=e+t,r=a+l;n>=0&&n<g.canvasWidth&&r>=0&&r<g.canvasHeight&&u.push([n,r])}e===t&&a===l||i>0&&e>t||i<0&&e<t||s>0&&a>l||s<0&&a<l?h=!0:(c=2*d,0===r?s>0&&a+s>l||s<0&&a+s<l?a=l:a+=s:0===o?i>0&&e+i>t||i<0&&e+i<t?e=t:e+=i:(c>o&&(d+=o,e+=i),c<r&&(d+=r,a+=s)))}return Wa(u)},drawLine(e,a,t,l){const n=Math.abs(t-e),r=e<t?1:-1,i=-Math.abs(l-a),o=a<l?1:-1;let s,c=n+i,d=!1,h=[];for(;!d;)e>=0&&e<=g.canvasWidth&&a>=0&&a<=g.canvasHeight&&h.push([e,a]),e===t&&a===l?d=!0:(s=2*c,s>i&&(c+=i,e+=r),s<n&&(c+=n,a+=o));return Wa(h)},drawRect(e,a,t,l){let n=Math.abs(e-t),r=Math.abs(a-l),i=[];if(r<=1)for(let o=0;o<r+1;o++)for(let l=0;l<n+1;l++){let n,r;e>t?(n=e-l,r=a-o,i.push([n,r])):(n=e+l,r=a+o,i.push([n,r]))}else{for(let r=0;r<=n;r++){let n,o,s,c;e>t?(n=e-r,o=a,i.push([n,o]),s=t+r,c=l,i.push([s,c])):(n=e+r,o=a,i.push([n,o]),s=t-r,c=l,i.push([s,c]))}for(let n=0;n<=r;n++){let r,o,s,c;a>l?(r=e,o=a-n,i.push([r,o]),s=t,c=l+n,i.push([s,c])):(r=e,o=a+n,i.push([r,o]),s=t,c=l-n,i.push([s,c]))}}return Wa(i)},drawFillRect(e,a,t,l){let n=Math.abs(e-t),r=Math.abs(a-l),i=[];if(r<=1)for(let o=0;o<r+1;o++)for(let l=0;l<n+1;l++){let n,r;e>t?(n=e-l,r=a-o,i.push([n,r,g.brushColor])):(n=e+l,r=a+o,i.push([n,r,g.brushColor]))}else{for(let l=0;l<r+1;l++)for(let r=0;r<n+1;r++){let n,o;e>t?(n=e-r,o=a-l,i.push([n,o,g.shapeFillColor])):(n=e+r,o=a+l,i.push([n,o,g.shapeFillColor]))}for(let r=0;r<=n;r++){let n,o,s,c;e>t?(n=e-r,o=a,i.push([n,o,g.brushColor]),s=t+r,c=l,i.push([s,c,g.brushColor])):(n=e+r,o=a,i.push([n,o,g.brushColor]),s=t-r,c=l,i.push([s,c,g.brushColor]))}for(let n=0;n<=r;n++){let r,o,s,c;a>l?(r=e,o=a-n,i.push([r,o,g.brushColor]),s=t,c=l+n,i.push([s,c,g.brushColor])):(r=e,o=a+n,i.push([r,o,g.brushColor]),s=t,c=l-n,i.push([s,c,g.brushColor]))}}return Wa(i)},handleLayerImg(e=(()=>{})){let a=m.getCurrentLayerId();g.layerCrossList[a].thumbImg=g.layerCrossList[a].layerCanvas.toDataURL(g.exportFormat,1),g.layerCrossList[a].layerData=g.layerCrossList[a].layerCtx.getImageData(0,0,g.canvasWidth,g.canvasHeight).data,g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].currentLayerImg=g.layerCrossList[a].thumbImg},handleLayerImgById(e){g.layerCrossList[e].thumbImg=g.layerCrossList[e].layerCanvas.toDataURL(g.exportFormat,1),g.layerCrossList[e].layerData=g.layerCrossList[e].layerCtx.getImageData(0,0,g.canvasWidth,g.canvasHeight).data;let a=m.getCurrentLayerIndexById(e);g.drawRecord[g.currentFrameIndex].layer[a].currentLayerImg=g.layerCrossList[e].thumbImg},handleGridImg(){g.realCanvas.width=40,g.realCanvas.height=40,g.ctx3.globalAlpha=.25,g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height);for(let e=0;e<g.realCanvas.height;e++)for(let a=0;a<g.realCanvas.width;a++)g.ctx3.fillStyle=(e+a)%2==0?"rgba(0, 0, 0, 0.5)":"rgba(100, 100, 100, 0.5)",g.ctx3.fillRect(6*a,6*e,6,6);g.layerGridImage=g.realCanvas.toDataURL("image/png"),g.ctx3.globalAlpha=1},handleFrameImg(e,a=!0){performance.now();let t=g.canvas.toDataURL(g.exportFormat,1);g.drawRecord[g.currentFrameIndex].currentFrameImg=t;performance.now();m.handleLayerImg(),g.FrameTimer&&clearTimeout(g.FrameTimer),g.FrameTimer=setTimeout((()=>{let e=g.ctx1.getImageData(0,0,g.canvasWidth,g.canvasHeight).data;g.worker.postMessage({type:105,currentFrameData:e,isPindouDrawMode:g.pinDouDrawMode,currentPindouBrandColorList:JSON.parse(JSON.stringify(h.pindouMaps[g.pindouBrand].data||h.pindouMaps[g.pindouBrand]))}),g.worker.onmessage=e=>{105===e.data.type&&(g.colorStatList=e.data.colorObj)}}),2e3),a&&m.handleAddHistory()},async handleExportPindouToExcel(e,a){r.handlePindouToExcel(g.pindouBlockList,o({currentPindouIndex:g.currentPindouIndex,canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight,pindouWidth:g.pindouBlockWidth,pindouHeight:g.pindouBlockHeight,pindouScale:g.pindouScaleValue,filename:`拼豆表格 - ${g.projectData.projectName}`},a)).then((a=>{e(),l.$message.success("导出成功")})).catch((a=>{e(),l.$message.error("导出失败")}))},handleExportCurrentBlockPindou:(e,{isShowGrid:a,isShowRulers:t,isShowCirclePoint:l,isShowRectPoint:n,rulersBackgroundColor:r,pointColor:i,rulersColor:o,gridColor:s,isShowTongji:c,isShowBrand:d,brandName:h,background:u,isShowProjectName:p,isShowTime:y,isShowTongjiCount:f,isShowWaterMark:v,waterMarkText:C,waterMarkSize:w,waterMarkColor:x,isShowReferenceLine:L,isShowTongjiBorder:D,isHighlight:S,currentSelectColor:b},I=!1,k=g.currentPindouIndex)=>new Promise(((e,R)=>{const M=document.createElement("canvas"),F=M.getContext("2d"),P=document.createElement("canvas");let B=g.pindouScaleValue,A=t?30:0,T=Va(g.pindouBlockWidth),O=B*g.pindouBlockWidth/T,j=Math.max(Math.floor(O-20),50),E=Math.max(40,j-20),H=Math.max(40,j-120);P.width=g.pindouBlockWidth*B+2*A,P.height=g.pindouBlockHeight*B+2*A,M.width=P.width+80,M.height=P.height+40+H+E;const W=P.getContext("2d"),$=g.pindouBlockList[k].canvas;if(W.fillStyle=u,W.fillRect(A,A,g.pindouBlockWidth*B,g.pindouBlockHeight*B),t){W.fillStyle=r,W.fillRect(0,0,P.width,B),W.fillRect(0,P.height-B,P.width,B),W.fillRect(0,B,B,P.height-2*B),W.fillRect(P.width-B,B,B,P.height-2*B),W.font="bold 14px Arial",W.textAlign="center",W.fillStyle=o;for(let e=0;e<g.pindouBlockHeight;e++){let a=A/2,t=B*e+B/2*3+5,l=P.width-A/2,n=t;W.fillText((e+1).toString(),a,t),W.fillText((g.pindouBlockHeight-e).toString(),l,n)}for(let e=0;e<g.pindouBlockWidth;e++){let a=B*e+B/2*3,t=A/2+5,l=a,n=P.height-A/2;W.fillText((e+1).toString(),a,t),W.fillText((g.pindouBlockWidth-e).toString(),l,n+4)}}for(let a=0;a<g.pindouBlockList[k].colorArr.length;a++){let e=a%g.pindouBlockWidth,t=Math.floor(a/g.pindouBlockWidth);if("#"===g.pindouBlockList[k].colorArr[a]){let a=e*g.pindouScaleValue,r=t*g.pindouScaleValue;W.fillStyle=i,l?(W.beginPath(),W.arc(a+A+B/2,r+A+B/2,3,0,2*Math.PI),W.fill()):n&&W.fillRect(a+A+B/2-3,r+A+B/2-3,6,6)}}let V=0;if(g.pindouBlockList[k].colorStatList.forEach(((e,a)=>{V+=e[1]})),g.pindouBlockList[k].colorStatList.size<=16&&g.pindouBlockWidth>32&&(T=8,O=B*g.pindouBlockWidth/T,j=Math.max(Math.floor(O-20),50),E=Math.max(40,j-20),H=Math.max(40,j-120),M.height=P.height+40+H+E),W.drawImage($,A,A),a){W.strokeStyle=s,W.beginPath(),W.moveTo(0,0),W.lineTo((g.pindouBlockWidth+2)*B,0),W.moveTo(0,g.pindouBlockHeight*B+2*A),W.lineTo((g.pindouBlockWidth+2)*B,g.pindouBlockHeight*B+2*A),W.moveTo(0,0),W.lineTo(0,(g.pindouBlockHeight+2)*B),W.moveTo((g.pindouBlockWidth+2)*B,0),W.lineTo((g.pindouBlockWidth+2)*B,(g.pindouBlockHeight+2)*B),W.stroke();for(let e=0;e<=g.pindouBlockHeight;e++)W.lineWidth=1,L&&e%5==0&&0!==e&&e!==g.pindouBlockHeight&&(W.lineWidth=4),W.beginPath(),W.moveTo(0,e*B+A),W.lineTo((g.pindouBlockWidth+2)*B,e*B+A),W.stroke();for(let e=0;e<=g.pindouBlockWidth;e++)W.lineWidth=1,L&&e%5==0&&0!==e&&e!==g.pindouBlockWidth&&(W.lineWidth=4),W.beginPath(),W.moveTo(e*B+A,0),W.lineTo(e*B+A,(g.pindouBlockHeight+2)*B),W.stroke()}F.drawImage(P,40,40+H);const z=document.createElement("canvas"),Y=z.getContext("2d");if(d){z.width=P.width,z.height=j+20,M.height=M.height+z.height,Y.fillStyle="white",Y.fillRect(0,0,z.width,z.height);let e=Math.floor(j/3)+2;Y.font=`bold ${e}px PixelFont`,Y.fillStyle="black",Y.textAlign="center",Y.fillText(h,z.width/2,z.height/2+20),f&&(Y.font=`bold ${e-2}px PixelFont`,Y.textAlign="end",Y.fillStyle="#808080",Y.fillText(`豆子总数：${V}`,z.width-35,z.height/2+20)),F.drawImage(P,40,40+H),F.drawImage(z,40,P.height+40+H)}else if(!d&&f){z.width=P.width,z.height=j+20,M.height=M.height+z.height,Y.fillStyle="white",Y.fillRect(0,0,z.width,z.height);let e=Math.floor(j/3)+2;Y.font=`bold ${e-2}px PixelFont`,Y.textAlign="end",Y.fillStyle="#808080",Y.fillText(`豆子总数：${V}`,z.width-35,z.height/2+20),F.drawImage(P,40,40+H),F.drawImage(z,40,P.height+40+H)}else z.width=P.width,z.height=60,M.height=M.height+z.height,Y.fillStyle="white",Y.fillRect(0,0,z.width,z.height),F.drawImage(P,40,40+H),F.drawImage(z,40,P.height+40+H);const X=document.createElement("canvas"),U=X.getContext("2d");if(c){let e=g.pindouBlockList[k].colorStatList;if(S){let a=e.get(`${b}`);e=new Map,e.set(b,a)}X.width=P.width;let a=T,t=Math.ceil(e.size/a);X.height=t*j*2,U.fillStyle="white",U.fillRect(0,0,X.width,X.height);let l=0,n=Array.from(e);for(let r=0;r<n.length;r++){r%a==0&&(l=0);let e=Math.ceil((r+1)/a);U.fillStyle=n[r][1][0];let t=O*l+A+O/2-(j-10)/2,i=2*j*(e-1)+10,o=t+j/2,s=i+j/2;m.drawRoundedRect(U,t,i,j,j,20,n[r][1][0],D);let c=Math.floor(j/4)+4;U.font=`bold ${c}px PixelFont`,U.fillStyle=ca(n[r][1][0]),U.textAlign="center",U.fillText(n[r][0],o,s+c/2-2),U.fillStyle="black",U.textAlign="center";let d=t+j/2,h=i+j/2+5+j;U.fillText(n[r][1][1],d,h-8),l++}M.height=M.height+X.height,F.drawImage(P,40,40+H),F.drawImage(z,40,P.height+40+H),X.height>0&&F.drawImage(X,40,P.height+z.height+40+H)}F.fillStyle="white",F.fillRect(0,M.height-E,M.width,E),F.fillRect(0,0,M.width,40+H),F.fillRect(0,40+H,40,M.height-80),F.fillRect(M.width-40,40+H,40,M.height-80);let N=Math.floor(j/4)+2;F.font=`normal ${N}px PixelFont`,F.textAlign="center";const _=F.createLinearGradient(0,0,M.width,0);if(_.addColorStop(0,"#FFD700"),_.addColorStop(.25,"#FFEC8B"),_.addColorStop(.5,"#FFA500"),_.addColorStop(.75,"#FFEC8B"),_.addColorStop(1,"#FFD700"),F.fillStyle=_,F.fillText("图纸来源 像素格子",M.width/2,M.height-E/2),g.pindouBlockWidth<30&&(N=j/3+2),p&&(F.font=`bold ${N}px PixelFont`,F.textAlign="start",F.fillStyle="#000000",F.fillText(`${g.projectData.projectName}`,45,(H+40)/2+N/2)),y&&(F.font=`bold ${N-2}px PixelFont`,F.textAlign="end",F.fillStyle="#808080",F.fillText(`${Da()}`,M.width-45,(H+40)/2+N/2)),!y&&!p){const e=document.createElement("canvas"),a=e.getContext("2d");e.width=M.width,e.height=M.height-H,a.drawImage(M,0,H,M.width,e.height,0,0,e.width,e.height),M.height=M.height-H,F.clearRect(0,0,M.width,M.height),F.drawImage(e,0,0,M.width,M.height)}if(v){F.font=`normal ${w}px PixelFont`,F.fillStyle=x;const e=Math.PI/180*-30,a=Math.sqrt(M.width*M.width+M.height*M.height);F.translate(M.width/2,M.height/2),F.rotate(e);const t=400,l=400,n=Math.ceil(a/l),r=Math.ceil(a/t);for(let i=-n;i<n;i++)for(let e=-r;e<r;e++){const n=e*t,r=i*l;n>=-a/2&&n<=a/2&&r>=-a/2&&r<=a/2&&F.fillText(C,n,r)}}I?e(M.toDataURL(g.exportFormat,1)):(za(M,"拼豆图 - "+g.projectData.projectName+" - 分块"+k),e(!0))})),handleExportFullPindou(e){let{isShowGrid:a,isShowRulers:t,isShowCirclePoint:l,isShowRectPoint:n,rulersBackgroundColor:r,pointColor:i,rulersColor:o,gridColor:s,isShowTongji:c,isShowBrand:d,brandName:h,background:u,isShowProjectName:p,isShowTime:y,isShowTongjiCount:f,isShowWaterMark:v,waterMarkText:C,waterMarkSize:w,waterMarkColor:x,isShowReferenceLine:L,isShowTongjiBorder:D,isHighlight:S,currentSelectColor:b}=e;return new Promise(((e,I)=>{!async function(){const I=document.createElement("canvas"),k=I.getContext("2d"),R=document.createElement("canvas");let M=30,F=t?30:0,P=Va(g.canvasWidth),B=M*g.canvasWidth/P,A=Math.max(Math.floor(B-20),50),T=Math.max(40,A-20),O=Math.max(40,A-120);R.width=g.canvasWidth*M+2*F,R.height=g.canvasHeight*M+2*F,I.width=R.width+80,I.height=R.height+40+O+T;const j=R.getContext("2d");if(j.fillStyle=u,j.fillRect(F,F,g.canvasWidth*M,g.canvasHeight*M),t){j.fillStyle=r,j.fillRect(0,0,R.width,M),j.fillRect(0,R.height-M,R.width,M),j.fillRect(0,M,M,R.height-60),j.fillRect(R.width-M,M,M,R.height-60),j.font="bold 14px Arial",j.textAlign="center",j.fillStyle=o;for(let e=0;e<g.canvasHeight;e++){let a=F/2,t=M*e+45+5,l=R.width-F/2,n=t;j.fillText((e+1).toString(),a,t),j.fillText((g.canvasHeight-e).toString(),l,n)}for(let e=0;e<g.canvasWidth;e++){let a=M*e+45,t=F/2+5,l=a,n=R.height-F/2;j.fillText((e+1).toString(),a,t),j.fillText((g.canvasWidth-e).toString(),l,n+4)}}let E=new Map,H=0;for(let e=0;e<g.pindouBlockList.length;e++){g.pindouBlockList[e].canvas||await m.handleDrawPindouByIndex(e);const a=e%Math.ceil(g.canvasWidth/g.pindouBlockWidth),t=Math.floor(e/Math.ceil(g.canvasWidth/g.pindouBlockWidth));for(let o=0;o<g.pindouBlockList[e].colorArr.length;o++){let r=o%g.pindouBlockWidth,s=Math.floor(o/g.pindouBlockWidth);if("#"===g.pindouBlockList[e].colorArr[o]){let e=r*M+g.pindouBlockWidth*a*M,o=s*M+g.pindouBlockHeight*t*M;if(e+F>=R.width-F||o+F>=R.height-F)continue;j.fillStyle=i,l?(j.beginPath(),j.arc(e+F+15,o+F+15,3,0,2*Math.PI),j.fill()):n&&j.fillRect(e+F+15-3,o+F+15-3,6,6)}}j.drawImage(g.pindouBlockList[e].canvas,F+g.pindouBlockWidth*a*M,F+g.pindouBlockHeight*t*M);for(const[l,n]of g.pindouBlockList[e].colorStatList)if(E.has(l)){let e=n[1];H+=e;let a=E.get(l)[1],t=Number(e+a);E.set(l,[n[0],t])}else E.set(l,n),H+=n[1];const r=Array.from(E.entries());r.sort(((e,a)=>a[1][1]-e[1][1])),E=new Map(r)}if(E.size<=16&&g.canvasWidth>32&&(P=8,B=M*g.canvasWidth/P,A=Math.max(Math.floor(B-20),50),T=Math.max(40,A-20),O=Math.max(40,A-120),I.height=R.height+40+O+T),a){j.strokeStyle=s,j.beginPath(),j.moveTo(0,0),j.lineTo((g.canvasWidth+2)*M,0),j.moveTo(0,g.canvasHeight*M+2*F),j.lineTo((g.canvasWidth+2)*M,g.canvasHeight*M+2*F),j.moveTo(0,0),j.lineTo(0,(g.canvasHeight+2)*M),j.moveTo((g.canvasWidth+2)*M,0),j.lineTo((g.canvasWidth+2)*M,(g.canvasHeight+2)*M),j.stroke();for(let e=0;e<=g.canvasHeight;e++)j.lineWidth=1,L&&e%5==0&&0!==e&&e!==g.canvasHeight&&(j.lineWidth=4),j.beginPath(),j.moveTo(0,e*M+F),j.lineTo((g.canvasWidth+2)*M,e*M+F),j.stroke();for(let e=0;e<=g.canvasWidth;e++)j.lineWidth=1,L&&e%5==0&&0!==e&&e!==g.canvasWidth&&(j.lineWidth=4),j.beginPath(),j.moveTo(e*M+F,0),j.lineTo(e*M+F,(g.canvasHeight+2)*M),j.stroke()}k.drawImage(R,40,40+O);const W=document.createElement("canvas"),$=W.getContext("2d");if(d){W.width=R.width,W.height=A+20,I.height=I.height+W.height,$.fillStyle="white",$.fillRect(0,0,W.width,W.height);let e=Math.floor(A/3)+2;$.font=`bold ${e}px PixelFont`,$.fillStyle="black",$.textAlign="center",$.fillText(h,W.width/2,W.height/2+20),f&&($.font=`bold ${e-2}px PixelFont`,$.textAlign="end",$.fillStyle="#808080",$.fillText(`豆子总数：${H}`,W.width-35,W.height/2+20)),k.drawImage(R,40,40+O),k.drawImage(W,40,R.height+40+O)}else if(!d&&f){W.width=R.width,W.height=A+20,I.height=I.height+W.height,$.fillStyle="white",$.fillRect(0,0,W.width,W.height);let e=Math.floor(A/3)+2;$.font=`bold ${e-2}px PixelFont`,$.textAlign="end",$.fillStyle="#808080",$.fillText(`豆子总数：${H}`,W.width-35,W.height/2+20),k.drawImage(R,40,40+O),k.drawImage(W,40,R.height+40+O)}else W.width=R.width,W.height=60,I.height=I.height+W.height,$.fillStyle="white",$.fillRect(0,0,W.width,W.height),k.drawImage(R,40,40+O),k.drawImage(W,40,R.height+40+O);const V=document.createElement("canvas"),z=V.getContext("2d");if(c){let e=E;if(S){let a=e.get(`${b}`);e=new Map,e.set(b,a)}V.width=R.width;let a=P,t=Math.ceil(e.size/a);V.height=t*A*2,z.fillStyle="white",z.fillRect(0,0,V.width,V.height);let l=0,n=Array.from(e);for(let r=0;r<n.length;r++){r%a==0&&(l=0);let e=Math.ceil((r+1)/a);z.fillStyle=n[r][1][0];let t=B*l+F+B/2-(A-10)/2,i=2*A*(e-1)+10,o=t+A/2,s=i+A/2;m.drawRoundedRect(z,t,i,A,A,20,n[r][1][0],D);let c=Math.floor(A/4)+4;z.font=`bold ${c}px PixelFont`,z.fillStyle=ca(n[r][1][0]),z.textAlign="center",z.fillText(n[r][0],o,s+c/2-2),z.fillStyle="black",z.textAlign="center";let d=t+A/2,h=i+A/2+5+A;z.fillText(n[r][1][1],d,h-8),l++}I.height=I.height+V.height,k.drawImage(R,40,40+O),k.drawImage(W,40,R.height+40+O),k.drawImage(V,40,R.height+W.height+40+O)}k.fillStyle="white",k.fillRect(0,I.height-T,I.width,T),k.fillRect(0,0,I.width,40+O),k.fillRect(0,40+O,40,I.height-80),k.fillRect(I.width-40,40+O,40,I.height-80);let Y=Math.floor(A/4)+2;k.font=`normal ${Y}px PixelFont`,k.textAlign="center";const X=k.createLinearGradient(0,0,I.width,0);if(X.addColorStop(0,"#FFD700"),X.addColorStop(.25,"#FFEC8B"),X.addColorStop(.5,"#FFA500"),X.addColorStop(.75,"#FFEC8B"),X.addColorStop(1,"#FFD700"),k.fillStyle=X,k.fillText("图纸来源 像素格子",I.width/2,I.height-T/2),g.pindouBlockWidth<30&&(Y=A/3+2),p&&(k.font=`bold ${Y}px PixelFont`,k.textAlign="start",k.fillStyle="#000000",k.fillText(`${g.projectData.projectName}`,45,(O+40)/2+Y/2)),y&&(k.font=`bold ${Y-2}px PixelFont`,k.textAlign="end",k.fillStyle="#808080",k.fillText(`${Da()}`,I.width-45,(O+40)/2+Y/2)),!y&&!p){const e=document.createElement("canvas"),a=e.getContext("2d");e.width=I.width,e.height=I.height-O,a.drawImage(I,0,O,I.width,e.height,0,0,e.width,e.height),I.height=I.height-O,k.clearRect(0,0,I.width,I.height),k.drawImage(e,0,0,I.width,I.height)}if(v){k.font=`normal ${w}px PixelFont`,k.fillStyle=x;const e=Math.PI/180*-30,a=Math.sqrt(I.width*I.width+I.height*I.height);k.translate(I.width/2,I.height/2),k.rotate(e);const t=400,l=400,n=Math.ceil(a/l),r=Math.ceil(a/t);for(let i=-n;i<n;i++)for(let e=-r;e<r;e++){const n=e*t,r=i*l;n>=-a/2&&n<=a/2&&r>=-a/2&&r<=a/2&&k.fillText(C,n,r)}}za(I,"拼豆图 - "+g.projectData.projectName),e(!0)}()}))},async handleExportPindou(e,a){if(0===a.type)return await m.handleExportCurrentBlockPindou(e,a),void e();if(1===a.type){const l=[];for(let n=0;n<g.pindouBlockList.length;n++)try{g.pindouBlockList[n].canvas||await m.handleDrawPindouByIndex(n);let t=await m.handleExportCurrentBlockPindou(e,a,!0,n);l.push(t)}catch(t){e()}return 1===l.length?Ya(l[0],`拼豆图 - ${g.projectData.projectName}`):Xa(`拼豆图 - ${g.projectData.projectName}`,l),void e()}await m.handleExportFullPindou(a),e()},drawRoundedRect(e,a,t,l,n,r,i,o=!1){e.beginPath(),e.moveTo(a+r,t),e.lineTo(a+l-r,t),e.quadraticCurveTo(a+l,t,a+l,t+r),e.lineTo(a+l,t+n-r),e.quadraticCurveTo(a+l,t+n,a+l-r,t+n),e.lineTo(a+r,t+n),e.quadraticCurveTo(a,t+n,a,t+n-r),e.lineTo(a,t+r),e.quadraticCurveTo(a,t,a+r,t),e.closePath(),e.fill(),o&&(e.lineWidth=2,e.strokeStyle="#101010",e.stroke())},addDrawRecord(e,a=!0){if(e[0]+e[1]*g.canvasWidth>=g.canvasWidth*g.canvasHeight)return;let t=e[0]+"/"+e[1],l=e[2],n=Aa(l),r=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData,i=r[t],o=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData;if("0000"!==n.join("")){let a=n,l=a[0],s=a[1],c=a[2],d=g.layerAlpha/100,h=ia([l,s,c,d]);r[t]=h,o[i]&&o[i].has(t)&&o[i].delete(t),o[h]?o[h].has(t)||o[h].set(t,[e[0],e[1]]):(o[h]=new Map,o[h].set(t,[e[0],e[1]]))}a&&(g.FrameTimer&&clearTimeout(g.FrameTimer),g.FrameTimer=setTimeout((()=>{m.handleLayerImg(),m.handleFrameImg(g.ctx1)}),200))},removeDrawRecord(e,a=!0){let t=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData,l=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData;e[0],e[1],g.canvasWidth;let n=e[0]+"/"+e[1],r=l[n];r&&(delete l[n],t[r]&&t[r].has(n)&&t[r].delete(n),a&&m.reDraw())},handlePindouHighlight(e){if(!e.isHighlight)return g.pindouHighlight=null,void m.handleDrawPindou(g.ctx1);g.pindouHighlight=e,m.handleDrawPindou(g.ctx1,e)},handlePindouBlockHighlight(e){if(!g.pinDouMode)return;if(m.handleDrawGridLine(),!e)return;let{startCol:a,endCol:t,startRow:l,endRow:n}=e,r=a*g.pindouScaleValue,i=t*g.pindouScaleValue,o=l*g.pindouScaleValue,s=i-r,c=n*g.pindouScaleValue-o;g.pindouHighlightOptions={startCol:a,endCol:t,startRow:l,endRow:n},g.ctx4.save(),g.ctx4.beginPath(),g.ctx4.rect(0,0,g.canvas.width,g.canvas.height),g.ctx4.rect(r,o,s,c),g.ctx4.clip("evenodd"),g.ctx4.fillStyle="rgba(0, 0, 0, 0.7)",g.ctx4.fillRect(0,0,g.canvas.width,g.canvas.height),g.ctx4.restore()},handleChangePindouBlock(e){g.currentPindouIndex=e,m.handleDrawPindou(g.ctx1),l.$refs.PindouDialog.handleUpdateCurrentPindouBlockColorList(g.pindouBlockList[g.currentPindouIndex].colorStatList)},async handleDrawPindouByIndex(e){let a=g.pindouBlockList[e];if(!g.pindouBlockList[e].canvas){let t=await m.handleNearestNeighborResize(g.pindouBlockWidth,g.pindouBlockHeight,g.pindouScaleValue,a.blockArr,!1,"",!0);const l=document.createElement("canvas");l.width=g.canvas.width,l.height=g.canvas.height;const n=l.getContext("2d");g.isShowPindouShadow?(n.shadowColor="rgba(0, 0, 0, 0.4)",n.shadowBlur=10,n.shadowOffsetX=5,n.shadowOffsetY=5):(n.shadowColor="rgba(0, 0, 0, 0)",n.shadowBlur=0,n.shadowOffsetX=0,n.shadowOffsetY=0),null==n||n.drawImage(t,0,0);let r=0;n.shadowColor="rgba(0, 0, 0, 0)",n.shadowBlur=0,n.shadowOffsetX=0,n.shadowOffsetY=0;for(let e=0;e<a.colorArr.length;e++){e%g.pindouBlockWidth==0&&(r=0);let t=Math.ceil((e+1)/g.pindouBlockWidth),l=4*e,i=a.colorArr[e];if("#"===i){r++;continue}let o=ia([a.blockArr[l],a.blockArr[l+1],a.blockArr[l+2],a.blockArr[l+3]]),s=~~(g.pindouScaleValue/2);n.font=`400 ${s}px Arial`;let c=~~n.measureText(i).width;s=Ta(c,s),n.font=`400 ${s}px Arial`,c=~~n.measureText(i).width,n.fillStyle=ca(o);let d=r*g.pindouScaleValue,h=(t-1)*g.pindouScaleValue;const u=d+(g.pindouScaleValue-c)/2,p=h+(g.pindouScaleValue-s)/2+s;n.fillText(i,~~u,~~p),r++}g.pindouBlockList[e].canvas=l,g.pindouBlockList[e].ctx=n}},handleDrawPindouShadow(e=g.isShowPindouShadow){g.isShowPindouShadow=e,m.handleDrawPindou(g.ctx1,g.pindouHighlight,null)},async handleDrawPindou(e=g.ctx1,a=g.pindouHighlight,t=null){if(a&&1===a.type&&(!a.selectedObj.col||!a.selectedObj.row))return l.$message.warning("缺少位置坐标无法高亮当前像素颜色，请在画布中选择颜色具体位置");e.clearRect(0,0,g.canvas.width,g.canvas.height);let n,r=g.pindouBlockList[g.currentPindouIndex];n=t||await m.handleNearestNeighborResize(g.pindouBlockWidth,g.pindouBlockHeight,g.pindouScaleValue,r.blockArr,!1,"",!0);const i=document.createElement("canvas");i.width=g.canvas.width,i.height=g.canvas.height;const o=i.getContext("2d");g.isShowPindouShadow?(o.shadowColor="rgba(0, 0, 0, 0.4)",o.shadowBlur=10,o.shadowOffsetX=5,o.shadowOffsetY=5):(o.shadowColor="rgba(0, 0, 0, 0)",o.shadowBlur=0,o.shadowOffsetX=0,o.shadowOffsetY=0),null==o||o.drawImage(n,0,0);let s=0;o.shadowColor="rgba(0, 0, 0, 0)",o.shadowBlur=0,o.shadowOffsetX=0,o.shadowOffsetY=0;for(let l=0;l<r.colorArr.length;l++){l%g.pindouBlockWidth==0&&(s=0);let e=Math.ceil((l+1)/g.pindouBlockWidth),t=4*l,n=r.colorArr[l];if("#"===n){s++;continue}let i=ia([r.blockArr[t],r.blockArr[t+1],r.blockArr[t+2],r.blockArr[t+3]]);if(a){if(a&&1===a.type){if(a.selectedObj.col+a.selectedObj.row*g.pindouBlockWidth===l){let a=~~(g.pindouScaleValue/2);o.font=`400 ${a}px Arial`;let t=~~o.measureText(n).width;a=Ta(t,a),o.font=`400 ${a}px Arial`,t=~~o.measureText(n).width,o.fillStyle=ca(i);let l=s*g.pindouScaleValue,r=(e-1)*g.pindouScaleValue;const c=l+(g.pindouScaleValue-t)/2,d=r+(g.pindouScaleValue-a)/2+a;o.fillText(n,~~c,~~d),o.beginPath(),o.moveTo(~~l,~~r),o.lineTo(~~l+g.pindouScaleValue,~~r),o.lineTo(~~l+g.pindouScaleValue,~~r+g.pindouScaleValue),o.lineTo(~~l,~~r+g.pindouScaleValue),o.lineTo(~~l,~~r),o.closePath(),o.setLineDash([5,3]),o.strokeStyle=ca(i),o.lineWidth=2,o.stroke();break}s++}else if(a&&2===a.type)if(a.selectedObj.name===n){let a=~~(g.pindouScaleValue/2);o.font=`400 ${a}px Arial`;let t=~~o.measureText(n).width;a=Ta(t,a),o.font=`400 ${a}px Arial`,t=~~o.measureText(n).width,o.fillStyle=ca(i);let l=s*g.pindouScaleValue,r=(e-1)*g.pindouScaleValue;const c=l+(g.pindouScaleValue-t)/2,d=r+(g.pindouScaleValue-a)/2+a;o.fillText(n,~~c,~~d),s++,o.beginPath(),o.moveTo(~~l,~~r),o.lineTo(~~l+g.pindouScaleValue,~~r),o.lineTo(~~l+g.pindouScaleValue,~~r+g.pindouScaleValue),o.lineTo(~~l,~~r+g.pindouScaleValue),o.lineTo(~~l,~~r),o.closePath(),o.setLineDash([5,3]),o.strokeStyle=ca(i),o.lineWidth=2,o.stroke()}else{let a=~~(g.pindouScaleValue/2);o.font=`400 ${a}px Arial`;let t=~~o.measureText(n).width;a=Ta(t,a),o.font=`400 ${a}px Arial`,t=~~o.measureText(n).width,o.fillStyle=ca(i);let l=s*g.pindouScaleValue,r=(e-1)*g.pindouScaleValue;const c=l+(g.pindouScaleValue-t)/2,d=r+(g.pindouScaleValue-a)/2+a;o.fillText(n,~~c,~~d),o.fillStyle="rgba(197, 197, 197, 0.8)",o.fillRect(~~l,~~r,g.pindouScaleValue,g.pindouScaleValue),s++}}else{let a=~~(g.pindouScaleValue/2);o.font=`400 ${a}px Arial`;let t=~~o.measureText(n).width;a=Ta(t,a),o.font=`400 ${a}px Arial`,t=~~o.measureText(n).width,o.fillStyle=ca(i);let l=s*g.pindouScaleValue,r=(e-1)*g.pindouScaleValue;const c=l+(g.pindouScaleValue-t)/2,d=r+(g.pindouScaleValue-a)/2+a;o.fillText(n,~~c,~~d),s++}}g.pindouBlockList[g.currentPindouIndex].canvas=i,g.pindouBlockList[g.currentPindouIndex].ctx=o,e.drawImage(i,0,0),g.loading=!1},reDrawPartV2(e){let a=Object.keys(e);for(let t=0;t<a.length;t++){g.ctx1.fillStyle=a[t];let l=e[a[t]];for(const[e,a]of l){let e=a,t=e[0]*g.scale,l=e[1]*g.scale;g.ctx1.fillRect(t,l,g.scale,g.scale)}}m.reDrawSelectData()},reDrawPart(e){for(let a=0;a<e.length;a++){if(e[a][0]>=g.canvasWidth||e[a][1]>=g.canvasHeight||e[a][0]<0||e[a][1]<0)continue;let t=e[a][0]*g.scale,l=e[a][1]*g.scale;g.ctx1.fillStyle=e[a][2],g.ctx1.fillRect(t,l,g.scale,g.scale)}m.reDrawSelectData()},reDrawV2(e,a=!0,t=!0,l=g.currentLayerIndex,n=!1){let r=g.drawRecord[g.currentFrameIndex].layer;if(n||g.ctx1.translate(0,0),a&&g.ctx1.clearRect(0,0,g.canvas.width,g.canvas.height),"top"===e){for(let i=0;i<l;i++)if(r[i].isRender)for(let e=0;e<r[i].layerData.length;e++)if(!(r[i].layerData[e][0]>=g.canvasWidth||r[i].layerData[e][1]>=g.canvasHeight||r[i].layerData[e][0]<0||r[i].layerData[e][1]<0)&&r[i].layerData[e][2]!==g.emptyColor){let a=r[i].layerData[e][0]*g.scale,t=r[i].layerData[e][1]*g.scale;g.ctx1.fillStyle=r[i].layerData[e][2],g.ctx1.fillRect(a,t,g.scale,g.scale)}}else if("middle"===e){if(r[l].isRender&&t)for(let i=0;i<r[l].layerData.length;i++)if(!(r[l].layerData[i][0]>=g.canvasWidth||r[l].layerData[i][1]>=g.canvasHeight||r[l].layerData[i][0]<0||r[l].layerData[i][1]<0)&&r[l].layerData[i][2]!==g.emptyColor){let e=r[l].layerData[i][0]*g.scale,a=r[l].layerData[i][1]*g.scale;g.ctx1.fillStyle=r[l].layerData[i][2],g.ctx1.fillRect(e,a,g.scale,g.scale)}}else if("bottom"===e)for(let i=r.length-1;i>l;i--)if(r[i].isRender)for(let e=0;e<r[i].layerData.length;e++)if(!(r[i].layerData[e][0]>=g.canvasWidth||r[i].layerData[e][1]>=g.canvasHeight||r[i].layerData[e][0]<0||r[i].layerData[e][1]<0)&&r[i].layerData[e][2]!==g.emptyColor){let a=r[i].layerData[e][0]*g.scale,t=r[i].layerData[e][1]*g.scale;g.ctx1.fillStyle=r[i].layerData[e][2],g.ctx1.fillRect(a,t,g.scale,g.scale)}},async reDrawV3(e,a=g.currentLayerIndex){let t=g.drawRecord[g.currentFrameIndex].layer;if("bottom"===e){for(let l=t.length-1;l>a;l--)if(t[l].isRender){let e=t[l].layerId;g.ctx1.drawImage(g.layerCrossList[e].layerCanvas,0,0);for(let a=0;a<t[l].mindLayerList.length;a++){let n=g.layerCrossList[e].mindLayerList[t[l].mindLayerList[a]];n.isHide||g.ctx1.drawImage(n.mindCanvas,n.left,n.top)}}}else if("middle"===e){if(t[a].isRender){let e=t[a].layerId;g.ctx1.drawImage(g.layerCrossList[e].layerCanvas,0,0);for(let a=0;a<t[e].mindLayerList.length;a++){let l=g.layerCrossList[e].mindLayerList[t[e].mindLayerList[a]];l.isHide||g.ctx1.drawImage(l.mindCanvas,l.left,l.top)}}}else if("top"===e)for(let l=a-1;l>=0;l--)if(t[l].isRender){let e=t[l].layerId;g.ctx1.drawImage(g.layerCrossList[e].layerCanvas,0,0);for(let a=0;a<t[l].mindLayerList.length;a++){let n=g.layerCrossList[e].mindLayerList[t[l].mindLayerList[a]];n.isHide||g.ctx1.drawImage(n.mindCanvas,n.left,n.top)}}},async reDraw(e=!0,a=!0,t=!0,l=!0){g.ctx1.clearRect(0,0,g.canvas.width,g.canvas.height),g.drawRecord.length-1<g.currentFrameIndex&&(g.currentFrameIndex=g.drawRecord.length-1);let n=g.drawRecord[g.currentFrameIndex].layer,r=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerId;const i=performance.now();for(let o=n.length-1;o>=0;o--)if((t||n[o].layerId!==r)&&n[o].isRender){let e=n[o].layerId;g.ctx1.drawImage(g.layerCrossList[e].layerCanvas,0,0);for(let a=0;a<n[o].mindLayerList.length;a++){let t=g.layerCrossList[e].mindLayerList[n[o].mindLayerList[a]];(l||n[o].layerId!==r||t.mindId!==g.currentSelectMindId)&&(t.isHide||g.ctx1.drawImage(t.mindCanvas,t.left,t.top))}}performance.now();e&&(g.FrameTimer&&clearTimeout(g.FrameTimer),g.FrameTimer=setTimeout((()=>{m.handleFrameImg(g.ctx2,a)}),200))},stop(e){if(!e)return;let a=g.canvas.getBoundingClientRect(),t=Math.floor((((null==e?void 0:e.touches)&&(null==e?void 0:e.touches.length)?e.touches[0].clientY:e.clientY)-a.top)/g.layerScale),l=Math.floor((((null==e?void 0:e.touches)&&(null==e?void 0:e.touches.length)?e.touches[0].clientX:e.clientX)-a.left)/g.layerScale);if(g.isDrawing&&(g.isDrawing=!1,m.handleFrameImg(g.ctx1),g.drawList=[]),g.isErasering&&(g.isErasering=!1,g.isEnableEraserTrack&&m.handleDrawReferenceLine(),g.removeDrawList.length&&m.handleFrameImg(g.ctx1),g.removeDrawList=[]),g.isScale=!1,g.isDragging&&(g.isDragging=!1),g.isMoving&&(g.isMoving=!1,m.handleAddHistory(),g.isShowReferenceLine=!1),g.isMovingPindouBrush&&(g.isMovingPindouBrush=!1),g.isSelecting){if(!g.selectData.isMoving)return void(g.isSelecting=!1);g.isSelecting=!1,g.selectData.isMoving=!1,g.selectData.x===l&&g.selectData.y===t||(g.selectData.isCopySelect=!1,g.selectData.selectCanvasObj.croppedLayerData=null)}if(g.isSelectDraging&&11!==g.currentTool){g.isSelectDraging=!1;let e=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex];if(e.isRender){let a=Math.min(g.selectData.x,g.selectData.endX),t=Math.max(g.selectData.x,g.selectData.endX),l=Math.min(g.selectData.y,g.selectData.endY);const n=t-a,r=Math.max(g.selectData.y,g.selectData.endY)-l;if(n<=0||r<=0)return;const i=g.layerCrossList[e.layerId].layerCtx.getImageData(a,l,n,r),o=i.data;g.selectData.selectCanvasObj.ctx.putImageData(i,a,l);let s=g.selectData.selectCanvasObj.selectCtx.getImageData(a,l,n,r),c=s.data,d=ra(g.selectActiveColor);for(let e=0;e<o.length;e+=4)0!==o[e+3]&&(c[e]=d[0],c[e+1]=d[1],c[e+2]=d[2],c[e+3]=255*d[3],o[e]=0,o[e+1]=0,o[e+2]=0,o[e+3]=0);g.selectData.selectCanvasObj.croppedLayerData&&g.selectData.selectCanvasObj.croppedLayerData.length?g.selectData.selectCanvasObj.croppedLayerData.push({croppedImageData:i,minX:a,minY:l}):g.selectData.selectCanvasObj.croppedLayerData=[{croppedImageData:i,minX:a,minY:l}],g.selectData.selectCanvasObj.selectCtx.putImageData(s,a,l),m.reDraw(!1),g.ctx1.drawImage(g.selectData.selectCanvasObj.canvas,0,0),g.ctx1.drawImage(g.selectData.selectCanvasObj.selectCanvas,0,0)}m.handleDrawReferenceLine()}else if(g.isSelectDraging&&11===g.currentTool){g.isSelectDraging=!1;let e=Math.min(g.selectData.x,g.selectData.endX),a=Math.max(g.selectData.x,g.selectData.endX),t=Math.min(g.selectData.y,g.selectData.endY),l=Math.max(g.selectData.y,g.selectData.endY);const n=Math.floor(a-e)+1,r=Math.floor(l-t)+1;if(n<=0||r<=0)return;g.loading=!0;for(let i=0;i<g.drawRecord.length;i++)for(let a=0;a<g.drawRecord[i].layer.length;a++){let l=g.drawRecord[i].layer[a];const o=g.layerCrossList[l.layerId].layerCtx.getImageData(e,t,n,r);g.layerCrossList[l.layerId].layerCanvas.width=n,g.layerCrossList[l.layerId].layerCanvas.height=r,g.layerCrossList[l.layerId].layerCtx.putImageData(o,0,0)}g.canvasWidth=n,g.canvasHeight=r,(g.canvasHeight>100||g.canvasWidth>100)&&(g.isEnableCanvasGrid=!1),m.computeScale(),g.canvasBeginPos.centerX=g.canvasBeginPos.x+g.scale*g.canvasWidth/2,g.canvasBeginPos.centerY=g.canvasBeginPos.y+g.scale*g.canvasHeight/2,m.drawPixelArea(!0),m.handleSetCanvasScale(),m.reDraw(),m.handleLayerAndFrameHighRender(),g.loading=!1}m.saveShapeData()},leave(){m.stop(),g.canvas.className=""},reDrawSelectData(e=g.canvasBeginPos){if(g.isScaling)return;if(8!==g.currentTool)return;g.ctx1.lineWidth=1,g.ctx1.strokeStyle=g.selectActiveColor;let a=Object.keys(g.selectData.selectMapList);for(let t=0;t<a.length;t++){g.ctx1.fillStyle=a[t];let e=g.selectData.selectMapList[a[t]];for(const[a,t]of e){let e=t;if(e[0]>=g.canvasWidth||e[1]>=g.canvasHeight||e[0]<0||e[1]<0)continue;let a=e[0]*g.scale,l=e[1]*g.scale;g.ctx1.fillRect(a,l,g.scale,g.scale),g.ctx1.strokeRect(a+1,l+1,g.scale-2,g.scale-2)}}},saveShapeData(){if(g.isDrawShape){if("circle"===g.currentDrawShape){let e=g.layerCrossList[m.getCurrentLayerId()].layerData,a=m.drawCircle(g.drawShapeData.startX,g.drawShapeData.startY,g.drawShapeData.endX,g.drawShapeData.endY,g.brushSize);for(let t=0;t<a.length;t++){if(a[t][0]>g.canvasWidth||a[t][1]>g.canvasHeight||a[t][0]<0||a[t][1]<0)return;if(m.getCurrentLayerIsLock()){0===e[4*(a[t][0]+a[t][1]*g.canvasWidth)+3]&&g.layerCrossList[m.getCurrentLayerId()].layerCtx.fillRect(a[t][0],a[t][1],g.scale,g.scale)}else g.layerCrossList[m.getCurrentLayerId()].layerCtx.fillRect(a[t][0],a[t][1],g.scale,g.scale)}}else if("line"===g.currentDrawShape){let e=g.layerCrossList[m.getCurrentLayerId()].layerData,a=m.drawLineV2(g.drawShapeData.startX,g.drawShapeData.startY,g.drawShapeData.endX,g.drawShapeData.endY,g.brushSize);for(let t=0;t<a.length;t++){if(a[t][0]>g.canvasWidth||a[t][1]>g.canvasHeight||a[t][0]<0||a[t][1]<0)return;if(m.getCurrentLayerIsLock()){0===e[4*(a[t][0]+a[t][1]*g.canvasWidth)+3]&&g.layerCrossList[m.getCurrentLayerId()].layerCtx.fillRect(a[t][0],a[t][1],g.scale,g.scale)}else g.layerCrossList[m.getCurrentLayerId()].layerCtx.fillRect(a[t][0],a[t][1],g.scale,g.scale)}}else if("rect"===g.currentDrawShape||"fillRect"===g.currentDrawShape){"rect"===g.currentDrawShape?Ha(g.brushSize)?g.layerCrossList[m.getCurrentLayerId()].layerCtx.strokeRect(g.drawShapeData.startX-.5,g.drawShapeData.startY-.5,g.drawShapeData.endX-g.drawShapeData.startX,g.drawShapeData.endY-g.drawShapeData.startY):g.layerCrossList[m.getCurrentLayerId()].layerCtx.strokeRect(g.drawShapeData.startX,g.drawShapeData.startY,g.drawShapeData.endX-g.drawShapeData.startX,g.drawShapeData.endY-g.drawShapeData.startY):"fillRect"===g.currentDrawShape&&g.layerCrossList[m.getCurrentLayerId()].layerCtx.fillRect(g.drawShapeData.startX,g.drawShapeData.startY,g.drawShapeData.endX-g.drawShapeData.startX,g.drawShapeData.endY-g.drawShapeData.startY);let e=g.layerCrossList[m.getCurrentLayerId()].layerData;if(m.getCurrentLayerIsLock()){let a=[];"rect"===g.currentDrawShape?a=Ua(g.drawShapeData.startX,g.drawShapeData.startY,g.drawShapeData.endX,g.drawShapeData.endY,g.ctx1.lineWidth,g.canvasWidth,g.canvasHeight):"fillRect"===g.currentDrawShape&&(a=Na(g.drawShapeData.startX,g.drawShapeData.startY,g.drawShapeData.endX,g.drawShapeData.endY,g.ctx1.lineWidth,g.canvasWidth,g.canvasHeight));for(let t=0;t<a.length;t++){let l=4*(a[t][0]+a[t][1]*g.canvasWidth);0!==e[l+3]&&(g.layerCrossList[m.getCurrentLayerId()].layerCtx.fillStyle=`rgba(${e[l]}, ${e[l+1]}, ${e[l+2]}, ${e[l+3]})`,g.layerCrossList[m.getCurrentLayerId()].layerCtx.clearRect(a[t][0],a[t][1],1,1),g.layerCrossList[m.getCurrentLayerId()].layerCtx.fillRect(a[t][0],a[t][1],1,1))}}}m.reDraw(),g.drawShapeList=[],g.curveEndPos=[],g.curveType.pressKey="0",g.isDrawShape=!1,g.drawShapeData={list:[],startX:0,startY:0,endX:0,endY:0,maxX:0,maxY:0,minX:-1,minY:-1}}},addCursorClass(e=null){0===g.currentTool?g.canvas.classList.add("brush-cursor"):1===g.currentTool?g.canvas.classList.add("eraser-cursor"):2===g.currentTool?g.canvas.classList.add("straw-cursor"):3===g.currentTool?-1!==g.currentDrawShape.toLowerCase().indexOf("rect")?g.canvas.classList.add("rect-cursor"):"line"===g.currentDrawShape||"curve"===g.currentDrawShape?g.canvas.classList.add("brush-cursor"):-1!==g.currentDrawShape.toLowerCase().indexOf("circle")&&g.canvas.classList.add("circle-cursor"):4===g.currentTool?g.canvas.classList.add("bucket-cursor"):5===g.currentTool&&g.pinDouMode?g.isEnablePindouBrushMode?g.canvas.classList.add("brush-cursor"):g.isEnablePindouEraserMode?g.canvas.classList.add("eraser-cursor"):g.canvas.classList.add("pindou-cursor"):7===g.currentTool?g.canvas.classList.add("move-cursor"):8===g.currentTool?g.canvas.classList.add("select-cursor"):11===g.currentTool&&g.canvas.classList.add("crop_cursor")},exportPng(){const e=document.createElement("a");e.download="image.png",e.href=g.canvas.toDataURL("image/png"),e.click()},computeScale(e=!0){const a=document.querySelector(".pixelBox");g.baseCanvas.width=null==a?void 0:a.clientWidth,g.baseCanvas.height=null==a?void 0:a.clientHeight;let t=null==a?void 0:a.clientHeight,n=null==a?void 0:a.clientWidth;g.pinDouMode?(g.layerScale=1,g.pindouScaleValue=30,g.canvas.width=Number(g.pindouBlockWidth)*g.pindouScaleValue,g.canvas.height=Number(g.pindouBlockHeight)*g.pindouScaleValue,g.bgCanvas.width=Number(g.pindouBlockWidth)*g.pindouScaleValue,g.bgCanvas.height=Number(g.pindouBlockHeight)*g.pindouScaleValue,g.gridCanvas.width=Number(g.pindouBlockWidth)*g.pindouScaleValue,g.gridCanvas.height=Number(g.pindouBlockHeight)*g.pindouScaleValue):(g.layerScale=Math.min(g.maxScale,Number((Math.floor(Math.min(t,n))/Math.max(g.canvasWidth,g.canvasHeight)).toFixed(1))),g.layerOriginRectData.scale=g.layerScale,g.layerOriginRectData.width=g.layerScale*g.canvasWidth,g.layerOriginRectData.height=g.layerScale*g.canvasHeight,g.pindouScaleValue=1,g.scale=1,g.canvas.width=Number(g.canvasWidth)*g.pindouScaleValue,g.canvas.height=Number(g.canvasHeight)*g.pindouScaleValue,g.bgCanvas.width=Number(g.canvasWidth)*g.pindouScaleValue,g.bgCanvas.height=Number(g.canvasHeight)*g.pindouScaleValue,g.gridCanvas.width=Number(g.canvasWidth)*g.pindouScaleValue,g.gridCanvas.height=Number(g.canvasHeight)*g.pindouScaleValue,g.scaleBoxDom.style.width=g.canvas.width+"px",g.scaleBoxDom.style.height=g.canvas.height+"px",g.realCanvas.width=g.canvas.width,g.realCanvas.height=g.canvas.height,"undefined"!=typeof OffscreenCanvas?g.worker.postMessage({type:0,canvasWidth:g.canvas.width,canvasHeight:g.canvas.height}):l.$message.warning("当前浏览器版本过低，将影响部分功能的使用")),e&&m.setCanvasCenter()},handleCreateLayerCrossData(e="add",a){if("add"===e)return new Promise(((e,t)=>{const l=document.createElement("canvas");l.width=g.canvasWidth,l.height=g.canvasHeight;const n=l.getContext("2d");g.isEnableCanvasSmooth||(n.imageSmoothingEnabled=!1,n.imageSmoothingQuality="none");let r=l.toDataURL(g.exportFormat,1),i=n.getImageData(0,0,l.width,l.height).data;g.layerCrossList[a.layerId]={layerCanvas:l,layerCtx:n,thumbImg:r,layerData:i,mindLayerList:{}},e(!0)}));if("update"===e){if(g.layerCrossList[a.layerId]){g.layerCrossList[a.layerId].layerCanvas.width=g.canvasWidth,g.layerCrossList[a.layerId].layerCanvas.height=g.canvasHeight;let e=g.layerCrossList[a.layerId].layerCanvas.width,t=g.layerCrossList[a.layerId].layerCanvas.height;return new Promise(((l,n)=>{""===a.currentLayerImg?(g.layerCrossList[a.layerId].thumbImg=g.layerCrossList[a.layerId].layerCanvas.toDataURL(g.exportFormat,1),g.layerCrossList[a.layerId].layerData=g.layerCrossList[a.layerId].layerCtx.getImageData(0,0,e,t).data,l(!0)):createImageBitmap(_a(a.currentLayerImg)).then((n=>{g.layerCrossList[a.layerId].layerCtx.drawImage(n,0,0),g.layerCrossList[a.layerId].thumbImg=g.layerCrossList[a.layerId].layerCanvas.toDataURL(g.exportFormat,1),g.layerCrossList[a.layerId].layerData=g.layerCrossList[a.layerId].layerCtx.getImageData(0,0,e,t).data,l(!0)}))}))}{const e=document.createElement("canvas");e.width=g.canvasWidth,e.height=g.canvasHeight;const t=e.getContext("2d");return g.isEnableCanvasSmooth||(t.imageSmoothingEnabled=!1,t.imageSmoothingQuality="none"),new Promise(((l,n)=>{if(""===a.currentLayerImg){let n=e.toDataURL(g.exportFormat,1),r=t.getImageData(0,0,e.width,e.height).data,i=a.mindLayerList.filter((e=>0!==e)),o={};if(i.length)for(let e=0;e<i.length;e++)o[i[e].mindId]=i[e];g.layerCrossList[a.layerId]={layerCanvas:e,layerCtx:t,thumbImg:n,layerData:r,mindLayerList:o},l(!0)}else createImageBitmap(_a(a.currentLayerImg)).then((n=>{t.drawImage(n,0,0);let r=e.toDataURL(g.exportFormat,1),i=t.getImageData(0,0,e.width,e.height).data,o=a.mindLayerList.filter((e=>0!==e)),s={};if(o.length)for(let e=0;e<o.length;e++)s[o[e].mindId]=o[e];g.layerCrossList[a.layerId]={layerCanvas:e,layerCtx:t,thumbImg:r,layerData:i,mindLayerList:s},l(!0)}))}))}}},async handleAddLayer(){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");if(g.isScaling&&m.handleCancelScale(),g.drawRecord[g.currentFrameIndex].layer.length>g.maxLayer)return l.$message.warning("图层数量达到上限");let e=g.historyLayerNameIndex[g.historyLayerNameIndex.length-1]+1,a={layerId:Ia.v4(),layerName:`图层${e+1}`,alpha:100,isLock:!1,currentLayerImg:"",isExpandMindList:!0,mindLayerList:[],isRender:!0};await m.handleCreateLayerCrossData("add",a),a.currentLayerImg=g.layerCrossList[a.layerId].thumbImg,g.historyLayerNameIndex.push(e),g.drawRecord[g.currentFrameIndex].layer.unshift(a),m.handleChangeLayer(0),m.handleAddHistory()},handleLayerMerge(){if(g.isScaling&&m.handleCancelScale(),8===g.currentTool&&m.handleCancelSelect(),g.selectLayerList.length>1){g.selectLayerList.sort(((e,a)=>a-e));let e=g.drawRecord[g.currentFrameIndex].layer[g.selectLayerList[0]];for(let t=1;t<g.selectLayerList.length;t++){let a=g.drawRecord[g.currentFrameIndex].layer[g.selectLayerList[t]].layerId;g.layerCrossList[e.layerId].layerCtx.drawImage(g.layerCrossList[a].layerCanvas,0,0),e.mindLayerList.push(...g.drawRecord[g.currentFrameIndex].layer[g.selectLayerList[t]].mindLayerList),g.layerCrossList[e.layerId].mindLayerList=o(o({},g.layerCrossList[e.layerId].mindLayerList),g.layerCrossList[a].mindLayerList),g.drawRecord[g.currentFrameIndex].layer.splice(g.selectLayerList[t],1)}let a=g.drawRecord[g.currentFrameIndex].layer.findIndex((a=>a.layerId===e.layerId));m.handleChangeLayer(a),m.reDraw()}},handleChangeLayer(e){if(g.isScaling&&e!==g.currentLayerIndex&&m.handleCancelScale(),g.pinDouMode)return g.currentLayerIndex=e,g.currentLayerId=m.getCurrentLayerId(),g.historyLayerIndexRecord.push(g.currentLayerId),g.layerAlpha=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].alpha||100,g.selectLayerList=[g.currentLayerIndex],void m.handlePindouEvent();g.isShift?g.selectLayerList.includes(e)||g.selectLayerList.push(e):(m.handleCancelSelectMindObj(),g.currentLayerIndex=e,g.currentLayerId=m.getCurrentLayerId(),g.historyLayerIndexRecord.push(g.currentLayerId),g.layerAlpha=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].alpha||100,g.selectLayerList=[g.currentLayerIndex])},handleChangeLayerVisible(e){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");if(g.isScaling&&m.handleCancelScale(),e<0){for(let e=0;e<g.drawRecord[g.currentFrameIndex].layer.length;e++)g.drawRecord[g.currentFrameIndex].layer[e].isRender=!g.currentFrameLayerVisible;return g.currentFrameLayerVisible=!g.currentFrameLayerVisible,void m.reDraw(!0,!1)}let a=g.drawRecord[g.currentFrameIndex].layer[e].isRender;g.drawRecord[g.currentFrameIndex].layer[e].isRender=!a,8===g.currentTool&&m.handleCancelSelect(),m.reDraw(!0,!1)},async handleClearLayer(e){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");if(g.isScaling&&m.handleCancelScale(),8===g.currentTool&&m.handleCancelSelect(),"all"===e)for(let a=0;a<g.drawRecord[g.currentFrameIndex].layer.length;a++)g.drawRecord[g.currentFrameIndex].layer[a].currentLayerImg="",g.drawRecord[g.currentFrameIndex].layer[a].mindLayerList=[],await m.handleCreateLayerCrossData("update",g.drawRecord[g.currentFrameIndex].layer[a]);else"single"===e&&(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].currentLayerImg="",g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].mindLayerList=[],await m.handleCreateLayerCrossData("update",g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex]));m.reDraw()},handleLockLayer(e,a){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");g.drawRecord[g.currentFrameIndex].layer[e].isLock=a},handleDeleteLayer(e){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");g.isScaling&&m.handleCancelScale(),8===g.currentTool&&m.handleCancelSelect(),g.drawRecord[g.currentFrameIndex].layer.splice(e,1);let a=g.drawRecord[g.currentFrameIndex].layer.findIndex((e=>g.historyLayerIndexRecord[g.historyLayerIndexRecord.length-1]===e.layerId));a<0&&(a=0),g.currentLayerIndex=a,g.layerAlpha=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].alpha||100,g.currentLayerId=m.getCurrentLayerId(),g.selectLayerList=[g.currentLayerIndex],m.reDraw()},async handleCopyLayer(e){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");g.isScaling&&m.handleCancelScale();let a=JSON.parse(JSON.stringify(g.drawRecord[g.currentFrameIndex].layer[e]));a.layerName=`${a.layerName} Copy`;for(let t=0;t<a.mindLayerList.length;t++){let e=o({},g.layerCrossList[a.layerId].mindLayerList[a.mindLayerList[t]]);e.mindId=Ia.v1(),a.mindLayerList[t]=e}a.layerId=Ia.v4(),await m.handleCreateLayerCrossData("update",a),a.mindLayerList=a.mindLayerList.map((e=>e.mindId)),g.drawRecord[g.currentFrameIndex].layer.splice(e,0,a),m.handleChangeLayer(e),m.handleAddHistory()},handleDoubleClickLayer(e,a){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");g.currentEditLayer.index=e,g.currentEditLayer.name=a},handleEditLayerName(){if(""===g.currentEditLayer.name.trim())return l.$message.warning("请填写图层名称");g.drawRecord[g.currentFrameIndex].layer[g.currentEditLayer.index].layerName=g.currentEditLayer.name,g.currentEditLayer.index=-1,g.currentEditLayer.name="",m.handleAddHistory()},handleDoubleClickLayerMind(e,a){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");g.currentEditLayer.mindIndex=e,g.currentEditLayer.mindName=a},handleEditLayerMindName:()=>g.pinDouMode?l.$message.warning("请先退出拼豆预览模式"):""===g.currentEditLayer.mindName.trim()?l.$message.warning("请填写图层名称"):(g.layerCrossList[m.getCurrentLayerId()].mindLayerList[g.currentEditLayer.mindIndex].mindName=g.currentEditLayer.mindName,g.currentEditLayer.mindIndex=-1,void(g.currentEditLayer.mindName="")),handleMindToPixel(e,a,t,l){if(1===e){let e=g.layerCrossList[l].mindLayerList[a];g.layerCrossList[l].layerCtx.drawImage(e.mindCanvas,e.left,e.top),m.handleDeleteLayerMind(t,l),m.handleLayerImgById(l)}else for(let n=0;n<g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].mindLayerList.length;n++){let e=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].mindLayerList[n],a=g.layerCrossList[g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerId].mindLayerList[e];g.layerCrossList[g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerId].layerCtx.drawImage(a.mindCanvas,a.left,a.top),m.handleDeleteLayerMind(n,g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerId),n--}},handleDeleteLayerMind(e,a){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");g.isControlMindObj=!1;let t=m.getCurrentLayerIndexById(a);g.drawRecord[g.currentFrameIndex].layer[t].mindLayerList.splice(e,1),m.reDraw()},handleSaveMindForSprite(e,a){let t=g.layerCrossList[a].mindLayerList[e].mindObj,n=Ia.v4();h.saveSprite({spriteID:n,spriteImg:t}).then((e=>{e&&l.$message.success(l.$t("message.saveSucceeded"))})).catch((e=>{l.$message.error(l.$t("message.saveFailed"))}))},handleCopyMindObj(e,a,t,l){let n=g.layerCrossList[t].mindLayerList[e];const r=document.createElement("canvas");r.width=n.mindCanvas.width,r.height=n.mindCanvas.height;const i=r.getContext("2d");null==i||i.drawImage(n.mindCanvas,0,0);let o={mindId:Ia.v1(),mindObj:n.mindObj,mindCanvas:r,mindCtx:i,isLock:n.isLock,isHide:n.isHide,width:n.width,height:n.height,left:n.left,top:n.top,mindName:`智能对象${Object.keys(g.layerCrossList[t].mindLayerList).length+1}`};g.layerCrossList[t].mindLayerList[o.mindId]=o,g.drawRecord[g.currentLayerIndex].layer[l].mindLayerList.push(o.mindId),m.reDraw()},handleCancelSelectMindObj(){if(!g.isControlMindObj)return;let e=g.layerCrossList[m.getCurrentLayerId()].mindLayerList[g.currentSelectMindId];e&&(e.mindCanvas.width=Math.round(parseFloat(g.scaleStyle.width)),e.mindCanvas.height=Math.round(parseFloat(g.scaleStyle.height)),e.mindCtx.drawImage(g.scaleCanvas,0,0),e.mindObj=e.mindCanvas.toDataURL(g.exportFormat,1),e.width=e.mindCanvas.width,e.height=e.mindCanvas.height,e.left=Math.round(parseFloat(g.scaleStyle.left)),e.top=Math.round(parseFloat(g.scaleStyle.top)),g.scaleStyle.left="0px",g.scaleStyle.top="0px",g.scaleImg="",g.scaleCanvas.width=g.canvasWidth,g.scaleCanvas.height=g.canvasHeight,m.handleResizeStyle(),m.reDraw(!0,!1),g.isControlMindObj=!1,g.currentSelectMindId="0")},handleSelectMindObj(e,a,t){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");g.currentLayerIndex!==a?(m.handleCancelSelectMindObj(),m.handleChangeLayer(a),g.currentSelectMindId=e):g.currentSelectMindId===e?(m.handleCancelSelectMindObj(),g.currentSelectMindId="0"):(m.handleCancelSelectMindObj(),g.currentSelectMindId=e),setTimeout((()=>{if("0"!==g.currentSelectMindId){let a=g.layerCrossList[m.getCurrentLayerId()].mindLayerList[e];g.ctx5.clearRect(0,0,g.scaleCanvas.width,g.scaleCanvas.height);let t=a.width,l=a.height;g.scaleImg=a.mindObj,g.resizeStyle.width=t*g.layerScale+"px",g.resizeStyle.height=l*g.layerScale+"px",g.scaleStyle.width=t+"px",g.scaleStyle.height=l+"px",g.scaleStyle.left=a.left+"px",g.scaleStyle.top=a.top+"px",g.scaleCanvas.width=t,g.scaleCanvas.height=l,g.ctx5.imageSmoothingEnabled=!1,g.ctx5.imageSmoothingQuality="none",m.reDraw(!1,!1,!0,!1),m.handleResizeStyle(),g.ctx5.drawImage(a.mindCanvas,0,0),g.isControlMindObj=!0}}),500)},handleChangeLayerMindVisible(e,a){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");g.layerCrossList[a].mindLayerList[e].isHide=!g.layerCrossList[a].mindLayerList[e].isHide,m.reDraw(!0,!1)},async handleExportLayer(e=g.currentFrameIndex,a=g.currentLayerIndex,t=!0,l=1,n=g.exportStyleOptions,r="pic"){let{isShowGrid:i}=n,o=g.drawRecord[e].layer[a].currentLayerImg,s=g.drawRecord[e].layer[a].layerId;if(i){const t=document.createElement("canvas");t.width=g.canvasWidth,t.height=g.canvasHeight;const l=t.getContext("2d");l.drawImage(g.layerCrossList[s].layerCanvas,0,0,t.width,t.height);for(let n=0;n<g.drawRecord[e].layer[a].mindLayerList.length;n++){let t=g.layerCrossList[s].mindLayerList[g.drawRecord[e].layer[a].mindLayerList[n]];t.isHide||l.drawImage(t.mindCanvas,t.left,t.top)}return o=t.toDataURL(g.exportFormat,1),await m.handleExportGridFrame(o,n)}return new Promise(((n,i)=>{g.ctx3.globalAlpha=1,g.realCanvas.width=g.canvasWidth*l,g.realCanvas.height=g.canvasHeight*l,g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height);const o=document.createElement("canvas");o.width=g.canvasWidth,o.height=g.canvasHeight;const c=o.getContext("2d");c.drawImage(g.layerCrossList[s].layerCanvas,0,0,o.width,o.height);for(let t=0;t<g.drawRecord[e].layer[a].mindLayerList.length;t++){let l=g.layerCrossList[s].mindLayerList[g.drawRecord[e].layer[a].mindLayerList[t]];l.isHide||c.drawImage(l.mindCanvas,l.left,l.top)}if("gif"===r){const e=c.getImageData(0,0,o.width,o.height),a=e.data;for(let t=0;t<a.length;t+=4){const e=a[t],l=a[t+1],n=a[t+2];0!==a[t+3]&&(0===e&&0===l&&0===n&&(a[t]=16,a[t+1]=16,a[t+2]=16))}c.putImageData(e,0,0)}if(l>1){const e=c.getImageData(0,0,o.width,o.height).data;t?m.handleNearestNeighborResize(g.canvasWidth,g.canvasHeight,l,e,!0,`layer${a+1}`):m.handleNearestNeighborResize(g.canvasWidth,g.canvasHeight,l,e,!1,"",!0).then((e=>{g.ctx3.drawImage(e,0,0)}))}else g.ctx3.drawImage(o,0,0),t&&za(g.realCanvas,`layer${a+1}`);n(!0)}))},handleImportDragImage(e){if(!l.$config.supportUploadImageType.includes(e.type))return l.$message.warning("导入文件格式不正确");if("application"===e.type.split("/")[0])m.handleImportImageLayer(e,"1");else{let a=URL.createObjectURL(e);m.handleImportImageLayer(a,"0")}},handleImportSprite(e){const a=new Image;a.src=e,a.onload=function(){m.handleTransfromPngToPixel(a,null,g.currentLayerIndex)}},handleImportImageLayer(e,a,t=1,n={blockH:0,blockW:0,colorThreshold:8,isEnableReduceColor:!0,colorReduceThreshold:5,isEnableVisionMode:!1}){if(8===g.currentTool&&m.handleCancelSelect(),g.isScaling&&m.handleCancelScale(),"0"===a){g.loading=!0;const a=new Image,l=e;a.src=l,a.onload=function(){let e=Math.floor(a.width/t),r=Math.floor(a.height/t);0!==n.blockH&&0!==n.blockW&&(r=Math.floor(a.height/n.blockH),e=Math.floor(a.width/n.blockW)),e>g.canvasWidth||r>g.canvasHeight?m.handleTransfromPngToPixel(a,l,g.currentLayerIndex,!0):a.width<=g.canvasWidth&&a.height<=g.canvasHeight?m.handleTransfromPngToPixel(a,l,g.currentLayerIndex):m.handleTransformPngToPixel2(a,l,g.currentLayerIndex,t,n)}}else g.loading=!0,r.handleExcelToPixel(e,(({tempCanvas:e,tempCtx:a})=>{let t=e.toDataURL(g.exportFormat,1),l=m.getCurrentLayerId(),n=Ia.v1();g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].mindLayerList.push(n),g.layerCrossList[l].mindLayerList[n]={mindId:n,mindObj:t,mindCanvas:e,mindCtx:a,isLock:!0,isHide:!1,width:e.width,height:e.height,left:0,top:0,mindName:`智能对象${Object.keys(g.layerCrossList[l].mindLayerList).length+1}`},m.reDraw(),g.loading=!1}),(e=>{g.loading=!1,l.$message.error(e)}),{canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight})},handleImportLayer(e=g.currentLayerIndex){8===g.currentTool&&m.handleCancelSelect(),g.isScaling&&m.handleCancelScale();const a=document.createElement("input");a.type="file",a.accept="image/png,image/jpg",a.addEventListener("change",(function(){const t=a.files[0];if(t){g.loading=!0;const a=new Image,l=URL.createObjectURL(t);a.src=l,a.onload=function(){a.width>g.canvasWidth||a.height>g.canvasHeight?m.handleTransfromPngToPixel(a,l,e,!0):m.handleTransfromPngToPixel(a,l,e)}}})),document.body.appendChild(a),a.click(),document.body.removeChild(a)},handleTransfromPngToPixel(e,a,t,n=!1){const r=document.createElement("canvas");r.width=e.width,r.height=e.height;const i=r.getContext("2d");if(i.imageSmoothingEnabled=!1,i.imageSmoothingQuality="none",n)return r.width=g.canvasWidth,r.height=g.canvasHeight,void u.resize(e,r,{unsharpAmount:100,unsharpRadius:.5,unsharpThreshold:6}).then((e=>{let t=r.toDataURL(g.exportFormat,1),l=m.getCurrentLayerId(),n=Ia.v1();g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].mindLayerList.push(n),g.layerCrossList[l].mindLayerList[n]={mindId:n,mindObj:t,mindCanvas:r,mindCtx:i,isLock:!0,isHide:!1,width:g.canvasWidth,height:g.canvasHeight,left:0,top:0,mindName:`智能对象${Object.keys(g.layerCrossList[l].mindLayerList).length+1}`},m.reDraw(),URL.revokeObjectURL(a),g.loading=!1})).catch((e=>{l.$message.error("图片导入异常"),g.loading=!1}));i.drawImage(e,0,0);let o=r.toDataURL(g.exportFormat,1),s=m.getCurrentLayerId(),c=Ia.v1();g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].mindLayerList.push(c),g.layerCrossList[s].mindLayerList[c]={mindId:c,mindObj:o,mindCanvas:r,mindCtx:i,isLock:!0,isHide:!1,width:e.width,height:e.height,left:0,top:0,mindName:`智能对象${Object.keys(g.layerCrossList[s].mindLayerList).length+1}`},m.reDraw(),a&&URL.revokeObjectURL(a),g.loading=!1},handleTransformPngToPixel2(e,a,t,l=1,n={blockH:0,blockW:0,colorThreshold:8,isEnableReduceColor:!0,colorReduceThreshold:5,isEnableVisionMode:!1}){let r=Math.floor(e.width/l),i=Math.floor(e.height/l);0!==n.blockH&&0!==n.blockW&&(r=Math.floor(e.width/n.blockW),i=Math.floor(e.height/n.blockH));const o=document.createElement("canvas");o.width=e.width,o.height=e.height;const s=o.getContext("2d");s.drawImage(e,0,0);const c=s.getImageData(0,0,o.width,o.height).data;g.worker.postMessage({type:108,variables:c,pxSize:l,options:{width:r,height:i,canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight,imageWidth:e.width,imageHeight:e.height,colorThreshold:n.colorThreshold,isEnableReduceColor:n.isEnableReduceColor,colorReduceThreshold:n.colorReduceThreshold,isEnableVisionMode:n.isEnableVisionMode}}),g.worker.onmessage=e=>{o.width=Math.min(r,g.canvasWidth),o.height=Math.min(i,g.canvasHeight),s.drawImage(e.data.imageBitmap,0,0),a&&URL.revokeObjectURL(a);let t=m.getCurrentLayerId(),l=o.toDataURL(g.exportFormat,1),n=Ia.v1();g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].mindLayerList.push(n),g.layerCrossList[t].mindLayerList[n]={mindId:n,mindObj:l,mindCanvas:o,mindCtx:s,isLock:!0,isHide:!1,width:Math.min(r,g.canvasWidth),height:Math.min(i,g.canvasHeight),left:0,top:0,mindName:`智能对象${Object.keys(g.layerCrossList[t].mindLayerList).length+1}`},g.loading=!1,m.reDraw()}},handleChangeLayerAlpha(){g.loading=!0;let e=Oa(g.layerCrossList[m.getCurrentLayerId()].layerData);g.worker.postMessage({type:107,variables:e,targetAlpha:g.layerAlpha}),g.worker.onmessage=e=>{if(107!==e.data.type)return;const a=new ImageData(e.data.currentLayerData,g.canvasWidth,g.canvasHeight);g.layerCrossList[m.getCurrentLayerId()].layerCtx.putImageData(a,0,0),g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].alpha=g.layerAlpha,g.loading=!1,m.reDraw()}},handleCopyLayerData(){let e=g.drawRecord[g.LayerMenu.contextData.currentFrameIndex].layer[g.LayerMenu.contextData.index];h.layerCopyData=JSON.parse(JSON.stringify(e)),l.$message.success("复制成功")},async handlePasteLayerData(){if(!h.layerCopyData)return l.$message.warning("数据不存在");let e=JSON.parse(JSON.stringify(h.layerCopyData));g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].currentLayerImg=e.currentLayerImg,await m.handleCreateLayerCrossData("update",g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex]),l.$message.success("粘贴成功"),m.reDraw()},async handleAddFrame(e=!0){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");if(g.drawRecord.length>=g.maxFrame)return l.$message.warning("帧数量达到上限");8===g.currentTool&&m.handleCancelSelect(),g.isScaling&&m.handleCancelScale();let a=Ia.v4();await m.handleCreateLayerCrossData("add",{layerId:a});let t={frameId:Ia.v1(),currentFrameImg:null,layer:[{layerId:a,layerName:"图层1",alpha:100,isLock:!1,currentLayerImg:g.layerCrossList[a].thumbImg,isExpandMindList:!0,mindLayerList:[],isRender:!0}]};g.drawRecord.push(t),e&&m.handleChangeFrame(g.drawRecord.length-1)},handleChangeFrame:e=>g.selectData.selectList.length&&e!==g.currentFrameIndex?l.$message.warning("请先取消选中区域"):(g.isScaling&&e!==g.currentFrameIndex&&m.handleCancelScale(),m.handleCancelSelectMindObj(),g.currentFrameIndex=e,g.currentFrameId=m.getCurrentFrameId(),g.historyFrameIndexRecord.push(g.currentFrameId),g.pinDouMode?(g.currentLayerIndex=0,void m.handlePindouEvent()):(m.handleChangeLayer(0),void m.reDraw(!0,!1))),async handleCopyFrame(e,a="copy"){if("copyData"===a)h.frameCopyData=JSON.parse(JSON.stringify(g.drawRecord[e])),l.$message.success("复制成功");else if("pasteData"===a){if(!h.frameCopyData)return l.$message.warning("数据不存在");let a=JSON.parse(JSON.stringify(h.frameCopyData));if(a.frameId===g.drawRecord[e].frameId){g.drawRecord[e]=JSON.parse(JSON.stringify(a));for(let a=0;a<g.drawRecord[e].layer.length;a++)await m.handleCreateLayerCrossData("update",g.drawRecord[e].layer[a])}else{g.drawRecord[e].currentFrameImg=a.currentFrameImg,g.drawRecord[e].layer=a.layer;for(let a=0;a<g.drawRecord[e].layer.length;a++){for(let t=0;t<g.drawRecord[e].layer[a].mindLayerList.length;t++){let l=o({},g.layerCrossList[g.drawRecord[e].layer[a].layerId].mindLayerList[g.drawRecord[e].layer[a].mindLayerList[t]]);l.mindId=Ia.v1(),g.drawRecord[e].layer[a].mindLayerList[t]=l}g.drawRecord[e].layer[a].layerId=Ia.v4(),await m.handleCreateLayerCrossData("update",g.drawRecord[e].layer[a]),g.drawRecord[e].layer[a].mindLayerList=g.drawRecord[e].layer[a].mindLayerList.map((e=>e.mindId))}}l.$message.success("粘贴成功"),e===g.currentFrameIndex&&m.reDraw(!0,!0)}else if("copy"===a){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");if(8===g.currentTool&&m.handleCancelSelect(),g.isScaling&&m.handleCancelScale(),g.drawRecord.length>=g.maxFrame)return l.$message.warning("帧数量达到上限");let a=JSON.parse(JSON.stringify(g.drawRecord[e]));a.frameId=Ia.v1();for(let e=0;e<a.layer.length;e++){for(let t=0;t<a.layer[e].mindLayerList.length;t++){let l=o({},g.layerCrossList[a.layer[e].layerId].mindLayerList[a.layer[e].mindLayerList[t]]);l.mindId=Ia.v1(),a.layer[e].mindLayerList[t]=l}a.layer[e].layerId=Ia.v4(),await m.handleCreateLayerCrossData("update",a.layer[e]),a.layer[e].mindLayerList=a.layer[e].mindLayerList.map((e=>e.mindId))}g.drawRecord.splice(e,0,a),m.handleChangeFrame(e+1),m.handleAddHistory()}},handleDeleteFrame(e){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");8===g.currentTool&&e===g.currentFrameIndex&&m.handleCancelSelect(),g.isScaling&&e===g.currentFrameIndex&&m.handleCancelScale(),g.drawRecord.splice(e,1);let a=g.drawRecord.findIndex((e=>g.historyFrameIndexRecord[g.historyFrameIndexRecord.length-1]===e.frameId));a<0&&(a=0),m.handleChangeFrame(a),m.handleAddHistory()},handleExportGridFrame(e,a=g.exportStyleOptions){let{gridBackgroundColor:t,gridColor:l}=a,n=a.gridSize;return new Promise(((a,r)=>{g.realCanvas.width=g.canvasWidth*n,g.realCanvas.height=g.canvasHeight*n,g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height),t!==g.emptyColor&&(g.ctx3.fillStyle=t,g.ctx3.fillRect(0,0,g.realCanvas.width,g.realCanvas.height));const i=document.createElement("canvas");i.width=g.canvasWidth,i.height=g.canvasHeight;const o=i.getContext("2d"),s=new Image;s.src=e,s.onload=async()=>{o.drawImage(s,0,0,i.width,i.height);const e=o.getImageData(0,0,i.width,i.height).data;let t=await m.handleNearestNeighborResize(g.canvasWidth,g.canvasHeight,n,e,!1,"",!0);g.ctx3.drawImage(t,0,0),(()=>{g.ctx3.strokeStyle=l,g.ctx3.globalAlpha=1,g.ctx3.lineWidth=1,g.ctx3.beginPath();for(let e=0;e<=g.canvasHeight;e++)g.ctx3.moveTo(0,e*n),g.ctx3.lineTo(g.canvasWidth*n,e*n);for(let e=0;e<=g.canvasWidth;e++)g.ctx3.moveTo(e*n,0),g.ctx3.lineTo(e*n,g.canvasHeight*n);g.ctx3.stroke()})(),a(!0)}}))},async handleExportFrame(e,a=!0,t=1,l=g.exportStyleOptions,n="pic"){let{isShowGrid:r}=l;return g.ctx3.globalAlpha=1,r?await m.handleExportGridFrame(g.drawRecord[e].currentFrameImg,l):new Promise(((l,r)=>{g.drawRecord[e].currentFrameImg||l(!0),1===t&&(g.realCanvas.width=g.canvasWidth,g.realCanvas.height=g.canvasHeight),g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height);const i=document.createElement("canvas");i.width=g.canvasWidth,i.height=g.canvasHeight;const o=i.getContext("2d"),s=new Image;s.src=g.drawRecord[e].currentFrameImg,s.onload=async()=>{if(o.drawImage(s,0,0,i.width,i.height),"gif"===n){const e=o.getImageData(0,0,i.width,i.height),a=e.data;for(let t=0;t<a.length;t+=4){const e=a[t],l=a[t+1],n=a[t+2];0!==a[t+3]&&(0===e&&0===l&&0===n&&(a[t]=16,a[t+1]=16,a[t+2]=16))}o.putImageData(e,0,0)}if(t>1){const l=o.getImageData(0,0,i.width,i.height).data;if(a)m.handleNearestNeighborResize(g.canvasWidth,g.canvasHeight,t,l,!0,`frame${e+1}`);else{let e=await m.handleNearestNeighborResize(g.canvasWidth,g.canvasHeight,t,l,!1,"",!0);g.ctx3.drawImage(e,0,0)}}else g.ctx3.drawImage(i,0,0),a&&za(g.realCanvas,`frame${e+1}`);l(!0)}}))},handleNearestNeighborResize:(e,a,t,l,n=!1,r,i=!1,o=!1)=>new Promise(((o,s)=>{const c=document.createElement("canvas"),d=c.getContext("2d"),h=e*t,u=a*t;c.width=h,c.height=u;const g=d.createImageData(h,u),p=g.data,m=e/h,y=a/u;for(let a=0;a<u;a++)for(let t=0;t<h;t++){const n=Math.floor(t*m),r=4*(Math.floor(a*y)*e+n),i=4*(a*h+t);p[i]=l[r],p[i+1]=l[r+1],p[i+2]=l[r+2],p[i+3]=l[r+3]}d.putImageData(g,0,0),n&&za(c,r),i&&o(c)})),handleExportFrameForBlock(e,a=!0,t=1,l=g.exportStyleOptions,n=.26){g.ctx3.globalAlpha=1;const r=(t=Math.floor(28*n))/5;return g.realCanvas.width=g.canvasWidth*t,g.realCanvas.height=g.canvasHeight*t,g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height),g.ctx3.shadowColor="rgba(0, 0, 0, 0.5)",g.ctx3.shadowBlur=2,g.ctx3.shadowOffsetX=1,g.ctx3.shadowOffsetY=1,new Promise(((a,l)=>{const n=document.createElement("canvas");n.width=g.canvasWidth,n.height=g.canvasHeight;const i=n.getContext("2d"),o=new Image;o.src=g.drawRecord[e].currentFrameImg,o.onload=async()=>{if(i.drawImage(o,0,0,n.width,n.height),t>1){const e=i.getImageData(0,0,n.width,n.height).data;let a=await m.handleNearestNeighborResize(g.canvasWidth,g.canvasHeight,t,e,!1,"",!0),l=a.getContext("2d").getImageData(0,0,a.width,a.height).data,o={};for(let n=0;n<g.canvasHeight;n++)for(let e=0;e<g.canvasWidth;e++){let a=ia(m.getPixelColorByCoords(l,e*t,n*t,g.canvasWidth*t));a!==g.emptyColor&&(o[a]||(o[a]=new Map),o[a].set(`${e}/${n}`,[e,n]))}let s=Object.keys(o);for(let n=0;n<s.length;n++){let e=o[s[n]],a=s[n];g.ctx3.fillStyle=a;for(const[l,n]of e){let e=n[0],a=n[1];g.ctx3.fillRect(e*t,a*t,t,t),g.ctx3.shadowColor="rgba(0, 0, 0, 0.8)",g.ctx3.shadowBlur=2,g.ctx3.shadowOffsetX=1,g.ctx3.shadowOffsetY=1,g.ctx3.beginPath(),g.ctx3.arc(e*t+t/2,a*t+t/2,r,0,2*Math.PI,!1),g.ctx3.closePath(),g.ctx3.fill()}}}a(!0)}}))},handleExportFrameForPindou(e,a=!0,t=1,l=g.exportStyleOptions,n=.26){g.ctx3.globalAlpha=1;const r=t=Math.floor(28*n),i=t/5;return g.realCanvas.width=g.canvasWidth*t,g.realCanvas.height=g.canvasHeight*t,g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height),g.ctx3.shadowColor="rgba(0, 0, 0, 0.5)",g.ctx3.shadowBlur=2,g.ctx3.shadowOffsetX=1,g.ctx3.shadowOffsetY=1,new Promise(((a,l)=>{const n=document.createElement("canvas");n.width=g.canvasWidth,n.height=g.canvasHeight;const o=n.getContext("2d"),s=new Image;s.src=g.drawRecord[e].currentFrameImg,s.onload=async()=>{if(o.drawImage(s,0,0,n.width,n.height),t>1){const e=o.getImageData(0,0,n.width,n.height).data;let a=await m.handleNearestNeighborResize(g.canvasWidth,g.canvasHeight,t,e,!1,"",!0),l=a.getContext("2d").getImageData(0,0,a.width,a.height).data,s={};for(let n=0;n<g.canvasHeight;n++)for(let e=0;e<g.canvasWidth;e++){let a=ia(m.getPixelColorByCoords(l,e*t,n*t,g.canvasWidth*t));a!==g.emptyColor&&(s[a]||(s[a]=new Map),s[a].set(`${e}/${n}`,[e,n]))}let c=Object.keys(s);for(let n=0;n<c.length;n++){let e=s[c[n]],a=c[n];for(const[l,n]of e){let e=n[0],l=n[1];g.ctx3.fillStyle=a,g.ctx3.beginPath(),g.ctx3.arc(e*t+r/2,l*t+r/2,r/2,0,2*Math.PI,!1),g.ctx3.closePath(),g.ctx3.fill(),g.ctx3.shadowColor="rgba(80, 80, 80, 0.5)",g.ctx3.shadowBlur=2,g.ctx3.shadowOffsetX=1,g.ctx3.shadowOffsetY=1,g.ctx3.fillStyle="rgba(0, 0, 0, 1)",g.ctx3.beginPath(),g.ctx3.arc(e*t+r/2,l*t+r/2,i,0,2*Math.PI,!1),g.ctx3.closePath(),g.ctx3.fill()}}}a(!0)}}))},async compressDrawRecordData(){let e=JSON.parse(JSON.stringify(g.drawRecord));for(let a=0;a<e.length;a++){let t=await Ka(e[a].currentFrameImg);e[a].currentFrameImg=t;for(let l=0;l<e[a].layer.length;l++){if(g.layerCrossList[e[a].layer[l].layerId])for(let n=0;n<e[a].layer[l].mindLayerList.length;n++){let t=o({},g.layerCrossList[e[a].layer[l].layerId].mindLayerList[e[a].layer[l].mindLayerList[n]]);e[a].layer[l].mindLayerList[n]=t||0,delete e[a].layer[l].mindLayerList[n].mindCanvas,delete e[a].layer[l].mindLayerList[n].mindCtx,e[a].layer[l].mindLayerList[n].mindObj=await Ka(e[a].layer[l].mindLayerList[n].mindObj)}let t=await Ka(e[a].layer[l].currentLayerImg);e[a].layer[l].currentLayerImg=t}}return e},async handleExportProject(e){g.exportLoaidng=!0;let a=s(o({},g.projectData),{width:g.canvasWidth,height:g.canvasHeight,data:null});a.data=await m.compressDrawRecordData(),a.frameImg="@";let t=JSON.parse(JSON.stringify(a));delete t.isBackup,delete t.backupUpdatedAt,delete t.authorUid;let n=await pt(t);if(!n){const t=JSON.stringify(a);return n=new Blob([t],{type:""}),oa.saveAs(n,`${e}.json`),l.$message.success("导出成功"),void(g.exportLoaidng=!1)}oa.saveAs(n,`${e}.px`),l.$message.success("导出成功"),g.exportLoaidng=!1},handleImportProject(){if(!g.projectData)return l.$message.error(l.$t("message.importFailed"));let e=JSON.parse(JSON.stringify(g.projectData));e.createAt=Da(),e.updateAt=e.createAt,e.projectId=Ia.v1(),e.tip="新项目",e.isTop=0,e.isLargeCanvas="1",h.saveProject(e).then((e=>{e&&l.$message.success(l.$t("message.importSucceeded")+"，请在我的项目中查看")})).catch((e=>{l.$message.error(l.$t("message.importFailed"))}))},async handleExport(e,a,t=1,n=!1,i=g.exportStyleOptions,s=2,c=.26,d){if((![5,6].includes(e)||!h.checkVipFunction("gifExport"))&&(![7].includes(e)||!h.checkVipFunction("excelExport"))&&(g.previewLoading||!h.checkVipFunction("beitu",t)))if(n||(g.exportLoaidng=!0),g.isExportProject)m.handleExportProject(a);else{if(0===e&&("frame"===g.exportSingleImage?(g.realCanvas.width=g.canvasWidth*t,g.realCanvas.height=g.canvasHeight*t,await m.handleExportFrame(g.exportSingleImageIndex,!1,t,i),Ya(g.realCanvas.toDataURL("image/png"),a)):"layer"===g.exportSingleImage&&(await m.handleExportLayer(g.currentFrameIndex,g.currentLayerIndex,!1,t,i),Ya(g.realCanvas.toDataURL("image/png"),a))),1===e){const e=document.createElement("canvas");e.width=g.canvasWidth*t*g.drawRecord.length,e.height=g.canvasHeight*t;const l=e.getContext("2d");g.realCanvas.width=g.canvasWidth*t,g.realCanvas.height=g.canvasHeight*t;for(let a=0;a<g.drawRecord.length;a++)await m.handleExportFrame(a,!1,t),l.drawImage(g.realCanvas,a*g.canvasWidth*t,0);if(n)return e.toDataURL("image/png");za(e,a)}else if(2===e){let e=0,l=[],n=[];for(let a=0;a<g.drawRecord.length;a++){l[a]=[];let n=g.drawRecord[a].layer.length;e<n&&(e=n);let r=0;for(let e=n-1;e>=0;e--)await m.handleExportLayer(a,e,!1,t),l[a][r]=g.ctx3.getImageData(0,0,g.canvasWidth*t,g.canvasHeight*t),r++}for(let a=0;a<e;a++){const e=document.createElement("canvas");e.width=g.canvasWidth*t*g.drawRecord.length,e.height=g.canvasHeight*t;const r=e.getContext("2d");for(let n=0;n<l.length;n++)if(l[n][a]){let e=document.createElement("canvas");e.width=g.canvasWidth*t,e.height=g.canvasHeight*t,e.getContext("2d").putImageData(l[n][a],0,0),r.drawImage(e,n*g.canvasWidth*t,0)}else;n.push(e.toDataURL("image/png"))}Xa(`${a}`,n)}else if(3===e){let e=[];g.realCanvas.width=g.canvasWidth*t,g.realCanvas.height=g.canvasHeight*t;for(let a=0;a<g.drawRecord.length;a++)await m.handleExportFrame(a,!1,t,i),e.push(g.realCanvas.toDataURL("image/png"));1===e.length?Ya(e[0],a):Xa(`${a}`,e)}else if(4===e){let e=[];for(let a=0;a<g.drawRecord.length;a++){for(let l=g.drawRecord[a].layer.length-1;l>=0;l--)g.drawRecord[a].layer[l].isRender&&(await m.handleExportLayer(a,l,!1,t,i),e.push(g.realCanvas.toDataURL("image/png")))}1===e.length?Ya(e[0],a):Xa(`${a}`,e)}else if(5===e){let e=[],l=new GIF({width:g.canvasWidth*t,height:g.canvasHeight*t,workerScript:"/js/gif-js/distt/gif.worker.js",workers:2,quality:10,transparent:0});g.realCanvas.width=g.canvasWidth*t,g.realCanvas.height=g.canvasHeight*t;for(let a=0;a<g.drawRecord.length;a++)await m.handleExportFrame(a,!1,t,g.exportStyleOptions,"gif"),e.push(g.realCanvas.toDataURL("image/png"));let n=[];for(let a=0;a<e.length;a++){const l=document.createElement("img");l.src=e[a],l.width=g.canvasWidth*t,l.height=g.canvasHeight*t;let r=new Promise(((e,a)=>{l.onload=function(){e(l)}}));n.push(r)}let r=0;await Promise.all(n).then((async()=>{for(let e=0;e<n.length;e++){let a=await n[e];l.addFrame(a,{delay:100*s}),r++}r>=n.length&&l.render()})),l.on("finished",(function(e){Ga(a,URL.createObjectURL(e)),l.abort()}))}else if(6===e){let e=0,l=[],n=[];const r=e=>new Promise(((a,t)=>{Ja(e).then((e=>{a(e)}))}));for(let a=0;a<g.drawRecord.length;a++){l[a]=[];let n=g.drawRecord[a].layer.length;e<n&&(e=n);let r=0;for(let e=n-1;e>=0;e--)await m.handleExportLayer(a,e,!1,t,g.exportStyleOptions,"gif"),l[a][r]=g.ctx3.getImageData(0,0,g.canvasWidth*t,g.canvasHeight*t),r++}for(let a=0;a<e;a++){let e=new GIF({width:g.canvasWidth*t,height:g.canvasHeight*t,workerScript:"/js/gif-js/distt/gif.worker.js",workers:2,quality:10,transparent:0});for(let n=0;n<l.length;n++)if(l[n][a]){let r=document.createElement("canvas");r.width=g.canvasWidth*t,r.height=g.canvasHeight*t,r.getContext("2d").putImageData(l[n][a],0,0),e.addFrame(r,{delay:100*s})}else;const i=await new Promise((a=>{e.on("finished",(function(t){a(t),e.abort()})),e.render()}));let o=await r(i);n.push(o)}await Promise.all(n).then((()=>{Xa(`${a}`,n,"gif")}))}else if(7===e)r.handlePixelToExcel(JSON.parse(JSON.stringify(g.drawRecord)),o({layerData:g.layerCrossList,canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight,filename:a},i),(e=>{l.$message.success(e)}),(e=>{l.$message.error(e)}));else if(8===e){let e=[];for(let a=0;a<g.drawRecord.length;a++)await m.handleExportFrameForPindou(a,!1,1,i,c),e.push(g.realCanvas.toDataURL("image/png"));1===e.length?Ya(e[0],`拼豆图-${a}`):Xa(`拼豆图-${a}`,e)}else if(9===e){let e=[];for(let a=0;a<g.drawRecord.length;a++)await m.handleExportFrameForBlock(a,!1,1,i,c),e.push(g.realCanvas.toDataURL("image/png"));1===e.length?Ya(e[0],`积木图-${a}`):Xa(`积木图-${a}`,e)}else if(10===e){if(!qa())return l.$message.warning("当前浏览器不支持该功能");try{let e=null,t=null,l=10*g.canvasWidth,n=10*g.canvasHeight;const r=async()=>{var l;await(null==t?void 0:t.flush()),e.finalize();let n=null==(l=e.target)?void 0:l.buffer,r=URL.createObjectURL(new Blob([n]));Ga(`${a}.mp4`,r),t=null,e=null};e=new Mp4Muxer.Muxer({target:new Mp4Muxer.ArrayBufferTarget,video:{codec:"avc",width:l,height:n,frameRate:d.videoSpeed},firstTimestampBehavior:"offset",fastStart:"in-memory"}),t=new VideoEncoder({output:(a,t)=>e.addVideoChunk(a,t),error:e=>{}}),t.configure({codec:"avc1.42001f",width:l,height:n,bitrate:1e6});let i=0;g.realCanvas.width=10*g.canvasWidth,g.realCanvas.height=10*g.canvasHeight;for(let a=0;a<g.drawRecord.length;a++){await m.handleExportFrame(a,!1,10,g.exportStyleOptions);let e=new VideoFrame(g.realCanvas,{timestamp:1e3*i/d.videoSpeed*1e3});i++,t.encode(e,{keyFrame:i%d.videoSpeed==0}),e.close(),i>=g.drawRecord.length&&r()}}catch(u){l.$message.error("当前画布过大，无法导出视频"),g.exportLoaidng=!1}}g.exportLoaidng=!1}},handleDeepCloneByWorker(e,a){g.loading=!0,g.worker.postMessage({type:104,variables:e}),g.worker.onmessage=e=>{104===e.data.type&&(a(e.data.variables),g.loading=!1)}},handleAddHistory(){for(g.historyRecord.length>=g.historyMaxLength&&g.historyRecord.shift();g.currentHistoryIndex<g.historyRecord.length-1;)g.historyRecord.pop();g.historyRecord.push({hid:Ia.v1(),record:JSON.parse(JSON.stringify(g.drawRecord))}),g.isSaveProject=!1,g.currentHistoryIndex=g.historyRecord.length-1,g.currentHistoryIndex<0&&(g.currentHistoryIndex=0)},async handleRevoke(){if(g.historyRecord.length){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");if(8!==g.currentTool)if(g.isScaling)m.handleCancelScale();else{if(g.currentHistoryIndex=g.currentHistoryIndex-1,g.currentHistoryIndex<0)return l.$message.warning("暂无更多记录"),void(g.currentHistoryIndex=0);g.drawRecord=JSON.parse(JSON.stringify(g.historyRecord[g.currentHistoryIndex].record));for(let e=0;e<g.drawRecord.length;e++)for(let a=0;a<g.drawRecord[e].layer.length;a++)await m.handleCreateLayerCrossData("update",g.drawRecord[e].layer[a]);m.reDraw(!0,!1)}else m.handleCancelSelect()}},async handleRecover(){if(g.historyRecord.length){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");if(8!==g.currentTool)if(g.isScaling)m.handleCancelScale();else{if(g.currentHistoryIndex=g.currentHistoryIndex+1,g.currentHistoryIndex>g.historyRecord.length-1)return l.$message.warning("暂无更多记录"),void(g.currentHistoryIndex=g.historyRecord.length-1);g.drawRecord=JSON.parse(JSON.stringify(g.historyRecord[g.currentHistoryIndex].record));for(let e=0;e<g.drawRecord.length;e++)for(let a=0;a<g.drawRecord[e].layer.length;a++)await m.handleCreateLayerCrossData("update",g.drawRecord[e].layer[a]);m.reDraw(!0,!1)}else m.handleCancelSelect()}},handleOpenMyColorDialog(){l.$refs.MyColorDialog.handleOpen(),m.handleCancelKeyboardEvent()},handleOpenReplaceColorDialog(){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");g.isScaling&&m.handleCancelScale(),l.$refs.ReplaceColorDialog.handleOpen(),m.handleCancelKeyboardEvent()},async handleOpenPreviewDialog(){if(g.pinDouMode)return l.$message.warning("请先退出拼豆预览模式");if(g.canvasHeight>512||g.canvasWidth>512)return l.$message.warning("当前画布尺寸过大，无法预览动画");g.previewLoading=!0;let e=Math.floor(512/Math.max(g.canvasHeight,g.canvasWidth));const a=await m.handleExport(1,"",e,!0);l.$refs.PreviewAnimDialog.handleOpen({imgUrl:a,width:g.canvasWidth*e,height:g.canvasHeight*e,frame:g.drawRecord.length}),g.previewLoading=!1},handleOpenMoveCanvas(){g.isSpace=!g.isSpace},handlekeyDownEvent(e){var a;if(l.$route.path.includes("/draw")){if(" "===e.key)return e.preventDefault(),void(g.isSpace=!0);if(e.shiftKey&&(g.isShift=!0),e.altKey&&(g.isAlt=!0),e.altKey&&"c"===e.key&&g.selectData.selectList.length)m.handleCopySelectData();else if(e.altKey&&"q"===e.key)e.preventDefault(),m.drawTransform("scale");else if(e.altKey&&"d"===e.key)e.preventDefault(),m.handleRemoveSelect();else if(e.altKey&&"n"===e.key)m.handleCancelSelect();else if((e.metaKey||e.ctrlKey)&&"z"===e.key)m.handleRevoke();else if((e.metaKey||e.ctrlKey)&&"x"===e.key)m.handleRecover();else if(e.altKey&&"j"===e.key)m.drawTransform("crop");else if((e.metaKey||e.ctrlKey)&&"s"===e.key)e.preventDefault(),m.handleSaveProject();else if((e.metaKey||e.ctrlKey)&&"p"===e.key)e.preventDefault(),m.handleExportDialog(!0);else if((e.metaKey||e.ctrlKey)&&"i"===e.key)e.preventDefault(),m.handleExportDialog(!1);else if(e.altKey&&"p"===e.key)m.handleOpenPreviewDialog();else if(e.altKey&&"f"===e.key)e.preventDefault(),m.handleScreenFull();else if(e.altKey&&"v"===e.key)m.handleResetCanvas();else if(e.altKey&&"a"===e.key)i.handleAdd(i.data.currentColorGroup);else if(e.altKey&&"g"===e.key)l.$refs.MyColorDialog.handleOpen();else if((e.metaKey||e.ctrlKey)&&"m"===e.key)e.preventDefault(),m.handleImportImage();else if((e.metaKey||e.ctrlKey)&&"g"===e.key)e.preventDefault(),m.handleImportImageForGif();else if((e.metaKey||e.ctrlKey)&&"c"===e.key)e.preventDefault(),i.handleCopyColor(g.brushColor);else if((e.metaKey||e.ctrlKey)&&e.altKey&&"t"===e.key)e.preventDefault(),m.handleAddLayer();else if((e.metaKey||e.ctrlKey)&&e.altKey&&"h"===e.key)e.preventDefault(),m.handleLayerMerge();else if((e.metaKey||e.ctrlKey)&&"ArrowUp"===e.key)e.preventDefault(),m.drawTransform("hReverse");else if((e.metaKey||e.ctrlKey)&&"ArrowDown"===e.key)e.preventDefault(),m.drawTransform("vReverse");else if((e.metaKey||e.ctrlKey)&&"ArrowLeft"===e.key)e.preventDefault(),m.drawTransform("rotate");else if((e.metaKey||e.ctrlKey)&&"ArrowRight"===e.key)e.preventDefault(),m.drawTransform("cReverse");else if((e.metaKey||e.ctrlKey)&&"="===e.key)e.preventDefault(),m.handleResizeCanvas(g.layerScaleStep);else if((e.metaKey||e.ctrlKey)&&"-"===e.key)e.preventDefault(),m.handleResizeCanvas(-g.layerScaleStep);else if((e.metaKey||e.ctrlKey)&&e.key);else if("q"===e.key)m.handleChangeTool(0);else if("w"===e.key)m.handleChangeTool(1);else if("e"===e.key)m.handleChangeTool(2);else if("r"===e.key)m.handleChangeTool(4);else if("t"===e.key)m.handleChangeTool(7);else if("y"===e.key)m.handleChangeTool(8),g.selectType="select";else if("p"===e.key)m.handleChangeTool(8),g.selectType="quickSelect";else if("j"===e.key)m.handleChangeTool(8),g.selectType="rangeSelect";else if("u"===e.key)m.handleOpenReplaceColorDialog();else if(e.altKey&&"s"===e.key)i.handleSaveColor(!0,g.brushColor);else if("i"===e.key)m.handleClearLayer("single");else if("o"===e.key)m.handlePindouMode("preview");else if("k"===e.key)m.handlePindouMode("draw");else if("l"===e.key)m.handleLinmoMode();else if("Delete"===e.key)m.handleClearLayer("all");else if("a"===e.key)m.handleChangeTool(3),m.drawShape("rect");else if("s"===e.key)m.handleChangeTool(3),m.drawShape("circle");else if("d"===e.key)m.handleChangeTool(3),m.handleChangeTool(3),m.drawShape("line");else if("f"===e.key)m.handleChangeTool(3),m.drawShape("fillRect");else if("g"===e.key)m.handleEyeDropper();else if("z"===e.key)g.linmoMode&&g.linmoPhoto&&(l.$refs.LinmoModeDialog.isLockCanvas=!l.$refs.LinmoModeDialog.isLockCanvas,m.handleLinmoFitCanvas(l.$refs.LinmoModeDialog.isLockCanvas));else if("x"===e.key)g.linmoMode&&g.linmoPhoto&&(l.$refs.LinmoModeDialog.zIndex=!l.$refs.LinmoModeDialog.zIndex,l.$refs.LinmoModeDialog.updatelinmoPhotoStyle());else if("v"===e.key)g.linmoMode&&g.linmoPhoto&&(l.$refs.LinmoModeDialog.display=!l.$refs.LinmoModeDialog.display,l.$refs.LinmoModeDialog.updatelinmoPhotoStyle());else if("c"===e.key)g.linmoMode&&(l.$refs.LinmoModeDialog.isPickingColor||(l.$refs.LinmoModeDialog.opacityHistoryRecord=l.$refs.LinmoModeDialog.opacity,l.$refs.LinmoModeDialog.zIndexHistoryRecord=l.$refs.LinmoModeDialog.zIndex,l.$refs.LinmoModeDialog.opacity=100,l.$refs.LinmoModeDialog.zIndex||(l.$refs.LinmoModeDialog.zIndex=!0),l.$refs.LinmoModeDialog.updatelinmoPhotoStyle(),l.$refs.LinmoModeDialog.isPickingColor=!0,setTimeout((()=>{var e;null==(e=document.querySelector(".EyeDropper-color-picker"))||e.click()}),500)));else if(e.altKey&&"ArrowUp"===e.key){if(g.isShift)return;g.currentLayerIndex--,g.currentLayerIndex<0&&(g.currentLayerIndex=0),g.selectLayerList=[g.currentLayerIndex]}else if(e.altKey&&"ArrowDown"===e.key){if(g.isShift)return;g.currentLayerIndex++,g.currentLayerIndex>g.drawRecord[g.currentFrameIndex].layer.length-1&&(g.currentLayerIndex=g.drawRecord[g.currentFrameIndex].layer.length-1),g.selectLayerList=[g.currentLayerIndex]}else if(e.altKey&&"ArrowLeft"===e.key){if(e.preventDefault(),g.currentFrameIndex--,g.currentFrameIndex<0)return void(g.currentFrameIndex=0);m.handleChangeFrame(g.currentFrameIndex)}else if(e.altKey&&"ArrowRight"===e.key){if(e.preventDefault(),g.currentFrameIndex++,g.currentFrameIndex>g.drawRecord.length-1)return void(g.currentFrameIndex=g.drawRecord.length-1);m.handleChangeFrame(g.currentFrameIndex)}else["1","2","3","4","5","6","7","8","9"].includes(e.key)?g.brushColor=(null==(a=h.settingsOption.colorKeyOptions.find((a=>a.key==e.key)))?void 0:a.color)||"#000000ff":"ArrowLeft"===e.key?(e.preventDefault(),g.menuType=0):"ArrowRight"===e.key&&(e.preventDefault(),g.menuType=1);g.canvas.className="",m.addCursorClass()}},handleKeyUpEvent(e){l.$route.path.includes("/draw")&&(" "===e.key&&(g.isSpace=!1,g.canvas.style.cursor=""),"Shift"===e.key&&(g.isShift=!1),"Alt"===e.key&&(g.isAlt=!1),"Escape"!==e.key&&"Esc"!==e.key||(l.$refs.LinmoModeDialog.isPickingColor=!1,l.$refs.LinmoModeDialog.zIndex&&(l.$refs.LinmoModeDialog.zIndex=l.$refs.LinmoModeDialog.zIndexHistoryRecord,l.$refs.LinmoModeDialog.opacity=l.$refs.LinmoModeDialog.opacityHistoryRecord,l.$refs.LinmoModeDialog.updatelinmoPhotoStyle())))},addKeyBoardEvent(){window.addEventListener("keydown",m.handlekeyDownEvent),window.addEventListener("keyup",m.handleKeyUpEvent)},handleResizeWindowEvent(e){m.handleCancelSelectMindObj(),m.handleCancelSelect(),m.computeScale(),g.canvasStyle.transform=`scale(${g.layerScale})`,g.canvasBeginPos.centerX=g.scale*g.canvasWidth/2,g.canvasBeginPos.centerY=g.scale*g.canvasHeight/2,m.drawPixelArea(!0),g.pinDouMode?m.handleDrawPindou(g.ctx1):g.isScaling||g.isControlMindObj?m.reDraw(!1,!1,!1):m.reDraw(!1,!1),g.linmoFitCanvasTimer&&clearTimeout(g.linmoFitCanvasTimer),g.linmoFitCanvasTimer=setTimeout((()=>{m.handleLinmoFitCanvas(),m.handleDrawReferenceLine(),m.handleScaleFrame1(),m.handleInitAxisOffset()}),250)},handleResizeWindow(){window.addEventListener("resize",m.handleResizeWindowEvent)},onDragLayerEnd(e,a){let t=l.$refs[a],n=Array.from(t.children),r=[],i=g.drawRecord[g.currentFrameIndex].layer;for(let l=0;l<n.length;l++){let e=n[l].dataset.key,a=i.find((a=>a.layerId===e));r.push(a)}g.drawRecord[g.currentFrameIndex].layer=r,m.reDraw()},onDragFrameEnd(e,a){let t=l.$refs[a],n=Array.from(t.children),r=[],i=g.drawRecord;for(let l=0;l<n.length-1;l++){let e=n[l].dataset.key,a=i.find((a=>a.frameId===e));r.push(a)}g.drawRecord=r,m.handleChangeFrame(g.currentFrameIndex)},handleCopySelectData(){if(8===g.currentTool){if($a(g.selectData.selectCanvasObj.canvas,g.selectData.selectCanvasObj.ctx))return l.$message.warning("选择区域为空");g.selectData.isCopySelect=!0,l.$message.success("已复制选区，可拖拽移动复制选区")}},handleFilter(e,a=0){g.isScaling&&m.handleCancelScale(),g.loading=!0;const t=e=>{e&&(g.loading=!1,g.layerCrossList[m.getCurrentLayerId()].layerCtx.putImageData(e,0,0),m.reDraw())};8===g.currentTool?n.handleFilter(e,{layerCanvas:g.selectData.selectCanvasObj.canvas,layerCtx:g.selectData.selectCanvasObj.ctx},(e=>{g.loading=!1,g.selectData.selectCanvasObj.ctx.putImageData(e,0,0),m.reDraw(!1),g.ctx1.drawImage(g.selectData.selectCanvasObj.canvas,0,0),g.ctx1.drawImage(g.selectData.selectCanvasObj.selectCanvas,0,0)}),a):g.isControlMindObj?n.handleFilter(e,{layerCanvas:g.scaleCanvas,layerCtx:g.ctx5},(e=>{g.loading=!1,g.ctx5.putImageData(e,0,0)}),a):n.handleFilter(e,g.layerCrossList[m.getCurrentLayerId()],t,a)},handleExpand(){g.isExpandColorSelector=!g.isExpandColorSelector;let e=document.querySelector(".colorSelector"),a=document.querySelector(".back-icon");g.isExpandColorSelector?(e.style.transform="translateX(0)",a.children[0].style.transform="rotate(0deg)"):(e.style.transform="translateX(100%)",a.children[0].style.transform="rotate(180deg)")},handleTransformColorAsHex(e){let a=e;return Za(a)&&9===a.length?e:Za(a)&&7===a.length?a+"ff":Za(a)?ia(ra(a)):ia(sa(a))},handleConfirmReplaceColor(e,a){let t=Aa(e.replaceColor),l=Aa(e.newColor);if(1===e.type){const e=g.layerCrossList[m.getCurrentLayerId()].layerData;for(let n=0;n<e.length;n+=4){let[a,r,i,o]=[e[n],e[n+1],e[n+2],e[n+3]];0!==o&&(t[0]===a&&t[1]===r&&t[2]===i&&255*t[3]===o&&(e[n]=l[0],e[n+1]=l[1],e[n+2]=l[2],e[n+3]=255*l[3]))}const a=new ImageData(e,g.canvasWidth,g.canvasHeight);g.layerCrossList[m.getCurrentLayerId()].layerCtx.putImageData(a,0,0)}else if(2===e.type)for(let n=0;n<g.drawRecord[g.currentFrameIndex].layer.length;n++){let e=g.drawRecord[g.currentFrameIndex].layer[n].layerId;const a=g.layerCrossList[e].layerData;for(let n=0;n<a.length;n+=4){let[e,r,i,o]=[a[n],a[n+1],a[n+2],a[n+3]];0!==o&&(t[0]===e&&t[1]===r&&t[2]===i&&255*t[3]===o&&(a[n]=l[0],a[n+1]=l[1],a[n+2]=l[2],a[n+3]=255*l[3]))}const r=new ImageData(a,g.canvasWidth,g.canvasHeight);g.layerCrossList[m.getCurrentLayerId()].layerCtx.putImageData(r,0,0)}a(),m.reDraw()},handleResetCanvas(){g.pindouScaleValue=1,m.handleResizeWindowEvent("")},handleInitData(){g.isPreview?g.currentTool=-1:g.currentTool=0,g.historyRecord=[],g.currentFrameIndex=0,g.currentLayerIndex=0,g.currentFrameId="0",g.currentLayerId="0",g.shapeFillColor="#000000ff",g.brushColor="#000000ff",g.isCheckedRatio=!0,g.isShowReferenceLine=!1,g.isShowRuler=!1,g.isShowGridLine=!1,g.isVertical=!1,g.isHorizontal=!1,g.isCenter=!1,g.brushSize=1,g.eraserSize=1,g.widthHeightRatio=1,g.tolerance=0,g.selectType="select",g.currentDrawShape="rect",g.currentDrawTransform="hReverse",g.projectData=ma(),g.pinDouMode=!1,g.pinDouDrawMode=!1,g.selectLayerList=[g.currentLayerIndex],g.pindouHighlight=null,g.pindouBrand=h.settingsOption.defaultPindou,g.isHidePindouMode=!1,g.isScaling=!1,g.scaleWhitePointPos=[],g.scaleAreaData=null,g.scaleRatio=0,g.colorStatList=[],g.layerAlpha=100,g.isHideLinmoMode=!1,g.linmoMode=!1,g.linmoPhoto=null,g.currentHistoryIndex=0,g.canvasStyle={transform:"scale(1)",transformOrigin:"center center"},g.linmoPhotoStyle={width:"200px",height:"200px",transform:"translate3d(0px, 0px, 10px) rotate(0deg) scale(1, 1)",opacity:1,zIndex:0,display:"none",transformOrigin:"center center"},g.pindouScaleValue=1,g.isSpace=!1,g.searchColorValue="",g.searchColorList=[],g.drawAreaGridCanvas=null,g.layerGridImage=null,g.isPreview?g.menuType=1:g.menuType=0,g.layerScale=1,g.layerCrossList={},g.currentSelectMindId="0",g.isEnableCanvasGrid=!1,g.layerScaleStep=.5,g.isEnableCanvasSmooth=!1,g.scaleStyle={width:"0px",height:"0px",left:"0px",top:"0px"},g.resizeStyle={width:"0px",height:"0px",left:"0px",top:"0px"},g.resizeData={startX:0,startY:0,direction:""},g.scaleImg="",g.isControlMindObj=!1,g.mobileStartDistance=null,g.pindouBlockList=[],g.currentPindouIndex=0,g.pindouBlockHeight=64,g.pindouBlockWidth=64,g.currentPindouBlockSize=64,g.isShowPindouGridLine=!1,g.isShowPindouReferenceLine=!1,g.isShowPindouRuler=!1,g.isUpdateAllBlock=!1,g.previewLoading=!1,g.selectData.selectCanvasObj=null},handleInitEmptyLayer(){g.emptyLayerData=[];for(let e=0;e<g.canvasHeight;e++)for(let a=0;a<g.canvasWidth;a++)g.emptyLayerData.push([a,e,g.emptyColor])},handleInitAxisOffset(){let e=g.canvas.getBoundingClientRect().left-g.baseCanvas.getBoundingClientRect().left,a=g.canvas.getBoundingClientRect().top-g.baseCanvas.getBoundingClientRect().top;g.XLineOffset=Math.floor(g.canvasWidth*g.layerScale/2)-2,g.axisXStyle.left=`${Math.floor(e+g.XLineOffset)}px`,g.YLineOffset=Math.floor(g.canvasHeight*g.layerScale/2)-2,g.axisYStyle.top=`${Math.floor(a+g.YLineOffset)}px`,g.CenterLineOffset=Math.floor(g.canvasWidth*g.layerScale/2)-2,g.axisCStyle.left=`${Math.floor(e+g.CenterLineOffset)}px`},handleCheckAxisOffset(){let e=g.canvas.getBoundingClientRect().left-g.baseCanvas.getBoundingClientRect().left,a=g.canvas.getBoundingClientRect().top-g.baseCanvas.getBoundingClientRect().top;g.isHorizontal&&(g.XLineOffset>=g.canvas.getBoundingClientRect().width?g.XLineOffset=Math.floor(g.canvas.getBoundingClientRect().width):g.XLineOffset<0&&(g.XLineOffset=0),g.axisXStyle.left=`${Math.floor(e+g.XLineOffset)}px`),g.isVertical&&(g.YLineOffset>=g.canvas.getBoundingClientRect().height?g.YLineOffset=Math.floor(g.canvas.getBoundingClientRect().height):g.YLineOffset<0&&(g.YLineOffset=0),g.axisYStyle.top=`${Math.floor(a+g.YLineOffset)}px`),g.isCenter&&(g.CenterLineOffset>=g.canvas.getBoundingClientRect().width?g.CenterLineOffset=Math.floor(g.canvas.getBoundingClientRect().width):g.CenterLineOffset<0&&(g.CenterLineOffset=0),g.axisCStyle.left=`${Math.floor(e+g.CenterLineOffset)}px`)},handleResizeStyle(){let e=g.canvas.getBoundingClientRect().left-g.baseCanvas.getBoundingClientRect().left,a=g.canvas.getBoundingClientRect().top-g.baseCanvas.getBoundingClientRect().top,t=parseFloat(g.scaleStyle.left)*g.layerScale,l=parseFloat(g.scaleStyle.top)*g.layerScale;g.resizeStyle.left=`${e+t}px`,g.resizeStyle.top=`${a+l}px`},setCanvasCenter(){let e=g.baseCanvas.width/2-g.canvas.width/2,a=g.baseCanvas.height/2-g.canvas.height/2;g.canvas.style.left=`${e}px`,g.canvas.style.top=`${a}px`,g.scaleBoxDom.style.left=`${e}px`,g.scaleBoxDom.style.top=`${a}px`,g.bgCanvas.style.left=`${e}px`,g.bgCanvas.style.top=`${a}px`,m.handleResizeStyle()},async handleReadProjectData(){let e=l.$route.params.projectId.slice(0,1),a=l.$route.params.projectId.split(e),t=a[a.length-1],n=null;if("B"===e)g.isPreview=!1,h.localProjectList.length&&(n=JSON.parse(JSON.stringify(h.localProjectList.find((e=>e.id===t)).data)));else if("A"===e)g.isPreview=!1,n=JSON.parse(JSON.stringify(h.getProjectById(t)));else{if("C"===e){if(t===g.projectData.projectId)return;return m.handlePreviewPorject(t),void(g.sharePermission="1")}if("D"===e){if(t===g.projectData.projectId)return;return void m.handlePreviewSharePorject(t)}}m.handleProjectData(n,e)},async handleProjectData(e,a){if(e){let n=h.currentProjectId.split(a);if(n[n.length-1]!==e.projectId)if(m.handleInitData(),g.drawRecord=[],g.loading=!0,g.projectData=e,g.projectData.projectId=e.projectId,g.projectData.projectName=e.projectName,g.projectData.updateAt=e.updateAt,g.projectData.createAt=e.createAt,g.projectData.desc=e.desc,g.canvasWidth=Number(e.width),g.canvasHeight=Number(e.height),g.projectData.frameImg=e.frameImg,g.projectData.tip=e.tip,g.projectData.isTop=e.isTop,g.projectData.isLargeCanvas=e.isLargeCanvas,g.projectData.isLocalFile=e.isLocalFile,g.projectData.data=e.data,i.getMyColorList(),g.baseCanvas=document.getElementById("BaseCanvas"),g.canvas=document.getElementById("Canvas"),g.bgCanvas=document.getElementById("PixelCanvas"),g.realCanvas=document.createElement("canvas"),g.gridCanvas=document.getElementById("GridCanvas"),g.scaleCanvas=document.getElementById("scale-canvas"),g.scaleBoxDom=document.querySelector(".ScaleBox"),m.computeScale(),g.ctx0=g.baseCanvas.getContext("2d"),g.ctx1=g.canvas.getContext("2d"),g.ctx2=g.bgCanvas.getContext("2d"),g.ctx3=g.realCanvas.getContext("2d"),g.ctx4=g.gridCanvas.getContext("2d"),g.ctx5=g.scaleCanvas.getContext("2d"),g.ctx1.lineCap="square",g.ctx1.save(),g.canvasBeginPos.centerX=g.canvasBeginPos.x+g.scale*g.canvasWidth/2,g.canvasBeginPos.centerY=g.canvasBeginPos.y+g.scale*g.canvasHeight/2,g.canvasHeight<100&&g.canvasWidth<100&&(g.isEnableCanvasGrid=!0),m.drawPixelArea(!0),m.startDrawing(),!g.isPreview&&m.addKeyBoardEvent(),m.handleResizeWindow(),m.handleSetCanvasScale(),ba((()=>m.handleInitAxisOffset())),g.projectData.data)try{for(let a=0;a<g.projectData.data.length;a++){let t=await Qa(g.projectData.data[a].currentFrameImg);g.projectData.data[a].currentFrameImg=t;for(let l=0;l<g.projectData.data[a].layer.length;l++){let t=await Qa(g.projectData.data[a].layer[l].currentLayerImg);g.projectData.data[a].layer[l].currentLayerImg=t,g.projectData.data[a].layer[l].mindLayerList||(g.projectData.data[a].layer[l].mindLayerList=[]);for(let e=0;e<g.projectData.data[a].layer[l].mindLayerList.length;e++){g.projectData.data[a].layer[l].mindLayerList[e].mindObj=await Qa(g.projectData.data[a].layer[l].mindLayerList[e].mindObj),g.projectData.data[a].layer[l].mindLayerList[e].mindCanvas=document.createElement("canvas"),g.projectData.data[a].layer[l].mindLayerList[e].mindCanvas.width=g.projectData.data[a].layer[l].mindLayerList[e].width,g.projectData.data[a].layer[l].mindLayerList[e].mindCanvas.height=g.projectData.data[a].layer[l].mindLayerList[e].height,g.projectData.data[a].layer[l].mindLayerList[e].mindCtx=g.projectData.data[a].layer[l].mindLayerList[e].mindCanvas.getContext("2d");const t=await createImageBitmap(_a(g.projectData.data[a].layer[l].mindLayerList[e].mindObj));g.projectData.data[a].layer[l].mindLayerList[e].mindCtx.drawImage(t,0,0)}await m.handleCreateLayerCrossData("update",e.data[a].layer[l]),g.projectData.data[a].layer[l].mindLayerList=g.projectData.data[a].layer[l].mindLayerList.map((e=>e.mindId))}}g.drawRecord=g.projectData.data,h.saveProjectId(g.projectData.projectId,a),m.handleChangeLayer(g.currentLayerIndex),m.reDraw(),g.loading=!1,ba((()=>{m.handleLayerAndFrameHighRender()}))}catch(t){l.$message.error("项目异常，无法打开"),h.saveProjectId("0"),l.$router.replace("/project")}else h.saveProjectId(g.projectData.projectId,a),g.drawRecord=[],m.initCanvasRecord("init"),g.loading=!1}else l.$message.error("项目不存在"),h.saveProjectId("0"),l.$router.replace("/project")},handlePreviewSharePorject(e){const a=async a=>{let t=await rt(a);t?(t.projectId="D"+e,m.handleProjectData(t,"D")):(l.$message.error("分享项目不存在"),h.saveProjectId("0"),l.$router.replace("/about"))};g.isPreview=!0,g.loading=!0,g.canvas&&g.ctx1.clearRect(0,0,g.canvasWidth,g.canvasHeight),g.drawRecord=[],g.projectData.projectName="";const t=l.$bmob.Query("Share");t.equalTo("projectId","==",e),t.limit(1),t.find().then((e=>{if(e.results.length){let t=e.results[0];if(et(t.exp,t.updatedAt,6e4))l.$message.error("分享项目已过期"),h.saveProjectId("0"),l.$router.replace("/about");else if(g.sharePermission=t.permission,""!==t.password){if(location.search.includes("pwd")){if(location.search.split("pwd=")[1]===t.password)return void a(t.url)}Sa.prompt("请输入访问密码","验证密码",{confirmButtonText:"确 认",cancelButtonText:"取 消",showClose:!1,showCancelButton:!1,closeOnClickModal:!1,closeOnPressEscape:!1,beforeClose:(e,n,r)=>{if("confirm"===e){if(""===n.inputValue||!n.inputValue)return l.$message.warning("请输入密码");if(n.inputValue===t.password)return a(t.url),void r();l.$message.warning("密码错误！")}else r()}}).then((async({value:e})=>{})).catch((e=>{l.$message.error("访问失败"),h.saveProjectId("0"),l.$router.replace("/about")}))}else a(t.url)}else l.$message.error("分享项目不存在"),h.saveProjectId("0"),l.$router.replace("/about")})).catch((e=>{l.$message.error("分享项目不存在"),h.saveProjectId("0"),l.$router.replace("/about")}))},handlePreviewPorject(e){g.isPreview=!0,g.loading=!0,g.canvas&&g.ctx1.clearRect(0,0,g.canvasWidth,g.canvasHeight),g.drawRecord=[],g.projectData.projectName="",at(`${e}.json`,(async a=>{let t=await rt(a);t?(t.projectId="C"+e,m.handleProjectData(t,"C")):(l.$message.error("项目不存在"),h.saveProjectId("0"),l.$router.replace("/module"))}),(e=>{l.$message.error(e),h.saveProjectId("0"),l.$router.replace("/module")}))},handleCancelKeyboardEvent(){window.removeEventListener("keydown",m.handlekeyDownEvent),window.removeEventListener("keyup",m.handleKeyUpEvent)},handleExportDialog(e,a="",t=-1){g.exportVisible=!0,g.isExportProject=e,g.exportSingleImage=a,g.exportSingleImageIndex=t,m.handleCancelKeyboardEvent()},handleImportImage(){g.importLayerVisible=!0,m.handleCancelKeyboardEvent()},handleImportImageForGif(){8===g.currentTool&&m.handleCancelSelect(),g.isScaling&&m.handleCancelScale();const e=document.createElement("input");e.type="file",e.accept="image/gif",e.addEventListener("change",(async function(){const a=e.files[0];if(a){if(await tt(a)){const e=new FileReader;e.onload=function(e){const a=new Uint8Array(e.target.result);lt("local",a).then((e=>{(null==e?void 0:e.list.length)&&Sa.confirm("导入的图像将覆盖每个帧的第一个图层，是否覆盖？","提 示",{confirmButtonText:"确 认",cancelButtonText:"取 消",type:"warning"}).then((()=>{m.handleImportGifImage(e.list)})).catch((()=>{}))})).catch((e=>{l.$message.error(e)}))},e.readAsArrayBuffer(a)}else l.$message.warning("导入文件格式不正确")}})),document.body.appendChild(e),e.click(),document.body.removeChild(e)},async handleImportGifImage(e){var a,t,n;const r=document.createElement("canvas"),i=r.getContext("2d");for(let o=0;o<e.length;o++)if(null==(a=g.drawRecord[o])?void 0:a.layer)if(g.layerCrossList[g.drawRecord[o].layer[0].layerId].layerCtx.drawImage(e[o].image,0,0),o===g.currentFrameIndex)m.reDraw(!0,!1);else{r.width=g.canvasWidth,r.height=g.canvasHeight;let e=null==(t=g.drawRecord[o])?void 0:t.layer;for(let a=e.length-1;a>=0;a--)if(e[a].isRender){let t=e[a].layerId;i.drawImage(g.layerCrossList[t].layerCanvas,0,0);for(let l=0;l<e[a].mindLayerList.length;l++){let n=g.layerCrossList[t].mindLayerList[e[a].mindLayerList[l]];n.isHide||i.drawImage(n.mindCanvas,n.left,n.top)}}g.drawRecord[o].currentFrameImg=r.toDataURL(g.exportFormat,1)}else{if(g.drawRecord.length+1>=g.maxFrame){l.$message.warning("帧数量达到上限");break}await m.handleAddFrame(!1),g.layerCrossList[g.drawRecord[o].layer[0].layerId].layerCtx.drawImage(e[o].image,0,0),r.width=g.canvasWidth,r.height=g.canvasHeight;let a=null==(n=g.drawRecord[o])?void 0:n.layer;for(let e=a.length-1;e>=0;e--)if(a[e].isRender){let t=a[e].layerId;i.drawImage(g.layerCrossList[t].layerCanvas,0,0);for(let l=0;l<a[e].mindLayerList.length;l++){let n=g.layerCrossList[t].mindLayerList[a[e].mindLayerList[l]];n.isHide||i.drawImage(n.mindCanvas,n.left,n.top)}}g.drawRecord[o].currentFrameImg=r.toDataURL(g.exportFormat,1)}m.handleAddHistory()},handleCloseDialog(e){g[e]=!1,m.addKeyBoardEvent()},closeMenu(){g.LayerMenu.visible=!1,g.MyColorMenu.visible=!1},handleMenu(e,a,t){g.pinDouMode||(m.closeMenu(),setTimeout((()=>{g[a].visible=!0,g[a].left=e.pageX,g[a].top=e.pageY,g[a].contextData=JSON.parse(JSON.stringify(t)),"LayerMenu"===a&&m.handleChangeLayer(t.index)}),100))},preventDefaults(e){e.preventDefault(),e.stopPropagation()},handleDragZoneEvent(){const e=document.getElementById("dropZone");["dragenter","dragover","dragleave","drop"].forEach((a=>{e.addEventListener(a,m.preventDefaults,!1),document.body.addEventListener(a,m.preventDefaults,!1)})),e.addEventListener("drop",m.handleDrop,!1)},handleDrop(e){if(g.isPreview)return;const a=e.dataTransfer.files[0];m.handleImportDragImage(a)},handleMobileScaleCanvasDown(e){e.preventDefault(),e.clientX=e.touches[0].clientX,e.clientY=e.touches[0].clientY,g.isMoving=!0,g.moveData.x=e.clientX,g.moveData.y=e.clientY,document.addEventListener("touchmove",m.handleMobileScaleCanvasMove),document.addEventListener("touchend",m.handleMobileScaleCanvasUp)},handleMobileScaleCanvasUp(e){g.isMoving=!1,document.removeEventListener("touchmove",m.handleMobileScaleCanvasMove),document.removeEventListener("touchend",m.handleMobileScaleCanvasUp)},handleMobileScaleCanvasMove(e){e.preventDefault(),e.clientX=e.touches[0].clientX,e.clientY=e.touches[0].clientY,m.handleScaleCanvasMove(e)},handleScaleCanvasDown(e){g.isMoving=!0,g.moveData.x=e.clientX,g.moveData.y=e.clientY,document.addEventListener("mousemove",m.handleScaleCanvasMove),document.addEventListener("mouseup",m.handleScaleCanvasUp)},handleScaleCanvasUp(){g.isMoving=!1,document.removeEventListener("mousemove",m.handleScaleCanvasMove),document.removeEventListener("mouseup",m.handleScaleCanvasUp)},handleScaleCanvasMove(e){if(!g.isMoving)return;const a=(e.clientX-g.moveData.x)/g.layerScale,t=(e.clientY-g.moveData.y)/g.layerScale;let l=parseFloat(g.scaleStyle.left),n=parseFloat(g.scaleStyle.top);l+=a,n+=t,g.scaleStyle.left=l+"px",g.scaleStyle.top=n+"px",m.handleResizeStyle(),g.moveData.x=e.clientX,g.moveData.y=e.clientY},mobileStartResize(e){e.stopPropagation(),g.isScale=!0;const a=e.target;g.resizeData.direction=a.className.split(" ")[1],g.resizeData.startX=e.touches[0].clientX,g.resizeData.startY=e.touches[0].clientY,document.addEventListener("touchmove",m.mobileResize),document.addEventListener("touchend",m.mobileStopResize)},mobileStopResize(){g.isScale=!1,document.removeEventListener("touchmove",m.mobileResize),document.removeEventListener("touchend",m.mobileStopResize)},mobileResize(e){e.preventDefault(),e.clientX=e.touches[0].clientX,e.clientY=e.touches[0].clientY,m.resize(e)},stopResize(){g.isScale=!1,document.removeEventListener("mousemove",m.resize),document.removeEventListener("mouseup",m.stopResize)},startResize(e){e.stopPropagation(),g.isScale=!0;const a=e.target;g.resizeData.direction=a.className.split(" ")[1],g.resizeData.startX=e.clientX,g.resizeData.startY=e.clientY,document.addEventListener("mousemove",m.resize),document.addEventListener("mouseup",m.stopResize)},resize(e){if(!g.isScale)return;let a=(e.clientX-g.resizeData.startX)/g.layerScale,t=(e.clientY-g.resizeData.startY)/g.layerScale;g.isAlt&&(a>t?t=a:a<t&&(a=t));let l=parseFloat(g.scaleStyle.width),n=parseFloat(g.scaleStyle.height),r=parseFloat(g.scaleStyle.left),i=parseFloat(g.scaleStyle.top),o=parseFloat(g.resizeStyle.width),s=parseFloat(g.resizeStyle.height),c=parseFloat(g.resizeStyle.left),d=parseFloat(g.resizeStyle.top);if(g.resizeData.direction.includes("left")&&(l-=a,r+=a,o-=a*g.layerScale,c+=a*g.layerScale),g.resizeData.direction.includes("right")&&(l+=a,o+=a*g.layerScale),g.resizeData.direction.includes("top")&&(n-=t,i+=t,s-=t*g.layerScale,d+=t*g.layerScale),g.resizeData.direction.includes("bottom")&&(n+=t,s+=t*g.layerScale),g.resizeData.startX=e.clientX,g.resizeData.startY=e.clientY,l<=1||n<=1)return;g.scaleStyle.width=l+"px",g.scaleStyle.height=n+"px",g.scaleStyle.left=r+"px",g.scaleStyle.top=i+"px",g.resizeStyle.width=o+"px",g.resizeStyle.height=s+"px",g.resizeStyle.left=c+"px",g.resizeStyle.top=d+"px";const h=parseInt(g.scaleStyle.width),u=parseInt(g.scaleStyle.height);g.scaleCanvas.width=h,g.scaleCanvas.height=u,g.ctx5.imageSmoothingEnabled=!1,g.ctx5.imageSmoothingQuality="none",g.ctx5.drawImage(g.scaleBoxDom.children[0].children[0],0,0,h,u)},handleChangeMenuType(e){if(g.brushColorVisible)return g.brushColorVisible=!1,void setTimeout((()=>{g.menuType=e}),300);g.menuType=e},handleSaveSpriteForSelect(){if($a(g.selectData.selectCanvasObj.canvas,g.selectData.selectCanvasObj.ctx))return l.$message.warning("选择区域为空");let e=nt(g.selectData.selectCanvasObj.canvas).toDataURL(g.exportFormat,1),a=Ia.v4();h.saveSprite({spriteID:a,spriteImg:e}).then((e=>{e&&l.$message.success(l.$t("message.saveSucceeded"))})).catch((e=>{l.$message.error(l.$t("message.saveFailed"))}))},async handleSaveMindForSelect(){if($a(g.selectData.selectCanvasObj.canvas,g.selectData.selectCanvasObj.ctx))return l.$message.warning("选择区域为空");let e=m.getCurrentLayerId();const a=nt(g.selectData.selectCanvasObj.canvas);let t=a.toDataURL(g.exportFormat,1);g.loading=!0;let n=Ia.v1();g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].mindLayerList.push(n),g.layerCrossList[e].mindLayerList[n]={mindId:n,mindObj:t,mindCanvas:a,mindCtx:a.getContext("2d"),isLock:!0,isHide:!1,width:a.width,height:a.height,left:0,top:0,mindName:`智能对象${Object.keys(g.layerCrossList[e].mindLayerList).length+1}`},g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isExpandMindList=!0,m.handleRemoveSelect(),m.handleChangeTool(0),m.reDraw(),g.loading=!1},async handleSaveMind(){let e=g.layerCrossList[m.getCurrentLayerId()];if($a(e.layerCanvas,e.layerCtx))return l.$message.warning("画布为空");let a=JSON.parse(JSON.stringify(g.drawRecord[g.LayerMenu.contextData.currentFrameIndex].layer[g.LayerMenu.contextData.index].currentLayerImg)),t=m.getCurrentLayerId(),n=document.createElement("canvas"),r=n.getContext("2d");n.width=g.canvasWidth,n.height=g.canvasHeight;let i=e.layerCtx.getImageData(0,0,g.canvasWidth,g.canvasHeight);null==r||r.putImageData(i,0,0),g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].currentLayerImg="",await m.handleCreateLayerCrossData("update",g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex]),g.loading=!0;let o=Ia.v1();g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].mindLayerList.push(o),g.layerCrossList[t].mindLayerList[o]={mindId:o,mindObj:a,mindCanvas:n,mindCtx:r,isLock:!0,isHide:!1,width:g.canvasWidth,height:g.canvasHeight,left:0,top:0,mindName:`智能对象${Object.keys(g.layerCrossList[t].mindLayerList).length+1}`},g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isExpandMindList=!0,m.reDraw(),g.loading=!1},handleSaveSprite(){let e=g.drawRecord[g.LayerMenu.contextData.currentFrameIndex].layer[g.LayerMenu.contextData.index].currentLayerImg,a=Ia.v4();h.saveSprite({spriteID:a,spriteImg:e}).then((e=>{e&&l.$message.success(l.$t("message.saveSucceeded"))})).catch((e=>{l.$message.error(l.$t("message.saveFailed"))}))},handleIntelligentStroke(e){let a=ra(e.strokeColor),t=g.layerCrossList[m.getCurrentLayerId()];if($a(t.layerCanvas,t.layerCtx))return l.$message.warning("画布为空");g.loading=!0;let n=t.layerCtx.getImageData(0,0,g.canvasWidth,g.canvasHeight);const r=n.data;for(let l=0;l<g.canvasWidth;l++)for(let e=0;e<g.canvasHeight;e++){let n=4*(l+e*g.canvasWidth);if(0!==t.layerData[n+3]){if(l>0){let e=n-4;0===r[e+3]&&(r[e]=a[0],r[e+1]=a[1],r[e+2]=a[2],r[e+3]=255)}if(l<g.canvasWidth-1){let e=n+4;0===r[e+3]&&(r[e]=a[0],r[e+1]=a[1],r[e+2]=a[2],r[e+3]=255)}if(e>0){let e=n-4*g.canvasWidth;0===r[e+3]&&(r[e]=a[0],r[e+1]=a[1],r[e+2]=a[2],r[e+3]=255)}if(e<g.canvasHeight-1){let e=n+4*g.canvasWidth;0===r[e+3]&&(r[e]=a[0],r[e+1]=a[1],r[e+2]=a[2],r[e+3]=255)}}}g.layerCrossList[m.getCurrentLayerId()].layerCtx.putImageData(n,0,0),m.reDraw(),g.loading=!1},handleXYLineMobileDown(e){e.preventDefault();let a=e.target.className.split(" ")[0];g.isMovingLine=!0;let t=e.touches[0].clientX,l=e.touches[0].clientY;const n=e=>{if(g.isMovingLine){e.preventDefault(),e.stopPropagation();const n=e.touches[0].clientX-t,r=e.touches[0].clientY-l;a.includes("Y")?g.YLineOffset+=r:g.XLineOffset+=n,m.handleCheckAxisOffset(),t=e.touches[0].clientX,l=e.touches[0].clientY}},r=()=>{g.isMovingLine=!1,document.removeEventListener("touchmove",n),document.removeEventListener("touchend",r)};document.addEventListener("touchmove",n),document.addEventListener("touchend",r)},handleXYLineMouseDown(e){e.stopPropagation();let a=e.target.className.split(" ")[0];g.isMovingLine=!0;let t=e.clientX,l=e.clientY;const n=e=>{if(g.isMovingLine){const n=e.clientX-t,r=e.clientY-l;a.includes("Y")?g.YLineOffset+=r:g.XLineOffset+=n,m.handleCheckAxisOffset(),t=e.clientX,l=e.clientY}},r=()=>{g.isMovingLine=!1,document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)},handleIntelligentCrop(){if($a(g.canvas,g.ctx1))return l.$message.warning("选择区域为空");g.loading=!0;let e=g.layerCrossList[m.getCurrentLayerId()].layerCtx.getImageData(0,0,g.canvasWidth,g.canvasHeight),a=null==e?void 0:e.data,t=1/0,n=1/0,r=-1/0,i=-1/0;for(let l=0;l<g.canvasHeight;l++)for(let e=0;e<g.canvasWidth;e++){a[4*(l*g.canvasWidth+e)+3]>0&&(e<t&&(t=e),e>r&&(r=e),l<n&&(n=l),l>i&&(i=l))}const o=Math.floor(r-t)+1,s=Math.floor(i-n)+1;if(o<=0||s<=0)return g.loading=!1;for(let l=0;l<g.drawRecord.length;l++)for(let e=0;e<g.drawRecord[l].layer.length;e++){let a=g.drawRecord[l].layer[e];const r=g.layerCrossList[a.layerId].layerCtx.getImageData(t,n,o,s);g.layerCrossList[a.layerId].layerCanvas.width=o,g.layerCrossList[a.layerId].layerCanvas.height=s,g.layerCrossList[a.layerId].layerCtx.putImageData(r,0,0)}g.canvasWidth=o,g.canvasHeight=s,(g.canvasHeight>100||g.canvasWidth>100)&&(g.isEnableCanvasGrid=!1),m.computeScale(),g.canvasBeginPos.centerX=g.canvasBeginPos.x+g.scale*g.canvasWidth/2,g.canvasBeginPos.centerY=g.canvasBeginPos.y+g.scale*g.canvasHeight/2,m.drawPixelArea(!0),m.handleSetCanvasScale(),m.reDraw(),m.handleLayerAndFrameHighRender(),g.loading=!1},handleIntelligentStrokeVisible(){l.$refs.IntelligentStrokeDialog.handleOpen(),m.handleCancelKeyboardEvent()},handleIntelligentSliceVisible(){g.intelligentSliceVisible=!0,g.intelligentSliceOptions={canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight},l.$refs.IntelligentSliceDialog.handleOpen(),l.$refs.IntelligentSliceDialog.handleChange(),m.handleCancelKeyboardEvent()},handleCloseIntelligentSlice(){g.intelligentSliceVisible=!1,m.addKeyBoardEvent()},handleExportIntelligentSlice(e,a){let t=[];const l=Math.ceil(g.canvasWidth/e.hCount),n=Math.ceil(g.canvasHeight/e.vCount);for(let r=0;r<n;r++)for(let a=0;a<l;a++){const l=Math.min(e.hCount,g.canvasWidth-a*e.hCount),n=Math.min(e.vCount,g.canvasHeight-r*e.vCount),i=document.createElement("canvas"),o=i.getContext("2d");i.width=l,i.height=n,o.drawImage(g.canvas,a*e.hCount,r*e.vCount,l,n,0,0,l,n),t.push(i.toDataURL("image/png"))}Xa(`${g.projectData.projectName}_切片`,t),a()},handleIntelligentSlice(e){if(!e)return;g.gridLineTimer&&clearTimeout(g.gridLineTimer);let a=g.layerScale,t=g.canvasWidth*a,l=g.canvasHeight*a;g.ctx4.clearRect(0,0,t,l),g.gridCanvas.style.left="-9999px",g.gridCanvas.style.top="-9999px",g.intelligentSliceVisible&&(a<10||(g.intelligentSliceObj=e,g.gridLineTimer=setTimeout((()=>{g.gridCanvas.width=t,g.gridCanvas.height=l,g.canvasRealLeft=g.baseCanvas.getBoundingClientRect().left,g.canvasRealTop=g.baseCanvas.getBoundingClientRect().top,g.gridCanvas.style.left=g.canvas.getBoundingClientRect().left-g.canvasRealLeft+"px",g.gridCanvas.style.top=g.canvas.getBoundingClientRect().top-g.canvasRealTop+"px",g.ctx4.strokeStyle=h.themeValue?"white":"black",g.ctx4.lineWidth=1;let n=a,r=a;g.ctx4.beginPath();let i=Math.floor(g.canvasHeight/e.hCount),o=Math.floor(g.canvasWidth/e.vCount);for(let a=0;a<=i;a++)g.ctx4.moveTo(0,a*n*e.hCount),g.ctx4.lineTo(g.gridCanvas.width,a*n*e.hCount);for(let a=0;a<=o;a++)g.ctx4.moveTo(a*r*e.vCount,0),g.ctx4.lineTo(a*r*e.vCount,g.gridCanvas.height);g.ctx4.stroke()}),200)))},handleOpenImageColorPicker(){t.methods.openWindow(l.$config.windowApp.ImageColorPicker)},handleCloseAllDialog(){l.$refs.ReplaceColorDialog.handleClose(),l.$refs.MyColorDialog.handleClose(),l.$refs.PreviewAnimDialog.handleClose(),l.$refs.SpriteDialog.handleClose(),l.$refs.IntelligentSliceDialog.handleClose(),l.$refs.IntelligentStrokeDialog.handleClose(),l.$refs.CanvasRotateDialog.handleClose()}});return fa((()=>i.data.addMyColorVisible),((e,a)=>{e?m.handleCancelKeyboardEvent():m.addKeyBoardEvent()})),fa((()=>g.isShowReferenceLine),((e,a)=>{m.handleDrawReferenceLine()})),fa((()=>g.isShowRuler),((e,a)=>{m.handleDrawReferenceLine()})),fa((()=>g.isShowGridLine),((e,a)=>{m.handleDrawGridLine(),g.pinDouMode&&m.handlePindouBlockHighlight(g.pindouHighlightOptions)})),fa((()=>g.pinDouMode),((e,a)=>{!1===e?(g.gridCanvas.style.left="-9999px",g.gridCanvas.style.top="-9999px",g.gridCanvas.style.transform="none",it.closeAll(),g.currentTool=0,g.pindouHighlight=null,g.currentPindouIndex=0,g.isShowPindouGridLine=!1,g.isShowPindouReferenceLine=!1,g.isShowPindouRuler=!1,ba((()=>{m.handleResetCanvas(),m.handleFrameImg(g.ctx1)}))):g.brushColorVisible=!1})),fa((()=>h.themeValue),((e,a)=>{g.canvas&&g.bgCanvas&&m.drawPixelArea(!0)})),fa((()=>h.isQueryProjectData),((e,a)=>{"1"===e?m.handleReadProjectData():"2"===e&&l.$router.replace("/project")})),fa((()=>g.isEnableCanvasSmooth),((e,a)=>{if(e){g.ctx1.imageSmoothingEnabled=!0,g.ctx1.imageSmoothingQuality="medium";for(const e in g.layerCrossList)g.layerCrossList[e]&&(g.layerCrossList[e].layerCtx.imageSmoothingEnabled=!0,g.layerCrossList[e].layerCtx.imageSmoothingQuality="medium")}else{g.ctx1.imageSmoothingEnabled=!1,g.ctx1.imageSmoothingQuality="none";for(const e in g.layerCrossList)g.layerCrossList[e]&&(g.layerCrossList[e].layerCtx.imageSmoothingEnabled=!1,g.layerCrossList[e].layerCtx.imageSmoothingQuality="none")}m.reDraw(!0,!1)})),$e((()=>{g.worker=new ut,document.addEventListener("click",m.closeMenu),m.handleDragZoneEvent(),va()||(g.exportFormat="image/png"),window.addEventListener("message",(function(e){e.data.includes("hsl")||(g.brushColor=e.data)}))})),Ca((()=>{"1"===h.isQueryProjectData&&m.handleReadProjectData(),g.canvas&&(m.startDrawing(),!g.isPreview&&m.addKeyBoardEvent(),m.handleResizeWindow(),document.addEventListener("click",m.closeMenu),g.isHidePindouMode||!g.pinDouMode&&!g.pinDouDrawMode||(m.handleShowPindou(),g.pinDouMode&&m.handleCancelKeyboardEvent()),!g.isHideLinmoMode&&g.linmoMode&&(g.isHideLinmoMode=!1,l.$refs.LinmoModeDialog.handleShow()))})),wa((()=>{var e,a,t,n,r,i,o,s;if(g.canvas){m.handleCancelSelect(),g.canvas.style.cursor="",g.canvas.classList="",g.canvas.removeEventListener("mousedown",m.start),g.canvas.removeEventListener("mousemove",m.draw),g.canvas.removeEventListener("mouseup",m.stop),g.canvas.removeEventListener("touchstart",m.mobileStart),g.canvas.removeEventListener("touchmove",m.mobileDraw),g.canvas.removeEventListener("touchend",m.mobileStop),g.canvas.removeEventListener("mouseout",m.leave),g.canvas.removeEventListener("wheel",m.handleWheelEvent),null==(e=document.getElementById("ResizeBox"))||e.removeEventListener("mousedown",m.handleScaleCanvasDown),null==(a=document.getElementById("ResizeBox"))||a.removeEventListener("mouseup",m.handleScaleCanvasUp),null==(t=document.getElementById("ResizeBox"))||t.removeEventListener("touchstart",m.handleMobileScaleCanvasDown),null==(n=document.getElementById("ResizeBox"))||n.removeEventListener("touchend",m.handleMobileScaleCanvasUp);let c=document.getElementsByClassName("resize-handle");Array.from(c).forEach((e=>{e.removeEventListener("mousedown",m.startResize),e.removeEventListener("mouseup",m.stopResize),e.removeEventListener("touchstart",m.mobileStartResize),e.removeEventListener("touchend",m.mobileStopResize)})),g.baseCanvas.parentNode.removeEventListener("touchstart",m.handleMobileScaleStart),g.baseCanvas.parentNode.removeEventListener("touchmove",m.handleMobileScaleMove),g.baseCanvas.parentNode.removeEventListener("touchend",m.handleMobileScaleEnd),null==(r=document.querySelector(".X-line"))||r.removeEventListener("mousedown",m.handleXYLineMouseDown),null==(i=document.querySelector(".Y-line"))||i.removeEventListener("mousedown",m.handleXYLineMouseDown),null==(o=document.querySelector(".X-line"))||o.removeEventListener("touchstart",m.handleXYLineMobileDown),null==(s=document.querySelector(".Y-line"))||s.removeEventListener("touchstart",m.handleXYLineMobileDown),window.removeEventListener("keydown",m.handlekeyDownEvent),window.removeEventListener("keyup",m.handleKeyUpEvent),window.removeEventListener("resize",m.handleResizeWindowEvent),document.removeEventListener("click",m.closeMenu),l.$refs.ReplaceColorDialog.handleClose(),l.$refs.MyColorDialog.handleClose(),l.$refs.PreviewAnimDialog.handleClose(),l.$refs.SpriteDialog.handleClose(),l.$refs.PindouDialog.dialogVisible=!1,l.$refs.LinmoModeDialog.dialogVisible=!1,l.$refs.IntelligentSliceDialog.handleClose(),l.$refs.IntelligentStrokeDialog.handleClose(),l.$refs.CanvasRotateDialog.handleClose(),it.closeAll()}})),ha((()=>{g.worker&&g.worker.terminate(),h.saveProjectId("0");const e=document.getElementById("dropZone");["dragenter","dragover","dragleave","drop"].forEach((a=>{e.removeEventListener(a,m.preventDefaults,!1),document.body.removeEventListener(a,m.preventDefaults,!1)})),e.removeEventListener("drop",m.handleDrop,!1)})),o(o(s(o(o(o(s(o(o(o({},Ve(g)),m),p),{editSpaceStore:h,copyText:xa,isEmptyObj:La}),b()),Ve(i.data)),i.computedApi),{getFontColor:ca}),Ve(t.data)),t.methods)}});const ol=e=>(Qe("data-v-8db1fb3e"),e=e(),ea(),e),sl={class:"scrollbar scrollX full-w draw-panel"},cl={class:"back flex-start"},dl={class:"oneline",style:{"font-size":"18px"}},hl={key:0,style:{color:"red","margin-left":"5px"}},ul={class:"flex-end"},gl=ta("导入图像 [Ctrl/⌘ + m]"),pl=ta("导入GIF [Ctrl/⌘ + g]"),ml=ta("保存项目 [Ctrl/⌘ + s]"),yl=ta("导出项目 [Ctrl/⌘ + p]"),fl=ta("导出图像 [Ctrl/⌘ + i]"),vl={class:"flex-start flex-nowarp full-w",style:{flex:"1"}},Cl={key:0,class:"functionBox"},wl={class:"flex-column-start"},xl=["src"],Ll=["src"],Dl=["src"],Sl=ta("画布取色[e]"),bl=ta("全局取色器[g]"),Il=["src"],kl=["src"],Rl=["src"],Ml=ta("矩 形 [s]"),Fl=ta("圆 形 [d]"),Pl=ta("直 线 [f]"),Bl=ta("填充矩形 [g]"),Al=["src"],Tl=ta("手动选择 [y]"),Ol=ta("快速选择 [p]"),jl=ta("区域选择 [j]"),El=ta("取消选择 [Alt/⌥ + n]"),Hl=ta("复 制 [Alt/⌥ + c]"),Wl=ta("删 除 [Alt/⌥ + d]"),$l=ta("移 动 [鼠标左键]"),Vl=["src"],zl=ta("精灵资源"),Yl=ta("智能描边"),Xl=ta("智能裁剪"),Ul=ta("智能切片"),Nl=ta("图片取色"),_l={class:"flex-column-end"},Kl=["src"],Gl=ta("裁剪 [Alt/⌥ + j]"),Jl=ta("缩放 [Alt/⌥ + q]"),ql=ta("水平翻转 [Ctrl/⌘ + ↑]"),Zl=ta("垂直翻转 [Ctrl/⌘ + ↓]"),Ql=ta("中心翻转 [Ctrl/⌘ + →]"),en=ta("旋转 [Ctrl/⌘ + ←]"),an={class:"pointer toolItem"},tn=["src"],ln=ta("黑 白"),nn=ta("反 相"),rn=ta("BGRA"),on=["src"],sn=["src"],cn=ta("清空所有图层 [Delete]"),dn=ta("清空当前图层 [i]"),hn=["src"],un=ta("拼豆预览 [o]"),gn=ta("拼豆绘图 [k]"),pn=["src"],mn={key:0,class:"operation-box full-w flex-end"},yn={key:0},fn=ta("保存智能对象"),vn=ta("保存精灵"),Cn=ta("复 制"),wn=ta("删 除"),xn=ta("取消选择"),Ln={key:1},Dn=["src"],Sn=[ol((()=>_e("div",{class:"resize-handle top-left"},null,-1))),ol((()=>_e("div",{class:"resize-handle top"},null,-1))),ol((()=>_e("div",{class:"resize-handle top-right"},null,-1))),ol((()=>_e("div",{class:"resize-handle right"},null,-1))),ol((()=>_e("div",{class:"resize-handle bottom-right"},null,-1))),ol((()=>_e("div",{class:"resize-handle bottom"},null,-1))),ol((()=>_e("div",{class:"resize-handle bottom-left"},null,-1))),ol((()=>_e("div",{class:"resize-handle left"},null,-1)))],bn={key:2,class:"gridInfo"},In={key:3,class:"colorSelector"},kn={class:"color-body scrollbar full-layout"},Rn=["onClick"],Mn={key:4,class:"colorSelector"},Fn={class:"color-body scrollbar full-layout"},Pn=["title"],Bn=ol((()=>_e("div",{class:"text-center"},"帧",-1))),An=["onClick"],Tn=["src"],On=ta("复 制"),jn=ta("删 除"),En=ta("复制帧数据"),Hn=ta("粘贴帧数据"),Wn=ta("导出为图像"),$n={class:"full-h flex-nowarp flex flex-column",style:{gap:"15px"}},Vn={class:"tab-container"},zn=["checked"],Yn=ol((()=>_e("label",{class:"tab_label",for:0},"功 能",-1))),Xn=["checked"],Un=ol((()=>_e("label",{class:"tab_label",for:1},"图 层",-1))),Nn=ol((()=>_e("div",{class:"indicator"},null,-1))),_n={class:"full-w full-h scrollbar scrollY scrollXHidden",style:{padding:"0 10px 0 5px"}},Kn={key:0,class:"full-w"},Gn={class:"function-block function-block-between"},Jn={class:"flex-center"},qn=ol((()=>_e("span",{class:"function-label"},"画笔颜色",-1))),Zn={class:"flex-center"},Qn=ta("保存"),er=ta("复制"),ar={class:"function-block function-block-between"},tr={class:"flex-center"},lr=ol((()=>_e("span",{class:"function-label",style:{width:"63px"}},"填充颜色",-1))),nr={key:0,class:"function-block-column",style:{"margin-top":"15px"}},rr={class:"flex-between full-w"},ir={class:"flex-start",style:{gap:"10px"}},or={class:"function-label",style:{"margin-right":"0px"}},sr={class:"color-group-select-icon flex-center pointer"},cr={class:"flex-start flex-warp common-color scrollbar"},dr=["title","onContextmenu","onClick"],hr={class:"function-block-column"},ur={class:"flex-between flex-nowarp full-w"},gr=ol((()=>_e("span",{class:"function-label",style:{margin:"0",width:"100px"}},"画布大小",-1))),pr={style:{gap:"10px","margin-top":"10px"},class:"flex-start full-w"},mr=ta("宽"),yr=ta("高"),fr={style:{"margin-top":"10px"},class:"flex-between symmetric-box full-w"},vr={style:{"margin-top":"10px"},class:"flex-between symmetric-box full-w"},Cr={key:1,class:"function-block function-block-between"},wr=ol((()=>_e("span",{class:"function-label"},"画笔大小",-1))),xr={key:2,class:"function-block function-block-between"},Lr=ol((()=>_e("span",{class:"function-label"},"橡皮擦大小",-1))),Dr={key:3,class:"function-block function-block-between"},Sr=ol((()=>_e("span",{class:"function-label"},"网格线间隔",-1))),br={key:4,class:"function-block function-block-between"},Ir=ol((()=>_e("span",{class:"function-label"},"X对称轴偏移",-1))),kr={key:5,class:"function-block function-block-between"},Rr=ol((()=>_e("span",{class:"function-label"},"Y对称轴偏移",-1))),Mr={class:"function-block function-block-between"},Fr=ol((()=>_e("div",{class:"function-label"}," 容 差 ",-1))),Pr={class:"function-block function-block-between"},Br=ol((()=>_e("div",{class:"function-label"}," 图层透明度 ",-1))),Ar={class:"function-block function-block-between"},Tr=ol((()=>_e("div",{class:"function-label"}," 图层缩放比 ",-1))),Or={class:"function-block function-block-between"},jr=ol((()=>_e("div",{class:"function-label"}," 缩放步长 ",-1))),Er={class:"function-block function-block-between"},Hr=ol((()=>_e("div",{class:"function-label"}," 拼豆分块尺寸 ",-1))),Wr={class:"function-block function-block-between"},$r=ol((()=>_e("div",{class:"function-label"}," 画布格子 ",-1))),Vr={class:"function-block function-block-between",style:{"margin-top":"0"}},zr=ol((()=>_e("div",{class:"function-label"}," 画布抗锯齿 ",-1))),Yr={key:6,class:"function-block function-block-between",style:{"margin-top":"0"}},Xr=ol((()=>_e("div",{class:"function-label"}," 橡皮擦轨迹 ",-1))),Ur={class:"function-block function-block-between",style:{"margin-top":"0"}},Nr=ol((()=>_e("div",{class:"function-label"}," 取色自动切换画笔 ",-1))),_r={class:"full-w full-h",style:{height:"calc(100% - 40px)"}},Kr={key:0,class:"full-w full-h scrollHidden"},Gr={key:0,class:"full-w flex-between",style:{padding:"5px 0"}},Jr={class:"flex-end"},qr=["data-key","disabled","onContextmenu","onClick"],Zr={class:"flex-column-center full-w",style:{"padding-top":"2px"}},Qr={class:"full-w flex-between"},ei={class:"flex-start",style:{gap:"10px"}},ai=["onClick"],ti=["src"],li={class:"layer-img flex-center"},ni=["src"],ri={key:0},ii=["onDblclick","title"],oi={key:0,class:"flex-end",style:{gap:"10px"}},si={key:0,class:"full-w",style:{padding:"20px 0px 0px 0px"}},ci={class:"full-w flex-between"},di={class:"flex-start",style:{gap:"10px"}},hi=["onClick"],ui=["src"],gi={key:1,class:"layer-img flex-center"},pi=["src"],mi={key:2},yi=["onDblclick","title"],fi={key:0,class:"flex-end",style:{gap:"10px"}},vi=ta("栅格化"),Ci=ta("复 制"),wi=ta("保存精灵"),xi={class:"full-h flex flex-column pindou-list scrollbar text-center",style:{gap:"15px"}},Li=ta(" 分块 "),Di=["onClick"],Si=["src"],bi={key:0,class:"full-h flex flex-column pindou-list scrollbar text-center",style:{gap:"15px"}},Ii=ta(" 图层 "),ki=["onClick"],Ri=["src"],Mi={class:"flex-between",style:{"margin-top":"10px"}},Fi=ta(" 新建分组 "),Pi={class:"flex-end"},Bi=ta("取消"),Ai=ta("保存"),Ti={style:{"margin-top":"10px"}},Oi={class:"dialog-footer"},ji=ta("取 消"),Ei=ta("保 存");var Hi=je(il,[["render",function(e,a,t,l,n,r){const i=ze("ArrowLeftBold"),o=ze("el-icon"),s=ze("Loading"),c=ze("Back"),d=ze("el-tooltip"),h=ze("Right"),u=ze("ZoomIn"),g=ze("ZoomOut"),p=ze("Refresh"),m=ze("Pointer"),y=ze("VideoPlay"),f=ze("FolderAdd"),v=ze("Folder"),C=ze("el-dropdown-item"),w=ze("el-dropdown-menu"),x=ze("el-dropdown"),L=ze("FullScreen"),D=ze("el-header"),S=ze("el-button"),b=ze("Close"),I=ze("Check"),k=ze("VueDragScale"),R=ze("Expand"),M=ze("Plus"),F=ze("el-footer"),P=ze("el-main"),B=ze("sketch-picker"),A=ze("el-popover"),T=ze("el-link"),O=ze("CaretBottom"),j=ze("MoreFilled"),E=ze("search"),H=ze("el-input"),W=ze("el-checkbox"),$=ze("el-slider"),V=ze("el-input-number"),z=ze("el-switch"),Y=ze("View"),X=ze("Hide"),U=ze("DocumentAdd"),N=ze("CirclePlus"),_=ze("el-divider"),K=ze("Lock"),G=ze("Unlock"),J=ze("CopyDocument"),q=ze("Delete"),Z=ze("el-popconfirm"),Q=ze("ArrowDown"),ee=ze("ArrowUp"),ae=ze("arrow-down"),te=ze("el-timeline-item"),le=ze("el-timeline"),ne=ze("el-aside"),re=ze("el-container"),ie=ze("MyColorDialog"),oe=ze("SpriteDialog"),se=ze("ReplaceColorDialog"),ce=ze("CanvasRotateDialog"),de=ze("IntelligentStrokeDialog"),he=ze("IntelligentSliceDialog"),ue=ze("ExportDialog"),ge=ze("PreviewAnimDialog"),pe=ze("PindouDialog"),me=ze("LayerMenu"),ye=ze("MyColorMenu"),fe=ze("LinmoModeDialog"),ve=ze("UploadImageLayerDialog"),Ce=ze("el-color-picker"),we=ze("el-option"),xe=ze("el-select"),Le=ze("el-dialog"),De=ua("loading");return aa(),Ye("div",{class:"container full-h",style:da(e.checkzIndex)},[Ke(re,{class:"full-h flex-warp"},{default:Ge((()=>[_e("div",sl,[Ke(P,{class:"flex-column-center",style:{display:"flex",padding:"0","min-width":"500px"}},{default:Ge((()=>[Ke(D,{class:"flex-between"},{default:Ge((()=>[_e("div",cl,[Ke(o,{onClick:e.handleBack},{default:Ge((()=>[Ke(i)])),_:1},8,["onClick"]),_e("h1",dl,la(e.projectData.projectName),1),e.isSaveProject||e.isPreview?Xe("v-if",!0):(aa(),Ye("span",hl,"*")),Xe(' <h1 class="oneline">{{ projectData.projectName }}\r\n                                <span style="color:red" v-if="!isSaveProject">*</span>\r\n                            </h1> '),e.editSpaceStore.isAutoBackuping?(aa(),pa(o,{key:1,style:{"margin-left":"10px"},color:"green",class:Je({"is-loading":e.editSpaceStore.isAutoBackuping})},{default:Ge((()=>[Ke(s)])),_:1},8,["class"])):Xe("v-if",!0)]),_e("div",ul,[Ke(d,{content:"撤销 [Ctrl/⌘ + z]",placement:"bottom"},{default:Ge((()=>[e.isPreview?Xe("v-if",!0):(aa(),pa(o,{key:0,style:{"margin-right":"20px"},onClick:e.handleRevoke,class:Je({isNotAllowed:e.loading||!e.historyRecord.length||8===e.currentTool||e.isControlMindObj})},{default:Ge((()=>[Ke(c)])),_:1},8,["onClick","class"]))])),_:1}),Ke(d,{content:"恢复 [Ctrl/⌘ + x]",placement:"bottom"},{default:Ge((()=>[e.isPreview?Xe("v-if",!0):(aa(),pa(o,{key:0,style:{"margin-right":"20px"},onClick:e.handleRecover,class:Je({isNotAllowed:e.loading||!e.historyRecord.length||8===e.currentTool||e.isControlMindObj})},{default:Ge((()=>[Ke(h)])),_:1},8,["onClick","class"]))])),_:1}),Ke(d,{content:"放大画布 [滚轮/Ctrl/⌘ + =]",placement:"bottom"},{default:Ge((()=>[Ke(o,{style:{"margin-right":"20px"},onClick:a[0]||(a[0]=a=>e.handleResizeCanvas(e.layerScaleStep))},{default:Ge((()=>[Ke(u)])),_:1})])),_:1}),Ke(d,{content:"缩小画布 [滚轮/Ctrl/⌘ + -]",placement:"bottom"},{default:Ge((()=>[Ke(o,{style:{"margin-right":"20px"},onClick:a[1]||(a[1]=a=>e.handleResizeCanvas(-e.layerScaleStep))},{default:Ge((()=>[Ke(g)])),_:1})])),_:1}),Ke(d,{content:"重置画布 [Alt/⌥ + v]",placement:"bottom"},{default:Ge((()=>[Ke(o,{style:{"margin-right":"20px"},onClick:e.handleResetCanvas},{default:Ge((()=>[Ke(p)])),_:1},8,["onClick"])])),_:1}),Ke(d,{content:"移动画布 [空格 + 鼠标]",placement:"bottom"},{default:Ge((()=>[Xe(' <el-icon style="margin-right: 20px; color: orange;" v-if="isSpace" @click="isSpace=false"><Pointer /></el-icon> '),Ke(o,{style:{"margin-right":"20px"},onClick:e.handleOpenMoveCanvas,class:Je({active:e.isSpace})},{default:Ge((()=>[Ke(m)])),_:1},8,["onClick","class"])])),_:1}),Ke(d,{content:e.previewLoading?"正在加载":"预览动画 [Alt/⌥ + p]",placement:"bottom"},{default:Ge((()=>[e.previewLoading?(aa(),pa(o,{key:1,style:{"margin-right":"20px"},class:"is-loading"},{default:Ge((()=>[Ke(s)])),_:1})):(aa(),pa(o,{key:0,style:{"margin-right":"20px"},onClick:e.handleOpenPreviewDialog,class:Je({isNotAllowed:e.loading})},{default:Ge((()=>[Ke(y)])),_:1},8,["onClick","class"]))])),_:1},8,["content"]),Ke(d,{content:"导入到我的项目",placement:"bottom"},{default:Ge((()=>[e.isPreview&&"1"===e.sharePermission?(aa(),pa(o,{key:0,style:{"margin-right":"20px"},onClick:e.handleImportProject,class:Je({isNotAllowed:e.loading})},{default:Ge((()=>[Ke(f)])),_:1},8,["onClick","class"])):Xe("v-if",!0)])),_:1}),Xe(' <el-tooltip\r\n                            content="导出"\r\n                            placement="bottom">\r\n                                <el-icon style="margin-right: 20px;" @click="exportVisible=true"><Files /></el-icon>\r\n                            </el-tooltip> '),Ke(x,{placement:"bottom",trigger:"hover"},{dropdown:Ge((()=>[Ke(w,null,{default:Ge((()=>[Ke(C,{onClick:e.handleImportImage,disabled:e.pinDouMode},{default:Ge((()=>[gl])),_:1},8,["onClick","disabled"]),Ke(C,{onClick:e.handleImportImageForGif,disabled:e.pinDouMode},{default:Ge((()=>[pl])),_:1},8,["onClick","disabled"]),Ke(C,{onClick:e.handleSaveProject,disabled:e.pinDouMode},{default:Ge((()=>[ml])),_:1},8,["onClick","disabled"]),Xe(' <el-dropdown-item @click="handleImportProject">导入项目</el-dropdown-item> '),Ke(C,{onClick:a[2]||(a[2]=a=>e.handleExportDialog(!0)),disabled:e.pinDouMode},{default:Ge((()=>[yl])),_:1},8,["disabled"]),Ke(C,{onClick:a[3]||(a[3]=a=>e.handleExportDialog(!1)),disabled:e.pinDouMode},{default:Ge((()=>[fl])),_:1},8,["disabled"])])),_:1})])),default:Ge((()=>[e.isPreview?Xe("v-if",!0):(aa(),pa(o,{key:0,style:{"margin-right":"20px"},size:"16"},{default:Ge((()=>[Ke(v)])),_:1}))])),_:1}),Ke(d,{content:"全屏 [Alt/⌥ + f]",placement:"bottom"},{default:Ge((()=>[Ke(o,{class:Je({active:e.editSpaceStore.isFullWork}),style:{"margin-right":"0px"},onClick:e.handleScreenFull},{default:Ge((()=>[Ke(L)])),_:1},8,["class","onClick"])])),_:1})])])),_:1}),_e("div",vl,[e.isPreview?Xe("v-if",!0):(aa(),Ye("div",Cl,[_e("div",wl,[Ke(d,{content:"画笔 [q]",placement:"right"},{default:Ge((()=>[_e("div",{class:Je(["pointer toolItem flex-center",{active:0===e.currentTool}]),style:{"margin-top":"0"},onClick:a[4]||(a[4]=a=>e.handleChangeTool(0))},[_e("img",{src:e.requireIcon("brush")},null,8,xl),Xe(" <span v-html=\"$iconSvg['brush']\"></span> ")],2)])),_:1}),Ke(d,{content:"橡皮擦 [w]",placement:"right"},{default:Ge((()=>[_e("div",{class:Je(["pointer toolItem",{active:1===e.currentTool}]),onClick:a[5]||(a[5]=a=>e.handleChangeTool(1))},[_e("img",{src:e.requireIcon("eraser")},null,8,Ll),Xe(" <span v-html=\"$iconSvg['eraser']\"></span> ")],2)])),_:1}),Ke(d,{content:"吸管[e]",placement:"right"},{default:Ge((()=>[Ke(x,{placement:"bottom-start",trigger:"hover"},{dropdown:Ge((()=>[Ke(w,null,{default:Ge((()=>[Ke(C,{onClick:a[7]||(a[7]=a=>e.handleChangeTool(2))},{default:Ge((()=>[Sl])),_:1}),Ke(C,{onClick:e.handleEyeDropper},{default:Ge((()=>[bl])),_:1},8,["onClick"])])),_:1})])),default:Ge((()=>[_e("div",{class:Je(["pointer toolItem",{active:2===e.currentTool}]),onClick:a[6]||(a[6]=a=>e.handleChangeTool(2))},[Xe(" <span v-html=\"$iconSvg['straw']\"></span> "),_e("img",{src:e.requireIcon("straw")},null,8,Dl)],2)])),_:1})])),_:1}),Ke(d,{content:"油漆桶 [r]",placement:"right"},{default:Ge((()=>[_e("div",{class:Je(["pointer toolItem",{active:4===e.currentTool}]),onClick:a[8]||(a[8]=a=>e.handleChangeTool(4))},[_e("img",{src:e.requireIcon("bucket")},null,8,Il)],2)])),_:1}),Ke(d,{content:"移动 [t]",placement:"right"},{default:Ge((()=>[_e("div",{class:Je(["pointer toolItem",{active:7===e.currentTool}]),onClick:a[9]||(a[9]=a=>e.handleChangeTool(7))},[_e("img",{src:e.requireIcon("move")},null,8,kl)],2)])),_:1}),Ke(d,{content:"形状",placement:"right"},{default:Ge((()=>[Ke(x,{placement:"bottom-start",trigger:"click"},{dropdown:Ge((()=>[Ke(w,null,{default:Ge((()=>[Ke(C,{onClick:a[11]||(a[11]=a=>e.drawShape("rect")),disabled:e.pinDouMode},{default:Ge((()=>[Ml])),_:1},8,["disabled"]),Ke(C,{onClick:a[12]||(a[12]=a=>e.drawShape("circle")),disabled:e.pinDouMode},{default:Ge((()=>[Fl])),_:1},8,["disabled"]),Ke(C,{onClick:a[13]||(a[13]=a=>e.drawShape("line")),disabled:e.pinDouMode},{default:Ge((()=>[Pl])),_:1},8,["disabled"]),Ke(C,{onClick:a[14]||(a[14]=a=>e.drawShape("fillRect")),disabled:e.pinDouMode},{default:Ge((()=>[Bl])),_:1},8,["disabled"]),Xe("v-if",!0)])),_:1})])),default:Ge((()=>[_e("div",{class:Je(["pointer toolItem",{active:3===e.currentTool}]),onClick:a[10]||(a[10]=a=>e.handleChangeTool(3))},[_e("img",{src:e.requireShapeImg},null,8,Rl)],2)])),_:1})])),_:1}),Ke(d,{content:"选区",placement:"right"},{default:Ge((()=>[Ke(x,{placement:"bottom-start",trigger:"click"},{dropdown:Ge((()=>[Ke(w,null,{default:Ge((()=>[Ke(C,{onClick:a[17]||(a[17]=a=>e.selectType="select")},{default:Ge((()=>[Tl])),_:1}),Ke(C,{onClick:a[18]||(a[18]=a=>e.selectType="quickSelect")},{default:Ge((()=>[Ol])),_:1}),Ke(C,{onClick:a[19]||(a[19]=a=>e.selectType="rangeSelect")},{default:Ge((()=>[jl])),_:1}),Ke(C,{onClick:e.handleCancelSelect,disabled:8!==e.currentTool||e.isScaling},{default:Ge((()=>[El])),_:1},8,["onClick","disabled"]),Ke(C,{onClick:e.handleCopySelectData,disabled:8!==e.currentTool||e.isScaling},{default:Ge((()=>[Hl])),_:1},8,["onClick","disabled"]),Ke(C,{onClick:e.handleRemoveSelect,disabled:8!==e.currentTool||e.isScaling},{default:Ge((()=>[Wl])),_:1},8,["onClick","disabled"]),Ke(C,{disabled:""},{default:Ge((()=>[$l])),_:1})])),_:1})])),default:Ge((()=>[_e("div",{class:Je(["pointer toolItem",{active:8===e.currentTool}]),onClick:a[16]||(a[16]=a=>e.handleChangeTool(8))},[_e("img",{src:e.requireSelectImg},null,8,Al)],2)])),_:1})])),_:1}),Ke(d,{content:"更多",placement:"right"},{default:Ge((()=>[Ke(x,{placement:"bottom-start",trigger:"click",disabled:e.pinDouMode},{dropdown:Ge((()=>[Ke(w,null,{default:Ge((()=>[Ke(C,{onClick:a[20]||(a[20]=a=>e.handleChangeTool(10))},{default:Ge((()=>[zl])),_:1}),Ke(C,{onClick:e.handleIntelligentStrokeVisible},{default:Ge((()=>[Yl])),_:1},8,["onClick"]),Ke(C,{onClick:e.handleIntelligentCrop},{default:Ge((()=>[Xl])),_:1},8,["onClick"]),Ke(C,{onClick:e.handleIntelligentSliceVisible},{default:Ge((()=>[Ul])),_:1},8,["onClick"]),Ke(C,{onClick:e.handleOpenImageColorPicker},{default:Ge((()=>[Nl])),_:1},8,["onClick"])])),_:1})])),default:Ge((()=>[_e("div",{class:Je(["pointer toolItem",{active:[10].includes(e.currentTool)}])},[_e("img",{src:e.requireIcon("more")},null,8,Vl)],2)])),_:1},8,["disabled"])])),_:1}),Xe(' <el-tooltip\r\n                                    content="精灵资源"\r\n                                    placement="right"\r\n                                >\r\n                                    <div class="pointer toolItem" @click="handleChangeTool(10)"\r\n                                    :class="{ \'active\': currentTool === 10 }">\r\n                                        <img :src="requireIcon(\'sprite\')"/>\r\n                                    </div>\r\n                                </el-tooltip> '),Xe(' <el-tooltip\r\n                                content="魔棒 [p]"\r\n                                placement="right"\r\n                                >\r\n                                    <div class="pointer toolItem" @click="handleChangeTool(9)"\r\n                                    :class="{ \'active\': currentTool === 9 }">\r\n                                        <img :src="requireIcon(\'magicStick\')"/>\r\n                                    </div>\r\n                                </el-tooltip> ')]),_e("div",_l,[Ke(d,{content:"变换",placement:"right"},{default:Ge((()=>[Ke(x,{placement:"top-start",trigger:"click"},{dropdown:Ge((()=>[Ke(w,null,{default:Ge((()=>[Xe(' <el-dropdown-item @click="drawTransform(\'frameSelect\')" :disabled="pinDouMode || isControlMindObj">框选 [Alt/⌥ + k]</el-dropdown-item> '),Ke(C,{onClick:a[21]||(a[21]=a=>e.drawTransform("crop")),disabled:e.pinDouMode||e.isControlMindObj},{default:Ge((()=>[Gl])),_:1},8,["disabled"]),Ke(C,{onClick:a[22]||(a[22]=a=>e.drawTransform("scale")),disabled:e.pinDouMode||e.isControlMindObj},{default:Ge((()=>[Jl])),_:1},8,["disabled"]),Ke(C,{onClick:a[23]||(a[23]=a=>e.drawTransform("hReverse")),disabled:e.pinDouMode},{default:Ge((()=>[ql])),_:1},8,["disabled"]),Ke(C,{onClick:a[24]||(a[24]=a=>e.drawTransform("vReverse")),disabled:e.pinDouMode},{default:Ge((()=>[Zl])),_:1},8,["disabled"]),Ke(C,{onClick:a[25]||(a[25]=a=>e.drawTransform("cReverse")),disabled:e.pinDouMode},{default:Ge((()=>[Ql])),_:1},8,["disabled"]),Ke(C,{onClick:a[26]||(a[26]=a=>e.drawTransform("rotate")),disabled:e.pinDouMode||8===e.currentTool||e.isControlMindObj},{default:Ge((()=>[en])),_:1},8,["disabled"]),Xe(' <el-dropdown-item @click="drawTransform(\'ssz\')" :disabled="pinDouMode || canvasWidth!==canvasHeight">顺时针旋转90度 [Ctrl/⌘ + →]</el-dropdown-item>\r\n                                                <el-dropdown-item @click="drawTransform(\'nsz\')" :disabled="pinDouMode || canvasWidth!==canvasHeight">逆时针旋转90度 [Ctrl/⌘ + ←]</el-dropdown-item> ')])),_:1})])),default:Ge((()=>[_e("div",{class:Je(["pointer toolItem",{active:9===e.currentTool||11===e.currentTool||e.isScaling}])},[_e("img",{src:e.requireTransformImg},null,8,Kl)],2)])),_:1})])),_:1}),Ke(d,{content:"滤镜",placement:"right"},{default:Ge((()=>[Ke(x,{placement:"top-start",trigger:"click"},{dropdown:Ge((()=>[Ke(w,null,{default:Ge((()=>[Ke(C,{onClick:a[27]||(a[27]=a=>e.handleFilter(1)),disabled:e.pinDouMode},{default:Ge((()=>[ln])),_:1},8,["disabled"]),Ke(C,{onClick:a[28]||(a[28]=a=>e.handleFilter(2)),disabled:e.pinDouMode},{default:Ge((()=>[nn])),_:1},8,["disabled"]),Ke(C,{onClick:a[29]||(a[29]=a=>e.handleFilter(3)),disabled:e.pinDouMode},{default:Ge((()=>[rn])),_:1},8,["disabled"]),Xe(' <el-dropdown-item @click="handleFilter(4, 16)" :disabled="pinDouMode">16色</el-dropdown-item>\r\n                                                <el-dropdown-item @click="handleFilter(4, 32)" :disabled="pinDouMode">32色</el-dropdown-item>\r\n                                                <el-dropdown-item @click="handleFilter(4, 64)" :disabled="pinDouMode">64色</el-dropdown-item>\r\n                                                <el-dropdown-item @click="handleFilter(4, 128)" :disabled="pinDouMode">128色</el-dropdown-item> '),Xe(" <el-dropdown-item @click=\"drawShape('fillCircle')\">填充圆形</el-dropdown-item> ")])),_:1})])),default:Ge((()=>[_e("div",an,[_e("img",{src:e.requireIcon("filter")},null,8,tn)])])),_:1})])),_:1}),Ke(d,{content:"替换颜色 [u]",placement:"right"},{default:Ge((()=>[_e("div",{class:"pointer toolItem",onClick:a[30]||(a[30]=(...a)=>e.handleOpenReplaceColorDialog&&e.handleOpenReplaceColorDialog(...a))},[_e("img",{src:e.requireIcon("color")},null,8,on)])])),_:1}),Ke(d,{content:"清空图层",placement:"right"},{default:Ge((()=>[Ke(x,{placement:"top-start",trigger:"hover"},{dropdown:Ge((()=>[Ke(w,null,{default:Ge((()=>[Ke(C,{onClick:a[32]||(a[32]=a=>e.handleClearLayer("all")),disabled:e.pinDouMode},{default:Ge((()=>[cn])),_:1},8,["disabled"]),Ke(C,{onClick:a[33]||(a[33]=a=>e.handleClearLayer("single")),disabled:e.pinDouMode},{default:Ge((()=>[dn])),_:1},8,["disabled"])])),_:1})])),default:Ge((()=>[_e("div",{class:"pointer toolItem",onClick:a[31]||(a[31]=a=>e.handleClearLayer("single"))},[_e("img",{src:e.requireIcon("clear")},null,8,sn)])])),_:1})])),_:1}),Ke(d,{content:"拼豆模式",placement:"right"},{default:Ge((()=>[Ke(x,{placement:"top-start",trigger:"hover",disabled:e.isControlMindObj},{dropdown:Ge((()=>[Ke(w,null,{default:Ge((()=>[Ke(C,{onClick:a[35]||(a[35]=a=>e.handlePindouMode("preview")),disabled:e.pinDouMode},{default:Ge((()=>[un])),_:1},8,["disabled"]),Ke(C,{onClick:a[36]||(a[36]=a=>e.handlePindouMode("draw")),disabled:e.pinDouMode},{default:Ge((()=>[gn])),_:1},8,["disabled"])])),_:1})])),default:Ge((()=>[_e("div",{class:Je(["pointer toolItem",{active:e.pinDouMode||e.pinDouDrawMode,isNotAllowed:e.isControlMindObj}]),onClick:a[34]||(a[34]=a=>e.handlePindouMode("preview"))},[_e("img",{src:e.requireIcon("pindou")},null,8,hn)],2)])),_:1},8,["disabled"])])),_:1}),Ke(d,{content:"临摹模式 [l]",placement:"right"},{default:Ge((()=>[_e("div",{class:Je(["pointer toolItem",{active:e.linmoMode}]),onClick:a[37]||(a[37]=(...a)=>e.handleLinmoMode&&e.handleLinmoMode(...a))},[_e("img",{src:e.requireIcon("copy")},null,8,pn)],2)])),_:1}),Xe(' <el-tooltip\r\n                                    content="AI"\r\n                                    placement="right"\r\n                                >\r\n                                    <el-dropdown placement="top-start" trigger="click">\r\n                                        <div class="pointer toolItem">\r\n                                            <img :src="requireIcon(\'ai\')"/>\r\n                                        </div>\r\n                                        <template #dropdown>\r\n                                            <el-dropdown-menu>\r\n                                                <el-dropdown-item @click="handleFilter(1)" :disabled="pinDouMode">智能描边</el-dropdown-item>\r\n                                                <el-dropdown-item @click="handleFilter(2)" :disabled="pinDouMode">智能生图</el-dropdown-item>\r\n                                                \r\n                                            </el-dropdown-menu>\r\n                                        </template>\r\n                                    </el-dropdown>\r\n                                    \r\n                                </el-tooltip> ')])])),Ue((aa(),Ye("div",{onContextmenu:a[48]||(a[48]=e=>e.preventDefault()),class:"pixelBox scrollbar",id:"dropZone","element-loading-background":"#00000033"},[8===e.currentTool||9===e.currentTool||e.isScaling?(aa(),Ye("div",mn,[8===e.currentTool?(aa(),Ye("div",yn,[Ke(S,{type:"info",size:"small",onClick:e.handleSaveMindForSelect,disabled:e.isScaling},{default:Ge((()=>[fn])),_:1},8,["onClick","disabled"]),Ke(S,{type:"warning",size:"small",onClick:e.handleSaveSpriteForSelect,disabled:e.isScaling},{default:Ge((()=>[vn])),_:1},8,["onClick","disabled"]),Ke(S,{type:"success",size:"small",onClick:e.handleCopySelectData,disabled:e.isScaling},{default:Ge((()=>[Cn])),_:1},8,["onClick","disabled"]),Ke(S,{type:"danger",size:"small",onClick:e.handleRemoveSelect,disabled:e.isScaling},{default:Ge((()=>[wn])),_:1},8,["onClick","disabled"]),Ke(S,{type:"primary",size:"small",onClick:a[38]||(a[38]=a=>e.handleChangeTool(0)),disabled:e.isScaling},{default:Ge((()=>[xn])),_:1},8,["disabled"])])):Xe("v-if",!0),9===e.currentTool||e.isScaling?(aa(),Ye("div",Ln,[Ke(S,{type:"danger",size:"small",onClick:e.handleCancelScale},{default:Ge((()=>[Ke(o,null,{default:Ge((()=>[Ke(b)])),_:1})])),_:1},8,["onClick"]),Ke(S,{type:"success",size:"small",onClick:e.handleFinishScale},{default:Ge((()=>[Ke(o,null,{default:Ge((()=>[Ke(I)])),_:1})])),_:1},8,["onClick"])])):Xe("v-if",!0)])):Xe("v-if",!0),e.linmoPhoto?(aa(),pa(k,{key:1,linmoPhotoStyle:e.linmoPhotoStyle,isHighPreview:e.isHighPreview,linmoPhoto:e.linmoPhoto,onUpdate:e.handleUpdateLinmoStyle},{default:Ge((()=>[Xe(' <img :src="linmoPhoto" draggable="false"/> ')])),_:1},8,["linmoPhotoStyle","isHighPreview","linmoPhoto","onUpdate"])):Xe("v-if",!0),Xe(' <img \r\n                            :src="linmoPhoto" \r\n                            v-show="linmoPhoto" draggable="false" \r\n                            :style="linmoPhotoStyle" class="linmoPhoto" id="linmoPhoto"/> '),_e("canvas",{id:"PixelCanvas",width:"512",height:"512",onContextmenu:a[39]||(a[39]=e=>e.preventDefault()),style:da(e.canvasStyle)},null,36),_e("canvas",{id:"Canvas",style:da(e.canvasStyle),width:"512",height:"512",onContextmenu:a[40]||(a[40]=e=>e.preventDefault())},null,36),Ue(_e("div",{class:Je(["ScaleBox",{"pointer-none":e.isSpace}]),style:da(e.canvasStyle)},[_e("div",{id:"scale-box",style:da(e.scaleStyle)},[Ue(_e("img",{src:e.scaleImg,onContextmenu:a[41]||(a[41]=e=>e.preventDefault())},null,40,Dn),[[Ne,!1]]),_e("canvas",{id:"scale-canvas",onContextmenu:a[42]||(a[42]=e=>e.preventDefault())},null,32),Xe(' <div class="resize-box">\r\n                                        <div class="resize-handle top-left"></div>\r\n                                        <div class="resize-handle top"></div>\r\n                                        <div class="resize-handle top-right"></div>\r\n                                        <div class="resize-handle right"></div>\r\n                                        <div class="resize-handle bottom-right"></div>\r\n                                        <div class="resize-handle bottom"></div>\r\n                                        <div class="resize-handle bottom-left"></div>\r\n                                        <div class="resize-handle left"></div>\r\n                                    </div> ')],4)],6),[[Ne,e.isScaling||e.isControlMindObj]]),Ue(_e("div",{class:Je(["resize-box",{"pointer-none":e.isSpace||e.isShift}]),id:"ResizeBox",style:da(e.resizeStyle)},Sn,6),[[Ne,e.isScaling||e.isControlMindObj]]),_e("canvas",{id:"GridCanvas",width:"512",height:"512",onContextmenu:a[43]||(a[43]=e=>e.preventDefault())},null,32),_e("canvas",{id:"BaseCanvas",width:"512",height:"512",onContextmenu:a[44]||(a[44]=e=>e.preventDefault())},null,32),Ue(_e("div",{class:"X-line",style:da(e.axisXStyle)},null,4),[[Ne,e.isHorizontal]]),Ue(_e("div",{class:"Y-line",style:da(e.axisYStyle)},null,4),[[Ne,e.isVertical]]),Xe(' <div class="C-line" v-show="isCenter" :style="axisCStyle"></div> '),"[]"!==e.gridInfo?(aa(),Ye("p",bn,la(e.gridInfo),1)):Xe("v-if",!0),Xe(' <div class="flex-center cancelSelect">\r\n                                <div v-if="currentSelectMindId != 0">\r\n                                    <el-button type="danger" @click="handleCancelScale">\r\n                                        <el-icon><Close /></el-icon>\r\n                                    </el-button>\r\n                                    <el-button type="success" @click="handleFinishScale">\r\n                                        <el-icon><Check /></el-icon>\r\n                                    </el-button>\r\n                                </div>\r\n                            </div> '),e.drawRecord.length&&Object.keys(e.colorStatList).length&&!e.pinDouMode?(aa(),Ye("div",In,[_e("div",{class:"back-icon",onClick:a[45]||(a[45]=(...a)=>e.handleExpand&&e.handleExpand(...a))},[Ke(o,null,{default:Ge((()=>[Ke(R)])),_:1})]),_e("div",kn,[(aa(!0),Ye(Ze,null,ga(e.colorStatList,((a,t)=>(aa(),Ye("div",{class:Je(["colorItem flex-center",{active:e.brushColor===t}]),key:t,onClick:a=>e.brushColor=t,style:da({backgroundColor:t,color:e.getFontColor(t)})},la(e.pinDouDrawMode?1==a?"":a:""),15,Rn)))),128))])])):Xe("v-if",!0),e.pinDouMode&&e.pindouBlockList[e.currentPindouIndex].colorStatList?(aa(),Ye("div",Mn,[_e("div",{class:"back-icon",onClick:a[46]||(a[46]=(...a)=>e.handleExpand&&e.handleExpand(...a))},[Ke(o,null,{default:Ge((()=>[Ke(R)])),_:1})]),_e("div",Fn,[(aa(!0),Ye(Ze,null,ga(Array.from(e.pindouBlockList[e.currentPindouIndex].colorStatList),((a,t)=>(aa(),Ye("div",{class:"colorItem flex-center",key:t,title:a,style:da({backgroundColor:a[1][0],fontSize:"12px",color:e.getFontColor(a[1][0])})},la(`${a[0]}:${a[1][1]}`),13,Pn)))),128))])])):Xe("v-if",!0),e.isHidePindouMode?(aa(),Ye("div",{key:5,class:"pindouBtn flex-center",onClick:a[47]||(a[47]=(...a)=>e.handleShowPindou&&e.handleShowPindou(...a))},la(e.pinDouMode?"预":"绘"),1)):Xe("v-if",!0)],32)),[[De,e.loading]])]),Ke(F,{class:"flex-start"},{default:Ge((()=>[Bn,_e("div",{class:"flex-start frame-list scrollbar",onDragstart:a[50]||(a[50]=a=>e.onDragStart(a,e.pinDouMode)),onDragover:a[51]||(a[51]=a=>e.onDragOver(a,"frameBox")),onDragend:a[52]||(a[52]=a=>e.onDragFrameEnd(a,"frameBox")),ref:"frameBox",id:"frame-box"},[(aa(!0),Ye(Ze,null,ga(e.drawRecord,((a,t)=>(aa(),pa(x,{draggable:"true","data-key":a.frameId,"data-node":"LI",disabled:e.pinDouMode||e.isPreview,key:a.frameId,trigger:"contextmenu"},{dropdown:Ge((()=>[Ke(w,null,{default:Ge((()=>[Ke(C,{onClick:a=>e.handleCopyFrame(t,"copy")},{default:Ge((()=>[On])),_:2},1032,["onClick"]),Xe(' <el-dropdown-item @click="handleExportFrame(index)">导出为帧数据</el-dropdown-item> '),0!==t?(aa(),pa(C,{key:0,onClick:a=>e.handleDeleteFrame(t)},{default:Ge((()=>[jn])),_:2},1032,["onClick"])):Xe("v-if",!0),Ke(C,{onClick:a=>e.handleCopyFrame(t,"copyData")},{default:Ge((()=>[En])),_:2},1032,["onClick"]),Ke(C,{onClick:a=>e.handleCopyFrame(t,"pasteData")},{default:Ge((()=>[Hn])),_:2},1032,["onClick"]),Ke(C,{onClick:a=>e.handleExportDialog(!1,"frame",t)},{default:Ge((()=>[Wn])),_:2},1032,["onClick"])])),_:2},1024)])),default:Ge((()=>[_e("div",{onClick:a=>e.handleChangeFrame(t),class:Je(["frame-item pointer",{active:e.currentFrameIndex===t,isNotAllowed:e.loading}])},[a.currentFrameImg?(aa(),Ye("img",{key:0,draggable:"false",src:a.currentFrameImg,class:"frame-image"},null,8,Tn)):Xe("v-if",!0)],10,An)])),_:2},1032,["data-key","disabled"])))),128)),e.drawRecord.length<e.maxFrame&&!e.isPreview?(aa(),Ye("div",{key:0,class:"frame-item pointer frame-add flex-center",onClick:a[49]||(a[49]=(...a)=>e.handleAddFrame&&e.handleAddFrame(...a))},[Ke(o,null,{default:Ge((()=>[Ke(M)])),_:1})])):Xe("v-if",!0)],544)])),_:1})])),_:1})]),Ue(Ke(ne,{onClick:e.handleCancelSelectMindObj},{default:Ge((()=>{var t,l,n;return[_e("div",$n,[_e("div",Vn,[_e("input",{type:"radio",name:"tab",id:0,class:"tab tab--1",onChange:a[53]||(a[53]=a=>e.handleChangeMenuType(0)),checked:0===e.menuType},null,40,zn),Yn,_e("input",{type:"radio",name:"tab",id:1,class:"tab tab--2",onChange:a[54]||(a[54]=a=>e.handleChangeMenuType(1)),checked:1===e.menuType},null,40,Xn),Un,Nn]),Ue(_e("div",_n,[e.isPreview?Xe("v-if",!0):(aa(),Ye("div",Kn,[Xe(' <h1>功能面板</h1>\r\n                            <el-divider border-style="dashed" /> '),_e("div",Gn,[_e("div",Jn,[qn,Xe(' <el-color-picker v-model="brushColor" show-alpha @active-change="(e) => brushColor = e"/> '),Ke(A,{placement:"bottom",width:224,visible:e.brushColorVisible&&0===e.menuType},{reference:Ge((()=>[_e("div",{style:da({backgroundColor:e.brushColor}),class:"color-picker",onClick:a[55]||(a[55]=a=>e.brushColorVisible=!e.brushColorVisible)},null,4)])),default:Ge((()=>[Ke(B,{modelValue:e.brushColor,"onUpdate:modelValue":a[56]||(a[56]=a=>e.brushColor=a.hex8)},null,8,["modelValue"])])),_:1},8,["visible"])]),_e("div",Zn,[Ke(d,{content:"保存颜色 [Alt/⌥ + s]",placement:"top"},{default:Ge((()=>[Ke(T,{type:"info",underline:!1,onClick:a[57]||(a[57]=a=>e.handleSaveColor(!1,e.brushColor))},{default:Ge((()=>[Qn])),_:1})])),_:1}),Ke(d,{content:"复制颜色 [Ctrl/⌘ + c]",placement:"top"},{default:Ge((()=>[Ke(T,{type:"info",underline:!1,style:{"margin-left":"10px"},onClick:a[58]||(a[58]=a=>e.handleCopyColor(e.brushColor))},{default:Ge((()=>[er])),_:1})])),_:1})])]),Ue(_e("div",ar,[_e("div",tr,[lr,Xe(' <el-color-picker v-model="shapeFillColor" show-alpha /> '),Ke(A,{placement:"bottom",width:224,visible:e.shapeFillColorVisible},{reference:Ge((()=>[_e("div",{style:da({backgroundColor:e.shapeFillColor}),class:"color-picker",onClick:a[59]||(a[59]=a=>e.shapeFillColorVisible=!e.shapeFillColorVisible)},null,4)])),default:Ge((()=>[Ke(B,{modelValue:e.shapeFillColor,"onUpdate:modelValue":a[60]||(a[60]=a=>e.shapeFillColor=a.hex8)},null,8,["modelValue"])])),_:1},8,["visible"])])],512),[[Ne,e.currentDrawShape.indexOf("fill")>=0&&3e3===e.currentTool]]),e.editSpaceStore.myColorList.length?(aa(),Ye("div",nr,[_e("div",rr,[_e("div",ir,[_e("span",or,la((null==(t=e.editSpaceStore.myColorList.find((a=>a.id==e.currentColorGroup)))?void 0:t.groupName)||e.editSpaceStore.myColorList[0].groupName),1),Ke(x,{trigger:"click"},{dropdown:Ge((()=>[Ke(w,null,{default:Ge((()=>[(aa(!0),Ye(Ze,null,ga(e.editSpaceStore.myColorList,(a=>(aa(),pa(C,{key:a.id,onClick:t=>e.currentColorGroup=a.id},{default:Ge((()=>[ta(la(a.groupName),1)])),_:2},1032,["onClick"])))),128))])),_:1})])),default:Ge((()=>[_e("div",sr,[Ke(o,null,{default:Ge((()=>[Ke(O)])),_:1})])])),_:1}),Ke(d,{content:"添加颜色 [Alt/⌥ + a]",placement:"bottom"},{default:Ge((()=>[_e("div",{class:"color-group-select-icon flex-center pointer",onClick:a[61]||(a[61]=a=>e.handleAdd(e.currentColorGroup))},[Ke(o,null,{default:Ge((()=>[Ke(M)])),_:1})])])),_:1}),Ke(d,{content:"全部颜色 [Alt/⌥ + g]",placement:"bottom"},{default:Ge((()=>[_e("div",{class:"color-group-select-icon flex-center pointer",onClick:a[62]||(a[62]=(...a)=>e.handleOpenMyColorDialog&&e.handleOpenMyColorDialog(...a))},[Ke(o,null,{default:Ge((()=>[Ke(j)])),_:1})])])),_:1})]),_e("div",null,[Ke(H,{modelValue:e.searchColorValue,"onUpdate:modelValue":a[63]||(a[63]=a=>e.searchColorValue=a),style:{width:"100px"},size:"small",placeholder:"搜索颜色",onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,onKeyup:a[64]||(a[64]=ct((a=>e.handleSearchColor(e.currentColorGroup)),["enter"]))},{prefix:Ge((()=>[Ke(o,{class:"el-input__icon"},{default:Ge((()=>[Ke(E)])),_:1})])),_:1},8,["modelValue","onFocus","onBlur"])])]),_e("div",cr,[(aa(!0),Ye(Ze,null,ga(e.searchColorList.length?e.searchColorList:(null==(l=e.editSpaceStore.myColorList.find((a=>a.id==e.currentColorGroup)))?void 0:l.list)||(null==(n=e.editSpaceStore.myColorList[0])?void 0:n.list),((a,t)=>(aa(),Ye("div",{key:t,style:da({backgroundColor:(null==a?void 0:a.color)||a,color:e.getFontColor((null==a?void 0:a.color)||a)}),class:"mycolor",title:(null==a?void 0:a.label)||"",onContextmenu:qe((l=>e.handleMenu(l,"MyColorMenu",{color:(null==a?void 0:a.color)||a,gid:e.currentColorGroup,index:t,label:(null==a?void 0:a.label)||""})),["prevent"]),onClick:t=>e.brushColor=e.handleTransformColorAsHex((null==a?void 0:a.color)||a)},la((null==a?void 0:a.label)||""),45,dr)))),128)),Xe(' <div class="mycolor flex-center" style="background-color: var(--el-bg-color-second);">\r\n                                        <el-icon color="#808080" @click="handleAdd(currentColorGroup)"><Plus /></el-icon>\r\n                                       \r\n                                    </div>\r\n                                    <el-tooltip\r\n                                    content="全部颜色 [Alt/⌥ + g]"\r\n                                    placement="bottom"\r\n                                    >\r\n                                        <div class="mycolor flex-center" style="background-color: var(--el-bg-color-second);" @click="handleOpenMyColorDialog">\r\n                                            <el-icon color="#808080"><MoreFilled /></el-icon>\r\n                                        </div>\r\n                                    </el-tooltip> ')])])):Xe("v-if",!0),Xe(' <div class="function-block function-block-between" v-if="[0, 3].includes(currentTool)">\r\n                                <span class="function-label">画笔大小</span>\r\n                                <el-slider v-model="brushSize" :step="1" :max="20" :min="1" size="small" />\r\n                            </div>\r\n                            <div class="function-block function-block-between" v-if="[0, 1].includes(currentTool)">\r\n                                <span class="function-label">橡皮擦大小</span>\r\n                                <el-slider v-model="eraserSize" :step="1" :max="20" :min="1" size="small"/>\r\n                            </div> '),_e("div",hr,[_e("div",ur,[gr,Ke(W,{modelValue:e.isCheckedRatio,"onUpdate:modelValue":a[65]||(a[65]=a=>e.isCheckedRatio=a),size:"small",label:"保持横纵比",onChange:e.handleChangeRatio,disabled:e.pinDouMode},null,8,["modelValue","onChange","disabled"])]),_e("div",pr,[Ke(H,{modelValue:e.canvasWidth,"onUpdate:modelValue":a[66]||(a[66]=a=>e.canvasWidth=a),style:{"max-width":"100px"},type:"number",max:e.$config.canvasMaxSize,min:e.$config.canvasMinSize,size:"small",onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,disabled:e.pinDouMode||e.isScaling||8===e.currentTool||e.isControlMindObj,onChange:a[67]||(a[67]=a=>e.handleChangeCanvasSize(a,"canvasWidth"))},{prepend:Ge((()=>[mr])),_:1},8,["modelValue","max","min","onFocus","onBlur","disabled"]),Ke(H,{modelValue:e.canvasHeight,"onUpdate:modelValue":a[68]||(a[68]=a=>e.canvasHeight=a),style:{"max-width":"100px"},type:"number",max:e.$config.canvasMaxSize,min:e.$config.canvasMinSize,onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,size:"small",disabled:e.pinDouMode||e.isScaling||8===e.currentTool||e.isControlMindObj,onChange:a[69]||(a[69]=a=>e.handleChangeCanvasSize(a,"canvasHeight"))},{prepend:Ge((()=>[yr])),_:1},8,["modelValue","max","min","onFocus","onBlur","disabled"])]),_e("div",fr,[Ke(W,{modelValue:e.isShowRuler,"onUpdate:modelValue":a[70]||(a[70]=a=>e.isShowRuler=a),size:"small",label:"显示标尺"},null,8,["modelValue"]),Ke(W,{modelValue:e.isShowReferenceLine,"onUpdate:modelValue":a[71]||(a[71]=a=>e.isShowReferenceLine=a),size:"small",label:"显示参考线"},null,8,["modelValue"]),Ke(W,{modelValue:e.isShowGridLine,"onUpdate:modelValue":a[72]||(a[72]=a=>e.isShowGridLine=a),size:"small",label:"显示网格线",disabled:e.layerScale<15},null,8,["modelValue","disabled"])]),Ue(_e("div",vr,[Ke(W,{modelValue:e.isHorizontal,"onUpdate:modelValue":a[73]||(a[73]=a=>e.isHorizontal=a),size:"small",label:"水平对称",disabled:e.pinDouMode,onChange:a[74]||(a[74]=a=>e.handleChangeBrushSymmetric(a,"isHorizontal"))},null,8,["modelValue","disabled"]),Ke(W,{modelValue:e.isVertical,"onUpdate:modelValue":a[75]||(a[75]=a=>e.isVertical=a),size:"small",label:"垂直对称",disabled:e.pinDouMode,onChange:a[76]||(a[76]=a=>e.handleChangeBrushSymmetric(a,"isVertical"))},null,8,["modelValue","disabled"]),Ke(W,{modelValue:e.isCenter,"onUpdate:modelValue":a[77]||(a[77]=a=>e.isCenter=a),size:"small",label:"中心对称",disabled:e.pinDouMode,onChange:a[78]||(a[78]=a=>e.handleChangeBrushSymmetric(a,"isCenter"))},null,8,["modelValue","disabled"])],512),[[Ne,[0,1,4].includes(e.currentTool)]])]),[0,3].includes(e.currentTool)?(aa(),Ye("div",Cr,[wr,Ke($,{modelValue:e.brushSize,"onUpdate:modelValue":a[79]||(a[79]=a=>e.brushSize=a),step:1,max:20,min:1,size:"small"},null,8,["modelValue"])])):Xe("v-if",!0),[0,1].includes(e.currentTool)?(aa(),Ye("div",xr,[Lr,Ke($,{modelValue:e.eraserSize,"onUpdate:modelValue":a[80]||(a[80]=a=>e.eraserSize=a),step:1,max:20,min:1,size:"small"},null,8,["modelValue"])])):Xe("v-if",!0),e.isShowGridLine?(aa(),Ye("div",Dr,[Sr,Ke($,{modelValue:e.gridGapSize,"onUpdate:modelValue":a[81]||(a[81]=a=>e.gridGapSize=a),step:1,max:100,min:1,size:"small",onChange:a[82]||(a[82]=a=>e.handleDrawGridLine(200))},null,8,["modelValue"])])):Xe("v-if",!0),e.isHorizontal?(aa(),Ye("div",br,[Ir,Ke($,{modelValue:e.XLineOffset,"onUpdate:modelValue":a[83]||(a[83]=a=>e.XLineOffset=a),step:1,max:1024,min:0,size:"small",onInput:e.handleCheckAxisOffset},null,8,["modelValue","onInput"])])):Xe("v-if",!0),e.isVertical?(aa(),Ye("div",kr,[Rr,Ke($,{modelValue:e.YLineOffset,"onUpdate:modelValue":a[84]||(a[84]=a=>e.YLineOffset=a),step:1,max:1024,min:0,size:"small",onInput:e.handleCheckAxisOffset},null,8,["modelValue","onInput"])])):Xe("v-if",!0),Xe(' <div class="function-block function-block-between" v-if="isCenter">\r\n                                <span class="function-label">对称轴偏移</span>\r\n                                <el-slider v-model="CenterLineOffset" :step="1" :max="1024" :min="0" size="small" @input="handleCheckAxisOffset"/>\r\n                            </div> '),Ue(_e("div",Mr,[Fr,Ke(V,{modelValue:e.tolerance,"onUpdate:modelValue":a[85]||(a[85]=a=>e.tolerance=a),onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,min:0,max:200,size:"small"},null,8,["modelValue","onFocus","onBlur"])],512),[[Ne,[2,4].includes(e.currentTool)||8===e.currentTool&&"quickSelect"===e.selectType]]),_e("div",Pr,[Br,Ke(V,{modelValue:e.layerAlpha,"onUpdate:modelValue":a[86]||(a[86]=a=>e.layerAlpha=a),onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,min:0,max:100,size:"small",disabled:e.pinDouMode||7===e.currentTool,onChange:e.handleChangeLayerAlpha},null,8,["modelValue","onFocus","onBlur","disabled","onChange"])]),_e("div",Ar,[Tr,Ke(V,{modelValue:e.layerScale,"onUpdate:modelValue":a[87]||(a[87]=a=>e.layerScale=a),onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,min:.1,max:e.maxScale,step:e.layerScaleStep,size:"small",onChange:e.handleSetCanvasScale},null,8,["modelValue","onFocus","onBlur","min","max","step","onChange"])]),_e("div",Or,[jr,Ke(V,{modelValue:e.layerScaleStep,"onUpdate:modelValue":a[88]||(a[88]=a=>e.layerScaleStep=a),onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,min:.05,max:2,size:"small",step:.05},null,8,["modelValue","onFocus","onBlur","min","step"])]),_e("div",Er,[Hr,Ke(V,{modelValue:e.currentPindouBlockSize,"onUpdate:modelValue":a[89]||(a[89]=a=>e.currentPindouBlockSize=a),onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,min:e.$config.minPindouBlockSize,max:e.$config.maxPindouBlockSize,size:"small",step:1},null,8,["modelValue","onFocus","onBlur","min","max"])]),_e("div",Wr,[$r,Ke(z,{modelValue:e.isEnableCanvasGrid,"onUpdate:modelValue":a[90]||(a[90]=a=>e.isEnableCanvasGrid=a),onChange:e.handleChangeCanvasGrid},null,8,["modelValue","onChange"])]),_e("div",Vr,[zr,Ke(z,{modelValue:e.isEnableCanvasSmooth,"onUpdate:modelValue":a[91]||(a[91]=a=>e.isEnableCanvasSmooth=a)},null,8,["modelValue"])]),[0,1].includes(e.currentTool)?(aa(),Ye("div",Yr,[Xr,Ke(z,{modelValue:e.isEnableEraserTrack,"onUpdate:modelValue":a[92]||(a[92]=a=>e.isEnableEraserTrack=a)},null,8,["modelValue"])])):Xe("v-if",!0),_e("div",Ur,[Nr,Ke(z,{modelValue:e.isAutoChangeBrush,"onUpdate:modelValue":a[93]||(a[93]=a=>e.isAutoChangeBrush=a)},null,8,["modelValue"])]),Xe(' <div class="function-block function-block-between flex-warp" style="gap:10px">\r\n                                <div v-if="currentTool === 8">\r\n                                    <el-button type="success" size="small" @click="handleCopySelectData" :disabled="isScaling">复 制</el-button>\r\n                                    <el-button type="danger" size="small" @click="handleRemoveSelect" :disabled="isScaling">删 除</el-button>\r\n                                    <el-button type="primary" size="small" @click="handleChangeTool(0)" :disabled="isScaling">取消选择</el-button>\r\n                                </div>\r\n                                <div v-if="currentTool === 9 || isScaling">\r\n                                    <el-button type="danger" size="small" @click="handleCancelScale">\r\n                                        <el-icon><Close /></el-icon>\r\n                                    </el-button>\r\n                                    <el-button type="success" size="small" @click="handleFinishScale">\r\n                                        <el-icon><Check /></el-icon>\r\n                                    </el-button>\r\n                                </div>\r\n                            </div> ')]))],512),[[Ne,0===e.menuType]]),Ue(_e("div",_r,[e.drawRecord.length?(aa(),Ye("div",Kr,[e.isPreview?Xe("v-if",!0):(aa(),Ye("div",Gr,[Ke(A,{placement:"bottom",width:224,visible:e.brushColorVisible&&1===e.menuType},{reference:Ge((()=>[_e("div",{style:da({backgroundColor:e.brushColor,marginLeft:"15px"}),class:"color-picker",onClick:a[94]||(a[94]=a=>e.brushColorVisible=!e.brushColorVisible)},null,4)])),default:Ge((()=>[Ke(B,{modelValue:e.brushColor,"onUpdate:modelValue":a[95]||(a[95]=a=>e.brushColor=a.hex8)},null,8,["modelValue"])])),_:1},8,["visible"]),_e("div",Jr,[e.currentFrameLayerVisible?(aa(),pa(o,{key:0,style:{"margin-right":"15px"},class:"pointer",onClick:a[96]||(a[96]=a=>e.handleChangeLayerVisible(-1))},{default:Ge((()=>[Ke(Y)])),_:1})):(aa(),pa(o,{key:1,style:{"margin-right":"15px"},class:"pointer",onClick:a[97]||(a[97]=a=>e.handleChangeLayerVisible(-1))},{default:Ge((()=>[Ke(X)])),_:1})),Ke(d,{content:"合并图层 [Ctrl/⌘ + Alt/⌥ + h]",placement:"top"},{default:Ge((()=>[Ke(o,{style:{"margin-right":"15px"},class:"pointer",onClick:e.handleLayerMerge},{default:Ge((()=>[Ke(U)])),_:1},8,["onClick"])])),_:1}),Ke(d,{content:"新建图层 [Ctrl/⌘ + Alt/⌥ + t]",placement:"top"},{default:Ge((()=>[Ke(o,{style:{"margin-right":"10px"},class:"pointer",onClick:e.handleAddLayer},{default:Ge((()=>[Ke(N)])),_:1},8,["onClick"])])),_:1})])])),e.isPreview?Xe("v-if",!0):(aa(),pa(_,{key:1,"border-style":"dashed"})),_e("div",{ref:"layerBox",id:"layer-box",class:"scrollbar scrollY full-w layer-list",onDragstart:a[102]||(a[102]=a=>e.onDragStart(a,e.pinDouMode)),onDragover:a[103]||(a[103]=a=>e.onDragOver(a,"layerBox")),onDragend:a[104]||(a[104]=a=>e.onDragLayerEnd(a,"layerBox")),style:{height:"calc(100% - 61px)"}},[Xe(' <el-dropdown\r\n                                draggable="true"\r\n                                class="full-w"\r\n                                trigger="contextmenu"\r\n                                v-for="(item, index) in drawRecord[currentFrameIndex].layer"\r\n                                :data-key="item.layerId"\r\n                                :disabled="pinDouMode"\r\n                                data-node="LI"\r\n                                :key="item.layerId" > '),(aa(!0),Ye(Ze,null,ga(e.drawRecord[e.currentFrameIndex].layer,((t,l)=>{var n;return aa(),Ye("div",{draggable:"true","data-key":t.layerId,disabled:e.pinDouMode,"data-node":"LI",key:t.layerId,class:Je(["layer-item flex-between pointer full-w",{active:e.currentLayerIndex===l,select:e.selectLayerList.includes(l)}]),style:{gap:"10px"},onContextmenu:qe((a=>e.handleMenu(a,"LayerMenu",{layerData:t.layerId,index:l,currentFrameIndex:e.currentFrameIndex})),["prevent"]),onClick:a=>e.handleChangeLayer(l)},[_e("div",Zr,[_e("div",Qr,[_e("div",ei,[_e("div",{class:"pointer layer-pic",onClick:qe((a=>e.handleChangeLayerVisible(l)),["stop"])},[_e("img",{src:e.requireVisibleImg(t.isRender)},null,8,ti)],8,ai),_e("div",li,[_e("img",{draggable:"false",src:t.currentLayerImg,class:"layer-image"},null,8,ni)]),e.currentEditLayer.index!==l||e.isPreview?(aa(),Ye("div",{key:1,onDblclick:a=>e.handleDoubleClickLayer(l,t.layerName),title:t.layerName,class:"oneline"},la(t.layerName),41,ii)):(aa(),Ye("div",ri,[Ke(H,{modelValue:e.currentEditLayer.name,"onUpdate:modelValue":a[98]||(a[98]=a=>e.currentEditLayer.name=a),maxlength:10,onClick:qe((e=>null),["stop"]),onBlur:e.handleEditLayerName,onKeyup:ct(e.handleEditLayerName,["enter"]),placeholder:"请输入图层名称",size:"small"},null,8,["modelValue","onClick","onBlur","onKeyup"])]))]),e.isPreview?Xe("v-if",!0):(aa(),Ye("div",oi,[t.isLock?(aa(),pa(o,{key:0,color:"#ff0000",class:"pointer",onClick:qe((a=>e.handleLockLayer(l,!1)),["stop"])},{default:Ge((()=>[Ke(K)])),_:2},1032,["onClick"])):(aa(),pa(o,{key:1,class:"pointer",onClick:qe((a=>e.handleLockLayer(l,!0)),["stop"])},{default:Ge((()=>[Ke(G)])),_:2},1032,["onClick"])),Ke(o,{class:"pointer",onClick:qe((a=>e.handleCopyLayer(l)),["stop"])},{default:Ge((()=>[Ke(J)])),_:2},1032,["onClick"]),Ke(Z,{title:"确认删除该图层？",width:"200",onConfirm:a=>e.handleDeleteLayer(l)},{reference:Ge((()=>[l!==e.drawRecord[e.currentFrameIndex].layer.length-1?(aa(),pa(o,{key:0,class:"pointer",onClick:a[99]||(a[99]=qe((()=>{}),["stop"]))},{default:Ge((()=>[Ke(q)])),_:1})):Xe("v-if",!0)])),_:2},1032,["onConfirm"]),t.mindLayerList.length?(aa(),Ye(Ze,{key:2},[t.isExpandMindList?Xe("v-if",!0):(aa(),pa(o,{key:0,class:"pointer",onClick:e=>t.isExpandMindList=!0},{default:Ge((()=>[Ke(Q)])),_:2},1032,["onClick"])),t.isExpandMindList?(aa(),pa(o,{key:1,class:"pointer",onClick:e=>t.isExpandMindList=!1},{default:Ge((()=>[Ke(ee)])),_:2},1032,["onClick"])):Xe("v-if",!0)],64)):Xe("v-if",!0)]))]),t.mindLayerList.length&&t.isExpandMindList&&(null==(n=e.layerCrossList[t.layerId])?void 0:n.mindLayerList)?(aa(),Ye("div",si,[Ke(le,null,{default:Ge((()=>[(aa(!0),Ye(Ze,null,ga(t.mindLayerList,((n,r)=>(aa(),pa(te,{key:n,center:"",type:"success",hollow:"","hide-timestamp":!0,placement:"top"},{default:Ge((()=>{var i,s,c,d;return[_e("div",ci,[_e("div",di,[e.layerCrossList[t.layerId].mindLayerList[n]?(aa(),Ye("div",{key:0,class:"pointer layer-pic",onClick:qe((a=>e.handleChangeLayerMindVisible(n,t.layerId)),["stop"])},[_e("img",{src:e.requireVisibleImg(!e.layerCrossList[t.layerId].mindLayerList[n].isHide)},null,8,ui),Xe(' <el-icon color="#ff0000" class="pointer" v-if="value.isLock" @click.stop="handleLockMindObj(index, mindIndex, false)"><Lock /></el-icon>\r\n                                                                    <el-icon class="pointer" v-else @click.stop="handleLockMindObj(index, mindIndex, true)"><Unlock /></el-icon> ')],8,hi)):Xe("v-if",!0),e.layerCrossList[t.layerId].mindLayerList[n]?(aa(),Ye("div",gi,[_e("img",{draggable:"false",src:e.layerCrossList[t.layerId].mindLayerList[n].mindObj},null,8,pi)])):Xe("v-if",!0),e.currentEditLayer.mindIndex!==n||e.isPreview?(aa(),Ye("div",{key:3,onDblclick:a=>{var l,r;return e.handleDoubleClickLayerMind(n,null==(r=null==(l=e.layerCrossList[t.layerId])?void 0:l.mindLayerList[n])?void 0:r.mindName)},title:null==(s=null==(i=e.layerCrossList[t.layerId])?void 0:i.mindLayerList[n])?void 0:s.mindName,class:"oneline"},la(null==(d=null==(c=e.layerCrossList[t.layerId])?void 0:c.mindLayerList[n])?void 0:d.mindName),41,yi)):(aa(),Ye("div",mi,[Ke(H,{modelValue:e.currentEditLayer.mindName,"onUpdate:modelValue":a[100]||(a[100]=a=>e.currentEditLayer.mindName=a),maxlength:10,onClick:qe((e=>null),["stop"]),onBlur:e.handleEditLayerMindName,onKeyup:ct(e.handleEditLayerMindName,["enter"]),placeholder:"请输入名称",size:"small"},null,8,["modelValue","onClick","onBlur","onKeyup"])]))]),e.isPreview?Xe("v-if",!0):(aa(),Ye("div",fi,[Xe(' <el-icon color="#ff0000" class="pointer" v-if="item.isLock" @click.stop="handleLockLayer(index, false)"><Lock /></el-icon>\r\n                                                                <el-icon class="pointer" v-else @click.stop="handleLockLayer(index, true)"><Unlock /></el-icon>\r\n                                                                <el-icon class="pointer" @click.stop="handleCopyLayer(index)"><CopyDocument /></el-icon> '),Ke(o,{onClick:qe((a=>e.handleSelectMindObj(n,l,r)),["stop"]),color:e.currentSelectMindId===n&&e.currentLayerId===t.layerId?"#ff0000":""},{default:Ge((()=>[Ke(m)])),_:2},1032,["onClick","color"]),Ke(Z,{title:"确认删除该智能对象？",width:"240",onConfirm:a=>e.handleDeleteLayerMind(r,t.layerId)},{reference:Ge((()=>[Ke(o,{class:"pointer"},{default:Ge((()=>[Ke(q)])),_:1})])),_:2},1032,["onConfirm"]),Ke(x,null,{dropdown:Ge((()=>[Ke(w,null,{default:Ge((()=>[Ke(C,{onClick:a=>e.handleMindToPixel(1,n,r,t.layerId)},{default:Ge((()=>[vi])),_:2},1032,["onClick"]),Ke(C,{onClick:a=>e.handleCopyMindObj(n,r,t.layerId,l)},{default:Ge((()=>[Ci])),_:2},1032,["onClick"]),Ke(C,{onClick:a=>e.handleSaveMindForSprite(n,t.layerId)},{default:Ge((()=>[wi])),_:2},1032,["onClick"]),Xe(" <el-dropdown-item @click=\"handleChangeLayerMindVisible(mindIndex)\">{{value.isHide ? '显 示' : '隐 藏'}}</el-dropdown-item> ")])),_:2},1024)])),default:Ge((()=>[Ke(o,{onClick:a[101]||(a[101]=qe((()=>{}),["stop"]))},{default:Ge((()=>[Ke(ae)])),_:1})])),_:2},1024)]))])]})),_:2},1024)))),128))])),_:2},1024)])):Xe("v-if",!0)])],42,qr)})),128)),Xe(' <template #dropdown>\r\n                                        <el-dropdown-menu>\r\n                                            <el-dropdown-item @click="handleImportLayer(index)">导入图像</el-dropdown-item>\r\n                                            <el-dropdown-item @click="handleExportLayer(currentFrameIndex, index)">导出为图像</el-dropdown-item>\r\n                                        </el-dropdown-menu>\r\n                                    </template>\r\n                                </el-dropdown> ')],544)])):Xe("v-if",!0)],512),[[Ne,1===e.menuType]])])]})),_:1},8,["onClick"]),[[Ne,!e.pinDouMode]]),Ue(_e("div",xi,[Li,(aa(!0),Ye(Ze,null,ga(e.pindouBlockList,((a,t)=>(aa(),Ye("div",{key:t,onClick:a=>e.handleChangePindouBlock(t),class:Je(["pindou-item pointer",{active:e.currentPindouIndex===t,isNotAllowed:e.loading}])},[a.blockBitmap?(aa(),Ye("img",{key:0,draggable:"false",src:a.blockBitmap},null,8,Si)):Xe("v-if",!0)],10,Di)))),128))],512),[[Ne,e.pinDouMode]]),e.pinDouMode?(aa(),Ye("div",bi,[Ii,(aa(!0),Ye(Ze,null,ga(e.drawRecord[e.currentFrameIndex].layer,((a,t)=>(aa(),Ye("div",{key:t,onClick:a=>e.handleChangeLayer(t),class:Je(["pindou-item pointer",{active:e.currentLayerIndex===t,isNotAllowed:e.loading}])},[_e("img",{draggable:"false",src:a.currentLayerImg},null,8,Ri)],10,ki)))),128))])):Xe("v-if",!0)])),_:1}),(aa(),pa(st,{to:"body"},[Ke(ie,{ref:"MyColorDialog",selected:e.editSpaceStore.currentSelectWindow,onClose:e.addKeyBoardEvent,onDelete:a[105]||(a[105]=a=>e.currentColorGroup="1"),onSelect:a[106]||(a[106]=a=>e.brushColor=a)},null,8,["selected","onClose"]),Ke(oe,{ref:"SpriteDialog",selected:e.editSpaceStore.currentSelectWindow,onImport:e.handleImportSprite},null,8,["selected","onImport"]),Ke(se,{onClose:e.addKeyBoardEvent,selected:e.editSpaceStore.currentSelectWindow,ref:"ReplaceColorDialog",onConfirm:e.handleConfirmReplaceColor},null,8,["onClose","selected","onConfirm"]),Ke(ce,{onClose:e.addKeyBoardEvent,selected:e.editSpaceStore.currentSelectWindow,ref:"CanvasRotateDialog",onConfirm:e.handleConfirmCanvasRotate},null,8,["onClose","selected","onConfirm"]),Ke(de,{ref:"IntelligentStrokeDialog",selected:e.editSpaceStore.currentSelectWindow,onConfirm:e.handleIntelligentStroke,onClose:e.addKeyBoardEvent},null,8,["selected","onConfirm","onClose"]),Ke(he,{ref:"IntelligentSliceDialog",selected:e.editSpaceStore.currentSelectWindow,visible:e.intelligentSliceVisible,canvasOptions:e.intelligentSliceOptions,onConfirm:e.handleExportIntelligentSlice,onChange:e.handleIntelligentSlice,onClose:e.handleCloseIntelligentSlice},null,8,["selected","visible","canvasOptions","onConfirm","onChange","onClose"]),e.exportVisible?(aa(),pa(ue,{key:0,loading:e.exportLoaidng,visible:e.exportVisible,isExportProject:e.isExportProject,exportSingleImage:e.exportSingleImage,canvasOptions:{canvasWidth:e.canvasWidth,canvasHeight:e.canvasHeight,projectData:e.projectData},onExport:e.handleExport,onClose:a[107]||(a[107]=a=>e.handleCloseDialog("exportVisible"))},null,8,["loading","visible","isExportProject","exportSingleImage","canvasOptions","onExport"])):Xe("v-if",!0),Ke(ge,{ref:"PreviewAnimDialog"},null,512),Ke(pe,{ref:"PindouDialog",selected:e.editSpaceStore.currentSelectWindow,canvasOptions:{width:e.pindouBlockWidth,height:e.pindouBlockHeight,isLargeCanvas:1},onChangeGrid:e.handleDrawPindouGridLine,onChangeReferenceLine:e.handleDrawPindouReferenceLine,onChangeRuler:e.handleDrawPindouRuler,onChangeShadow:e.handleDrawPindouShadow,onChangeAllBlock:a[108]||(a[108]=a=>e.isUpdateAllBlock=a),onChangeBrushMode:a[109]||(a[109]=a=>e.isEnablePindouBrushMode=a),onChangeEraserMode:a[110]||(a[110]=a=>e.isEnablePindouEraserMode=a),onBlockHighlight:e.handlePindouBlockHighlight,onClose:e.handleCloseDialog,onChange:e.handlePindouEvent,onReplace:e.handleReplacePindouColor,onHighlight:e.handlePindouHighlight,onSelect:e.handleChangeBrushColor,onRemoveKeyBoard:e.handleCancelKeyboardEvent,onAddKeyBoard:e.addKeyBoardEvent,onHide:a[111]||(a[111]=a=>e.isHidePindouMode=!0),onExportExcel:e.handleExportPindouToExcel,onSave:e.handleTransformColorToPindou,onExport:e.handleExportPindou},null,8,["selected","canvasOptions","onChangeGrid","onChangeReferenceLine","onChangeRuler","onChangeShadow","onBlockHighlight","onClose","onChange","onReplace","onHighlight","onSelect","onRemoveKeyBoard","onAddKeyBoard","onExportExcel","onSave","onExport"]),e.LayerMenu.visible&&!e.isPreview?(aa(),pa(me,{key:1,visible:e.LayerMenu.visible,left:e.LayerMenu.left,top:e.LayerMenu.top,contextData:e.LayerMenu.contextData,onCopy:e.handleCopyLayerData,onPixel:a[112]||(a[112]=a=>e.handleMindToPixel(0)),onPaste:e.handlePasteLayerData,onImport:e.handleImportImage,onSaveSprite:e.handleSaveSprite,onSaveMind:e.handleSaveMind,onExport:a[113]||(a[113]=a=>e.handleExportDialog(!1,"layer",e.currentLayerIndex))},null,8,["visible","left","top","contextData","onCopy","onPaste","onImport","onSaveSprite","onSaveMind"])):Xe("v-if",!0),e.MyColorMenu.visible?(aa(),pa(ye,{key:2,visible:e.MyColorMenu.visible,left:e.MyColorMenu.left,top:e.MyColorMenu.top,contextData:e.MyColorMenu.contextData,onCopy:a[114]||(a[114]=a=>e.handleCopyColor(a)),onEdit:e.handleEditMyColor,onDelete:e.handleDeleteMyColor},null,8,["visible","left","top","contextData","onEdit","onDelete"])):Xe("v-if",!0),Ke(fe,{ref:"LinmoModeDialog",selected:e.editSpaceStore.currentSelectWindow,onClose:e.handleCloseDialog,onUpload:a[115]||(a[115]=a=>e.linmoPhoto=a),onUpdate:a[116]||(a[116]=a=>e.linmoPhotoStyle=a),onColor:a[117]||(a[117]=a=>e.brushColor=a),onHide:a[118]||(a[118]=a=>e.isHideLinmoMode=!0),onLock:e.handleLinmoFitCanvas,onHigh:a[119]||(a[119]=a=>e.isHighPreview=a)},null,8,["selected","onClose","onLock"]),e.importLayerVisible?(aa(),pa(ve,{key:3,visible:e.importLayerVisible,canvasOptions:{canvasWidth:e.canvasWidth,canvasHeight:e.canvasHeight},onImport:e.handleImportImageLayer,onClose:a[120]||(a[120]=a=>e.handleCloseDialog("importLayerVisible"))},null,8,["visible","canvasOptions","onImport"])):Xe("v-if",!0),Ke(Le,{modelValue:e.addMyColorVisible,"onUpdate:modelValue":a[128]||(a[128]=a=>e.addMyColorVisible=a),width:"300",title:e.editMyColorMask?"修改颜色":"添加颜色","append-to-body":"",class:"z-dialog"},{footer:Ge((()=>[_e("div",Oi,[Ke(S,{onClick:a[127]||(a[127]=a=>e.addMyColorVisible=!1)},{default:Ge((()=>[ji])),_:1}),Ke(S,{type:"primary",onClick:e.handleAddColor},{default:Ge((()=>[Ei])),_:1},8,["onClick"])])])),default:Ge((()=>[_e("div",Mi,[Ke(Ce,{modelValue:e.myColor,"onUpdate:modelValue":a[121]||(a[121]=a=>e.myColor=a),"show-alpha":""},null,8,["modelValue"]),Ke(xe,{modelValue:e.myColorGroup,"onUpdate:modelValue":a[125]||(a[125]=a=>e.myColorGroup=a),placeholder:"选择分组",style:{width:"200px"}},{footer:Ge((()=>[e.isAddGroup?(aa(),Ye(Ze,{key:1},[Ke(H,{modelValue:e.myGroupName,"onUpdate:modelValue":a[123]||(a[123]=a=>e.myGroupName=a),class:"option-input",placeholder:"请输入分组",size:"small",maxlength:"10"},null,8,["modelValue"]),_e("div",Pi,[Ke(S,{size:"small",onClick:a[124]||(a[124]=a=>{e.myGroupName="",e.isAddGroup=!1})},{default:Ge((()=>[Bi])),_:1}),Ke(S,{type:"primary",size:"small",onClick:e.addColorGroup},{default:Ge((()=>[Ai])),_:1},8,["onClick"])])],64)):(aa(),pa(S,{key:0,text:"",bg:"",size:"small",onClick:a[122]||(a[122]=a=>e.isAddGroup=!0)},{default:Ge((()=>[Fi])),_:1}))])),default:Ge((()=>[(aa(!0),Ye(Ze,null,ga(e.editSpaceStore.myColorList,(e=>(aa(),pa(we,{key:e.id,label:e.groupName,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])]),_e("div",Ti,[Ke(H,{modelValue:e.myColorLabel,"onUpdate:modelValue":a[126]||(a[126]=a=>e.myColorLabel=a),placeholder:"请输入颜色名称"},null,8,["modelValue"])])])),_:1},8,["modelValue","title"])]))],4)}],["__scopeId","data-v-8db1fb3e"],["__file","D:/project/pixel-grid/src/views/draw/index.vue"]]);export{Hi as default};
