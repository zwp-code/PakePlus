var e=Object.defineProperty,o=Object.defineProperties,s=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,t=Object.prototype.propertyIsEnumerable,l=(o,s,n)=>s in o?e(o,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[s]=n,r=(e,o)=>{for(var s in o||(o={}))a.call(o,s)&&l(e,s,o[s]);if(n)for(var s of n(o))t.call(o,s)&&l(e,s,o[s]);return e};import{d as i,y as c,r as d,o as u,M as g,R as p,t as f,U as m,c as b,g as v,_ as h,u as I,$ as y,b as w,e as k,n as C,J as x,j as _,F as $,x as E,k as U,h as L,V as P,X as j,l as Q,p as q,f as B,s as O,W as M,T as R}from"./index-7e9c327e.js";import{F as S,u as F,Q as T,q as A}from"./qq-06eb59da.js";import{v as D,g as V}from"./validator-16ef0ed0.js";import{l as G}from"./logo-145c6dfc.js";import{b as N}from"./boy-60d2a964.js";import{_ as z}from"./plugin-vue_export-helper-46f75680.js";var J=i({name:"login",components:{ForgetPasswordDialog:S},props:{},emits:[],setup(e,n){const a=F(),t=c(),{proxy:l}=v();let i=d({loginInfo:{username:"",password:""},logonInfo:{username:"",password:"",sex:"0",nickname:""},isLogon:!1,isloading:!1,isRemeber:!1,forgetPasswordVisible:!1}),w={async handleQQLogin(){try{if(l.$utils.cache.qqInfo.get())return;const e=h(location.href);if(!e.access_token)return;const o=await a.getOpenId(e.access_token);if(!o.data.content||!o.data)return;let s=o.data.content,n={accessToken:s.accessToken,openId:s.openId};l.$utils.cache.qqInfo.set(JSON.stringify(n));const r=s.userData;let i="QQ"+n.openId;n.password=l.$utils.secret.MD5(i);const c=l.$bmob.Query("User");c.equalTo("username","==",n.openId),c.equalTo("password","==",n.password),c.limit(1),c.select(...l.$config.UserField),c.find(!1).then((async e=>{if(e.length){if("0"===e[0].isEnable)return void l.$message.warning("账号异常，无法登陆");w.handleClose();let o=e[0];o.browserId||(o.browserId="0"),o.vip||(o.vip="0"),o.vipEndAt||(o.vipEndAt="0"),o.backupCount||(o.backupCount="0"),o.extraBackupCount||(o.extraBackupCount="0"),t.saveUserInfo(o),l.$message.success("登陆成功")}else w.handleQQLogon(n,r)})).catch((e=>{l.$message.error("登录失败")}))}catch(e){t.saveErrorToBmob("QQ登录",e)}},async handleQQLogon(e,o){i.logonInfo.username=e.openId,i.logonInfo.password=e.password,i.logonInfo.avatar=o.figureurl_2,i.logonInfo.nickname=o.nickname,i.logonInfo.sex="2"==o.gender_type?"0":"1";let s=Object.keys(i.logonInfo);const n=l.$bmob.Query("User");for(let t=0;t<s.length;t++){let e=s[t];n.set(e,i.logonInfo[e])}n.set("platform","2"),n.set("vip","0"),n.set("vipEndAt","0"),n.set("browserId",t.browserId),n.set("backupCount","0"),n.set("avatarUpdatedAt",""),n.set("nameUpdatedAt",""),n.set("uid",I.v4()),n.set("isEnable","1");const a=l.$bmob.Query("User"),r=await a.count();n.set("rank",r.count+1),n.save().then((async e=>{i.logonInfo.objectId=e.objectId;try{i.logonInfo=await t.getRemoteUserInfo(l,e.objectId),w.handleClose(),t.saveUserInfo(i.logonInfo),l.$message.success("登录成功")}catch(o){delete i.logonInfo.password,w.handleClose(),t.saveUserInfo(i.logonInfo)}})).catch((e=>{l.$message.error("登录失败")}))},async handleqqLogin(){try{T.Login.showPopup({appId:l.$config.QQ_APP_ID,redirectURI:"https://pg.zwpyyds.com/about"})}catch(e){}},handleGoogleLogin(e){const o=y(e.credential);i.isloading=!0;let s=o.sub,n="Google"+o.sub;const a=l.$bmob.Query("User");a.equalTo("username","==",s),a.equalTo("password","==",l.$utils.secret.MD5(n)),a.limit(1),a.select(...l.$config.UserField),a.find(!1).then((async e=>{if(e.length){if("0"===e[0].isEnable)return void l.$message.warning("账号异常，无法登陆");w.handleClose(),i.isloading=!1;let o=e[0];o.browserId||(o.browserId="0"),o.vip||(o.vip="0"),o.vipEndAt||(o.vipEndAt="0"),o.backupCount||(o.backupCount="0"),o.extraBackupCount||(o.extraBackupCount="0"),t.saveUserInfo(o),l.$message.success("登陆成功")}else{i.logonInfo.username=s,i.logonInfo.password=n,i.logonInfo.avatar=o.picture,i.logonInfo.nickname=o.family_name+o.given_name;let e=Object.keys(i.logonInfo);for(let o=0;o<e.length;o++){let s=e[o];if("password"===s){let e=l.$utils.secret.MD5(i.logonInfo[s]);a.set(s,e)}else a.set(s,i.logonInfo[s])}a.set("platform","1"),a.set("vip","0"),a.set("vipEndAt","0"),a.set("browserId",t.browserId),a.set("backupCount","0"),a.set("avatarUpdatedAt",""),a.set("nameUpdatedAt",""),a.set("uid",I.v4()),a.set("isEnable","1");const r=l.$bmob.Query("User"),c=await r.count();a.set("rank",c.count+1),a.save().then((async e=>{i.logonInfo.objectId=e.objectId;try{i.logonInfo=await t.getRemoteUserInfo(l,e.objectId),w.handleClose(),i.isloading=!1,t.saveUserInfo(i.logonInfo),l.$message.success("登录成功")}catch(o){delete i.logonInfo.password,w.handleClose(),t.saveUserInfo(i.logonInfo),i.isloading=!1}})).catch((e=>{i.isloading=!1,l.$message.error("登录失败")}))}})).catch((e=>{i.isloading=!1,l.$message.error("登录失败")}))},handleChangeRemeber(e){i.isRemeber=e.target.checked},handleGo(){w.handleClose(),l.$router.push("/project")},handleClose(){l.$router.options.history.state.back&&""!==l.$router.options.history.state.back?l.$router.back():l.$router.push("/about"),setTimeout((()=>{i.isLogon=!1}),1e3)},handleCheck(e){let o=!1;for(let s in e)if(""===e[s]){o=!0;break}return o},handleRemeber(){if(i.isRemeber){let e=r({},i.loginInfo);e.password=l.$utils.secret.Encrypt(e.password),l.$utils.cache.user.set(JSON.stringify(e))}else l.$utils.cache.user.remove()},handleLogin(){if(w.handleCheck(i.loginInfo))return l.$message.warning("请填写完整信息");i.isloading=!0;const e=l.$bmob.Query("User");e.equalTo("username","==",i.loginInfo.username),e.equalTo("password","==",l.$utils.secret.MD5(i.loginInfo.password)),e.limit(1),e.select(...l.$config.UserField),e.find(!1).then((e=>{if(i.isloading=!1,e.length){if("0"===e[0].isEnable)return void l.$message.warning("账号异常，无法登陆");w.handleRemeber(),w.handleClose();let o=e[0];return o.browserId||(o.browserId="0"),o.vip||(o.vip="0"),o.vipEndAt||(o.vipEndAt="0"),o.backupCount||(o.backupCount="0"),o.extraBackupCount||(o.extraBackupCount="0"),t.saveUserInfo(o),t.getProjectList(),void l.$message.success("登陆成功")}l.$message.warning("用户名或密码错误")})).catch((e=>{i.isloading=!1,l.$message.error("登录失败")}))},async handleLogon(){try{const e=D.validateEmpty(i.logonInfo),o=D.validateUserName(i.logonInfo.username),s=D.validateNickname(i.logonInfo.nickname),n=D.validatePwd(i.logonInfo.password);await Promise.all([e,o,n,s]).catch((e=>{throw l.$message.warning(e.message),new Error(e.message)})),i.isloading=!0;const a=l.$bmob.Query("User");a.equalTo("username","==",i.logonInfo.username),a.limit(1),a.select("username","browserId"),a.find().then((async e=>{if(e.results.length)return i.isloading=!1,l.$message.warning("用户名已存在");let o=Object.keys(i.logonInfo);for(let t=0;t<o.length;t++){let e=o[t];if("password"===e){let o=l.$utils.secret.MD5(i.logonInfo[e]);a.set(e,o)}else a.set(e,i.logonInfo[e])}a.set("platform","0"),a.set("vip","0"),a.set("vipEndAt","0"),a.set("browserId",t.browserId),a.set("backupCount","0"),a.set("avatar",""),a.set("avatarUpdatedAt",""),a.set("nameUpdatedAt",""),a.set("uid",I.v4()),a.set("isEnable","1");const s=l.$bmob.Query("User"),n=await s.count();a.set("rank",n.count+1),a.save().then((async e=>{i.logonInfo.objectId=e.objectId;try{i.logonInfo=await t.getRemoteUserInfo(l,e.objectId),t.saveUserInfo(i.logonInfo),l.$message.success("注册成功"),i.isloading=!1}catch(o){delete i.logonInfo.password,i.logonInfo.avatar="",t.saveUserInfo(i.logonInfo),i.isloading=!1}})).catch((e=>{i.isloading=!1,l.$message.error("注册失败"),t.saveErrorToBmob("注册",e)}))})).catch((e=>{l.$message.error("注册失败"),t.saveErrorToBmob("注册",e)}))}catch(e){}finally{i.isloading=!1}},handleFocusPassword(){let e=document.getElementById("face");e&&(e.style.transform="translateX(-30px)");const o=document.getElementsByClassName("eye");for(let s of o)s.style.transform="rotate(-100deg)"},handleFocusOutPassword(e){var o,s;let n=document.getElementById("face");if(n&&(n.style.transform="translateX(0)"),e.target.checkValidity())null==(o=document.getElementById("ball"))||o.classList.toggle("sad");else{null==(s=document.getElementById("ball"))||s.classList.toggle("sad");const e=document.getElementsByClassName("eye");for(let o of e)o.style.transform="rotate(215deg)"}},handleMouseMove(e){if(!document.querySelector("#password:is(:focus)")&&!document.querySelector("#password:is(:user-invalid)")){const o=document.getElementsByClassName("eye");for(let s of o){const o=s.getBoundingClientRect().left+10,n=s.getBoundingClientRect().top+10,a=Math.atan2(e.pageX-o,e.pageY-n)*(180/Math.PI)*-1+180;s.style.transform=`rotate(${a}deg)`}}},handleToggleFace(){var e;null==(e=document.getElementById("ball"))||e.classList.toggle("look_at")}};return u((()=>{document.addEventListener("mousemove",w.handleMouseMove);let e=l.$utils.cache.user.get();if(e){i.isRemeber=!0;let o=JSON.parse(e);o.password=l.$utils.secret.Decrypt(o.password),i.loginInfo=o}})),g((()=>{document.removeEventListener("mousemove",w.handleMouseMove)})),p((()=>{if(i.isLogon)for(let e in i.logonInfo)i.logonInfo[e]="","sex"===e&&(i.logonInfo[e]="0")})),k=r(r({},f(i)),w),o(k,s({editSpaceStore:t,checkIsPGComEnv:m,checkIsClientEnv:b}));var k}});const X={class:"main"},H={class:"form"},W={class:"logo"},Y=["src"],K={class:"login"},Z={class:"form__title text-center"},ee={key:0,class:"login-body flex-column-center"},oe={class:"input-search"},se={class:"input-search"},ne={class:"flex-between full-w",style:{padding:"0 10px","font-size":"14px"}},ae={class:"flex"},te={class:"checkbox-container"},le=["checked"],re={class:"flex-center"},ie={class:"flex",style:{gap:"10px","font-size":"14px"}},ce={key:0,class:"full-w text-center",style:{color:"#808080","font-size":"14px"}},de=["src"],ue={key:1,class:"login-body logon-body flex-column-center"},ge={class:"input-search"},pe={class:"input-search"},fe={class:"input-search"},me={class:"sex-select flex-between"},be=["src"],ve=["src"],he={class:"flex",style:{gap:"10px","font-size":"14px"}},Ie={class:"flex-between login-dialog-header"},ye={key:0,class:"welcome-body flex-column-center text-center"},we={key:1,class:"welcome-body flex-column-center text-center"},ke={class:"close flex-center"};var Ce=z(J,[["render",function(e,o,s,n,a,t){const l=w("User"),r=w("el-icon"),i=w("Lock"),c=w("el-link"),d=w("el-button"),u=w("GoogleLogin"),g=w("EditPen"),p=w("CloseBold"),f=w("ForgetPasswordDialog");return k(),C("div",X,[o[28]||(o[28]=x('<section class="form__animation" data-v-7034b40d><div id="ball" data-v-7034b40d><div class="ball" data-v-7034b40d><div id="face" data-v-7034b40d><div class="ball__eyes" data-v-7034b40d><div class="eye_wrap" data-v-7034b40d><span class="eye" data-v-7034b40d></span></div><div class="eye_wrap" data-v-7034b40d><span class="eye" data-v-7034b40d></span></div></div><div class="ball__mouth" data-v-7034b40d></div></div></div></div><div class="ball__shadow" data-v-7034b40d></div></section>',1)),_("section",H,[_("div",W,[_("img",{src:G},null,8,Y)]),_("div",K,[e.editSpaceStore.isLogin?e.editSpaceStore.isLogin&&e.isLogon?(k(),C($,{key:1},[_("div",Ie,[o[26]||(o[26]=_("p",null,"欢 迎",-1)),U(r,{onClick:M(e.handleClose,["stop"])},{default:L((()=>[U(p)])),_:1},8,["onClick"])]),e.editSpaceStore.userData.rank&&e.editSpaceStore.userData.rank>0?(k(),C("div",ye," 欢迎加入像素格子，您将成为像素格子的第"+E(e.editSpaceStore.userData.rank)+"位用户，快去创作属于自己的像素艺术吧！ ",1)):(k(),C("div",we," 欢迎加入像素格子，快去创作属于自己的像素艺术吧！ ")),U(d,{type:"primary",style:{"border-radius":"10px"},class:"full-w",onClick:e.handleGo},{default:L((()=>o[27]||(o[27]=[Q("去创作")]))),_:1,__:[27]},8,["onClick"])],64)):q("",!0):(k(),C($,{key:0},[_("h1",Z,E(e.isLogon?"注 册":"登 录"),1),o[25]||(o[25]=_("p",{class:"form__description"},"欢迎回来，请填写你的信息",-1)),e.isLogon?(k(),C("div",ue,[_("div",ge,[U(r,null,{default:L((()=>[U(l)])),_:1}),P(_("input",{type:"text","onUpdate:modelValue":o[8]||(o[8]=o=>e.logonInfo.username=o),placeholder:"请输入用户名"},null,512),[[j,e.logonInfo.username]])]),_("div",pe,[U(r,null,{default:L((()=>[U(i)])),_:1}),P(_("input",{type:"password","onUpdate:modelValue":o[9]||(o[9]=o=>e.logonInfo.password=o),placeholder:"请输入密码"},null,512),[[j,e.logonInfo.password]])]),_("div",fe,[U(r,null,{default:L((()=>[U(g)])),_:1}),P(_("input",{"onUpdate:modelValue":o[10]||(o[10]=o=>e.logonInfo.nickname=o),placeholder:"请输入昵称"},null,512),[[j,e.logonInfo.nickname]])]),_("div",me,[_("div",{class:O(["sex-item",{active:"0"==e.logonInfo.sex}]),onClick:o[11]||(o[11]=o=>e.logonInfo.sex="0")},[_("img",{src:N},null,8,be)],2),_("div",{class:O(["sex-item",{active:"1"==e.logonInfo.sex}]),onClick:o[12]||(o[12]=o=>e.logonInfo.sex="1")},[_("img",{src:V},null,8,ve)],2)]),U(d,{type:"primary",style:{"border-radius":"10px"},class:"full-w",onClick:e.handleLogon,loading:e.isloading},{default:L((()=>o[22]||(o[22]=[Q("注 册")]))),_:1,__:[22]},8,["onClick","loading"]),_("p",he,[o[24]||(o[24]=Q("已有账号？ ")),U(c,{type:"success",underline:!1,onClick:o[13]||(o[13]=o=>e.isLogon=!1)},{default:L((()=>o[23]||(o[23]=[Q("去登录")]))),_:1,__:[23]})])])):(k(),C("div",ee,[_("div",oe,[U(r,null,{default:L((()=>[U(l)])),_:1}),P(_("input",{type:"text","onUpdate:modelValue":o[0]||(o[0]=o=>e.loginInfo.username=o),placeholder:"请输入用户名"},null,512),[[j,e.loginInfo.username]])]),_("div",se,[U(r,null,{default:L((()=>[U(i)])),_:1}),P(_("input",{type:"password","onUpdate:modelValue":o[1]||(o[1]=o=>e.loginInfo.password=o),placeholder:"请输入密码",onBlur:o[2]||(o[2]=(...o)=>e.handleFocusOutPassword&&e.handleFocusOutPassword(...o)),onFocus:o[3]||(o[3]=(...o)=>e.handleFocusPassword&&e.handleFocusPassword(...o))},null,544),[[j,e.loginInfo.password]])]),_("div",ne,[_("div",ae,[_("label",te,[_("input",{class:"custom-checkbox",checked:e.isRemeber,type:"checkbox",onChange:o[4]||(o[4]=(...o)=>e.handleChangeRemeber&&e.handleChangeRemeber(...o))},null,40,le),o[15]||(o[15]=_("span",{class:"checkmark"},null,-1))]),o[16]||(o[16]=Q(" 记住我 "))]),_("div",re,[U(c,{type:"success",underline:!1,onClick:o[5]||(o[5]=o=>e.forgetPasswordVisible=!0)},{default:L((()=>o[17]||(o[17]=[Q("忘记密码")]))),_:1,__:[17]})])]),U(d,{type:"primary",class:"full-w",style:{"border-radius":"10px"},onClick:e.handleLogin,loading:e.isloading,onMouseover:e.handleToggleFace,onMouseout:e.handleToggleFace},{default:L((()=>o[18]||(o[18]=[Q("登 录")]))),_:1,__:[18]},8,["onClick","loading","onMouseover","onMouseout"]),_("p",ie,[o[20]||(o[20]=Q("没有账号？ ")),U(c,{type:"success",underline:!1,onClick:o[6]||(o[6]=o=>e.isLogon=!0)},{default:L((()=>o[19]||(o[19]=[Q("去注册")]))),_:1,__:[19]})]),!e.checkIsClientEnv()&&e.checkIsPGComEnv()?(k(),C("p",ce," - OR -")):q("",!0),!e.checkIsClientEnv()&&e.checkIsPGComEnv()?(k(),C("div",{key:1,class:"qq",onClick:o[7]||(o[7]=(...o)=>e.handleqqLogin&&e.handleqqLogin(...o))},[_("div",null,[_("img",{src:A,alt:"QQ登录"},null,8,de)]),o[21]||(o[21]=Q(" 用QQ账号登录 "))])):q("",!0),e.checkIsClientEnv()?q("",!0):(k(),B(u,{key:2,callback:e.handleGoogleLogin,class:"scrollHidden",style:{"border-radius":"10px",padding:"2px"}},null,8,["callback"]))]))],64)),(k(),B(R,{to:"body"},[e.forgetPasswordVisible?(k(),B(f,{key:0,style:{"z-index":"2001"},visible:e.forgetPasswordVisible,onClose:o[14]||(o[14]=o=>e.forgetPasswordVisible=!1)},null,8,["visible"])):q("",!0)]))])]),_("div",ke,[U(r,{onClick:M(e.handleClose,["stop"])},{default:L((()=>[U(p)])),_:1},8,["onClick"])])])}],["__scopeId","data-v-7034b40d"]]);export{Ce as default};
