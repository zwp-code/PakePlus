var e=Object.defineProperty,s=Object.defineProperties,o=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,t=Object.prototype.propertyIsEnumerable,l=(s,o,n)=>o in s?e(s,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[o]=n,r=(e,s)=>{for(var o in s||(s={}))a.call(s,o)&&l(e,o,s[o]);if(n)for(var o of n(s))t.call(s,o)&&l(e,o,s[o]);return e};import{d as i,A as c,r as d,o as u,N as g,U as f,t as p,W as m,a as v,g as b,$ as h,u as I,a0 as y,_ as w,b as k,l as C,j as x,F as $,v as _,n as E,h as U,O as L,Y as P,k as j,f as q,q as Q,X as B,T as O,L as S,x as A,y as F,z as M,e as R}from"./index-371f133f.js";import{F as T,u as D,Q as V,q as G}from"./qq-b79dcbfd.js";import{v as N,g as z}from"./validator-ad586801.js";import{l as X}from"./logo-6a1fb798.js";import{b as J}from"./boy-09783d30.js";var Y=i({name:"login",components:{ForgetPasswordDialog:T},props:{},emits:[],setup(e,n){const a=D(),t=c(),{proxy:l}=b();let i=d({loginInfo:{username:"",password:""},logonInfo:{username:"",password:"",sex:"0",nickname:""},isLogon:!1,isloading:!1,isRemeber:!1,forgetPasswordVisible:!1}),w={async handleQQLogin(){try{if(l.$utils.cache.qqInfo.get())return;const e=h(location.href);if(!e.access_token)return;const s=await a.getOpenId(e.access_token);if(!s.data.content||!s.data)return;let o=s.data.content,n={accessToken:o.accessToken,openId:o.openId};l.$utils.cache.qqInfo.set(JSON.stringify(n));const r=o.userData;let i="QQ"+n.openId;n.password=l.$utils.secret.MD5(i);const c=l.$bmob.Query("User");c.equalTo("username","==",n.openId),c.equalTo("password","==",n.password),c.limit(1),c.select(...l.$config.UserField),c.find(!1).then((async e=>{if(e.length){if("0"===e[0].isEnable)return void l.$message.warning("账号异常，无法登陆");w.handleClose();let s=e[0];s.browserId||(s.browserId="0"),s.vip||(s.vip="0"),s.vipEndAt||(s.vipEndAt="0"),s.backupCount||(s.backupCount="0"),s.extraBackupCount||(s.extraBackupCount="0"),t.saveUserInfo(s),l.$message.success("登陆成功")}else w.handleQQLogon(n,r)})).catch((e=>{l.$message.error("登录失败")}))}catch(e){t.saveErrorToBmob("QQ登录",e)}},async handleQQLogon(e,s){i.logonInfo.username=e.openId,i.logonInfo.password=e.password,i.logonInfo.avatar=s.figureurl_2,i.logonInfo.nickname=s.nickname,i.logonInfo.sex="2"==s.gender_type?"0":"1";let o=Object.keys(i.logonInfo);const n=l.$bmob.Query("User");for(let t=0;t<o.length;t++){let e=o[t];n.set(e,i.logonInfo[e])}n.set("platform","2"),n.set("vip","0"),n.set("vipEndAt","0"),n.set("browserId",t.browserId),n.set("backupCount","0"),n.set("avatarUpdatedAt",""),n.set("nameUpdatedAt",""),n.set("uid",I.v4()),n.set("isEnable","1");const a=l.$bmob.Query("User"),r=await a.count();n.set("rank",r.count+1),n.save().then((async e=>{i.logonInfo.objectId=e.objectId;try{i.logonInfo=await t.getRemoteUserInfo(l,e.objectId),w.handleClose(),t.saveUserInfo(i.logonInfo),l.$message.success("登录成功")}catch(s){delete i.logonInfo.password,w.handleClose(),t.saveUserInfo(i.logonInfo)}})).catch((e=>{l.$message.error("登录失败")}))},async handleqqLogin(){try{V.Login.showPopup({appId:l.$config.QQ_APP_ID,redirectURI:"https://pg.zwpyyds.com/about"})}catch(e){}},handleGoogleLogin(e){const s=y(e.credential);i.isloading=!0;let o=s.sub,n="Google"+s.sub;const a=l.$bmob.Query("User");a.equalTo("username","==",o),a.equalTo("password","==",l.$utils.secret.MD5(n)),a.limit(1),a.select(...l.$config.UserField),a.find(!1).then((async e=>{if(e.length){if("0"===e[0].isEnable)return void l.$message.warning("账号异常，无法登陆");w.handleClose(),i.isloading=!1;let s=e[0];s.browserId||(s.browserId="0"),s.vip||(s.vip="0"),s.vipEndAt||(s.vipEndAt="0"),s.backupCount||(s.backupCount="0"),s.extraBackupCount||(s.extraBackupCount="0"),t.saveUserInfo(s),l.$message.success("登陆成功")}else{i.logonInfo.username=o,i.logonInfo.password=n,i.logonInfo.avatar=s.picture,i.logonInfo.nickname=s.family_name+s.given_name;let e=Object.keys(i.logonInfo);for(let s=0;s<e.length;s++){let o=e[s];if("password"===o){let e=l.$utils.secret.MD5(i.logonInfo[o]);a.set(o,e)}else a.set(o,i.logonInfo[o])}a.set("platform","1"),a.set("vip","0"),a.set("vipEndAt","0"),a.set("browserId",t.browserId),a.set("backupCount","0"),a.set("avatarUpdatedAt",""),a.set("nameUpdatedAt",""),a.set("uid",I.v4()),a.set("isEnable","1");const r=l.$bmob.Query("User"),c=await r.count();a.set("rank",c.count+1),a.save().then((async e=>{i.logonInfo.objectId=e.objectId;try{i.logonInfo=await t.getRemoteUserInfo(l,e.objectId),w.handleClose(),i.isloading=!1,t.saveUserInfo(i.logonInfo),l.$message.success("登录成功")}catch(s){delete i.logonInfo.password,w.handleClose(),t.saveUserInfo(i.logonInfo),i.isloading=!1}})).catch((e=>{i.isloading=!1,l.$message.error("登录失败")}))}})).catch((e=>{i.isloading=!1,l.$message.error("登录失败")}))},handleChangeRemeber(e){i.isRemeber=e.target.checked},handleGo(){w.handleClose(),l.$router.push("/project")},handleClose(){l.$router.options.history.state.back&&""!==l.$router.options.history.state.back?l.$router.back():l.$router.push("/about"),setTimeout((()=>{i.isLogon=!1}),1e3)},handleCheck(e){let s=!1;for(let o in e)if(""===e[o]){s=!0;break}return s},handleRemeber(){if(i.isRemeber){let e=r({},i.loginInfo);e.password=l.$utils.secret.Encrypt(e.password),l.$utils.cache.user.set(JSON.stringify(e))}else l.$utils.cache.user.remove()},handleLogin(){if(w.handleCheck(i.loginInfo))return l.$message.warning("请填写完整信息");i.isloading=!0;const e=l.$bmob.Query("User");e.equalTo("username","==",i.loginInfo.username),e.equalTo("password","==",l.$utils.secret.MD5(i.loginInfo.password)),e.limit(1),e.select(...l.$config.UserField),e.find(!1).then((e=>{if(i.isloading=!1,e.length){if("0"===e[0].isEnable)return void l.$message.warning("账号异常，无法登陆");w.handleRemeber(),w.handleClose();let s=e[0];return s.browserId||(s.browserId="0"),s.vip||(s.vip="0"),s.vipEndAt||(s.vipEndAt="0"),s.backupCount||(s.backupCount="0"),s.extraBackupCount||(s.extraBackupCount="0"),t.saveUserInfo(s),t.getProjectList(),void l.$message.success("登陆成功")}l.$message.warning("用户名或密码错误")})).catch((e=>{i.isloading=!1,l.$message.error("登录失败")}))},async handleLogon(){try{const e=N.validateEmpty(i.logonInfo),s=N.validateUserName(i.logonInfo.username),o=N.validateNickname(i.logonInfo.nickname),n=N.validatePwd(i.logonInfo.password);await Promise.all([e,s,n,o]).catch((e=>{throw l.$message.warning(e.message),new Error(e.message)})),i.isloading=!0;const a=l.$bmob.Query("User");a.equalTo("username","==",i.logonInfo.username),a.limit(1),a.select("username","browserId"),a.find().then((async e=>{if(e.results.length)return i.isloading=!1,l.$message.warning("用户名已存在");let s=Object.keys(i.logonInfo);for(let t=0;t<s.length;t++){let e=s[t];if("password"===e){let s=l.$utils.secret.MD5(i.logonInfo[e]);a.set(e,s)}else a.set(e,i.logonInfo[e])}a.set("platform","0"),a.set("vip","0"),a.set("vipEndAt","0"),a.set("browserId",t.browserId),a.set("backupCount","0"),a.set("avatar",""),a.set("avatarUpdatedAt",""),a.set("nameUpdatedAt",""),a.set("uid",I.v4()),a.set("isEnable","1");const o=l.$bmob.Query("User"),n=await o.count();a.set("rank",n.count+1),a.save().then((async e=>{i.logonInfo.objectId=e.objectId;try{i.logonInfo=await t.getRemoteUserInfo(l,e.objectId),t.saveUserInfo(i.logonInfo),l.$message.success("注册成功"),i.isloading=!1}catch(s){delete i.logonInfo.password,i.logonInfo.avatar="",t.saveUserInfo(i.logonInfo),i.isloading=!1}})).catch((e=>{i.isloading=!1,l.$message.error("注册失败"),t.saveErrorToBmob("注册",e)}))})).catch((e=>{l.$message.error("注册失败"),t.saveErrorToBmob("注册",e)}))}catch(e){}finally{i.isloading=!1}},handleFocusPassword(){let e=document.getElementById("face");e&&(e.style.transform="translateX(-30px)");const s=document.getElementsByClassName("eye");for(let o of s)o.style.transform="rotate(-100deg)"},handleFocusOutPassword(e){var s,o;let n=document.getElementById("face");if(n&&(n.style.transform="translateX(0)"),e.target.checkValidity())null==(s=document.getElementById("ball"))||s.classList.toggle("sad");else{null==(o=document.getElementById("ball"))||o.classList.toggle("sad");const e=document.getElementsByClassName("eye");for(let s of e)s.style.transform="rotate(215deg)"}},handleMouseMove(e){if(!document.querySelector("#password:is(:focus)")&&!document.querySelector("#password:is(:user-invalid)")){const s=document.getElementsByClassName("eye");for(let o of s){const s=o.getBoundingClientRect().left+10,n=o.getBoundingClientRect().top+10,a=Math.atan2(e.pageX-s,e.pageY-n)*(180/Math.PI)*-1+180;o.style.transform=`rotate(${a}deg)`}}},handleToggleFace(){var e;null==(e=document.getElementById("ball"))||e.classList.toggle("look_at")}};return u((()=>{document.addEventListener("mousemove",w.handleMouseMove);let e=l.$utils.cache.user.get();if(e){i.isRemeber=!0;let s=JSON.parse(e);s.password=l.$utils.secret.Decrypt(s.password),i.loginInfo=s}})),g((()=>{document.removeEventListener("mousemove",w.handleMouseMove)})),f((()=>{if(i.isLogon)for(let e in i.logonInfo)i.logonInfo[e]="","sex"===e&&(i.logonInfo[e]="0")})),k=r(r({},p(i)),w),s(k,o({editSpaceStore:t,checkIsPGComEnv:m,checkIsClientEnv:v}));var k}});const H=e=>(A("data-v-37dfd6fc"),e=e(),F(),e),W={class:"main"},K=S('<section class="form__animation" data-v-37dfd6fc><div id="ball" data-v-37dfd6fc><div class="ball" data-v-37dfd6fc><div id="face" data-v-37dfd6fc><div class="ball__eyes" data-v-37dfd6fc><div class="eye_wrap" data-v-37dfd6fc><span class="eye" data-v-37dfd6fc></span></div><div class="eye_wrap" data-v-37dfd6fc><span class="eye" data-v-37dfd6fc></span></div></div><div class="ball__mouth" data-v-37dfd6fc></div></div></div></div><div class="ball__shadow" data-v-37dfd6fc></div></section>',1),Z={class:"form"},ee={class:"logo"},se=["src"],oe={class:"login"},ne={class:"form__title text-center"},ae=H((()=>x("p",{class:"form__description"},"欢迎回来，请填写你的信息",-1))),te={key:0,class:"login-body flex-column-center"},le={class:"input-search"},re={class:"input-search"},ie={class:"flex-between full-w",style:{padding:"0 10px","font-size":"14px"}},ce={class:"flex"},de={class:"checkbox-container"},ue=["checked"],ge=H((()=>x("span",{class:"checkmark"},null,-1))),fe=M(" 记住我 "),pe={class:"flex-center"},me=M("忘记密码"),ve=M("登 录"),be={class:"flex",style:{gap:"10px","font-size":"14px"}},he=M("没有账号？ "),Ie=M("去注册"),ye={key:0,class:"full-w text-center",style:{color:"#808080","font-size":"14px"}},we=["src"],ke=M(" 用QQ账号登录 "),Ce={key:1,class:"login-body logon-body flex-column-center"},xe={class:"input-search"},$e={class:"input-search"},_e={class:"input-search"},Ee={class:"sex-select flex-between"},Ue=["src"],Le=["src"],Pe=M("注 册"),je={class:"flex",style:{gap:"10px","font-size":"14px"}},qe=M("已有账号？ "),Qe=M("去登录"),Be={class:"flex-between login-dialog-header"},Oe=H((()=>x("p",null,"欢 迎",-1))),Se={key:0,class:"welcome-body flex-column-center text-center"},Ae={key:1,class:"welcome-body flex-column-center text-center"},Fe=M("去创作"),Me={class:"close flex-center"};var Re=w(Y,[["render",function(e,s,o,n,a,t){const l=k("User"),r=k("el-icon"),i=k("Lock"),c=k("el-link"),d=k("el-button"),u=k("GoogleLogin"),g=k("EditPen"),f=k("CloseBold"),p=k("ForgetPasswordDialog");return R(),C("div",W,[K,x("section",Z,[x("div",ee,[x("img",{src:X},null,8,se)]),x("div",oe,[e.editSpaceStore.isLogin?e.editSpaceStore.isLogin&&e.isLogon?(R(),C($,{key:1},[x("div",Be,[Oe,E(r,{onClick:B(e.handleClose,["stop"])},{default:U((()=>[E(f)])),_:1},8,["onClick"])]),e.editSpaceStore.userData.rank&&e.editSpaceStore.userData.rank>0?(R(),C("div",Se," 欢迎加入像素格子，您将成为像素格子的第"+_(e.editSpaceStore.userData.rank)+"位用户，快去创作属于自己的像素艺术吧！ ",1)):(R(),C("div",Ae," 欢迎加入像素格子，快去创作属于自己的像素艺术吧！ ")),E(d,{type:"primary",style:{"border-radius":"10px"},class:"full-w",onClick:e.handleGo},{default:U((()=>[Fe])),_:1},8,["onClick"])],64)):j("v-if",!0):(R(),C($,{key:0},[x("h1",ne,_(e.isLogon?"注 册":"登 录"),1),ae,e.isLogon?(R(),C("div",Ce,[x("div",xe,[E(r,null,{default:U((()=>[E(l)])),_:1}),L(x("input",{type:"text","onUpdate:modelValue":s[8]||(s[8]=s=>e.logonInfo.username=s),placeholder:"请输入用户名"},null,512),[[P,e.logonInfo.username]])]),x("div",$e,[E(r,null,{default:U((()=>[E(i)])),_:1}),L(x("input",{type:"password","onUpdate:modelValue":s[9]||(s[9]=s=>e.logonInfo.password=s),placeholder:"请输入密码"},null,512),[[P,e.logonInfo.password]])]),x("div",_e,[E(r,null,{default:U((()=>[E(g)])),_:1}),L(x("input",{"onUpdate:modelValue":s[10]||(s[10]=s=>e.logonInfo.nickname=s),placeholder:"请输入昵称"},null,512),[[P,e.logonInfo.nickname]])]),x("div",Ee,[x("div",{class:Q(["sex-item",{active:"0"==e.logonInfo.sex}]),onClick:s[11]||(s[11]=s=>e.logonInfo.sex="0")},[x("img",{src:J},null,8,Ue)],2),x("div",{class:Q(["sex-item",{active:"1"==e.logonInfo.sex}]),onClick:s[12]||(s[12]=s=>e.logonInfo.sex="1")},[x("img",{src:z},null,8,Le)],2)]),E(d,{type:"primary",style:{"border-radius":"10px"},class:"full-w",onClick:e.handleLogon,loading:e.isloading},{default:U((()=>[Pe])),_:1},8,["onClick","loading"]),x("p",je,[qe,E(c,{type:"success",underline:!1,onClick:s[13]||(s[13]=s=>e.isLogon=!1)},{default:U((()=>[Qe])),_:1})])])):(R(),C("div",te,[x("div",le,[E(r,null,{default:U((()=>[E(l)])),_:1}),L(x("input",{type:"text","onUpdate:modelValue":s[0]||(s[0]=s=>e.loginInfo.username=s),placeholder:"请输入用户名"},null,512),[[P,e.loginInfo.username]])]),x("div",re,[E(r,null,{default:U((()=>[E(i)])),_:1}),L(x("input",{type:"password","onUpdate:modelValue":s[1]||(s[1]=s=>e.loginInfo.password=s),placeholder:"请输入密码",onBlur:s[2]||(s[2]=(...s)=>e.handleFocusOutPassword&&e.handleFocusOutPassword(...s)),onFocus:s[3]||(s[3]=(...s)=>e.handleFocusPassword&&e.handleFocusPassword(...s))},null,544),[[P,e.loginInfo.password]])]),x("div",ie,[x("div",ce,[x("label",de,[x("input",{class:"custom-checkbox",checked:e.isRemeber,type:"checkbox",onChange:s[4]||(s[4]=(...s)=>e.handleChangeRemeber&&e.handleChangeRemeber(...s))},null,40,ue),ge]),fe]),x("div",pe,[E(c,{type:"success",underline:!1,onClick:s[5]||(s[5]=s=>e.forgetPasswordVisible=!0)},{default:U((()=>[me])),_:1})])]),E(d,{type:"primary",class:"full-w",style:{"border-radius":"10px"},onClick:e.handleLogin,loading:e.isloading,onMouseover:e.handleToggleFace,onMouseout:e.handleToggleFace},{default:U((()=>[ve])),_:1},8,["onClick","loading","onMouseover","onMouseout"]),x("p",be,[he,E(c,{type:"success",underline:!1,onClick:s[6]||(s[6]=s=>e.isLogon=!0)},{default:U((()=>[Ie])),_:1})]),!e.checkIsClientEnv()&&e.checkIsPGComEnv()?(R(),C("p",ye," - OR -")):j("v-if",!0),!e.checkIsClientEnv()&&e.checkIsPGComEnv()?(R(),C("div",{key:1,class:"qq",onClick:s[7]||(s[7]=(...s)=>e.handleqqLogin&&e.handleqqLogin(...s))},[x("div",null,[x("img",{src:G,alt:"QQ登录"},null,8,we)]),ke])):j("v-if",!0),e.checkIsClientEnv()?j("v-if",!0):(R(),q(u,{key:2,callback:e.handleGoogleLogin,class:"scrollHidden",style:{"border-radius":"10px",padding:"2px"}},null,8,["callback"]))]))],64)),(R(),q(O,{to:"body"},[e.forgetPasswordVisible?(R(),q(p,{key:0,style:{"z-index":"2001"},visible:e.forgetPasswordVisible,onClose:s[14]||(s[14]=s=>e.forgetPasswordVisible=!1)},null,8,["visible"])):j("v-if",!0)]))])]),x("div",Me,[E(r,{onClick:B(e.handleClose,["stop"])},{default:U((()=>[E(f)])),_:1},8,["onClick"])])])}],["__scopeId","data-v-37dfd6fc"],["__file","D:/project/pixel-grid/src/views/login/index.vue"]]);export{Re as default};
