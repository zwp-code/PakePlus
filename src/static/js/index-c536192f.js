var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,r=(t,a,o)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[a]=o,s=(e,t)=>{for(var a in t||(t={}))l.call(t,a)&&r(e,a,t[a]);if(o)for(var a of o(t))i.call(t,a)&&r(e,a,t[a]);return e},n=(e,o)=>t(e,a(o));import{_ as c,d,A as p,r as u,o as m,t as g,b as f,f as h,h as j,C as b,u as y,e as k,j as v,n as w,z as P,v as I,k as C,l as S,F as x,p as $,q as B,g as D,ar as A,as as _,x as O,y as V,B as L,at as U,au as G,av as T,aw as F,a8 as N,ax as z,am as R,ay as E,c as H,U as J,V as q,az as M,aA as Q,aB as K,i as W,S as Z,K as Y,ag as X,aC as ee,aD as te,an as ae,aE as oe,a2 as le,O as ie,Y as re,ah as se,P as ne,X as ce,s as de}from"./index-6a0d579b.js";import{u as pe}from"./useDB-ae0c91ac.js";import{e as ue,i as me}from"./binary-96a35058.js";import{g as ge}from"./grid-33bc5412.js";import{e as fe}from"./empty-6662c720.js";const he=d({name:"NewProjectDialog",components:{},props:{visible:{type:Boolean,default:!1},editInfo:{type:Object,default:null},groupId:{type:String,default:"0"},isLocalProject:{type:Boolean,default:!1}},emits:["close","save","group","local"],setup(e,t){const a=p();pe();let{proxy:o}=D(),l=u({dialogVisible:e.visible,projectGroupID:e.groupId,itemInfo:{projectName:"",desc:"",createAt:"",updateAt:"",projectId:"",width:32,height:32,frameImg:"",isTop:0,isLargeCanvas:"1",tip:"新项目",data:null},isloading:!1,isCheckedRatio:!0,widthHeightRatio:1,canvasTemplate:[{id:0,width:0,height:0},{id:1,width:16,height:16},{id:2,width:24,height:24},{id:3,width:32,height:32},{id:4,width:48,height:48},{id:5,width:64,height:64}],selectTemplateId:3}),i={handleChangeLargeCanvas(e){if(a.checkIsLogin())return l.itemInfo.isLargeCanvas=!e;const t=o.$bmob.Query("Test");t.equalTo("username","==",a.userData.username),t.limit(1),t.find(!1).then((t=>t.length?"undefined"==typeof OffscreenCanvas?(l.itemInfo.isLargeCanvas=!e,o.$message.warning("当前浏览器暂不支持此功能")):void(l.itemInfo.isLargeCanvas=e):(l.itemInfo.isLargeCanvas=!e,o.$message.warning("当前账号暂无内测资格")))).catch((t=>{l.itemInfo.isLargeCanvas=!e,o.$message.error("网络异常，请稍后再试")}))},handleSelectTemplate(e){l.selectTemplateId=e.id,0!==e.id&&(l.itemInfo.width=e.width,l.itemInfo.height=e.height)},handleChangeRatio(e){e&&(l.widthHeightRatio=l.itemInfo.width/l.itemInfo.height)},handleClose(){l.isloading=!1,l.dialogVisible=!1,t.emit("close")},handleChangeCanvasSize(e,t){if(e<o.$config.canvasMinSize||e>o.$config.canvasMaxSize)l.itemInfo[t]=e<o.$config.canvasMinSize?o.$config.canvasMinSize:e>o.$config.canvasMaxSize?o.$config.canvasMaxSize:l.itemInfo[t],o.$message.warning(`画布像素必须${o.$config.canvasMinSize}-${o.$config.canvasMaxSize}像素区间`);else{if(!l.itemInfo.isLargeCanvas&&e>150)return l.itemInfo[t]=150,o.$message.warning("画布过大，请启用大画布模式");l.itemInfo[t]=Number(e)}l.isCheckedRatio&&("width"===t?l.itemInfo.height=parseInt(l.itemInfo[t]/l.widthHeightRatio):l.itemInfo.width=parseInt(l.itemInfo[t]/l.widthHeightRatio));let a=l.canvasTemplate.find((e=>e.width===l.itemInfo.width&&e.height===l.itemInfo.height));l.selectTemplateId=a?a.id:0},handleAddGroup(o){a.addProjectToGroup(e.groupId,l.projectGroupID,o),t.emit("group")},handleConfirm(){o.$refs.form.validate((r=>{if(r){if(l.isloading=!0,e.editInfo&&e.isLocalProject)return l.itemInfo.updateAt=b(),l.itemInfo.tip="最近编辑",void t.emit("local",l.itemInfo,(()=>i.handleClose()));if(e.editInfo)return i.handleAddGroup(l.itemInfo.projectId),l.itemInfo.updateAt=b(),l.itemInfo.tip="最近编辑",void a.saveProject(l.itemInfo,!0).then((e=>{e&&(l.isloading=!1,i.handleClose(),o.$message.success(o.$t("message.saveSucceeded")))})).catch((e=>{l.isloading=!1,o.$message.error(o.$t("message.saveFailed"))}));if(l.itemInfo.projectId=y.v1(),e.isLocalProject)return l.itemInfo.createAt=b(),l.itemInfo.updateAt=l.itemInfo.createAt,void t.emit("local",l.itemInfo,(()=>i.handleClose()));i.handleAddGroup(l.itemInfo.projectId),l.itemInfo.createAt=b(),l.itemInfo.updateAt=l.itemInfo.createAt,a.saveProject(l.itemInfo,!0).then((e=>{e&&(o.$message.success(o.$t("message.newSucceeded")),l.isloading=!1,i.handleClose(),t.emit("save",l.itemInfo))})).catch((e=>{o.$message.error(o.$t("message.newFailed")),l.isloading=!1}))}else o.$message.warning("请填写参数")}))}};return m((()=>{e.editInfo&&(l.itemInfo=e.editInfo)})),n(s(s({},g(l)),i),{editSpaceStore:a})}}),je={class:"flex-between full-w"},be=P("宽"),ye=P("高"),ke={style:{"margin-left":"20px"}},ve={key:1,class:"flex-between full-w",style:{gap:"10px","margin-top":"10px"}},we=["onClick"],Pe=["src"],Ie={class:"full-w size flex-center"},Ce=P("自定义"),Se={class:"dialog-footer"};var xe=c(he,[["render",function(e,t,a,o,l,i){const r=f("el-input"),s=f("el-form-item"),n=f("el-checkbox"),c=f("el-tag"),d=f("el-option"),p=f("el-select"),u=f("el-form"),m=f("el-button"),g=f("el-dialog");return k(),h(g,{modelValue:e.dialogVisible,"onUpdate:modelValue":t[9]||(t[9]=t=>e.dialogVisible=t),title:e.editInfo?e.$t("message.editProject"):e.$t("message.newProject"),width:500,"before-close":e.handleClose,"close-on-click-modal":!1,"lock-scroll":!1,class:"z-dialog",center:""},{footer:j((()=>[v("span",Se,[w(m,{onClick:e.handleClose},{default:j((()=>[P(I(e.$t("message.cancel")),1)])),_:1},8,["onClick"]),w(m,{type:"primary",onClick:e.handleConfirm,loading:e.isloading},{default:j((()=>[P(I(e.$t("message.confirm")),1)])),_:1},8,["onClick","loading"])])])),default:j((()=>[w(u,{ref:"form","label-position":"top","label-width":"100px","show-message":!1,model:e.itemInfo},{default:j((()=>[e.editInfo?(k(),h(s,{key:0,label:"项目ID"},{default:j((()=>[w(r,{modelValue:e.itemInfo.projectId,"onUpdate:modelValue":t[0]||(t[0]=t=>e.itemInfo.projectId=t),disabled:""},null,8,["modelValue"])])),_:1})):C("v-if",!0),w(s,{label:"项目名称",required:"",prop:"projectName"},{default:j((()=>[w(r,{modelValue:e.itemInfo.projectName,"onUpdate:modelValue":t[1]||(t[1]=t=>e.itemInfo.projectName=t),clearable:"",placeholder:"请输入",maxlength:"20"},null,8,["modelValue"])])),_:1}),w(s,{label:"画布大小",required:""},{default:j((()=>[v("div",je,[w(r,{modelValue:e.itemInfo.width,"onUpdate:modelValue":t[2]||(t[2]=t=>e.itemInfo.width=t),type:"number",disabled:e.editInfo,max:e.$config.canvasMaxSize,min:e.$config.canvasMinSize,onChange:t[3]||(t[3]=t=>e.handleChangeCanvasSize(t,"width"))},{prepend:j((()=>[be])),_:1},8,["modelValue","disabled","max","min"]),w(r,{modelValue:e.itemInfo.height,"onUpdate:modelValue":t[4]||(t[4]=t=>e.itemInfo.height=t),style:{"margin-left":"10px"},type:"number",disabled:e.editInfo,max:e.$config.canvasMaxSize,min:e.$config.canvasMinSize,onChange:t[5]||(t[5]=t=>e.handleChangeCanvasSize(t,"height"))},{prepend:j((()=>[ye])),_:1},8,["modelValue","disabled","max","min"]),v("div",ke,[w(n,{modelValue:e.isCheckedRatio,"onUpdate:modelValue":t[6]||(t[6]=t=>e.isCheckedRatio=t),disabled:e.editInfo,label:"保持横纵比",onChange:e.handleChangeRatio},null,8,["modelValue","disabled","onChange"])])]),e.editInfo?C("v-if",!0):(k(),h(c,{key:0,type:"info",style:{"margin-top":"10px"}},{default:j((()=>[P("目前画布最大支持 "+I(e.$config.canvasMaxSize)+"*"+I(e.$config.canvasMaxSize)+" 大小",1)])),_:1})),e.editInfo?C("v-if",!0):(k(),S("div",ve,[(k(!0),S(x,null,$(e.canvasTemplate,(t=>(k(),S("div",{key:t.label,class:B(["template-box pointer",{active:e.selectTemplateId===t.id}]),onClick:a=>e.handleSelectTemplate(t)},[v("img",{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGMAAABiCAYAAABEZ20wAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAHlSURBVHhe7d3RioMwEIVh3//ZfCdL8aYNkwQR01P4Cnu1iIvp/Gf8J67bMfjs+36MfkbHvn/n+GvXb7MY/Suw+stkMYLIYDEsxsnS2Wc1Jtq/Z/X5VYbKUBkVGTata7/9XI1RizG4l7IYHxdn9cVoKbH6/CpDZZzfudWt469b19n5VYbKUBkVGVRGUmWwtqwtN1W4OW6Km+KmSjclM2SGzJAZ34Z2tXuauS8BnhTg5hnmGURhIUrpkCQdAlMwBVMw9d06pQ23ZIbMMFwqh0vcFDfFTXFT3FR3S06aqJttpZmJvrvHE4VJolCAC3ABLsDDA5woJAqJQqKQKOy2K2nW9On7iNl9CGvL2rK2HgloOJGGSZhKwhQdQofQIXRIuA6BKZiCKZiCKWPXTvvcAtLYNWnsap5hnmGeYZ5hnmGe0bkCbUQQhUmiUIALcAEuwMMDnCgkColCopAoJAqJwv/7v7msbZK11U3ppnRTVTdFh9AhdAgdEq5DYAqmYAqmYMrY1dj1/96QSYfQId4S4C0BjcoeebnqAcinH02GKZiCKZiCqRzd8DTzW+Jdfc5cZiRlBlGYU7k2Ptv4fLLhKlPvMjn9eJWhMlRGRQaVoTJUhspoEjytgXDTl3TTZ3un7Z22dxbbO1/qp7ceqIxB2QAAAABJRU5ErkJggg=="},null,8,Pe),v("div",Ie,[0!==t.id?(k(),h(c,{key:0,type:"success",size:"small"},{default:j((()=>[P(I(t.width)+"*"+I(t.height),1)])),_:2},1024)):(k(),h(c,{key:1,type:"primary",size:"small"},{default:j((()=>[Ce])),_:1}))])],10,we)))),128))]))])),_:1}),e.isLocalProject?C("v-if",!0):(k(),h(s,{key:1,label:"项目分组"},{default:j((()=>[w(p,{modelValue:e.projectGroupID,"onUpdate:modelValue":t[7]||(t[7]=t=>e.projectGroupID=t),placeholder:"请选择项目分组"},{default:j((()=>[(k(!0),S(x,null,$(e.editSpaceStore.projectGroupList,(e=>(k(),h(d,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})),C(' <el-form-item label="项目模式">\r\n                    <div class="flex-column-start">\r\n                        <div class="flex-start">\r\n                            <el-checkbox \r\n                            v-model="itemInfo.isLargeCanvas" \r\n                            disabled\r\n                            true-label="1"\r\n                            false-label="0" label="大画布模式" />\r\n                            <el-tag type="info" style="margin-left:10px" v-if="itemInfo.height > 512 && itemInfo.width > 512">当前画布过大，可能会存在性能问题！</el-tag>\r\n                        </div>\r\n                        <div v-if="false">\r\n                            <el-link href="#" type="success" :underline="false" v-show="!editInfo">项目模式申请链接（戳这里申请！）</el-link>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    \r\n                </el-form-item> '),w(s,{label:"项目描述"},{default:j((()=>[w(r,{modelValue:e.itemInfo.desc,"onUpdate:modelValue":t[8]||(t[8]=t=>e.itemInfo.desc=t),placeholder:"请输入",type:"textarea",maxlength:"30","show-word-limit":"",autosize:{minRows:1,maxRows:3}},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue","title","before-close"])}],["__scopeId","data-v-40ef6028"],["__file","D:/project/pixel-grid/src/components/dialog/NewProjectDialog.vue"]]);const $e=d({name:"UploadFileDialog",components:{},props:{visible:{type:Boolean,default:!1}},emits:["close","reload"],setup(e,t){const{proxy:a}=D();let o=u({loading:!1,dialogVisible:e.visible,fileList:[],fileListTemp:[],imageTypes:["image/jpeg","image/png","image/gif","image/bmp","image/svg+xml"]}),l={handleClose(){o.dialogVisible=!1,t.emit("close")},handleConfirm(){if(!o.fileList.length)return a.$message.warning("上传文件不能为空");t.emit("close"),t.emit("reload",o.fileList)},handleChange(e,t){if(o.fileList=t,!["application/json","application/x-zip-compressed"].includes(e.raw.type)&&!e.raw.name.endsWith(".px")){let t=o.fileList.findIndex((t=>t.uid===e.uid));return o.fileList.splice(t,1),void a.$message.warning("导入文件格式不正确")}if("application/x-zip-compressed"===e.raw.type){let t=[];(new A).loadAsync(e.raw).then((l=>{let i=Object.keys(l.files),r=[];for(let e=0;e<i.length;e++)if("json"===_(l.files[i[e]].name)){let a=l.files[i[e]].async("blob").then((function(a){let o=new File([a],l.files[i[e]].name,{type:"application/json"});t.push(o)}));r.push(a)}else if("px"===_(l.files[i[e]].name)){let a=l.files[i[e]].async("blob").then((function(a){let o=new File([a],l.files[i[e]].name,{type:"application/octet-stream"});t.push(o)}));r.push(a)}let s=o.fileList.findIndex((t=>t.uid===e.uid));o.fileList.splice(s,1),Promise.all(r).then((e=>{if(0===t.length)return a.$message.warning("压缩包不存在对应项目文件或项目文件格式不正确");for(let a=0;a<t.length;a++)o.fileList.push(t[a])}))}))}}};return s(s({},g(o)),l)}}),Be=e=>(O("data-v-6a9264ec"),e=e(),V(),e),De=Be((()=>v("div",{class:"el-upload__text"},[P(" 拖拽文件到这 或者 "),v("em",null,"点击这里上传")],-1))),Ae=Be((()=>v("div",{class:"el-upload__tip text-center"}," 支持上传多个.json 或 .px为后缀的项目文件或.zip项目压缩包 ",-1))),_e={class:"dialog-footer"};var Oe=c($e,[["render",function(e,t,a,o,l,i){const r=f("upload-filled"),s=f("el-icon"),n=f("el-upload"),c=f("el-button"),d=f("el-dialog");return k(),h(d,{modelValue:e.dialogVisible,"onUpdate:modelValue":t[1]||(t[1]=t=>e.dialogVisible=t),title:"导入项目","before-close":e.handleClose,"close-on-click-modal":!1,"lock-scroll":!1,class:"z-dialog",center:"",width:500},{footer:j((()=>[v("span",_e,[w(c,{onClick:e.handleClose},{default:j((()=>[P(I(e.$t("message.cancel")),1)])),_:1},8,["onClick"]),w(c,{type:"primary",onClick:e.handleConfirm,loading:e.loading},{default:j((()=>[P(I(e.$t("message.confirm")),1)])),_:1},8,["onClick","loading"])])])),default:j((()=>[w(n,{ref:"uploadRef",class:"content",drag:"",multiple:"","auto-upload":!1,accept:".json,.zip,.px","on-change":e.handleChange,"file-list":e.fileList,"onUpdate:file-list":t[0]||(t[0]=t=>e.fileList=t)},{tip:j((()=>[Ae])),default:j((()=>[w(s,{class:"el-icon--upload"},{default:j((()=>[w(r)])),_:1}),De])),_:1},8,["on-change","file-list"])])),_:1},8,["modelValue","before-close"])}],["__scopeId","data-v-6a9264ec"],["__file","D:/project/pixel-grid/src/components/dialog/UploadFileDialog.vue"]]);const Ve=d({name:"PublishDialog",components:{},props:{visible:{type:Boolean,default:!1},editInfo:{type:Object,default:null}},emits:["close","save"],setup(e,t){const a=p(),o=L();pe();let{proxy:l}=D(),i=u({uploadUrl:"/api/1/upload",dialogVisible:e.visible,itemInfo:{projectName:"",desc:"",createAt:"",updateAt:"",projectId:"",width:"32",height:"32",frameImg:"",isTop:"0",tip:"",data:null},projectOptions:{isPass:"0",author:"",authorAvatar:"",projectName:"",projectId:"",desc:"-",width:"32",height:"32",frameImg:"",isTop:"0",tip:"",tag:"0",authorId:"",authorUid:"",source:["0"],activityCode:"0",createAt:""},imageTypes:["image/jpeg","image/jpg","image/png","image/gif"],fileList:[],fileHeader:{"X-API-Key":l.$config.PICGO_KEY},poster:"",isloading:!1,deletePosterUrl:"",progressValue:0,posterFile:null}),r={handleChangeActivity:e=>i.projectOptions.source.includes("0")?(i.projectOptions.activityCode="0",l.$message.warning("请确保项目是原创作品！")):Number(i.projectOptions.width)>100||Number(i.projectOptions.height)>100?(i.projectOptions.activityCode="0",l.$message.warning("请确保项目画布尺寸小于100")):""===i.projectOptions.tip?l.$message.warning("请确保项目画布尺寸小于100"):void 0,handleChangeProjectTag(e){"1"===i.projectOptions.tag&&(i.projectOptions.tip="动画")},handleBeforeUploadPoster:e=>i.imageTypes.includes(e.type)?!(e.size/1024/1024>l.$config.MAX_UPLOAD_SIZE)||(l.$message.warning("上传图片封面大小不能超过500kb！"),!1):(l.$message.warning("上传图片封面格式不正确！"),!1),handleErrorUploadPoster(e,t){l.$message.error("上传封面失败"),i.isloading=!1},handleSuccessUploadPoster(e,t){},handleExceedUploadPoster(e,t){o.value.clearFiles();const a=e[0];a.uid=G(),o.value.handleStart(a)},handleChangeUploadPoster(e,t){i.poster=URL.createObjectURL(e.raw),i.posterFile=e},async handleUploadFileToOBS(e){const t=JSON.stringify(i.itemInfo),a=new Blob([t],{type:""});T(a,`${i.projectOptions.projectId}.json`,(t=>{r.handleBmobPublish(e)}),(t=>{l.$message.error(t),r.handleDeletePoster(e)}),(e=>{i.progressValue=e}))},handleUploadPosterToOBS(e){i.projectOptions.projectId=y.v1();let t=_(e.name),a=`${i.projectOptions.projectId}.${t}`;T(e.raw,a,(e=>{r.handleUploadFileToOBS("/"+a)}),(e=>{i.isloading=!1,l.$message.error(e)}),(e=>{}))},async handleBmobPublish(e){i.projectOptions.frameImg=e,i.projectOptions.author=a.userData.nickname,i.projectOptions.authorId=a.userData.username,i.projectOptions.authorUid=a.userData.uid,i.projectOptions.authorAvatar=a.userData.avatar||"",i.projectOptions.createAt=b();const t=l.$bmob.Query("Resource");let o=Object.keys(i.projectOptions);for(let a=0;a<o.length;a++){let e=o[a];"source"!==e?("desc"===e&&(i.projectOptions[e]=i.projectOptions[e].trim()),t.set(e,i.projectOptions[e])):(i.projectOptions[e].sort(((e,t)=>e-t)),t.set(e,i.projectOptions[e].join(",")))}t.save().then((e=>{i.isloading=!1,l.$message.success("发布成功，已提交审核"),URL.revokeObjectURL(i.poster),r.handleClose()})).catch((t=>{r.handleDeleteToOBS(),r.handleDeletePoster(e),l.$message.error("发布失败"),URL.revokeObjectURL(i.poster),a.saveErrorToBmob("发布项目",t)}))},handleDeletePoster(e){let t=e.slice(1);F(t,(e=>{i.isloading=!1}),(e=>{i.isloading=!1}))},handleDeleteToOBS(){F(`${i.projectOptions.projectId}.json`,(e=>{}),(e=>{}))},handleClose(){i.dialogVisible=!1,t.emit("close")},handleConfirm(){l.$refs.form.validate((async e=>{if(e){if(""===i.poster)return l.$message.warning("请上传封面");if("1"===i.projectOptions.activityCode){if(i.projectOptions.source.includes("0"))return l.$message.warning("请确保项目是原创作品！");if(Number(i.projectOptions.width)>100||Number(i.projectOptions.height)>100)return l.$message.warning("请确保项目画布尺寸小于100");if(""===i.projectOptions.tip)return l.$message.warning("请填写联系方式");if(""===i.projectOptions.desc)return l.$message.warning("请填写项目描述")}if(i.isloading=!0,"1"===i.projectOptions.activityCode){const e=l.$bmob.Query("Resource");e.equalTo("authorUid","==",a.userData.uid),e.equalTo("activityCode","==","1");if((await e.find()).results.length)return i.isloading=!1,l.$message.warning("你已经参与过此次活动了!")}r.handleBeforeUploadPoster(i.posterFile.raw)?r.handleUploadPosterToOBS(i.posterFile):i.isloading=!1}else l.$message.warning("请填写参数")}))}};return m((()=>{if(e.editInfo){if(i.itemInfo=e.editInfo,i.itemInfo.frameImg="@",i.itemInfo.tip="",i.itemInfo.isTop=0,delete i.itemInfo.isBackup,delete i.itemInfo.backupUpdatedAt,delete i.itemInfo.authorUid,i.itemInfo.data&&i.itemInfo.data.length&&i.itemInfo.data[0].currentFrameImg){let e=U(i.itemInfo.data[0].currentFrameImg);i.poster=URL.createObjectURL(e),i.posterFile={name:"frame0.png",raw:new File([e],"frame0",{type:"image/png"})}}i.projectOptions.desc=i.itemInfo.desc,i.projectOptions.projectName=i.itemInfo.projectName,i.projectOptions.width=String(i.itemInfo.width),i.projectOptions.height=String(i.itemInfo.height),i.projectOptions.activityCode=i.itemInfo.activityCode}})),n(s(s({},g(i)),r),{uploadRef:o})}}),Le=e=>(O("data-v-cc7bbac0"),e=e(),V(),e),Ue=Le((()=>v("div",{class:"el-upload__text"},[P(" 拖拽文件到这 或者 "),v("em",null,"点击这里上传")],-1))),Ge={key:1,class:"poster flex-center"},Te=["src"],Fe={key:0,class:"el-upload__tip"},Ne=Le((()=>v("p",{style:{"line-height":"1.5","font-size":"12px","margin-top":"5px"},class:"text-grey"},"注：如需艾特原创作者可通过 @原创作者名称[原创作者链接地址] 标明",-1))),ze={class:"dialog-footer"};var Re=c(Ve,[["render",function(e,t,a,o,l,i){const r=f("upload-filled"),s=f("el-icon"),n=f("el-upload"),c=f("el-input"),d=f("el-form-item"),p=f("el-option"),u=f("el-select"),m=f("el-form"),g=f("el-progress"),b=f("el-button"),y=f("el-dialog");return k(),h(y,{modelValue:e.dialogVisible,"onUpdate:modelValue":t[6]||(t[6]=t=>e.dialogVisible=t),title:"1"===e.projectOptions.activityCode?"投稿作品":"发布项目",width:400,"before-close":e.handleClose,"lock-scroll":!1,"close-on-click-modal":!1,class:"z-dialog",center:""},{footer:j((()=>[v("span",ze,[w(b,{onClick:e.handleClose},{default:j((()=>[P(I(e.$t("message.cancel")),1)])),_:1},8,["onClick"]),w(b,{type:"primary",onClick:e.handleConfirm,loading:e.isloading},{default:j((()=>[P(I(e.$t("message.confirm")),1)])),_:1},8,["onClick","loading"])])])),default:j((()=>[w(n,{ref:"uploadRef",class:"flex-column-center",drag:"",action:e.uploadUrl,"auto-upload":!1,"show-file-list":!1,accept:".png,.jpg,.jpeg,.gif",name:"source",limit:1,method:"post",headers:e.fileHeader,"file-list":e.fileList,"onUpdate:file-list":t[0]||(t[0]=t=>e.fileList=t),"on-success":e.handleSuccessUploadPoster,"before-upload":e.handleBeforeUploadPoster,"on-error":e.handleErrorUploadPoster,"on-exceed":e.handleExceedUploadPoster,"on-change":e.handleChangeUploadPoster,disabled:"1"===e.projectOptions.activityCode},{tip:j((()=>["0"===e.projectOptions.activityCode?(k(),S("div",Fe," 上传小于500KB的jpg/png/gif文件作为封面 ")):C("v-if",!0)])),default:j((()=>[""===e.poster?(k(),S(x,{key:0},[w(s,{class:"el-icon--upload"},{default:j((()=>[w(r)])),_:1}),Ue],64)):(k(),S("div",Ge,[v("img",{src:e.poster,style:{"object-fit":"contain"},draggable:"false"},null,8,Te)]))])),_:1},8,["action","headers","file-list","on-success","before-upload","on-error","on-exceed","on-change","disabled"]),w(m,{ref:"form","label-position":"top","label-width":"100px","show-message":!1,class:"scrollbar scrollY",style:{"margin-top":"10px","max-height":"300px",padding:"0 10px"},model:e.projectOptions},{default:j((()=>[w(d,{label:"项目名称",required:"",prop:"projectName"},{default:j((()=>[w(c,{modelValue:e.projectOptions.projectName,"onUpdate:modelValue":t[1]||(t[1]=t=>e.projectOptions.projectName=t),clearable:"",placeholder:"请输入项目名称",maxlength:"20"},null,8,["modelValue"])])),_:1}),w(d,{label:"项目标签"},{default:j((()=>[w(u,{modelValue:e.projectOptions.tag,"onUpdate:modelValue":t[2]||(t[2]=t=>e.projectOptions.tag=t),placeholder:"请选择项目标签",onChange:e.handleChangeProjectTag},{default:j((()=>[w(p,{label:"静态",value:"0"}),w(p,{label:"动态",value:"1"})])),_:1},8,["modelValue","onChange"])])),_:1}),w(d,{label:"项目来源"},{default:j((()=>[C(' <el-select v-model="projectOptions.source" placeholder="请选择项目来源">\r\n                      <el-option label="临摹" :value="\'0\'"></el-option>\r\n                      <el-option label="原创" :value="\'1\'"></el-option>\r\n                    </el-select> '),w(u,{modelValue:e.projectOptions.source,"onUpdate:modelValue":t[3]||(t[3]=t=>e.projectOptions.source=t),placeholder:"请选择项目来源","multiple-limit":2,"collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":2,multiple:""},{default:j((()=>[w(p,{label:"临摹",value:"0",disabled:e.projectOptions.source.includes("1")},null,8,["disabled"]),w(p,{label:"原创",value:"1",disabled:e.projectOptions.source.includes("0")},null,8,["disabled"]),w(p,{label:"二创",value:"2"})])),_:1},8,["modelValue"])])),_:1}),"1"===e.projectOptions.activityCode?(k(),h(d,{key:0,label:"联系方式",required:"",prop:"tip"},{default:j((()=>[w(c,{modelValue:e.projectOptions.tip,"onUpdate:modelValue":t[4]||(t[4]=t=>e.projectOptions.tip=t),clearable:"",placeholder:"请输入联系方式",maxlength:"20"},null,8,["modelValue"])])),_:1})):C("v-if",!0),w(d,{label:"项目描述"},{default:j((()=>[w(c,{modelValue:e.projectOptions.desc,"onUpdate:modelValue":t[5]||(t[5]=t=>e.projectOptions.desc=t),placeholder:"请输入项目描述",type:"textarea",maxlength:"100","show-word-limit":"",autosize:{minRows:1,maxRows:3}},null,8,["modelValue"]),Ne])),_:1})])),_:1},8,["model"]),e.progressValue>0?(k(),h(g,{key:0,"text-inside":!0,"stroke-width":20,percentage:e.progressValue,status:"success"},null,8,["percentage"])):C("v-if",!0)])),_:1},8,["modelValue","title","before-close"])}],["__scopeId","data-v-cc7bbac0"],["__file","D:/project/pixel-grid/src/components/dialog/PublishDialog.vue"]]);const Ee=d({name:"AddProjectGroupDialog",components:{},props:{visible:{type:Boolean,default:!1},editData:{type:Object,default:null},isSelectGroup:{type:Boolean,default:!1}},emits:["close","add"],setup(e,t){const{proxy:a}=D(),o=p();let l=u({loading:!1,dialogVisible:e.visible,form:{group:{value:"",list:[],label:"",desc:""}},projectGroupID:"0"}),i={handleClose(){l.dialogVisible=!1,t.emit("close")},async handleConfirm(){if(e.isSelectGroup)return t.emit("add",l.projectGroupID),void i.handleClose();!e.editData&&o.checkVipFunction("projectGroup",o.projectGroupList.length,!0,!1)||a.$refs.form.validate((t=>{t?(l.loading=!0,!e.editData&&(l.form.group.value=y.v4()),o.saveProjectGroup(l.form.group),l.loading=!1,i.handleClose()):a.$message.warning("请填写参数")}))}};return m((()=>{e.editData&&(l.form.group=e.editData)})),n(s(s({},g(l)),i),{editSpaceStore:o})}}),He={class:"dialog-footer"},Je=P("取 消"),qe=P("确 定");var Me=c(Ee,[["render",function(e,t,a,o,l,i){const r=f("el-input"),s=f("el-form-item"),n=f("el-option"),c=f("el-select"),d=f("el-form"),p=f("el-button"),u=f("el-dialog");return k(),h(u,{modelValue:e.dialogVisible,"onUpdate:modelValue":t[3]||(t[3]=t=>e.dialogVisible=t),title:e.isSelectGroup?"选择分组":e.editData?"编辑分组":"新增分组","before-close":e.handleClose,class:"z-dialog",center:"","close-on-click-modal":!1,width:350},{footer:j((()=>[v("span",He,[w(p,{onClick:e.handleClose},{default:j((()=>[Je])),_:1},8,["onClick"]),w(p,{type:"primary",onClick:e.handleConfirm,loading:e.loading},{default:j((()=>[qe])),_:1},8,["onClick","loading"])])])),default:j((()=>[w(d,{ref:"form",model:e.form.group,"label-position":"top"},{default:j((()=>[e.isSelectGroup?C("v-if",!0):(k(),h(s,{key:0,label:"分组名称",required:"",prop:"label"},{default:j((()=>[w(r,{modelValue:e.form.group.label,"onUpdate:modelValue":t[0]||(t[0]=t=>e.form.group.label=t),placeholder:"请输入名称",clearable:""},null,8,["modelValue"])])),_:1})),e.isSelectGroup?C("v-if",!0):(k(),h(s,{key:1,label:"分组描述"},{default:j((()=>[w(r,{modelValue:e.form.group.desc,"onUpdate:modelValue":t[1]||(t[1]=t=>e.form.group.desc=t),placeholder:"请输入描述",clearable:""},null,8,["modelValue"])])),_:1})),e.isSelectGroup?(k(),h(s,{key:2,label:"选择分组"},{default:j((()=>[w(c,{modelValue:e.projectGroupID,"onUpdate:modelValue":t[2]||(t[2]=t=>e.projectGroupID=t),placeholder:"请选择项目分组"},{default:j((()=>[(k(!0),S(x,null,$(e.editSpaceStore.projectGroupList,(e=>(k(),h(n,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):C("v-if",!0)])),_:1},8,["model"])])),_:1},8,["modelValue","title","before-close"])}],["__file","D:/project/pixel-grid/src/components/dialog/AddProjectGroupDialog.vue"]]);const Qe=d({name:"ShareProjectDialog",components:{},props:{visible:{type:Boolean,default:!1},editInfo:{type:Object,default:null}},emits:["close"],setup(e,t){const{proxy:a}=D(),o=p();let l=u({loading:!1,dialogVisible:e.visible,shareUrl:"",form:{updateAt:"",permission:"0",fromUsername:"",fromUid:"",password:"",exp:"10",url:"",projectId:""},permissionOptions:[{label:"仅预览",value:"0"},{label:"预览 + 导入",value:"1"}],itemInfo:{projectName:"",desc:"",createAt:"",updateAt:"",projectId:"",width:"32",height:"32",frameImg:"",isTop:"0",tip:"",data:null},qrcode:null}),i={handleClose(){l.dialogVisible=!1,t.emit("close")},checkIsShare:()=>new Promise(((e,t)=>{const i=a.$bmob.Query("Share");i.equalTo("fromUid","==",o.userData.uid),i.equalTo("projectId","==",l.itemInfo.projectId),i.find().then((t=>{if(t.results.length){let a=t.results[0];z(a.exp,a.updatedAt,6e4)||a.updateAt!==l.itemInfo.updateAt?e({objectId:a.objectId}):e({objectId:a.objectId,projectId:a.projectId,password:a.password})}else e({objectId:null})})).catch((e=>{t(e)}))})),async handleConfirm(){l.loading=!0;try{const e=await i.checkIsShare();if(e.objectId){if(e.projectId){l.loading=!1;let t=""!==l.form.password?`?pwd=${l.form.password}`:"";return l.shareUrl=R()+"draw/D"+e.projectId+t,void i.generateQRCode()}const t=JSON.stringify(l.itemInfo),r=new Blob([t],{type:""});let s=a.$bmob.File(l.itemInfo.projectId+".json",r);const n=await s.save();if(n.length){l.form.fromUid=o.userData.uid,l.form.fromUsername=o.userData.username,l.form.projectId=l.itemInfo.projectId,l.form.updateAt=l.itemInfo.updateAt,l.form.url=n[0].url;const t=a.$bmob.Query("Share");t.set("id",e.objectId);for(let e in l.form)t.set(e,l.form[e]);t.set("files",n[0]),t.save().then((e=>{l.loading=!1;let t=""!==l.form.password?`?pwd=${l.form.password}`:"";l.shareUrl=R()+"draw/D"+l.itemInfo.projectId+t,i.generateQRCode()})).catch((e=>{l.loading=!1,a.$message.error("分享失败")}))}else l.loading=!1,a.$message.error("分享失败")}else{const e=JSON.stringify(l.itemInfo),t=new Blob([e],{type:""});a.$bmob.File(l.itemInfo.projectId+".json",t).save().then((e=>{if(e.length){l.form.fromUid=o.userData.uid,l.form.fromUsername=o.userData.username,l.form.projectId=l.itemInfo.projectId,l.form.updateAt=l.itemInfo.updateAt,l.form.url=e[0].url;const t=a.$bmob.Query("Share");for(let e in l.form)t.set(e,l.form[e]);t.set("files",e[0]),t.save().then((e=>{l.loading=!1;let t=""!==l.form.password?`?pwd=${l.form.password}`:"";l.shareUrl=R()+"draw/D"+l.itemInfo.projectId+t,i.generateQRCode()})).catch((e=>{l.loading=!1,a.$message.error("分享失败")}))}else l.loading=!1,a.$message.error("分享失败")})).catch((e=>{l.loading=!1,a.$message.error("分享失败")}))}}catch(e){l.loading=!1,a.$message.error("分享失败")}},async generateQRCode(){E((()=>{let e=document.getElementById("qrcode");try{e.innerHTML="",l.qrcode=new QRCode(e),l.qrcode.clear(),l.qrcode.makeCode(l.shareUrl||"分享内容不存在")}catch(t){e.innerText="二维码生成失败"}}))}};return m((()=>{e.editInfo&&(l.itemInfo=e.editInfo,l.itemInfo.frameImg="@",l.itemInfo.tip="",l.itemInfo.isTop=0,delete l.itemInfo.isBackup,delete l.itemInfo.backupUpdatedAt,delete l.itemInfo.authorUid)})),n(s(s({},g(l)),i),{copyText:N})}}),Ke={key:0,class:"share-pic flex-center",id:"qrcode",ref:"qrcode"},We={key:1,class:"flex-between share-url"},Ze=["title"],Ye=P("10分钟"),Xe=P("30分钟"),et=P("1小时"),tt={key:0,class:"dialog-footer"},at=P("取 消"),ot=P("确 定");var lt=d({name:"project",components:{NewProjectDialog:xe,UploadFileDialog:Oe,PublishDialog:Re,ShareProjectDialog:c(Qe,[["render",function(e,t,a,o,l,i){const r=f("CopyDocument"),s=f("el-icon"),n=f("el-input"),c=f("el-form-item"),d=f("el-option"),p=f("el-select"),u=f("el-radio"),m=f("el-radio-group"),g=f("el-form"),b=f("el-button"),y=f("el-dialog");return k(),h(y,{modelValue:e.dialogVisible,"onUpdate:modelValue":t[4]||(t[4]=t=>e.dialogVisible=t),title:"分享项目","before-close":e.handleClose,class:"z-dialog",center:"",width:350},{footer:j((()=>[""===e.shareUrl?(k(),S("span",tt,[w(b,{onClick:e.handleClose},{default:j((()=>[at])),_:1},8,["onClick"]),w(b,{type:"primary",onClick:e.handleConfirm,loading:e.loading},{default:j((()=>[ot])),_:1},8,["onClick","loading"])])):C("v-if",!0)])),default:j((()=>[""!==e.shareUrl?(k(),S("div",Ke,null,512)):C("v-if",!0),""!==e.shareUrl?(k(),S("div",We,[v("p",{title:e.shareUrl,class:"oneline"},I(e.shareUrl),9,Ze),w(s,{onClick:t[0]||(t[0]=t=>e.copyText(e.shareUrl))},{default:j((()=>[w(r)])),_:1})])):(k(),h(g,{key:2,model:e.form,"label-position":"top"},{default:j((()=>[w(c,{label:"访问密码"},{default:j((()=>[w(n,{modelValue:e.form.password,"onUpdate:modelValue":t[1]||(t[1]=t=>e.form.password=t),placeholder:"请输入访问密码"},null,8,["modelValue"])])),_:1}),w(c,{label:"访问权限"},{default:j((()=>[w(p,{modelValue:e.form.permission,"onUpdate:modelValue":t[2]||(t[2]=t=>e.form.permission=t),placeholder:"请选择访问权限"},{default:j((()=>[(k(!0),S(x,null,$(e.permissionOptions,(e=>(k(),h(d,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),w(c,{label:"有效期"},{default:j((()=>[w(m,{modelValue:e.form.exp,"onUpdate:modelValue":t[3]||(t[3]=t=>e.form.exp=t)},{default:j((()=>[w(u,{value:"10"},{default:j((()=>[Ye])),_:1}),w(u,{value:"30"},{default:j((()=>[Xe])),_:1}),w(u,{value:"60"},{default:j((()=>[et])),_:1})])),_:1},8,["modelValue"])])),_:1}),C(' <el-tag type="warning" style="margin-top:10px" v-if="!editInfo">分享的有效期为1天，请及时通知对方接收，用户接收后将会自动删除文件</el-tag> ')])),_:1},8,["model"]))])),_:1},8,["modelValue","before-close"])}],["__scopeId","data-v-b0c04fee"],["__file","D:/project/pixel-grid/src/components/dialog/ShareProjectDialog.vue"]]),AddProjectGroupDialog:Me},props:{},emits:[],setup(e,t){const{proxy:a}=D(),o=p();let l=u({isExporting:!1,NewProjectVisible:!1,PublishProjectVisible:!1,ShareProjectVisible:!1,editProjectInfo:null,isloading:!0,searchValue:"",searchData:[],loadingText:"正在加载...",isBackupsing:!1,backupsProjectId:"",selectedProject:new Map,UploadFileVisible:!1,count:0,scrollHeight:0,currentPage:1,pageSize:20,totalCount:0,backupsProjectOptions:{id:null,projectName:"",projectId:"",desc:"-",width:"32",height:"32",isTop:"0",authorUid:"",createAt:"",updateAt:"",backupUpdatedAt:""},isPullBackupsing:!1,alreadySyncBackup:0,syncBackupArr:[],isShowNoticeTag:!0,isExpandGroup:!1,searchGroup:"",searchGroupData:[],currentGroup:"0",projectGroupVisible:!1,projectList:[],projectGroupData:null,isSelectGroup:!1,isLocalProject:!1,currentDirectoryHandle:null,currentFileHandle:null,directoryStack:[]});const i={getFrameImg:H((()=>e=>e.data?""!==e.data[0].currentFrameImg&&null!==e.data[0].currentFrameImg?e.data[0].currentFrameImg:"/"===e.frameImg[0]?`${a.$config.HUAWEI_OBS_CONFIG.HOST}${e.frameImg}`:ge:ge)),getGroupImg:H((()=>e=>{if(!e.list.length){if("0"===e.value){return o.projectList.slice(0,1).map((e=>{var t,a,o;return(null==(t=e.data)?void 0:t.data)&&(null==(a=e.data)?void 0:a.data.length)&&(null==(o=e.data)?void 0:o.data[0].currentFrameImg)||""}))[0]}return""}return e.list.slice(0,1).map((e=>{var t,a,l;const i=o.projectList.find((t=>t.id===e));return i&&(null==(t=i.data)?void 0:t.data)&&(null==(a=i.data)?void 0:a.data.length)&&(null==(l=i.data)?void 0:l.data[0].currentFrameImg)||""}))[0]})),getProjectList:H((()=>o.projectList.slice(l.pageSize*l.currentPage-l.pageSize,l.pageSize*l.currentPage))),checkBackupCount:H((()=>{var e,t;let a=(null==(e=o.userData)?void 0:e.backupCount)||"0",l=(null==(t=o.userData)?void 0:t.vip)||"0",i=a/(Number(o.versionInfoData[Number(l)].count)+Number(o.userData.extraBackupCount||0));return i<=.5?"success":i>.5&&i<=.75?"warning":"danger"}))};let r={handleBatchCommand(e){"1"===e?r.handleBatchDeleteProject():"2"===e?r.handleBatchExportProject():"3"===e?r.handleBatchBackupProject():"4"===e&&(l.projectGroupVisible=!0,l.isSelectGroup=!0)},handleCurrentChange(e){l.currentPage=e,l.scrollHeight=0,r.getProjectByGroup(),E((()=>{let e=a.$refs.scroll;e&&(e.scrollTop=l.scrollHeight)}))},handleScroll(e){l.scrollHeight=e.target.scrollTop},handleReset(){if(l.selectedProject.size>0)return l.selectedProject.clear();l.searchData.length=0,l.searchValue=""},handleSelectProject(e){l.selectedProject.has(e.projectId)?l.selectedProject.delete(e.projectId):l.selectedProject.set(e.projectId,e)},handleAllSelect(){let e=l.searchData.length?l.searchData:l.projectList;for(let t=0;t<e.length;t++)l.selectedProject.set(e[t].data.projectId,e[t].data)},handleBatchExportProject(){if(0===l.selectedProject.size)return a.$message.warning("请选择项目后导出");Y.prompt("请输入导出的文件名称","批量导出项目",{confirmButtonText:"确 认",cancelButtonText:"取 消"}).then((async({value:e})=>{const t=new A;let o=0;Array.from(l.selectedProject.keys()).forEach((i=>{let r=l.selectedProject.get(i).projectName;const s=JSON.stringify(l.selectedProject.get(i)),n=new Blob([s],{type:""});t.file(`${r}.json`,n,{blob:!0}),o++,o>=l.selectedProject.size&&t.generateAsync({type:"blob"}).then((t=>{X.saveAs(t,`${e}.zip`),a.$message.success("导出成功"),l.selectedProject.clear()}))}))})).catch((e=>{}))},handleBatchDeleteProject(){var e;if(0===l.selectedProject.size)return a.$message.warning("请选择项目后删除");let t=Array.from(l.selectedProject.keys()),i=!1;for(let a=0;a<t.length;a++)if(null==(e=l.selectedProject.get(t[a]))?void 0:e.isBackup){i=!0;break}if(i)return a.$message.warning("选中项目存在已备份项目，无法执行批量删除");Y.confirm("是否删除选中的项目？","提 示",{confirmButtonText:"确 认",cancelButtonText:"取 消",type:"warning"}).then((()=>{let e=[];Array.from(l.selectedProject.keys()).forEach((async t=>{o.deleteProjectToGroup(l.currentGroup,l.selectedProject.get(t).projectId);let a=await o.deleteProjectById(l.selectedProject.get(t).projectId);e.push(a)})),Promise.all(e).then((e=>{l.selectedProject.clear(),a.$message.success("删除成功"),r.getProjectByGroup()})).catch((e=>{a.$message.error("删除失败 - "+e)}))})).catch((()=>{}))},async handleBatchBackupProject(){if(o.checkVipFunction("batchBackup"))return;if(0===l.selectedProject.size)return a.$message.warning("请选择项目后备份");l.isPullBackupsing=!0;let e=Array.from(l.selectedProject.keys());for(let t=0;t<e.length;t++)await r.handleBackupProject(l.selectedProject.get(e[t])),l.selectedProject.delete(l.selectedProject.get(e[t]).projectId);l.isPullBackupsing=!1},handleCheckBackups(e=!0){var t,i,s;if(!(null==(t=o.userData)?void 0:t.browserId)||"0"===(null==(i=o.userData)?void 0:i.browserId)||(null==(s=o.userData)?void 0:s.browserId)===o.browserId)return e?a.$message.warning("暂无可同步备份"):"";if(l.alreadySyncBackup==o.userData.backupCount)return e?a.$message.warning("暂无可同步备份"):"";const n=a.$bmob.Query("Backups");n.equalTo("authorUid","==",o.userData.uid),n.count().then((e=>{e.count>0&&Y.confirm("检测到有可同步的项目备份文件，是否同步至本地？","提 示",{confirmButtonText:"确 认",cancelButtonText:"取 消",type:"warning"}).then((()=>{r.handlePullBackups()})).catch((()=>{}))})).catch((e=>{a.$message.warning("网络异常")}))},async handlePullBackups(){var e,t,i;if((null==(e=o.userData)?void 0:e.browserId)&&"0"!==(null==(t=o.userData)?void 0:t.browserId)&&(null==(i=o.userData)?void 0:i.browserId)!==o.browserId){if(l.syncBackupArr.length&&l.alreadySyncBackup!==o.userData.backupCount)return void r.handlePullBackupFileBySyncData();let e=100,t=0;const i=a.$bmob.Query("Backups");i.equalTo("authorUid","==",o.userData.uid),i.limit(e);for(let r=0;r<Math.ceil(o.userData.backupCount/e);r++)try{i.skip(r*e);const a=await i.find();t=a.count,l.syncBackupArr=[...l.syncBackupArr,...a.results]}catch(s){a.$message.error("备份拉取失败")}r.handlePullBackupFileBySyncData()}else a.$message.warning("暂无可同步备份")},async handlePullBackupFileBySyncData(){if(!l.syncBackupArr.length)return;let e=l.syncBackupArr.filter((e=>!o.projectList.some((t=>t.data.backupUpdatedAt&&t.data.backupUpdatedAt==e.backupUpdatedAt&&t.data.projectId===e.projectId))));if(0===e.length)return l.alreadySyncBackup=o.userData.backupCount,void r.handleUpdateUserBrowserId();l.alreadySyncBackup=l.syncBackupArr.length-e.length;for(let i=0;i<e.length;i++)try{const t=await r.handlePullBackupFile(e[i].projectId);let s=await ee(t);s&&(s.isBackup=!0,o.saveProject(s).then((t=>{t&&(l.alreadySyncBackup++,a.$message.success("项目（"+e[i].projectName+"）同步成功"),l.alreadySyncBackup==o.userData.backupCount&&r.handleUpdateUserBrowserId())})).catch((t=>{a.$message.error("项目（"+e[i].projectName+"）同步失败")})))}catch(t){a.$message.error("项目（"+e[i].projectName+"）同步失败")}},handleUpdateUserBrowserId(){o.updateUserInfo(a,{browserId:o.browserId},(async()=>{}),(e=>{}))},handlePullBackupFile:async e=>new Promise(((t,a)=>{te(`${o.userData.uid}/${e}.json`,(e=>{t(e)}),(e=>{a(e)}))})),getProjectByGroup(){var e;if(l.isloading=!0,l.loadingText="正在加载...","0"===l.currentGroup)return l.totalCount=o.projectList.length,l.projectList=o.projectList.slice(l.pageSize*l.currentPage-l.pageSize,l.pageSize*l.currentPage),void(l.isloading=!1);let t=null==(e=o.projectGroupList.find((e=>e.value===l.currentGroup)))?void 0:e.list;t.length||(l.projectList=[],l.totalCount=l.projectList.length,l.isloading=!1);const a=t.map((e=>o.projectList.find((t=>t.id===e))));l.projectList=a.slice(l.pageSize*l.currentPage-l.pageSize,l.pageSize*l.currentPage),l.totalCount=l.projectList.length,l.isloading=!1},handleSearch(){if(""===l.searchValue.trim())return a.$message.warning("请输入搜索内容");let e=new RegExp(l.searchValue,"i");return l.searchData=o.projectList.filter((t=>e.test(t.data.projectName))),l.searchData.length?void 0:a.$message.warning("搜索不到该项目")},async handleOpenProject(e){if(e.type&&"folder"===e.type)return l.directoryStack.push(e.entry),l.currentDirectoryHandle=e.entry,o.localProjectList=[],void(await r.populateFolderGrid(e.entry));if(e.type&&"file"===e.type){let t=e.data;return l.currentFileHandle=e.entry,t.isLargeCanvas&&"1"===t.isLargeCanvas?(l.isloading=!0,l.loadingText="正在打开本机项目",void a.$router.push({name:"draw",params:{projectId:"B"+t.projectId}})):(t.isLargeCanvas="1",l.isloading=!0,l.loadingText="正在打开本机项目",void a.$router.push({name:"draw",params:{projectId:"B"+t.projectId}}))}if(!e.isLargeCanvas||"1"!==e.isLargeCanvas)return e.updateAt=b(),e.tip="最近编辑",e.isLargeCanvas="1",void o.saveProject(e,!0).then((t=>{t&&(l.isloading=!0,l.loadingText="正在打开项目",a.$router.push({name:"draw",params:{projectId:"A"+e.projectId}}))})).catch((e=>{a.$message.error("项目打开异常")}));l.isloading=!0,l.loadingText="正在打开项目",a.$router.push({name:"draw",params:{projectId:"A"+e.projectId}})},async handleTopProject(e){let t=JSON.parse(JSON.stringify(e));t.isTop=0==e.isTop?"1":"0";try{await o.saveProject(t),e.isTop=0==e.isTop?"1":"0",a.$message.success(""+(0==e.isTop?"已取消置顶":"已置顶")),r.getProjectByGroup()}catch(l){a.$message.error("置顶失败 - "+l)}},handleEditProject(e){e.type&&"file"===e.type&&(l.currentFileHandle=e.entry,l.currentFileHandle.id=e.id,e=e.data),l.editProjectInfo=JSON.parse(JSON.stringify(e)),l.NewProjectVisible=!0},async handleBackupProject(e){if(o.checkVipFunction("backup"))return;l.isBackupsing=!0,l.backupsProjectId=e.projectId;let t=JSON.parse(JSON.stringify(e));l.backupsProjectOptions.createAt=t.createAt,l.backupsProjectOptions.updateAt=t.updateAt,l.backupsProjectOptions.isTop=String(t.isTop),l.backupsProjectOptions.desc=t.desc,l.backupsProjectOptions.projectName=t.projectName,l.backupsProjectOptions.width=String(t.width),l.backupsProjectOptions.height=String(t.height),l.backupsProjectOptions.projectId=t.projectId,l.backupsProjectOptions.authorUid=o.userData.uid,t.authorUid=o.userData.uid,l.backupsProjectOptions.id=null;const i=a.$bmob.Query("Backups");i.equalTo("authorUid","==",o.userData.uid),i.equalTo("projectId","==",l.backupsProjectOptions.projectId),i.limit(1);try{const e=await i.find(!1);return e.length?ae(e[0].updateAt)===ae(l.backupsProjectOptions.updateAt)?(l.isBackupsing=!1,a.$message.warning("当前项目已备份")):(l.backupsProjectOptions.id=e[0].objectId,await r.handleUploadFileToOBS(t)):await r.handleUploadFileToOBS(t)}catch(s){return l.isBackupsing=!1,new Promise(((e,t)=>t(s)))}},handleUploadFileToOBS(e){e.backupUpdatedAt=String((new Date).getTime());const t=JSON.stringify(e),i=new Blob([t],{type:""});return new Promise(((t,s)=>{T(i,`${o.userData.uid}/${l.backupsProjectOptions.projectId}.json`,(async a=>{try{await r.handleBmobPublish(e),t(!0)}catch(o){s(o)}}),(t=>{s(t),l.isBackupsing=!1,a.$message.error("项目（"+e.projectName+"）备份失败")}),(e=>{}))}))},handleDeletePoster(e){F(e,(e=>{l.isBackupsing=!1}),(e=>{l.isBackupsing=!1}))},handleDeleteToOBS:e=>new Promise(((t,a)=>{F(`${o.userData.uid}/${e}.json`,(e=>{t(!0)}),(e=>{a(e)}))})),handleBmobPublish:async e=>new Promise(((t,i)=>{const s=a.$bmob.Query("Backups");l.backupsProjectOptions.backupUpdatedAt=e.backupUpdatedAt;let n=Object.keys(l.backupsProjectOptions);for(let e=0;e<n.length;e++){let t=n[e];l.backupsProjectOptions[t]&&s.set(t,l.backupsProjectOptions[t])}s.save().then((async r=>{try{if(l.backupsProjectOptions.id)return e.isBackup=!0,await o.saveProject(e),void o.updateUserInfo(a,{browserId:o.browserId},(async()=>{l.isBackupsing=!1,a.$message.success("项目（"+e.projectName+"）备份成功")}),(e=>{l.isBackupsing=!1,i(e)}));o.updateUserInfo(a,{backupCount:String(Number(o.userData.backupCount||0)+1),browserId:o.browserId},(async()=>{e.isBackup=!0,await o.saveProject(e),l.isBackupsing=!1,a.$message.success("项目（"+e.projectName+"）备份成功"),t(!0)}),(e=>{l.isBackupsing=!1,i(e)}))}catch(s){l.isBackupsing=!1}})).catch((async t=>{l.isBackupsing=!1,a.$message.error("项目（"+e.projectName+"）备份失败");try{await r.handleDeleteToOBS(l.backupsProjectOptions.projectId),i(t)}catch(s){i(t)}o.saveErrorToBmob("备份项目",t)}))})),handlePublishProject(e,t=!1){o.checkIsLogin()||(l.editProjectInfo=JSON.parse(JSON.stringify(e)),l.editProjectInfo.activityCode="0",t&&(l.editProjectInfo.activityCode="1"),l.PublishProjectVisible=!0)},handleShareProject(e){o.checkIsLogin()||(l.editProjectInfo=JSON.parse(JSON.stringify(e)),l.ShareProjectVisible=!0)},async handleExportProject(e){l.isExporting=!0;let t=JSON.parse(JSON.stringify(e));delete t.isBackup,delete t.backupUpdatedAt,delete t.authorUid;let o=await ue(t);if(!o){const t=JSON.stringify(e);return o=new Blob([t],{type:""}),X.saveAs(o,`${e.projectName}.json`),a.$message.success("导出成功"),void(l.isExporting=!1)}X.saveAs(o,`${e.projectName}.px`),a.$message.success("导出成功"),l.isExporting=!1},handleDeleteProject(e){if(e.type&&"file"===e.type)return l.currentFileHandle=e.entry,l.currentFileHandle.id=e.id,void Y.confirm("是否删除该本机项目？","提 示",{confirmButtonText:"确 认",cancelButtonText:"取 消",type:"warning"}).then((async()=>{try{const e=l.directoryStack[l.directoryStack.length-1];await e.removeEntry(l.currentFileHandle.name);let t=o.localProjectList.findIndex((e=>e.id===l.currentFileHandle.id));t>=0&&(o.localProjectList.splice(t,1),l.currentFileHandle=null,o.localProjectList=[],await r.populateFolderGrid(e)),a.$message.success("删除成功")}catch(e){a.$message.error("删除失败")}})).catch((()=>{}));let{projectId:t,isBackup:i,projectName:s}=e;i?Y.confirm(`项目（${s}）已备份，是否删除该备份项目？`,"提 示",{confirmButtonText:"确 认",cancelButtonText:"取 消",type:"error",beforeClose:(l,i,s)=>{if("confirm"===l){i.confirmButtonLoading=!0,i.confirmButtonText="正在删除...";const l=a.$bmob.Query("Backups");l.equalTo("authorUid","==",o.userData.uid),l.equalTo("projectId","==",t),l.limit(1),l.find(!1).then((async t=>{if(t.length)l.destroy(t[0].objectId).then((async l=>{try{await r.handleDeleteToOBS(t[0].projectId),o.updateUserInfo(a,{backupCount:String(Math.max(0,Number(o.userData.backupCount||0)-1)),browserId:o.browserId},(async()=>{e.isBackup=!1,e.backupUpdatedAt="0",e.authorUid="0",await o.saveProject(e),a.$message.success("删除成功"),s()}),(async t=>{var a,l;e.isBackup=!1,e.backupUpdatedAt="0",e.authorUid="0",await o.saveProject(e),(null==(a=o.userData)?void 0:a.backupCount)&&(null==(l=o.userData)?void 0:l.backupCount)>0&&(o.userData.backupCount=String(Math.max(0,Number(o.userData.backupCount||0)-1))),s()}))}catch(i){}})).catch((e=>{a.$message.error("备份项目删除失败")}));else{e.isBackup=!1,e.backupUpdatedAt="0",e.authorUid="0";try{await o.saveProject(e)}catch(i){}a.$message.warning("备份项目不存在或已被删除"),s()}})).catch((e=>{a.$message.error("网络异常，请稍后再试"),i.confirmButtonText="确 认",i.confirmButtonLoading=!1}))}else{if(i.confirmButtonLoading)return;s()}}}).then((()=>{})).catch((()=>{})):Y.confirm("是否删除该项目？","提 示",{confirmButtonText:"确 认",cancelButtonText:"取 消",type:"warning"}).then((()=>{o.deleteProjectById(t).then((e=>{e&&(a.$message.success(e),o.deleteProjectToGroup(l.currentGroup,t),r.getProjectByGroup())})).catch((e=>{a.$message.error("删除失败 - "+e)}))})).catch((()=>{}))},handleImportProject(e){l.isloading=!0,l.loadingText="正在导入项目";for(let i=0;i<e.length;i++)try{const t=new FileReader;t.onload=async function(t){let s=t.target.result;if(s="application/json"===e[i].raw.type?JSON.parse(t.target.result):await me(t.target.result),!s.projectId)return l.count++,void(l.count>=e.length&&(a.$message.error(e[i].name+a.$t("message.importFailed")+"，请检查项目文件是否完整！"),l.isloading=!1,l.count=0));s.projectId=y.v1(),s.createAt=b(),s.updateAt=s.createAt,s.tip="新项目",o.saveProject(s).then((t=>{t&&(l.count++,l.count>=e.length&&(a.$message.success(a.$t("message.importSucceeded")),o.addProjectToGroup(l.currentGroup,l.currentGroup,s.projectId),l.isloading=!1,l.count=0,r.getProjectByGroup()))})).catch((t=>{l.count++,a.$message.error(e[i].name+a.$t("message.importFailed")),l.count>=e.length&&(l.isloading=!1,l.count=0)}))},"application/json"===e[i].raw.type?t.readAsText(e[i].raw):t.readAsArrayBuffer(e[i].raw)}catch(t){l.isloading=!1,a.$message.error(e[i].name+a.$t("message.importFailed"))}},handleCopyProject(e){const t=JSON.parse(JSON.stringify(e));t.projectId=y.v1(),t.createAt=b(),t.updateAt=t.createAt,t.tip="新项目",o.saveProject(t).then((e=>{e&&a.$message.success("复制成功")})).catch((e=>{a.$message.error("复制失败")}))},handleImportProject1(){const e=document.createElement("input");e.type="file",e.accept="application/json",e.addEventListener("change",(function(){const t=e.files[0];if(t){if(["image/jpeg","image/png","image/gif","image/bmp","image/svg+xml"].includes(t.type))return a.$message.warning("导入文件格式不正确，确保导入的是项目文件而非图片文件");l.isloading=!0,l.loadingText="正在导入项目";const e=new FileReader;e.onload=function(e){const t=JSON.parse(e.target.result);t.projectId=y.v1(),t.createAt=b(),t.updateAt=t.createAt,t.tip="新项目",o.saveProject(t).then((e=>{e&&(a.$message.success(a.$t("message.importSucceeded")),l.isloading=!1)})).catch((e=>{a.$message.error(a.$t("message.importFailed")),l.isloading=!1}))},e.readAsText(t)}})),document.body.appendChild(e),e.click(),document.body.removeChild(e)},handleExpand(){l.isExpandGroup=!l.isExpandGroup;let e=document.querySelector(".project-group"),t=document.querySelector(".back-icon");l.isExpandGroup?(e.style.transform="translateX(0)",t.children[0].style.transform="rotate(0deg)"):(e.style.transform="translateX(100%)",t.children[0].style.transform="rotate(180deg)")},handleSearchGroup(){if(""===l.searchGroup.trim())return l.searchGroupData=[],a.$message.warning("请输入搜索内容");let e=new RegExp(l.searchGroup,"i");return l.searchGroupData=o.projectGroupList.filter((t=>e.test(t.label))),l.searchGroupData.length?void 0:a.$message.warning("搜索不到该分组")},handleOpenProjectGroup(e){l.currentGroup=e.value,l.currentPage=1,r.getProjectByGroup()},handleEditProjectGroup(e){l.projectGroupVisible=!0,l.isSelectGroup=!1,l.projectGroupData=JSON.parse(JSON.stringify(e))},handleDeleteProjectGroup(e){let t=o.projectGroupList.findIndex((t=>t.value===e.value));t<0||(o.projectGroupList.splice(t,1),a.$utils.cache.projectGroup.set(JSON.stringify(o.projectGroupList)))},handleAddProjectToGroup(e){let t=Array.from(l.selectedProject.keys());if(!t.length)return a.$message.warning("请选择项目后分组");for(let a=0;a<t.length;a++)o.addProjectToGroup(l.currentGroup,e,t[a]);a.$message.success("添加完成"),l.selectedProject.clear(),r.getProjectByGroup()},async handleOpenLocalProject(){if(l.isLocalProject)return l.isLocalProject=!1,o.localProjectList=[],l.currentDirectoryHandle=null,void(l.directoryStack=[]);l.isLocalProject=!0;try{const e=await window.showDirectoryPicker();l.currentDirectoryHandle=e,l.directoryStack=[e],o.localProjectList=[],await r.populateFolderGrid(e)}catch(e){a.$message.error("无法打开本机文件夹")}},async populateFolderGrid(e){l.isloading=!0;for await(const a of e.values())if("directory"===a.kind){let e={type:"folder",id:y.v4(),name:a.name,entry:a};o.localProjectList.push(e)}else if("file"===a.kind&&(a.name.endsWith(".json")||a.name.endsWith(".px"))){let e=null;try{const t=await a.getFile();if(a.name.endsWith(".json")){const a=await t.text();e=JSON.parse(a)}else if(a.name.endsWith(".px")){const a=await t.arrayBuffer();e=await me(a)}if(e&&e.projectId){if(e.data){let t=await oe(e.data[0].currentFrameImg);e.data[0].currentFrameImg=t}e.isLocalFile=a.name.endsWith(".json")?"1":"2";let t={type:"file",id:e.projectId,name:a.name,entry:a,data:e};o.localProjectList.push(t)}}catch(t){}}l.isloading=!1},async handleBackFolder(){l.directoryStack.length>1&&(l.directoryStack.pop(),l.currentDirectoryHandle=l.directoryStack[l.directoryStack.length-1],o.localProjectList=[],await r.populateFolderGrid(l.currentDirectoryHandle))},async handleSaveLocalProject(e,t){if(l.currentFileHandle)try{const i=await l.currentFileHandle.createWritable();if("1"===e.isLocalFile)delete e.isLocalFile,await i.write(JSON.stringify(e));else{delete e.isLocalFile;let t=await ue(e);t&&await i.write(t)}await i.close(),a.$message.success("保存成功"),t();const s=l.directoryStack[l.directoryStack.length-1];l.currentFileHandle=null,o.localProjectList=[],await r.populateFolderGrid(s)}catch(i){a.$message.error("保存失败"),t()}else try{const i=await l.currentDirectoryHandle.getFileHandle(`${e.projectName}.json`,{create:!0}),s=await i.createWritable();await s.write(JSON.stringify(e)),await s.close(),o.localProjectList=[],await r.populateFolderGrid(l.currentDirectoryHandle),a.$message.success("创建成功"),t()}catch(i){a.$message.success("创建失败"),t()}},async handleReloadLocalProject(){const e=l.directoryStack[l.directoryStack.length-1];l.currentFileHandle=null,o.localProjectList=[],await r.populateFolderGrid(e)}};return J((()=>{""===l.searchValue.trim()&&(l.searchData=[])})),q((()=>o.isQueryProjectData),((e,t)=>{"1"!==e&&"2"!==e||(l.isloading=!1,l.totalCount=o.projectList.length)}),{immediate:!0}),q((()=>o.projectList),((e,t)=>{e&&r.getProjectByGroup()}),{immediate:!0}),q((()=>o.isLogin),((e,t)=>{e||(l.alreadySyncBackup=0,l.syncBackupArr=[])})),m((()=>{r.getProjectByGroup(),r.handleCheckBackups(!1)})),M((()=>{E((()=>{let e=a.$refs.scroll;e&&(e.scrollTop=l.scrollHeight)})),l.isLocalProject&&r.handleReloadLocalProject()})),Q((()=>{l.isloading=!1})),n(s(n(s(s({},g(l)),r),{editSpaceStore:o,ArrowDownBold:K}),i),{isMobile:W,isSupportPaintWorklet:Z})}}),it="/static/webp/group-6bb8d4aa.webp";const rt={class:"full-layout flex-center routerview scrollHidden"},st={class:"project-group"},nt={class:"group-body scrollbar full-layout"},ct={class:"group-title flex-between"},dt=P(" 项目分组 "),pt={class:"input-search"},ut={class:"scrollbar scrollAuto grid-box"},mt=["onClick"],gt={class:"frameImg flex-center"},ft={class:"image-slot full-h"},ht=["src"],jt={class:"info"},bt={class:"flex-between",style:{"padding-bottom":"5px"}},yt={class:"oneline project-name"},kt={class:"twoline",style:{"font-size":"14px",display:"-webkit-inline-box",color:"#808080"}},vt=["element-loading-text"],wt={style:{padding:"10px 20px",gap:"10px"},class:"flex-start flex-warp"},Pt=P(" 须知：已备份的项目，只有在已登录状态下才能看见喔！ "),It={class:"flex-between flex-warp",style:{padding:"0px 20px 10px","row-gap":"10px"}},Ct={class:"title flex-start flex-warp",style:{gap:"10px"}},St={class:"folder-back-icon pointer"},xt={key:0,class:"flex-start flex-warp",style:{gap:"10px"}},$t=P("全 选"),Bt=P("批量操作 "),Dt=P("批量删除"),At=P("批量导出"),_t=P("批量备份"),Ot=P("批量分组"),Vt={key:1,class:"flex-start flex-warp",style:{gap:"10px"}},Lt=P("全 选"),Ut=P("批量操作 "),Gt=P("批量删除"),Tt=P("批量导出"),Ft=P("批量备份"),Nt=P("批量分组"),zt=["onClick"],Rt=["onDblclick"],Et=["src"],Ht={class:"image-slot full-h"},Jt=["src"],qt=P("已备份"),Mt=P(" 正在备份 "),Qt={class:"info"},Kt={class:"flex-between",style:{"padding-bottom":"5px"}},Wt=["title"],Zt=P("复 制"),Yt=P("发 布"),Xt=P(I("备 份")),ea=P("分 享"),ta={class:"twoline",style:{"font-size":"14px",display:"-webkit-inline-box",color:"#808080"}},aa={key:0,class:"flex-center full-w",style:{padding:"10px"}},oa=["onDblclick"],la=["src"],ia={class:"image-slot full-h"},ra=["src"],sa={class:"info"},na={class:"flex-between",style:{"padding-bottom":"5px"}},ca=["title"],da=["title"],pa={key:0,class:"twoline",style:{"font-size":"14px",display:"-webkit-inline-box",color:"#808080"}},ua={key:0,class:"flex-center full-w",style:{padding:"10px"}},ma={key:2,class:"full-layout flex-center scrollbar scrollAuto"};var ga=c(lt,[["render",function(e,t,a,o,l,i){var r,s,n,c;const d=f("Expand"),p=f("el-icon"),u=f("CirclePlusFilled"),m=f("Search"),g=f("el-skeleton-item"),b=f("el-skeleton"),y=f("el-image"),D=f("el-button"),A=f("el-dropdown-item"),_=f("el-dropdown-menu"),O=f("el-dropdown"),V=f("el-divider"),L=f("el-tooltip"),U=f("InfoFilled"),G=f("el-tag"),T=f("RefreshRight"),F=f("Delete"),N=f("ArrowLeft"),z=f("search"),R=f("el-input"),E=f("px-button"),H=f("arrow-down"),J=f("px-dropdown-item"),q=f("px-dropdown-menu"),M=f("px-dropdown"),Q=f("Loading"),K=f("el-pagination"),W=f("el-empty"),Z=f("NewProjectDialog"),Y=f("PublishDialog"),X=f("ShareProjectDialog"),ee=f("UploadFileDialog"),te=f("AddProjectGroupDialog"),ae=le("loading");return k(),S("div",rt,[v("div",st,[v("div",{class:"back-icon",onClick:t[0]||(t[0]=(...t)=>e.handleExpand&&e.handleExpand(...t))},[w(p,null,{default:j((()=>[w(d)])),_:1})]),v("div",nt,[v("p",ct,[dt,w(p,{onClick:t[1]||(t[1]=t=>{e.projectGroupVisible=!0,e.isSelectGroup=!1})},{default:j((()=>[w(u)])),_:1})]),v("div",pt,[w(p,null,{default:j((()=>[w(m)])),_:1}),ie(v("input",{type:"text","onUpdate:modelValue":t[2]||(t[2]=t=>e.searchGroup=t),placeholder:"请搜索分组",onKeyup:t[3]||(t[3]=se(((...t)=>e.handleSearchGroup&&e.handleSearchGroup(...t)),["enter"]))},null,544),[[re,e.searchGroup]])]),v("div",ut,[(k(!0),S(x,null,$(e.searchGroupData.length?e.searchGroupData:e.editSpaceStore.projectGroupList,(a=>(k(),S("div",{class:B([{active:a.value===e.currentGroup},"project-item"]),onClick:t=>e.handleOpenProjectGroup(a),key:a.id},[v("div",gt,[w(y,{src:e.getGroupImg(a),fit:"contain"},{placeholder:j((()=>[w(b,{animated:"",class:"full-layout"},{template:j((()=>[w(g,{variant:"image",style:{height:"100%"}})])),_:1})])),error:j((()=>[v("div",ft,[v("img",{src:it,style:{"object-fit":"contain","image-rendering":"auto"}},null,8,ht)])])),_:2},1032,["src"])]),v("div",jt,[v("div",bt,[v("h4",yt,I(a.label),1),"0"!==a.value?(k(),h(O,{key:0,trigger:"click",size:"small"},{dropdown:j((()=>[w(_,null,{default:j((()=>[w(A,{onClick:t=>e.handleEditProjectGroup(a),icon:"Edit"},{default:j((()=>[P(I(e.$t("message.edit")),1)])),_:2},1032,["onClick"]),w(A,{onClick:t=>e.handleDeleteProjectGroup(a),icon:"Delete"},{default:j((()=>[P(I(e.$t("message.delete")),1)])),_:2},1032,["onClick"])])),_:2},1024)])),default:j((()=>[w(D,{type:"primary",icon:e.ArrowDownBold,size:"small",onClick:t[4]||(t[4]=ce((()=>{}),["stop"])),style:{"margin-left":"5px"}},null,8,["icon"])])),_:2},1024)):C("v-if",!0)]),w(V,{"border-style":"dashed","content-position":"left",style:{margin:"5px 0"}}),w(L,{content:a.desc,effect:"light"},{default:j((()=>[v("div",kt,I(a.desc),1)])),_:2},1032,["content"])])],10,mt)))),128))])])]),ie((k(),S("div",{class:"full-layout flex flex-column","element-loading-text":e.loadingText,"element-loading-background":"#00000020"},[v("div",wt,[ie(w(G,{type:"warning",effect:"dark",class:"notice-tag",closable:"",onClose:t[5]||(t[5]=t=>e.isShowNoticeTag=!1)},{default:j((()=>[w(p,{size:"16"},{default:j((()=>[w(U)])),_:1}),Pt])),_:1},512),[[ne,e.isShowNoticeTag]]),C(' <el-tag type="danger" effect="dark" class="notice-tag" closable @close="isShowNoticeTag = false" v-show="isShowNoticeTag">\r\n                    <template #default>\r\n                        <el-icon size="16"><InfoFilled /></el-icon>\r\n                        旧版项目模式将不再进行维护，请各位用户使用新版大画布模式！\r\n                    </template>\r\n                </el-tag> ')]),v("div",It,[v("h2",Ct,[P(I(e.isLocalProject?"本机项目":e.$t("message.mineProject"))+" ",1),e.editSpaceStore.userData&&!e.isLocalProject&&e.editSpaceStore.versionInfoData?(k(),S(x,{key:0},[w(G,{type:e.checkBackupCount},{default:j((()=>[P("已备份: "+I(e.editSpaceStore.userData.backupCount||"0")+" / "+I(Number(e.editSpaceStore.versionInfoData[Number(e.editSpaceStore.userData.vip)||0].count)+Number(e.editSpaceStore.userData.extraBackupCount||0)),1)])),_:1},8,["type"]),(null==(r=e.editSpaceStore.userData)?void 0:r.backupCount)>0&&(null==(s=e.editSpaceStore.userData)?void 0:s.browserId)&&"0"!==(null==(n=e.editSpaceStore.userData)?void 0:n.browserId)&&(null==(c=e.editSpaceStore.userData)?void 0:c.browserId)!==e.editSpaceStore.browserId?(k(),h(G,{key:0,type:"primary"},{default:j((()=>[P(I(e.alreadySyncBackup==e.editSpaceStore.userData.backupCount?"已同步":"待同步")+": "+I(e.alreadySyncBackup)+" / "+I(e.editSpaceStore.userData.backupCount||"0"),1)])),_:1})):C("v-if",!0),w(L,{content:"同步备份",placement:"bottom"},{default:j((()=>[w(p,{onClick:e.handleCheckBackups,class:B({"is-loading":e.isPullBackupsing}),style:de({pointerEvents:e.isPullBackupsing?"none":"auto",cursor:e.isPullBackupsing?"not-allowed":"pointer"})},{default:j((()=>[w(T)])),_:1},8,["onClick","class","style"])])),_:1}),w(L,{effect:"dark",content:"回收站",placement:"bottom"},{default:j((()=>{var a;return[(null==(a=e.editSpaceStore.userData)?void 0:a.vip)>1?(k(),h(p,{key:0,class:"pointer",onClick:t[6]||(t[6]=t=>e.$router.push("/recycle"))},{default:j((()=>[w(F)])),_:1})):C("v-if",!0)]})),_:1})],64)):e.isLocalProject?(k(),h(L,{key:1,content:"返回上一级",placement:"bottom"},{default:j((()=>[v("div",St,[w(p,{onClick:e.handleBackFolder},{default:j((()=>[w(N)])),_:1},8,["onClick"])])])),_:1})):C("v-if",!0)]),e.isSupportPaintWorklet()?(k(),S("div",xt,[w(R,{disabled:e.isLocalProject,modelValue:e.searchValue,"onUpdate:modelValue":t[7]||(t[7]=t=>e.searchValue=t),clearable:"",placeholder:e.$t("message.pleaseSearchProject"),onKeyup:se(e.handleSearch,["enter"]),style:{"max-width":"150px"}},{prefix:j((()=>[w(p,{class:"el-input__icon"},{default:j((()=>[w(z)])),_:1})])),_:1},8,["disabled","modelValue","placeholder","onKeyup"]),w(E,{round:"",disabled:e.isLocalProject,type:"primary",onClick:e.handleReset},{default:j((()=>[P(I(e.$t("message.reset")),1)])),_:1},8,["disabled","onClick"]),w(E,{round:"",type:"primary",onClick:e.handleAllSelect,disabled:e.isLocalProject},{default:j((()=>[$t])),_:1},8,["onClick","disabled"]),w(M,{trigger:"click",disabled:e.isLocalProject,onCommand:e.handleBatchCommand},{dropdown:j((()=>[w(q,null,{default:j((()=>[w(J,{onClick:e.handleBatchDeleteProject,command:"1"},{default:j((()=>[Dt])),_:1},8,["onClick"]),w(J,{onClick:e.handleBatchExportProject,command:"2"},{default:j((()=>[At])),_:1},8,["onClick"]),w(J,{onClick:e.handleBatchBackupProject,command:"3"},{default:j((()=>[_t])),_:1},8,["onClick"]),w(J,{onClick:t[8]||(t[8]=t=>{e.projectGroupVisible=!0,e.isSelectGroup=!0}),command:"4"},{default:j((()=>[Ot])),_:1})])),_:1})])),default:j((()=>[w(E,{type:"primary",round:"",disabled:e.isLocalProject},{default:j((()=>[Bt,w(p,{class:"el-icon--right"},{default:j((()=>[w(H)])),_:1})])),_:1},8,["disabled"])])),_:1},8,["disabled","onCommand"]),w(E,{round:"",type:"primary",disabled:e.isLocalProject,onClick:t[9]||(t[9]=t=>{e.UploadFileVisible=!0})},{default:j((()=>[P(I(e.$t("message.importProject")),1)])),_:1},8,["disabled"]),w(E,{round:"",type:"primary",onClick:t[10]||(t[10]=t=>{e.NewProjectVisible=!0,e.editProjectInfo=null})},{default:j((()=>[P(I(e.$t("message.newProject")),1)])),_:1}),e.isMobile()?C("v-if",!0):(k(),h(E,{key:0,round:"",type:"success",onClick:e.handleOpenLocalProject},{default:j((()=>[P(I(e.isLocalProject?"取消浏览":"浏览本机项目"),1)])),_:1},8,["onClick"]))])):(k(),S("div",Vt,[w(R,{disabled:e.isLocalProject,modelValue:e.searchValue,"onUpdate:modelValue":t[11]||(t[11]=t=>e.searchValue=t),clearable:"",placeholder:e.$t("message.pleaseSearchProject"),onKeyup:se(e.handleSearch,["enter"]),style:{"max-width":"150px"}},{prefix:j((()=>[w(p,{class:"el-input__icon"},{default:j((()=>[w(z)])),_:1})])),_:1},8,["disabled","modelValue","placeholder","onKeyup"]),w(D,{disabled:e.isLocalProject,type:"primary",onClick:e.handleReset},{default:j((()=>[P(I(e.$t("message.reset")),1)])),_:1},8,["disabled","onClick"]),w(D,{type:"primary",onClick:e.handleAllSelect,disabled:e.isLocalProject},{default:j((()=>[Lt])),_:1},8,["onClick","disabled"]),w(O,{trigger:"click",disabled:e.isLocalProject},{dropdown:j((()=>[w(_,null,{default:j((()=>[w(A,{onClick:e.handleBatchDeleteProject},{default:j((()=>[Gt])),_:1},8,["onClick"]),w(A,{onClick:e.handleBatchExportProject},{default:j((()=>[Tt])),_:1},8,["onClick"]),w(A,{onClick:e.handleBatchBackupProject},{default:j((()=>[Ft])),_:1},8,["onClick"]),w(A,{onClick:t[12]||(t[12]=t=>{e.projectGroupVisible=!0,e.isSelectGroup=!0})},{default:j((()=>[Nt])),_:1})])),_:1})])),default:j((()=>[w(D,{type:"primary",disabled:e.isLocalProject},{default:j((()=>[Ut,w(p,{class:"el-icon--right"},{default:j((()=>[w(H)])),_:1})])),_:1},8,["disabled"])])),_:1},8,["disabled"]),w(D,{type:"primary",disabled:e.isLocalProject,onClick:t[13]||(t[13]=t=>{e.UploadFileVisible=!0})},{default:j((()=>[P(I(e.$t("message.importProject")),1)])),_:1},8,["disabled"]),w(D,{type:"primary",onClick:t[14]||(t[14]=t=>{e.NewProjectVisible=!0,e.editProjectInfo=null})},{default:j((()=>[P(I(e.$t("message.newProject")),1)])),_:1}),e.isMobile()?C("v-if",!0):(k(),h(D,{key:0,type:"success",onClick:e.handleOpenLocalProject},{default:j((()=>[P(I(e.isLocalProject?"取消浏览":"浏览本机项目"),1)])),_:1},8,["onClick"]))]))]),!e.projectList.length&&!e.searchData.length||e.isloading||e.isLocalProject?e.editSpaceStore.localProjectList.length&&!e.isloading&&e.isLocalProject?(k(),S(x,{key:1},[v("div",{class:"full-layout scrollbar scrollAuto grid-box",onScroll:t[19]||(t[19]=(...t)=>e.handleScroll&&e.handleScroll(...t)),ref:"scroll"},[(k(!0),S(x,null,$(e.editSpaceStore.localProjectList,(a=>(k(),S("div",{key:a.id,class:"project-item"},[v("div",{class:"frameImg flex-center",onDblclick:ce((t=>e.handleOpenProject(a)),["stop"])},["folder"===a.type?(k(),S("img",{key:0,src:it,class:"folderImg"},null,8,la)):(k(),S(x,{key:1},[C(' <img :src="getFrameImg(item.data)" v-else class="previewImg"/> '),w(y,{src:e.getFrameImg(a.data),fit:"contain"},{placeholder:j((()=>[w(b,{animated:"",class:"full-layout"},{template:j((()=>[w(g,{variant:"image",style:{height:"100%"}})])),_:1})])),error:j((()=>[v("div",ia,[v("img",{src:ge},null,8,ra)])])),_:2},1032,["src"])],2112)),a.data?(k(),h(G,{key:2,type:"success",class:"size"},{default:j((()=>[P(I(a.data.width)+"x"+I(a.data.height),1)])),_:2},1024)):C("v-if",!0),C(' <el-tag type="primary" effect="dark" v-if="item.data.tip!==\'\'" class="tip">{{ item.data.tip }}</el-tag> ')],40,oa),v("div",sa,[v("div",na,["folder"===a.type?(k(),S("h4",{key:0,class:"oneline project-name",title:a.name},I(a.name),9,ca)):C("v-if",!0),"file"===a.type?(k(),S("h4",{key:1,class:"oneline project-name",title:a.data.projectName},I(a.data.projectName),9,da)):C("v-if",!0),"file"===a.type?(k(),h(O,{key:2,trigger:"click",size:"small"},{dropdown:j((()=>[w(_,null,{default:j((()=>[w(A,{onClick:t=>e.handleOpenProject(a),icon:"Open"},{default:j((()=>[P(I(e.$t("message.open")),1)])),_:2},1032,["onClick"]),w(A,{onClick:t=>e.handleEditProject(a),icon:"Edit"},{default:j((()=>[P(I(e.$t("message.edit")),1)])),_:2},1032,["onClick"]),C(" <el-dropdown-item @click=\"handleTopProject(item.data)\" icon=\"Upload\">{{ item.data.isTop > 0 ? $t('message.cancelTop') : $t('message.top')}}</el-dropdown-item> "),C(' <el-dropdown-item @click="handleExportProject(item.data)" :disabled="isExporting" icon="FolderOpened">{{ isExporting ? $t(\'message.exportLoading\') : $t(\'message.export\')}}</el-dropdown-item> '),C(' <el-dropdown-item @click="handlePublishProject(item.data)" icon="FolderChecked">发 布</el-dropdown-item> '),C(' <el-dropdown-item @click="handlePublishProject(item.data, true)" icon="FolderAdd">投 稿</el-dropdown-item> '),C(' <el-dropdown-item @click="handleBackupProject(item.data)" icon="MostlyCloudy" :disabled="isBackupsing">{{\'备 份\'}}</el-dropdown-item> '),w(A,{onClick:t=>e.handleDeleteProject(a),icon:"Delete"},{default:j((()=>[P(I(e.$t("message.delete")),1)])),_:2},1032,["onClick"])])),_:2},1024)])),default:j((()=>["file"===a.type?(k(),h(D,{key:0,type:"primary",icon:e.ArrowDownBold,size:"small",onClick:t[18]||(t[18]=ce((()=>{}),["stop"])),style:{"margin-left":"5px"}},null,8,["icon"])):C("v-if",!0)])),_:2},1024)):C("v-if",!0)]),w(V,{"border-style":"dashed","content-position":"left",style:{margin:"5px 0"}},{default:j((()=>[P(I(a.data?a.data.updateAt:""),1)])),_:2},1024),w(L,{content:(null==a?void 0:a.data)?a.data.desc:"",effect:"light"},{default:j((()=>[a.data?(k(),S("div",pa,[C(" {{ item.desc !== '' ? $t(`message.${item.desc}`) : $t(`message.None`) }} "),P(I(a.data.desc),1)])):C("v-if",!0)])),_:2},1032,["content"])])])))),128))],544),e.searchData.length||e.editSpaceStore.localProjectList.length?C("v-if",!0):(k(),S("div",ua,[w(K,{"current-page":e.currentPage,"onUpdate:current-page":t[20]||(t[20]=t=>e.currentPage=t),"page-size":e.pageSize,background:"",layout:"total, prev, pager, next",total:e.totalCount,onCurrentChange:e.handleCurrentChange},null,8,["current-page","page-size","total","onCurrentChange"])]))],64)):e.isloading||e.searchData.length&&e.projectList.length&&e.editSpaceStore.localProjectList.length?C("v-if",!0):(k(),S("div",ma,[w(W,{image:fe,description:"空空如也","image-size":200},null,8,["image"])])):(k(),S(x,{key:0},[v("div",{class:"full-layout scrollbar scrollAuto grid-box",onScroll:t[16]||(t[16]=(...t)=>e.handleScroll&&e.handleScroll(...t)),ref:"scroll"},[(k(!0),S(x,null,$(e.searchData.length?e.searchData:e.projectList,(a=>(k(),S("div",{class:B([{active:e.selectedProject.has(a.id)},"project-item"]),onClick:t=>e.handleSelectProject(a.data),key:a.id},[v("div",{class:"frameImg flex-center",onDblclick:ce((t=>e.handleOpenProject(a.data)),["stop"])},[""===a.data.frameImg?(k(),S("img",{key:0,src:ge,class:"emptyImg"},null,8,Et)):(k(),S(x,{key:1},[C(' <img :src="getFrameImg(item.data)" v-else class="previewImg"/> '),w(y,{src:e.getFrameImg(a.data),fit:"contain"},{placeholder:j((()=>[w(b,{animated:"",class:"full-layout"},{template:j((()=>[w(g,{variant:"image",style:{height:"100%"}})])),_:1})])),error:j((()=>[v("div",Ht,[v("img",{src:ge},null,8,Jt)])])),_:2},1032,["src"])],2112)),C(' <img :src="require(\'@/assets/top.png\')" class="top" v-if="item.data.isTop"/> '),a.data.isBackup?(k(),h(G,{key:2,type:"success",effect:"dark",class:"backups"},{default:j((()=>[qt])),_:1})):C("v-if",!0),e.isBackupsing&&e.backupsProjectId===a.data.projectId?(k(),h(G,{key:3,type:"success",effect:"dark",class:"backups"},{default:j((()=>[w(p,{size:"16",class:"is-loading"},{default:j((()=>[w(Q)])),_:1}),Mt])),_:1})):C("v-if",!0),1==a.data.isTop?(k(),h(G,{key:4,type:"danger",effect:"dark",class:"top"},{default:j((()=>[P(I(e.$t("message.top")),1)])),_:1})):C("v-if",!0),w(G,{type:"success",class:"size"},{default:j((()=>[P(I(a.data.width)+"x"+I(a.data.height),1)])),_:2},1024),""!==a.data.tip?(k(),h(G,{key:5,type:"primary",effect:"dark",class:"tip"},{default:j((()=>[P(I(a.data.tip),1)])),_:2},1024)):C("v-if",!0)],40,Rt),v("div",Qt,[v("div",Kt,[v("h4",{class:"oneline project-name",title:a.data.projectName},I(a.data.projectName),9,Wt),w(O,{trigger:"click",size:"small"},{dropdown:j((()=>[w(_,null,{default:j((()=>[w(A,{onClick:t=>e.handleOpenProject(a.data),icon:"Open"},{default:j((()=>[P(I(e.$t("message.open")),1)])),_:2},1032,["onClick"]),w(A,{onClick:t=>e.handleEditProject(a.data),icon:"Edit"},{default:j((()=>[P(I(e.$t("message.edit")),1)])),_:2},1032,["onClick"]),w(A,{onClick:t=>e.handleTopProject(a.data),icon:"Upload"},{default:j((()=>[P(I(a.data.isTop>0?e.$t("message.cancelTop"):e.$t("message.top")),1)])),_:2},1032,["onClick"]),w(A,{onClick:t=>e.handleCopyProject(a.data),icon:"DocumentCopy"},{default:j((()=>[Zt])),_:2},1032,["onClick"]),w(A,{onClick:t=>e.handleExportProject(a.data),disabled:e.isExporting,icon:"FolderOpened"},{default:j((()=>[P(I(e.isExporting?e.$t("message.exportLoading"):e.$t("message.export")),1)])),_:2},1032,["onClick","disabled"]),w(A,{onClick:t=>e.handlePublishProject(a.data),icon:"FolderChecked"},{default:j((()=>[Yt])),_:2},1032,["onClick"]),C(' <el-dropdown-item @click="handlePublishProject(item.data, true)" icon="FolderAdd">投 稿</el-dropdown-item> '),w(A,{onClick:t=>e.handleBackupProject(a.data),icon:"MostlyCloudy",disabled:e.isBackupsing},{default:j((()=>[Xt])),_:2},1032,["onClick","disabled"]),w(A,{onClick:t=>e.handleShareProject(a.data),icon:"Connection"},{default:j((()=>[ea])),_:2},1032,["onClick"]),w(A,{onClick:t=>e.handleDeleteProject(a.data),icon:"Delete"},{default:j((()=>[P(I(e.$t("message.delete")),1)])),_:2},1032,["onClick"])])),_:2},1024)])),default:j((()=>[w(D,{type:"primary",icon:e.ArrowDownBold,size:"small",onClick:t[15]||(t[15]=ce((()=>{}),["stop"])),style:{"margin-left":"5px"}},null,8,["icon"])])),_:2},1024)]),w(V,{"border-style":"dashed","content-position":"left",style:{margin:"5px 0"}},{default:j((()=>[P(I(a.data.updateAt),1)])),_:2},1024),w(L,{content:a.data.desc,effect:"light"},{default:j((()=>[v("div",ta,[C(" {{ item.desc !== '' ? $t(`message.${item.desc}`) : $t(`message.None`) }} "),P(I(a.data.desc),1)])])),_:2},1032,["content"])])],10,zt)))),128))],544),e.searchData.length?C("v-if",!0):(k(),S("div",aa,[w(K,{"current-page":e.currentPage,"onUpdate:current-page":t[17]||(t[17]=t=>e.currentPage=t),"page-size":e.pageSize,background:"",layout:"total, prev, pager, next",total:e.totalCount,onCurrentChange:e.handleCurrentChange},null,8,["current-page","page-size","total","onCurrentChange"])]))],64)),e.NewProjectVisible?(k(),h(Z,{key:3,visible:e.NewProjectVisible,editInfo:e.editProjectInfo,groupId:e.currentGroup,isLocalProject:e.isLocalProject,onSave:e.handleOpenProject,onLocal:e.handleSaveLocalProject,onClose:t[21]||(t[21]=t=>e.NewProjectVisible=!1)},null,8,["visible","editInfo","groupId","isLocalProject","onSave","onLocal"])):C("v-if",!0),e.PublishProjectVisible?(k(),h(Y,{key:4,visible:e.PublishProjectVisible,editInfo:e.editProjectInfo,onClose:t[22]||(t[22]=t=>e.PublishProjectVisible=!1)},null,8,["visible","editInfo"])):C("v-if",!0),e.ShareProjectVisible?(k(),h(X,{key:5,visible:e.ShareProjectVisible,editInfo:e.editProjectInfo,onClose:t[23]||(t[23]=t=>e.ShareProjectVisible=!1)},null,8,["visible","editInfo"])):C("v-if",!0),e.UploadFileVisible?(k(),h(ee,{key:6,visible:e.UploadFileVisible,onReload:e.handleImportProject,onClose:t[24]||(t[24]=t=>e.UploadFileVisible=!1)},null,8,["visible","onReload"])):C("v-if",!0),e.projectGroupVisible?(k(),h(te,{key:7,editData:e.projectGroupData,isSelectGroup:e.isSelectGroup,visible:e.projectGroupVisible,onAdd:e.handleAddProjectToGroup,onClose:t[25]||(t[25]=t=>{e.projectGroupVisible=!1,e.projectGroupData=null,e.isSelectGroup=!1})},null,8,["editData","isSelectGroup","visible","onAdd"])):C("v-if",!0)],8,vt)),[[ae,e.isloading]])])}],["__scopeId","data-v-146d869c"],["__file","D:/project/pixel-grid/src/views/project/index.vue"]]);export{ga as default};
