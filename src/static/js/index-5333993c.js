var e=Object.defineProperty,a=Object.defineProperties,t=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,o=(a,t,r)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[t]=r,s=(e,a)=>{for(var t in a||(a={}))l.call(a,t)&&o(e,t,a[t]);if(r)for(var t of r(a))n.call(a,t)&&o(e,t,a[t]);return e},i=(e,r)=>a(e,t(r));import{c,E as d,M as h,a as u,P as m,R as g,b as y,L as f,d as p,U as v,S as D,V as w,e as x,u as C,p as L,_ as S,f as R}from"./pica-44eded81.js";import{r as b,aJ as M,av as I,B as k,al as F,C as T,aK as P,d as $,y as A,t as E,aL as H,S as O,o as W,ah as N,ai as _,M as B,a7 as j,a as Y,I as z,aM as X,aN as V,aO as U,u as K,aP as J,aQ as G,aR as q,aS as Z,aT as Q,aU as ee,aV as ae,aG as te,aW as re,aX as le,aY as ne,aZ as oe,a_ as se,aA as ie,a$ as ce,b0 as de,g as he,A as ue,b1 as me,b2 as ge,b as ye,aa as fe,e as pe,n as ve,k as De,h as we,j as xe,l as Ce,x as Le,p as Se,f as Re,s as be,V as Me,v as Ie,Y as ke,F as Fe,q as Te,ap as Pe,T as $e,W as Ae}from"./index-7e9c327e.js";import{W as Ee}from"./worker-efe1e0e9.js";import{r as He}from"./xlsx-eef54bab.js";import{_ as Oe}from"./plugin-vue_export-helper-46f75680.js";var We=$({name:"work",components:{MyColorDialog:h,ExportDialog:u,PreviewAnimDialog:m,ReplaceColorDialog:g,PindouDialog:y,LayerMenu:f,LinmoModeDialog:p,UploadImageLayerDialog:v,"sketch-picker":D,VueDragScale:w,MyColorMenu:x},props:{},emits:[],setup(e,a){const{proxy:t}=he(),r=function(){const e=b({canvasWidth:0,canvasHeight:0}),a={handleFilter(t,r,l,n,o,s,i,c){e.canvasHeight=o,e.canvasWidth=n,1===t?a.transformBlackAndWhite(r,l,s):2===t?a.transformReverse(r,l,s):3===t&&a.transformBGRA(r,l,s)},transformBlackAndWhite(e,a,t){let r=M(a.selectMapList)?e.layerNewData:a.selectMapList,l=Object.keys(r);for(let n=0;n<l.length;n++){let t=l[n],o=I(t),s=(o[0]+o[1]+o[2])/3;o[0]=s,o[1]=s,o[2]=s;let i=k(o);if(i!==t&&(r[i]=r[l[n]],delete r[l[n]],!M(a.selectMapList))){if(e.layerNewData[i])for(const[a,l]of r[i])e.layerNewData[t].delete(a),e.layerNewData[i].set(a,l);else{e.layerNewData[i]=new Map;for(const[a,l]of r[i])e.layerNewData[t].delete(a),e.layerNewData[i].set(a,l)}e.layerNewData[t].size||delete e.layerNewData[t]}}t(r,e.layerNewData)},transformReverse(e,a,t){let r=M(a.selectMapList)?e.layerNewData:a.selectMapList,l=Object.keys(r);for(let n=0;n<l.length;n++){let t=l[n],o=I(t);o[0]=255-o[0],o[1]=255-o[1],o[2]=255-o[2];let s=k(o);if(s!==t&&(r[s]=r[l[n]],delete r[l[n]],!M(a.selectMapList))){if(e.layerNewData[s])for(const[a,l]of r[s])e.layerNewData[t].delete(a),e.layerNewData[s].set(a,l);else{e.layerNewData[s]=new Map;for(const[a,l]of r[s])e.layerNewData[t].delete(a),e.layerNewData[s].set(a,l)}e.layerNewData[t].size||delete e.layerNewData[t]}}t(r)},transformBGRA(e,a,t){let r=M(a.selectMapList)?e.layerNewData:a.selectMapList,l=Object.keys(r);for(let n=0;n<l.length;n++){let t=l[n],o=I(t),s=o[0],i=o[2];o[0]=i,o[2]=s;let c=k(o);if(c!==t&&(r[c]=r[l[n]],delete r[l[n]],!M(a.selectMapList))){if(e.layerNewData[c])for(const[a,l]of r[c])e.layerNewData[t].delete(a),e.layerNewData[c].set(a,l);else{e.layerNewData[c]=new Map;for(const[a,l]of r[c])e.layerNewData[t].delete(a),e.layerNewData[c].set(a,l)}e.layerNewData[t].size||delete e.layerNewData[t]}}t(r)},transformIndexColor(e,a,t,r,l){let n=a.length>0?a:e;l.postMessage({type:8,currentIndexColorList:JSON.parse(JSON.stringify(c[r])),variables:JSON.parse(JSON.stringify(n))}),l.onmessage=e=>{t(e.data.variables)}}};return s({},a)}(),l=function(){const e=b({excelPinDouOptions:{1:{numberFontSize:4,rulerFontSize:6,pointFontSize:12,colWidth:1.36,rowHeight:7.9},2:{numberFontSize:6,rulerFontSize:10,pointFontSize:12,colWidth:2.66,rowHeight:14.8}}}),a={convertToExcelPosition({x:e,y:a}){let t="",r=e+1;for(;r>0;){let e=r%26;0===e?(t="Z"+t,r=Math.floor(r/26)-1):(t=String.fromCharCode(64+e)+t,r=Math.floor(r/26))}return t+(a+1)},handleExcelToPixel(e,t,r,l){if(!e)return r("文件不存在");const n=new FileReader;n.onload=function(e){const r=new Uint8Array(e.target.result),n=He(r,{type:"array",cellStyles:!0});let o=[],s=n.SheetNames[0];const i=n.Sheets[s];for(let t=0;t<l.canvasHeight;t++)for(let e=0;e<l.canvasWidth;e++){let r=[];r[0]=e,r[1]=t;let l="",n=a.convertToExcelPosition({x:e,y:t});i[n]&&i[n].s.fgColor?(l="#"+i[n].s.fgColor.rgb+"ff",r[2]=l.toLocaleLowerCase()):(l="#00000000",r[2]=l),o.push(r)}t(o)},n.readAsArrayBuffer(e)},async handlePixelToExcel(e,a,t,r){const l=new d.Workbook;l.creator="by 像素格子",l.lastModifiedBy="by 像素格子";const n={};for(let o=0;o<e.length;o++){n[`frame${o+1}`]=l.addWorksheet(`frame${o+1}`);let t=[],r=[],s=0;for(let l=e[o].layer.length-1;l>=0;l--)if(e[o].layer[l].isRender){for(let n=0;n<a.canvasHeight;n++){0===s&&(r[n]=[],t[n]=[]);for(let i=0;i<a.canvasWidth;i++){let c=e[o].layer[l].layerData[i+n*a.canvasWidth][2];0===s?(r[n][i]=c,t[n][i]=""):r[n][i]&&"#00000000"!==c&&(r[n][i]=c)}}s++}for(let e=0;e<t.length;e++)n[`frame${o+1}`].addRow(t[e]);for(let e=0;e<t[0].length;e++)n[`frame${o+1}`]._columns[e].width=3;n[`frame${o+1}`].eachRow(((e,t)=>{e.height=18,e.eachCell(((e,l)=>{if(a.isShowGrid){let t="FF",r=a.gridColor.slice(1).toUpperCase();e.border={top:{style:"thin",color:{argb:`${t}${r}`}},left:{style:"thin",color:{argb:`${t}${r}`}},bottom:{style:"thin",color:{argb:`${t}${r}`}},right:{style:"thin",color:{argb:`${t}${r}`}}}}let n=r[t-1][l-1];if("#00000000"!==n){let a=n.slice(7).toUpperCase(),t=n.slice(1,7).toUpperCase();e.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${a}${t}`}}}else if(a.isShowGrid){let t=a.gridBackgroundColor,r=t.slice(7).toUpperCase(),l=t.slice(1,7).toUpperCase();e.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${r}${l}`}}}}))}))}l.xlsx.writeBuffer().then((e=>{let r=new Blob([e],{type:"application/octet-stream"});F.saveAs(r,a.filename+".xlsx"),t("导出成功")})).catch((e=>{r("导出失败")}))},async handlePindouToExcel(t,r,l,n,o){let{isShowGrid:s,isShowRulers:i,isShowCirclePoint:c,isShowRectPoint:h,rulersBackgroundColor:u,pointColor:m,rulersColor:g,gridColor:y,canvasWidth:f,canvasHeight:p,filename:v,excelSize:D,isShowTongji:w,isShowBrand:x,brandName:C,background:L}=l,{variables:S}=t;u=k(T(u)),L=k(T(L));const R=new d.Workbook;R.creator="by 像素格子",R.lastModifiedBy="by 像素格子";const b=R.addWorksheet("拼豆");let M=[],I=[],$=0;for(let e=S.length-1;e>=0;e--)if(S[e].isRender){for(let a=0;a<p;a++){0===$&&(I[a]=[],M[a]=[]);for(let t=0;t<f;t++){let r=S[e].layerData[t+a*f][2],l=S[e].layerData[t+a*f][3]||"";0===$?(I[a][t]=r,M[a][t]=""!==l?l:c?"•":h?"▪":""):(I[a][t]&&"#00000000"!==r&&(I[a][t]=r),M[a][t]&&""!==l&&(M[a][t]=l))}}$++}if(i){let e=[];for(let a=0;a<f+2;a++){let t="";t=0===a||a===f+1?"":a+"",e.push(t)}b.addRow(e)}for(let e=0;e<M.length;e++){let a=String(e+1);b.addRow([a,...M[e],a])}if(i){let e=[];for(let a=0;a<f+2;a++){let t="";t=0===a||a===f+1?"":a+"",e.push(t)}b.addRow(e)}for(let a=0;a<M[0].length+2;a++)b._columns[a].width=e.excelPinDouOptions[D].colWidth;if(b.eachRow(((a,t)=>{a.height=e.excelPinDouOptions[D].rowHeight,!i||1!==t&&t!==p+2?a.eachCell(((a,r)=>{if(a.alignment={vertical:"middle",horizontal:"center"},s){let e="FF"+y.slice(1,7).toUpperCase();a.border={top:{style:"thin",color:{argb:`${e}`}},left:{style:"thin",color:{argb:`${e}`}},bottom:{style:"thin",color:{argb:`${e}`}},right:{style:"thin",color:{argb:`${e}`}}}}if(1===r||r===f+2){let t=u;if("#00000000"!==t){let e=t.slice(7).toUpperCase(),r=t.slice(1,7).toUpperCase();a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${e}${r}`}}}let r="FF"+g.slice(1,7).toUpperCase();a.font={name:"Microsoft YaHei UI",color:{argb:r},size:e.excelPinDouOptions[D].rulerFontSize}}else{let l=L.slice(7).toUpperCase(),n=L.slice(1,7).toUpperCase();a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${l}${n}`}};let o=I[t-2][r-2],s=M[t-2][r-2];if("#00000000"!==o){let t=o.slice(7).toUpperCase(),r=o.slice(1,7).toUpperCase();if(a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${t}${r}`}},s){let t=e.excelPinDouOptions[D].numberFontSize,r="#FFF"===P(o)?"FFFFFFFF":"FF000000";s.length>=4&&(t-=1),a.font={name:"Microsoft YaHei UI",color:{argb:r},size:t}}}else{let t="FF"+m.slice(1,7).toUpperCase();a.font={name:"Microsoft YaHei UI",color:{argb:t},size:e.excelPinDouOptions[D].pointFontSize}}}})):a.eachCell(((a,t)=>{if(s){let e="FF"+y.slice(1,7).toUpperCase();a.border={top:{style:"thin",color:{argb:`${e}`}},left:{style:"thin",color:{argb:`${e}`}},bottom:{style:"thin",color:{argb:`${e}`}},right:{style:"thin",color:{argb:`${e}`}}}}a.alignment={vertical:"middle",horizontal:"center"};let r=u;if("#00000000"!==r){let e=r.slice(7).toUpperCase(),t=r.slice(1,7).toUpperCase();a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${e}${t}`}}}let l="FF"+g.slice(1,7).toUpperCase();a.font={name:"Microsoft YaHei UI",color:{argb:l},size:e.excelPinDouOptions[D].rulerFontSize}}))})),x){b.addRow([C]),b.lastRow.height=12;let e=a.convertToExcelPosition({x:b.columnCount-1,y:b.rowCount-1});b.mergeCells(`A${b.rowCount}:${e}`);const t=b.getCell(`A${p+3}`);t.font={name:"Arial",size:8,bold:!0,color:{argb:"FF101010"}},t.alignment={vertical:"middle",horizontal:"center"},t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFF00"}}}if(w){let e=Math.floor((f+2)/2),t=Math.ceil(r.size/e),l=Array.from(r),n=[],o=[],s=[],i=0;for(let a=0;a<t;a++){n[a]=[],o[a]=[],s[a]=[];for(let t=0;t<2*e&&!(i>l.length-1);t+=2)n[a][t]=l[i][1][0],s[a][t]=l[i][1][1]+"",o[a][t]=l[i][0],n[a][t+1]="",s[a][t+1]="",o[a][t+1]="",i++;b.addRow([...o[a]]),b.addRow([...s[a]])}const c=b.rowCount;for(let r=0;r<c-(p+3);r++)for(let e=0;e<f+2;e+=2){let t=p+3+r+1,l=a.convertToExcelPosition({x:e,y:t-1}),n=a.convertToExcelPosition({x:e+1,y:t-1});if(e+1>f+2-1)break;b.mergeCells(`${l}:${n}`)}for(let a=0;a<c-(p+3);a++){let e=p+3+(a+1),t=b.getRow(e);t.height=13,t.eachCell(((e,t)=>{if(e.alignment={vertical:"middle",horizontal:"center"},a%2==0&&t%2!=0){if(t>n[a/2].length)return;let r=t-1,l=n[a/2][r],s=o[a/2][r],i=l.slice(1,7).toUpperCase();if(e.fill={type:"pattern",pattern:"solid",fgColor:{argb:`FF${i}`}},s){let a=6,t="#FFF"===P(l)?"FFFFFFFF":"FF000000";s.length>=4&&(a-=1),e.font={name:"Microsoft YaHei UI",color:{argb:t},size:a}}}let r="ffffff";const l=e.fill;l&&l.fgColor&&(r=l.fgColor.argb.slice(2));let s="#FFF"===P(r)?"FFFFFFFF":"FF000000";e.font={name:"Microsoft YaHei UI",color:{argb:s},size:6}}))}}b.addRow(["By 像素格子"]),b.lastRow.height=15;let A=a.convertToExcelPosition({x:b.columnCount-1,y:b.rowCount});b.mergeCells(`A${b.rowCount}:${A}`);const E=b.getCell(`A${b.rowCount}`);E.font={name:"Arial",size:10,bold:!0,color:{argb:"FFFFFFFF"}},E.alignment={vertical:"middle",horizontal:"center"},E.fill={type:"pattern",pattern:"solid",fgColor:{argb:"0052D9"}},R.xlsx.writeBuffer().then((e=>{let a=new Blob([e],{type:"application/octet-stream"});F.saveAs(a,v+".xlsx"),n("导出成功")})).catch((e=>{o("导出失败")}))}};return s({},a)}(),n=C(),o=A(),h=(L||S)();let u=b(i(s({},E(n.data)),{projectData:H(),emptyColor:"#00000000",brushColorVisible:!1,shapeFillColorVisible:!1,baseCanvas:null,bgCanvas:null,canvas:null,realCanvas:null,gridCanvas:null,moveCanvas:null,moveBoxDom:null,ctx0:null,ctx1:null,ctx2:null,ctx3:null,ctx4:null,ctx5:null,isDrawing:!1,isErasering:!1,isDrawShape:!1,isMoving:!1,isSelecting:!1,isSelectDraging:!1,isCopy:!1,isScale:!1,shapeFillColor:"#000000ff",brushColor:"#000000ff",brushSize:1,eraserSize:1,canvasWidth:32,canvasHeight:32,scale:1,isCheckedRatio:!0,isShowReferenceLine:!1,isShowRuler:!1,widthHeightRatio:1,drawAreaList:[],currentTool:0,drawRecord:[],drawShapeList:[],gridInfo:"[]",currentDrawShape:"rect",currentDrawTransform:"hReverse",historyRecord:[],historyMaxLength:10,currentHistoryIndex:0,historyTimer:null,lastX:0,lastY:0,currentFrameIndex:0,currentLayerIndex:0,currentFrameId:0,currentLayerId:0,currentFrameLayerVisible:!0,currentEditLayer:{index:-1,name:""},FrameTimer:null,maxFrame:15,maxLayer:30,exportVisible:!1,exportLoaidng:!1,importLayerVisible:!1,loading:!0,isSpace:!1,isShift:!1,isDragging:!1,dragData:{x:0,y:0},canvasBeginPos:{x:0,y:0,centerX:0,centerY:0},moveData:{x:0,y:0,col:0,row:0,diffCol:0,diffRow:0,centerX:0,centerY:0,transformX:0,transformY:0,list:[],mapList:{},bitmap:"",isMoving:!1},selectData:{selectLayerId:0,x:-1,y:-1,endX:-1,endY:-1,isCancelSelect:!0,originList:[],selectList:[],selectOriginList:[],copyList:[],selectMapList:{},copySelectMapList:null},selectType:"select",previewLoading:!1,selectActiveColor:"#3100FC",isExpandColorSelector:!0,colorStatList:{},worker:null,isExportProject:!1,AnimationFrameId_1:null,zIndex:{max:13,min:8},isSaveProject:!0,pinDouMode:!1,pinDouDrawMode:!1,pinDouData:null,tolerance:0,curvature:4,curveType:{isPress:!1,pressKey:"0"},curveEndPos:[],isHorizontal:!1,isVertical:!1,isCenter:!1,drawList:[],removeDrawList:[],LayerMenu:{visible:!1,top:0,left:0,contextData:null},selectLayerList:[],pindouHighlight:null,isHidePindouMode:!1,pindouBrand:"mard-v2",isScaling:!1,scaleWhitePointPos:[],scaleAreaData:null,scaleRatio:0,emptyLayerData:[],exportStyleOptions:{isShowGrid:!1,gridBackgroundColor:"#ffffffff",gridColor:"#808080ff",gridSize:50},layerAlpha:100,isHideLinmoMode:!1,linmoMode:!1,linmoPhoto:null,linmoPhotoStyle:{width:"200px",height:"200px",transform:"translate3d(0px, 0px, 10px) rotate(0deg) scale(1, 1)",opacity:1,zIndex:0,display:"none",transformOrigin:"center center"},linmoPhotoDom:null,dragLinmoPhoto:{enable:!1,startX:0,startY:0,translateX:0,translateY:0},scaleTimer:null,canvasStyle:{transform:"translate3d(0, 0, 10px) scale(1)",transformOrigin:"center center"},isShowGridLine:!1,pindouScaleValue:0,drawAreaGridColor:{light:["rgba(100, 100, 100, 0.5)","rgba(0, 0, 0, 0.5)"],dark:["rgba(150, 150, 150, 0.5)","rgba(100, 100, 100, 0.5)"]},canvasRealTop:0,canvasRealLeft:0,isLockCanvas:!1,isHighPreview:!1,linmoFitCanvasTimer:null,mouseDrawData:{startX:0,startY:0},drawShapeData:{list:[],maxX:0,maxY:0,minX:-1,minY:-1},historyLayerIndexRecord:[0],historyLayerNameIndex:[0],historyFrameIndexRecord:[0],drawAreaGridCanvas:null,layerGridImage:null,pindouHighlightOptions:null}));const m={requireIcon:Y((()=>e=>o.themeValue?new URL(`../../assets/light/${e}.png`,window.location.href).href:new URL(`../../assets/dark/${e}.png`,window.location.href).href)),requireShapeImg:Y((()=>o.themeValue?new URL(`../../assets/light/${u.currentDrawShape}.png`,window.location.href).href:new URL(`../../assets/dark/${u.currentDrawShape}.png`,window.location.href).href)),requireTransformImg:Y((()=>o.themeValue?new URL(`../../assets/light/${u.currentDrawTransform}.png`,window.location.href).href:new URL(`../../assets/dark/${u.currentDrawTransform}.png`,window.location.href).href)),requireSelectImg:Y((()=>o.themeValue?new URL(`../../assets/light/${u.selectType}.png`,window.location.href).href:new URL(`../../assets/dark/${u.selectType}.png`,window.location.href).href)),requireVisibleImg:Y((()=>e=>e?o.themeValue?new URL("../../assets/light/visible.png",window.location.href).href:new URL("../../assets/dark/visible.png",window.location.href).href:o.themeValue?new URL("../../assets/light/hidden.png",window.location.href).href:new URL("../../assets/dark/hidden.png",window.location.href).href)),checkTheme:Y((()=>o.themeValue)),checkzIndex:Y((()=>{let e={zIndex:0};return o.isFullWork?e.zIndex=u.zIndex.max:e.zIndex=u.zIndex.min,e}))};let g=i(s({},n),{handleChangeBrushColor(e){let a=e;a.length<=6&&"#"!==a.slice(0,1)&&(a=`#${a}ff`.toLowerCase()),u.brushColor=a},handleSaveProject(){u.isScaling&&g.handleCancelScale();g.handleSaveMoveData(!0,(()=>{u.loading=!0,u.isSaveProject=!0,u.projectData.updateAt=ue(),u.projectData.height=u.canvasHeight,u.projectData.width=u.canvasWidth,u.projectData.tip="最近编辑",u.projectData.data=g.compressDrawRecordData(),""===u.drawRecord[0].currentFrameImg?u.projectData.frameImg="":u.projectData.frameImg="@",o.saveProject(u.projectData,!0).then((e=>{e&&(t.$message.success(t.$t("message.saveSucceeded")),u.loading=!1)})).catch((e=>{t.$message.error(t.$t("message.saveFailed")),u.loading=!1}))}))},handleBack(){if(u.isSaveProject)return o.saveProjectId("0"),u.pinDouMode=!1,t.$router.replace("/project");z.confirm("项目未保存，是否离开该页面？","提 示",{confirmButtonText:"确 认",cancelButtonText:"取 消",type:"warning"}).then((()=>{o.saveProjectId("0"),u.pinDouMode=!1,t.$router.replace("/project")})).catch((()=>{}))},handleScreenFull(){o.isFullWork=!o.isFullWork,setTimeout((()=>{g.handleResizeWindowEvent(""),o.isFullWork||g.handleResetCanvas()}),200)},handleSaveMoveData(e=!1,a){if(u.isMoving&&7===u.currentTool){let t=u.moveCanvas.offsetLeft/u.scale,r=u.moveCanvas.offsetTop/u.scale;u.worker.postMessage({type:13,moveData:JSON.parse(JSON.stringify(u.moveData.list)),layerData:JSON.parse(JSON.stringify(u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData)),options:{canvasWidth:u.canvasWidth,canvasHeight:u.canvasHeight,scale:u.scale,difLeft:t,difTop:r}}),u.worker.onmessage=t=>{let r=g.getCurrentLayerDataByLayerId();r.layerData=t.data.layerData,r.layerNewData=t.data.layerNewData,u.moveData.list=[],u.ctx5.clearRect(0,0,u.moveCanvas.width,u.moveCanvas.height),u.moveCanvas.style.left="0px",u.moveCanvas.style.top="0px",u.isMoving=!1,g.reDraw(),a(),setTimeout((()=>{e&&g.handleMoveData()}),1e3)}}else a()},handleMoveData(){if(!u.isMoving&&(u.moveBoxDom.style.width=u.moveCanvas.width+"px",u.moveBoxDom.style.height=u.moveCanvas.height+"px",u.currentLayerId=g.getCurrentLayerId(),"undefined"!=typeof OffscreenCanvas)){u.loading=!0;let e=X(u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex]),a=i(s({},e),{layerNewData:V(e.layerNewData)});u.worker.postMessage({type:7,currentLayerData:a,options:{canvasWidth:u.canvasWidth,canvasHeight:u.canvasHeight,scale:u.scale}}),u.worker.onmessage=e=>{u.moveData.list=JSON.parse(JSON.stringify(U(a.layerData.map((e=>e[2]!==u.emptyColor?e:null))))),u.loading=!1,u.isMoving=!0,u.moveData.list.length&&(u.ctx5.drawImage(e.data.imageBitmap,0,0),u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData=JSON.parse(JSON.stringify(u.emptyLayerData)),u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData={},g.reDraw(!1))}}},handleChangeTool(e){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");u.isScaling&&g.handleFinishScale();const a=()=>{if(6===e)return u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData=JSON.parse(JSON.stringify(u.emptyLayerData)),u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData={},g.handleCancelSelect(),void g.reDraw();if(7===e){if(!M(u.selectData.selectMapList))return t.$message.warning("请先取消选中区域");if(!u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].isRender)return t.$message.warning("图层为空");if("undefined"==typeof OffscreenCanvas)return t.$message.warning("当前浏览器不支持该功能，请切换浏览器");g.handleMoveData()}u.currentTool=e};u.isMoving&&7===u.currentTool&&u.currentTool!==e?g.handleSaveMoveData(!1,a):a()},handleLinmoMode:()=>u.pinDouMode?t.$message.warning("请先退出拼豆预览模式"):u.isHideLinmoMode?(u.isHideLinmoMode=!1,void t.$refs.LinmoModeDialog.handleShow()):(u.linmoMode=!0,void t.$refs.LinmoModeDialog.handleOpen()),handlePindouMode(e){if(!M(u.selectData.selectMapList))return t.$message.warning("请先取消选中区域");if(u.isScaling&&g.handleCancelScale(),!u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].isRender)return t.$message.warning("请将图层设置显示状态");if("preview"!==e||u.pinDouMode){if("draw"===e&&!u.pinDouDrawMode){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(u.isHidePindouMode)return void g.handleShowPindou();u.pinDouDrawMode=!0,t.$refs.PindouDialog.handleOpen(e)}}else{if(u.pinDouDrawMode)return t.$message.warning("请先退出拼豆绘图模式");if(u.linmoMode)return t.$message.warning("请先退出临摹模式");u.loading=!0,g.handleResetCanvas(),u.currentTool=5,g.handlePindouEvent()}},handleShowPindou(){u.isHidePindouMode=!1,t.$refs.PindouDialog.handleShow()},handlePindouEvent(e=u.pindouBrand){u.loading=!0,u.worker.postMessage({type:6,currentPindouBrandColorList:JSON.parse(JSON.stringify(o.pindouMaps[e].data||o.pindouMaps[e])),variables:JSON.parse(JSON.stringify(u.drawRecord[u.currentFrameIndex].layer))}),u.worker.onmessage=a=>{u.pinDouMode=!0,g.computeScale(),u.pinDouData=a.data,g.drawPixelArea(!0),g.handleDrawPindou(u.ctx1),u.pindouBrand=e,t.$refs.PindouDialog.handleOpen(a.data),g.handleCancelKeyboardEvent()}},handleTransformColorToPindou(e){let a=u.drawRecord[u.currentFrameIndex].layer,r=u.pinDouData.variables;for(let t=r.length-1;t>=0;t--)for(let e=0;e<r[t].layerData.length;e++)a[t].layerData[e][2]=r[t].layerData[e][2];g.handleLayerDataToLayerMapData((()=>{g.handleFrameImg(u.ctx1),e(),t.$message.success("保存成功")}))},handleChangeCanvasSize(e,a){e<t.$config.canvasMinSize||e>t.$config.canvasMaxSize?(u[a]=e<t.$config.canvasMinSize?t.$config.canvasMinSize:e>t.$config.canvasMaxSize?t.$config.canvasMaxSize:u[a],t.$message.warning(`画布像素必须${t.$config.canvasMinSize}-${t.$config.canvasMaxSize}像素区间`)):u[a]=Number(e),u.isCheckedRatio&&("canvasWidth"===a?u.canvasHeight=parseInt(u[a]/u.widthHeightRatio):u.canvasWidth=parseInt(u[a]/u.widthHeightRatio)),g.computeScale(),u.canvasBeginPos.centerX=u.canvasBeginPos.x+u.scale*u.canvasWidth/2,u.canvasBeginPos.centerY=u.canvasBeginPos.y+u.scale*u.canvasHeight/2,g.drawPixelArea(!0),g.handleInitEmptyLayer(),g.initCanvasRecord("scale")},handleChangeRatio(e){e&&(u.widthHeightRatio=u.canvasWidth/u.canvasHeight)},initCanvasRecord(e){if("init"===e)u.drawRecord.push({frameId:K.v1(),currentFrameImg:null,layer:[{layerId:K.v4(),layerName:"图层1",alpha:100,isLock:!1,currentLayerImg:u.layerGridImage,isRender:!0,layerData:JSON.parse(JSON.stringify(u.emptyLayerData)),layerNewData:{}}]}),g.handleAddHistory();else if("scale"===e){u.loading=!0;let e=JSON.parse(JSON.stringify(u.emptyLayerData));u.worker.postMessage({originData:e,type:1,variables:JSON.parse(JSON.stringify(u.drawRecord))}),u.worker.onmessage=e=>{u.drawRecord=e.data,u.loading=!1,g.reDraw()}}},drawPixelArea(e=!1){if(!e&&u.drawAreaGridCanvas&&u.ctx2.drawImage(u.drawAreaGridCanvas,0,0,u.bgCanvas.width,u.bgCanvas.height),e){let e=o.themeValue?u.drawAreaGridColor.dark:u.drawAreaGridColor.light;u.drawAreaList=[],u.ctx2.clearRect(0,0,u.bgCanvas.width,u.bgCanvas.height),u.ctx2.globalAlpha=.25;for(let a=0;a<u.canvasHeight;a++)for(let t=0;t<u.canvasWidth;t++){u.ctx2.fillStyle=(a+t)%2==0?e[1]:e[0];let r=t*u.scale,l=a*u.scale;u.ctx2.fillRect(r,l,u.scale,u.scale),u.drawAreaList.push([r,l])}u.drawAreaGridCanvas=u.bgCanvas}g.handleDrawReferenceLine(),g.handleDrawGridLine()},handleDrawGridLine(){if(u.ctx4.clearRect(0,0,u.gridCanvas.width,u.gridCanvas.height),u.isShowGridLine){u.ctx4.strokeStyle=o.themeValue?"white":"black",u.ctx4.lineWidth=1,u.ctx4.beginPath();for(let e=0;e<=u.canvasHeight;e++)u.ctx4.moveTo(0,e*u.scale),u.ctx4.lineTo(u.canvasWidth*u.scale,e*u.scale);for(let e=0;e<=u.canvasWidth;e++)u.ctx4.moveTo(e*u.scale,0),u.ctx4.lineTo(e*u.scale,u.canvasHeight*u.scale);u.ctx4.stroke()}},handleDrawReferenceLine(e="vh"){if(u.ctx0.clearRect(0,0,u.baseCanvas.width,u.baseCanvas.height),u.isShowReferenceLine){let a=u.canvas.offsetLeft,t=u.canvas.offsetTop;u.ctx0.globalAlpha=.5,u.ctx0.lineWidth=2,u.ctx0.strokeStyle=o.themeValue?"white":"black",u.ctx0.setLineDash([5,3]),"vh"!==e&&"v"!==e||(u.ctx0.beginPath(),u.ctx0.moveTo(a+u.canvasWidth*u.scale/2,0),u.ctx0.lineTo(a+u.canvasWidth*u.scale/2,u.baseCanvas.height),u.ctx0.stroke()),"vh"!==e&&"h"!==e||(u.ctx0.beginPath(),u.ctx0.moveTo(0,t+u.canvasHeight*u.scale/2),u.ctx0.lineTo(u.baseCanvas.width,t+u.canvasHeight*u.scale/2),u.ctx0.stroke())}g.handleDrawRulerLine()},handleDrawRulerLine(){if(u.isShowRuler){let e=J(u.canvas),a=16,t=15;if(!u.pinDouMode&&e<.5)return;u.pinDouMode&&(a=32,t=30);let r=e*t,l=e*u.scale,n=Math.floor(e*a)-1;u.canvasRealLeft=u.baseCanvas.getBoundingClientRect().left,u.canvasRealTop=u.baseCanvas.getBoundingClientRect().top,u.ctx0.setLineDash([]);let s=u.canvas.getBoundingClientRect().left-u.canvasRealLeft,i=u.canvas.getBoundingClientRect().top-u.canvasRealTop,c=u.canvas.getBoundingClientRect().width,d=u.canvas.getBoundingClientRect().height;u.ctx0.globalAlpha=1,u.ctx0.lineWidth=1,u.ctx0.strokeStyle=o.themeValue?"white":"black",u.ctx0.fillStyle=o.themeValue?"white":"black",u.ctx0.font=`${n}px PixelFont`,u.ctx0.textAlign="center",u.ctx0.beginPath(),u.ctx0.moveTo(s,i-5),u.ctx0.lineTo(s+c,i-5),u.ctx0.moveTo(s,i+d+5),u.ctx0.lineTo(s+c,i+d+5),u.ctx0.moveTo(s-5,i),u.ctx0.lineTo(s-5,i+d),u.ctx0.moveTo(s+c+5,i),u.ctx0.lineTo(s+c+5,i+d);for(let o=0;o<=u.canvasWidth&&(u.ctx0.moveTo(s+o*u.scale*e,i-5),u.ctx0.lineTo(s+o*u.scale*e,i-(5+r)),u.ctx0.moveTo(s+o*u.scale*e,i+d+5),u.ctx0.lineTo(s+o*u.scale*e,i+d+(5+r)),o!==u.canvasWidth);o++){if(G(o+1))continue;let e=s+l*o+l/2,a=i-5-r,t=e,n=i+d+5+r+5;u.ctx0.fillText((o+1).toString(),e,a),u.ctx0.fillText((u.canvasWidth-o).toString(),t,n+4)}for(let o=0;o<=u.canvasHeight&&(u.ctx0.moveTo(s-5,i+o*u.scale*e),u.ctx0.lineTo(s-(5+r),i+o*u.scale*e),u.ctx0.moveTo(s+c+5,i+o*u.scale*e),u.ctx0.lineTo(s+c+(5+r),i+o*u.scale*e),o!==u.canvasHeight);o++){if(G(o+1))continue;let e=s-5-r-5,a=i+o*l+l/2+5,t=s+c+(5+r)+8,n=a;u.ctx0.fillText((o+1).toString(),e,a),u.ctx0.fillText((u.canvasHeight-o).toString(),t,n)}u.ctx0.stroke()}},drawLoop(){g.drawPixelArea(),u.AnimationFrameId_1=requestAnimationFrame(g.drawLoop)},drawShape(e){u.currentDrawShape=e},getCurrentLayerData:(e=u.currentFrameIndex,a=u.currentLayerIndex)=>u.drawRecord[e].layer[a].layerData,getCurrentLayerDataByLayerId(e=u.currentFrameIndex,a=u.currentLayerId){let t=u.drawRecord[e].layer.findIndex((e=>e.layerId===a));return u.drawRecord[e].layer[t]},getCurrentLayerId:(e=u.currentFrameIndex,a=u.currentLayerIndex)=>u.drawRecord[e].layer[a].layerId,getCurrentFrameId:(e=u.currentFrameIndex)=>u.drawRecord[e].frameId,getCurrentLayerIsLock:(e=u.currentFrameIndex,a=u.currentLayerIndex)=>u.drawRecord[e].layer[a].isLock,drawScaleFrame(){if(!u.isScaling)return;let e=0,a=0,r=[];r=M(u.selectData.selectMapList)?JSON.parse(JSON.stringify(g.getCurrentLayerData())):q(JSON.parse(JSON.stringify(u.selectData.selectList)));let l=1/0,n=1/0,o=-1/0,s=-1/0;for(let t=0;t<r.length;t++){if(r[t][2]===u.emptyColor)continue;const e=r[t][0],a=r[t][1];e<l&&(l=e),e>o&&(o=e),a<n&&(n=a),a>s&&(s=a)}if(l===1/0&&(l=0),n===1/0&&(n=0),o===-1/0&&(o=0),s===-1/0&&(s=0),l+n+o+s===0)return u.isScaling=!1,t.$message.warning("图层为空");let i=J(u.canvas),c=o*u.scale*i+u.scale*i,d=l*u.scale*i,h=s*u.scale*i+u.scale*i,m=n*u.scale*i;e=c-d,a=h-m,u.scaleAreaData={},u.scaleAreaData={minX:l,maxX:o,minY:n,maxY:s,realmaxX:c,realminX:d,realmaxY:h,realminY:m,originArr:[],colorMaxtrix:[],coordMaxtrix:[],isRight:!1,isLeft:!1,isTop:!1,isBottom:!1},g.handleDrawScaleFrame(d-5,m-5,c+5,h+5);for(let t=0;t<r.length;t++)r[t][0]<=u.scaleAreaData.maxX&&r[t][0]>=u.scaleAreaData.minX&&r[t][1]<=u.scaleAreaData.maxY&&r[t][1]>=u.scaleAreaData.minY&&u.scaleAreaData.originArr.push(r[t]);let y=u.scaleAreaData.maxX-u.scaleAreaData.minX+1,f=u.scaleAreaData.maxY-u.scaleAreaData.minY+1;for(let t=0;t<f;t++){let e=[],a=[];for(let r=0;r<y;r++){let l=r+u.scaleAreaData.minX,n=t+u.scaleAreaData.minY,o=g.getCurrentLayerColorByCoords(l,n)||u.emptyColor;e.push([l,n]),a.push([o])}u.scaleAreaData.colorMaxtrix.push(a),u.scaleAreaData.coordMaxtrix.push(e)}},handleDrawScaleFrame(e,a,t,r,l=!0){l&&g.handleDrawReferenceLine(),u.canvasRealLeft=u.baseCanvas.getBoundingClientRect().left,u.canvasRealTop=u.baseCanvas.getBoundingClientRect().top;let n=u.canvas.getBoundingClientRect().left,o=u.canvas.getBoundingClientRect().top;e+=n-u.canvasRealLeft,t+=n-u.canvasRealLeft,a+=o-u.canvasRealTop,r+=o-u.canvasRealTop,u.ctx0.strokeStyle="blue",u.ctx0.fillStyle="white",u.ctx0.globalAlpha=.9,u.ctx0.lineWidth=2,u.ctx0.setLineDash([]),u.ctx0.beginPath(),u.ctx0.moveTo(e,a),u.ctx0.lineTo(t,a),u.ctx0.stroke(),u.ctx0.beginPath(),u.ctx0.moveTo(e,a),u.ctx0.lineTo(e,r),u.ctx0.stroke(),u.ctx0.beginPath(),u.ctx0.moveTo(e,r),u.ctx0.lineTo(t,r),u.ctx0.stroke(),u.ctx0.beginPath(),u.ctx0.moveTo(t,r),u.ctx0.lineTo(t,a),u.ctx0.stroke(),u.scaleWhitePointPos=[[t,r]],u.ctx0.beginPath(),u.ctx0.rect(t-4,r-4,8,8),u.ctx0.fill(),u.ctx0.stroke()},handleFinishScale(){let e=Z(u.scaleAreaData,u.scaleRatio),a=Q(u.scaleAreaData,u.scaleRatio);if(M(u.selectData.selectMapList))u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData=JSON.parse(JSON.stringify(u.emptyLayerData));else{for(let e=0;e<u.selectData.selectList.length;e++){let a=u.selectData.selectList[e][0]+u.selectData.selectList[e][1]*u.canvasWidth;u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData[a][2]=u.emptyColor}u.selectData.selectList=[]}for(let t=0;t<e.length;t++)for(let r=0;r<e[t].length;r++)0!==u.selectData.selectLayerId&&a[t][r][0]!==u.emptyColor&&u.selectData.selectList.push([e[t][r][0],e[t][r][1],a[t][r][0]]),g.addDrawRecord([e[t][r][0],e[t][r][1],a[t][r][0]],!1);u.isScaling=!1,u.scaleAreaData=null,u.scaleWhitePointPos=[],u.scaleRatio=0,g.handleDrawReferenceLine(),g.reDraw(),M(u.selectData.selectMapList)?g.handleChangeTool(0):g.handleChangeTool(8)},handleCancelScale(){u.isScaling=!1,u.scaleAreaData=null,u.scaleWhitePointPos=[],u.scaleRatio=0,g.handleDrawReferenceLine(),g.reDraw(!1),M(u.selectData.selectMapList)?g.handleChangeTool(0):g.handleChangeTool(8)},drawTransform(e){if(u.isScaling&&"scale"!==e&&g.handleCancelScale(),u.isScaling&&"scale"===e)return;if(u.currentDrawTransform=e,"scale"===e)return g.handleChangeTool(9),u.isScaling=!0,void g.drawScaleFrame();let a=[],t=u.canvasBeginPos.centerX,r=u.canvasBeginPos.centerY,l=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex],n=JSON.parse(JSON.stringify(l.layerData)),o=V(l.layerNewData);if(M(u.selectData.selectMapList)){let e=Object.keys(o);for(let t=0;t<e.length;t++){let r=o[e[t]];for(const[l,n]of r){if(n[0]>=u.canvasWidth||n[1]>=u.canvasHeight||n[0]<0||n[1]<0)return;let r=n[0]*u.scale,l=n[1]*u.scale;a.push([r,l,e[t]])}}}else{let e=Object.keys(u.selectData.selectMapList);for(let t=0;t<e.length;t++){let r=u.selectData.selectMapList[e[t]];for(const[l,n]of r){if(n[0]>=u.canvasWidth||n[1]>=u.canvasHeight||n[0]<0||n[1]<0)return;let r=n[0]*u.scale,l=n[1]*u.scale;a.push([r,l,e[t]])}}}if("hReverse"===e)for(let c=0;c<a.length;c++){let e=a[c][0],t=a[c][1];a[c][0],u.scale;const r=Math.floor(t/u.scale),s=Math.floor(e/u.scale);let i=u.canvasWidth-1-s,d=r;n[s+r*u.canvasWidth][2]=u.emptyColor,o[a[c][2]].has(`${i}/${d}`)||(o[a[c][2]].delete(`${s}/${r}`),o[a[c][2]].set(`${i}/${d}`,[i,d])),M(u.selectData.selectMapList)||u.selectData.selectLayerId!==l.layerId||u.selectData.selectMapList[a[c][2]].has(`${i}/${d}`)||(u.selectData.selectMapList[a[c][2]].delete(`${s}/${r}`),u.selectData.selectMapList[a[c][2]].set(`${i}/${d}`,[i,d]))}else if("vReverse"===e)for(let c=0;c<a.length;c++){let e=a[c][0],t=a[c][1];a[c][1],u.scale;const r=Math.floor(t/u.scale),s=Math.floor(e/u.scale);let i=s,d=u.canvasHeight-1-r;n[s+r*u.canvasWidth][2]=u.emptyColor,o[a[c][2]].has(`${i}/${d}`)||(o[a[c][2]].delete(`${s}/${r}`),o[a[c][2]].set(`${i}/${d}`,[i,d])),M(u.selectData.selectMapList)||u.selectData.selectLayerId!==l.layerId||u.selectData.selectMapList[a[c][2]].has(`${i}/${d}`)||(u.selectData.selectMapList[a[c][2]].delete(`${s}/${r}`),u.selectData.selectMapList[a[c][2]].set(`${i}/${d}`,[i,d]))}else if("ssz"===e)for(let c=0;c<a.length;c++){let e=a[c][0]-t,s=-(a[c][1]-r)+t-u.scale,i=e+r;const d=Math.floor(a[c][1]/u.scale),h=Math.floor(a[c][0]/u.scale),m=Math.floor(i/u.scale),g=Math.floor(s/u.scale);n[h+d*u.canvasWidth][2]=u.emptyColor,o[a[c][2]].set(`${h}/${d}`,[g,m]),M(u.selectData.selectMapList)||u.selectData.selectLayerId!==l.layerId||u.selectData.selectMapList[a[c][2]].has(`${g}/${m}`)||(u.selectData.selectMapList[a[c][2]].delete(`${h}/${d}`),u.selectData.selectMapList[a[c][2]].set(`${g}/${m}`,[g,m]))}else if("nsz"===e)for(let c=0;c<a.length;c++){let e=a[c][0]-t,s=a[c][1]-r+t,i=-e+r-u.scale;const d=Math.floor(a[c][1]/u.scale),h=Math.floor(a[c][0]/u.scale),m=Math.floor(i/u.scale),g=Math.floor(s/u.scale);n[h+d*u.canvasWidth][2]=u.emptyColor,o[a[c][2]].set(`${h}/${d}`,[g,m]),M(u.selectData.selectMapList)||u.selectData.selectLayerId!==l.layerId||u.selectData.selectMapList[a[c][2]].has(`${g}/${m}`)||(u.selectData.selectMapList[a[c][2]].delete(`${h}/${d}`),u.selectData.selectMapList[a[c][2]].set(`${g}/${m}`,[g,m]))}let s=Object.keys(o),i=[];for(let c=0;c<s.length;c++){let e=o[s[c]];for(const[a,t]of e){let e=a.split("/")[0],r=a.split("/")[1];e==t[0]&&r==t[1]||i.push([a,t,s[c]])}}for(let c=0;c<i.length;c++){o[i[c][2]].delete(i[c][0])}for(let c=0;c<i.length;c++){o[i[c][2]].set(`${i[c][1][0]}/${i[c][1][1]}`,i[c][1])}u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData=n,u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData=o,g.reDraw(),g.handleLayerMapDataToLayerData(!0)},handleLayerMapDataToLayerData(e=!1){let a=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData;e&&(u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData=JSON.parse(JSON.stringify(u.emptyLayerData)));let t=Object.keys(a);for(let r=0;r<t.length;r++){let e=a[t[r]];for(const[a,l]of e){if(l[0]>=u.canvasWidth||l[1]>=u.canvasHeight||l[0]<0||l[1]<0)return;let e=l[0]+l[1]*u.canvasWidth;u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData[e][2]=t[r]}}},handleAllLayerMapDataToLayerData(){let e=u.drawRecord[u.currentFrameIndex].layer;for(let a=0;a<e.length;a++){let e=u.drawRecord[u.currentFrameIndex].layer[a].layerNewData,t=Object.keys(e);for(let r=0;r<t.length;r++){let l=e[t[r]];for(const[e,n]of l){if(n[0]>=u.canvasWidth||n[1]>=u.canvasHeight||n[0]<0||n[1]<0)return;let e=n[0]+n[1]*u.canvasWidth;u.drawRecord[u.currentFrameIndex].layer[a].layerData[e][2]=t[r]}}}},handleCurrentLayerDataToLayerMapData(e){let a=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData,t={};for(let r=0;r<a.length;r++){if("#00000000"===a[r][2])continue;let e=a[r][0]+"/"+a[r][1];t[a[r][2]]||(t[a[r][2]]=new Map),t[a[r][2]].set(e,[a[r][0],a[r][1]])}u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData=t,e()},handleLayerDataToLayerMapData(e){let a=ee(u.drawRecord[u.currentFrameIndex].layer);u.worker.postMessage({type:14,variables:a}),u.worker.onmessage=a=>{u.drawRecord[u.currentFrameIndex].layer=a.data,e()}},drawTransformSymmetric(){let e=[];for(let a=0;a<u.drawList.length;a++)if(u.isHorizontal){let t=u.canvasWidth-1-u.drawList[a][0],r=u.drawList[a][1];e.push([t,r,u.drawList[a][2]])}else if(u.isVertical){let t=u.drawList[a][0],r=u.canvasHeight-1-u.drawList[a][1];e.push([t,r,u.drawList[a][2]])}else if(u.isCenter){let t=u.drawList[a][0]*u.scale+u.canvasBeginPos.x,r=u.drawList[a][1]*u.scale+u.canvasBeginPos.y,l=2*u.canvasBeginPos.centerX-(t+u.scale/2),n=2*u.canvasBeginPos.centerY-(r+u.scale/2),o=Math.floor((l-u.canvasBeginPos.x)/u.scale),s=Math.floor((n-u.canvasBeginPos.y)/u.scale);e.push([o,s,u.drawList[a][2]])}for(let a=0;a<e.length;a++)g.addDrawList(e[a][0],e[a][1],e[a][2])},removeDrawTransformSymmetric(){let e=[];for(let a=0;a<u.removeDrawList.length;a++)if(u.isHorizontal){let t=u.canvasWidth-1-u.removeDrawList[a][0],r=u.removeDrawList[a][1];e.push([t,r,u.removeDrawList[a][2]])}else if(u.isVertical){let t=u.removeDrawList[a][0],r=u.canvasHeight-1-u.removeDrawList[a][1];e.push([t,r,u.removeDrawList[a][2]])}else if(u.isCenter){let t=u.removeDrawList[a][0]*u.scale+u.canvasBeginPos.x,r=u.removeDrawList[a][1]*u.scale+u.canvasBeginPos.y,l=2*u.canvasBeginPos.centerX-(t+u.scale/2),n=2*u.canvasBeginPos.centerY-(r+u.scale/2),o=Math.floor((l-u.canvasBeginPos.x)/u.scale),s=Math.floor((n-u.canvasBeginPos.y)/u.scale);e.push([o,s,u.removeDrawList[a][2]])}for(let a=0;a<e.length;a++){g.addRemoveDrawList(e[a][0],e[a][1],e[a][2]);let t=e[a][0]*u.scale,r=e[a][1]*u.scale;g.checkLayerEraseOrder(t,r,u.eraserSize*u.scale)}},handleChangeBrushSymmetric(e,a){"isHorizontal"===a&&u[a]?(u.isVertical=!1,u.isCenter=!1):"isCenter"===a&&u[a]?(u.isVertical=!1,u.isHorizontal=!1):"isVertical"===a&&u[a]&&(u.isHorizontal=!1,u.isCenter=!1)},handleWheelEvent(e){if(u.pinDouMode){const a=e.deltaY>0?-.02:.02;let t=J(u.canvas);t+=a;let r=Math.max(.1,t);return r>10&&(r=10),u.canvasStyle.transform=`translate3d(0, 0, 10px) scale(${r})`,u.linmoFitCanvasTimer&&clearTimeout(u.linmoFitCanvasTimer),void(u.linmoFitCanvasTimer=setTimeout((()=>{g.handleDrawReferenceLine()}),250))}const a=e.deltaY>0?-.05:.05;let t=J(u.canvas);t+=a;let r=Math.max(.1,t);r>10&&(r=10),u.canvasStyle.transform=`translate3d(0, 0, 10px) scale(${r})`,u.linmoFitCanvasTimer&&clearTimeout(u.linmoFitCanvasTimer),u.linmoFitCanvasTimer=setTimeout((()=>{g.handleLinmoFitCanvas(),g.handleDrawReferenceLine(),g.handleScaleFrame1()}),250)},handleResizeCanvas(e){if(u.pinDouMode){let a=J(u.canvas);a+=e-.08;let t=Math.max(.1,a);return t>10&&(t=10),u.canvasStyle.transformOrigin="center center",u.canvasStyle.transform=`translate3d(0, 0, 10px) scale(${t})`,u.linmoFitCanvasTimer&&clearTimeout(u.linmoFitCanvasTimer),void(u.linmoFitCanvasTimer=setTimeout((()=>{g.handleDrawReferenceLine()}),250))}let a=J(u.canvas);a+=e;let t=Math.max(.1,a);t>10&&(t=10),u.canvasStyle.transformOrigin="center center",u.canvasStyle.transform=`translate3d(0, 0, 10px) scale(${t})`,u.linmoFitCanvasTimer&&clearTimeout(u.linmoFitCanvasTimer),u.linmoFitCanvasTimer=setTimeout((()=>{g.handleLinmoFitCanvas(),g.handleDrawReferenceLine(),g.handleScaleFrame1()}),250)},handleResizeDraw(){g.drawPixelArea(),u.isScaling?g.handleScaleFrame():u.pinDouMode?g.handleDrawPindou(u.ctx1):g.reDraw(!1)},startDrawing(){var e;u.canvas.addEventListener("mousedown",g.start),u.canvas.addEventListener("mousemove",g.draw),u.canvas.addEventListener("mouseup",g.stop),u.canvas.addEventListener("touchstart",g.mobileStart),u.canvas.addEventListener("touchmove",g.mobileDraw),u.canvas.addEventListener("touchend",g.stop),u.canvas.addEventListener("mouseout",g.leave),u.canvas.addEventListener("wheel",g.handleWheelEvent),u.moveCanvas.addEventListener("wheel",g.handleWheelEvent),null==(e=document.getElementById("dropZone"))||e.addEventListener("mousemove",g.handleChangeMouseStyle)},handleLinmoFitCanvas(e=u.isLockCanvas){u.isLockCanvas=e,(u.linmoMode||u.linmoPhoto)&&u.isLockCanvas&&(t.$refs.LinmoModeDialog.posX=u.canvas.getBoundingClientRect().left-u.baseCanvas.getBoundingClientRect().left-10,t.$refs.LinmoModeDialog.posY=u.canvas.getBoundingClientRect().top-u.baseCanvas.getBoundingClientRect().top-10,t.$refs.LinmoModeDialog.width=u.canvas.getBoundingClientRect().width+20,t.$refs.LinmoModeDialog.height=u.canvas.getBoundingClientRect().height+20,t.$refs.LinmoModeDialog.updatelinmoPhotoStyle())},handleUpdateLinmoStyle(e){u.linmoPhotoStyle=e.style,t.$refs.LinmoModeDialog.posX=e.data.translateX,t.$refs.LinmoModeDialog.posY=e.data.translateY,t.$refs.LinmoModeDialog.width=e.data.width,t.$refs.LinmoModeDialog.height=e.data.height,t.$refs.LinmoModeDialog.rotate=e.data.rotate},handleMoveCanvasMouseDown(e){u.moveData.isMoving=!0;let a=J(u.canvas);u.moveData.x=e.clientX-u.moveCanvas.offsetLeft*a,u.moveData.y=e.clientY-u.moveCanvas.offsetTop*a,document.addEventListener("mousemove",g.handleMoveCanvasMouseMove),document.addEventListener("mouseup",g.handleMoveCanvasMouseUp)},handleMoveCanvasMouseMove(e){if(u.moveData.isMoving){let a=J(u.canvas),t=u.scale,r=u.moveCanvas.offsetLeft,l=u.moveCanvas.offsetTop;e.clientX>u.moveData.x+u.moveCanvas.offsetLeft*a+t*a/2?r+=t:e.clientX<u.moveData.x+u.moveCanvas.offsetLeft*a-t*a/2&&(r-=t),e.clientY>u.moveData.y+u.moveCanvas.offsetTop*a+t*a/2?l+=t:e.clientY<u.moveData.y+u.moveCanvas.offsetTop*a-t*a/2&&(l-=t),u.moveCanvas.style.left=`${r}px`,u.moveCanvas.style.top=`${l}px`}},handleMoveCanvasMouseUp(){u.moveData.isMoving=!1,document.removeEventListener("mousemove",g.handleMoveCanvasMouseMove),document.removeEventListener("mouseup",g.handleMoveCanvasMouseUp)},linmoPhotoStart(e){u.dragLinmoPhoto.enable=!0,u.dragLinmoPhoto.startX=e.offsetX,u.dragLinmoPhoto.startY=e.offsetY,u.dragLinmoPhoto.translateX=parseInt(getComputedStyle(u.linmoPhotoDom).transform.split(" ")[12]),u.dragLinmoPhoto.translateY=parseInt(getComputedStyle(u.linmoPhotoDom).transform.split(" ")[13]),document.addEventListener("mousemove",g.linmoPhotoMove),document.addEventListener("touchmove",g.linmoPhotoMobileMove),document.addEventListener("mouseup",g.linmoPhotoStop)},lnmoPhotoMobileStart(e){let a={offsetX:e.touches[0].clientX,offsetY:e.touches[0].clientY};g.linmoPhotoStart(a)},linmoPhotoMove(e){if(u.dragLinmoPhoto.enable){const a=e.offsetX-u.dragLinmoPhoto.startX,r=e.offsetY-u.dragLinmoPhoto.startY;u.dragLinmoPhoto.translateX+=a,u.dragLinmoPhoto.translateY+=r,t.$refs.LinmoModeDialog.posX=u.dragLinmoPhoto.translateX,t.$refs.LinmoModeDialog.posY=u.dragLinmoPhoto.translateY;let l=u.linmoPhotoStyle.transform.split(") ")[1]+")",n=u.linmoPhotoStyle.transform.split(") ")[2];u.linmoPhotoStyle.transform=`translate3d(${u.dragLinmoPhoto.translateX}px, ${u.dragLinmoPhoto.translateY}px, 10px) ${l} ${n}`}},linmoPhotoMobileMove(e){let a={offsetX:e.touches[0].clientX,offsetY:e.touches[0].clientY};g.linmoPhotoMove(a)},linmoPhotoStop(){u.dragLinmoPhoto.enable=!1,document.removeEventListener("mousemove",g.linmoPhotoMove),document.removeEventListener("touchmove",g.linmoPhotoMobileMove),document.removeEventListener("mouseup",g.linmoPhotoStop)},handleBrushColorAlpha(){let e=ae(u.brushColor),a=e[0],t=e[1],r=e[2],l=u.layerAlpha/100;return k([a,t,r,l])},mobileStart(e){let a={offsetX:e.touches[0].clientX-u.canvas.getBoundingClientRect().left,offsetY:e.touches[0].clientY-u.canvas.getBoundingClientRect().top};g.start(a)},start(e){if(e){g.stop();const a=Math.floor((e.offsetY-u.drawAreaList[0][1])/u.scale),r=Math.floor((e.offsetX-u.drawAreaList[0][0])/u.scale);if(u.isSpace)return u.isDragging=!0,u.dragData.x=e.clientX-u.canvas.offsetLeft,void(u.dragData.y=e.clientY-u.canvas.offsetTop);if(0===u.currentTool){if(!M(u.selectData.selectMapList))return t.$message.warning("请先取消选中区域");if(0===e.button)u.ctx1.fillStyle=g.handleBrushColorAlpha(),u.mouseDrawData.startX=e.offsetX-e.offsetX%(u.scale*u.brushSize),u.mouseDrawData.startY=e.offsetY-e.offsetY%(u.scale*u.brushSize),u.isDrawing=!0;else if(2===e.button){if("0000"===Array.from(u.ctx1.getImageData(e.offsetX,e.offsetY,1,1).data).join(""))return;u.mouseDrawData.startX=e.offsetX-e.offsetX%(u.scale*u.eraserSize),u.mouseDrawData.startY=e.offsetY-e.offsetY%(u.scale*u.eraserSize),u.isErasering=!0}g.draw(e)}else if(1===u.currentTool){if(!M(u.selectData.selectMapList))return t.$message.warning("请先取消选中区域");const l=Array.from(u.ctx1.getImageData(e.offsetX,e.offsetY,1,1).data);if("0000"===l.join(""))return;0===e.button?(u.mouseDrawData.startX=e.offsetX-e.offsetX%(u.scale*u.eraserSize),u.mouseDrawData.startY=e.offsetY-e.offsetY%(u.scale*u.eraserSize),u.isErasering=!0,g.draw(e)):2===e.button&&g.fillChunkSelect(r,a,k(l),!0)}else if(2===u.currentTool){const l=Array.from(u.ctx1.getImageData(e.offsetX,e.offsetY,1,1).data);if("0000"!==l.join("")&&(u.brushColor=k(l),t.$refs.ReplaceColorDialog.dialogVisible&&t.$refs.ReplaceColorDialog.handleUpdate(u.brushColor),u.pinDouDrawMode)){let e={color:u.brushColor,col:r,row:a};t.$refs.PindouDialog.selectedObj=e}}else if(3===u.currentTool){if(!M(u.selectData.selectMapList))return t.$message.warning("请先取消选中区域");u.isScaling&&g.handleCancelScale(),u.ctx1.fillStyle=g.handleBrushColorAlpha(),u.ctx1.strokeStyle=g.handleBrushColorAlpha(),u.ctx1.lineWidth=u.scale,u.ctx1.setLineDash([]),u.isDrawShape=!0;let e=r*u.scale+u.canvasBeginPos.x,l=a*u.scale+u.canvasBeginPos.y;u.lastX=e+u.scale/2,u.lastY=l+u.scale/2}else if(4===u.currentTool){let e=te(u.brushColor)?k(I(u.brushColor)):k(T(u.brushColor));if(!M(u.selectData.selectMapList))return void g.handleReplaceColor(e);const t=g.getCurrentLayerColorByCoords(r,a);if(!t)return;g.fillChunk(r,a,t,e)}else if(5===u.currentTool&&u.pinDouMode){let e=r+a*u.canvasWidth,l=u.pinDouData.variables;for(let n=0;n<l.length;n++)if(l[n].isRender&&l[n].layerData[e][2]!==u.emptyColor){let o={name:l[n].layerData[e][3],color:l[n].layerData[e][2],col:r,row:a};t.$refs.PindouDialog.selectedObj=o;break}}else if(7777===u.currentTool);else if(8===u.currentTool&&"select"===u.selectType){u.isScaling&&g.handleCancelScale();let t=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex];if(!t.isRender)return;if(0===e.button){if(u.selectData.selectLayerId!==t.layerId&&t.layerData[r+a*u.canvasWidth][2]!==u.emptyColor&&(g.handleCancelSelect(),u.selectData.selectLayerId=t.layerId),u.isSelecting=!0,u.selectData.x=r,u.selectData.y=a,u.ctx1.lineWidth=1,u.isSelecting&&u.isShift&&(u.isMoving=!0,u.canvas.style.cursor="move",u.moveData.x=u.selectData.x,u.moveData.y=u.selectData.y,u.moveData.list=JSON.parse(JSON.stringify(u.selectData.selectList)),u.selectData.selectOriginList=V(u.selectData.selectMapList),!u.selectData.copyList.length)){let e=Object.keys(u.selectData.selectOriginList);for(let a=0;a<e.length;a++){let r=e[a],l=u.selectData.selectOriginList[e[a]];for(const[e,a]of l){let e=a[0]+a[1]*u.canvasWidth;t.layerData[e][2]=u.emptyColor,t.layerNewData[r].delete(`${a[0]}/${a[1]}`)}}}g.draw(e)}else if(2===e.button){let e=t.layerData[r+a*u.canvasWidth][2];if(e===u.emptyColor)return;if(u.selectData.selectMapList[e]){let t=r+"/"+a;u.selectData.selectMapList[e].delete(t)}let l=u.selectData.selectList.findIndex((e=>e[0]===r&&e[1]===a));if(l>=0){let t=r*u.scale,n=a*u.scale;u.ctx1.fillStyle=e,u.ctx1.fillRect(t,n,u.scale,u.scale),u.selectData.selectList.splice(l,1)}}}else if(8===u.currentTool&&"quickSelect"===u.selectType){let t=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex];if(!t.isRender)return;if(0===e.button){if(u.selectData.selectLayerId!==t.layerId&&t.layerData[r+a*u.canvasWidth][2]!==u.emptyColor&&(g.handleCancelSelect(),u.selectData.selectLayerId=t.layerId),u.isSelecting=!0,u.selectData.x=r,u.selectData.y=a,u.ctx1.lineWidth=1,u.isSelecting&&u.isShift){if(u.isMoving=!0,u.canvas.style.cursor="move",u.moveData.x=u.selectData.x,u.moveData.y=u.selectData.y,u.moveData.list=JSON.parse(JSON.stringify(u.selectData.selectList)),u.selectData.selectOriginList=V(u.selectData.selectMapList),!u.selectData.copyList.length){let e=Object.keys(u.selectData.selectOriginList);for(let a=0;a<e.length;a++){let r=e[a],l=u.selectData.selectOriginList[e[a]];for(const[e,a]of l){let e=a[0]+a[1]*u.canvasWidth;t.layerData[e][2]=u.emptyColor,t.layerNewData[r].delete(`${a[0]}/${a[1]}`)}}}return}const l=Array.from(u.ctx1.getImageData(e.offsetX,e.offsetY,1,1).data);"0000"!==l.join("")&&g.fillChunkSelect(r,a,k(l))}else 2===e.button&&g.handleCancelSelect()}else if(8===u.currentTool&&"rangeSelect"===u.selectType){let t=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex];if(!t.isRender)return;if(u.selectData.selectList.length&&u.selectData.selectList.find((e=>e[0]===r&&e[1]===a))?u.isSelecting=!0:(u.selectData.selectLayerId!==t.layerId&&(g.handleCancelSelect(),u.selectData.selectLayerId=t.layerId),u.isSelectDraging=!0,u.canvasRealLeft=u.baseCanvas.getBoundingClientRect().left,u.canvasRealTop=u.baseCanvas.getBoundingClientRect().top,u.lastX=e.clientX-u.canvasRealLeft,u.lastY=e.clientY-u.canvasRealTop),u.selectData.x=r,u.selectData.y=a,u.ctx1.lineWidth=1,u.ctx0.lineWidth=2,u.isSelecting&&u.isShift&&(u.isMoving=!0,u.canvas.style.cursor="move",u.moveData.x=u.selectData.x,u.moveData.y=u.selectData.y,u.moveData.list=JSON.parse(JSON.stringify(u.selectData.selectList)),u.selectData.selectOriginList=V(u.selectData.selectMapList),!u.selectData.copyList.length)){let e=Object.keys(u.selectData.selectOriginList);for(let a=0;a<e.length;a++){let r=e[a],l=u.selectData.selectOriginList[e[a]];for(const[e,a]of l){let e=a[0]+a[1]*u.canvasWidth;t.layerData[e][2]=u.emptyColor,t.layerNewData[r].delete(`${a[0]}/${a[1]}`)}}}}else if(9===u.currentTool&&u.isScaling){if(!u.scaleAreaData)return;u.lastX=e.offsetX,u.lastY=e.offsetY,u.isScale=!0}}},handleReplaceColor(e){for(let a=0;a<u.selectData.selectList.length;a++){u.selectData.selectList[a][2]=e;let t=u.selectData.selectList[a][0]+u.selectData.selectList[a][1]*u.canvasWidth;u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData[t][2]=e}g.reDraw()},handleReplacePindouColor(e,a){if(u.pinDouDrawMode)return g.handleConfirmReplaceColor(e,a);let r=k(I(e.replaceObj.color)),l=u.pinDouData.variables,n=u.pinDouData.colorStatList;if(1===e.type){for(let a=l.length-1;a>=0;a--)if(l[a].isRender)for(let t=0;t<l[a].layerData.length;t+=2){if(l[a].layerData[t][0]===e.originObj.col&&l[a].layerData[t][1]===e.originObj.row&&l[a].layerData[t][3]){l[a].layerData[t][2]=r,l[a].layerData[t][3]=e.replaceObj.name;break}if(t+1<l[a].layerData.length&&l[a].layerData[t+1][0]===e.originObj.col&&l[a].layerData[t+1][1]===e.originObj.row&&l[a].layerData[t+1][3]){l[a].layerData[t+1][2]=r,l[a].layerData[t+1][3]=e.replaceObj.name;break}}let o=n.get(e.originObj.name);if(!o)return t.$message.warning("当前选择颜色不存在"),void a();if(n.has(e.replaceObj.name)){let a=n.get(e.replaceObj.name)[1]+1;n.set(e.replaceObj.name,[r,a]),n.set(e.originObj.name,[o[0],o[1]-1])}else n.set(e.originObj.name,[o[0],o[1]-1]),n.set(e.replaceObj.name,[r,1])}else if(2===e.type){for(let a=l.length-1;a>=0;a--)if(l[a].isRender)for(let t=0;t<l[a].layerData.length;t+=2)l[a].layerData[t][3]&&l[a].layerData[t][3]===e.originObj.name&&(l[a].layerData[t][2]=r,l[a].layerData[t][3]=e.replaceObj.name),t+1<l[a].layerData.length&&l[a].layerData[t+1][3]&&l[a].layerData[t+1][3]===e.originObj.name&&(l[a].layerData[t+1][2]=r,l[a].layerData[t+1][3]=e.replaceObj.name);let o=n.get(e.originObj.name);if(!o)return t.$message.warning("当前选择颜色不存在"),void a();if(n.has(e.replaceObj.name)){let a=n.get(e.replaceObj.name),t=o[1]+a[1];n.delete(e.originObj.name),n.set(e.replaceObj.name,[r,t])}else n.delete(e.originObj.name),n.set(e.replaceObj.name,[r,o[1]])}const o=Array.from(n);o.sort(((e,a)=>a[1][1]-e[1][1])),u.pinDouData.colorStatList=new Map(o),t.$refs.PindouDialog.handleColorStatList(u.pinDouData.colorStatList),a(),g.handleDrawPindou(u.ctx1)},getCurrentLayerColorByCoords(e,a){let t=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData,r=e+a*u.canvasWidth;return t[r]?t[r][2]:null},fillChunk(e,a,t,r){if(t===r)return;u.loading=!0;let l=X(u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex]),n=i(s({},l),{layerNewData:V(l.layerNewData)});u.worker.postMessage({type:9,variables:n,options:{x:e,y:a,targetColor:t,replacementColor:r},canvasWidth:u.canvasWidth,canvasHeight:u.canvasHeight,tolerance:u.tolerance}),u.worker.onmessage=e=>{u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData=e.data.layerData,u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData=e.data.layerNewData,u.loading=!1,g.reDraw()}},fillChunkSelect(e,a,t,r=!1){if(t===u.emptyColor)return;if(u.selectData.selectMapList[t]&&u.selectData.selectMapList[t].has(`${e}/${a}`))return;u.loading=!0;let l=X(u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData),n=X(u.selectData);u.worker.postMessage({type:10,variables:l,selectData:n,options:{x:e,y:a,targetColor:t},canvasWidth:u.canvasWidth,canvasHeight:u.canvasHeight,tolerance:u.tolerance}),u.worker.onmessage=e=>{u.selectData.selectList=e.data.variables.selectList,u.selectData.selectMapList=e.data.variables.selectMapList,u.loading=!1,r?g.handleRemoveSelect():g.reDrawSelectData()}},handleChangeMouseStyle(e){if(!e)return;if(!u.scaleWhitePointPos.length)return;u.canvasRealLeft=u.baseCanvas.getBoundingClientRect().left,u.canvasRealTop=u.baseCanvas.getBoundingClientRect().top;let a=e.clientX-u.canvasRealLeft,t=e.clientY-u.canvasRealTop;Math.abs(a-u.scaleWhitePointPos[0][0])<=15&&Math.abs(t-u.scaleWhitePointPos[0][1])<=15&&(u.canvas.style.cursor="se-resize",u.scaleAreaData.cursor="se-resize")},drawSquareLine(e,a,t,r){const l=u.scale*u.brushSize,n=Math.abs(t-e),o=Math.abs(r-a),s=e<t?l:-l,i=a<r?l:-l;let c=n-o;for(;;){for(let t=0;t<u.brushSize;t++){let r=a+u.scale*t;for(let t=0;t<u.brushSize;t++){let l=e+u.scale*t,n=Math.floor(l/u.scale),o=Math.floor(r/u.scale);n>=0&&n<u.canvasWidth&&o>=0&&o<u.canvasHeight&&g.addDrawList(n,o,u.brushColor),g.checkLayerDrawOrder(l,r,u.scale);let s=-1,i=-1;if(u.isHorizontal)s=u.canvasWidth-1-n,i=o;else if(u.isVertical)s=n,i=u.canvasHeight-1-o;else if(u.isCenter){let t=2*u.canvasBeginPos.centerX-(e+u.scale/2),r=2*u.canvasBeginPos.centerY-(a+u.scale/2);s=Math.floor(t/u.scale),i=Math.floor(r/u.scale)}if(s>=0&&s<u.canvasWidth&&i>=0&&i<u.canvasHeight){g.addDrawList(s,i,u.brushColor);let e=s*u.scale,a=i*u.scale;g.checkLayerDrawOrder(e,a,u.scale)}}}if(e===t&&a===r)break;const l=2*c;l>-o&&(c-=o,e+=s),l<n&&(c+=n,a+=i)}},checkLayerDrawOrder(e,a,t){if(u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].isRender){let r=!1,l=Math.floor(e/u.scale)+Math.floor(a/u.scale)*u.canvasWidth;for(let e=0;e<u.currentLayerIndex;e++){let a=u.drawRecord[u.currentFrameIndex].layer[e];a.isRender&&a.layerData[l][2]!==u.emptyColor&&(r=!0)}if(!r)if(g.getCurrentLayerIsLock()){u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData[l][2]===u.emptyColor&&u.ctx1.fillRect(e,a,t,t)}else u.ctx1.fillRect(e,a,t,t)}},eraseSquareLine(e,a,t,r){const l=u.scale*u.eraserSize,n=Math.abs(t-e),o=Math.abs(r-a),s=e<t?l:-l,i=a<r?l:-l;let c=n-o;for(;;){for(let t=0;t<u.eraserSize;t++){let r=a+u.scale*t;for(let t=0;t<u.eraserSize;t++){let l=e+u.scale*t,n=Math.floor(l/u.scale),o=Math.floor(r/u.scale);n>=0&&n<u.canvasWidth&&o>=0&&o<u.canvasHeight&&g.addRemoveDrawList(n,o,u.brushColor),g.checkLayerEraseOrder(l,r,u.scale);let s=-1,i=-1;if(u.isHorizontal)s=u.canvasWidth-1-n,i=o;else if(u.isVertical)s=n,i=u.canvasHeight-1-o;else if(u.isCenter){let t=2*u.canvasBeginPos.centerX-(e+u.scale/2),r=2*u.canvasBeginPos.centerY-(a+u.scale/2);s=Math.floor(t/u.scale),i=Math.floor(r/u.scale)}if(s>=0&&s<u.canvasWidth&&i>=0&&i<u.canvasHeight){g.addRemoveDrawList(s,i,u.brushColor);let e=s*u.scale,a=i*u.scale;g.checkLayerEraseOrder(e,a,u.scale)}}}if(e===t&&a===r)break;const l=2*c;l>-o&&(c-=o,e+=s),l<n&&(c+=n,a+=i)}},checkLayerEraseOrder(e,a,t){if(u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].isRender){let r=Math.floor(e/u.scale)+Math.floor(a/u.scale)*u.canvasWidth,l=u.drawRecord[u.currentFrameIndex].layer;l[u.currentLayerIndex].layerData[r][2]!==u.emptyColor&&u.ctx1.clearRect(e,a,t,t);for(let n=l.length-1;n>=0;n--)l[n].isRender&&n!==u.currentLayerIndex&&l[n].layerData[r]&&l[n].layerData[r][2]!==u.emptyColor&&(u.ctx1.fillStyle=l[n].layerData[r][2],u.ctx1.fillRect(e,a,t,t))}},draw(e){if(e){const a=Math.floor((e.offsetY-u.drawAreaList[0][1])/u.scale),t=Math.floor((e.offsetX-u.drawAreaList[0][0])/u.scale);if(u.isSpace){if(u.canvas.style.cursor="grabbing",u.isDragging){const a=e.clientX-u.dragData.x,t=e.clientY-u.dragData.y;u.canvas.style.left=`${a}px`,u.canvas.style.top=`${t}px`,u.moveBoxDom.style.left=`${a}px`,u.moveBoxDom.style.top=`${t}px`,u.bgCanvas.style.left=`${a}px`,u.bgCanvas.style.top=`${t}px`,u.gridCanvas.style.left=`${a}px`,u.gridCanvas.style.top=`${t}px`,g.handleDrawReferenceLine(),g.handleScaleFrame1(),u.linmoFitCanvasTimer&&clearTimeout(u.linmoFitCanvasTimer),u.linmoFitCanvasTimer=setTimeout((()=>{g.handleLinmoFitCanvas()}),250)}return}if(u.isShift&&u.isMoving&&u.isSelecting?u.canvas.style.cursor="move":(u.canvas.style.cursor="",g.addCursorClass(e)),u.gridInfo=`[${t}, ${a}]`,u.isDrawing){const a=e.offsetX-e.offsetX%(u.scale*u.brushSize),t=e.offsetY-e.offsetY%(u.scale*u.brushSize),r=u.mouseDrawData.startX,l=u.mouseDrawData.startY;g.drawSquareLine(r,l,a,t),u.mouseDrawData.startX=a,u.mouseDrawData.startY=t}else if(u.isErasering){const a=e.offsetX-e.offsetX%(u.scale*u.eraserSize),t=e.offsetY-e.offsetY%(u.scale*u.eraserSize),r=u.mouseDrawData.startX,l=u.mouseDrawData.startY;g.eraseSquareLine(r,l,a,t),u.mouseDrawData.startX=a,u.mouseDrawData.startY=t}else if(u.isDrawShape){if("rect"===u.currentDrawShape||"fillRect"===u.currentDrawShape){if(g.addShapeList(t,a),u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].isRender){let e=u.drawShapeList[0][0],r=u.drawShapeList[0][1],l=t,n=a;u.drawShapeData.maxX=Math.max(e,l,u.drawShapeData.maxX),u.drawShapeData.maxY=Math.max(r,n,u.drawShapeData.maxY),u.drawShapeData.minX=Math.min(e,l,u.drawShapeData.minX),u.drawShapeData.minY=Math.min(r,n,u.drawShapeData.minY),u.drawShapeData.minX<0&&u.drawShapeData.minY<0&&(u.drawShapeData.minX=Math.min(e,l),u.drawShapeData.minY=Math.min(r,n)),u.drawShapeData.list=re(u.drawShapeData);let o=u.drawShapeData.minX*u.scale,s=u.drawShapeData.minY*u.scale,i=u.drawShapeData.maxX*u.scale+u.scale-o,c=u.drawShapeData.maxY*u.scale+u.scale-s;u.ctx1.clearRect(o,s,i,c);let d=g.getRectIntersect(u.drawShapeData.list),h=[];h="fillRect"===u.currentDrawShape?g.drawFillRect(e,r,l,n):g.drawRect(e,r,l,n),g.reDrawPart(d),u.ctx1.fillStyle=g.handleBrushColorAlpha();for(let a=0;a<h.length;a++){let e=h[a][0]*u.scale,t=h[a][1]*u.scale;if(g.getCurrentLayerIsLock()){u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData[h[a][0]+h[a][1]*u.canvasWidth][2]===u.emptyColor&&u.ctx1.fillRect(e,t,u.scale,u.scale)}else u.ctx1.fillRect(e,t,u.scale,u.scale)}}}else if("circle"===u.currentDrawShape){if(g.addShapeList(t,a),u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].isRender){let e=u.drawShapeList[0][0],r=u.drawShapeList[0][1],l=t,n=a;u.drawShapeData.maxX=Math.max(e,l,u.drawShapeData.maxX),u.drawShapeData.maxY=Math.max(r,n,u.drawShapeData.maxY),u.drawShapeData.minX=Math.min(e,l,u.drawShapeData.minX),u.drawShapeData.minY=Math.min(r,n,u.drawShapeData.minY),u.drawShapeData.minX<0&&u.drawShapeData.minY<0&&(u.drawShapeData.minX=Math.min(e,l),u.drawShapeData.minY=Math.min(r,n)),u.drawShapeData.list=re(u.drawShapeData);let o=u.drawShapeData.minX*u.scale,s=u.drawShapeData.minY*u.scale,i=u.drawShapeData.maxX*u.scale+u.scale-o,c=u.drawShapeData.maxY*u.scale+u.scale-s;u.ctx1.clearRect(o,s,i,c);let d=g.getRectIntersect(u.drawShapeData.list),h=g.drawCircle(e,r,l,n,u.scale);g.reDrawPart(d),u.ctx1.fillStyle=g.handleBrushColorAlpha();for(let a=0;a<h.length;a++){if(h[a][0]>u.canvasWidth||h[a][1]>u.canvasHeight||h[a][0]<0||h[a][1]<0)return;let e=h[a][0]*u.scale,t=h[a][1]*u.scale;if(g.getCurrentLayerIsLock()){u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData[h[a][0]+h[a][1]*u.canvasWidth][2]===u.emptyColor&&u.ctx1.fillRect(e,t,u.scale,u.scale)}else u.ctx1.fillRect(e,t,u.scale,u.scale)}}}else if("line"===u.currentDrawShape){if(g.addShapeList(t,a),u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].isRender){let e=u.drawShapeList[0][0],r=u.drawShapeList[0][1],l=t,n=a;u.drawShapeData.maxX=Math.max(e,l,u.drawShapeData.maxX),u.drawShapeData.maxY=Math.max(r,n,u.drawShapeData.maxY),u.drawShapeData.minX=Math.min(e,l,u.drawShapeData.minX),u.drawShapeData.minY=Math.min(r,n,u.drawShapeData.minY),u.drawShapeData.minX<0&&u.drawShapeData.minY<0&&(u.drawShapeData.minX=Math.min(e,l),u.drawShapeData.minY=Math.min(r,n)),u.drawShapeData.list=re(u.drawShapeData);let o=u.drawShapeData.minX*u.scale,s=u.drawShapeData.minY*u.scale,i=u.drawShapeData.maxX*u.scale+u.scale-o,c=u.drawShapeData.maxY*u.scale+u.scale-s;u.ctx1.clearRect(o,s,i,c);let d=g.getRectIntersect(u.drawShapeData.list),h=g.drawLine(e,r,l,n);g.reDrawPart(d),u.ctx1.fillStyle=g.handleBrushColorAlpha();for(let a=0;a<h.length;a++){if(h[a][0]>u.canvasWidth||h[a][1]>u.canvasHeight||h[a][0]<0||h[a][1]<0)return;let e=h[a][0]*u.scale,t=h[a][1]*u.scale;if(g.getCurrentLayerIsLock()){u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData[h[a][0]+h[a][1]*u.canvasWidth][2]===u.emptyColor&&u.ctx1.fillRect(e,t,u.scale,u.scale)}else u.ctx1.fillRect(e,t,u.scale,u.scale)}}}else if("curve"===u.currentDrawShape&&u.curveType.isPress&&(g.addShapeList(t,a),u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].isRender)){let e=u.drawShapeList[0][0],r=u.drawShapeList[0][1],l=t,n=a;if(e===l&&r===n)return;if(e===l||r===n){let a=0,t=0,o=0;if(e===l&&["3","4"].includes(u.curveType.pressKey)?(t=Math.round(Math.min(r,n)+Math.abs(n-r)/2),"3"===u.curveType.pressKey?a=Math.round(e-u.curvature)<=0?0:Math.round(e-u.curvature):"4"===u.curveType.pressKey&&(a=Math.round(e+u.curvature)>=u.canvasWidth?u.canvasWidth:Math.round(e+u.curvature)),o=Math.abs(n-r)):r===n&&["1","2"].includes(u.curveType.pressKey)&&(a=Math.round(Math.abs(l-e)/2+Math.min(e,l)),"1"===u.curveType.pressKey?t=Math.round(r-u.curvature)<=0?0:Math.round(r-u.curvature):"2"===u.curveType.pressKey&&(t=Math.round(r+u.curvature)>=u.canvasHeight?u.canvasHeight:Math.round(r+u.curvature)),o=Math.abs(l-e)),0===a&&0===t)return;let s=g.drawCurve({x:e,y:r},{x:a,y:t},{x:l,y:n},20+o);u.curveEndPos=[l,n],g.reDraw(!1);for(let e=0;e<s.length;e++){if(s[e][0]>u.canvasWidth||s[e][1]>u.canvasHeight)return;let a=s[e][0]*u.scale+u.canvasBeginPos.x,t=s[e][1]*u.scale+u.canvasBeginPos.y;u.ctx1.fillStyle=u.brushColor,u.ctx1.fillRect(a,t,u.scale,u.scale)}}}}else if(u.isMoving&&!u.isSelecting&&u.moveData.list.length,u.isSelecting){if(u.isMoving){let e=t-u.moveData.x,r=a-u.moveData.y;if(0===e&&0===r)return;let l=Object.keys(u.selectData.selectMapList);for(let a=0;a<l.length;a++){let e=u.selectData.selectMapList[l[a]];for(const[a,t]of e){let e=t,a=e[0]*u.scale,r=e[1]*u.scale;u.ctx1.clearRect(a,r,u.scale,u.scale)}}if(u.selectData.copySelectMapList){let e=Object.keys(u.selectData.copySelectMapList);for(let a=0;a<e.length;a++){u.ctx1.fillStyle=e[a];let t=u.selectData.copySelectMapList[e[a]];for(const[e,a]of t){let e=a,t=e[0]*u.scale,r=e[1]*u.scale;u.ctx1.fillRect(t,r,u.scale,u.scale)}}}let n=g.getRectIntersectV2(u.selectData.selectMapList);for(let a=0;a<l.length;a++){let t=u.selectData.selectMapList[l[a]];for(const[n,o]of t){let t=o,s=t[0]+e,i=t[1]+r;u.selectData.selectMapList[l[a]].set(n,[s,i])}}u.moveData.x=t,u.moveData.y=a,g.reDrawPartV2(n);for(let a=0;a<u.moveData.list.length;a++)u.moveData.list[a][0]+=e,u.moveData.list[a][1]+=r;return void(u.selectData.selectList=JSON.parse(JSON.stringify(u.moveData.list)))}if("rangeSelect"===u.selectType)return;let e=g.getCurrentLayerColorByCoords(t,a);if(e!==u.emptyColor){u.selectData.x=t,u.selectData.y=a;let r=t+"/"+a;if(u.selectData.selectMapList[e]||(u.selectData.selectMapList[e]=new Map),!u.selectData.selectMapList[e].has(r)){u.selectData.selectMapList[e].set(r,[t,a]);let l=u.selectData.x*u.scale,n=u.selectData.y*u.scale;u.ctx1.strokeStyle=u.selectActiveColor,u.ctx1.strokeRect(l+1,n+1,u.scale-2,u.scale-2)}u.selectData.selectList.findIndex((e=>e[0]===u.selectData.x&&e[1]===u.selectData.y))<0&&u.selectData.selectList.push([u.selectData.x,u.selectData.y,e])}}else if(u.isScale){u.canvas.style.cursor=u.scaleAreaData.cursor;const a=e.offsetX-u.lastX,t=e.offsetY-u.lastY;if(a>=u.scale-5&&t>=u.scale-5||a<=5-u.scale&&t<=5-u.scale){a>=u.scale-5||t>=u.scale-5?u.scaleRatio=u.scaleRatio+=1:(a<=5-u.scale||t<=5-u.scale)&&(u.scaleRatio=u.scaleRatio-=1),u.lastX=e.offsetX,u.lastY=e.offsetY,u.scaleAreaData.coordMaxtrix.length+u.scaleRatio===0&&(u.scaleRatio+=1);let r=J(u.canvas),l=(u.scaleAreaData.maxX+u.scaleRatio)*u.scale*r+u.scale*r,n=u.scaleAreaData.minX*u.scale*r,o=(u.scaleAreaData.maxY+u.scaleRatio)*u.scale*r+u.scale*r,s=u.scaleAreaData.minY*u.scale*r,i=u.scaleAreaData.minX*u.scale,c=u.scaleAreaData.minY*u.scale,d=(u.scaleAreaData.maxX+u.scaleRatio)*u.scale+u.scale-i,h=(u.scaleAreaData.maxY+u.scaleRatio)*u.scale+u.scale-c;a>=u.scale-5||t>=u.scale-5?(u.drawShapeData.list=re({maxX:u.scaleAreaData.maxX+u.scaleRatio,maxY:u.scaleAreaData.maxY+u.scaleRatio,minX:u.scaleAreaData.minX,minY:u.scaleAreaData.minY}),u.ctx1.clearRect(i,c,d,h)):(u.drawShapeData.list=re({maxX:u.scaleAreaData.maxX+u.scaleRatio+1,maxY:u.scaleAreaData.maxY+u.scaleRatio+1,minX:u.scaleAreaData.minX,minY:u.scaleAreaData.minY}),u.ctx1.clearRect(i,c,d+u.scale,h+u.scale));let m=g.getRectIntersect(u.drawShapeData.list).filter((e=>!u.scaleAreaData.originArr.find((a=>a[0]===e[0]&&a[1]===e[1])))),y=Z(u.scaleAreaData,u.scaleRatio),f=Q(u.scaleAreaData,u.scaleRatio);u.scaleAreaData.scaledCoordMap=y,u.scaleAreaData.scaledColorMap=f,g.reDrawPart(m);for(let e=0;e<y.length;e++)for(let a=0;a<y[e].length;a++){let t=y[e][a][0]*u.scale,r=y[e][a][1]*u.scale;u.ctx1.fillStyle=f[e][a][0],u.ctx1.fillRect(t,r,u.scale,u.scale)}g.handleDrawReferenceLine(),g.handleDrawScaleFrame(n-5,s-5,l+5,o+5)}}else if(u.isSelectDraging&&"rangeSelect"===u.selectType){const r=e.clientX-u.canvasRealLeft-u.lastX,l=e.clientY-u.canvasRealTop-u.lastY;g.handleDrawReferenceLine(),u.ctx0.strokeStyle="green",u.ctx0.setLineDash([]),u.ctx0.beginPath(),u.ctx0.globalCompositeOperation="destination-out",u.ctx0.fillRect(u.lastX,u.lastY,r,l),u.ctx0.globalCompositeOperation="source-over",u.ctx0.moveTo(u.lastX,u.lastY),u.ctx0.lineTo(u.lastX+r,u.lastY),u.ctx0.lineTo(u.lastX+r,u.lastY+l),u.ctx0.lineTo(u.lastX,u.lastY+l),u.ctx0.lineTo(u.lastX,u.lastY),u.ctx0.stroke(),u.ctx0.closePath(),u.selectData.endX=t,u.selectData.endY=a}}else u.canvas.classList=""},mobileDraw(e){let a={offsetX:e.touches[0].clientX-u.canvas.getBoundingClientRect().left,offsetY:e.touches[0].clientY-u.canvas.getBoundingClientRect().top};g.draw(a)},handleCancelSelect(){if(M(u.selectData.selectMapList))return;if(!u.selectData.selectList.length)return;let e=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData,a=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData,t=Object.keys(u.selectData.selectMapList);for(let r=0;r<t.length;r++){let l=t[r],n=u.selectData.selectMapList[l];for(const[t,r]of n){let t=r[0],n=r[1],o=t+"/"+n;if(a[l]){a[l].set(o,[t,n]),e[t+n*u.canvasWidth][2]=l}else{a[l]=new Map,a[l].set(o,[t,n]),e[t+n*u.canvasWidth][2]=l}}}u.selectData.copySelectMapList=null,u.selectData.selectMapList={},g.reDraw(),u.selectData.isCancelSelect=!0,u.selectData.selectLayerId=0,u.selectData.selectList=[],u.selectData.selectOriginList=[],u.selectData.originList=[],u.selectData.copyList=[],u.isMoving=!1,u.isSelecting=!1,u.isScaling&&g.handleCancelScale()},handleRemoveSelect(){if(M(u.selectData.selectMapList))return;if(!u.selectData.selectList.length)return;let e=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData,a=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData,t=Object.keys(u.selectData.selectMapList);for(let r=0;r<t.length;r++){let a=t[r],l=u.selectData.selectMapList[a];for(const[t,r]of l){let t=r[0]+"/"+r[1];e[a].delete(t)}}u.selectData.selectMapList={},u.selectData.copySelectMapList=null,g.reDraw();for(let r=0;r<u.selectData.selectList.length;r++){if(u.selectData.selectList[r][0]>=u.canvasWidth||u.selectData.selectList[r][1]>=u.canvasHeight||u.selectData.selectList[r][0]<0||u.selectData.selectList[r][1]<0)continue;let e=u.selectData.selectList[r][0]+u.selectData.selectList[r][1]*u.canvasWidth;a[e][2]!==u.emptyColor&&(a[e][2]=u.emptyColor)}u.selectData.selectList=[],u.selectData.copyList=[],u.isMoving=!1,u.isSelecting=!1},getRectIntersectV2(e){let a=u.drawRecord[u.currentFrameIndex].layer,t={};for(let r=a.length-1;r>=0;r--)if(a[r].isRender){let l=Object.keys(e);for(let n=0;n<l.length;n++){let o=e[l[n]];for(const[e,l]of o){let e=l,n=e[0]+e[1]*u.canvasWidth;if(!(n<0||n>a[r].layerData.length-1)&&(!(a[r].layerData[n][0]>=u.canvasWidth||a[r].layerData[n][1]>=u.canvasHeight||a[r].layerData[n][0]<0||a[r].layerData[n][1]<0)&&a[r].layerData[n]&&a[r].layerData[n][2]!==u.emptyColor)){t[a[r].layerData[n][2]]||(t[a[r].layerData[n][2]]=new Map);let e=a[r].layerData[n][0]+"/"+a[r].layerData[n][1];t[a[r].layerData[n][2]].set(e,[a[r].layerData[n][0],a[r].layerData[n][1]])}}}}return t},getRectIntersect(e){let a=u.drawRecord[u.currentFrameIndex].layer,t=[];for(let r=a.length-1;r>=0;r--)if(a[r].isRender)for(let l=0;l<e.length;l++){let n=e[l][0]+e[l][1]*u.canvasWidth;n<0||n>a[r].layerData.length-1||(a[r].layerData[n][0]>=u.canvasWidth||a[r].layerData[n][1]>=u.canvasHeight||a[r].layerData[n][0]<0||a[r].layerData[n][1]<0||a[r].layerData[n]&&a[r].layerData[n][2]!==u.emptyColor&&t.push(a[r].layerData[n]))}return t},startDrag(e,a){if(u.isDragging){const t=e-u.dragData.x,r=a-u.dragData.y;let l=u.drawAreaList[0][0]+t,n=u.drawAreaList[0][1]+r,o=l+u.scale*u.canvasWidth/2,s=n+u.scale*u.canvasHeight/2;g.drawPixelArea(),u.isScaling?g.handleScaleFrame({x:l,y:n,centerX:o,centerY:s}):u.pinDouMode?g.handleDrawPindou(u.ctx1,{x:l,y:n,centerX:o,centerY:s}):g.reDraw(!1,!1)}},handleScaleFrame1(){if(u.isScaling){let e=J(u.canvas),a=(u.scaleAreaData.maxX+u.scaleRatio)*u.scale*e+u.scale*e,t=u.scaleAreaData.minX*u.scale*e,r=(u.scaleAreaData.maxY+u.scaleRatio)*u.scale*e+u.scale*e,l=u.scaleAreaData.minY*u.scale*e;g.handleDrawScaleFrame(t-5,l-5,a+5,r+5,!1)}},handleScaleFrame(e=u.canvasBeginPos){if(u.isScaling){let e=J(u.canvas),a=(u.scaleAreaData.maxX+u.scaleRatio)*u.scale*e+u.scale*e,t=u.scaleAreaData.minX*u.scale*e,r=(u.scaleAreaData.maxY+u.scaleRatio)*u.scale*e+u.scale*e,l=u.scaleAreaData.minY*u.scale*e;if(u.scaleAreaData.scaledCoordMap){u.drawShapeData.list=re({maxX:u.scaleAreaData.maxX+u.scaleRatio,maxY:u.scaleAreaData.maxY+u.scaleRatio,minX:u.scaleAreaData.minX,minY:u.scaleAreaData.minY});let e=u.scaleAreaData.minX*u.scale,a=u.scaleAreaData.minY*u.scale,t=(u.scaleAreaData.maxX+u.scaleRatio)*u.scale+u.scale-e,r=(u.scaleAreaData.maxY+u.scaleRatio)*u.scale+u.scale-a;u.ctx1.clearRect(e,a,t,r);let l=g.getRectIntersect(u.drawShapeData.list);g.reDrawPart(l);for(let n=0;n<u.scaleAreaData.scaledCoordMap.length;n++)for(let e=0;e<u.scaleAreaData.scaledCoordMap[n].length;e++){let a=u.scaleAreaData.scaledCoordMap[n][e][0]*u.scale,t=u.scaleAreaData.scaledCoordMap[n][e][1]*u.scale;u.ctx1.fillStyle=u.scaleAreaData.scaledColorMap[n][e][0],u.ctx1.fillRect(a,t,u.scale,u.scale)}}else g.reDraw(!1,!1);g.handleDrawScaleFrame(t-5,l-5,a+5,r+5,!1)}},addDrawList(e,a,t){u.drawList.push([e,a,t])},addRemoveDrawList(e,a,t){u.removeDrawList.push([e,a,t])},addShapeList(e,a){u.drawShapeList.push([e,a])},drawCircle(e,a,t,r,l){let n,o,s,i=me(e,a,t,r),c=[],d=Math.round((i.x0+i.x1)/2),h=Math.round((i.y0+i.y1)/2),u=(i.x0+i.x1)%2,m=(i.y0+i.y1)%2,g=i.x1-d,y=i.y1-h;for(n=i.x0;n<=d;n++)s=Math.acos((n-d)/g),o=Math.round(y*Math.sin(s)+h),c.push([n-u,o]),c.push([n-u,2*h-o-m]),c.push([2*d-n,o]),c.push([2*d-n,2*h-o-m]);for(o=i.y0;o<=h;o++)s=Math.asin((o-h)/y),n=Math.round(g*Math.cos(s)+d),c.push([n,o-m]),c.push([2*d-n-u,o-m]),c.push([n,2*h-o]),c.push([2*d-n-u,2*h-o]);return le(c)},drawCurve(e,a,t,r){const l=[];for(let o=0;o<=r;o++){let n=o/r,s=Math.round(Math.pow(1-n,2)*e.x+2*n*(1-n)*a.x+Math.pow(n,2)*t.x),i=Math.round(Math.pow(1-n,2)*e.y+2*n*(1-n)*a.y+Math.pow(n,2)*t.y);l.push([s,i])}let n=le(l);return n=n.filter((e=>e[0]>=0&&e[1]>=0)),n},drawLine(e,a,t,r){const l=Math.abs(t-e),n=e<t?1:-1,o=-Math.abs(r-a),s=a<r?1:-1;let i,c=l+o,d=!1,h=[];for(;!d;)e>=0&&e<=u.canvasWidth&&a>=0&&a<=u.canvasHeight&&h.push([e,a]),e===t&&a===r?d=!0:(i=2*c,i>o&&(c+=o,e+=n),i<l&&(c+=l,a+=s));return le(h)},drawRect(e,a,t,r){let l=Math.abs(e-t),n=Math.abs(a-r),o=[];if(n<=1)for(let s=0;s<n+1;s++)for(let r=0;r<l+1;r++){let l,n;e>t?(l=e-r,n=a-s,o.push([l,n])):(l=e+r,n=a+s,o.push([l,n]))}else{for(let n=0;n<=l;n++){let l,s,i,c;e>t?(l=e-n,s=a,o.push([l,s]),i=t+n,c=r,o.push([i,c])):(l=e+n,s=a,o.push([l,s]),i=t-n,c=r,o.push([i,c]))}for(let l=0;l<=n;l++){let n,s,i,c;a>r?(n=e,s=a-l,o.push([n,s]),i=t,c=r+l,o.push([i,c])):(n=e,s=a+l,o.push([n,s]),i=t,c=r-l,o.push([i,c]))}}return le(o)},drawFillRect(e,a,t,r){let l=Math.abs(e-t),n=Math.abs(a-r),o=[];if(n<=1)for(let s=0;s<n+1;s++)for(let r=0;r<l+1;r++){let l,n;e>t?(l=e-r,n=a-s,o.push([l,n,u.brushColor])):(l=e+r,n=a+s,o.push([l,n,u.brushColor]))}else{for(let r=0;r<n+1;r++)for(let n=0;n<l+1;n++){let l,s;e>t?(l=e-n,s=a-r,o.push([l,s,u.shapeFillColor])):(l=e+n,s=a+r,o.push([l,s,u.shapeFillColor]))}for(let n=0;n<=l;n++){let l,s,i,c;e>t?(l=e-n,s=a,o.push([l,s,u.brushColor]),i=t+n,c=r,o.push([i,c,u.brushColor])):(l=e+n,s=a,o.push([l,s,u.brushColor]),i=t-n,c=r,o.push([i,c,u.brushColor]))}for(let l=0;l<=n;l++){let n,s,i,c;a>r?(n=e,s=a-l,o.push([n,s,u.brushColor]),i=t,c=r+l,o.push([i,c,u.brushColor])):(n=e,s=a+l,o.push([n,s,u.brushColor]),i=t,c=r-l,o.push([i,c,u.brushColor]))}}return le(o)},handleLayerImg(){let e=1;e=u.canvasWidth>u.canvasHeight?Math.floor(Math.max(1,40/u.canvasWidth)):Math.floor(Math.max(1,40/u.canvasHeight)),u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData;let a=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData,t=0;u.realCanvas.width=u.canvasWidth*e,u.realCanvas.height=u.canvasHeight*e,u.ctx3.clearRect(0,0,u.realCanvas.width,u.realCanvas.height),u.ctx3.globalAlpha=1,M(a)&&t++;let r=Object.keys(a);for(let l=0;l<r.length;l++){u.ctx3.fillStyle=r[l];let t=a[r[l]];for(const[a,r]of t){let a=r,t=a[0]*e,l=a[1]*e;u.ctx3.fillRect(t,l,e,e)}}u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].currentLayerImg=t>0?u.layerGridImage:u.realCanvas.toDataURL("image/png")},handleGridImg(){u.realCanvas.width=40,u.realCanvas.height=40,u.ctx3.globalAlpha=.25,u.ctx3.clearRect(0,0,u.realCanvas.width,u.realCanvas.height);for(let e=0;e<u.realCanvas.height;e++)for(let a=0;a<u.realCanvas.width;a++)u.ctx3.fillStyle=(e+a)%2==0?"rgba(0, 0, 0, 0.5)":"rgba(100, 100, 100, 0.5)",u.ctx3.fillRect(6*a,6*e,6,6);u.layerGridImage=u.realCanvas.toDataURL("image/png")},handleFrameImg(e,a=!0){let t=Math.max(u.canvasWidth,u.canvasHeight),r=Math.ceil(66/t),l=0;const n=u.drawRecord[u.currentFrameIndex].layer;u.realCanvas.width=u.canvasWidth*r,u.realCanvas.height=u.canvasHeight*r,u.ctx3.clearRect(0,0,u.realCanvas.width,u.realCanvas.height),u.ctx3.globalAlpha=1;for(let o=n.length-1;o>=0;o--)if(n[o].isRender){M(n[o].layerNewData)&&l++;let e=Object.keys(n[o].layerNewData);for(let a=0;a<e.length;a++){u.ctx3.fillStyle=e[a];let t=n[o].layerNewData[e[a]];for(const[e,a]of t){let e=a,t=e[0]*r,l=e[1]*r;u.ctx3.fillRect(t,l,r,r)}}}if(l>=n.length)u.drawRecord[u.currentFrameIndex].currentFrameImg="";else{let e=u.realCanvas.toDataURL("image/png");u.drawRecord[u.currentFrameIndex].currentFrameImg=e}g.handleLayerImg(),u.colorStatList=V(u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData),a&&g.handleAddHistory()},handleExportPindouToExcel(e,a){l.handlePindouToExcel(JSON.parse(JSON.stringify(u.pinDouData)),u.pinDouData.colorStatList,s({canvasWidth:u.canvasWidth,canvasHeight:u.canvasHeight,filename:`拼豆 - ${u.projectData.projectName}`},a),(a=>{e(),t.$message.success(a)}),(a=>{e(),t.$message.error(a)}))},handleExportPindou(e,{isShowGrid:a,isShowRulers:t,isShowCirclePoint:r,isShowRectPoint:l,rulersBackgroundColor:n,pointColor:o,rulersColor:s,gridColor:i,isShowTongji:c,isShowBrand:d,brandName:h,background:m}){const y=document.createElement("canvas"),f=y.getContext("2d"),p=document.createElement("canvas");let v=30,D=t?30:0,w=v*u.canvasWidth/8,x=Math.max(Math.floor(w-20),60),C=Math.max(40,x-20);p.width=u.canvasWidth*v+2*D,p.height=u.canvasHeight*v+2*D,y.width=p.width+80,y.height=p.height+40+C;const L=p.getContext("2d");L.imageSmoothingEnabled=!0;const S=u.pinDouData.variables;if(L.fillStyle=m,L.fillRect(D,D,u.canvasWidth*v,u.canvasHeight*v),t){L.fillStyle=n,L.fillRect(0,0,p.width,v),L.fillRect(0,p.height-v,p.width,v),L.fillRect(0,v,v,p.height-60),L.fillRect(p.width-v,v,v,p.height-60),L.font="bold 14px Arial",L.textAlign="center",L.fillStyle=s;for(let e=0;e<u.canvasHeight;e++){let a=D/2,t=v*e+45+5,r=p.width-D/2,l=t;L.fillText((e+1).toString(),a,t),L.fillText((u.canvasHeight-e).toString(),r,l)}for(let e=0;e<u.canvasWidth;e++){let a=v*e+45,t=D/2+5,r=a,l=p.height-D/2;L.fillText((e+1).toString(),a,t),L.fillText((u.canvasWidth-e).toString(),r,l+4)}}let R=new Map;for(let g=S.length-1;g>=0;g--)if(S[g].isRender)for(let e=0;e<u.canvasHeight;e++)for(let a=0;a<u.canvasWidth;a++){let t=S[g].layerData[a+e*u.canvasWidth][2];if(t===u.emptyColor?R.has(`${a}-${e}`)||(L.fillStyle=o,r?(L.beginPath(),L.arc(a*v+D+15,e*v+D+15,3,0,2*Math.PI),L.fill()):l&&L.fillRect(a*v+D+15-3,e*v+D+15-3,6,6)):(R.has(`${a}-${e}`)||R.set(`${a}-${e}`,!0),L.fillStyle=t,L.fillRect(a*v+D,e*v+D,v,v)),S[g].layerData[a+e*u.canvasWidth][3]){let t=a*v+D,r=e*v+D,l=15;L.font=`400 ${l}px Arial`;let n=~~L.measureText(S[g].layerData[a+e*u.canvasWidth][3]).width;l=ne(n,l),L.font=`400 ${l}px Arial`,n=~~L.measureText(S[g].layerData[a+e*u.canvasWidth][3]).width,L.textAlign="start",L.fillStyle=P(S[g].layerData[a+e*u.canvasWidth][2]);const o=t+(v-n)/2,s=r+(v-l)/2+l;L.fillText(S[g].layerData[a+e*u.canvasWidth][3],~~o,~~s)}}if(a){L.strokeStyle=i,L.beginPath();for(let e=0;e<=u.canvasHeight;e++)L.moveTo(0,e*v+D),L.lineTo((u.canvasWidth+2)*v,e*v+D);for(let e=0;e<=u.canvasWidth;e++)L.moveTo(e*v+D,0),L.lineTo(e*v+D,(u.canvasHeight+2)*v);L.stroke()}f.drawImage(p,40,40);const b=document.createElement("canvas"),M=b.getContext("2d");if(d){b.width=p.width,b.height=x+20,y.height=y.height+b.height,M.fillStyle="white",M.fillRect(0,0,b.width,b.height);let e=Math.floor(x/4)+2;M.font=`bold ${e}px PixelFont`,M.fillStyle="black",M.textAlign="center",M.fillText(h,b.width/2,b.height/2+20),f.drawImage(p,40,40),f.drawImage(b,40,p.height+40)}else b.width=p.width,b.height=60,y.height=y.height+b.height,M.fillStyle="white",M.fillRect(0,0,b.width,b.height),f.drawImage(p,40,40),f.drawImage(b,40,p.height+40);const I=document.createElement("canvas"),k=I.getContext("2d");if(c){const e=u.pinDouData.colorStatList;I.width=p.width;let a=8,t=Math.ceil(e.size/a);I.height=t*x*2,k.fillStyle="white",k.fillRect(0,0,I.width,I.height);let r=0,l=Array.from(e);for(let n=0;n<l.length;n++){n%a==0&&(r=0);let e=Math.ceil((n+1)/a);k.fillStyle=l[n][1][0];let t=w*r+D+w/2-(x-10)/2,o=2*x*(e-1)+10,s=t+x/2,i=o+x/2;g.drawRoundedRect(k,t,o,x,x,20);let c=Math.floor(x/4);k.font=`bold ${c}px PixelFont`,k.fillStyle=P(l[n][1][0]),k.textAlign="center",k.fillText(l[n][0],s,i+c/2-2),k.fillStyle="black",k.textAlign="center";let d=t+x/2,h=o+x/2+5+x;k.fillText(l[n][1][1],d,h-8),r++}y.height=y.height+I.height,f.drawImage(p,40,40),f.drawImage(b,40,p.height+40),f.drawImage(I,40,p.height+b.height+40)}f.fillStyle="white",f.fillRect(0,y.height-C,y.width,C),f.fillRect(0,0,y.width,40),f.fillRect(0,40,40,y.height-80),f.fillRect(y.width-40,40,40,y.height-80);let F=Math.floor(x/4);f.font=`normal ${F}px PixelFont`,f.textAlign="center";const T=f.createLinearGradient(0,0,y.width,0);T.addColorStop(0,"#FFD700"),T.addColorStop(.25,"#FFEC8B"),T.addColorStop(.5,"#FFA500"),T.addColorStop(.75,"#FFEC8B"),T.addColorStop(1,"#FFD700"),f.fillStyle=T,f.fillText("By 像素格子",y.width/2,y.height-C/2),oe(y,"拼豆图 - "+u.projectData.projectName),e()},drawRoundedRect(e,a,t,r,l,n){e.beginPath(),e.moveTo(a+n,t),e.lineTo(a+r-n,t),e.quadraticCurveTo(a+r,t,a+r,t+n),e.lineTo(a+r,t+l-n),e.quadraticCurveTo(a+r,t+l,a+r-n,t+l),e.lineTo(a+n,t+l),e.quadraticCurveTo(a,t+l,a,t+l-n),e.lineTo(a,t+n),e.quadraticCurveTo(a,t,a+n,t),e.closePath(),e.fill()},addDrawRecord(e,a=!0){let t=e[0]+e[1]*u.canvasWidth;if(t>=u.canvasWidth*u.canvasHeight)return;let r=e[0]+"/"+e[1],l=e[2],n=ae(l),o=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData,s=o[t][2],i=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData;if("0000"!==n.join("")){let a=n,l=a[0],c=a[1],d=a[2],h=u.layerAlpha/100,m=k([l,c,d,h]);o[t][2]=m,i[s]&&i[s].has(r)&&i[s].delete(r),i[m]?i[m].has(r)||i[m].set(r,[e[0],e[1]]):(i[m]=new Map,i[m].set(r,[e[0],e[1]]))}a&&(u.FrameTimer&&clearTimeout(u.FrameTimer),u.FrameTimer=setTimeout((()=>{g.handleFrameImg(u.ctx1)}),300))},removeDrawRecord(e,a=!0){let t=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData,r=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData,l=e[0]+e[1]*u.canvasWidth,n=r[l][2];if(r[l][2]===u.emptyColor)return;r[l][2]=u.emptyColor;let o=e[0]+"/"+e[1];t[n]&&t[n].has(o)&&t[n].delete(o),a&&g.reDraw()},handlePindouHighlight(e){if(!e.isHighlight)return u.pindouHighlight=null,void g.handleDrawPindou(u.ctx1);u.pindouHighlight=e,g.handleDrawPindou(u.ctx1,u.canvasBeginPos,e)},handlePindouBlockHighlight(e){if(!e)return;g.handleDrawGridLine();let{startCol:a,endCol:t,startRow:r,endRow:l}=e,n=a*u.scale,o=t*u.scale,s=r*u.scale,i=o-n,c=l*u.scale-s;u.pindouHighlightOptions={startCol:a,endCol:t,startRow:r,endRow:l},u.ctx4.save(),u.ctx4.beginPath(),u.ctx4.rect(0,0,u.canvas.width,u.canvas.height),u.ctx4.rect(n,s,i,c),u.ctx4.clip("evenodd"),u.ctx4.fillStyle="rgba(0, 0, 0, 0.7)",u.ctx4.fillRect(0,0,u.canvas.width,u.canvas.height),u.ctx4.restore()},handleDrawPindou(e,a=u.canvasBeginPos,t=u.pindouHighlight){e.clearRect(0,0,u.canvas.width,u.canvas.height);let r=u.pinDouData.variables;e.imageSmoothingEnabled=!0;for(let l=r.length-1;l>=0;l--)if(r[l].isRender)for(let n=0;n<r[l].layerData.length;n++)if(!(r[l].layerData[n][0]>=u.canvasWidth||r[l].layerData[n][1]>=u.canvasHeight||r[l].layerData[n][0]<0||r[l].layerData[n][1]<0)&&r[l].layerData[n][2]!==u.emptyColor){let o=r[l].layerData[n][0]*u.scale+a.x,s=r[l].layerData[n][1]*u.scale+a.y;if(e.fillStyle=r[l].layerData[n][2],e.fillRect(o,s,u.scale,u.scale),r[l].layerData[n][3]&&!t){let a=~~(u.scale/2);e.font=`${a}px Arial sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial Narrow, Times, "Times New Roman"`;let t=~~e.measureText(r[l].layerData[n][3]).width;a=ne(t,a),e.font=`${a}px Arial sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial Narrow, Times, "Times New Roman"`,t=~~e.measureText(r[l].layerData[n][3]).width,e.fillStyle=P(r[l].layerData[n][2]);const i=o+(u.scale-t)/2,c=s+(u.scale-a)/2+a;e.fillText(r[l].layerData[n][3],~~i,~~c)}if(r[l].layerData[n][3]&&t)if(1===t.type){if(r[l].layerData[n][0]===t.selectedObj.col&&r[l].layerData[n][1]===t.selectedObj.row){let a=~~(u.scale/2);e.font=`${a}px Arial sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial Narrow, Times, "Times New Roman"`;let t=~~e.measureText(r[l].layerData[n][3]).width;a=ne(t,a),e.font=`${a}px Arial sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial Narrow, Times, "Times New Roman"`,t=~~e.measureText(r[l].layerData[n][3]).width,e.fillStyle=P(r[l].layerData[n][2]);const i=o+(u.scale-t)/2,c=s+(u.scale-a)/2+a;e.fillText(r[l].layerData[n][3],~~i,~~c)}}else if(2===t.type&&r[l].layerData[n][3]===t.selectedObj.name){let a=~~(u.scale/2);e.font=`${a}px Arial sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial Narrow, Times, "Times New Roman"`;let t=~~e.measureText(r[l].layerData[n][3]).width;a=ne(t,a),e.font=`${a}px Arial sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial Narrow, Times, "Times New Roman"`,t=~~e.measureText(r[l].layerData[n][3]).width,e.fillStyle=P(r[l].layerData[n][2]);const i=o+(u.scale-t)/2,c=s+(u.scale-a)/2+a;e.fillText(r[l].layerData[n][3],~~i,~~c)}}u.loading=!1},reDrawPartV2(e){let a=Object.keys(e);for(let t=0;t<a.length;t++){u.ctx1.fillStyle=a[t];let r=e[a[t]];for(const[e,a]of r){let e=a,t=e[0]*u.scale,r=e[1]*u.scale;u.ctx1.fillRect(t,r,u.scale,u.scale)}}g.reDrawSelectData()},reDrawPart(e){for(let a=0;a<e.length;a++){if(e[a][0]>=u.canvasWidth||e[a][1]>=u.canvasHeight||e[a][0]<0||e[a][1]<0)continue;let t=e[a][0]*u.scale,r=e[a][1]*u.scale;u.ctx1.fillStyle=e[a][2],u.ctx1.fillRect(t,r,u.scale,u.scale)}g.reDrawSelectData()},reDrawV2(e,a=!0,t=!0,r=u.currentLayerIndex,l=!1){let n=u.drawRecord[u.currentFrameIndex].layer;if(l||u.ctx1.translate(0,0),a&&u.ctx1.clearRect(0,0,u.canvas.width,u.canvas.height),"top"===e){for(let o=0;o<r;o++)if(n[o].isRender)for(let e=0;e<n[o].layerData.length;e++)if(!(n[o].layerData[e][0]>=u.canvasWidth||n[o].layerData[e][1]>=u.canvasHeight||n[o].layerData[e][0]<0||n[o].layerData[e][1]<0)&&n[o].layerData[e][2]!==u.emptyColor){let a=n[o].layerData[e][0]*u.scale,t=n[o].layerData[e][1]*u.scale;u.ctx1.fillStyle=n[o].layerData[e][2],u.ctx1.fillRect(a,t,u.scale,u.scale)}}else if("middle"===e){if(n[r].isRender&&t)for(let o=0;o<n[r].layerData.length;o++)if(!(n[r].layerData[o][0]>=u.canvasWidth||n[r].layerData[o][1]>=u.canvasHeight||n[r].layerData[o][0]<0||n[r].layerData[o][1]<0)&&n[r].layerData[o][2]!==u.emptyColor){let e=n[r].layerData[o][0]*u.scale,a=n[r].layerData[o][1]*u.scale;u.ctx1.fillStyle=n[r].layerData[o][2],u.ctx1.fillRect(e,a,u.scale,u.scale)}}else if("bottom"===e)for(let o=n.length-1;o>r;o--)if(n[o].isRender)for(let e=0;e<n[o].layerData.length;e++)if(!(n[o].layerData[e][0]>=u.canvasWidth||n[o].layerData[e][1]>=u.canvasHeight||n[o].layerData[e][0]<0||n[o].layerData[e][1]<0)&&n[o].layerData[e][2]!==u.emptyColor){let a=n[o].layerData[e][0]*u.scale,t=n[o].layerData[e][1]*u.scale;u.ctx1.fillStyle=n[o].layerData[e][2],u.ctx1.fillRect(a,t,u.scale,u.scale)}},reDraw(e=!0,a=!0,t=!0){{u.ctx1.clearRect(0,0,u.canvas.width,u.canvas.height),u.drawRecord.length-1<u.currentFrameIndex&&(u.currentFrameIndex=u.drawRecord.length-1);let e=u.drawRecord[u.currentFrameIndex].layer,a=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerId;const r=performance.now();for(let l=e.length-1;l>=0;l--)if((t||e[l].layerId!==a)&&e[l].isRender){let a=Object.keys(e[l].layerNewData);for(let t=0;t<a.length;t++){u.ctx1.fillStyle=a[t];let r=e[l].layerNewData[a[t]];for(const[e,a]of r){let e=a,t=e[0]*u.scale,r=e[1]*u.scale;u.ctx1.fillRect(t,r,u.scale,u.scale)}}}performance.now();t&&g.reDrawSelectData()}e&&(u.FrameTimer&&clearTimeout(u.FrameTimer),u.FrameTimer=setTimeout((()=>{g.handleFrameImg(u.ctx2,a)}),300))},stop(){if(u.isDrawing){u.isDrawing=!1,u.drawList=le(u.drawList);for(let e=0;e<u.drawList.length;e++)if(g.getCurrentLayerIsLock()){u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData[u.drawList[e][0]+u.drawList[e][1]*u.canvasWidth][2]===u.emptyColor&&g.addDrawRecord([u.drawList[e][0],u.drawList[e][1],u.brushColor],!1)}else g.addDrawRecord([u.drawList[e][0],u.drawList[e][1],u.brushColor],!1);g.handleFrameImg(u.ctx1),u.drawList=[]}if(u.isErasering){u.isErasering=!1,u.removeDrawList=le(u.removeDrawList);for(let e=0;e<u.removeDrawList.length;e++)g.removeDrawRecord([u.removeDrawList[e][0],u.removeDrawList[e][1]],!1);g.handleFrameImg(u.ctx1),u.removeDrawList=[]}if(u.isScale=!1,u.isDragging&&(u.isDragging=!1),u.isMoving&&u.isSelecting,u.isSelecting){if(!u.isMoving)return void(u.isSelecting=!1);u.selectData.isCancelSelect=!1,u.selectData.copyList=[],u.selectData.copySelectMapList=null,u.isSelecting=!1,u.isMoving=!1}if(u.isSelectDraging){u.isSelectDraging=!1;let e=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex];if(e.isRender){let a=Math.min(u.selectData.x,u.selectData.endX),t=Math.max(u.selectData.x,u.selectData.endX),r=Math.min(u.selectData.y,u.selectData.endY),l=Math.max(u.selectData.y,u.selectData.endY);for(let n=0;n<e.layerData.length;n++)if(!(e.layerData[n][0]>=u.canvasWidth||e.layerData[n][1]>=u.canvasHeight||e.layerData[n][0]<0||e.layerData[n][1]<0)&&e.layerData[n][2]!==u.emptyColor){let o=e.layerData[n][0],s=e.layerData[n][1],i=e.layerData[n][2];o>=a&&o<=t&&s>=r&&s<=l&&(u.selectData.selectList.push([o,s,i]),u.selectData.selectMapList[i]||(u.selectData.selectMapList[i]=new Map),u.selectData.selectMapList[i].set(`${o}/${s}`,[o,s]))}g.reDrawSelectData()}g.handleDrawReferenceLine()}g.saveShapeData()},leave(){g.stop(),u.canvas.className=""},reDrawSelectData(e=u.canvasBeginPos){if(u.isScaling)return;if(M(u.selectData.selectMapList))return;u.ctx1.lineWidth=1,u.ctx1.strokeStyle=u.selectActiveColor;let a=Object.keys(u.selectData.selectMapList);for(let t=0;t<a.length;t++){u.ctx1.fillStyle=a[t];let e=u.selectData.selectMapList[a[t]];for(const[a,t]of e){let e=t;if(e[0]>=u.canvasWidth||e[1]>=u.canvasHeight||e[0]<0||e[1]<0)continue;let a=e[0]*u.scale,r=e[1]*u.scale;u.ctx1.fillRect(a,r,u.scale,u.scale),u.ctx1.strokeRect(a+1,r+1,u.scale-2,u.scale-2)}}},saveShapeData(){if(u.isDrawShape&&u.drawShapeList.length){if("circle"===u.currentDrawShape){let e=u.drawShapeList.length,a=u.drawShapeList[0][0],t=u.drawShapeList[0][1],r=u.drawShapeList[e-1][0],l=u.drawShapeList[e-1][1],n=g.drawCircle(a,t,r,l,u.scale);for(let o=0;o<n.length;o++)if(g.getCurrentLayerIsLock()){u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData[n[o][0]+n[o][1]*u.canvasWidth][2]===u.emptyColor&&g.addDrawRecord([n[o][0],n[o][1],u.brushColor],!1)}else g.addDrawRecord([n[o][0],n[o][1],u.brushColor],!1)}else if("rect"===u.currentDrawShape){let e=u.drawShapeList.length,a=u.drawShapeList[0][0],t=u.drawShapeList[0][1],r=u.drawShapeList[e-1][0],l=u.drawShapeList[e-1][1],n=g.drawRect(a,t,r,l);for(let o=0;o<n.length;o++)if(g.getCurrentLayerIsLock()){u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData[n[o][0]+n[o][1]*u.canvasWidth][2]===u.emptyColor&&g.addDrawRecord([n[o][0],n[o][1],u.brushColor],!1)}else g.addDrawRecord([n[o][0],n[o][1],u.brushColor],!1)}else if("fillRect"===u.currentDrawShape){let e=u.drawShapeList.length,a=u.drawShapeList[0][0],t=u.drawShapeList[0][1],r=u.drawShapeList[e-1][0],l=u.drawShapeList[e-1][1],n=g.drawFillRect(a,t,r,l);for(let o=0;o<n.length;o++)if(g.getCurrentLayerIsLock()){u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData[n[o][0]+n[o][1]*u.canvasWidth][2]===u.emptyColor&&g.addDrawRecord([n[o][0],n[o][1],u.brushColor],!1)}else g.addDrawRecord([n[o][0],n[o][1],u.brushColor],!1)}else if("line"===u.currentDrawShape){let e=u.drawShapeList.length,a=u.drawShapeList[0][0],t=u.drawShapeList[0][1],r=u.drawShapeList[e-1][0],l=u.drawShapeList[e-1][1],n=g.drawLine(a,t,r,l);for(let o=0;o<n.length;o++)if(g.getCurrentLayerIsLock()){u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData[n[o][0]+n[o][1]*u.canvasWidth][2]===u.emptyColor&&g.addDrawRecord([n[o][0],n[o][1],u.brushColor],!1)}else g.addDrawRecord([n[o][0],n[o][1],u.brushColor],!1)}else if("curve"===u.currentDrawShape){let e=u.drawShapeList[0][0],a=u.drawShapeList[0][1],t=u.curveEndPos[0],r=u.curveEndPos[1],l=[],n=0,o=0,s=0;if(e===t&&a===r)return;if(e===t&&["3","4"].includes(u.curveType.pressKey)?(o=Math.round(Math.min(a,r)+Math.abs(r-a)/2),"3"===u.curveType.pressKey?n=Math.round(e-u.curvature)<=0?0:Math.round(e-u.curvature):"4"===u.curveType.pressKey&&(n=Math.round(e+u.curvature)>=u.canvasWidth?u.canvasWidth:Math.round(e+u.curvature)),s=Math.abs(r-a)):a===r&&["1","2"].includes(u.curveType.pressKey)&&(n=Math.round(Math.abs(t-e)/2+Math.min(e,t)),"1"===u.curveType.pressKey?o=Math.round(a-u.curvature)<=0?0:Math.round(a-u.curvature):"2"===u.curveType.pressKey&&(o=Math.round(a+u.curvature)>=u.canvasHeight?u.canvasHeight:Math.round(a+u.curvature)),s=Math.abs(t-e)),0===n&&0===o)return;l=g.drawCurve({x:e,y:a},{x:n,y:o},{x:t,y:r},20+s);for(let i=0;i<l.length;i++)g.addDrawRecord([l[i][0],l[i][1],u.brushColor],!1)}g.reDraw(),u.drawShapeList=[],u.curveEndPos=[],u.curveType.pressKey="0",u.isDrawShape=!1,u.drawShapeData={list:[],maxX:0,maxY:0,minX:-1,minY:-1}}else u.isDrawShape=!1},addCursorClass(e=null){0===u.currentTool?u.canvas.classList.add("brush-cursor"):1===u.currentTool?u.canvas.classList.add("eraser-cursor"):2===u.currentTool?u.canvas.classList.add("straw-cursor"):3===u.currentTool?-1!==u.currentDrawShape.toLowerCase().indexOf("rect")?u.canvas.classList.add("rect-cursor"):"line"===u.currentDrawShape||"curve"===u.currentDrawShape?u.canvas.classList.add("brush-cursor"):-1!==u.currentDrawShape.toLowerCase().indexOf("circle")&&u.canvas.classList.add("circle-cursor"):4===u.currentTool?u.canvas.classList.add("bucket-cursor"):5===u.currentTool&&u.pinDouMode?u.canvas.classList.add("pindou-cursor"):7===u.currentTool?u.canvas.classList.add("move-cursor"):8===u.currentTool?u.canvas.classList.add("select-cursor"):9===u.currentTool&&g.handleChangeMouseStyle(e)},exportPng(){const e=document.createElement("a");e.download="image.png",e.href=u.canvas.toDataURL("image/png"),e.click()},computeScale(e=!0){const a=document.querySelector(".pixelBox");u.baseCanvas.width=null==a?void 0:a.clientWidth,u.baseCanvas.height=null==a?void 0:a.clientHeight;let r=null==a?void 0:a.clientHeight,l=Math.floor(r)/Math.max(u.canvasWidth-u.pindouScaleValue,u.canvasHeight-u.pindouScaleValue),n=G(Math.floor(l))?Math.floor(l):Math.floor(l)-1;u.scale=Math.max(n,15),u.pinDouMode&&(u.scale=Math.max(u.scale,30)),u.canvas.width=(Number(u.canvasWidth)+u.pindouScaleValue)*u.scale,u.canvas.height=(Number(u.canvasHeight)+u.pindouScaleValue)*u.scale,u.bgCanvas.width=(Number(u.canvasWidth)+u.pindouScaleValue)*u.scale,u.bgCanvas.height=(Number(u.canvasHeight)+u.pindouScaleValue)*u.scale,u.gridCanvas.width=(Number(u.canvasWidth)+u.pindouScaleValue)*u.scale,u.gridCanvas.height=(Number(u.canvasHeight)+u.pindouScaleValue)*u.scale,u.moveCanvas.width=u.canvas.width,u.moveCanvas.height=u.canvas.height,"undefined"!=typeof OffscreenCanvas?u.worker.postMessage({type:0,canvasWidth:u.canvas.width,canvasHeight:u.canvas.height}):t.$message.warning("当前浏览器版本过低，将影响部分功能的使用"),e&&g.setCanvasCenter()},handleAddLayer(){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(u.isScaling&&g.handleCancelScale(),u.drawRecord[u.currentFrameIndex].layer.length>u.maxLayer)return t.$message.warning("图层数量达到上限");let e=JSON.parse(JSON.stringify(u.emptyLayerData)),a=u.historyLayerNameIndex[u.historyLayerNameIndex.length-1]+1,r={layerId:K.v4(),layerName:`图层${a+1}`,alpha:100,isLock:!1,currentLayerImg:u.layerGridImage,isRender:!0,layerData:e,layerNewData:{}};u.historyLayerNameIndex.push(a),u.drawRecord[u.currentFrameIndex].layer.unshift(r),g.handleChangeLayer(0),g.handleAddHistory()},handleLayerMerge(){if(u.isScaling&&g.handleCancelScale(),!M(u.selectData.selectMapList))return t.$message.warning("请先取消选中区域");if(u.selectLayerList.length>1){u.selectLayerList.sort(((e,a)=>a-e));let e=u.drawRecord[u.currentFrameIndex].layer[u.selectLayerList[0]];for(let t=1;t<u.selectLayerList.length;t++){let a=u.drawRecord[u.currentFrameIndex].layer[u.selectLayerList[t]].layerData;for(let t=0;t<a.length;t++)a[t][2]!==u.emptyColor&&(e.layerData[t][2]=a[t][2]);u.drawRecord[u.currentFrameIndex].layer.splice(u.selectLayerList[t],1)}let a=u.drawRecord[u.currentFrameIndex].layer.findIndex((a=>a.layerId===e.layerId));g.handleChangeLayer(a),g.handleCurrentLayerDataToLayerMapData((()=>{g.reDraw()}))}},handleChangeLayer(e){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");u.isScaling&&e!==u.currentLayerIndex&&g.handleCancelScale(),u.isShift?u.selectLayerList.includes(e)||u.selectLayerList.push(e):g.handleSaveMoveData(!0,(()=>{u.currentLayerIndex=e,u.currentLayerId=g.getCurrentLayerId(),u.historyLayerIndexRecord.push(u.currentLayerId),u.layerAlpha=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].alpha||100,u.selectLayerList=[u.currentLayerIndex]}))},handleChangeLayerVisible(e){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(u.isScaling&&g.handleCancelScale(),e<0){for(let e=0;e<u.drawRecord[u.currentFrameIndex].layer.length;e++)u.drawRecord[u.currentFrameIndex].layer[e].isRender=!u.currentFrameLayerVisible;return u.currentFrameLayerVisible=!u.currentFrameLayerVisible,void g.reDraw()}let a=u.drawRecord[u.currentFrameIndex].layer[e].isRender;if(u.drawRecord[u.currentFrameIndex].layer[e].isRender=!a,!M(u.selectData.selectMapList))return g.handleCancelSelect();g.reDraw(!0,!1)},handleLockLayer(e,a){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");u.drawRecord[u.currentFrameIndex].layer[e].isLock=a},handleDeleteLayer(e){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(u.isScaling&&g.handleCancelScale(),u.currentLayerIndex!==e&&!M(u.selectData.selectMapList))return t.$message.warning("请先取消选中区域");u.currentLayerIndex===e&&u.selectData.selectLayerId===u.currentLayerId&&g.handleCancelSelect(),u.drawRecord[u.currentFrameIndex].layer.splice(e,1);let a=u.drawRecord[u.currentFrameIndex].layer.findIndex((e=>u.historyLayerIndexRecord[u.historyLayerIndexRecord.length-1]===e.layerId));a<0&&(a=0),u.currentLayerIndex=a,u.layerAlpha=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].alpha||100,u.currentLayerId=g.getCurrentLayerId(),u.selectLayerList=[u.currentLayerIndex],g.reDraw()},handleCopyLayer(e){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");u.isScaling&&g.handleCancelScale();let a=ee(u.drawRecord[u.currentFrameIndex].layer[e]);u.drawRecord[u.currentFrameIndex].layer.length,a.layerId=K.v4(),a.layerName=`${a.layerName} Copy`,u.drawRecord[u.currentFrameIndex].layer.splice(e,0,a),g.handleChangeLayer(e),g.handleAddHistory()},handleDoubleClickLayer(e,a){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");u.currentEditLayer.index=e,u.currentEditLayer.name=a},handleEditLayerName(){if(""===u.currentEditLayer.name.trim())return t.$message.warning("请填写图层名称");u.drawRecord[u.currentFrameIndex].layer[u.currentEditLayer.index].layerName=u.currentEditLayer.name,u.currentEditLayer={index:-1,name:""},g.handleAddHistory()},handleExportLayer(e=u.currentFrameIndex,a=u.currentLayerIndex,t=!0,r=1,l=u.exportStyleOptions,n="pic"){let{isShowGrid:o}=l;const s=u.drawRecord[e].layer[a].layerData;if(o)return void g.handleExportGridFrame(s,"layer",l);u.realCanvas.width=u.canvasWidth*r,u.realCanvas.height=u.canvasHeight*r,u.ctx3.clearRect(0,0,u.realCanvas.width,u.realCanvas.height),u.ctx3.globalAlpha=1;let i=Object.keys(u.drawRecord[e].layer[a].layerNewData);for(let c=0;c<i.length;c++){let t=u.drawRecord[e].layer[a].layerNewData[i[c]],l=i[c];"gif"===n&&"#000000ff"===l&&(l="#010101ff"),u.ctx3.fillStyle=l;for(const[e,a]of t){let e=a[0],t=a[1];u.ctx3.fillRect(e*r,t*r,r,r)}}t&&oe(u.realCanvas,`layer${a+1}`)},handleImportDragImage(e){if(!t.$congif.supportUploadImageType.includes(e.type))return t.$message.warning("导入文件格式不正确");"application"===e.type.split("/")[0]?g.handleImportImageLayer(e,"1"):g.handleImportImageLayer(e,"0")},handleImportImageLayer(e,a,r=1){if(M(u.selectData.selectMapList)||g.handleCancelSelect(),u.isScaling&&g.handleCancelScale(),"0"===a){u.loading=!0;const a=new Image,t=e;a.src=t,a.onload=function(){let e=Math.floor(a.width/r),l=Math.floor(a.height/r);e>u.canvasWidth||l>u.canvasHeight?g.handleTransfromPngToPixel(a,t,u.currentLayerIndex,!0):a.width<=u.canvasWidth&&a.height<=u.canvasHeight?g.handleTransfromPngToPixel(a,t,u.currentLayerIndex):g.handleTransformPngToPixel2(a,t,u.currentLayerIndex,r)}}else u.loading=!0,l.handleExcelToPixel(e,(e=>{if(!e.length)return;let a=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData;for(let t=0;t<e.length;t++)if(e[t][2]!==u.emptyColor){a[e[t][0]+e[t][1]*u.canvasWidth][2]=e[t][2]}g.handleCurrentLayerDataToLayerMapData((()=>{g.reDraw(),u.loading=!1}))}),(e=>{u.loading=!1,t.$message.error(e)}),{canvasWidth:u.canvasWidth,canvasHeight:u.canvasHeight})},handleImportLayer(e=u.currentLayerIndex){M(u.selectData.selectMapList)||g.handleCancelSelect(),u.isScaling&&g.handleCancelScale();const a=document.createElement("input");a.type="file",a.accept="image/png,image/jpg",a.addEventListener("change",(function(){const t=a.files[0];if(t){u.loading=!0;const a=new Image,r=URL.createObjectURL(t);a.src=r,a.onload=function(){a.width>u.canvasWidth||a.height>u.canvasHeight?g.handleTransfromPngToPixel(a,r,e,!0):g.handleTransfromPngToPixel(a,r,e)}}})),document.body.appendChild(a),a.click(),document.body.removeChild(a)},handleTransfromPngToPixel(e,a,t,r=!1){const l=document.createElement("canvas");l.width=u.canvasWidth,l.height=u.canvasHeight;const n=l.getContext("2d");if(r)return void h.resize(e,l,{unsharpAmount:100,unsharpRadius:.5,unsharpThreshold:6}).then((e=>{const r=n.getImageData(0,0,l.width,l.height);u.worker.postMessage({type:2,variables:r.data,currentLayerData:JSON.parse(JSON.stringify(u.drawRecord[u.currentFrameIndex].layer[t].layerData))}),u.worker.onmessage=e=>{URL.revokeObjectURL(a),u.drawRecord[u.currentFrameIndex].layer[t].layerData=e.data.layerData,u.drawRecord[u.currentFrameIndex].layer[t].layerNewData=e.data.layerNewData,u.loading=!1,g.reDraw()}})).catch((e=>{}));n.drawImage(e,0,0);const o=n.getImageData(0,0,l.width,l.height);u.worker.postMessage({type:2,variables:o.data,currentLayerData:JSON.parse(JSON.stringify(u.drawRecord[u.currentFrameIndex].layer[t].layerData))}),u.worker.onmessage=e=>{URL.revokeObjectURL(a),u.drawRecord[u.currentFrameIndex].layer[t].layerData=e.data.layerData,u.drawRecord[u.currentFrameIndex].layer[t].layerNewData=e.data.layerNewData,u.loading=!1,g.reDraw()}},handleTransformPngToPixel2(e,a,t,r=1){let l=Math.floor(e.width/r),n=Math.floor(e.height/r);const o=document.createElement("canvas");o.width=e.width,o.height=e.height;const s=o.getContext("2d");s.drawImage(e,0,0);const i=s.getImageData(0,0,o.width,o.height).data;u.worker.postMessage({type:11,variables:i,pxSize:r,options:{width:l,height:n,canvasWidth:u.canvasWidth,canvasHeight:u.canvasHeight,imageWidth:e.width,imageHeight:e.height},currentLayerData:JSON.parse(JSON.stringify(u.drawRecord[u.currentFrameIndex].layer[t].layerData))}),u.worker.onmessage=e=>{URL.revokeObjectURL(a),u.drawRecord[u.currentFrameIndex].layer[t].layerData=e.data.layerData,u.drawRecord[u.currentFrameIndex].layer[t].layerNewData=e.data.layerNewData,u.loading=!1,g.reDraw()}},handleChangeLayerAlpha(){u.loading=!0;let e=X(u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex]),a=i(s({},e),{layerNewData:V(e.layerNewData)});u.worker.postMessage({type:5,variables:a,targetAlpha:u.layerAlpha}),u.worker.onmessage=e=>{u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData=e.data.layerData,u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData=e.data.layerNewData,u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].alpha=u.layerAlpha,u.loading=!1,g.reDraw()}},handleCopyLayerData(){var e;o.layerCopyData=ee(null==(e=u.LayerMenu.contextData)?void 0:e.layerData),t.$message.success("复制成功")},handlePasteLayerData(){if(!o.layerCopyData)return t.$message.warning("数据不存在");let e=o.layerCopyData;u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerData=JSON.parse(JSON.stringify(e.layerData)),u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData=ee(e.layerNewData),t.$message.success("粘贴成功"),g.reDraw(!0,!0)},handleAddFrame(){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(u.drawRecord.length>=u.maxFrame)return t.$message.warning("帧数量达到上限");if(!M(u.selectData.selectMapList))return t.$message.warning("请先取消选中区域");u.isScaling&&g.handleCancelScale();let e=JSON.parse(JSON.stringify(u.emptyLayerData)),a={frameId:K.v1(),currentFrameImg:null,layer:[{layerId:K.v4(),layerName:"图层1",alpha:100,isLock:!1,currentLayerImg:u.layerGridImage,isRender:!0,layerData:e,layerNewData:{}}]};u.drawRecord.push(a),g.handleChangeFrame(u.drawRecord.length-1)},handleChangeFrame:e=>u.pinDouMode?t.$message.warning("请先退出拼豆预览模式"):u.selectData.selectList.length&&e!==u.currentFrameIndex?t.$message.warning("请先取消选中区域"):(u.isScaling&&e!==u.currentFrameIndex&&g.handleCancelScale(),void(7===u.currentTool?g.handleSaveMoveData(!1,(()=>{setTimeout((()=>{u.currentTool=0,u.currentFrameIndex=e,u.currentFrameId=g.getCurrentFrameId(),u.historyFrameIndexRecord.push(u.currentFrameId),g.handleChangeLayer(0),g.reDraw(!0,!1)}),500)})):(u.currentFrameIndex=e,u.currentFrameId=g.getCurrentFrameId(),u.historyFrameIndexRecord.push(u.currentFrameId),g.handleChangeLayer(0),g.reDraw(!0,!1)))),handleCopyFrame(e,a="copy"){if("copyData"===a)o.frameCopyData=ee(u.drawRecord[e]),t.$message.success("复制成功");else if("pasteData"===a){if(!o.frameCopyData)return t.$message.warning("数据不存在");let a=o.frameCopyData;if(a.frameId===u.drawRecord[e].frameId)u.drawRecord[e]=ee(a);else{u.drawRecord[e].currentFrameImg=a.currentFrameImg,u.drawRecord[e].layer=ee(a.layer);for(let a=0;a<u.drawRecord[e].layer.length;a++)u.drawRecord[e].layer[a].layerId=K.v4()}t.$message.success("粘贴成功"),e===u.currentFrameIndex&&g.reDraw(!0,!0)}else if("copy"===a){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(!M(u.selectData.selectMapList))return t.$message.warning("请先取消选中区域");if(u.isScaling&&g.handleCancelScale(),u.drawRecord.length>=u.maxFrame)return t.$message.warning("帧数量达到上限");let a=ee(u.drawRecord[e]);a.frameId=K.v1();for(let e=0;e<a.layer.length;e++)a.layer[e].layerId=K.v4();u.drawRecord.splice(e,0,a),g.handleChangeFrame(e+1),g.handleAddHistory()}},handleDeleteFrame(e){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");u.selectData.selectList.length&&e===u.currentFrameIndex&&g.handleCancelSelect(),u.isScaling&&e===u.currentFrameIndex&&g.handleCancelScale(),u.drawRecord.splice(e,1);let a=u.drawRecord.findIndex((e=>u.historyFrameIndexRecord[u.historyFrameIndexRecord.length-1]===e.frameId));a<0&&(a=0),g.handleChangeFrame(a),g.handleAddHistory()},handleExportGridFrame(e,a,t=u.exportStyleOptions){let{gridBackgroundColor:r,gridColor:l}=t,n=t.gridSize;u.realCanvas.width=u.canvasWidth*n,u.realCanvas.height=u.canvasHeight*n,u.ctx3.clearRect(0,0,u.realCanvas.width,u.realCanvas.height),r!==u.emptyColor&&(u.ctx3.fillStyle=r,u.ctx3.fillRect(0,0,u.realCanvas.width,u.realCanvas.height));const o=n;u.ctx3.strokeStyle=l,u.ctx3.globalAlpha=1,u.ctx3.lineWidth=1;for(let s=0;s<=u.canvasHeight;s++)u.ctx3.beginPath(),u.ctx3.moveTo(0,s*o),u.ctx3.lineTo(u.canvasWidth*o,s*o),u.ctx3.stroke();for(let s=0;s<=u.canvasWidth;s++)u.ctx3.beginPath(),u.ctx3.moveTo(s*o,0),u.ctx3.lineTo(s*o,u.canvasHeight*o),u.ctx3.stroke();if("frame"===a){for(let s=e.length-1;s>=0;s--)if(e[s].isRender){let a=Object.keys(e[s].layerNewData);for(let t=0;t<a.length;t++){let r=e[s].layerNewData[a[t]],l=a[t];u.ctx3.fillStyle=l;for(const[e,a]of r){let e=a[0],t=a[1];u.ctx3.fillRect(e*o+1,t*o+1,o-2,o-2)}}}}else{let e=Object.keys(u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData);for(let a=0;a<e.length;a++){let t=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData[e[a]],r=e[a];u.ctx3.fillStyle=r;for(const[e,a]of t){let e=a[0],t=a[1];u.ctx3.fillRect(e*o+1,t*o+1,o-2,o-2)}}}},handleExportFrame(e,a=!0,t=1,r=u.exportStyleOptions,l="pic"){let{isShowGrid:n}=r;u.ctx3.globalAlpha=1;const o=u.drawRecord[e].layer;if(n)g.handleExportGridFrame(o,"frame",r);else{u.realCanvas.width=u.canvasWidth*t,u.realCanvas.height=u.canvasHeight*t,u.ctx3.clearRect(0,0,u.realCanvas.width,u.realCanvas.height);for(let e=o.length-1;e>=0;e--)if(o[e].isRender){let a=Object.keys(o[e].layerNewData);for(let r=0;r<a.length;r++){let n=o[e].layerNewData[a[r]],s=a[r];"gif"===l&&"#000000ff"===s&&(s="#010101ff"),u.ctx3.fillStyle=s;for(const[e,a]of n){let e=a[0],r=a[1];u.ctx3.fillRect(e*t,r*t,t,t)}}}a&&oe(u.realCanvas,`frame${e+1}`)}},handleExportFrameForBlock(e,a=!0,t=1,r=u.exportStyleOptions,l=.26){u.ctx3.globalAlpha=1;const n=u.drawRecord[e].layer,o=(t=28*l)/5;u.realCanvas.width=u.canvasWidth*t,u.realCanvas.height=u.canvasHeight*t,u.ctx3.clearRect(0,0,u.realCanvas.width,u.realCanvas.height);for(let s=n.length-1;s>=0;s--)if(n[s].isRender){let e=Object.keys(n[s].layerNewData);for(let a=0;a<e.length;a++){let r=n[s].layerNewData[e[a]],l=e[a];u.ctx3.fillStyle=l;for(const[e,a]of r){let e=a[0],r=a[1];u.ctx3.fillRect(e*t,r*t,t,t),u.ctx3.shadowColor="rgba(0, 0, 0, 0.8)",u.ctx3.shadowBlur=2,u.ctx3.shadowOffsetX=1,u.ctx3.shadowOffsetY=1,u.ctx3.beginPath(),u.ctx3.arc(e*t+t/2,r*t+t/2,o,0,2*Math.PI,!1),u.ctx3.closePath(),u.ctx3.fill()}}}a&&oe(u.realCanvas,`积木图${e+1}`)},handleExportFrameForPindou(e,a=!0,t=1,r=u.exportStyleOptions,l=.26){u.ctx3.globalAlpha=1;const n=u.drawRecord[e].layer,o=t=28*l,s=t/5;u.realCanvas.width=u.canvasWidth*t,u.realCanvas.height=u.canvasHeight*t,u.ctx3.clearRect(0,0,u.realCanvas.width,u.realCanvas.height),u.ctx3.shadowColor="rgba(0, 0, 0, 0.5)",u.ctx3.shadowBlur=2,u.ctx3.shadowOffsetX=1,u.ctx3.shadowOffsetY=1;for(let i=n.length-1;i>=0;i--)if(n[i].isRender){let e=Object.keys(n[i].layerNewData);for(let a=0;a<e.length;a++){let r=n[i].layerNewData[e[a]],l=e[a];for(const[e,a]of r){let e=a[0],r=a[1];u.ctx3.fillStyle=l,u.ctx3.beginPath(),u.ctx3.arc(e*t+o/2,r*t+o/2,o/2,0,2*Math.PI,!1),u.ctx3.closePath(),u.ctx3.fill(),u.ctx3.shadowColor="rgba(80, 80, 80, 0.5)",u.ctx3.shadowBlur=2,u.ctx3.shadowOffsetX=1,u.ctx3.shadowOffsetY=1,u.ctx3.fillStyle="rgba(0, 0, 0, 1)",u.ctx3.beginPath(),u.ctx3.arc(e*t+o/2,r*t+o/2,s,0,2*Math.PI,!1),u.ctx3.closePath(),u.ctx3.fill()}}}a&&oe(u.realCanvas,`拼豆图${e+1}`)},compressDrawRecordData(){let e=JSON.parse(JSON.stringify(u.drawRecord));for(let a=0;a<e.length;a++)for(let t=0;t<e[a].layer.length;t++){delete e[a].layer[t].layerNewData;for(let r=0;r<e[a].layer[t].layerData.length;r++){let l=e[a].layer[t].layerData[r][2];l===u.emptyColor?e[a].layer[t].layerData[r]=0:e[a].layer[t].layerData[r]=l}}return e},handleExportProject(e){u.exportLoaidng=!0;let a=i(s({},u.projectData),{width:u.canvasWidth,height:u.canvasHeight,data:null});a.data=g.compressDrawRecordData(),a.frameImg="@";const r=JSON.stringify(a),l=new Blob([r],{type:""});F.saveAs(l,`${e}.json`),t.$message.success("导出成功"),u.exportLoaidng=!1},handleImportProject(){const e=document.createElement("input");e.type="file",e.accept="application/json",e.addEventListener("change",(function(){const a=e.files[0];if(a){u.loading=!0;const e=new FileReader;e.onload=function(e){const a=JSON.parse(e.target.result);u.worker.postMessage({type:4,variables:a.data}),u.projectData.projectId=a.projectId,u.projectData.projectName=a.projectName,u.projectData.updateAt=a.updateAt,u.projectData.createAt=a.createAt,u.projectData.desc=a.desc,u.projectData.frameImg=a.frameImg,u.canvasWidth=a.width,u.canvasHeight=a.height,u.historyRecord=[],g.computeScale(),u.canvasBeginPos.x=u.bgCanvas.width/2-u.canvasWidth*u.scale/2,u.canvasBeginPos.y=u.bgCanvas.height/2-u.canvasHeight*u.scale/2,g.drawPixelArea(),u.worker.onmessage=e=>{u.drawRecord=e.data,g.reDraw(),u.loading=!1}},e.readAsText(a)}})),document.body.appendChild(e),e.click(),document.body.removeChild(e)},async handleExport(e,a,r=1,n=!1,i=u.exportStyleOptions,c=2,d=.26){if((![5,6].includes(e)||!o.checkVipFunction("gifExport"))&&(![7].includes(e)||!o.checkVipFunction("excelExport"))&&(u.previewLoading||!o.checkVipFunction("beitu",r)))if(n||(u.exportLoaidng=!0),u.isExportProject)g.handleExportProject(a);else{if(1===e){const e=document.createElement("canvas");e.width=u.canvasWidth*r*u.drawRecord.length,e.height=u.canvasHeight*r;const t=e.getContext("2d");u.realCanvas.width=u.canvasWidth*r,u.realCanvas.height=u.canvasHeight*r;for(let a=0;a<u.drawRecord.length;a++)g.handleExportFrame(a,!1,r),t.drawImage(u.realCanvas,a*u.canvasWidth*r,0);if(n)return e.toDataURL("image/png");oe(e,a)}else if(2===e){let e=0,t=[],l=[];for(let a=0;a<u.drawRecord.length;a++){t[a]=[];let l=u.drawRecord[a].layer.length;e<l&&(e=l);let n=0;for(let e=l-1;e>=0;e--)g.handleExportLayer(a,e,!1,r),t[a][n]=u.ctx3.getImageData(0,0,u.canvasWidth*r,u.canvasHeight*r),n++}for(let a=0;a<e;a++){const e=document.createElement("canvas");e.width=u.canvasWidth*r*u.drawRecord.length,e.height=u.canvasHeight*r;const n=e.getContext("2d");for(let l=0;l<t.length;l++)if(t[l][a]){let e=document.createElement("canvas");e.width=u.canvasWidth*r,e.height=u.canvasHeight*r,e.getContext("2d").putImageData(t[l][a],0,0),n.drawImage(e,l*u.canvasWidth*r,0)}else;l.push(e.toDataURL("image/png"))}se(`${a}`,l)}else if(3===e){let e=[];for(let a=0;a<u.drawRecord.length;a++)g.handleExportFrame(a,!1,r,i),e.push(u.realCanvas.toDataURL("image/png"));1===e.length?ie(e[0],a):se(`${a}`,e)}else if(4===e){let e=[];for(let a=0;a<u.drawRecord.length;a++){for(let t=u.drawRecord[a].layer.length-1;t>=0;t--)u.drawRecord[a].layer[t].isRender&&(g.handleExportLayer(a,t,!1,r,i),e.push(u.realCanvas.toDataURL("image/png")))}1===e.length?ie(e[0],a):se(`${a}`,e)}else if(5===e){let e=[],t=new GIF({width:u.canvasWidth*r,height:u.canvasHeight*r,workerScript:"/gif-js/distt/gif.worker.js",workers:2,quality:10,transparent:0});for(let a=0;a<u.drawRecord.length;a++)g.handleExportFrame(a,!1,r,u.exportStyleOptions,"gif"),e.push(u.realCanvas.toDataURL("image/png"));let l=[];for(let a=0;a<e.length;a++){const t=document.createElement("img");t.src=e[a],t.width=u.canvasWidth*r,t.height=u.canvasHeight*r;let n=new Promise(((e,a)=>{t.onload=function(){e(t)}}));l.push(n)}let n=0;await Promise.all(l).then((async()=>{for(let e=0;e<l.length;e++){let a=await l[e];t.addFrame(a,{delay:100*c}),n++}n>=l.length&&t.render()})),t.on("finished",(function(e){ce(a,URL.createObjectURL(e)),t.abort()}))}else if(6===e){let e=0,t=[],l=[];const n=e=>new Promise(((a,t)=>{de(e).then((e=>{a(e)}))}));for(let a=0;a<u.drawRecord.length;a++){t[a]=[];let l=u.drawRecord[a].layer.length;e<l&&(e=l);let n=0;for(let e=l-1;e>=0;e--)g.handleExportLayer(a,e,!1,r,u.exportStyleOptions,"gif"),t[a][n]=u.ctx3.getImageData(0,0,u.canvasWidth*r,u.canvasHeight*r),n++}for(let a=0;a<e;a++){let e=new GIF({width:u.canvasWidth*r,height:u.canvasHeight*r,workerScript:"/gif-js/distt/gif.worker.js",workers:2,quality:10,transparent:0});for(let l=0;l<t.length;l++)if(t[l][a]){let n=document.createElement("canvas");n.width=u.canvasWidth*r,n.height=u.canvasHeight*r,n.getContext("2d").putImageData(t[l][a],0,0),e.addFrame(n,{delay:100*c})}else;const o=await new Promise((a=>{e.on("finished",(function(t){a(t),e.abort()})),e.render()}));let s=await n(o);l.push(s)}await Promise.all(l).then((()=>{se(`${a}`,l,"gif")}))}else if(7===e)l.handlePixelToExcel(JSON.parse(JSON.stringify(u.drawRecord)),s({canvasWidth:u.canvasWidth,canvasHeight:u.canvasHeight,filename:a},i),(e=>{t.$message.success(e)}),(e=>{t.$message.error(e)}));else if(8===e){let e=[];for(let a=0;a<u.drawRecord.length;a++)g.handleExportFrameForPindou(a,!1,1,i,d),e.push(u.realCanvas.toDataURL("image/png"));1===e.length?ie(e[0],a):se(`${a}`,e)}else if(9===e){let e=[];for(let a=0;a<u.drawRecord.length;a++)g.handleExportFrameForBlock(a,!1,1,i,d),e.push(u.realCanvas.toDataURL("image/png"));1===e.length?ie(e[0],a):se(`${a}`,e)}u.exportLoaidng=!1}},handleAddHistory(){for(u.historyRecord.length>=u.historyMaxLength&&u.historyRecord.shift();u.currentHistoryIndex<u.historyRecord.length-1;)u.historyRecord.pop();u.historyRecord.push({hid:K.v1(),record:ee(u.drawRecord)}),u.isSaveProject=!1,u.currentHistoryIndex=u.historyRecord.length-1,u.currentHistoryIndex<0&&(u.currentHistoryIndex=0)},handleRevoke(){if(u.historyRecord.length){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(!M(u.selectData.selectMapList))return t.$message.warning("请先取消选中区域");u.isScaling&&g.handleCancelScale(),u.currentHistoryIndex=u.currentHistoryIndex-1,u.currentHistoryIndex<0&&t.$message.warning("暂无更多记录"),u.currentHistoryIndex<=0&&(u.currentHistoryIndex=0),u.drawRecord=ee(u.historyRecord[u.currentHistoryIndex].record),g.reDraw(!0,!1)}},handleRecover(){if(u.historyRecord.length){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(!M(u.selectData.selectMapList))return t.$message.warning("请先取消选中区域");u.isScaling&&g.handleCancelScale(),u.currentHistoryIndex=u.currentHistoryIndex+1,u.currentHistoryIndex>u.historyRecord.length-1&&t.$message.warning("暂无更多记录"),u.currentHistoryIndex>=u.historyRecord.length-1&&(u.currentHistoryIndex=u.historyRecord.length-1),u.drawRecord=ee(u.historyRecord[u.currentHistoryIndex].record),g.reDraw(!0,!1)}},handleOpenMyColorDialog(){t.$refs.MyColorDialog.handleOpen(),g.handleCancelKeyboardEvent()},handleOpenReplaceColorDialog(){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");u.isScaling&&g.handleCancelScale(),t.$refs.ReplaceColorDialog.handleOpen(),g.handleCancelKeyboardEvent()},async handleOpenPreviewDialog(){if(u.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");u.previewLoading=!0;let e=Math.floor(512/Math.max(u.canvasHeight,u.canvasWidth));const a=await g.handleExport(1,"",e,!0);t.$refs.PreviewAnimDialog.handleOpen({imgUrl:a,width:u.canvasWidth*e,height:u.canvasHeight*e,frame:u.drawRecord.length}),u.previewLoading=!1},handleOpenMoveCanvas(){u.isSpace=!u.isSpace},handlekeyDownEvent(e){var a;if(t.$route.path.includes("/work")){if(" "===e.key)return e.preventDefault(),void(u.isSpace=!0);if(e.shiftKey&&(u.isShift=!0),e.altKey&&"c"===e.key&&u.selectData.selectList.length)g.handleCopySelectData();else if(e.altKey&&"q"===e.key)e.preventDefault(),g.drawTransform("scale");else if(e.altKey&&"d"===e.key)e.preventDefault(),g.handleRemoveSelect();else if(e.altKey&&"n"===e.key)g.handleCancelSelect();else if(e.altKey&&"z"===e.key)g.handleRevoke();else if(e.altKey&&"x"===e.key)g.handleRecover();else if((e.metaKey||e.ctrlKey)&&"s"===e.key)e.preventDefault(),g.handleSaveProject();else if((e.metaKey||e.ctrlKey)&&"p"===e.key)e.preventDefault(),g.handleExportDialog(!0);else if((e.metaKey||e.ctrlKey)&&"i"===e.key)e.preventDefault(),g.handleExportDialog(!1);else if(e.altKey&&"p"===e.key)g.handleOpenPreviewDialog();else if(e.altKey&&"f"===e.key)e.preventDefault(),g.handleScreenFull();else if(e.altKey&&"v"===e.key)g.handleResetCanvas();else if(e.altKey&&"g"===e.key)t.$refs.MyColorDialog.handleOpen();else if((e.metaKey||e.ctrlKey)&&"m"===e.key)e.preventDefault(),g.handleImportImage();else if((e.metaKey||e.ctrlKey)&&e.altKey&&"c"===e.key)e.preventDefault(),n.handleCopyColor(u.brushColor);else if((e.metaKey||e.ctrlKey)&&e.altKey&&"t"===e.key)e.preventDefault(),g.handleAddLayer();else if((e.metaKey||e.ctrlKey)&&e.altKey&&"h"===e.key)e.preventDefault(),g.handleLayerMerge();else if((e.metaKey||e.ctrlKey)&&"ArrowUp"===e.key)e.preventDefault(),g.drawTransform("hReverse");else if((e.metaKey||e.ctrlKey)&&"ArrowDown"===e.key)e.preventDefault(),g.drawTransform("vReverse");else if((e.metaKey||e.ctrlKey)&&"ArrowLeft"===e.key)e.preventDefault(),g.drawTransform("nsz");else if((e.metaKey||e.ctrlKey)&&"ArrowRight"===e.key)e.preventDefault(),g.drawTransform("ssz");else if((e.metaKey||e.ctrlKey)&&"="===e.key)e.preventDefault(),g.handleResizeCanvas(.05);else if((e.metaKey||e.ctrlKey)&&"-"===e.key)e.preventDefault(),g.handleResizeCanvas(-.05);else if((e.metaKey||e.ctrlKey)&&e.key);else if("q"===e.key)g.handleChangeTool(0);else if("w"===e.key)g.handleChangeTool(1);else if("e"===e.key)g.handleChangeTool(2);else if("r"===e.key)g.handleChangeTool(4);else if("t"===e.key)g.handleChangeTool(7);else if("y"===e.key)g.handleChangeTool(8),u.selectType="select";else if("p"===e.key)g.handleChangeTool(8),u.selectType="quickSelect";else if("j"===e.key)g.handleChangeTool(8),u.selectType="rangeSelect";else if("u"===e.key)g.handleOpenReplaceColorDialog();else if(e.altKey&&"s"===e.key)n.handleSaveColor(!0,u.brushColor);else if("i"===e.key)g.handleChangeTool(6);else if("o"===e.key)g.handlePindouMode("preview");else if("k"===e.key)g.handlePindouMode("draw");else if("l"===e.key)g.handleLinmoMode();else if("a"===e.key)g.handleChangeTool(3),g.drawShape("rect");else if("s"===e.key)g.handleChangeTool(3),g.drawShape("circle");else if("d"===e.key)g.handleChangeTool(3),g.drawShape("line");else if("f"===e.key)g.handleChangeTool(3),g.drawShape("fillRect");else if("z"===e.key)u.linmoMode&&u.linmoPhoto&&(t.$refs.LinmoModeDialog.isLockCanvas=!t.$refs.LinmoModeDialog.isLockCanvas,g.handleLinmoFitCanvas(t.$refs.LinmoModeDialog.isLockCanvas));else if("x"===e.key)u.linmoMode&&u.linmoPhoto&&(t.$refs.LinmoModeDialog.zIndex=!t.$refs.LinmoModeDialog.zIndex,t.$refs.LinmoModeDialog.updatelinmoPhotoStyle());else if("v"===e.key)u.linmoMode&&u.linmoPhoto&&(t.$refs.LinmoModeDialog.display=!t.$refs.LinmoModeDialog.display,t.$refs.LinmoModeDialog.updatelinmoPhotoStyle());else if("c"===e.key)u.linmoMode&&(t.$refs.LinmoModeDialog.isPickingColor||(t.$refs.LinmoModeDialog.opacityHistoryRecord=t.$refs.LinmoModeDialog.opacity,t.$refs.LinmoModeDialog.zIndexHistoryRecord=t.$refs.LinmoModeDialog.zIndex,t.$refs.LinmoModeDialog.opacity=100,t.$refs.LinmoModeDialog.zIndex||(t.$refs.LinmoModeDialog.zIndex=!0),t.$refs.LinmoModeDialog.updatelinmoPhotoStyle(),t.$refs.LinmoModeDialog.isPickingColor=!0,setTimeout((()=>{var e;null==(e=document.querySelector(".EyeDropper-color-picker"))||e.click()}),500)));else if(e.altKey&&"ArrowUp"===e.key){if(u.isShift)return;u.currentLayerIndex--,u.currentLayerIndex<0&&(u.currentLayerIndex=0),u.selectLayerList=[u.currentLayerIndex]}else if(e.altKey&&"ArrowDown"===e.key){if(u.isShift)return;u.currentLayerIndex++,u.currentLayerIndex>u.drawRecord[u.currentFrameIndex].layer.length-1&&(u.currentLayerIndex=u.drawRecord[u.currentFrameIndex].layer.length-1),u.selectLayerList=[u.currentLayerIndex]}else if(e.altKey&&"ArrowLeft"===e.key){if(e.preventDefault(),u.currentFrameIndex--,u.currentFrameIndex<0)return void(u.currentFrameIndex=0);g.handleChangeFrame(u.currentFrameIndex)}else if(e.altKey&&"ArrowRight"===e.key){if(e.preventDefault(),u.currentFrameIndex++,u.currentFrameIndex>u.drawRecord.length-1)return void(u.currentFrameIndex=u.drawRecord.length-1);g.handleChangeFrame(u.currentFrameIndex)}else["1","2","3","4","5","6","7","8","9"].includes(e.key)&&(u.brushColor=(null==(a=o.settingsOption.colorKeyOptions.find((a=>a.key==e.key)))?void 0:a.color)||"#000000ff");u.canvas.className="",g.addCursorClass()}},handleKeyUpEvent(e){t.$route.path.includes("/work")&&(" "===e.key&&(u.isSpace=!1,u.canvas.style.cursor=""),"Shift"===e.key&&(u.isShift=!1),"Shift"===e.key&&u.isSelecting&&u.selectData.selectList.length&&(u.isShift=!1,u.isMoving=!1,u.canvas.style.cursor=""),"Escape"!==e.key&&"Esc"!==e.key||(t.$refs.LinmoModeDialog.isPickingColor=!1,t.$refs.LinmoModeDialog.zIndex&&(t.$refs.LinmoModeDialog.zIndex=t.$refs.LinmoModeDialog.zIndexHistoryRecord,t.$refs.LinmoModeDialog.opacity=t.$refs.LinmoModeDialog.opacityHistoryRecord,t.$refs.LinmoModeDialog.updatelinmoPhotoStyle())))},addKeyBoardEvent(){window.addEventListener("keydown",g.handlekeyDownEvent),window.addEventListener("keyup",g.handleKeyUpEvent)},handleResizeWindowEvent(e){g.handleSaveMoveData(!0,(()=>{g.computeScale(),u.canvasBeginPos.centerX=u.canvasBeginPos.x+u.scale*u.canvasWidth/2,u.canvasBeginPos.centerY=u.canvasBeginPos.y+u.scale*u.canvasHeight/2,g.drawPixelArea(!0),u.pinDouMode?g.handleDrawPindou(u.ctx1):g.reDraw(!1,!1),u.linmoFitCanvasTimer&&clearTimeout(u.linmoFitCanvasTimer),u.linmoFitCanvasTimer=setTimeout((()=>{g.handleLinmoFitCanvas(),g.handleDrawReferenceLine(),g.handleScaleFrame()}),250)}))},handleResizeWindow(){window.addEventListener("resize",g.handleResizeWindowEvent)},onDragLayerEnd(e,a){let r=t.$refs[a],l=Array.from(r.children),n=[],o=u.drawRecord[u.currentFrameIndex].layer;for(let t=0;t<l.length;t++){let e=l[t].dataset.key,a=o.find((a=>a.layerId===e));n.push(a)}u.drawRecord[u.currentFrameIndex].layer=n,g.reDraw()},onDragFrameEnd(e,a){let r=t.$refs[a],l=Array.from(r.children),n=[],o=u.drawRecord;for(let t=0;t<l.length-1;t++){let e=l[t].dataset.key,a=o.find((a=>a.frameId===e));n.push(a)}u.drawRecord=n,g.handleChangeFrame(u.currentFrameIndex)},handleCopySelectData(){u.selectData.copySelectMapList=V(u.selectData.selectMapList),u.selectData.copyList=JSON.parse(JSON.stringify(u.selectData.selectList)),t.$message.success("复制成功")},handleFilter(e,a=0){u.isScaling&&g.handleCancelScale(),u.loading=!0;r.handleFilter(e,u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex],u.selectData,u.canvasWidth,u.canvasHeight,((e=null,a)=>{u.loading=!1,g.reDraw(),g.handleLayerMapDataToLayerData(!0)}),a,u.worker)},handleExpand(){u.isExpandColorSelector=!u.isExpandColorSelector;let e=document.querySelector(".colorSelector"),a=document.querySelector(".back-icon");u.isExpandColorSelector?(e.style.transform="translateX(0)",a.children[0].style.transform="rotate(0deg)"):(e.style.transform="translateX(100%)",a.children[0].style.transform="rotate(180deg)")},handleTransformColorAsHex(e){let a=e;return te(a)&&9===a.length?e:te(a)&&7===a.length?a+"ff":te(a)?k(I(a)):k(T(a))},handleConfirmReplaceColor(e,a){let r=g.handleTransformColorAsHex(e.replaceColor),l=g.handleTransformColorAsHex(e.newColor);if(1===e.type){let e=u.drawRecord[u.currentFrameIndex].layer[u.currentLayerIndex].layerNewData;e[r]?(e[l]=e[r],delete e[r]):t.$message.warning("替换颜色不存在")}else if(2===e.type){let e=u.drawRecord[u.currentFrameIndex].layer;for(let a=0;a<e.length;a++){let e=u.drawRecord[u.currentFrameIndex].layer[a].layerNewData;e[r]&&(e[l]=e[r],delete e[r])}}a(),g.reDraw(),g.handleLayerMapDataToLayerData(!0)},handleResetCanvas(){u.pindouScaleValue=0,u.canvasStyle.transform="translate3d(0, 0, 10px) scale(1)",g.handleResizeWindowEvent("")},handleInitData(){u.currentTool=0,u.historyRecord=[],u.currentFrameIndex=0,u.currentLayerIndex=0,u.currentFrameId=0,u.currentLayerId=0,u.shapeFillColor="#000000ff",u.brushColor="#000000ff",u.isCheckedRatio=!0,u.isShowReferenceLine=!1,u.isShowRuler=!1,u.isShowGridLine=!1,u.isVertical=!1,u.isHorizontal=!1,u.isCenter=!1,u.brushSize=1,u.eraserSize=1,u.widthHeightRatio=1,u.tolerance=0,u.selectType="select",u.currentDrawShape="rect",u.currentDrawTransform="hReverse",u.projectData=H(),u.pinDouMode=!1,u.pinDouDrawMode=!1,u.selectLayerList=[u.currentLayerIndex],u.pindouHighlight=null,u.pindouBrand="mard-v2",u.isHidePindouMode=!1,u.isScaling=!1,u.scaleWhitePointPos=[],u.scaleAreaData=null,u.scaleRatio=0,u.colorStatList=[],u.layerAlpha=100,u.isHideLinmoMode=!1,u.linmoMode=!1,u.linmoPhoto=null,u.currentHistoryIndex=0,u.canvasStyle={transform:"translate3d(0, 0, 10px) scale(1)",transformOrigin:"center center"},u.linmoPhotoStyle={width:"200px",height:"200px",transform:"translate3d(0px, 0px, 10px) rotate(0deg) scale(1, 1)",opacity:1,zIndex:0,display:"none",transformOrigin:"center center"},u.pindouScaleValue=0,u.isSpace=!1,u.searchColorValue="",u.searchColorList=[],u.drawAreaGridCanvas=null,u.layerGridImage=null,g.handleCancelSelect()},handleInitEmptyLayer(){u.emptyLayerData=[];for(let e=0;e<u.canvasHeight;e++)for(let a=0;a<u.canvasWidth;a++)u.emptyLayerData.push([a,e,u.emptyColor])},setCanvasCenter(){let e=u.baseCanvas.width/2-u.canvas.width/2,a=u.baseCanvas.height/2-u.canvas.height/2;u.canvas.style.left=`${e}px`,u.canvas.style.top=`${a}px`,u.moveBoxDom.style.left=`${e}px`,u.moveBoxDom.style.top=`${a}px`,u.bgCanvas.style.left=`${e}px`,u.bgCanvas.style.top=`${a}px`,u.gridCanvas.style.left=`${e}px`,u.gridCanvas.style.top=`${a}px`},handleReadProjectData(){let e=t.$route.params.projectId,a=JSON.parse(JSON.stringify(o.getProjectById(e)));if(a){let e=o.currentProjectId.split("A");e[e.length-1]!==a.projectId&&(g.handleInitData(),u.loading=!0,u.projectData.projectId=a.projectId,u.projectData.projectName=a.projectName,u.projectData.updateAt=a.updateAt,u.projectData.createAt=a.createAt,u.projectData.desc=a.desc,u.canvasWidth=Number(a.width),u.canvasHeight=Number(a.height),u.projectData.frameImg=a.frameImg,u.projectData.tip=a.tip,u.projectData.isTop=a.isTop,u.projectData.data=a.data,n.getMyColorList(),u.baseCanvas=document.getElementById("BaseCanvas"),u.canvas=document.getElementById("Canvas"),u.bgCanvas=document.getElementById("PixelCanvas"),u.realCanvas=document.createElement("canvas"),u.gridCanvas=document.getElementById("GridCanvas"),u.moveCanvas=document.getElementById("MoveCanvas"),u.moveBoxDom=document.querySelector(".MoveBox"),g.computeScale(),u.ctx0=u.baseCanvas.getContext("2d"),u.ctx1=u.canvas.getContext("2d"),u.ctx2=u.bgCanvas.getContext("2d"),u.ctx3=u.realCanvas.getContext("2d"),u.ctx4=u.gridCanvas.getContext("2d"),u.ctx5=u.moveCanvas.getContext("2d"),u.ctx1.lineCap="square",u.ctx1.save(),u.canvasBeginPos.centerX=u.canvasBeginPos.x+u.scale*u.canvasWidth/2,u.canvasBeginPos.centerY=u.canvasBeginPos.y+u.scale*u.canvasHeight/2,g.drawPixelArea(!0),g.handleInitEmptyLayer(),g.handleGridImg(),g.startDrawing(),g.addKeyBoardEvent(),g.handleResizeWindow(),u.projectData.data?(u.worker.postMessage({type:4,variables:JSON.parse(JSON.stringify(a.data)),canvasWidth:u.canvasWidth}),u.worker.onmessage=e=>{try{u.drawRecord=e.data,o.saveProjectId(u.projectData.projectId),u.drawRecord.length&&g.reDraw(),g.handleChangeLayer(u.currentLayerIndex),u.loading=!1}catch(a){t.$message.error("项目读取异常"),o.saveProjectId("0"),setTimeout((()=>{t.$router.replace("/project")}),1e3)}}):(o.saveProjectId(u.projectData.projectId),u.drawRecord=[],g.initCanvasRecord("init"),u.loading=!1))}else t.$message.error("项目不存在"),o.saveProjectId("0"),t.$router.replace("/project")},handleCancelKeyboardEvent(){window.removeEventListener("keydown",g.handlekeyDownEvent),window.removeEventListener("keyup",g.handleKeyUpEvent)},handleExportDialog(e){u.exportVisible=!0,u.isExportProject=e,g.handleCancelKeyboardEvent()},handleImportImage(){u.importLayerVisible=!0,g.handleCancelKeyboardEvent()},handleCloseDialog(e){u[e]=!1,g.addKeyBoardEvent()},closeMenu(){u.LayerMenu.visible=!1,u.MyColorMenu.visible=!1},handleMenu(e,a,t){u.pinDouMode||(g.closeMenu(),setTimeout((()=>{u[a].visible=!0,u[a].left=e.pageX,u[a].top=e.pageY,u[a].contextData=ee(t),"LayerMenu"===a&&g.handleChangeLayer(t.index)}),100))},preventDefaults(e){e.preventDefault(),e.stopPropagation()},handleDragZoneEvent(){const e=document.getElementById("dropZone");["dragenter","dragover","dragleave","drop"].forEach((a=>{e.addEventListener(a,g.preventDefaults,!1),document.body.addEventListener(a,g.preventDefaults,!1)})),e.addEventListener("drop",g.handleDrop,!1)},handleDrop(e){const a=e.dataTransfer.files[0];g.handleImportDragImage(a)}});return O((()=>n.data.addMyColorVisible),((e,a)=>{e?g.handleCancelKeyboardEvent():g.addKeyBoardEvent()})),O((()=>u.isShowReferenceLine),((e,a)=>{g.handleDrawReferenceLine(),g.handleScaleFrame1()})),O((()=>u.isShowRuler),((e,a)=>{g.handleDrawReferenceLine()})),O((()=>u.isShowGridLine),((e,a)=>{g.handleDrawGridLine(),u.pinDouMode&&g.handlePindouBlockHighlight(u.pindouHighlightOptions)})),O((()=>u.pinDouMode),((e,a)=>{!1===e?(ge.closeAll(),u.currentTool=0,u.pindouHighlight=null,g.handleResetCanvas()):t.$message.warning("拼豆模式 - 超清预览",{duration:0,grouping:!0,icon:"Search",showClose:!0})})),O((()=>o.themeValue),((e,a)=>{u.canvas&&u.bgCanvas&&(g.drawPixelArea(!0),g.handleScaleFrame1())})),O((()=>o.isQueryProjectData),((e,a)=>{"1"===e?g.handleReadProjectData():"2"===e&&t.$router.replace("/project")})),W((()=>{u.worker=new Ee,document.addEventListener("click",g.closeMenu),g.handleDragZoneEvent()})),N((()=>{"1"===o.isQueryProjectData&&g.handleReadProjectData(),u.canvas&&(g.startDrawing(),g.addKeyBoardEvent(),g.handleResizeWindow(),document.addEventListener("click",g.closeMenu),u.isHidePindouMode||!u.pinDouMode&&!u.pinDouDrawMode||(g.handleShowPindou(),u.pinDouMode&&(t.$message.warning("拼豆模式 - 超清预览",{duration:0,grouping:!0,icon:"Search"}),g.handleCancelKeyboardEvent())),!u.isHideLinmoMode&&u.linmoMode&&(u.isHideLinmoMode=!1,t.$refs.LinmoModeDialog.handleShow()))})),_((()=>{var e;u.canvas&&(u.canvas.style.cursor="",u.canvas.classList="",u.canvas.removeEventListener("mousedown",g.start),u.canvas.removeEventListener("mousemove",g.draw),u.canvas.removeEventListener("mouseup",g.stop),u.canvas.removeEventListener("touchstart",g.mobileStart),u.canvas.removeEventListener("touchmove",g.mobileDraw),u.canvas.removeEventListener("touchend",g.stop),u.canvas.removeEventListener("mouseout",g.leave),u.canvas.removeEventListener("wheel",g.handleWheelEvent),u.moveCanvas.removeEventListener("wheel",g.handleWheelEvent),null==(e=document.getElementById("dropZone"))||e.removeEventListener("mousemove",g.handleChangeMouseStyle),window.removeEventListener("keydown",g.handlekeyDownEvent),window.removeEventListener("keyup",g.handleKeyUpEvent),window.removeEventListener("resize",g.handleResizeWindowEvent),document.removeEventListener("click",g.closeMenu),t.$refs.ReplaceColorDialog.handleClose(),t.$refs.MyColorDialog.handleClose(),t.$refs.PreviewAnimDialog.handleClose(),t.$refs.PindouDialog.dialogVisible=!1,t.$refs.LinmoModeDialog.dialogVisible=!1,ge.closeAll())})),B((()=>{u.worker&&u.worker.terminate(),o.saveProjectId("0");const e=document.getElementById("dropZone");["dragenter","dragover","dragleave","drop"].forEach((a=>{e.removeEventListener(a,g.preventDefaults,!1),document.body.removeEventListener(a,g.preventDefaults,!1)})),e.removeEventListener("drop",g.handleDrop,!1)})),s(s(s(i(s(s(s({},E(u)),g),m),{editSpaceStore:o,copyText:j}),R()),E(n.data)),n.computedApi)}});const Ne={class:"scrollbar scrollX full-w draw-panel"},_e={class:"back flex-start"},Be={class:"oneline"},je={key:0,style:{color:"red"}},Ye={class:"flex-end"},ze={class:"flex-start flex-nowarp full-w",style:{flex:"1"}},Xe={class:"functionBox"},Ve={class:"flex-column-start"},Ue=["src"],Ke=["src"],Je=["src"],Ge=["src"],qe=["src"],Ze=["src"],Qe=["src"],ea={class:"flex-column-end"},aa=["src"],ta=["src"],ra=["src"],la=["src"],na=["src"],oa=["src"],sa={key:1,class:"gridInfo"},ia={key:2,class:"colorSelector"},ca={class:"color-body scrollbar full-layout"},da=["onClick"],ha=["onClick"],ua=["src"],ma={class:"full-h flex-nowarp flex flex-column"},ga={style:{flex:"1"},class:"full-w"},ya={class:"function-block function-block-between"},fa={class:"flex-center"},pa={class:"flex-center"},va={class:"function-block function-block-between"},Da={class:"flex-center"},wa={key:0,class:"function-block-column",style:{"margin-top":"15px"}},xa={class:"flex-between full-w"},Ca={class:"flex-start"},La={class:"function-label",style:{"margin-right":"10px"}},Sa={class:"color-group-select-icon flex-center pointer"},Ra={class:"flex-start flex-warp common-color scrollbar"},ba=["title","onContextmenu","onClick"],Ma={class:"mycolor flex-center",style:{"background-color":"var(--el-bg-color-second)"}},Ia={key:1,class:"function-block function-block-between"},ka={key:2,class:"function-block function-block-between"},Fa={class:"function-block-column"},Ta={class:"flex-between flex-nowarp full-w"},Pa={style:{gap:"10px","margin-top":"10px"},class:"flex-start full-w"},$a={style:{"margin-top":"10px"},class:"flex-between symmetric-box full-w"},Aa={style:{"margin-top":"10px"},class:"flex-between symmetric-box full-w"},Ea={class:"function-block function-block-between"},Ha={class:"function-block function-block-between"},Oa={class:"function-block function-block-between flex-warp",style:{gap:"10px"}},Wa={key:0},Na={key:1},_a={key:0,style:{flex:"1","margin-top":"15px"},class:"full-w scrollHidden"},Ba={class:"flex-between"},ja={class:"flex-end"},Ya=["data-key","disabled","onContextmenu","onClick"],za={class:"flex-start",style:{gap:"10px"}},Xa=["onClick"],Va=["src"],Ua={key:0,class:"layer-img flex-center"},Ka=["src"],Ja={key:1},Ga=["onDblclick","title"],qa={class:"flex-end"},Za={class:"flex-between",style:{"margin-top":"10px"}},Qa={class:"flex-end"},et={class:"dialog-footer"};var at=Oe(We,[["render",function(e,a,t,r,l,n){const o=ye("ArrowLeftBold"),s=ye("el-icon"),i=ye("Loading"),c=ye("Back"),d=ye("el-tooltip"),h=ye("Right"),u=ye("ZoomIn"),m=ye("ZoomOut"),g=ye("Refresh"),y=ye("Pointer"),f=ye("VideoPlay"),p=ye("Folder"),v=ye("el-dropdown-item"),D=ye("el-dropdown-menu"),w=ye("el-dropdown"),x=ye("FullScreen"),C=ye("el-header"),L=ye("VueDragScale"),S=ye("Expand"),R=ye("Plus"),b=ye("el-footer"),M=ye("el-main"),I=ye("el-divider"),k=ye("sketch-picker"),F=ye("el-popover"),T=ye("el-link"),P=ye("CaretBottom"),$=ye("search"),A=ye("el-input"),E=ye("MoreFilled"),H=ye("el-slider"),O=ye("el-checkbox"),W=ye("el-input-number"),N=ye("el-button"),_=ye("Close"),B=ye("Check"),j=ye("View"),Y=ye("Hide"),z=ye("DocumentAdd"),X=ye("CirclePlus"),V=ye("Lock"),U=ye("Unlock"),K=ye("CopyDocument"),J=ye("Delete"),G=ye("el-popconfirm"),q=ye("el-aside"),Z=ye("el-container"),Q=ye("MyColorDialog"),ee=ye("ReplaceColorDialog"),ae=ye("ExportDialog"),te=ye("PreviewAnimDialog"),re=ye("PindouDialog"),le=ye("LayerMenu"),ne=ye("MyColorMenu"),oe=ye("LinmoModeDialog"),se=ye("UploadImageLayerDialog"),ie=ye("el-color-picker"),ce=ye("el-option"),de=ye("el-select"),he=ye("el-dialog"),ue=fe("loading");return pe(),ve("div",{class:"container full-h",style:Ie(e.checkzIndex)},[De(Z,{class:"full-h flex-warp"},{default:we((()=>[xe("div",Ne,[De(M,{class:"flex-column-center",style:{display:"flex",padding:"0","min-width":"500px"}},{default:we((()=>[De(C,{class:"flex-between"},{default:we((()=>[xe("div",_e,[De(s,{onClick:e.handleBack},{default:we((()=>[De(o)])),_:1},8,["onClick"]),xe("h1",Be,[Ce(Le(e.projectData.projectName)+" ",1),e.isSaveProject?Se("",!0):(pe(),ve("span",je,"*"))]),e.editSpaceStore.isAutoBackuping?(pe(),Re(s,{key:0,style:{"margin-left":"10px"},color:"green",class:be({"is-loading":e.editSpaceStore.isAutoBackuping})},{default:we((()=>[De(i)])),_:1},8,["class"])):Se("",!0)]),xe("div",Ye,[De(d,{content:"撤销 [Alt/⌥ + z]",placement:"bottom"},{default:we((()=>[De(s,{style:{"margin-right":"20px"},onClick:e.handleRevoke,class:be({isNotAllowed:!e.historyRecord.length||7===e.currentTool})},{default:we((()=>[De(c)])),_:1},8,["onClick","class"])])),_:1}),De(d,{content:"恢复 [Alt/⌥ + x]",placement:"bottom"},{default:we((()=>[De(s,{style:{"margin-right":"20px"},onClick:e.handleRecover,class:be({isNotAllowed:!e.historyRecord.length||7===e.currentTool})},{default:we((()=>[De(h)])),_:1},8,["onClick","class"])])),_:1}),De(d,{content:"放大画布 [滚轮/Ctrl/⌘ + =]",placement:"bottom"},{default:we((()=>[De(s,{style:{"margin-right":"20px"},onClick:a[0]||(a[0]=a=>e.handleResizeCanvas(.05))},{default:we((()=>[De(u)])),_:1})])),_:1}),De(d,{content:"缩小画布 [滚轮/Ctrl/⌘ + -]",placement:"bottom"},{default:we((()=>[De(s,{style:{"margin-right":"20px"},onClick:a[1]||(a[1]=a=>e.handleResizeCanvas(-.05))},{default:we((()=>[De(m)])),_:1})])),_:1}),De(d,{content:"重置画布 [Alt/⌥ + v]",placement:"bottom"},{default:we((()=>[De(s,{style:{"margin-right":"20px"},onClick:e.handleResetCanvas},{default:we((()=>[De(g)])),_:1},8,["onClick"])])),_:1}),De(d,{content:"移动画布 [空格 + 鼠标]",placement:"bottom"},{default:we((()=>[De(s,{style:{"margin-right":"20px"},onClick:e.handleOpenMoveCanvas,class:be({active:e.isSpace})},{default:we((()=>[De(y)])),_:1},8,["onClick","class"])])),_:1}),De(d,{content:e.previewLoading?"正在加载":"预览动画 [Alt/⌥ + p]",placement:"bottom"},{default:we((()=>[e.previewLoading?(pe(),Re(s,{key:1,style:{"margin-right":"20px"},class:"is-loading"},{default:we((()=>[De(i)])),_:1})):(pe(),Re(s,{key:0,style:{"margin-right":"20px"},onClick:e.handleOpenPreviewDialog},{default:we((()=>[De(f)])),_:1},8,["onClick"]))])),_:1},8,["content"]),De(w,{placement:"bottom",trigger:"hover"},{dropdown:we((()=>[De(D,null,{default:we((()=>[De(v,{onClick:e.handleImportImage,disabled:e.pinDouMode},{default:we((()=>a[100]||(a[100]=[Ce("导入图像 [Ctrl/⌘ + m]")]))),_:1,__:[100]},8,["onClick","disabled"]),De(v,{onClick:e.handleSaveProject,disabled:e.pinDouMode},{default:we((()=>a[101]||(a[101]=[Ce("保存项目 [Ctrl/⌘ + s]")]))),_:1,__:[101]},8,["onClick","disabled"]),De(v,{onClick:a[2]||(a[2]=a=>e.handleExportDialog(!0)),disabled:e.pinDouMode},{default:we((()=>a[102]||(a[102]=[Ce("导出项目 [Ctrl/⌘ + p]")]))),_:1,__:[102]},8,["disabled"]),De(v,{onClick:a[3]||(a[3]=a=>e.handleExportDialog(!1)),disabled:e.pinDouMode},{default:we((()=>a[103]||(a[103]=[Ce("导出图像 [Ctrl/⌘ + i]")]))),_:1,__:[103]},8,["disabled"])])),_:1})])),default:we((()=>[De(s,{style:{"margin-right":"20px"},size:"16"},{default:we((()=>[De(p)])),_:1})])),_:1}),De(d,{content:"全屏 [Alt/⌥ + f]",placement:"bottom"},{default:we((()=>[De(s,{class:be({active:e.editSpaceStore.isFullWork}),style:{"margin-right":"0px"},onClick:e.handleScreenFull},{default:we((()=>[De(x)])),_:1},8,["class","onClick"])])),_:1})])])),_:1}),xe("div",ze,[xe("div",Xe,[xe("div",Ve,[De(d,{content:"画笔 [q]",placement:"right"},{default:we((()=>[xe("div",{class:be(["pointer toolItem flex-center",{active:0===e.currentTool}]),style:{"margin-top":"0"},onClick:a[4]||(a[4]=a=>e.handleChangeTool(0))},[xe("img",{src:e.requireIcon("brush")},null,8,Ue)],2)])),_:1}),De(d,{content:"橡皮擦 [w]",placement:"right"},{default:we((()=>[xe("div",{class:be(["pointer toolItem",{active:1===e.currentTool}]),onClick:a[5]||(a[5]=a=>e.handleChangeTool(1))},[xe("img",{src:e.requireIcon("eraser")},null,8,Ke)],2)])),_:1}),De(d,{content:"吸管 [e]",placement:"right"},{default:we((()=>[xe("div",{class:be(["pointer toolItem",{active:2===e.currentTool}]),onClick:a[6]||(a[6]=a=>e.handleChangeTool(2))},[xe("img",{src:e.requireIcon("straw")},null,8,Je)],2)])),_:1}),De(d,{content:"油漆桶 [r]",placement:"right"},{default:we((()=>[xe("div",{class:be(["pointer toolItem",{active:4===e.currentTool}]),onClick:a[7]||(a[7]=a=>e.handleChangeTool(4))},[xe("img",{src:e.requireIcon("bucket")},null,8,Ge)],2)])),_:1}),De(d,{content:"移动 [t]",placement:"right"},{default:we((()=>[xe("div",{class:be(["pointer toolItem",{active:7===e.currentTool}]),onClick:a[8]||(a[8]=a=>e.handleChangeTool(7))},[xe("img",{src:e.requireIcon("move")},null,8,qe)],2)])),_:1}),De(d,{content:"形状",placement:"right"},{default:we((()=>[De(w,{placement:"bottom-start",trigger:"click"},{dropdown:we((()=>[De(D,null,{default:we((()=>[De(v,{onClick:a[10]||(a[10]=a=>e.drawShape("rect")),disabled:e.pinDouMode},{default:we((()=>a[104]||(a[104]=[Ce("矩 形 [a]")]))),_:1,__:[104]},8,["disabled"]),De(v,{onClick:a[11]||(a[11]=a=>e.drawShape("circle")),disabled:e.pinDouMode},{default:we((()=>a[105]||(a[105]=[Ce("圆 形 [s]")]))),_:1,__:[105]},8,["disabled"]),De(v,{onClick:a[12]||(a[12]=a=>e.drawShape("line")),disabled:e.pinDouMode},{default:we((()=>a[106]||(a[106]=[Ce("直 线 [d]")]))),_:1,__:[106]},8,["disabled"]),De(v,{onClick:a[13]||(a[13]=a=>e.drawShape("fillRect")),disabled:e.pinDouMode},{default:we((()=>a[107]||(a[107]=[Ce("填充矩形 [f]")]))),_:1,__:[107]},8,["disabled"]),Se("",!0)])),_:1})])),default:we((()=>[xe("div",{class:be(["pointer toolItem",{active:3===e.currentTool}]),onClick:a[9]||(a[9]=a=>e.handleChangeTool(3))},[xe("img",{src:e.requireShapeImg},null,8,Ze)],2)])),_:1})])),_:1}),De(d,{content:"选区",placement:"right"},{default:we((()=>[De(w,{placement:"bottom-start",trigger:"click"},{dropdown:we((()=>[De(D,null,{default:we((()=>[De(v,{onClick:a[16]||(a[16]=a=>e.selectType="select")},{default:we((()=>a[109]||(a[109]=[Ce("手动选择 [y]")]))),_:1,__:[109]}),De(v,{onClick:a[17]||(a[17]=a=>e.selectType="quickSelect")},{default:we((()=>a[110]||(a[110]=[Ce("快速选择 [p]")]))),_:1,__:[110]}),De(v,{onClick:a[18]||(a[18]=a=>e.selectType="rangeSelect")},{default:we((()=>a[111]||(a[111]=[Ce("区域选择 [j]")]))),_:1,__:[111]}),De(v,{onClick:e.handleCancelSelect,disabled:!e.selectData.selectList.length},{default:we((()=>a[112]||(a[112]=[Ce("取消选择 [Alt/⌥ + n]")]))),_:1,__:[112]},8,["onClick","disabled"]),De(v,{onClick:a[19]||(a[19]=a=>e.selectData.copyList=JSON.parse(JSON.stringify(e.selectData.selectList))),disabled:!e.selectData.selectList.length},{default:we((()=>a[113]||(a[113]=[Ce("复 制 [Alt/⌥ + c]")]))),_:1,__:[113]},8,["disabled"]),De(v,{onClick:e.handleRemoveSelect,disabled:!e.selectData.selectList.length},{default:we((()=>a[114]||(a[114]=[Ce("删 除 [Alt/⌥ + d]")]))),_:1,__:[114]},8,["onClick","disabled"]),De(v,{disabled:""},{default:we((()=>a[115]||(a[115]=[Ce("移 动 [Shift + 鼠标左键]")]))),_:1,__:[115]})])),_:1})])),default:we((()=>[xe("div",{class:be(["pointer toolItem",{active:8===e.currentTool}]),onClick:a[15]||(a[15]=a=>e.handleChangeTool(8))},[xe("img",{src:e.requireSelectImg},null,8,Qe)],2)])),_:1})])),_:1})]),xe("div",ea,[De(d,{content:"变换",placement:"right"},{default:we((()=>[De(w,{placement:"top-start",trigger:"click",disabled:7===e.currentTool},{dropdown:we((()=>[De(D,null,{default:we((()=>[De(v,{onClick:a[20]||(a[20]=a=>e.drawTransform("scale")),disabled:e.pinDouMode},{default:we((()=>a[116]||(a[116]=[Ce("缩放 [Alt/⌥ + q]")]))),_:1,__:[116]},8,["disabled"]),De(v,{onClick:a[21]||(a[21]=a=>e.drawTransform("hReverse")),disabled:e.pinDouMode},{default:we((()=>a[117]||(a[117]=[Ce("水平翻转 [Ctrl/⌘ + ↑]")]))),_:1,__:[117]},8,["disabled"]),De(v,{onClick:a[22]||(a[22]=a=>e.drawTransform("vReverse")),disabled:e.pinDouMode},{default:we((()=>a[118]||(a[118]=[Ce("垂直翻转 [Ctrl/⌘ + ↓]")]))),_:1,__:[118]},8,["disabled"]),De(v,{onClick:a[23]||(a[23]=a=>e.drawTransform("ssz")),disabled:e.pinDouMode||e.canvasWidth!==e.canvasHeight},{default:we((()=>a[119]||(a[119]=[Ce("顺时针旋转90度 [Ctrl/⌘ + →]")]))),_:1,__:[119]},8,["disabled"]),De(v,{onClick:a[24]||(a[24]=a=>e.drawTransform("nsz")),disabled:e.pinDouMode||e.canvasWidth!==e.canvasHeight},{default:we((()=>a[120]||(a[120]=[Ce("逆时针旋转90度 [Ctrl/⌘ + ←]")]))),_:1,__:[120]},8,["disabled"])])),_:1})])),default:we((()=>[xe("div",{class:be(["pointer toolItem",{active:9===e.currentTool,isNotAllowed:7===e.currentTool}])},[xe("img",{src:e.requireTransformImg},null,8,aa)],2)])),_:1},8,["disabled"])])),_:1}),De(d,{content:"滤镜",placement:"right"},{default:we((()=>[De(w,{placement:"top-start",trigger:"click",disabled:7===e.currentTool},{dropdown:we((()=>[De(D,null,{default:we((()=>[De(v,{onClick:a[25]||(a[25]=a=>e.handleFilter(1)),disabled:e.pinDouMode},{default:we((()=>a[121]||(a[121]=[Ce("黑 白")]))),_:1,__:[121]},8,["disabled"]),De(v,{onClick:a[26]||(a[26]=a=>e.handleFilter(2)),disabled:e.pinDouMode},{default:we((()=>a[122]||(a[122]=[Ce("反 相")]))),_:1,__:[122]},8,["disabled"]),De(v,{onClick:a[27]||(a[27]=a=>e.handleFilter(3)),disabled:e.pinDouMode},{default:we((()=>a[123]||(a[123]=[Ce("BGRA")]))),_:1,__:[123]},8,["disabled"])])),_:1})])),default:we((()=>[xe("div",{class:be(["pointer toolItem",{isNotAllowed:7===e.currentTool}])},[xe("img",{src:e.requireIcon("filter")},null,8,ta)],2)])),_:1},8,["disabled"])])),_:1}),De(d,{content:"替换颜色 [u]",placement:"right"},{default:we((()=>[xe("div",{class:be(["pointer toolItem",{isNotAllowed:7===e.currentTool}]),onClick:a[28]||(a[28]=(...a)=>e.handleOpenReplaceColorDialog&&e.handleOpenReplaceColorDialog(...a))},[xe("img",{src:e.requireIcon("color")},null,8,ra)],2)])),_:1}),De(d,{content:"清空图层 [i]",placement:"right"},{default:we((()=>[xe("div",{class:be(["pointer toolItem",{isNotAllowed:7===e.currentTool}]),onClick:a[29]||(a[29]=a=>e.handleChangeTool(6))},[xe("img",{src:e.requireIcon("clear")},null,8,la)],2)])),_:1}),De(d,{content:"拼豆模式",placement:"right"},{default:we((()=>[De(w,{placement:"top-start",trigger:"hover",disabled:7===e.currentTool},{dropdown:we((()=>[De(D,null,{default:we((()=>[De(v,{onClick:a[31]||(a[31]=a=>e.handlePindouMode("preview")),disabled:e.pinDouMode},{default:we((()=>a[124]||(a[124]=[Ce("预览模式 [o]")]))),_:1,__:[124]},8,["disabled"]),De(v,{onClick:a[32]||(a[32]=a=>e.handlePindouMode("draw")),disabled:e.pinDouMode},{default:we((()=>a[125]||(a[125]=[Ce("绘图模式 [k]")]))),_:1,__:[125]},8,["disabled"])])),_:1})])),default:we((()=>[xe("div",{class:be(["pointer toolItem",{active:e.pinDouMode||e.pinDouDrawMode,isNotAllowed:7===e.currentTool}]),onClick:a[30]||(a[30]=a=>e.handlePindouMode("preview"))},[xe("img",{src:e.requireIcon("pindou")},null,8,na)],2)])),_:1},8,["disabled"])])),_:1}),De(d,{content:"临摹模式 [l]",placement:"right"},{default:we((()=>[xe("div",{class:be(["pointer toolItem",{active:e.linmoMode}]),onClick:a[33]||(a[33]=(...a)=>e.handleLinmoMode&&e.handleLinmoMode(...a))},[xe("img",{src:e.requireIcon("copy")},null,8,oa)],2)])),_:1})])]),Me((pe(),ve("div",{onContextmenu:a[42]||(a[42]=e=>e.preventDefault()),class:"pixelBox scrollbar",id:"dropZone","element-loading-background":"#00000000"},[e.linmoPhoto?(pe(),Re(L,{key:0,linmoPhotoStyle:e.linmoPhotoStyle,isHighPreview:e.isHighPreview,linmoPhoto:e.linmoPhoto,onUpdate:e.handleUpdateLinmoStyle},null,8,["linmoPhotoStyle","isHighPreview","linmoPhoto","onUpdate"])):Se("",!0),xe("canvas",{id:"PixelCanvas",width:"512",height:"512",onContextmenu:a[34]||(a[34]=e=>e.preventDefault()),style:Ie(e.canvasStyle)},null,36),xe("canvas",{id:"Canvas",style:Ie(e.canvasStyle),width:"512",height:"512",onContextmenu:a[35]||(a[35]=e=>e.preventDefault())},null,36),Me(xe("div",{class:"MoveBox",style:Ie(e.canvasStyle)},[xe("canvas",{id:"MoveCanvas",onMousedown:a[36]||(a[36]=(...a)=>e.handleMoveCanvasMouseDown&&e.handleMoveCanvasMouseDown(...a)),onContextmenu:a[37]||(a[37]=e=>e.preventDefault())},null,32)],4),[[ke,e.isMoving]]),xe("canvas",{id:"GridCanvas",style:Ie(e.canvasStyle),width:"512",height:"512",onContextmenu:a[38]||(a[38]=e=>e.preventDefault())},null,36),xe("canvas",{id:"BaseCanvas",width:"512",height:"512",onContextmenu:a[39]||(a[39]=e=>e.preventDefault())},null,32),"[]"!==e.gridInfo?(pe(),ve("p",sa,Le(e.gridInfo),1)):Se("",!0),Object.keys(e.colorStatList).length?(pe(),ve("div",ia,[xe("div",{class:"back-icon",onClick:a[40]||(a[40]=(...a)=>e.handleExpand&&e.handleExpand(...a))},[De(s,null,{default:we((()=>[De(S)])),_:1})]),xe("div",ca,[(pe(!0),ve(Fe,null,Te(Object.keys(e.colorStatList),(a=>(pe(),ve("div",{class:be(["colorItem",{active:e.brushColor===a}]),key:a,onClick:t=>e.brushColor=a,style:Ie({backgroundColor:a,display:e.colorStatList[a].size>0?"block":"none"})},null,14,da)))),128))])])):Se("",!0),e.isHidePindouMode?(pe(),ve("div",{key:3,class:"pindouBtn flex-center",onClick:a[41]||(a[41]=(...a)=>e.handleShowPindou&&e.handleShowPindou(...a))},Le(e.pinDouMode?"预":"绘"),1)):Se("",!0)],32)),[[ue,e.loading]])]),De(b,{class:"flex-start"},{default:we((()=>[a[131]||(a[131]=xe("div",{class:"text-center"},"帧",-1)),xe("div",{class:"flex-start frame-list scrollbar",onDragstart:a[44]||(a[44]=a=>e.onDragStart(a,e.pinDouMode)),onDragover:a[45]||(a[45]=a=>e.onDragOver(a,"frameBox")),onDragend:a[46]||(a[46]=a=>e.onDragFrameEnd(a,"frameBox")),ref:"frameBox",id:"frame-box"},[(pe(!0),ve(Fe,null,Te(e.drawRecord,((t,r)=>(pe(),Re(w,{draggable:"true","data-key":t.frameId,"data-node":"LI",disabled:e.pinDouMode,key:t.frameId,trigger:"contextmenu"},{dropdown:we((()=>[De(D,null,{default:we((()=>[De(v,{onClick:a=>e.handleCopyFrame(r,"copy")},{default:we((()=>a[126]||(a[126]=[Ce("复 制")]))),_:2,__:[126]},1032,["onClick"]),0!==r?(pe(),Re(v,{key:0,onClick:a=>e.handleDeleteFrame(r)},{default:we((()=>a[127]||(a[127]=[Ce("删 除")]))),_:2,__:[127]},1032,["onClick"])):Se("",!0),De(v,{onClick:a=>e.handleCopyFrame(r,"copyData")},{default:we((()=>a[128]||(a[128]=[Ce("复制帧数据")]))),_:2,__:[128]},1032,["onClick"]),De(v,{onClick:a=>e.handleCopyFrame(r,"pasteData")},{default:we((()=>a[129]||(a[129]=[Ce("粘贴帧数据")]))),_:2,__:[129]},1032,["onClick"]),De(v,{onClick:a=>e.handleExportFrame(r)},{default:we((()=>a[130]||(a[130]=[Ce("导出为图像")]))),_:2,__:[130]},1032,["onClick"])])),_:2},1024)])),default:we((()=>[xe("div",{onClick:a=>e.handleChangeFrame(r),class:be(["frame-item pointer",{active:e.currentFrameIndex===r}])},[t.currentFrameImg?(pe(),ve("img",{key:0,draggable:"false",src:t.currentFrameImg},null,8,ua)):Se("",!0)],10,ha)])),_:2},1032,["data-key","disabled"])))),128)),e.drawRecord.length<e.maxFrame?(pe(),ve("div",{key:0,class:"frame-item pointer frame-add flex-center",onClick:a[43]||(a[43]=(...a)=>e.handleAddFrame&&e.handleAddFrame(...a))},[De(s,null,{default:we((()=>[De(R)])),_:1})])):Se("",!0)],544)])),_:1,__:[131]})])),_:1})]),De(q,null,{default:we((()=>[xe("div",ma,[xe("div",ga,[a[146]||(a[146]=xe("h1",null,"功能面板",-1)),De(I,{"border-style":"dashed"}),xe("div",ya,[xe("div",fa,[a[132]||(a[132]=xe("span",{class:"function-label"},"画笔颜色",-1)),De(F,{placement:"bottom",width:224,visible:e.brushColorVisible},{reference:we((()=>[xe("div",{style:Ie({backgroundColor:e.brushColor}),class:"color-picker",onClick:a[47]||(a[47]=a=>e.brushColorVisible=!e.brushColorVisible)},null,4)])),default:we((()=>[De(k,{modelValue:e.brushColor,"onUpdate:modelValue":a[48]||(a[48]=a=>e.brushColor=a.hex8)},null,8,["modelValue"])])),_:1},8,["visible"])]),xe("div",pa,[De(d,{content:"保存颜色 [Alt/⌥ + s]",placement:"top"},{default:we((()=>[De(T,{type:"info",underline:!1,onClick:a[49]||(a[49]=a=>e.handleSaveColor(!1,e.brushColor))},{default:we((()=>a[133]||(a[133]=[Ce("保存")]))),_:1,__:[133]})])),_:1}),De(d,{content:"复制颜色 [Ctrl/⌘ + Alt/⌥ + c]",placement:"top"},{default:we((()=>[De(T,{type:"info",underline:!1,style:{"margin-left":"10px"},onClick:a[50]||(a[50]=a=>e.handleCopyColor(e.brushColor))},{default:we((()=>a[134]||(a[134]=[Ce("复制")]))),_:1,__:[134]})])),_:1})])]),Me(xe("div",va,[xe("div",Da,[a[135]||(a[135]=xe("span",{class:"function-label",style:{width:"63px"}},"填充颜色",-1)),De(F,{placement:"bottom",width:224,visible:e.shapeFillColorVisible},{reference:we((()=>[xe("div",{style:Ie({backgroundColor:e.shapeFillColor}),class:"color-picker",onClick:a[51]||(a[51]=a=>e.shapeFillColorVisible=!e.shapeFillColorVisible)},null,4)])),default:we((()=>[De(k,{modelValue:e.shapeFillColor,"onUpdate:modelValue":a[52]||(a[52]=a=>e.shapeFillColor=a.hex8)},null,8,["modelValue"])])),_:1},8,["visible"])])],512),[[ke,e.currentDrawShape.indexOf("fill")>=0&&3e3===e.currentTool]]),e.editSpaceStore.myColorList.length?(pe(),ve("div",wa,[xe("div",xa,[xe("div",Ca,[xe("span",La,Le(e.editSpaceStore.myColorList.find((a=>a.id==e.currentColorGroup)).groupName||"常用颜色"),1),De(w,{trigger:"click"},{dropdown:we((()=>[De(D,null,{default:we((()=>[(pe(!0),ve(Fe,null,Te(e.editSpaceStore.myColorList,(a=>(pe(),Re(v,{key:a.id,onClick:t=>e.currentColorGroup=a.id},{default:we((()=>[Ce(Le(a.groupName),1)])),_:2},1032,["onClick"])))),128))])),_:1})])),default:we((()=>[xe("div",Sa,[De(s,null,{default:we((()=>[De(P)])),_:1})])])),_:1})]),xe("div",null,[De(A,{modelValue:e.searchColorValue,"onUpdate:modelValue":a[53]||(a[53]=a=>e.searchColorValue=a),style:{width:"100px"},size:"small",placeholder:"搜索颜色",onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,onKeyup:a[54]||(a[54]=Pe((a=>e.handleSearchColor(e.currentColorGroup)),["enter"]))},{prefix:we((()=>[De(s,{class:"el-input__icon"},{default:we((()=>[De($)])),_:1})])),_:1},8,["modelValue","onFocus","onBlur"])])]),xe("div",Ra,[(pe(!0),ve(Fe,null,Te(e.searchColorList.length?e.searchColorList:e.editSpaceStore.myColorList.find((a=>a.id==e.currentColorGroup)).list||[],((a,t)=>(pe(),ve("div",{key:t,style:Ie({backgroundColor:(null==a?void 0:a.color)||a}),class:"mycolor",title:(null==a?void 0:a.label)||"",onContextmenu:Ae((r=>e.handleMenu(r,"MyColorMenu",{color:(null==a?void 0:a.color)||a,gid:e.currentColorGroup,index:t})),["prevent"]),onClick:t=>e.brushColor=e.handleTransformColorAsHex((null==a?void 0:a.color)||a)},null,44,ba)))),128)),xe("div",Ma,[De(s,{color:"#808080",onClick:a[55]||(a[55]=a=>e.handleAdd(e.currentColorGroup))},{default:we((()=>[De(R)])),_:1})]),De(d,{content:"全部颜色 [Alt/⌥ + g]",placement:"bottom"},{default:we((()=>[xe("div",{class:"mycolor flex-center",style:{"background-color":"var(--el-bg-color-second)"},onClick:a[56]||(a[56]=(...a)=>e.handleOpenMyColorDialog&&e.handleOpenMyColorDialog(...a))},[De(s,{color:"#808080"},{default:we((()=>[De(E)])),_:1})])])),_:1})])])):Se("",!0),0===e.currentTool?(pe(),ve("div",Ia,[a[136]||(a[136]=xe("span",{class:"function-label"},"画笔大小",-1)),De(H,{modelValue:e.brushSize,"onUpdate:modelValue":a[57]||(a[57]=a=>e.brushSize=a),step:1,max:5,min:1,size:"small","show-stops":""},null,8,["modelValue"])])):1===e.currentTool?(pe(),ve("div",ka,[a[137]||(a[137]=xe("span",{class:"function-label"},"橡皮擦大小",-1)),De(H,{modelValue:e.eraserSize,"onUpdate:modelValue":a[58]||(a[58]=a=>e.eraserSize=a),step:1,max:5,min:1,size:"small","show-stops":""},null,8,["modelValue"])])):Se("",!0),xe("div",Fa,[xe("div",Ta,[a[138]||(a[138]=xe("span",{class:"function-label",style:{margin:"0",width:"100px"}},"画布像素",-1)),De(O,{modelValue:e.isCheckedRatio,"onUpdate:modelValue":a[59]||(a[59]=a=>e.isCheckedRatio=a),size:"small",label:"保持横纵比",onChange:e.handleChangeRatio,disabled:e.pinDouMode},null,8,["modelValue","onChange","disabled"])]),xe("div",Pa,[De(A,{modelValue:e.canvasWidth,"onUpdate:modelValue":a[60]||(a[60]=a=>e.canvasWidth=a),style:{"max-width":"100px"},type:"number",max:e.$config.canvasMaxSize,min:e.$config.canvasMinSize,size:"small",onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,disabled:e.pinDouMode||e.isScaling||e.selectData.selectList.length||7===e.currentTool,onChange:a[61]||(a[61]=a=>e.handleChangeCanvasSize(a,"canvasWidth"))},{prepend:we((()=>a[139]||(a[139]=[Ce("宽")]))),_:1},8,["modelValue","max","min","onFocus","onBlur","disabled"]),De(A,{modelValue:e.canvasHeight,"onUpdate:modelValue":a[62]||(a[62]=a=>e.canvasHeight=a),style:{"max-width":"100px"},type:"number",max:e.$config.canvasMaxSize,min:e.$config.canvasMinSize,onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,size:"small",disabled:e.pinDouMode||e.isScaling||e.selectData.selectList.length||7===e.currentTool,onChange:a[63]||(a[63]=a=>e.handleChangeCanvasSize(a,"canvasHeight"))},{prepend:we((()=>a[140]||(a[140]=[Ce("高")]))),_:1},8,["modelValue","max","min","onFocus","onBlur","disabled"])]),xe("div",$a,[De(O,{modelValue:e.isShowRuler,"onUpdate:modelValue":a[64]||(a[64]=a=>e.isShowRuler=a),size:"small",label:"显示标尺"},null,8,["modelValue"]),De(O,{modelValue:e.isShowReferenceLine,"onUpdate:modelValue":a[65]||(a[65]=a=>e.isShowReferenceLine=a),size:"small",label:"显示参考线"},null,8,["modelValue"]),De(O,{modelValue:e.isShowGridLine,"onUpdate:modelValue":a[66]||(a[66]=a=>e.isShowGridLine=a),size:"small",label:"显示网格线"},null,8,["modelValue"])]),Me(xe("div",Aa,[De(O,{modelValue:e.isHorizontal,"onUpdate:modelValue":a[67]||(a[67]=a=>e.isHorizontal=a),size:"small",label:"水平对称",disabled:e.pinDouMode,onChange:a[68]||(a[68]=a=>e.handleChangeBrushSymmetric(a,"isHorizontal"))},null,8,["modelValue","disabled"]),De(O,{modelValue:e.isVertical,"onUpdate:modelValue":a[69]||(a[69]=a=>e.isVertical=a),size:"small",label:"垂直对称",disabled:e.pinDouMode,onChange:a[70]||(a[70]=a=>e.handleChangeBrushSymmetric(a,"isVertical"))},null,8,["modelValue","disabled"]),De(O,{modelValue:e.isCenter,"onUpdate:modelValue":a[71]||(a[71]=a=>e.isCenter=a),size:"small",label:"中心对称",disabled:e.pinDouMode,onChange:a[72]||(a[72]=a=>e.handleChangeBrushSymmetric(a,"isCenter"))},null,8,["modelValue","disabled"])],512),[[ke,0===e.currentTool||1===e.currentTool]])]),Me(xe("div",Ea,[a[141]||(a[141]=xe("div",{class:"function-label"}," 容 差 ",-1)),De(W,{modelValue:e.tolerance,"onUpdate:modelValue":a[73]||(a[73]=a=>e.tolerance=a),min:0,max:200,size:"small"},null,8,["modelValue"])],512),[[ke,[2,4].includes(e.currentTool)||8===e.currentTool&&"quickSelect"===e.selectType]]),xe("div",Ha,[a[142]||(a[142]=xe("div",{class:"function-label"}," 图层透明度 ",-1)),De(W,{modelValue:e.layerAlpha,"onUpdate:modelValue":a[74]||(a[74]=a=>e.layerAlpha=a),min:0,max:100,size:"small",disabled:e.pinDouMode||7===e.currentTool,onChange:e.handleChangeLayerAlpha},null,8,["modelValue","disabled","onChange"])]),xe("div",Oa,[e.selectData.selectList.length?(pe(),ve("div",Wa,[De(N,{type:"success",size:"small",onClick:e.handleCopySelectData},{default:we((()=>a[143]||(a[143]=[Ce("复 制")]))),_:1,__:[143]},8,["onClick"]),De(N,{type:"danger",size:"small",onClick:e.handleRemoveSelect},{default:we((()=>a[144]||(a[144]=[Ce("删 除")]))),_:1,__:[144]},8,["onClick"]),De(N,{type:"primary",size:"small",onClick:e.handleCancelSelect},{default:we((()=>a[145]||(a[145]=[Ce("取消选择")]))),_:1,__:[145]},8,["onClick"])])):Se("",!0),9===e.currentTool&&e.scaleAreaData?(pe(),ve("div",Na,[De(N,{type:"danger",size:"small",onClick:e.handleCancelScale},{default:we((()=>[De(s,null,{default:we((()=>[De(_)])),_:1})])),_:1},8,["onClick"]),De(N,{type:"success",size:"small",onClick:e.handleFinishScale},{default:we((()=>[De(s,null,{default:we((()=>[De(B)])),_:1})])),_:1},8,["onClick"])])):Se("",!0)])]),e.drawRecord.length?(pe(),ve("div",_a,[xe("h1",Ba,[a[147]||(a[147]=Ce("图层面板 ")),xe("div",ja,[e.currentFrameLayerVisible?(pe(),Re(s,{key:0,style:{"margin-right":"15px"},class:"pointer",onClick:a[75]||(a[75]=a=>e.handleChangeLayerVisible(-1))},{default:we((()=>[De(j)])),_:1})):(pe(),Re(s,{key:1,style:{"margin-right":"15px"},class:"pointer",onClick:a[76]||(a[76]=a=>e.handleChangeLayerVisible(-1))},{default:we((()=>[De(Y)])),_:1})),De(d,{content:"合并图层 [Ctrl/⌘ + Alt/⌥ + h]",placement:"top"},{default:we((()=>[De(s,{style:{"margin-right":"15px"},class:"pointer",onClick:e.handleLayerMerge},{default:we((()=>[De(z)])),_:1},8,["onClick"])])),_:1}),De(d,{content:"新建图层 [Ctrl/⌘ + Alt/⌥ + t]",placement:"top"},{default:we((()=>[De(s,{style:{"margin-right":"10px"},class:"pointer",onClick:e.handleAddLayer},{default:we((()=>[De(X)])),_:1},8,["onClick"])])),_:1})])]),De(I,{"border-style":"dashed"}),xe("div",{ref:"layerBox",id:"layer-box",class:"scrollbar scrollY full-w layer-list",onDragstart:a[79]||(a[79]=a=>e.onDragStart(a,e.pinDouMode)),onDragover:a[80]||(a[80]=a=>e.onDragOver(a,"layerBox")),onDragend:a[81]||(a[81]=a=>e.onDragLayerEnd(a,"layerBox")),style:{height:"calc(100% - 50px)"}},[(pe(!0),ve(Fe,null,Te(e.drawRecord[e.currentFrameIndex].layer,((t,r)=>(pe(),ve("div",{draggable:"true","data-key":t.layerId,disabled:e.pinDouMode,"data-node":"LI",key:t.layerId,class:be(["layer-item flex-between pointer full-w",{active:e.currentLayerIndex===r,select:e.selectLayerList.includes(r)}]),style:{gap:"10px"},onContextmenu:Ae((a=>e.handleMenu(a,"LayerMenu",{layerData:t,index:r,currentFrameIndex:e.currentFrameIndex})),["prevent"]),onClick:a=>e.handleChangeLayer(r)},[xe("div",za,[xe("div",{class:"pointer layer-pic",onClick:Ae((a=>e.handleChangeLayerVisible(r)),["stop"])},[xe("img",{src:e.requireVisibleImg(t.isRender)},null,8,Va)],8,Xa),t.currentLayerImg?(pe(),ve("div",Ua,[xe("img",{draggable:"false",src:t.currentLayerImg},null,8,Ka)])):Se("",!0),e.currentEditLayer.index===r?(pe(),ve("div",Ja,[De(A,{modelValue:e.currentEditLayer.name,"onUpdate:modelValue":a[77]||(a[77]=a=>e.currentEditLayer.name=a),maxlength:10,onClick:Ae((e=>null),["stop"]),onBlur:e.handleEditLayerName,onKeyup:Pe(e.handleEditLayerName,["enter"]),placeholder:"请输入图层名称",size:"small"},null,8,["modelValue","onBlur","onKeyup"])])):(pe(),ve("div",{key:2,onDblclick:a=>e.handleDoubleClickLayer(r,t.layerName),title:t.layerName,class:"oneline"},Le(t.layerName),41,Ga))]),xe("div",qa,[t.isLock?(pe(),Re(s,{key:0,style:{"margin-right":"10px"},color:"#ff0000",class:"pointer",onClick:Ae((a=>e.handleLockLayer(r,!1)),["stop"])},{default:we((()=>[De(V)])),_:2},1032,["onClick"])):(pe(),Re(s,{key:1,style:{"margin-right":"10px"},class:"pointer",onClick:Ae((a=>e.handleLockLayer(r,!0)),["stop"])},{default:we((()=>[De(U)])),_:2},1032,["onClick"])),De(s,{style:{"margin-right":"10px"},class:"pointer",onClick:Ae((a=>e.handleCopyLayer(r)),["stop"])},{default:we((()=>[De(K)])),_:2},1032,["onClick"]),De(G,{title:"确认删除该图层？",width:"200",onConfirm:a=>e.handleDeleteLayer(r)},{reference:we((()=>[r!==e.drawRecord[e.currentFrameIndex].layer.length-1?(pe(),Re(s,{key:0,class:"pointer",onClick:a[78]||(a[78]=Ae((()=>{}),["stop"]))},{default:we((()=>[De(J)])),_:1})):Se("",!0)])),_:2},1032,["onConfirm"])])],42,Ya)))),128))],544)])):Se("",!0)])])),_:1})])),_:1}),(pe(),Re($e,{to:"body"},[De(Q,{ref:"MyColorDialog",onClose:e.addKeyBoardEvent,onDelete:a[82]||(a[82]=a=>e.currentColorGroup=1),onSelect:a[83]||(a[83]=a=>e.brushColor=a)},null,8,["onClose"]),De(ee,{onClose:e.addKeyBoardEvent,ref:"ReplaceColorDialog",onConfirm:e.handleConfirmReplaceColor},null,8,["onClose","onConfirm"]),e.exportVisible?(pe(),Re(ae,{key:0,loading:e.exportLoaidng,visible:e.exportVisible,isExportProject:e.isExportProject,canvasOptions:{canvasWidth:e.canvasWidth,canvasHeight:e.canvasHeight},onExport:e.handleExport,onClose:a[84]||(a[84]=a=>e.handleCloseDialog("exportVisible"))},null,8,["loading","visible","isExportProject","canvasOptions","onExport"])):Se("",!0),De(te,{ref:"PreviewAnimDialog"},null,512),De(re,{ref:"PindouDialog",canvasOptions:{width:e.canvasWidth,height:e.canvasHeight,isLargeCanvas:0},onBlockHighlight:e.handlePindouBlockHighlight,onClose:e.handleCloseDialog,onChange:e.handlePindouEvent,onReplace:e.handleReplacePindouColor,onHighlight:e.handlePindouHighlight,onSelect:e.handleChangeBrushColor,onRemoveKeyBoard:e.handleCancelKeyboardEvent,onAddKeyBoard:e.addKeyBoardEvent,onHide:a[85]||(a[85]=a=>e.isHidePindouMode=!0),onExportExcel:e.handleExportPindouToExcel,onSave:e.handleTransformColorToPindou,onExport:e.handleExportPindou},null,8,["canvasOptions","onBlockHighlight","onClose","onChange","onReplace","onHighlight","onSelect","onRemoveKeyBoard","onAddKeyBoard","onExportExcel","onSave","onExport"]),e.LayerMenu.visible?(pe(),Re(le,{key:1,visible:e.LayerMenu.visible,left:e.LayerMenu.left,top:e.LayerMenu.top,contextData:e.LayerMenu.contextData,onCopy:e.handleCopyLayerData,onPaste:e.handlePasteLayerData,onImport:e.handleImportImage,onExport:e.handleExportLayer},null,8,["visible","left","top","contextData","onCopy","onPaste","onImport","onExport"])):Se("",!0),e.MyColorMenu.visible?(pe(),Re(ne,{key:2,visible:e.MyColorMenu.visible,left:e.MyColorMenu.left,top:e.MyColorMenu.top,contextData:e.MyColorMenu.contextData,onCopy:a[86]||(a[86]=a=>e.handleCopyColor(a)),onEdit:e.handleEditMyColor,onDelete:e.handleDeleteMyColor},null,8,["visible","left","top","contextData","onEdit","onDelete"])):Se("",!0),De(oe,{ref:"LinmoModeDialog",onClose:e.handleCloseDialog,onUpload:a[87]||(a[87]=a=>e.linmoPhoto=a),onUpdate:a[88]||(a[88]=a=>e.linmoPhotoStyle=a),onColor:a[89]||(a[89]=a=>e.brushColor=a),onHide:a[90]||(a[90]=a=>e.isHideLinmoMode=!0),onLock:e.handleLinmoFitCanvas,onHigh:a[91]||(a[91]=a=>e.isHighPreview=a)},null,8,["onClose","onLock"]),e.importLayerVisible?(pe(),Re(se,{key:3,visible:e.importLayerVisible,onImport:e.handleImportImageLayer,onClose:a[92]||(a[92]=a=>e.handleCloseDialog("importLayerVisible"))},null,8,["visible","onImport"])):Se("",!0),De(he,{modelValue:e.addMyColorVisible,"onUpdate:modelValue":a[99]||(a[99]=a=>e.addMyColorVisible=a),width:"300",title:e.editMyColorMask?"修改颜色":"添加颜色","append-to-body":"",class:"z-dialog"},{footer:we((()=>[xe("div",et,[De(N,{onClick:a[98]||(a[98]=a=>e.addMyColorVisible=!1)},{default:we((()=>a[151]||(a[151]=[Ce("取 消")]))),_:1,__:[151]}),De(N,{type:"primary",onClick:e.handleAddColor},{default:we((()=>a[152]||(a[152]=[Ce("保 存")]))),_:1,__:[152]},8,["onClick"])])])),default:we((()=>[xe("div",Za,[De(ie,{modelValue:e.myColor,"onUpdate:modelValue":a[93]||(a[93]=a=>e.myColor=a),"show-alpha":""},null,8,["modelValue"]),De(de,{modelValue:e.myColorGroup,"onUpdate:modelValue":a[97]||(a[97]=a=>e.myColorGroup=a),placeholder:"选择分组",style:{width:"200px"}},{footer:we((()=>[e.isAddGroup?(pe(),ve(Fe,{key:1},[De(A,{modelValue:e.myGroupName,"onUpdate:modelValue":a[95]||(a[95]=a=>e.myGroupName=a),class:"option-input",placeholder:"请输入分组",size:"small",maxlength:"10"},null,8,["modelValue"]),xe("div",Qa,[De(N,{size:"small",onClick:a[96]||(a[96]=a=>{e.myGroupName="",e.isAddGroup=!1})},{default:we((()=>a[149]||(a[149]=[Ce("取消")]))),_:1,__:[149]}),De(N,{type:"primary",size:"small",onClick:e.addColorGroup},{default:we((()=>a[150]||(a[150]=[Ce("保存")]))),_:1,__:[150]},8,["onClick"])])],64)):(pe(),Re(N,{key:0,text:"",bg:"",size:"small",onClick:a[94]||(a[94]=a=>e.isAddGroup=!0)},{default:we((()=>a[148]||(a[148]=[Ce(" 新建分组 ")]))),_:1,__:[148]}))])),default:we((()=>[(pe(!0),ve(Fe,null,Te(e.editSpaceStore.myColorList,(e=>(pe(),Re(ce,{key:e.id,label:e.groupName,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])])),_:1},8,["modelValue","title"])]))],4)}],["__scopeId","data-v-48198e03"]]);export{at as default};
