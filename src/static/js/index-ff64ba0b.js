var e=Object.defineProperty,a=Object.defineProperties,t=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,s=(a,t,r)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[t]=r,o=(e,a)=>{for(var t in a||(a={}))l.call(a,t)&&s(e,t,a[t]);if(r)for(var t of r(a))n.call(a,t)&&s(e,t,a[t]);return e},i=(e,r)=>a(e,t(r));import{c,E as d,M as h,a as g,P as p,R as u,b as m,L as f,d as y,U as v,S as D,V as w,e as x,u as C,p as L,_ as S,f as b,g as k,h as R,i as I,j as M,k as A,l as F,m as T,n as P,o as E,q as B,r as $,s as O,t as H,v as N,w as W,x as Y,y as j,z,A as V,B as X,C as U,D as K,F as J,G as _,H as G,I as q,J as Z,K as Q,N as ee,O as ae,Q as te,T as re,W as le,X as ne,Y as se,Z as oe,$ as ie,a0 as ce,a1 as de,a2 as he,a3 as ge,a4 as pe,a5 as ue,a6 as me,a7 as fe,a8 as ye,a9 as ve,aa as De,ab as we,ac as xe,ad as Ce,ae as Le,af as Se,ag as be,ah as ke,ai as Re,aj as Ie,ak as Me,al as Ae,am as Fe,an as Te,ao as Pe,ap as Ee,aq as Be}from"./pica-e7209953.js";import{r as $e,aS as Oe,aa as He,D as Ne,ag as We,E as Ye,a7 as je,d as ze,A as Ve,t as Xe,aT as Ue,c as Ke,V as Je,o as _e,az as Ge,aA as qe,N as Ze,a8 as Qe,K as ea,aU as aa,aV as ta,aW as ra,u as la,aX as na,aY as sa,aZ as oa,a_ as ia,a$ as ca,b0 as da,b1 as ha,ae as ga,b2 as pa,b3 as ua,b4 as ma,b5 as fa,b6 as ya,aO as va,b7 as Da,b8 as wa,g as xa,C as Ca,b9 as La,ba as Sa,_ as ba,b as ka,a2 as Ra,l as Ia,n as Ma,h as Aa,f as Fa,k as Ta,T as Pa,s as Ea,e as Ba,j as $a,z as Oa,v as Ha,q as Na,O as Wa,P as Ya,F as ja,p as za,ah as Va,X as Xa,x as Ua,y as Ka}from"./index-371f133f.js";import{W as Ja}from"./worker-cecf3bdf.js";import{r as _a}from"./xlsx-eef54bab.js";import"./windowHeader-812834b0.js";import"./useWindow-4404eab5.js";var Ga=ze({name:"work",components:{MyColorDialog:h,ExportDialog:g,PreviewAnimDialog:p,ReplaceColorDialog:u,PindouDialog:m,LayerMenu:f,LinmoModeDialog:y,UploadImageLayerDialog:v,"sketch-picker":D,VueDragScale:w,MyColorMenu:x},props:{},emits:[],setup(e,a){const{proxy:t}=xa(),r=function(){const e=$e({canvasWidth:0,canvasHeight:0}),a={handleFilter(t,r,l,n,s,o,i,c){e.canvasHeight=s,e.canvasWidth=n,1===t?a.transformBlackAndWhite(r,l,o):2===t?a.transformReverse(r,l,o):3===t&&a.transformBGRA(r,l,o)},transformBlackAndWhite(e,a,t){let r=Oe(a.selectMapList)?e.layerNewData:a.selectMapList,l=Object.keys(r);for(let n=0;n<l.length;n++){let t=l[n],s=He(t),o=(s[0]+s[1]+s[2])/3;s[0]=o,s[1]=o,s[2]=o;let i=Ne(s);if(i!==t&&(r[i]=r[l[n]],delete r[l[n]],!Oe(a.selectMapList))){if(e.layerNewData[i])for(const[a,l]of r[i])e.layerNewData[t].delete(a),e.layerNewData[i].set(a,l);else{e.layerNewData[i]=new Map;for(const[a,l]of r[i])e.layerNewData[t].delete(a),e.layerNewData[i].set(a,l)}e.layerNewData[t].size||delete e.layerNewData[t]}}t(r,e.layerNewData)},transformReverse(e,a,t){let r=Oe(a.selectMapList)?e.layerNewData:a.selectMapList,l=Object.keys(r);for(let n=0;n<l.length;n++){let t=l[n],s=He(t);s[0]=255-s[0],s[1]=255-s[1],s[2]=255-s[2];let o=Ne(s);if(o!==t&&(r[o]=r[l[n]],delete r[l[n]],!Oe(a.selectMapList))){if(e.layerNewData[o])for(const[a,l]of r[o])e.layerNewData[t].delete(a),e.layerNewData[o].set(a,l);else{e.layerNewData[o]=new Map;for(const[a,l]of r[o])e.layerNewData[t].delete(a),e.layerNewData[o].set(a,l)}e.layerNewData[t].size||delete e.layerNewData[t]}}t(r)},transformBGRA(e,a,t){let r=Oe(a.selectMapList)?e.layerNewData:a.selectMapList,l=Object.keys(r);for(let n=0;n<l.length;n++){let t=l[n],s=He(t),o=s[0],i=s[2];s[0]=i,s[2]=o;let c=Ne(s);if(c!==t&&(r[c]=r[l[n]],delete r[l[n]],!Oe(a.selectMapList))){if(e.layerNewData[c])for(const[a,l]of r[c])e.layerNewData[t].delete(a),e.layerNewData[c].set(a,l);else{e.layerNewData[c]=new Map;for(const[a,l]of r[c])e.layerNewData[t].delete(a),e.layerNewData[c].set(a,l)}e.layerNewData[t].size||delete e.layerNewData[t]}}t(r)},transformIndexColor(e,a,t,r,l){let n=a.length>0?a:e;l.postMessage({type:8,currentIndexColorList:JSON.parse(JSON.stringify(c[r])),variables:JSON.parse(JSON.stringify(n))}),l.onmessage=e=>{t(e.data.variables)}}};return o({},a)}(),l=function(){const e=$e({excelPinDouOptions:{1:{numberFontSize:4,rulerFontSize:6,pointFontSize:12,colWidth:1.36,rowHeight:7.9},2:{numberFontSize:6,rulerFontSize:10,pointFontSize:12,colWidth:2.66,rowHeight:14.8}}}),a={convertToExcelPosition({x:e,y:a}){let t="",r=e+1;for(;r>0;){let e=r%26;0===e?(t="Z"+t,r=Math.floor(r/26)-1):(t=String.fromCharCode(64+e)+t,r=Math.floor(r/26))}return t+(a+1)},handleExcelToPixel(e,t,r,l){if(!e)return r("文件不存在");const n=new FileReader;n.onload=function(e){const r=new Uint8Array(e.target.result),n=_a(r,{type:"array",cellStyles:!0});let s=[],o=n.SheetNames[0];const i=n.Sheets[o];for(let t=0;t<l.canvasHeight;t++)for(let e=0;e<l.canvasWidth;e++){let r=[];r[0]=e,r[1]=t;let l="",n=a.convertToExcelPosition({x:e,y:t});i[n]&&i[n].s.fgColor?(l="#"+i[n].s.fgColor.rgb+"ff",r[2]=l.toLocaleLowerCase()):(l="#00000000",r[2]=l),s.push(r)}t(s)},n.readAsArrayBuffer(e)},async handlePixelToExcel(e,a,t,r){const l=new d.Workbook;l.creator="by 像素格子",l.lastModifiedBy="by 像素格子";const n={};for(let s=0;s<e.length;s++){n[`frame${s+1}`]=l.addWorksheet(`frame${s+1}`);let t=[],r=[],o=0;for(let l=e[s].layer.length-1;l>=0;l--)if(e[s].layer[l].isRender){for(let n=0;n<a.canvasHeight;n++){0===o&&(r[n]=[],t[n]=[]);for(let i=0;i<a.canvasWidth;i++){let c=e[s].layer[l].layerData[i+n*a.canvasWidth][2];0===o?(r[n][i]=c,t[n][i]=""):r[n][i]&&"#00000000"!==c&&(r[n][i]=c)}}o++}for(let e=0;e<t.length;e++)n[`frame${s+1}`].addRow(t[e]);for(let e=0;e<t[0].length;e++)n[`frame${s+1}`]._columns[e].width=3;n[`frame${s+1}`].eachRow(((e,t)=>{e.height=18,e.eachCell(((e,l)=>{if(a.isShowGrid){let t="FF",r=a.gridColor.slice(1).toUpperCase();e.border={top:{style:"thin",color:{argb:`${t}${r}`}},left:{style:"thin",color:{argb:`${t}${r}`}},bottom:{style:"thin",color:{argb:`${t}${r}`}},right:{style:"thin",color:{argb:`${t}${r}`}}}}let n=r[t-1][l-1];if("#00000000"!==n){let a=n.slice(7).toUpperCase(),t=n.slice(1,7).toUpperCase();e.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${a}${t}`}}}else if(a.isShowGrid){let t=a.gridBackgroundColor,r=t.slice(7).toUpperCase(),l=t.slice(1,7).toUpperCase();e.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${r}${l}`}}}}))}))}l.xlsx.writeBuffer().then((e=>{let r=new Blob([e],{type:"application/octet-stream"});We.saveAs(r,a.filename+".xlsx"),t("导出成功")})).catch((e=>{r("导出失败")}))},async handlePindouToExcel(t,r,l,n,s){let{isShowGrid:o,isShowRulers:i,isShowCirclePoint:c,isShowRectPoint:h,rulersBackgroundColor:g,pointColor:p,rulersColor:u,gridColor:m,canvasWidth:f,canvasHeight:y,filename:v,excelSize:D,isShowTongji:w,isShowBrand:x,brandName:C,background:L}=l,{variables:S}=t;g=Ne(Ye(g)),L=Ne(Ye(L));const b=new d.Workbook;b.creator="by 像素格子",b.lastModifiedBy="by 像素格子";const k=b.addWorksheet("拼豆");let R=[],I=[],M=0;for(let e=S.length-1;e>=0;e--)if(S[e].isRender){for(let a=0;a<y;a++){0===M&&(I[a]=[],R[a]=[]);for(let t=0;t<f;t++){let r=S[e].layerData[t+a*f][2],l=S[e].layerData[t+a*f][3]||"";0===M?(I[a][t]=r,R[a][t]=""!==l?l:c?"•":h?"▪":""):(I[a][t]&&"#00000000"!==r&&(I[a][t]=r),R[a][t]&&""!==l&&(R[a][t]=l))}}M++}if(i){let e=[];for(let a=0;a<f+2;a++){let t="";t=0===a||a===f+1?"":a+"",e.push(t)}k.addRow(e)}for(let e=0;e<R.length;e++){let a=String(e+1);k.addRow([a,...R[e],a])}if(i){let e=[];for(let a=0;a<f+2;a++){let t="";t=0===a||a===f+1?"":a+"",e.push(t)}k.addRow(e)}for(let a=0;a<R[0].length+2;a++)k._columns[a].width=e.excelPinDouOptions[D].colWidth;if(k.eachRow(((a,t)=>{a.height=e.excelPinDouOptions[D].rowHeight,!i||1!==t&&t!==y+2?a.eachCell(((a,r)=>{if(a.alignment={vertical:"middle",horizontal:"center"},o){let e="FF"+m.slice(1,7).toUpperCase();a.border={top:{style:"thin",color:{argb:`${e}`}},left:{style:"thin",color:{argb:`${e}`}},bottom:{style:"thin",color:{argb:`${e}`}},right:{style:"thin",color:{argb:`${e}`}}}}if(1===r||r===f+2){let t=g;if("#00000000"!==t){let e=t.slice(7).toUpperCase(),r=t.slice(1,7).toUpperCase();a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${e}${r}`}}}let r="FF"+u.slice(1,7).toUpperCase();a.font={name:"Microsoft YaHei UI",color:{argb:r},size:e.excelPinDouOptions[D].rulerFontSize}}else{let l=L.slice(7).toUpperCase(),n=L.slice(1,7).toUpperCase();a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${l}${n}`}};let s=I[t-2][r-2],o=R[t-2][r-2];if("#00000000"!==s){let t=s.slice(7).toUpperCase(),r=s.slice(1,7).toUpperCase();if(a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${t}${r}`}},o){let t=e.excelPinDouOptions[D].numberFontSize,r="#FFF"===je(s)?"FFFFFFFF":"FF000000";o.length>=4&&(t-=1),a.font={name:"Microsoft YaHei UI",color:{argb:r},size:t}}}else{let t="FF"+p.slice(1,7).toUpperCase();a.font={name:"Microsoft YaHei UI",color:{argb:t},size:e.excelPinDouOptions[D].pointFontSize}}}})):a.eachCell(((a,t)=>{if(o){let e="FF"+m.slice(1,7).toUpperCase();a.border={top:{style:"thin",color:{argb:`${e}`}},left:{style:"thin",color:{argb:`${e}`}},bottom:{style:"thin",color:{argb:`${e}`}},right:{style:"thin",color:{argb:`${e}`}}}}a.alignment={vertical:"middle",horizontal:"center"};let r=g;if("#00000000"!==r){let e=r.slice(7).toUpperCase(),t=r.slice(1,7).toUpperCase();a.fill={type:"pattern",pattern:"solid",fgColor:{argb:`${e}${t}`}}}let l="FF"+u.slice(1,7).toUpperCase();a.font={name:"Microsoft YaHei UI",color:{argb:l},size:e.excelPinDouOptions[D].rulerFontSize}}))})),x){k.addRow([C]),k.lastRow.height=12;let e=a.convertToExcelPosition({x:k.columnCount-1,y:k.rowCount-1});k.mergeCells(`A${k.rowCount}:${e}`);const t=k.getCell(`A${y+3}`);t.font={name:"Arial",size:8,bold:!0,color:{argb:"FF101010"}},t.alignment={vertical:"middle",horizontal:"center"},t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFF00"}}}if(w){let e=Math.floor((f+2)/2),t=Math.ceil(r.size/e),l=Array.from(r),n=[],s=[],o=[],i=0;for(let a=0;a<t;a++){n[a]=[],s[a]=[],o[a]=[];for(let t=0;t<2*e&&!(i>l.length-1);t+=2)n[a][t]=l[i][1][0],o[a][t]=l[i][1][1]+"",s[a][t]=l[i][0],n[a][t+1]="",o[a][t+1]="",s[a][t+1]="",i++;k.addRow([...s[a]]),k.addRow([...o[a]])}const c=k.rowCount;for(let r=0;r<c-(y+3);r++)for(let e=0;e<f+2;e+=2){let t=y+3+r+1,l=a.convertToExcelPosition({x:e,y:t-1}),n=a.convertToExcelPosition({x:e+1,y:t-1});if(e+1>f+2-1)break;k.mergeCells(`${l}:${n}`)}for(let a=0;a<c-(y+3);a++){let e=y+3+(a+1),t=k.getRow(e);t.height=13,t.eachCell(((e,t)=>{if(e.alignment={vertical:"middle",horizontal:"center"},a%2==0&&t%2!=0){if(t>n[a/2].length)return;let r=t-1,l=n[a/2][r],o=s[a/2][r],i=l.slice(1,7).toUpperCase();if(e.fill={type:"pattern",pattern:"solid",fgColor:{argb:`FF${i}`}},o){let a=6,t="#FFF"===je(l)?"FFFFFFFF":"FF000000";o.length>=4&&(a-=1),e.font={name:"Microsoft YaHei UI",color:{argb:t},size:a}}}let r="ffffff";const l=e.fill;l&&l.fgColor&&(r=l.fgColor.argb.slice(2));let o="#FFF"===je(r)?"FFFFFFFF":"FF000000";e.font={name:"Microsoft YaHei UI",color:{argb:o},size:6}}))}}k.addRow(["By 像素格子"]),k.lastRow.height=15;let A=a.convertToExcelPosition({x:k.columnCount-1,y:k.rowCount});k.mergeCells(`A${k.rowCount}:${A}`);const F=k.getCell(`A${k.rowCount}`);F.font={name:"Arial",size:10,bold:!0,color:{argb:"FFFFFFFF"}},F.alignment={vertical:"middle",horizontal:"center"},F.fill={type:"pattern",pattern:"solid",fgColor:{argb:"0052D9"}},b.xlsx.writeBuffer().then((e=>{let a=new Blob([e],{type:"application/octet-stream"});We.saveAs(a,v+".xlsx"),n("导出成功")})).catch((e=>{s("导出失败")}))}};return o({},a)}(),n=C(),s=Ve(),h=(L||S)();let g=$e(i(o({},Xe(n.data)),{projectData:Ue(),emptyColor:"#00000000",brushColorVisible:!1,shapeFillColorVisible:!1,baseCanvas:null,bgCanvas:null,canvas:null,realCanvas:null,gridCanvas:null,moveCanvas:null,moveBoxDom:null,ctx0:null,ctx1:null,ctx2:null,ctx3:null,ctx4:null,ctx5:null,isDrawing:!1,isErasering:!1,isDrawShape:!1,isMoving:!1,isSelecting:!1,isSelectDraging:!1,isCopy:!1,isScale:!1,shapeFillColor:"#000000ff",brushColor:"#000000ff",brushSize:1,eraserSize:1,canvasWidth:32,canvasHeight:32,scale:1,isCheckedRatio:!0,isShowReferenceLine:!1,isShowRuler:!1,widthHeightRatio:1,drawAreaList:[],currentTool:0,drawRecord:[],drawShapeList:[],gridInfo:"[]",currentDrawShape:"rect",currentDrawTransform:"hReverse",historyRecord:[],historyMaxLength:10,currentHistoryIndex:0,historyTimer:null,lastX:0,lastY:0,currentFrameIndex:0,currentLayerIndex:0,currentFrameId:0,currentLayerId:0,currentFrameLayerVisible:!0,currentEditLayer:{index:-1,name:""},FrameTimer:null,maxFrame:15,maxLayer:30,exportVisible:!1,exportLoaidng:!1,importLayerVisible:!1,loading:!0,isSpace:!1,isShift:!1,isDragging:!1,dragData:{x:0,y:0},canvasBeginPos:{x:0,y:0,centerX:0,centerY:0},moveData:{x:0,y:0,col:0,row:0,diffCol:0,diffRow:0,centerX:0,centerY:0,transformX:0,transformY:0,list:[],mapList:{},bitmap:"",isMoving:!1},selectData:{selectLayerId:0,x:-1,y:-1,endX:-1,endY:-1,isCancelSelect:!0,originList:[],selectList:[],selectOriginList:[],copyList:[],selectMapList:{},copySelectMapList:null},selectType:"select",previewLoading:!1,selectActiveColor:"#3100FC",isExpandColorSelector:!0,colorStatList:{},worker:null,isExportProject:!1,AnimationFrameId_1:null,zIndex:{max:13,min:8},isSaveProject:!0,pinDouMode:!1,pinDouDrawMode:!1,pinDouData:null,tolerance:0,curvature:4,curveType:{isPress:!1,pressKey:"0"},curveEndPos:[],isHorizontal:!1,isVertical:!1,isCenter:!1,drawList:[],removeDrawList:[],LayerMenu:{visible:!1,top:0,left:0,contextData:null},selectLayerList:[],pindouHighlight:null,isHidePindouMode:!1,pindouBrand:"mard-v2",isScaling:!1,scaleWhitePointPos:[],scaleAreaData:null,scaleRatio:0,emptyLayerData:[],exportStyleOptions:{isShowGrid:!1,gridBackgroundColor:"#ffffffff",gridColor:"#808080ff",gridSize:50},layerAlpha:100,isHideLinmoMode:!1,linmoMode:!1,linmoPhoto:null,linmoPhotoStyle:{width:"200px",height:"200px",transform:"translate3d(0px, 0px, 10px) rotate(0deg) scale(1, 1)",opacity:1,zIndex:0,display:"none",transformOrigin:"center center"},linmoPhotoDom:null,dragLinmoPhoto:{enable:!1,startX:0,startY:0,translateX:0,translateY:0},scaleTimer:null,canvasStyle:{transform:"translate3d(0, 0, 10px) scale(1)",transformOrigin:"center center"},isShowGridLine:!1,pindouScaleValue:0,drawAreaGridColor:{light:["rgba(100, 100, 100, 0.5)","rgba(0, 0, 0, 0.5)"],dark:["rgba(150, 150, 150, 0.5)","rgba(100, 100, 100, 0.5)"]},canvasRealTop:0,canvasRealLeft:0,isLockCanvas:!1,isHighPreview:!1,linmoFitCanvasTimer:null,mouseDrawData:{startX:0,startY:0},drawShapeData:{list:[],maxX:0,maxY:0,minX:-1,minY:-1},historyLayerIndexRecord:[0],historyLayerNameIndex:[0],historyFrameIndexRecord:[0],drawAreaGridCanvas:null,layerGridImage:null,pindouHighlightOptions:null}));const p={requireIcon:Ke((()=>e=>s.themeValue?new URL({"../../assets/light/ai.png":k,"../../assets/light/brush.png":R,"../../assets/light/bucket.png":I,"../../assets/light/circle.png":M,"../../assets/light/clear.png":A,"../../assets/light/color.png":F,"../../assets/light/copy.png":T,"../../assets/light/cReverse.png":P,"../../assets/light/crop.png":E,"../../assets/light/curve.png":B,"../../assets/light/eraser.png":$,"../../assets/light/fillCircle.png":O,"../../assets/light/fillRect.png":H,"../../assets/light/filter.png":N,"../../assets/light/hidden.png":W,"../../assets/light/hReverse.png":Y,"../../assets/light/line.png":j,"../../assets/light/magicStick.png":z,"../../assets/light/more.png":V,"../../assets/light/move.png":X,"../../assets/light/nsz.png":U,"../../assets/light/pindou.png":K,"../../assets/light/quickSelect.png":J,"../../assets/light/rangeSelect.png":_,"../../assets/light/rect.png":G,"../../assets/light/rotate.png":q,"../../assets/light/scale.png":Z,"../../assets/light/select.png":Q,"../../assets/light/sprite.png":ee,"../../assets/light/straw.png":ae,"../../assets/light/visible.png":te,"../../assets/light/vReverse.png":re}[`../../assets/light/${e}.png`],self.location).href:new URL({"../../assets/dark/ai.png":le,"../../assets/dark/brush.png":ne,"../../assets/dark/bucket.png":se,"../../assets/dark/circle.png":oe,"../../assets/dark/clear.png":ie,"../../assets/dark/color.png":ce,"../../assets/dark/copy.png":de,"../../assets/dark/cReverse.png":he,"../../assets/dark/crop.png":ge,"../../assets/dark/curve.png":pe,"../../assets/dark/eraser.png":ue,"../../assets/dark/fillCircle.png":me,"../../assets/dark/fillRect.png":fe,"../../assets/dark/filter.png":ye,"../../assets/dark/hidden.png":ve,"../../assets/dark/hReverse.png":De,"../../assets/dark/line.png":we,"../../assets/dark/magicStick.png":xe,"../../assets/dark/more.png":Ce,"../../assets/dark/move.png":Le,"../../assets/dark/nsz.png":Se,"../../assets/dark/pindou.png":be,"../../assets/dark/quickSelect.png":ke,"../../assets/dark/rangeSelect.png":Re,"../../assets/dark/rect.png":Ie,"../../assets/dark/rotate.png":Me,"../../assets/dark/scale.png":Ae,"../../assets/dark/select.png":Fe,"../../assets/dark/sprite.png":Te,"../../assets/dark/straw.png":Pe,"../../assets/dark/visible.png":Ee,"../../assets/dark/vReverse.png":Be}[`../../assets/dark/${e}.png`],self.location).href)),requireShapeImg:Ke((()=>s.themeValue?new URL({"../../assets/light/ai.png":k,"../../assets/light/brush.png":R,"../../assets/light/bucket.png":I,"../../assets/light/circle.png":M,"../../assets/light/clear.png":A,"../../assets/light/color.png":F,"../../assets/light/copy.png":T,"../../assets/light/cReverse.png":P,"../../assets/light/crop.png":E,"../../assets/light/curve.png":B,"../../assets/light/eraser.png":$,"../../assets/light/fillCircle.png":O,"../../assets/light/fillRect.png":H,"../../assets/light/filter.png":N,"../../assets/light/hidden.png":W,"../../assets/light/hReverse.png":Y,"../../assets/light/line.png":j,"../../assets/light/magicStick.png":z,"../../assets/light/more.png":V,"../../assets/light/move.png":X,"../../assets/light/nsz.png":U,"../../assets/light/pindou.png":K,"../../assets/light/quickSelect.png":J,"../../assets/light/rangeSelect.png":_,"../../assets/light/rect.png":G,"../../assets/light/rotate.png":q,"../../assets/light/scale.png":Z,"../../assets/light/select.png":Q,"../../assets/light/sprite.png":ee,"../../assets/light/straw.png":ae,"../../assets/light/visible.png":te,"../../assets/light/vReverse.png":re}[`../../assets/light/${g.currentDrawShape}.png`],self.location).href:new URL({"../../assets/dark/ai.png":le,"../../assets/dark/brush.png":ne,"../../assets/dark/bucket.png":se,"../../assets/dark/circle.png":oe,"../../assets/dark/clear.png":ie,"../../assets/dark/color.png":ce,"../../assets/dark/copy.png":de,"../../assets/dark/cReverse.png":he,"../../assets/dark/crop.png":ge,"../../assets/dark/curve.png":pe,"../../assets/dark/eraser.png":ue,"../../assets/dark/fillCircle.png":me,"../../assets/dark/fillRect.png":fe,"../../assets/dark/filter.png":ye,"../../assets/dark/hidden.png":ve,"../../assets/dark/hReverse.png":De,"../../assets/dark/line.png":we,"../../assets/dark/magicStick.png":xe,"../../assets/dark/more.png":Ce,"../../assets/dark/move.png":Le,"../../assets/dark/nsz.png":Se,"../../assets/dark/pindou.png":be,"../../assets/dark/quickSelect.png":ke,"../../assets/dark/rangeSelect.png":Re,"../../assets/dark/rect.png":Ie,"../../assets/dark/rotate.png":Me,"../../assets/dark/scale.png":Ae,"../../assets/dark/select.png":Fe,"../../assets/dark/sprite.png":Te,"../../assets/dark/straw.png":Pe,"../../assets/dark/visible.png":Ee,"../../assets/dark/vReverse.png":Be}[`../../assets/dark/${g.currentDrawShape}.png`],self.location).href)),requireTransformImg:Ke((()=>s.themeValue?new URL({"../../assets/light/ai.png":k,"../../assets/light/brush.png":R,"../../assets/light/bucket.png":I,"../../assets/light/circle.png":M,"../../assets/light/clear.png":A,"../../assets/light/color.png":F,"../../assets/light/copy.png":T,"../../assets/light/cReverse.png":P,"../../assets/light/crop.png":E,"../../assets/light/curve.png":B,"../../assets/light/eraser.png":$,"../../assets/light/fillCircle.png":O,"../../assets/light/fillRect.png":H,"../../assets/light/filter.png":N,"../../assets/light/hidden.png":W,"../../assets/light/hReverse.png":Y,"../../assets/light/line.png":j,"../../assets/light/magicStick.png":z,"../../assets/light/more.png":V,"../../assets/light/move.png":X,"../../assets/light/nsz.png":U,"../../assets/light/pindou.png":K,"../../assets/light/quickSelect.png":J,"../../assets/light/rangeSelect.png":_,"../../assets/light/rect.png":G,"../../assets/light/rotate.png":q,"../../assets/light/scale.png":Z,"../../assets/light/select.png":Q,"../../assets/light/sprite.png":ee,"../../assets/light/straw.png":ae,"../../assets/light/visible.png":te,"../../assets/light/vReverse.png":re}[`../../assets/light/${g.currentDrawTransform}.png`],self.location).href:new URL({"../../assets/dark/ai.png":le,"../../assets/dark/brush.png":ne,"../../assets/dark/bucket.png":se,"../../assets/dark/circle.png":oe,"../../assets/dark/clear.png":ie,"../../assets/dark/color.png":ce,"../../assets/dark/copy.png":de,"../../assets/dark/cReverse.png":he,"../../assets/dark/crop.png":ge,"../../assets/dark/curve.png":pe,"../../assets/dark/eraser.png":ue,"../../assets/dark/fillCircle.png":me,"../../assets/dark/fillRect.png":fe,"../../assets/dark/filter.png":ye,"../../assets/dark/hidden.png":ve,"../../assets/dark/hReverse.png":De,"../../assets/dark/line.png":we,"../../assets/dark/magicStick.png":xe,"../../assets/dark/more.png":Ce,"../../assets/dark/move.png":Le,"../../assets/dark/nsz.png":Se,"../../assets/dark/pindou.png":be,"../../assets/dark/quickSelect.png":ke,"../../assets/dark/rangeSelect.png":Re,"../../assets/dark/rect.png":Ie,"../../assets/dark/rotate.png":Me,"../../assets/dark/scale.png":Ae,"../../assets/dark/select.png":Fe,"../../assets/dark/sprite.png":Te,"../../assets/dark/straw.png":Pe,"../../assets/dark/visible.png":Ee,"../../assets/dark/vReverse.png":Be}[`../../assets/dark/${g.currentDrawTransform}.png`],self.location).href)),requireSelectImg:Ke((()=>s.themeValue?new URL({"../../assets/light/ai.png":k,"../../assets/light/brush.png":R,"../../assets/light/bucket.png":I,"../../assets/light/circle.png":M,"../../assets/light/clear.png":A,"../../assets/light/color.png":F,"../../assets/light/copy.png":T,"../../assets/light/cReverse.png":P,"../../assets/light/crop.png":E,"../../assets/light/curve.png":B,"../../assets/light/eraser.png":$,"../../assets/light/fillCircle.png":O,"../../assets/light/fillRect.png":H,"../../assets/light/filter.png":N,"../../assets/light/hidden.png":W,"../../assets/light/hReverse.png":Y,"../../assets/light/line.png":j,"../../assets/light/magicStick.png":z,"../../assets/light/more.png":V,"../../assets/light/move.png":X,"../../assets/light/nsz.png":U,"../../assets/light/pindou.png":K,"../../assets/light/quickSelect.png":J,"../../assets/light/rangeSelect.png":_,"../../assets/light/rect.png":G,"../../assets/light/rotate.png":q,"../../assets/light/scale.png":Z,"../../assets/light/select.png":Q,"../../assets/light/sprite.png":ee,"../../assets/light/straw.png":ae,"../../assets/light/visible.png":te,"../../assets/light/vReverse.png":re}[`../../assets/light/${g.selectType}.png`],self.location).href:new URL({"../../assets/dark/ai.png":le,"../../assets/dark/brush.png":ne,"../../assets/dark/bucket.png":se,"../../assets/dark/circle.png":oe,"../../assets/dark/clear.png":ie,"../../assets/dark/color.png":ce,"../../assets/dark/copy.png":de,"../../assets/dark/cReverse.png":he,"../../assets/dark/crop.png":ge,"../../assets/dark/curve.png":pe,"../../assets/dark/eraser.png":ue,"../../assets/dark/fillCircle.png":me,"../../assets/dark/fillRect.png":fe,"../../assets/dark/filter.png":ye,"../../assets/dark/hidden.png":ve,"../../assets/dark/hReverse.png":De,"../../assets/dark/line.png":we,"../../assets/dark/magicStick.png":xe,"../../assets/dark/more.png":Ce,"../../assets/dark/move.png":Le,"../../assets/dark/nsz.png":Se,"../../assets/dark/pindou.png":be,"../../assets/dark/quickSelect.png":ke,"../../assets/dark/rangeSelect.png":Re,"../../assets/dark/rect.png":Ie,"../../assets/dark/rotate.png":Me,"../../assets/dark/scale.png":Ae,"../../assets/dark/select.png":Fe,"../../assets/dark/sprite.png":Te,"../../assets/dark/straw.png":Pe,"../../assets/dark/visible.png":Ee,"../../assets/dark/vReverse.png":Be}[`../../assets/dark/${g.selectType}.png`],self.location).href)),requireVisibleImg:Ke((()=>e=>e?s.themeValue?new URL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAwNJREFUeF7tmU2IjVEYx3//nYViJRbKCgtfxQIpasosDLFgMTGUMmQlWVGULdn5mJKPSWpmQUhRsvAxKVOSUjYsJsXKwsJC/jq69M51Z+577r3vNLdznnq7i3uej/d3nuec85xXJC5K/P3JAHIGJE4gl0DiCZAXwVwCuQQSJ5BLIPEEyLtALoFcAjNAwPYSYAuwGVgOzC88IYJvhecd8BgYkzRRdXiVlYDtVcAOYBuwvsUXGQMeAvckvW3RxrRqHQdg+yCwB9ja4YBDVoxIutpJux0DYLsXOAaE3yrlEXBBUvhtW9oGYHsecB4IMz+TEjLhpKQv7ThtC4DtlcA1YG07QbSh+wkYlBTKoyVpGYDtQ8CVSK/fw4IGvAfeAOPAL2A1EBbN8OwG5kTaPSHpXKTOn+EtAbB9Bjgd6fAlcFRSePEpxXYPcBFYGmm/X9LtSJ14ALaPA7G0L0s6EhOc7ZAp22N0wu4jaTRGJyoDbO8E7sQ4AO5LCueBaLF9CTgcqbhL0t2yOqUB2F4APAFWlDUOfJC0rH687X212d0A/ASeAc8lDTUY+wLYGOEznCR7JH0toxMDICx4YeErKz+APkkB2j+xPVJb6BrZGZe0rm78mhqguWUdA0OSBsuMLwXA9n7gehmDhTHDkgbqXuZ1iS1zVFI4SRah3QL6I/0fkHSjmU5ZACFFNzUzVvf/pK0pctsckDT8157tU8DZSP//ZVMj/aYAbIdm5kGk8zC8t3hAsX0TCLVfRiZlge2+sJiWUawbs1dSyJ4ppQyAp7VWNtb/wuIx1fZHILTFZWRC0uJCBiwCPpdRrBvzStK0nWgG0Ixq8iUQANlOdxGsAUh7G6xBSPcgVAOQ9lG4BiHdZqiwJ6fbDhcgpHshUoCQ7pVYAUK6l6IFCOleixeP0cl+GKnvJZL9NNYARJofRxt1l0l+Hm/WZs+W/5teiMyWQKuKIwOoimy32M0Z0C0zVVWcOQOqItstdnMGdMtMVRVnzoCqyHaL3ZwB3TJTVcWZM6Aqst1i9zeYIGJQFMquqwAAAABJRU5ErkJggg==",self.location).href:new URL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAtFJREFUeF7t2T/oVEcQwPGPnYWglWghpIoWiQpaJBKIIGgRE7TQQvwHAf+QSsQqgoKtYuc/kCSKCFooKoKCWPgPQUFEEGy0CEJSWVikCCGMvIPzeXq7d7+nnLsDjytuZ3bed2dmd/ZNU7hMK/z9VQA1AgonUFOg8ACoRbCmQE2BwgnUFCg8AOouUFOgpsDHIfAFluN7LMCsvic8eNX3PMF13MOfXbvXZQosxE/4Ad+M+CIB4Sou4fGINj6o1gWAn7EeK6fY4YiKczg5lXanEsAq7EL8dinXcBjxO7ZMBYCZOIRY+Y8pEQm/4q9xJh0XwNf4DUvGcWIM3RfY3hTNkcyMA2AbjmfO+ropaE/xCA/xHxYhimY86zA90+4eHMzUeTN8VAD7sS9zwrv4pXnxD6muwBF8mWl/A85m6owEYPcItI9hZ6ZzsfX9mKkTu8/5HJ3cCFiDCzkT4HJzHshUezP8KHZkKq7FxVSdHACzcQNfpRrHM8wfMH5Ts7rf4l/cwm2cGDD2DpZlzBknyUijv1N0cgBEwYvClyr/YHUDrV8nDjNR6AZJFMWlrT8WN4BmpE7cgIzdYaikAtiC34dae3vAaWxu6TxI2DIjhyOX++UMosjlyFb8MUwhFUCE6HfDjLX+b29NOdtmgAuAPdmLA5nzD4qmd0ykAIhm5krm5DE8jsRxfu/JKUTup0g7CiKVopjmykZE9LxXUgDcbFrZ3MnntI6pzxFtcYpEGzyvb+BcvExRbI25P6wTrQASqBafAsGo6CIYAIrfBgNC0QehAFD8UTggFN0M9TaMotvhHoSiL0R6EHLO9j2dz+ZKrPdCRV+K9iAUfS3ef5Iu9sNIu50o9tNYG0SxH0cHNZhFfh5P6LQ//ZCUC5FP72WHHlQAHcKdCNM1AiZimTp0skZAh3AnwnSNgIlYpg6drBHQIdyJMF0jYCKWqUMnawR0CHciTP8Phw+oQQpn1acAAAAASUVORK5CYII=",self.location).href:s.themeValue?new URL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABO1JREFUeF7tmkmoHVUQhr8fQVwI6sJhkYBujIITKqIiKATNwii6iIugURSNGgRHCLhIslNU4sIx4BhESBaKEcUJRaNRNE44oC4MGHACBxAREUrqcTr0venhVPd9l0e/W9DcxTl1qv7/VNepOn3FIhctcvzMCJhFwCJnYPYKLPIAmCXBQb8CZrZR0samKB8sAQ4e2ABsaiJhkASUwBeb75GwqSoSBkdABXjH/TVwmaQvxkkYFAE14L9L4D8ddATUgP8+gf+oLhEOIgJqwP+QwL8/6FOgBvyPCfzOtkJvKhFgZkcD5wHnAscBh5aefwHfrb2lxx1/W5KP1UoN+F8T+LfawPv4vBFgZicBFwMXAmfmOFMx5+NExC3jYzXgf0/gX8+1N3ECzOwadwK4INeJhnnbJflaI1ID/q8E/uWI3YkRYGYrAN8p/52ERMD/k8DviBruTYCZHQLcB/jOT0oi4P9L4J/rYrwXAWZ2IvAEcFoX4zU6EfC+hFd427va70yAmV0HPBo07O/pC6k09cpsN3AAcFZ6lgTe+bLp9ZLuDvoyN70TATVJqM3+e8A6SZUlaZ1ywFZj11e3fpgAM7sNuLcN7dj4I5JuCOoQAF8svULSqxE7IQLM7BIgmmx2SPJ6oFI8iUr6c3ywA/hiiTMkfZhLQjYBZnYE8AZwQu7iwLeSllWA8/xxNrCn6rKiB3g39RlwviSvCFslQoAnPHc8V/xsXinJSdsnZuadmZ8ale9sT/CFncclZR3LWQSY2ZXAk7nI07ytktaMgd8GrOoAfj1wV9C+J9yH2nRyCXgHOKdtsbHxOyTtS5ZmdgXwdAfwRSns5EXEm6tlkv5uUmolwMy8mXkxYjnNHcnIZvYasLPqbq4h7OeKHDPzV6b2UqPBt5skPdCXgDdTKxvl4ChJPxdKZrahC3jXN7PDgN+iDgCfSDq1LwHvpowdtb9UkofhHABJ3qqOSMPO75W0tETekcBPUQeADyQ1tuI5r8Bq4JkOxhtr9JZsP9IPmJm31q908OFySY2+5xBwEPAVcEzQgc2Sbq3SyTjq1kjaWoqA24F7gvZ3Szq9TaeVgBTCNwIPti02Nh7t6gr1/fTMzE8PP0UicpWkp9oUsghIJDwGXN22YBrvCv5LSSOVppktT6eQR2KubJG0NmdyhIDDAT/KTm5ZOAreE+Uuf81qyuJvgGNzwKQ5/vVnuaRfcnSyCUhRsBJounaKgm9LlH53cFEOkNKcSyU9n6sTIiCRsA6oKi4mDf5h4PpcIGle+HYoTEAi4WZgc8m5iYE3s1NSwvVuMSKrJT0bUfC5nQhIJHhT4/V5FLx/9PDHCyy/EnPxUteBH5++JRwcBDLSd0R0OxNQkFB1IZlxzkd8bJq7B1gbvQUqL9iLgCrPpgjej+U7y/1GF1YnSsCUwHtJ7FVml9J4P44mRsAUwPtl5zZJvvMTk4kQ0AD+/tRKe4LrIl4gveTfEiR93mWBNp3eBLRdZhQOmJl/HvdnSenxlvdA4I/S45Wc7/auop1uA9FnvBcBueD7ODjfup0JGAL4zoXQUMB3ImBI4MMEDA18iIAhgs8mYKjgswgYMvgsAlLX5zeyfjNbSPjiYb7P867rZ9cBZrYFuLbvf3K6OjpfetkEpEhY1ecPSfMFos+6IQL6GFqoujMCFurOTMuvWQRMi+mFaud/XhkSXwnoZssAAAAASUVORK5CYII=",self.location).href:new URL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABJ9JREFUeF7tmkuoVlUUx3+XQBwE6UBtkJCTSjALDdEIEqIcmFEDHYgvlCwVwV4QNMhmhYoOLDVQywihBoqKkg+UfJSYmVKJOTBIMA18gISIA/nLPnA4d5+z99rnfF927rfgcLnsvdba///eZz32+foY4NI3wPHTI6B3AgY4A71XYIAfgF4QbPsrsBzQUyptJkDAPwQ+qiKhrQRk4LOd1/8iop+0kYAieIE+C8wAfi0y0DYCfODPO/C/tP0E+MBfcOB/KouCbTkBPvB/OfA/tj0L+MBfcuCPhAq9bp2AR4HJwPPAE8CQ3HMb0G5dzD1a+PeAxqrEB/4fB/5QCLzGO0nAWOAVYCowMWYxnjk/OyLe8oz5wF9z4PfH+usEAQvcIl6KXUTFvG+dreIUH/ibbu4ei98mCZgCaKf0twmxgL/lwO+0Om6CgIeAVYB2vimxgL/jwG9LcV6XgCeBzcD4FOclOhbwMqEKTzpJUoeAhcAGo1e9pztcaarK7CTwADDJPY8Y3vm86/eBT4xruTc9lQBfEAr5PwYsAbwlaYVyrK/Krq/MfgoB7wArQ2gL4+uBRUYdTY8Fn5lWAN5r8WMl4FXAGmwUmVUPlImC6A3PoBV8ZmICcCKWBAsBw4EDwJhY48AfwOOe+YofzwJ/llxWpIKXq9PAi4AqwqBYCFDA08JjRbn5ZUdaXkedmbJG2TtbB3zmZ1NsWo4lYC7wRSxyN+8rYE5B5xtgegJ4RfmPjf4VcD8L6cQScBh4LmSsMP5eIVjOBrYkgFeel4g8i6i50uv3b5VSDAFqZnZZPLu5xYi8D1CX57ubKzv2WZGjV6b0UqNibUuBtXUJOOhaWSsHDwOXc0rZDW3RTgi85g8FrloXAJwCxtUl4KiL2Fb/I11/nwFQqxoLXsdX+pmMAP62LgA4HmrFY16BmcDXCc5DNXpVtC/2A2qtv0tYw6zQ2mMIGAz8DowyLmA18HaJTijVKXsoi2TyLrDC6F99xjMhnRgCZGMx8GnIWGHc2tVl6j49ZQ9lEYvMA74MKcQSIDsbgfkhg248FfxvnkrzBZeFdBJj5XPgjZjJFgKGAUplTwUMW8Er4P3gXjPfh8xzwGMxYNwcff0RaVdidCwEyJ5K26prJyv4UKDU3cG0GCC5Oa8B22N1rATIrkpMX3HRNPh1wJuxQNy8EKH9zKUQICPLAEX5qsClsZgip7iop13AVbdoEaXrrRYFzU0lQLpqalSfW3de5bAeFVhKVRKVugI+2t0dPGgEUuw7otXrEJCR4LuQDOX56AUGJuo+QdHedAuUt1mXAN/6ugVeafmDQr9hJrZpAroBXiWx4k9KadxYEPwvdl7HXDFHO9+YNHUCynZ+jWulFeBSRAXSbvct4UyKgZBOEwTEpjp9Htejjx/Zo5Z3EHA996iS024LvKrEjkpdAmLBdxREHeN1CPjfg69TCLUCfCoBrQGfQkCrwFsJaB14CwGtBB9LQGvBxxKgebqR1c1sJuaLhzq5upO6ljpAF42v1/1NTifBpNi2ECD7ugRJ/kFSygI7rWMloNPr6br9HgFdp/w+c9g7AffZhnR9OXcBC2PsQVriZsoAAAAASUVORK5CYII=",self.location).href)),checkTheme:Ke((()=>s.themeValue)),checkzIndex:Ke((()=>{let e={zIndex:0};return s.isFullWork?e.zIndex=g.zIndex.max:e.zIndex=g.zIndex.min,e}))};let u=i(o({},n),{handleChangeBrushColor(e){let a=e;a.length<=6&&"#"!==a.slice(0,1)&&(a=`#${a}ff`.toLowerCase()),g.brushColor=a},handleSaveProject(){g.isScaling&&u.handleCancelScale();u.handleSaveMoveData(!0,(()=>{g.loading=!0,g.isSaveProject=!0,g.projectData.updateAt=Ca(),g.projectData.height=g.canvasHeight,g.projectData.width=g.canvasWidth,g.projectData.tip="最近编辑",g.projectData.data=u.compressDrawRecordData(),""===g.drawRecord[0].currentFrameImg?g.projectData.frameImg="":g.projectData.frameImg="@",s.saveProject(g.projectData,!0).then((e=>{e&&(t.$message.success(t.$t("message.saveSucceeded")),g.loading=!1)})).catch((e=>{t.$message.error(t.$t("message.saveFailed")),g.loading=!1}))}))},handleBack(){if(g.isSaveProject)return s.saveProjectId("0"),g.pinDouMode=!1,t.$router.replace("/project");ea.confirm("项目未保存，是否离开该页面？","提 示",{confirmButtonText:"确 认",cancelButtonText:"取 消",type:"warning"}).then((()=>{s.saveProjectId("0"),g.pinDouMode=!1,t.$router.replace("/project")})).catch((()=>{}))},handleScreenFull(){s.isFullWork=!s.isFullWork,setTimeout((()=>{u.handleResizeWindowEvent(""),s.isFullWork||u.handleResetCanvas()}),200)},handleSaveMoveData(e=!1,a){if(g.isMoving&&7===g.currentTool){let t=g.moveCanvas.offsetLeft/g.scale,r=g.moveCanvas.offsetTop/g.scale;g.worker.postMessage({type:13,moveData:JSON.parse(JSON.stringify(g.moveData.list)),layerData:JSON.parse(JSON.stringify(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData)),options:{canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight,scale:g.scale,difLeft:t,difTop:r}}),g.worker.onmessage=t=>{let r=u.getCurrentLayerDataByLayerId();r.layerData=t.data.layerData,r.layerNewData=t.data.layerNewData,g.moveData.list=[],g.ctx5.clearRect(0,0,g.moveCanvas.width,g.moveCanvas.height),g.moveCanvas.style.left="0px",g.moveCanvas.style.top="0px",g.isMoving=!1,u.reDraw(),a(),setTimeout((()=>{e&&u.handleMoveData()}),1e3)}}else a()},handleMoveData(){if(!g.isMoving&&(g.moveBoxDom.style.width=g.moveCanvas.width+"px",g.moveBoxDom.style.height=g.moveCanvas.height+"px",g.currentLayerId=u.getCurrentLayerId(),"undefined"!=typeof OffscreenCanvas)){g.loading=!0;let e=aa(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex]),a=i(o({},e),{layerNewData:ta(e.layerNewData)});g.worker.postMessage({type:7,currentLayerData:a,options:{canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight,scale:g.scale}}),g.worker.onmessage=e=>{g.moveData.list=JSON.parse(JSON.stringify(ra(a.layerData.map((e=>e[2]!==g.emptyColor?e:null))))),g.loading=!1,g.isMoving=!0,g.moveData.list.length&&(g.ctx5.drawImage(e.data.imageBitmap,0,0),g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData=JSON.parse(JSON.stringify(g.emptyLayerData)),g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData={},u.reDraw(!1))}}},handleChangeTool(e){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");g.isScaling&&u.handleFinishScale();const a=()=>{if(6===e)return g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData=JSON.parse(JSON.stringify(g.emptyLayerData)),g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData={},u.handleCancelSelect(),void u.reDraw();if(7===e){if(!Oe(g.selectData.selectMapList))return t.$message.warning("请先取消选中区域");if(!g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender)return t.$message.warning("图层为空");if("undefined"==typeof OffscreenCanvas)return t.$message.warning("当前浏览器不支持该功能，请切换浏览器");u.handleMoveData()}g.currentTool=e};g.isMoving&&7===g.currentTool&&g.currentTool!==e?u.handleSaveMoveData(!1,a):a()},handleLinmoMode:()=>g.pinDouMode?t.$message.warning("请先退出拼豆预览模式"):g.isHideLinmoMode?(g.isHideLinmoMode=!1,void t.$refs.LinmoModeDialog.handleShow()):(g.linmoMode=!0,void t.$refs.LinmoModeDialog.handleOpen()),handlePindouMode(e){if(!Oe(g.selectData.selectMapList))return t.$message.warning("请先取消选中区域");if(g.isScaling&&u.handleCancelScale(),!g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender)return t.$message.warning("请将图层设置显示状态");if("preview"!==e||g.pinDouMode){if("draw"===e&&!g.pinDouDrawMode){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(g.isHidePindouMode)return void u.handleShowPindou();g.pinDouDrawMode=!0,t.$refs.PindouDialog.handleOpen(e)}}else{if(g.pinDouDrawMode)return t.$message.warning("请先退出拼豆绘图模式");if(g.linmoMode)return t.$message.warning("请先退出临摹模式");g.loading=!0,u.handleResetCanvas(),g.currentTool=5,u.handlePindouEvent()}},handleShowPindou(){g.isHidePindouMode=!1,t.$refs.PindouDialog.handleShow()},handlePindouEvent(e=g.pindouBrand){g.loading=!0,g.worker.postMessage({type:6,currentPindouBrandColorList:JSON.parse(JSON.stringify(s.pindouMaps[e].data||s.pindouMaps[e])),variables:JSON.parse(JSON.stringify(g.drawRecord[g.currentFrameIndex].layer))}),g.worker.onmessage=a=>{g.pinDouMode=!0,u.computeScale(),g.pinDouData=a.data,u.drawPixelArea(!0),u.handleDrawPindou(g.ctx1),g.pindouBrand=e,t.$refs.PindouDialog.handleOpen(a.data),u.handleCancelKeyboardEvent()}},handleTransformColorToPindou(e){let a=g.drawRecord[g.currentFrameIndex].layer,r=g.pinDouData.variables;for(let t=r.length-1;t>=0;t--)for(let e=0;e<r[t].layerData.length;e++)a[t].layerData[e][2]=r[t].layerData[e][2];u.handleLayerDataToLayerMapData((()=>{u.handleFrameImg(g.ctx1),e(),t.$message.success("保存成功")}))},handleChangeCanvasSize(e,a){e<t.$config.canvasMinSize||e>t.$config.canvasMaxSize?(g[a]=e<t.$config.canvasMinSize?t.$config.canvasMinSize:e>t.$config.canvasMaxSize?t.$config.canvasMaxSize:g[a],t.$message.warning(`画布像素必须${t.$config.canvasMinSize}-${t.$config.canvasMaxSize}像素区间`)):g[a]=Number(e),g.isCheckedRatio&&("canvasWidth"===a?g.canvasHeight=parseInt(g[a]/g.widthHeightRatio):g.canvasWidth=parseInt(g[a]/g.widthHeightRatio)),u.computeScale(),g.canvasBeginPos.centerX=g.canvasBeginPos.x+g.scale*g.canvasWidth/2,g.canvasBeginPos.centerY=g.canvasBeginPos.y+g.scale*g.canvasHeight/2,u.drawPixelArea(!0),u.handleInitEmptyLayer(),u.initCanvasRecord("scale")},handleChangeRatio(e){e&&(g.widthHeightRatio=g.canvasWidth/g.canvasHeight)},initCanvasRecord(e){if("init"===e)g.drawRecord.push({frameId:la.v1(),currentFrameImg:null,layer:[{layerId:la.v4(),layerName:"图层1",alpha:100,isLock:!1,currentLayerImg:g.layerGridImage,isRender:!0,layerData:JSON.parse(JSON.stringify(g.emptyLayerData)),layerNewData:{}}]}),u.handleAddHistory();else if("scale"===e){g.loading=!0;let e=JSON.parse(JSON.stringify(g.emptyLayerData));g.worker.postMessage({originData:e,type:1,variables:JSON.parse(JSON.stringify(g.drawRecord))}),g.worker.onmessage=e=>{g.drawRecord=e.data,g.loading=!1,u.reDraw()}}},drawPixelArea(e=!1){if(!e&&g.drawAreaGridCanvas&&g.ctx2.drawImage(g.drawAreaGridCanvas,0,0,g.bgCanvas.width,g.bgCanvas.height),e){let e=s.themeValue?g.drawAreaGridColor.dark:g.drawAreaGridColor.light;g.drawAreaList=[],g.ctx2.clearRect(0,0,g.bgCanvas.width,g.bgCanvas.height),g.ctx2.globalAlpha=.25;for(let a=0;a<g.canvasHeight;a++)for(let t=0;t<g.canvasWidth;t++){g.ctx2.fillStyle=(a+t)%2==0?e[1]:e[0];let r=t*g.scale,l=a*g.scale;g.ctx2.fillRect(r,l,g.scale,g.scale),g.drawAreaList.push([r,l])}g.drawAreaGridCanvas=g.bgCanvas}u.handleDrawReferenceLine(),u.handleDrawGridLine()},handleDrawGridLine(){if(g.ctx4.clearRect(0,0,g.gridCanvas.width,g.gridCanvas.height),g.isShowGridLine){g.ctx4.strokeStyle=s.themeValue?"white":"black",g.ctx4.lineWidth=1,g.ctx4.beginPath();for(let e=0;e<=g.canvasHeight;e++)g.ctx4.moveTo(0,e*g.scale),g.ctx4.lineTo(g.canvasWidth*g.scale,e*g.scale);for(let e=0;e<=g.canvasWidth;e++)g.ctx4.moveTo(e*g.scale,0),g.ctx4.lineTo(e*g.scale,g.canvasHeight*g.scale);g.ctx4.stroke()}},handleDrawReferenceLine(e="vh"){if(g.ctx0.clearRect(0,0,g.baseCanvas.width,g.baseCanvas.height),g.isShowReferenceLine){let a=g.canvas.offsetLeft,t=g.canvas.offsetTop;g.ctx0.globalAlpha=.5,g.ctx0.lineWidth=2,g.ctx0.strokeStyle=s.themeValue?"white":"black",g.ctx0.setLineDash([5,3]),"vh"!==e&&"v"!==e||(g.ctx0.beginPath(),g.ctx0.moveTo(a+g.canvasWidth*g.scale/2,0),g.ctx0.lineTo(a+g.canvasWidth*g.scale/2,g.baseCanvas.height),g.ctx0.stroke()),"vh"!==e&&"h"!==e||(g.ctx0.beginPath(),g.ctx0.moveTo(0,t+g.canvasHeight*g.scale/2),g.ctx0.lineTo(g.baseCanvas.width,t+g.canvasHeight*g.scale/2),g.ctx0.stroke())}u.handleDrawRulerLine()},handleDrawRulerLine(){if(g.isShowRuler){let e=na(g.canvas),a=16,t=15;if(!g.pinDouMode&&e<.5)return;g.pinDouMode&&(a=32,t=30);let r=e*t,l=e*g.scale,n=Math.floor(e*a)-1;g.canvasRealLeft=g.baseCanvas.getBoundingClientRect().left,g.canvasRealTop=g.baseCanvas.getBoundingClientRect().top,g.ctx0.setLineDash([]);let o=g.canvas.getBoundingClientRect().left-g.canvasRealLeft,i=g.canvas.getBoundingClientRect().top-g.canvasRealTop,c=g.canvas.getBoundingClientRect().width,d=g.canvas.getBoundingClientRect().height;g.ctx0.globalAlpha=1,g.ctx0.lineWidth=1,g.ctx0.strokeStyle=s.themeValue?"white":"black",g.ctx0.fillStyle=s.themeValue?"white":"black",g.ctx0.font=`${n}px PixelFont`,g.ctx0.textAlign="center",g.ctx0.beginPath(),g.ctx0.moveTo(o,i-5),g.ctx0.lineTo(o+c,i-5),g.ctx0.moveTo(o,i+d+5),g.ctx0.lineTo(o+c,i+d+5),g.ctx0.moveTo(o-5,i),g.ctx0.lineTo(o-5,i+d),g.ctx0.moveTo(o+c+5,i),g.ctx0.lineTo(o+c+5,i+d);for(let s=0;s<=g.canvasWidth&&(g.ctx0.moveTo(o+s*g.scale*e,i-5),g.ctx0.lineTo(o+s*g.scale*e,i-(5+r)),g.ctx0.moveTo(o+s*g.scale*e,i+d+5),g.ctx0.lineTo(o+s*g.scale*e,i+d+(5+r)),s!==g.canvasWidth);s++){if(sa(s+1))continue;let e=o+l*s+l/2,a=i-5-r,t=e,n=i+d+5+r+5;g.ctx0.fillText((s+1).toString(),e,a),g.ctx0.fillText((g.canvasWidth-s).toString(),t,n+4)}for(let s=0;s<=g.canvasHeight&&(g.ctx0.moveTo(o-5,i+s*g.scale*e),g.ctx0.lineTo(o-(5+r),i+s*g.scale*e),g.ctx0.moveTo(o+c+5,i+s*g.scale*e),g.ctx0.lineTo(o+c+(5+r),i+s*g.scale*e),s!==g.canvasHeight);s++){if(sa(s+1))continue;let e=o-5-r-5,a=i+s*l+l/2+5,t=o+c+(5+r)+8,n=a;g.ctx0.fillText((s+1).toString(),e,a),g.ctx0.fillText((g.canvasHeight-s).toString(),t,n)}g.ctx0.stroke()}},drawLoop(){u.drawPixelArea(),g.AnimationFrameId_1=requestAnimationFrame(u.drawLoop)},drawShape(e){g.currentDrawShape=e},getCurrentLayerData:(e=g.currentFrameIndex,a=g.currentLayerIndex)=>g.drawRecord[e].layer[a].layerData,getCurrentLayerDataByLayerId(e=g.currentFrameIndex,a=g.currentLayerId){let t=g.drawRecord[e].layer.findIndex((e=>e.layerId===a));return g.drawRecord[e].layer[t]},getCurrentLayerId:(e=g.currentFrameIndex,a=g.currentLayerIndex)=>g.drawRecord[e].layer[a].layerId,getCurrentFrameId:(e=g.currentFrameIndex)=>g.drawRecord[e].frameId,getCurrentLayerIsLock:(e=g.currentFrameIndex,a=g.currentLayerIndex)=>g.drawRecord[e].layer[a].isLock,drawScaleFrame(){if(!g.isScaling)return;let e=0,a=0,r=[];r=Oe(g.selectData.selectMapList)?JSON.parse(JSON.stringify(u.getCurrentLayerData())):oa(JSON.parse(JSON.stringify(g.selectData.selectList)));let l=1/0,n=1/0,s=-1/0,o=-1/0;for(let t=0;t<r.length;t++){if(r[t][2]===g.emptyColor)continue;const e=r[t][0],a=r[t][1];e<l&&(l=e),e>s&&(s=e),a<n&&(n=a),a>o&&(o=a)}if(l===1/0&&(l=0),n===1/0&&(n=0),s===-1/0&&(s=0),o===-1/0&&(o=0),l+n+s+o===0)return g.isScaling=!1,t.$message.warning("图层为空");let i=na(g.canvas),c=s*g.scale*i+g.scale*i,d=l*g.scale*i,h=o*g.scale*i+g.scale*i,p=n*g.scale*i;e=c-d,a=h-p,g.scaleAreaData={},g.scaleAreaData={minX:l,maxX:s,minY:n,maxY:o,realmaxX:c,realminX:d,realmaxY:h,realminY:p,originArr:[],colorMaxtrix:[],coordMaxtrix:[],isRight:!1,isLeft:!1,isTop:!1,isBottom:!1},u.handleDrawScaleFrame(d-5,p-5,c+5,h+5);for(let t=0;t<r.length;t++)r[t][0]<=g.scaleAreaData.maxX&&r[t][0]>=g.scaleAreaData.minX&&r[t][1]<=g.scaleAreaData.maxY&&r[t][1]>=g.scaleAreaData.minY&&g.scaleAreaData.originArr.push(r[t]);let m=g.scaleAreaData.maxX-g.scaleAreaData.minX+1,f=g.scaleAreaData.maxY-g.scaleAreaData.minY+1;for(let t=0;t<f;t++){let e=[],a=[];for(let r=0;r<m;r++){let l=r+g.scaleAreaData.minX,n=t+g.scaleAreaData.minY,s=u.getCurrentLayerColorByCoords(l,n)||g.emptyColor;e.push([l,n]),a.push([s])}g.scaleAreaData.colorMaxtrix.push(a),g.scaleAreaData.coordMaxtrix.push(e)}},handleDrawScaleFrame(e,a,t,r,l=!0){l&&u.handleDrawReferenceLine(),g.canvasRealLeft=g.baseCanvas.getBoundingClientRect().left,g.canvasRealTop=g.baseCanvas.getBoundingClientRect().top;let n=g.canvas.getBoundingClientRect().left,s=g.canvas.getBoundingClientRect().top;e+=n-g.canvasRealLeft,t+=n-g.canvasRealLeft,a+=s-g.canvasRealTop,r+=s-g.canvasRealTop,g.ctx0.strokeStyle="blue",g.ctx0.fillStyle="white",g.ctx0.globalAlpha=.9,g.ctx0.lineWidth=2,g.ctx0.setLineDash([]),g.ctx0.beginPath(),g.ctx0.moveTo(e,a),g.ctx0.lineTo(t,a),g.ctx0.stroke(),g.ctx0.beginPath(),g.ctx0.moveTo(e,a),g.ctx0.lineTo(e,r),g.ctx0.stroke(),g.ctx0.beginPath(),g.ctx0.moveTo(e,r),g.ctx0.lineTo(t,r),g.ctx0.stroke(),g.ctx0.beginPath(),g.ctx0.moveTo(t,r),g.ctx0.lineTo(t,a),g.ctx0.stroke(),g.scaleWhitePointPos=[[t,r]],g.ctx0.beginPath(),g.ctx0.rect(t-4,r-4,8,8),g.ctx0.fill(),g.ctx0.stroke()},handleFinishScale(){let e=ia(g.scaleAreaData,g.scaleRatio),a=ca(g.scaleAreaData,g.scaleRatio);if(Oe(g.selectData.selectMapList))g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData=JSON.parse(JSON.stringify(g.emptyLayerData));else{for(let e=0;e<g.selectData.selectList.length;e++){let a=g.selectData.selectList[e][0]+g.selectData.selectList[e][1]*g.canvasWidth;g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[a][2]=g.emptyColor}g.selectData.selectList=[]}for(let t=0;t<e.length;t++)for(let r=0;r<e[t].length;r++)0!==g.selectData.selectLayerId&&a[t][r][0]!==g.emptyColor&&g.selectData.selectList.push([e[t][r][0],e[t][r][1],a[t][r][0]]),u.addDrawRecord([e[t][r][0],e[t][r][1],a[t][r][0]],!1);g.isScaling=!1,g.scaleAreaData=null,g.scaleWhitePointPos=[],g.scaleRatio=0,u.handleDrawReferenceLine(),u.reDraw(),Oe(g.selectData.selectMapList)?u.handleChangeTool(0):u.handleChangeTool(8)},handleCancelScale(){g.isScaling=!1,g.scaleAreaData=null,g.scaleWhitePointPos=[],g.scaleRatio=0,u.handleDrawReferenceLine(),u.reDraw(!1),Oe(g.selectData.selectMapList)?u.handleChangeTool(0):u.handleChangeTool(8)},drawTransform(e){if(g.isScaling&&"scale"!==e&&u.handleCancelScale(),g.isScaling&&"scale"===e)return;if(g.currentDrawTransform=e,"scale"===e)return u.handleChangeTool(9),g.isScaling=!0,void u.drawScaleFrame();let a=[],t=g.canvasBeginPos.centerX,r=g.canvasBeginPos.centerY,l=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex],n=JSON.parse(JSON.stringify(l.layerData)),s=ta(l.layerNewData);if(Oe(g.selectData.selectMapList)){let e=Object.keys(s);for(let t=0;t<e.length;t++){let r=s[e[t]];for(const[l,n]of r){if(n[0]>=g.canvasWidth||n[1]>=g.canvasHeight||n[0]<0||n[1]<0)return;let r=n[0]*g.scale,l=n[1]*g.scale;a.push([r,l,e[t]])}}}else{let e=Object.keys(g.selectData.selectMapList);for(let t=0;t<e.length;t++){let r=g.selectData.selectMapList[e[t]];for(const[l,n]of r){if(n[0]>=g.canvasWidth||n[1]>=g.canvasHeight||n[0]<0||n[1]<0)return;let r=n[0]*g.scale,l=n[1]*g.scale;a.push([r,l,e[t]])}}}if("hReverse"===e)for(let c=0;c<a.length;c++){let e=a[c][0],t=a[c][1];a[c][0],g.scale;const r=Math.floor(t/g.scale),o=Math.floor(e/g.scale);let i=g.canvasWidth-1-o,d=r;n[o+r*g.canvasWidth][2]=g.emptyColor,s[a[c][2]].has(`${i}/${d}`)||(s[a[c][2]].delete(`${o}/${r}`),s[a[c][2]].set(`${i}/${d}`,[i,d])),Oe(g.selectData.selectMapList)||g.selectData.selectLayerId!==l.layerId||g.selectData.selectMapList[a[c][2]].has(`${i}/${d}`)||(g.selectData.selectMapList[a[c][2]].delete(`${o}/${r}`),g.selectData.selectMapList[a[c][2]].set(`${i}/${d}`,[i,d]))}else if("vReverse"===e)for(let c=0;c<a.length;c++){let e=a[c][0],t=a[c][1];a[c][1],g.scale;const r=Math.floor(t/g.scale),o=Math.floor(e/g.scale);let i=o,d=g.canvasHeight-1-r;n[o+r*g.canvasWidth][2]=g.emptyColor,s[a[c][2]].has(`${i}/${d}`)||(s[a[c][2]].delete(`${o}/${r}`),s[a[c][2]].set(`${i}/${d}`,[i,d])),Oe(g.selectData.selectMapList)||g.selectData.selectLayerId!==l.layerId||g.selectData.selectMapList[a[c][2]].has(`${i}/${d}`)||(g.selectData.selectMapList[a[c][2]].delete(`${o}/${r}`),g.selectData.selectMapList[a[c][2]].set(`${i}/${d}`,[i,d]))}else if("ssz"===e)for(let c=0;c<a.length;c++){let e=a[c][0]-t,o=-(a[c][1]-r)+t-g.scale,i=e+r;const d=Math.floor(a[c][1]/g.scale),h=Math.floor(a[c][0]/g.scale),p=Math.floor(i/g.scale),u=Math.floor(o/g.scale);n[h+d*g.canvasWidth][2]=g.emptyColor,s[a[c][2]].set(`${h}/${d}`,[u,p]),Oe(g.selectData.selectMapList)||g.selectData.selectLayerId!==l.layerId||g.selectData.selectMapList[a[c][2]].has(`${u}/${p}`)||(g.selectData.selectMapList[a[c][2]].delete(`${h}/${d}`),g.selectData.selectMapList[a[c][2]].set(`${u}/${p}`,[u,p]))}else if("nsz"===e)for(let c=0;c<a.length;c++){let e=a[c][0]-t,o=a[c][1]-r+t,i=-e+r-g.scale;const d=Math.floor(a[c][1]/g.scale),h=Math.floor(a[c][0]/g.scale),p=Math.floor(i/g.scale),u=Math.floor(o/g.scale);n[h+d*g.canvasWidth][2]=g.emptyColor,s[a[c][2]].set(`${h}/${d}`,[u,p]),Oe(g.selectData.selectMapList)||g.selectData.selectLayerId!==l.layerId||g.selectData.selectMapList[a[c][2]].has(`${u}/${p}`)||(g.selectData.selectMapList[a[c][2]].delete(`${h}/${d}`),g.selectData.selectMapList[a[c][2]].set(`${u}/${p}`,[u,p]))}let o=Object.keys(s),i=[];for(let c=0;c<o.length;c++){let e=s[o[c]];for(const[a,t]of e){let e=a.split("/")[0],r=a.split("/")[1];e==t[0]&&r==t[1]||i.push([a,t,o[c]])}}for(let c=0;c<i.length;c++){s[i[c][2]].delete(i[c][0])}for(let c=0;c<i.length;c++){s[i[c][2]].set(`${i[c][1][0]}/${i[c][1][1]}`,i[c][1])}g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData=n,g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData=s,u.reDraw(),u.handleLayerMapDataToLayerData(!0)},handleLayerMapDataToLayerData(e=!1){let a=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData;e&&(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData=JSON.parse(JSON.stringify(g.emptyLayerData)));let t=Object.keys(a);for(let r=0;r<t.length;r++){let e=a[t[r]];for(const[a,l]of e){if(l[0]>=g.canvasWidth||l[1]>=g.canvasHeight||l[0]<0||l[1]<0)return;let e=l[0]+l[1]*g.canvasWidth;g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[e][2]=t[r]}}},handleAllLayerMapDataToLayerData(){let e=g.drawRecord[g.currentFrameIndex].layer;for(let a=0;a<e.length;a++){let e=g.drawRecord[g.currentFrameIndex].layer[a].layerNewData,t=Object.keys(e);for(let r=0;r<t.length;r++){let l=e[t[r]];for(const[e,n]of l){if(n[0]>=g.canvasWidth||n[1]>=g.canvasHeight||n[0]<0||n[1]<0)return;let e=n[0]+n[1]*g.canvasWidth;g.drawRecord[g.currentFrameIndex].layer[a].layerData[e][2]=t[r]}}}},handleCurrentLayerDataToLayerMapData(e){let a=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData,t={};for(let r=0;r<a.length;r++){if("#00000000"===a[r][2])continue;let e=a[r][0]+"/"+a[r][1];t[a[r][2]]||(t[a[r][2]]=new Map),t[a[r][2]].set(e,[a[r][0],a[r][1]])}g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData=t,e()},handleLayerDataToLayerMapData(e){let a=da(g.drawRecord[g.currentFrameIndex].layer);g.worker.postMessage({type:14,variables:a}),g.worker.onmessage=a=>{g.drawRecord[g.currentFrameIndex].layer=a.data,e()}},drawTransformSymmetric(){let e=[];for(let a=0;a<g.drawList.length;a++)if(g.isHorizontal){let t=g.canvasWidth-1-g.drawList[a][0],r=g.drawList[a][1];e.push([t,r,g.drawList[a][2]])}else if(g.isVertical){let t=g.drawList[a][0],r=g.canvasHeight-1-g.drawList[a][1];e.push([t,r,g.drawList[a][2]])}else if(g.isCenter){let t=g.drawList[a][0]*g.scale+g.canvasBeginPos.x,r=g.drawList[a][1]*g.scale+g.canvasBeginPos.y,l=2*g.canvasBeginPos.centerX-(t+g.scale/2),n=2*g.canvasBeginPos.centerY-(r+g.scale/2),s=Math.floor((l-g.canvasBeginPos.x)/g.scale),o=Math.floor((n-g.canvasBeginPos.y)/g.scale);e.push([s,o,g.drawList[a][2]])}for(let a=0;a<e.length;a++)u.addDrawList(e[a][0],e[a][1],e[a][2])},removeDrawTransformSymmetric(){let e=[];for(let a=0;a<g.removeDrawList.length;a++)if(g.isHorizontal){let t=g.canvasWidth-1-g.removeDrawList[a][0],r=g.removeDrawList[a][1];e.push([t,r,g.removeDrawList[a][2]])}else if(g.isVertical){let t=g.removeDrawList[a][0],r=g.canvasHeight-1-g.removeDrawList[a][1];e.push([t,r,g.removeDrawList[a][2]])}else if(g.isCenter){let t=g.removeDrawList[a][0]*g.scale+g.canvasBeginPos.x,r=g.removeDrawList[a][1]*g.scale+g.canvasBeginPos.y,l=2*g.canvasBeginPos.centerX-(t+g.scale/2),n=2*g.canvasBeginPos.centerY-(r+g.scale/2),s=Math.floor((l-g.canvasBeginPos.x)/g.scale),o=Math.floor((n-g.canvasBeginPos.y)/g.scale);e.push([s,o,g.removeDrawList[a][2]])}for(let a=0;a<e.length;a++){u.addRemoveDrawList(e[a][0],e[a][1],e[a][2]);let t=e[a][0]*g.scale,r=e[a][1]*g.scale;u.checkLayerEraseOrder(t,r,g.eraserSize*g.scale)}},handleChangeBrushSymmetric(e,a){"isHorizontal"===a&&g[a]?(g.isVertical=!1,g.isCenter=!1):"isCenter"===a&&g[a]?(g.isVertical=!1,g.isHorizontal=!1):"isVertical"===a&&g[a]&&(g.isHorizontal=!1,g.isCenter=!1)},handleWheelEvent(e){if(g.pinDouMode){const a=e.deltaY>0?-.02:.02;let t=na(g.canvas);t+=a;let r=Math.max(.1,t);return r>10&&(r=10),g.canvasStyle.transform=`translate3d(0, 0, 10px) scale(${r})`,g.linmoFitCanvasTimer&&clearTimeout(g.linmoFitCanvasTimer),void(g.linmoFitCanvasTimer=setTimeout((()=>{u.handleDrawReferenceLine()}),250))}const a=e.deltaY>0?-.05:.05;let t=na(g.canvas);t+=a;let r=Math.max(.1,t);r>10&&(r=10),g.canvasStyle.transform=`translate3d(0, 0, 10px) scale(${r})`,g.linmoFitCanvasTimer&&clearTimeout(g.linmoFitCanvasTimer),g.linmoFitCanvasTimer=setTimeout((()=>{u.handleLinmoFitCanvas(),u.handleDrawReferenceLine(),u.handleScaleFrame1()}),250)},handleResizeCanvas(e){if(g.pinDouMode){let a=na(g.canvas);a+=e-.08;let t=Math.max(.1,a);return t>10&&(t=10),g.canvasStyle.transformOrigin="center center",g.canvasStyle.transform=`translate3d(0, 0, 10px) scale(${t})`,g.linmoFitCanvasTimer&&clearTimeout(g.linmoFitCanvasTimer),void(g.linmoFitCanvasTimer=setTimeout((()=>{u.handleDrawReferenceLine()}),250))}let a=na(g.canvas);a+=e;let t=Math.max(.1,a);t>10&&(t=10),g.canvasStyle.transformOrigin="center center",g.canvasStyle.transform=`translate3d(0, 0, 10px) scale(${t})`,g.linmoFitCanvasTimer&&clearTimeout(g.linmoFitCanvasTimer),g.linmoFitCanvasTimer=setTimeout((()=>{u.handleLinmoFitCanvas(),u.handleDrawReferenceLine(),u.handleScaleFrame1()}),250)},handleResizeDraw(){u.drawPixelArea(),g.isScaling?u.handleScaleFrame():g.pinDouMode?u.handleDrawPindou(g.ctx1):u.reDraw(!1)},startDrawing(){var e;g.canvas.addEventListener("mousedown",u.start),g.canvas.addEventListener("mousemove",u.draw),g.canvas.addEventListener("mouseup",u.stop),g.canvas.addEventListener("touchstart",u.mobileStart),g.canvas.addEventListener("touchmove",u.mobileDraw),g.canvas.addEventListener("touchend",u.stop),g.canvas.addEventListener("mouseout",u.leave),g.canvas.addEventListener("wheel",u.handleWheelEvent),g.moveCanvas.addEventListener("wheel",u.handleWheelEvent),null==(e=document.getElementById("dropZone"))||e.addEventListener("mousemove",u.handleChangeMouseStyle)},handleLinmoFitCanvas(e=g.isLockCanvas){g.isLockCanvas=e,(g.linmoMode||g.linmoPhoto)&&g.isLockCanvas&&(t.$refs.LinmoModeDialog.posX=g.canvas.getBoundingClientRect().left-g.baseCanvas.getBoundingClientRect().left-10,t.$refs.LinmoModeDialog.posY=g.canvas.getBoundingClientRect().top-g.baseCanvas.getBoundingClientRect().top-10,t.$refs.LinmoModeDialog.width=g.canvas.getBoundingClientRect().width+20,t.$refs.LinmoModeDialog.height=g.canvas.getBoundingClientRect().height+20,t.$refs.LinmoModeDialog.updatelinmoPhotoStyle())},handleUpdateLinmoStyle(e){g.linmoPhotoStyle=e.style,t.$refs.LinmoModeDialog.posX=e.data.translateX,t.$refs.LinmoModeDialog.posY=e.data.translateY,t.$refs.LinmoModeDialog.width=e.data.width,t.$refs.LinmoModeDialog.height=e.data.height,t.$refs.LinmoModeDialog.rotate=e.data.rotate},handleMoveCanvasMouseDown(e){g.moveData.isMoving=!0;let a=na(g.canvas);g.moveData.x=e.clientX-g.moveCanvas.offsetLeft*a,g.moveData.y=e.clientY-g.moveCanvas.offsetTop*a,document.addEventListener("mousemove",u.handleMoveCanvasMouseMove),document.addEventListener("mouseup",u.handleMoveCanvasMouseUp)},handleMoveCanvasMouseMove(e){if(g.moveData.isMoving){let a=na(g.canvas),t=g.scale,r=g.moveCanvas.offsetLeft,l=g.moveCanvas.offsetTop;e.clientX>g.moveData.x+g.moveCanvas.offsetLeft*a+t*a/2?r+=t:e.clientX<g.moveData.x+g.moveCanvas.offsetLeft*a-t*a/2&&(r-=t),e.clientY>g.moveData.y+g.moveCanvas.offsetTop*a+t*a/2?l+=t:e.clientY<g.moveData.y+g.moveCanvas.offsetTop*a-t*a/2&&(l-=t),g.moveCanvas.style.left=`${r}px`,g.moveCanvas.style.top=`${l}px`}},handleMoveCanvasMouseUp(){g.moveData.isMoving=!1,document.removeEventListener("mousemove",u.handleMoveCanvasMouseMove),document.removeEventListener("mouseup",u.handleMoveCanvasMouseUp)},linmoPhotoStart(e){g.dragLinmoPhoto.enable=!0,g.dragLinmoPhoto.startX=e.offsetX,g.dragLinmoPhoto.startY=e.offsetY,g.dragLinmoPhoto.translateX=parseInt(getComputedStyle(g.linmoPhotoDom).transform.split(" ")[12]),g.dragLinmoPhoto.translateY=parseInt(getComputedStyle(g.linmoPhotoDom).transform.split(" ")[13]),document.addEventListener("mousemove",u.linmoPhotoMove),document.addEventListener("touchmove",u.linmoPhotoMobileMove),document.addEventListener("mouseup",u.linmoPhotoStop)},lnmoPhotoMobileStart(e){let a={offsetX:e.touches[0].clientX,offsetY:e.touches[0].clientY};u.linmoPhotoStart(a)},linmoPhotoMove(e){if(g.dragLinmoPhoto.enable){const a=e.offsetX-g.dragLinmoPhoto.startX,r=e.offsetY-g.dragLinmoPhoto.startY;g.dragLinmoPhoto.translateX+=a,g.dragLinmoPhoto.translateY+=r,t.$refs.LinmoModeDialog.posX=g.dragLinmoPhoto.translateX,t.$refs.LinmoModeDialog.posY=g.dragLinmoPhoto.translateY;let l=g.linmoPhotoStyle.transform.split(") ")[1]+")",n=g.linmoPhotoStyle.transform.split(") ")[2];g.linmoPhotoStyle.transform=`translate3d(${g.dragLinmoPhoto.translateX}px, ${g.dragLinmoPhoto.translateY}px, 10px) ${l} ${n}`}},linmoPhotoMobileMove(e){let a={offsetX:e.touches[0].clientX,offsetY:e.touches[0].clientY};u.linmoPhotoMove(a)},linmoPhotoStop(){g.dragLinmoPhoto.enable=!1,document.removeEventListener("mousemove",u.linmoPhotoMove),document.removeEventListener("touchmove",u.linmoPhotoMobileMove),document.removeEventListener("mouseup",u.linmoPhotoStop)},handleBrushColorAlpha(){let e=ha(g.brushColor),a=e[0],t=e[1],r=e[2],l=g.layerAlpha/100;return Ne([a,t,r,l])},mobileStart(e){let a={offsetX:e.touches[0].clientX-g.canvas.getBoundingClientRect().left,offsetY:e.touches[0].clientY-g.canvas.getBoundingClientRect().top};u.start(a)},start(e){if(e){u.stop();const a=Math.floor((e.offsetY-g.drawAreaList[0][1])/g.scale),r=Math.floor((e.offsetX-g.drawAreaList[0][0])/g.scale);if(g.isSpace)return g.isDragging=!0,g.dragData.x=e.clientX-g.canvas.offsetLeft,void(g.dragData.y=e.clientY-g.canvas.offsetTop);if(0===g.currentTool){if(!Oe(g.selectData.selectMapList))return t.$message.warning("请先取消选中区域");if(0===e.button)g.ctx1.fillStyle=u.handleBrushColorAlpha(),g.mouseDrawData.startX=e.offsetX-e.offsetX%(g.scale*g.brushSize),g.mouseDrawData.startY=e.offsetY-e.offsetY%(g.scale*g.brushSize),g.isDrawing=!0;else if(2===e.button){if("0000"===Array.from(g.ctx1.getImageData(e.offsetX,e.offsetY,1,1).data).join(""))return;g.mouseDrawData.startX=e.offsetX-e.offsetX%(g.scale*g.eraserSize),g.mouseDrawData.startY=e.offsetY-e.offsetY%(g.scale*g.eraserSize),g.isErasering=!0}u.draw(e)}else if(1===g.currentTool){if(!Oe(g.selectData.selectMapList))return t.$message.warning("请先取消选中区域");const l=Array.from(g.ctx1.getImageData(e.offsetX,e.offsetY,1,1).data);if("0000"===l.join(""))return;0===e.button?(g.mouseDrawData.startX=e.offsetX-e.offsetX%(g.scale*g.eraserSize),g.mouseDrawData.startY=e.offsetY-e.offsetY%(g.scale*g.eraserSize),g.isErasering=!0,u.draw(e)):2===e.button&&u.fillChunkSelect(r,a,Ne(l),!0)}else if(2===g.currentTool){const l=Array.from(g.ctx1.getImageData(e.offsetX,e.offsetY,1,1).data);if("0000"!==l.join("")&&(g.brushColor=Ne(l),t.$refs.ReplaceColorDialog.dialogVisible&&t.$refs.ReplaceColorDialog.handleUpdate(g.brushColor),g.pinDouDrawMode)){let e={color:g.brushColor,col:r,row:a};t.$refs.PindouDialog.selectedObj=e}}else if(3===g.currentTool){if(!Oe(g.selectData.selectMapList))return t.$message.warning("请先取消选中区域");g.isScaling&&u.handleCancelScale(),g.ctx1.fillStyle=u.handleBrushColorAlpha(),g.ctx1.strokeStyle=u.handleBrushColorAlpha(),g.ctx1.lineWidth=g.scale,g.ctx1.setLineDash([]),g.isDrawShape=!0;let e=r*g.scale+g.canvasBeginPos.x,l=a*g.scale+g.canvasBeginPos.y;g.lastX=e+g.scale/2,g.lastY=l+g.scale/2}else if(4===g.currentTool){let e=ga(g.brushColor)?Ne(He(g.brushColor)):Ne(Ye(g.brushColor));if(!Oe(g.selectData.selectMapList))return void u.handleReplaceColor(e);const t=u.getCurrentLayerColorByCoords(r,a);if(!t)return;u.fillChunk(r,a,t,e)}else if(5===g.currentTool&&g.pinDouMode){let e=r+a*g.canvasWidth,l=g.pinDouData.variables;for(let n=0;n<l.length;n++)if(l[n].isRender&&l[n].layerData[e][2]!==g.emptyColor){let s={name:l[n].layerData[e][3],color:l[n].layerData[e][2],col:r,row:a};t.$refs.PindouDialog.selectedObj=s;break}}else if(7777===g.currentTool);else if(8===g.currentTool&&"select"===g.selectType){g.isScaling&&u.handleCancelScale();let t=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex];if(!t.isRender)return;if(0===e.button){if(g.selectData.selectLayerId!==t.layerId&&t.layerData[r+a*g.canvasWidth][2]!==g.emptyColor&&(u.handleCancelSelect(),g.selectData.selectLayerId=t.layerId),g.isSelecting=!0,g.selectData.x=r,g.selectData.y=a,g.ctx1.lineWidth=1,g.isSelecting&&g.isShift&&(g.isMoving=!0,g.canvas.style.cursor="move",g.moveData.x=g.selectData.x,g.moveData.y=g.selectData.y,g.moveData.list=JSON.parse(JSON.stringify(g.selectData.selectList)),g.selectData.selectOriginList=ta(g.selectData.selectMapList),!g.selectData.copyList.length)){let e=Object.keys(g.selectData.selectOriginList);for(let a=0;a<e.length;a++){let r=e[a],l=g.selectData.selectOriginList[e[a]];for(const[e,a]of l){let e=a[0]+a[1]*g.canvasWidth;t.layerData[e][2]=g.emptyColor,t.layerNewData[r].delete(`${a[0]}/${a[1]}`)}}}u.draw(e)}else if(2===e.button){let e=t.layerData[r+a*g.canvasWidth][2];if(e===g.emptyColor)return;if(g.selectData.selectMapList[e]){let t=r+"/"+a;g.selectData.selectMapList[e].delete(t)}let l=g.selectData.selectList.findIndex((e=>e[0]===r&&e[1]===a));if(l>=0){let t=r*g.scale,n=a*g.scale;g.ctx1.fillStyle=e,g.ctx1.fillRect(t,n,g.scale,g.scale),g.selectData.selectList.splice(l,1)}}}else if(8===g.currentTool&&"quickSelect"===g.selectType){let t=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex];if(!t.isRender)return;if(0===e.button){if(g.selectData.selectLayerId!==t.layerId&&t.layerData[r+a*g.canvasWidth][2]!==g.emptyColor&&(u.handleCancelSelect(),g.selectData.selectLayerId=t.layerId),g.isSelecting=!0,g.selectData.x=r,g.selectData.y=a,g.ctx1.lineWidth=1,g.isSelecting&&g.isShift){if(g.isMoving=!0,g.canvas.style.cursor="move",g.moveData.x=g.selectData.x,g.moveData.y=g.selectData.y,g.moveData.list=JSON.parse(JSON.stringify(g.selectData.selectList)),g.selectData.selectOriginList=ta(g.selectData.selectMapList),!g.selectData.copyList.length){let e=Object.keys(g.selectData.selectOriginList);for(let a=0;a<e.length;a++){let r=e[a],l=g.selectData.selectOriginList[e[a]];for(const[e,a]of l){let e=a[0]+a[1]*g.canvasWidth;t.layerData[e][2]=g.emptyColor,t.layerNewData[r].delete(`${a[0]}/${a[1]}`)}}}return}const l=Array.from(g.ctx1.getImageData(e.offsetX,e.offsetY,1,1).data);"0000"!==l.join("")&&u.fillChunkSelect(r,a,Ne(l))}else 2===e.button&&u.handleCancelSelect()}else if(8===g.currentTool&&"rangeSelect"===g.selectType){let t=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex];if(!t.isRender)return;if(g.selectData.selectList.length&&g.selectData.selectList.find((e=>e[0]===r&&e[1]===a))?g.isSelecting=!0:(g.selectData.selectLayerId!==t.layerId&&(u.handleCancelSelect(),g.selectData.selectLayerId=t.layerId),g.isSelectDraging=!0,g.canvasRealLeft=g.baseCanvas.getBoundingClientRect().left,g.canvasRealTop=g.baseCanvas.getBoundingClientRect().top,g.lastX=e.clientX-g.canvasRealLeft,g.lastY=e.clientY-g.canvasRealTop),g.selectData.x=r,g.selectData.y=a,g.ctx1.lineWidth=1,g.ctx0.lineWidth=2,g.isSelecting&&g.isShift&&(g.isMoving=!0,g.canvas.style.cursor="move",g.moveData.x=g.selectData.x,g.moveData.y=g.selectData.y,g.moveData.list=JSON.parse(JSON.stringify(g.selectData.selectList)),g.selectData.selectOriginList=ta(g.selectData.selectMapList),!g.selectData.copyList.length)){let e=Object.keys(g.selectData.selectOriginList);for(let a=0;a<e.length;a++){let r=e[a],l=g.selectData.selectOriginList[e[a]];for(const[e,a]of l){let e=a[0]+a[1]*g.canvasWidth;t.layerData[e][2]=g.emptyColor,t.layerNewData[r].delete(`${a[0]}/${a[1]}`)}}}}else if(9===g.currentTool&&g.isScaling){if(!g.scaleAreaData)return;g.lastX=e.offsetX,g.lastY=e.offsetY,g.isScale=!0}}},handleReplaceColor(e){for(let a=0;a<g.selectData.selectList.length;a++){g.selectData.selectList[a][2]=e;let t=g.selectData.selectList[a][0]+g.selectData.selectList[a][1]*g.canvasWidth;g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[t][2]=e}u.reDraw()},handleReplacePindouColor(e,a){if(g.pinDouDrawMode)return u.handleConfirmReplaceColor(e,a);let r=Ne(He(e.replaceObj.color)),l=g.pinDouData.variables,n=g.pinDouData.colorStatList;if(1===e.type){for(let a=l.length-1;a>=0;a--)if(l[a].isRender)for(let t=0;t<l[a].layerData.length;t+=2){if(l[a].layerData[t][0]===e.originObj.col&&l[a].layerData[t][1]===e.originObj.row&&l[a].layerData[t][3]){l[a].layerData[t][2]=r,l[a].layerData[t][3]=e.replaceObj.name;break}if(t+1<l[a].layerData.length&&l[a].layerData[t+1][0]===e.originObj.col&&l[a].layerData[t+1][1]===e.originObj.row&&l[a].layerData[t+1][3]){l[a].layerData[t+1][2]=r,l[a].layerData[t+1][3]=e.replaceObj.name;break}}let s=n.get(e.originObj.name);if(!s)return t.$message.warning("当前选择颜色不存在"),void a();if(n.has(e.replaceObj.name)){let a=n.get(e.replaceObj.name)[1]+1;n.set(e.replaceObj.name,[r,a]),n.set(e.originObj.name,[s[0],s[1]-1])}else n.set(e.originObj.name,[s[0],s[1]-1]),n.set(e.replaceObj.name,[r,1])}else if(2===e.type){for(let a=l.length-1;a>=0;a--)if(l[a].isRender)for(let t=0;t<l[a].layerData.length;t+=2)l[a].layerData[t][3]&&l[a].layerData[t][3]===e.originObj.name&&(l[a].layerData[t][2]=r,l[a].layerData[t][3]=e.replaceObj.name),t+1<l[a].layerData.length&&l[a].layerData[t+1][3]&&l[a].layerData[t+1][3]===e.originObj.name&&(l[a].layerData[t+1][2]=r,l[a].layerData[t+1][3]=e.replaceObj.name);let s=n.get(e.originObj.name);if(!s)return t.$message.warning("当前选择颜色不存在"),void a();if(n.has(e.replaceObj.name)){let a=n.get(e.replaceObj.name),t=s[1]+a[1];n.delete(e.originObj.name),n.set(e.replaceObj.name,[r,t])}else n.delete(e.originObj.name),n.set(e.replaceObj.name,[r,s[1]])}const s=Array.from(n);s.sort(((e,a)=>a[1][1]-e[1][1])),g.pinDouData.colorStatList=new Map(s),t.$refs.PindouDialog.handleColorStatList(g.pinDouData.colorStatList),a(),u.handleDrawPindou(g.ctx1)},getCurrentLayerColorByCoords(e,a){let t=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData,r=e+a*g.canvasWidth;return t[r]?t[r][2]:null},fillChunk(e,a,t,r){if(t===r)return;g.loading=!0;let l=aa(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex]),n=i(o({},l),{layerNewData:ta(l.layerNewData)});g.worker.postMessage({type:9,variables:n,options:{x:e,y:a,targetColor:t,replacementColor:r},canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight,tolerance:g.tolerance}),g.worker.onmessage=e=>{g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData=e.data.layerData,g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData=e.data.layerNewData,g.loading=!1,u.reDraw()}},fillChunkSelect(e,a,t,r=!1){if(t===g.emptyColor)return;if(g.selectData.selectMapList[t]&&g.selectData.selectMapList[t].has(`${e}/${a}`))return;g.loading=!0;let l=aa(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData),n=aa(g.selectData);g.worker.postMessage({type:10,variables:l,selectData:n,options:{x:e,y:a,targetColor:t},canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight,tolerance:g.tolerance}),g.worker.onmessage=e=>{g.selectData.selectList=e.data.variables.selectList,g.selectData.selectMapList=e.data.variables.selectMapList,g.loading=!1,r?u.handleRemoveSelect():u.reDrawSelectData()}},handleChangeMouseStyle(e){if(!e)return;if(!g.scaleWhitePointPos.length)return;g.canvasRealLeft=g.baseCanvas.getBoundingClientRect().left,g.canvasRealTop=g.baseCanvas.getBoundingClientRect().top;let a=e.clientX-g.canvasRealLeft,t=e.clientY-g.canvasRealTop;Math.abs(a-g.scaleWhitePointPos[0][0])<=15&&Math.abs(t-g.scaleWhitePointPos[0][1])<=15&&(g.canvas.style.cursor="se-resize",g.scaleAreaData.cursor="se-resize")},drawSquareLine(e,a,t,r){const l=g.scale*g.brushSize,n=Math.abs(t-e),s=Math.abs(r-a),o=e<t?l:-l,i=a<r?l:-l;let c=n-s;for(;;){for(let t=0;t<g.brushSize;t++){let r=a+g.scale*t;for(let t=0;t<g.brushSize;t++){let l=e+g.scale*t,n=Math.floor(l/g.scale),s=Math.floor(r/g.scale);n>=0&&n<g.canvasWidth&&s>=0&&s<g.canvasHeight&&u.addDrawList(n,s,g.brushColor),u.checkLayerDrawOrder(l,r,g.scale);let o=-1,i=-1;if(g.isHorizontal)o=g.canvasWidth-1-n,i=s;else if(g.isVertical)o=n,i=g.canvasHeight-1-s;else if(g.isCenter){let t=2*g.canvasBeginPos.centerX-(e+g.scale/2),r=2*g.canvasBeginPos.centerY-(a+g.scale/2);o=Math.floor(t/g.scale),i=Math.floor(r/g.scale)}if(o>=0&&o<g.canvasWidth&&i>=0&&i<g.canvasHeight){u.addDrawList(o,i,g.brushColor);let e=o*g.scale,a=i*g.scale;u.checkLayerDrawOrder(e,a,g.scale)}}}if(e===t&&a===r)break;const l=2*c;l>-s&&(c-=s,e+=o),l<n&&(c+=n,a+=i)}},checkLayerDrawOrder(e,a,t){if(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender){let r=!1,l=Math.floor(e/g.scale)+Math.floor(a/g.scale)*g.canvasWidth;for(let e=0;e<g.currentLayerIndex;e++){let a=g.drawRecord[g.currentFrameIndex].layer[e];a.isRender&&a.layerData[l][2]!==g.emptyColor&&(r=!0)}if(!r)if(u.getCurrentLayerIsLock()){g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[l][2]===g.emptyColor&&g.ctx1.fillRect(e,a,t,t)}else g.ctx1.fillRect(e,a,t,t)}},eraseSquareLine(e,a,t,r){const l=g.scale*g.eraserSize,n=Math.abs(t-e),s=Math.abs(r-a),o=e<t?l:-l,i=a<r?l:-l;let c=n-s;for(;;){for(let t=0;t<g.eraserSize;t++){let r=a+g.scale*t;for(let t=0;t<g.eraserSize;t++){let l=e+g.scale*t,n=Math.floor(l/g.scale),s=Math.floor(r/g.scale);n>=0&&n<g.canvasWidth&&s>=0&&s<g.canvasHeight&&u.addRemoveDrawList(n,s,g.brushColor),u.checkLayerEraseOrder(l,r,g.scale);let o=-1,i=-1;if(g.isHorizontal)o=g.canvasWidth-1-n,i=s;else if(g.isVertical)o=n,i=g.canvasHeight-1-s;else if(g.isCenter){let t=2*g.canvasBeginPos.centerX-(e+g.scale/2),r=2*g.canvasBeginPos.centerY-(a+g.scale/2);o=Math.floor(t/g.scale),i=Math.floor(r/g.scale)}if(o>=0&&o<g.canvasWidth&&i>=0&&i<g.canvasHeight){u.addRemoveDrawList(o,i,g.brushColor);let e=o*g.scale,a=i*g.scale;u.checkLayerEraseOrder(e,a,g.scale)}}}if(e===t&&a===r)break;const l=2*c;l>-s&&(c-=s,e+=o),l<n&&(c+=n,a+=i)}},checkLayerEraseOrder(e,a,t){if(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender){let r=Math.floor(e/g.scale)+Math.floor(a/g.scale)*g.canvasWidth,l=g.drawRecord[g.currentFrameIndex].layer;l[g.currentLayerIndex].layerData[r][2]!==g.emptyColor&&g.ctx1.clearRect(e,a,t,t);for(let n=l.length-1;n>=0;n--)l[n].isRender&&n!==g.currentLayerIndex&&l[n].layerData[r]&&l[n].layerData[r][2]!==g.emptyColor&&(g.ctx1.fillStyle=l[n].layerData[r][2],g.ctx1.fillRect(e,a,t,t))}},draw(e){if(e){const a=Math.floor((e.offsetY-g.drawAreaList[0][1])/g.scale),t=Math.floor((e.offsetX-g.drawAreaList[0][0])/g.scale);if(g.isSpace){if(g.canvas.style.cursor="grabbing",g.isDragging){const a=e.clientX-g.dragData.x,t=e.clientY-g.dragData.y;g.canvas.style.left=`${a}px`,g.canvas.style.top=`${t}px`,g.moveBoxDom.style.left=`${a}px`,g.moveBoxDom.style.top=`${t}px`,g.bgCanvas.style.left=`${a}px`,g.bgCanvas.style.top=`${t}px`,g.gridCanvas.style.left=`${a}px`,g.gridCanvas.style.top=`${t}px`,u.handleDrawReferenceLine(),u.handleScaleFrame1(),g.linmoFitCanvasTimer&&clearTimeout(g.linmoFitCanvasTimer),g.linmoFitCanvasTimer=setTimeout((()=>{u.handleLinmoFitCanvas()}),250)}return}if(g.isShift&&g.isMoving&&g.isSelecting?g.canvas.style.cursor="move":(g.canvas.style.cursor="",u.addCursorClass(e)),g.gridInfo=`[${t}, ${a}]`,g.isDrawing){const a=e.offsetX-e.offsetX%(g.scale*g.brushSize),t=e.offsetY-e.offsetY%(g.scale*g.brushSize),r=g.mouseDrawData.startX,l=g.mouseDrawData.startY;u.drawSquareLine(r,l,a,t),g.mouseDrawData.startX=a,g.mouseDrawData.startY=t}else if(g.isErasering){const a=e.offsetX-e.offsetX%(g.scale*g.eraserSize),t=e.offsetY-e.offsetY%(g.scale*g.eraserSize),r=g.mouseDrawData.startX,l=g.mouseDrawData.startY;u.eraseSquareLine(r,l,a,t),g.mouseDrawData.startX=a,g.mouseDrawData.startY=t}else if(g.isDrawShape){if("rect"===g.currentDrawShape||"fillRect"===g.currentDrawShape){if(u.addShapeList(t,a),g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender){let e=g.drawShapeList[0][0],r=g.drawShapeList[0][1],l=t,n=a;g.drawShapeData.maxX=Math.max(e,l,g.drawShapeData.maxX),g.drawShapeData.maxY=Math.max(r,n,g.drawShapeData.maxY),g.drawShapeData.minX=Math.min(e,l,g.drawShapeData.minX),g.drawShapeData.minY=Math.min(r,n,g.drawShapeData.minY),g.drawShapeData.minX<0&&g.drawShapeData.minY<0&&(g.drawShapeData.minX=Math.min(e,l),g.drawShapeData.minY=Math.min(r,n)),g.drawShapeData.list=pa(g.drawShapeData);let s=g.drawShapeData.minX*g.scale,o=g.drawShapeData.minY*g.scale,i=g.drawShapeData.maxX*g.scale+g.scale-s,c=g.drawShapeData.maxY*g.scale+g.scale-o;g.ctx1.clearRect(s,o,i,c);let d=u.getRectIntersect(g.drawShapeData.list),h=[];h="fillRect"===g.currentDrawShape?u.drawFillRect(e,r,l,n):u.drawRect(e,r,l,n),u.reDrawPart(d),g.ctx1.fillStyle=u.handleBrushColorAlpha();for(let a=0;a<h.length;a++){let e=h[a][0]*g.scale,t=h[a][1]*g.scale;if(u.getCurrentLayerIsLock()){g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[h[a][0]+h[a][1]*g.canvasWidth][2]===g.emptyColor&&g.ctx1.fillRect(e,t,g.scale,g.scale)}else g.ctx1.fillRect(e,t,g.scale,g.scale)}}}else if("circle"===g.currentDrawShape){if(u.addShapeList(t,a),g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender){let e=g.drawShapeList[0][0],r=g.drawShapeList[0][1],l=t,n=a;g.drawShapeData.maxX=Math.max(e,l,g.drawShapeData.maxX),g.drawShapeData.maxY=Math.max(r,n,g.drawShapeData.maxY),g.drawShapeData.minX=Math.min(e,l,g.drawShapeData.minX),g.drawShapeData.minY=Math.min(r,n,g.drawShapeData.minY),g.drawShapeData.minX<0&&g.drawShapeData.minY<0&&(g.drawShapeData.minX=Math.min(e,l),g.drawShapeData.minY=Math.min(r,n)),g.drawShapeData.list=pa(g.drawShapeData);let s=g.drawShapeData.minX*g.scale,o=g.drawShapeData.minY*g.scale,i=g.drawShapeData.maxX*g.scale+g.scale-s,c=g.drawShapeData.maxY*g.scale+g.scale-o;g.ctx1.clearRect(s,o,i,c);let d=u.getRectIntersect(g.drawShapeData.list),h=u.drawCircle(e,r,l,n,g.scale);u.reDrawPart(d),g.ctx1.fillStyle=u.handleBrushColorAlpha();for(let a=0;a<h.length;a++){if(h[a][0]>g.canvasWidth||h[a][1]>g.canvasHeight||h[a][0]<0||h[a][1]<0)return;let e=h[a][0]*g.scale,t=h[a][1]*g.scale;if(u.getCurrentLayerIsLock()){g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[h[a][0]+h[a][1]*g.canvasWidth][2]===g.emptyColor&&g.ctx1.fillRect(e,t,g.scale,g.scale)}else g.ctx1.fillRect(e,t,g.scale,g.scale)}}}else if("line"===g.currentDrawShape){if(u.addShapeList(t,a),g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender){let e=g.drawShapeList[0][0],r=g.drawShapeList[0][1],l=t,n=a;g.drawShapeData.maxX=Math.max(e,l,g.drawShapeData.maxX),g.drawShapeData.maxY=Math.max(r,n,g.drawShapeData.maxY),g.drawShapeData.minX=Math.min(e,l,g.drawShapeData.minX),g.drawShapeData.minY=Math.min(r,n,g.drawShapeData.minY),g.drawShapeData.minX<0&&g.drawShapeData.minY<0&&(g.drawShapeData.minX=Math.min(e,l),g.drawShapeData.minY=Math.min(r,n)),g.drawShapeData.list=pa(g.drawShapeData);let s=g.drawShapeData.minX*g.scale,o=g.drawShapeData.minY*g.scale,i=g.drawShapeData.maxX*g.scale+g.scale-s,c=g.drawShapeData.maxY*g.scale+g.scale-o;g.ctx1.clearRect(s,o,i,c);let d=u.getRectIntersect(g.drawShapeData.list),h=u.drawLine(e,r,l,n);u.reDrawPart(d),g.ctx1.fillStyle=u.handleBrushColorAlpha();for(let a=0;a<h.length;a++){if(h[a][0]>g.canvasWidth||h[a][1]>g.canvasHeight||h[a][0]<0||h[a][1]<0)return;let e=h[a][0]*g.scale,t=h[a][1]*g.scale;if(u.getCurrentLayerIsLock()){g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[h[a][0]+h[a][1]*g.canvasWidth][2]===g.emptyColor&&g.ctx1.fillRect(e,t,g.scale,g.scale)}else g.ctx1.fillRect(e,t,g.scale,g.scale)}}}else if("curve"===g.currentDrawShape&&g.curveType.isPress&&(u.addShapeList(t,a),g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].isRender)){let e=g.drawShapeList[0][0],r=g.drawShapeList[0][1],l=t,n=a;if(e===l&&r===n)return;if(e===l||r===n){let a=0,t=0,s=0;if(e===l&&["3","4"].includes(g.curveType.pressKey)?(t=Math.round(Math.min(r,n)+Math.abs(n-r)/2),"3"===g.curveType.pressKey?a=Math.round(e-g.curvature)<=0?0:Math.round(e-g.curvature):"4"===g.curveType.pressKey&&(a=Math.round(e+g.curvature)>=g.canvasWidth?g.canvasWidth:Math.round(e+g.curvature)),s=Math.abs(n-r)):r===n&&["1","2"].includes(g.curveType.pressKey)&&(a=Math.round(Math.abs(l-e)/2+Math.min(e,l)),"1"===g.curveType.pressKey?t=Math.round(r-g.curvature)<=0?0:Math.round(r-g.curvature):"2"===g.curveType.pressKey&&(t=Math.round(r+g.curvature)>=g.canvasHeight?g.canvasHeight:Math.round(r+g.curvature)),s=Math.abs(l-e)),0===a&&0===t)return;let o=u.drawCurve({x:e,y:r},{x:a,y:t},{x:l,y:n},20+s);g.curveEndPos=[l,n],u.reDraw(!1);for(let e=0;e<o.length;e++){if(o[e][0]>g.canvasWidth||o[e][1]>g.canvasHeight)return;let a=o[e][0]*g.scale+g.canvasBeginPos.x,t=o[e][1]*g.scale+g.canvasBeginPos.y;g.ctx1.fillStyle=g.brushColor,g.ctx1.fillRect(a,t,g.scale,g.scale)}}}}else if(g.isMoving&&!g.isSelecting&&g.moveData.list.length,g.isSelecting){if(g.isMoving){let e=t-g.moveData.x,r=a-g.moveData.y;if(0===e&&0===r)return;let l=Object.keys(g.selectData.selectMapList);for(let a=0;a<l.length;a++){let e=g.selectData.selectMapList[l[a]];for(const[a,t]of e){let e=t,a=e[0]*g.scale,r=e[1]*g.scale;g.ctx1.clearRect(a,r,g.scale,g.scale)}}if(g.selectData.copySelectMapList){let e=Object.keys(g.selectData.copySelectMapList);for(let a=0;a<e.length;a++){g.ctx1.fillStyle=e[a];let t=g.selectData.copySelectMapList[e[a]];for(const[e,a]of t){let e=a,t=e[0]*g.scale,r=e[1]*g.scale;g.ctx1.fillRect(t,r,g.scale,g.scale)}}}let n=u.getRectIntersectV2(g.selectData.selectMapList);for(let a=0;a<l.length;a++){let t=g.selectData.selectMapList[l[a]];for(const[n,s]of t){let t=s,o=t[0]+e,i=t[1]+r;g.selectData.selectMapList[l[a]].set(n,[o,i])}}g.moveData.x=t,g.moveData.y=a,u.reDrawPartV2(n);for(let a=0;a<g.moveData.list.length;a++)g.moveData.list[a][0]+=e,g.moveData.list[a][1]+=r;return void(g.selectData.selectList=JSON.parse(JSON.stringify(g.moveData.list)))}if("rangeSelect"===g.selectType)return;let e=u.getCurrentLayerColorByCoords(t,a);if(e!==g.emptyColor){g.selectData.x=t,g.selectData.y=a;let r=t+"/"+a;if(g.selectData.selectMapList[e]||(g.selectData.selectMapList[e]=new Map),!g.selectData.selectMapList[e].has(r)){g.selectData.selectMapList[e].set(r,[t,a]);let l=g.selectData.x*g.scale,n=g.selectData.y*g.scale;g.ctx1.strokeStyle=g.selectActiveColor,g.ctx1.strokeRect(l+1,n+1,g.scale-2,g.scale-2)}g.selectData.selectList.findIndex((e=>e[0]===g.selectData.x&&e[1]===g.selectData.y))<0&&g.selectData.selectList.push([g.selectData.x,g.selectData.y,e])}}else if(g.isScale){g.canvas.style.cursor=g.scaleAreaData.cursor;const a=e.offsetX-g.lastX,t=e.offsetY-g.lastY;if(a>=g.scale-5&&t>=g.scale-5||a<=5-g.scale&&t<=5-g.scale){a>=g.scale-5||t>=g.scale-5?g.scaleRatio=g.scaleRatio+=1:(a<=5-g.scale||t<=5-g.scale)&&(g.scaleRatio=g.scaleRatio-=1),g.lastX=e.offsetX,g.lastY=e.offsetY,g.scaleAreaData.coordMaxtrix.length+g.scaleRatio===0&&(g.scaleRatio+=1);let r=na(g.canvas),l=(g.scaleAreaData.maxX+g.scaleRatio)*g.scale*r+g.scale*r,n=g.scaleAreaData.minX*g.scale*r,s=(g.scaleAreaData.maxY+g.scaleRatio)*g.scale*r+g.scale*r,o=g.scaleAreaData.minY*g.scale*r,i=g.scaleAreaData.minX*g.scale,c=g.scaleAreaData.minY*g.scale,d=(g.scaleAreaData.maxX+g.scaleRatio)*g.scale+g.scale-i,h=(g.scaleAreaData.maxY+g.scaleRatio)*g.scale+g.scale-c;a>=g.scale-5||t>=g.scale-5?(g.drawShapeData.list=pa({maxX:g.scaleAreaData.maxX+g.scaleRatio,maxY:g.scaleAreaData.maxY+g.scaleRatio,minX:g.scaleAreaData.minX,minY:g.scaleAreaData.minY}),g.ctx1.clearRect(i,c,d,h)):(g.drawShapeData.list=pa({maxX:g.scaleAreaData.maxX+g.scaleRatio+1,maxY:g.scaleAreaData.maxY+g.scaleRatio+1,minX:g.scaleAreaData.minX,minY:g.scaleAreaData.minY}),g.ctx1.clearRect(i,c,d+g.scale,h+g.scale));let p=u.getRectIntersect(g.drawShapeData.list).filter((e=>!g.scaleAreaData.originArr.find((a=>a[0]===e[0]&&a[1]===e[1])))),m=ia(g.scaleAreaData,g.scaleRatio),f=ca(g.scaleAreaData,g.scaleRatio);g.scaleAreaData.scaledCoordMap=m,g.scaleAreaData.scaledColorMap=f,u.reDrawPart(p);for(let e=0;e<m.length;e++)for(let a=0;a<m[e].length;a++){let t=m[e][a][0]*g.scale,r=m[e][a][1]*g.scale;g.ctx1.fillStyle=f[e][a][0],g.ctx1.fillRect(t,r,g.scale,g.scale)}u.handleDrawReferenceLine(),u.handleDrawScaleFrame(n-5,o-5,l+5,s+5)}}else if(g.isSelectDraging&&"rangeSelect"===g.selectType){const r=e.clientX-g.canvasRealLeft-g.lastX,l=e.clientY-g.canvasRealTop-g.lastY;u.handleDrawReferenceLine(),g.ctx0.strokeStyle="green",g.ctx0.setLineDash([]),g.ctx0.beginPath(),g.ctx0.globalCompositeOperation="destination-out",g.ctx0.fillRect(g.lastX,g.lastY,r,l),g.ctx0.globalCompositeOperation="source-over",g.ctx0.moveTo(g.lastX,g.lastY),g.ctx0.lineTo(g.lastX+r,g.lastY),g.ctx0.lineTo(g.lastX+r,g.lastY+l),g.ctx0.lineTo(g.lastX,g.lastY+l),g.ctx0.lineTo(g.lastX,g.lastY),g.ctx0.stroke(),g.ctx0.closePath(),g.selectData.endX=t,g.selectData.endY=a}}else g.canvas.classList=""},mobileDraw(e){let a={offsetX:e.touches[0].clientX-g.canvas.getBoundingClientRect().left,offsetY:e.touches[0].clientY-g.canvas.getBoundingClientRect().top};u.draw(a)},handleCancelSelect(){if(Oe(g.selectData.selectMapList))return;if(!g.selectData.selectList.length)return;let e=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData,a=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData,t=Object.keys(g.selectData.selectMapList);for(let r=0;r<t.length;r++){let l=t[r],n=g.selectData.selectMapList[l];for(const[t,r]of n){let t=r[0],n=r[1],s=t+"/"+n;if(a[l]){a[l].set(s,[t,n]),e[t+n*g.canvasWidth][2]=l}else{a[l]=new Map,a[l].set(s,[t,n]),e[t+n*g.canvasWidth][2]=l}}}g.selectData.copySelectMapList=null,g.selectData.selectMapList={},u.reDraw(),g.selectData.isCancelSelect=!0,g.selectData.selectLayerId=0,g.selectData.selectList=[],g.selectData.selectOriginList=[],g.selectData.originList=[],g.selectData.copyList=[],g.isMoving=!1,g.isSelecting=!1,g.isScaling&&u.handleCancelScale()},handleRemoveSelect(){if(Oe(g.selectData.selectMapList))return;if(!g.selectData.selectList.length)return;let e=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData,a=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData,t=Object.keys(g.selectData.selectMapList);for(let r=0;r<t.length;r++){let a=t[r],l=g.selectData.selectMapList[a];for(const[t,r]of l){let t=r[0]+"/"+r[1];e[a].delete(t)}}g.selectData.selectMapList={},g.selectData.copySelectMapList=null,u.reDraw();for(let r=0;r<g.selectData.selectList.length;r++){if(g.selectData.selectList[r][0]>=g.canvasWidth||g.selectData.selectList[r][1]>=g.canvasHeight||g.selectData.selectList[r][0]<0||g.selectData.selectList[r][1]<0)continue;let e=g.selectData.selectList[r][0]+g.selectData.selectList[r][1]*g.canvasWidth;a[e][2]!==g.emptyColor&&(a[e][2]=g.emptyColor)}g.selectData.selectList=[],g.selectData.copyList=[],g.isMoving=!1,g.isSelecting=!1},getRectIntersectV2(e){let a=g.drawRecord[g.currentFrameIndex].layer,t={};for(let r=a.length-1;r>=0;r--)if(a[r].isRender){let l=Object.keys(e);for(let n=0;n<l.length;n++){let s=e[l[n]];for(const[e,l]of s){let e=l,n=e[0]+e[1]*g.canvasWidth;if(!(n<0||n>a[r].layerData.length-1)&&(!(a[r].layerData[n][0]>=g.canvasWidth||a[r].layerData[n][1]>=g.canvasHeight||a[r].layerData[n][0]<0||a[r].layerData[n][1]<0)&&a[r].layerData[n]&&a[r].layerData[n][2]!==g.emptyColor)){t[a[r].layerData[n][2]]||(t[a[r].layerData[n][2]]=new Map);let e=a[r].layerData[n][0]+"/"+a[r].layerData[n][1];t[a[r].layerData[n][2]].set(e,[a[r].layerData[n][0],a[r].layerData[n][1]])}}}}return t},getRectIntersect(e){let a=g.drawRecord[g.currentFrameIndex].layer,t=[];for(let r=a.length-1;r>=0;r--)if(a[r].isRender)for(let l=0;l<e.length;l++){let n=e[l][0]+e[l][1]*g.canvasWidth;n<0||n>a[r].layerData.length-1||(a[r].layerData[n][0]>=g.canvasWidth||a[r].layerData[n][1]>=g.canvasHeight||a[r].layerData[n][0]<0||a[r].layerData[n][1]<0||a[r].layerData[n]&&a[r].layerData[n][2]!==g.emptyColor&&t.push(a[r].layerData[n]))}return t},startDrag(e,a){if(g.isDragging){const t=e-g.dragData.x,r=a-g.dragData.y;let l=g.drawAreaList[0][0]+t,n=g.drawAreaList[0][1]+r,s=l+g.scale*g.canvasWidth/2,o=n+g.scale*g.canvasHeight/2;u.drawPixelArea(),g.isScaling?u.handleScaleFrame({x:l,y:n,centerX:s,centerY:o}):g.pinDouMode?u.handleDrawPindou(g.ctx1,{x:l,y:n,centerX:s,centerY:o}):u.reDraw(!1,!1)}},handleScaleFrame1(){if(g.isScaling){let e=na(g.canvas),a=(g.scaleAreaData.maxX+g.scaleRatio)*g.scale*e+g.scale*e,t=g.scaleAreaData.minX*g.scale*e,r=(g.scaleAreaData.maxY+g.scaleRatio)*g.scale*e+g.scale*e,l=g.scaleAreaData.minY*g.scale*e;u.handleDrawScaleFrame(t-5,l-5,a+5,r+5,!1)}},handleScaleFrame(e=g.canvasBeginPos){if(g.isScaling){let e=na(g.canvas),a=(g.scaleAreaData.maxX+g.scaleRatio)*g.scale*e+g.scale*e,t=g.scaleAreaData.minX*g.scale*e,r=(g.scaleAreaData.maxY+g.scaleRatio)*g.scale*e+g.scale*e,l=g.scaleAreaData.minY*g.scale*e;if(g.scaleAreaData.scaledCoordMap){g.drawShapeData.list=pa({maxX:g.scaleAreaData.maxX+g.scaleRatio,maxY:g.scaleAreaData.maxY+g.scaleRatio,minX:g.scaleAreaData.minX,minY:g.scaleAreaData.minY});let e=g.scaleAreaData.minX*g.scale,a=g.scaleAreaData.minY*g.scale,t=(g.scaleAreaData.maxX+g.scaleRatio)*g.scale+g.scale-e,r=(g.scaleAreaData.maxY+g.scaleRatio)*g.scale+g.scale-a;g.ctx1.clearRect(e,a,t,r);let l=u.getRectIntersect(g.drawShapeData.list);u.reDrawPart(l);for(let n=0;n<g.scaleAreaData.scaledCoordMap.length;n++)for(let e=0;e<g.scaleAreaData.scaledCoordMap[n].length;e++){let a=g.scaleAreaData.scaledCoordMap[n][e][0]*g.scale,t=g.scaleAreaData.scaledCoordMap[n][e][1]*g.scale;g.ctx1.fillStyle=g.scaleAreaData.scaledColorMap[n][e][0],g.ctx1.fillRect(a,t,g.scale,g.scale)}}else u.reDraw(!1,!1);u.handleDrawScaleFrame(t-5,l-5,a+5,r+5,!1)}},addDrawList(e,a,t){g.drawList.push([e,a,t])},addRemoveDrawList(e,a,t){g.removeDrawList.push([e,a,t])},addShapeList(e,a){g.drawShapeList.push([e,a])},drawCircle(e,a,t,r,l){let n,s,o,i=La(e,a,t,r),c=[],d=Math.round((i.x0+i.x1)/2),h=Math.round((i.y0+i.y1)/2),g=(i.x0+i.x1)%2,p=(i.y0+i.y1)%2,u=i.x1-d,m=i.y1-h;for(n=i.x0;n<=d;n++)o=Math.acos((n-d)/u),s=Math.round(m*Math.sin(o)+h),c.push([n-g,s]),c.push([n-g,2*h-s-p]),c.push([2*d-n,s]),c.push([2*d-n,2*h-s-p]);for(s=i.y0;s<=h;s++)o=Math.asin((s-h)/m),n=Math.round(u*Math.cos(o)+d),c.push([n,s-p]),c.push([2*d-n-g,s-p]),c.push([n,2*h-s]),c.push([2*d-n-g,2*h-s]);return ua(c)},drawCurve(e,a,t,r){const l=[];for(let s=0;s<=r;s++){let n=s/r,o=Math.round(Math.pow(1-n,2)*e.x+2*n*(1-n)*a.x+Math.pow(n,2)*t.x),i=Math.round(Math.pow(1-n,2)*e.y+2*n*(1-n)*a.y+Math.pow(n,2)*t.y);l.push([o,i])}let n=ua(l);return n=n.filter((e=>e[0]>=0&&e[1]>=0)),n},drawLine(e,a,t,r){const l=Math.abs(t-e),n=e<t?1:-1,s=-Math.abs(r-a),o=a<r?1:-1;let i,c=l+s,d=!1,h=[];for(;!d;)e>=0&&e<=g.canvasWidth&&a>=0&&a<=g.canvasHeight&&h.push([e,a]),e===t&&a===r?d=!0:(i=2*c,i>s&&(c+=s,e+=n),i<l&&(c+=l,a+=o));return ua(h)},drawRect(e,a,t,r){let l=Math.abs(e-t),n=Math.abs(a-r),s=[];if(n<=1)for(let o=0;o<n+1;o++)for(let r=0;r<l+1;r++){let l,n;e>t?(l=e-r,n=a-o,s.push([l,n])):(l=e+r,n=a+o,s.push([l,n]))}else{for(let n=0;n<=l;n++){let l,o,i,c;e>t?(l=e-n,o=a,s.push([l,o]),i=t+n,c=r,s.push([i,c])):(l=e+n,o=a,s.push([l,o]),i=t-n,c=r,s.push([i,c]))}for(let l=0;l<=n;l++){let n,o,i,c;a>r?(n=e,o=a-l,s.push([n,o]),i=t,c=r+l,s.push([i,c])):(n=e,o=a+l,s.push([n,o]),i=t,c=r-l,s.push([i,c]))}}return ua(s)},drawFillRect(e,a,t,r){let l=Math.abs(e-t),n=Math.abs(a-r),s=[];if(n<=1)for(let o=0;o<n+1;o++)for(let r=0;r<l+1;r++){let l,n;e>t?(l=e-r,n=a-o,s.push([l,n,g.brushColor])):(l=e+r,n=a+o,s.push([l,n,g.brushColor]))}else{for(let r=0;r<n+1;r++)for(let n=0;n<l+1;n++){let l,o;e>t?(l=e-n,o=a-r,s.push([l,o,g.shapeFillColor])):(l=e+n,o=a+r,s.push([l,o,g.shapeFillColor]))}for(let n=0;n<=l;n++){let l,o,i,c;e>t?(l=e-n,o=a,s.push([l,o,g.brushColor]),i=t+n,c=r,s.push([i,c,g.brushColor])):(l=e+n,o=a,s.push([l,o,g.brushColor]),i=t-n,c=r,s.push([i,c,g.brushColor]))}for(let l=0;l<=n;l++){let n,o,i,c;a>r?(n=e,o=a-l,s.push([n,o,g.brushColor]),i=t,c=r+l,s.push([i,c,g.brushColor])):(n=e,o=a+l,s.push([n,o,g.brushColor]),i=t,c=r-l,s.push([i,c,g.brushColor]))}}return ua(s)},handleLayerImg(){let e=1;e=g.canvasWidth>g.canvasHeight?Math.floor(Math.max(1,40/g.canvasWidth)):Math.floor(Math.max(1,40/g.canvasHeight)),g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData;let a=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData,t=0;g.realCanvas.width=g.canvasWidth*e,g.realCanvas.height=g.canvasHeight*e,g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height),g.ctx3.globalAlpha=1,Oe(a)&&t++;let r=Object.keys(a);for(let l=0;l<r.length;l++){g.ctx3.fillStyle=r[l];let t=a[r[l]];for(const[a,r]of t){let a=r,t=a[0]*e,l=a[1]*e;g.ctx3.fillRect(t,l,e,e)}}g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].currentLayerImg=t>0?g.layerGridImage:g.realCanvas.toDataURL("image/png")},handleGridImg(){g.realCanvas.width=40,g.realCanvas.height=40,g.ctx3.globalAlpha=.25,g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height);for(let e=0;e<g.realCanvas.height;e++)for(let a=0;a<g.realCanvas.width;a++)g.ctx3.fillStyle=(e+a)%2==0?"rgba(0, 0, 0, 0.5)":"rgba(100, 100, 100, 0.5)",g.ctx3.fillRect(6*a,6*e,6,6);g.layerGridImage=g.realCanvas.toDataURL("image/png")},handleFrameImg(e,a=!0){let t=Math.max(g.canvasWidth,g.canvasHeight),r=Math.ceil(66/t),l=0;const n=g.drawRecord[g.currentFrameIndex].layer;g.realCanvas.width=g.canvasWidth*r,g.realCanvas.height=g.canvasHeight*r,g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height),g.ctx3.globalAlpha=1;for(let s=n.length-1;s>=0;s--)if(n[s].isRender){Oe(n[s].layerNewData)&&l++;let e=Object.keys(n[s].layerNewData);for(let a=0;a<e.length;a++){g.ctx3.fillStyle=e[a];let t=n[s].layerNewData[e[a]];for(const[e,a]of t){let e=a,t=e[0]*r,l=e[1]*r;g.ctx3.fillRect(t,l,r,r)}}}if(l>=n.length)g.drawRecord[g.currentFrameIndex].currentFrameImg="";else{let e=g.realCanvas.toDataURL("image/png");g.drawRecord[g.currentFrameIndex].currentFrameImg=e}u.handleLayerImg(),g.colorStatList=ta(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData),a&&u.handleAddHistory()},handleExportPindouToExcel(e,a){l.handlePindouToExcel(JSON.parse(JSON.stringify(g.pinDouData)),g.pinDouData.colorStatList,o({canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight,filename:`拼豆 - ${g.projectData.projectName}`},a),(a=>{e(),t.$message.success(a)}),(a=>{e(),t.$message.error(a)}))},handleExportPindou(e,{isShowGrid:a,isShowRulers:t,isShowCirclePoint:r,isShowRectPoint:l,rulersBackgroundColor:n,pointColor:s,rulersColor:o,gridColor:i,isShowTongji:c,isShowBrand:d,brandName:h,background:p}){const m=document.createElement("canvas"),f=m.getContext("2d"),y=document.createElement("canvas");let v=30,D=t?30:0,w=v*g.canvasWidth/8,x=Math.max(Math.floor(w-20),60),C=Math.max(40,x-20);y.width=g.canvasWidth*v+2*D,y.height=g.canvasHeight*v+2*D,m.width=y.width+80,m.height=y.height+40+C;const L=y.getContext("2d");L.imageSmoothingEnabled=!0;const S=g.pinDouData.variables;if(L.fillStyle=p,L.fillRect(D,D,g.canvasWidth*v,g.canvasHeight*v),t){L.fillStyle=n,L.fillRect(0,0,y.width,v),L.fillRect(0,y.height-v,y.width,v),L.fillRect(0,v,v,y.height-60),L.fillRect(y.width-v,v,v,y.height-60),L.font="bold 14px Arial",L.textAlign="center",L.fillStyle=o;for(let e=0;e<g.canvasHeight;e++){let a=D/2,t=v*e+45+5,r=y.width-D/2,l=t;L.fillText((e+1).toString(),a,t),L.fillText((g.canvasHeight-e).toString(),r,l)}for(let e=0;e<g.canvasWidth;e++){let a=v*e+45,t=D/2+5,r=a,l=y.height-D/2;L.fillText((e+1).toString(),a,t),L.fillText((g.canvasWidth-e).toString(),r,l+4)}}let b=new Map;for(let u=S.length-1;u>=0;u--)if(S[u].isRender)for(let e=0;e<g.canvasHeight;e++)for(let a=0;a<g.canvasWidth;a++){let t=S[u].layerData[a+e*g.canvasWidth][2];if(t===g.emptyColor?b.has(`${a}-${e}`)||(L.fillStyle=s,r?(L.beginPath(),L.arc(a*v+D+15,e*v+D+15,3,0,2*Math.PI),L.fill()):l&&L.fillRect(a*v+D+15-3,e*v+D+15-3,6,6)):(b.has(`${a}-${e}`)||b.set(`${a}-${e}`,!0),L.fillStyle=t,L.fillRect(a*v+D,e*v+D,v,v)),S[u].layerData[a+e*g.canvasWidth][3]){let t=a*v+D,r=e*v+D,l=15;L.font=`400 ${l}px Arial`;let n=~~L.measureText(S[u].layerData[a+e*g.canvasWidth][3]).width;l=ma(n,l),L.font=`400 ${l}px Arial`,n=~~L.measureText(S[u].layerData[a+e*g.canvasWidth][3]).width,L.textAlign="start",L.fillStyle=je(S[u].layerData[a+e*g.canvasWidth][2]);const s=t+(v-n)/2,o=r+(v-l)/2+l;L.fillText(S[u].layerData[a+e*g.canvasWidth][3],~~s,~~o)}}if(a){L.strokeStyle=i,L.beginPath();for(let e=0;e<=g.canvasHeight;e++)L.moveTo(0,e*v+D),L.lineTo((g.canvasWidth+2)*v,e*v+D);for(let e=0;e<=g.canvasWidth;e++)L.moveTo(e*v+D,0),L.lineTo(e*v+D,(g.canvasHeight+2)*v);L.stroke()}f.drawImage(y,40,40);const k=document.createElement("canvas"),R=k.getContext("2d");if(d){k.width=y.width,k.height=x+20,m.height=m.height+k.height,R.fillStyle="white",R.fillRect(0,0,k.width,k.height);let e=Math.floor(x/4)+2;R.font=`bold ${e}px PixelFont`,R.fillStyle="black",R.textAlign="center",R.fillText(h,k.width/2,k.height/2+20),f.drawImage(y,40,40),f.drawImage(k,40,y.height+40)}else k.width=y.width,k.height=60,m.height=m.height+k.height,R.fillStyle="white",R.fillRect(0,0,k.width,k.height),f.drawImage(y,40,40),f.drawImage(k,40,y.height+40);const I=document.createElement("canvas"),M=I.getContext("2d");if(c){const e=g.pinDouData.colorStatList;I.width=y.width;let a=8,t=Math.ceil(e.size/a);I.height=t*x*2,M.fillStyle="white",M.fillRect(0,0,I.width,I.height);let r=0,l=Array.from(e);for(let n=0;n<l.length;n++){n%a==0&&(r=0);let e=Math.ceil((n+1)/a);M.fillStyle=l[n][1][0];let t=w*r+D+w/2-(x-10)/2,s=2*x*(e-1)+10,o=t+x/2,i=s+x/2;u.drawRoundedRect(M,t,s,x,x,20);let c=Math.floor(x/4);M.font=`bold ${c}px PixelFont`,M.fillStyle=je(l[n][1][0]),M.textAlign="center",M.fillText(l[n][0],o,i+c/2-2),M.fillStyle="black",M.textAlign="center";let d=t+x/2,h=s+x/2+5+x;M.fillText(l[n][1][1],d,h-8),r++}m.height=m.height+I.height,f.drawImage(y,40,40),f.drawImage(k,40,y.height+40),f.drawImage(I,40,y.height+k.height+40)}f.fillStyle="white",f.fillRect(0,m.height-C,m.width,C),f.fillRect(0,0,m.width,40),f.fillRect(0,40,40,m.height-80),f.fillRect(m.width-40,40,40,m.height-80);let A=Math.floor(x/4);f.font=`normal ${A}px PixelFont`,f.textAlign="center";const F=f.createLinearGradient(0,0,m.width,0);F.addColorStop(0,"#FFD700"),F.addColorStop(.25,"#FFEC8B"),F.addColorStop(.5,"#FFA500"),F.addColorStop(.75,"#FFEC8B"),F.addColorStop(1,"#FFD700"),f.fillStyle=F,f.fillText("By 像素格子",m.width/2,m.height-C/2),fa(m,"拼豆图 - "+g.projectData.projectName),e()},drawRoundedRect(e,a,t,r,l,n){e.beginPath(),e.moveTo(a+n,t),e.lineTo(a+r-n,t),e.quadraticCurveTo(a+r,t,a+r,t+n),e.lineTo(a+r,t+l-n),e.quadraticCurveTo(a+r,t+l,a+r-n,t+l),e.lineTo(a+n,t+l),e.quadraticCurveTo(a,t+l,a,t+l-n),e.lineTo(a,t+n),e.quadraticCurveTo(a,t,a+n,t),e.closePath(),e.fill()},addDrawRecord(e,a=!0){let t=e[0]+e[1]*g.canvasWidth;if(t>=g.canvasWidth*g.canvasHeight)return;let r=e[0]+"/"+e[1],l=e[2],n=ha(l),s=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData,o=s[t][2],i=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData;if("0000"!==n.join("")){let a=n,l=a[0],c=a[1],d=a[2],h=g.layerAlpha/100,p=Ne([l,c,d,h]);s[t][2]=p,i[o]&&i[o].has(r)&&i[o].delete(r),i[p]?i[p].has(r)||i[p].set(r,[e[0],e[1]]):(i[p]=new Map,i[p].set(r,[e[0],e[1]]))}a&&(g.FrameTimer&&clearTimeout(g.FrameTimer),g.FrameTimer=setTimeout((()=>{u.handleFrameImg(g.ctx1)}),300))},removeDrawRecord(e,a=!0){let t=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData,r=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData,l=e[0]+e[1]*g.canvasWidth,n=r[l][2];if(r[l][2]===g.emptyColor)return;r[l][2]=g.emptyColor;let s=e[0]+"/"+e[1];t[n]&&t[n].has(s)&&t[n].delete(s),a&&u.reDraw()},handlePindouHighlight(e){if(!e.isHighlight)return g.pindouHighlight=null,void u.handleDrawPindou(g.ctx1);g.pindouHighlight=e,u.handleDrawPindou(g.ctx1,g.canvasBeginPos,e)},handlePindouBlockHighlight(e){if(!e)return;u.handleDrawGridLine();let{startCol:a,endCol:t,startRow:r,endRow:l}=e,n=a*g.scale,s=t*g.scale,o=r*g.scale,i=s-n,c=l*g.scale-o;g.pindouHighlightOptions={startCol:a,endCol:t,startRow:r,endRow:l},g.ctx4.save(),g.ctx4.beginPath(),g.ctx4.rect(0,0,g.canvas.width,g.canvas.height),g.ctx4.rect(n,o,i,c),g.ctx4.clip("evenodd"),g.ctx4.fillStyle="rgba(0, 0, 0, 0.7)",g.ctx4.fillRect(0,0,g.canvas.width,g.canvas.height),g.ctx4.restore()},handleDrawPindou(e,a=g.canvasBeginPos,t=g.pindouHighlight){e.clearRect(0,0,g.canvas.width,g.canvas.height);let r=g.pinDouData.variables;e.imageSmoothingEnabled=!0;for(let l=r.length-1;l>=0;l--)if(r[l].isRender)for(let n=0;n<r[l].layerData.length;n++)if(!(r[l].layerData[n][0]>=g.canvasWidth||r[l].layerData[n][1]>=g.canvasHeight||r[l].layerData[n][0]<0||r[l].layerData[n][1]<0)&&r[l].layerData[n][2]!==g.emptyColor){let s=r[l].layerData[n][0]*g.scale+a.x,o=r[l].layerData[n][1]*g.scale+a.y;if(e.fillStyle=r[l].layerData[n][2],e.fillRect(s,o,g.scale,g.scale),r[l].layerData[n][3]&&!t){let a=~~(g.scale/2);e.font=`${a}px Arial sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial Narrow, Times, "Times New Roman"`;let t=~~e.measureText(r[l].layerData[n][3]).width;a=ma(t,a),e.font=`${a}px Arial sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial Narrow, Times, "Times New Roman"`,t=~~e.measureText(r[l].layerData[n][3]).width,e.fillStyle=je(r[l].layerData[n][2]);const i=s+(g.scale-t)/2,c=o+(g.scale-a)/2+a;e.fillText(r[l].layerData[n][3],~~i,~~c)}if(r[l].layerData[n][3]&&t)if(1===t.type){if(r[l].layerData[n][0]===t.selectedObj.col&&r[l].layerData[n][1]===t.selectedObj.row){let a=~~(g.scale/2);e.font=`${a}px Arial sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial Narrow, Times, "Times New Roman"`;let t=~~e.measureText(r[l].layerData[n][3]).width;a=ma(t,a),e.font=`${a}px Arial sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial Narrow, Times, "Times New Roman"`,t=~~e.measureText(r[l].layerData[n][3]).width,e.fillStyle=je(r[l].layerData[n][2]);const i=s+(g.scale-t)/2,c=o+(g.scale-a)/2+a;e.fillText(r[l].layerData[n][3],~~i,~~c)}}else if(2===t.type&&r[l].layerData[n][3]===t.selectedObj.name){let a=~~(g.scale/2);e.font=`${a}px Arial sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial Narrow, Times, "Times New Roman"`;let t=~~e.measureText(r[l].layerData[n][3]).width;a=ma(t,a),e.font=`${a}px Arial sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial Narrow, Times, "Times New Roman"`,t=~~e.measureText(r[l].layerData[n][3]).width,e.fillStyle=je(r[l].layerData[n][2]);const i=s+(g.scale-t)/2,c=o+(g.scale-a)/2+a;e.fillText(r[l].layerData[n][3],~~i,~~c)}}g.loading=!1},reDrawPartV2(e){let a=Object.keys(e);for(let t=0;t<a.length;t++){g.ctx1.fillStyle=a[t];let r=e[a[t]];for(const[e,a]of r){let e=a,t=e[0]*g.scale,r=e[1]*g.scale;g.ctx1.fillRect(t,r,g.scale,g.scale)}}u.reDrawSelectData()},reDrawPart(e){for(let a=0;a<e.length;a++){if(e[a][0]>=g.canvasWidth||e[a][1]>=g.canvasHeight||e[a][0]<0||e[a][1]<0)continue;let t=e[a][0]*g.scale,r=e[a][1]*g.scale;g.ctx1.fillStyle=e[a][2],g.ctx1.fillRect(t,r,g.scale,g.scale)}u.reDrawSelectData()},reDrawV2(e,a=!0,t=!0,r=g.currentLayerIndex,l=!1){let n=g.drawRecord[g.currentFrameIndex].layer;if(l||g.ctx1.translate(0,0),a&&g.ctx1.clearRect(0,0,g.canvas.width,g.canvas.height),"top"===e){for(let s=0;s<r;s++)if(n[s].isRender)for(let e=0;e<n[s].layerData.length;e++)if(!(n[s].layerData[e][0]>=g.canvasWidth||n[s].layerData[e][1]>=g.canvasHeight||n[s].layerData[e][0]<0||n[s].layerData[e][1]<0)&&n[s].layerData[e][2]!==g.emptyColor){let a=n[s].layerData[e][0]*g.scale,t=n[s].layerData[e][1]*g.scale;g.ctx1.fillStyle=n[s].layerData[e][2],g.ctx1.fillRect(a,t,g.scale,g.scale)}}else if("middle"===e){if(n[r].isRender&&t)for(let s=0;s<n[r].layerData.length;s++)if(!(n[r].layerData[s][0]>=g.canvasWidth||n[r].layerData[s][1]>=g.canvasHeight||n[r].layerData[s][0]<0||n[r].layerData[s][1]<0)&&n[r].layerData[s][2]!==g.emptyColor){let e=n[r].layerData[s][0]*g.scale,a=n[r].layerData[s][1]*g.scale;g.ctx1.fillStyle=n[r].layerData[s][2],g.ctx1.fillRect(e,a,g.scale,g.scale)}}else if("bottom"===e)for(let s=n.length-1;s>r;s--)if(n[s].isRender)for(let e=0;e<n[s].layerData.length;e++)if(!(n[s].layerData[e][0]>=g.canvasWidth||n[s].layerData[e][1]>=g.canvasHeight||n[s].layerData[e][0]<0||n[s].layerData[e][1]<0)&&n[s].layerData[e][2]!==g.emptyColor){let a=n[s].layerData[e][0]*g.scale,t=n[s].layerData[e][1]*g.scale;g.ctx1.fillStyle=n[s].layerData[e][2],g.ctx1.fillRect(a,t,g.scale,g.scale)}},reDraw(e=!0,a=!0,t=!0){{g.ctx1.clearRect(0,0,g.canvas.width,g.canvas.height),g.drawRecord.length-1<g.currentFrameIndex&&(g.currentFrameIndex=g.drawRecord.length-1);let e=g.drawRecord[g.currentFrameIndex].layer,a=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerId;const r=performance.now();for(let l=e.length-1;l>=0;l--)if((t||e[l].layerId!==a)&&e[l].isRender){let a=Object.keys(e[l].layerNewData);for(let t=0;t<a.length;t++){g.ctx1.fillStyle=a[t];let r=e[l].layerNewData[a[t]];for(const[e,a]of r){let e=a,t=e[0]*g.scale,r=e[1]*g.scale;g.ctx1.fillRect(t,r,g.scale,g.scale)}}}performance.now();t&&u.reDrawSelectData()}e&&(g.FrameTimer&&clearTimeout(g.FrameTimer),g.FrameTimer=setTimeout((()=>{u.handleFrameImg(g.ctx2,a)}),300))},stop(){if(g.isDrawing){g.isDrawing=!1,g.drawList=ua(g.drawList);for(let e=0;e<g.drawList.length;e++)if(u.getCurrentLayerIsLock()){g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[g.drawList[e][0]+g.drawList[e][1]*g.canvasWidth][2]===g.emptyColor&&u.addDrawRecord([g.drawList[e][0],g.drawList[e][1],g.brushColor],!1)}else u.addDrawRecord([g.drawList[e][0],g.drawList[e][1],g.brushColor],!1);u.handleFrameImg(g.ctx1),g.drawList=[]}if(g.isErasering){g.isErasering=!1,g.removeDrawList=ua(g.removeDrawList);for(let e=0;e<g.removeDrawList.length;e++)u.removeDrawRecord([g.removeDrawList[e][0],g.removeDrawList[e][1]],!1);u.handleFrameImg(g.ctx1),g.removeDrawList=[]}if(g.isScale=!1,g.isDragging&&(g.isDragging=!1),g.isMoving&&g.isSelecting,g.isSelecting){if(!g.isMoving)return void(g.isSelecting=!1);g.selectData.isCancelSelect=!1,g.selectData.copyList=[],g.selectData.copySelectMapList=null,g.isSelecting=!1,g.isMoving=!1}if(g.isSelectDraging){g.isSelectDraging=!1;let e=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex];if(e.isRender){let a=Math.min(g.selectData.x,g.selectData.endX),t=Math.max(g.selectData.x,g.selectData.endX),r=Math.min(g.selectData.y,g.selectData.endY),l=Math.max(g.selectData.y,g.selectData.endY);for(let n=0;n<e.layerData.length;n++)if(!(e.layerData[n][0]>=g.canvasWidth||e.layerData[n][1]>=g.canvasHeight||e.layerData[n][0]<0||e.layerData[n][1]<0)&&e.layerData[n][2]!==g.emptyColor){let s=e.layerData[n][0],o=e.layerData[n][1],i=e.layerData[n][2];s>=a&&s<=t&&o>=r&&o<=l&&(g.selectData.selectList.push([s,o,i]),g.selectData.selectMapList[i]||(g.selectData.selectMapList[i]=new Map),g.selectData.selectMapList[i].set(`${s}/${o}`,[s,o]))}u.reDrawSelectData()}u.handleDrawReferenceLine()}u.saveShapeData()},leave(){u.stop(),g.canvas.className=""},reDrawSelectData(e=g.canvasBeginPos){if(g.isScaling)return;if(Oe(g.selectData.selectMapList))return;g.ctx1.lineWidth=1,g.ctx1.strokeStyle=g.selectActiveColor;let a=Object.keys(g.selectData.selectMapList);for(let t=0;t<a.length;t++){g.ctx1.fillStyle=a[t];let e=g.selectData.selectMapList[a[t]];for(const[a,t]of e){let e=t;if(e[0]>=g.canvasWidth||e[1]>=g.canvasHeight||e[0]<0||e[1]<0)continue;let a=e[0]*g.scale,r=e[1]*g.scale;g.ctx1.fillRect(a,r,g.scale,g.scale),g.ctx1.strokeRect(a+1,r+1,g.scale-2,g.scale-2)}}},saveShapeData(){if(g.isDrawShape&&g.drawShapeList.length){if("circle"===g.currentDrawShape){let e=g.drawShapeList.length,a=g.drawShapeList[0][0],t=g.drawShapeList[0][1],r=g.drawShapeList[e-1][0],l=g.drawShapeList[e-1][1],n=u.drawCircle(a,t,r,l,g.scale);for(let s=0;s<n.length;s++)if(u.getCurrentLayerIsLock()){g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[n[s][0]+n[s][1]*g.canvasWidth][2]===g.emptyColor&&u.addDrawRecord([n[s][0],n[s][1],g.brushColor],!1)}else u.addDrawRecord([n[s][0],n[s][1],g.brushColor],!1)}else if("rect"===g.currentDrawShape){let e=g.drawShapeList.length,a=g.drawShapeList[0][0],t=g.drawShapeList[0][1],r=g.drawShapeList[e-1][0],l=g.drawShapeList[e-1][1],n=u.drawRect(a,t,r,l);for(let s=0;s<n.length;s++)if(u.getCurrentLayerIsLock()){g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[n[s][0]+n[s][1]*g.canvasWidth][2]===g.emptyColor&&u.addDrawRecord([n[s][0],n[s][1],g.brushColor],!1)}else u.addDrawRecord([n[s][0],n[s][1],g.brushColor],!1)}else if("fillRect"===g.currentDrawShape){let e=g.drawShapeList.length,a=g.drawShapeList[0][0],t=g.drawShapeList[0][1],r=g.drawShapeList[e-1][0],l=g.drawShapeList[e-1][1],n=u.drawFillRect(a,t,r,l);for(let s=0;s<n.length;s++)if(u.getCurrentLayerIsLock()){g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[n[s][0]+n[s][1]*g.canvasWidth][2]===g.emptyColor&&u.addDrawRecord([n[s][0],n[s][1],g.brushColor],!1)}else u.addDrawRecord([n[s][0],n[s][1],g.brushColor],!1)}else if("line"===g.currentDrawShape){let e=g.drawShapeList.length,a=g.drawShapeList[0][0],t=g.drawShapeList[0][1],r=g.drawShapeList[e-1][0],l=g.drawShapeList[e-1][1],n=u.drawLine(a,t,r,l);for(let s=0;s<n.length;s++)if(u.getCurrentLayerIsLock()){g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData[n[s][0]+n[s][1]*g.canvasWidth][2]===g.emptyColor&&u.addDrawRecord([n[s][0],n[s][1],g.brushColor],!1)}else u.addDrawRecord([n[s][0],n[s][1],g.brushColor],!1)}else if("curve"===g.currentDrawShape){let e=g.drawShapeList[0][0],a=g.drawShapeList[0][1],t=g.curveEndPos[0],r=g.curveEndPos[1],l=[],n=0,s=0,o=0;if(e===t&&a===r)return;if(e===t&&["3","4"].includes(g.curveType.pressKey)?(s=Math.round(Math.min(a,r)+Math.abs(r-a)/2),"3"===g.curveType.pressKey?n=Math.round(e-g.curvature)<=0?0:Math.round(e-g.curvature):"4"===g.curveType.pressKey&&(n=Math.round(e+g.curvature)>=g.canvasWidth?g.canvasWidth:Math.round(e+g.curvature)),o=Math.abs(r-a)):a===r&&["1","2"].includes(g.curveType.pressKey)&&(n=Math.round(Math.abs(t-e)/2+Math.min(e,t)),"1"===g.curveType.pressKey?s=Math.round(a-g.curvature)<=0?0:Math.round(a-g.curvature):"2"===g.curveType.pressKey&&(s=Math.round(a+g.curvature)>=g.canvasHeight?g.canvasHeight:Math.round(a+g.curvature)),o=Math.abs(t-e)),0===n&&0===s)return;l=u.drawCurve({x:e,y:a},{x:n,y:s},{x:t,y:r},20+o);for(let i=0;i<l.length;i++)u.addDrawRecord([l[i][0],l[i][1],g.brushColor],!1)}u.reDraw(),g.drawShapeList=[],g.curveEndPos=[],g.curveType.pressKey="0",g.isDrawShape=!1,g.drawShapeData={list:[],maxX:0,maxY:0,minX:-1,minY:-1}}else g.isDrawShape=!1},addCursorClass(e=null){0===g.currentTool?g.canvas.classList.add("brush-cursor"):1===g.currentTool?g.canvas.classList.add("eraser-cursor"):2===g.currentTool?g.canvas.classList.add("straw-cursor"):3===g.currentTool?-1!==g.currentDrawShape.toLowerCase().indexOf("rect")?g.canvas.classList.add("rect-cursor"):"line"===g.currentDrawShape||"curve"===g.currentDrawShape?g.canvas.classList.add("brush-cursor"):-1!==g.currentDrawShape.toLowerCase().indexOf("circle")&&g.canvas.classList.add("circle-cursor"):4===g.currentTool?g.canvas.classList.add("bucket-cursor"):5===g.currentTool&&g.pinDouMode?g.canvas.classList.add("pindou-cursor"):7===g.currentTool?g.canvas.classList.add("move-cursor"):8===g.currentTool?g.canvas.classList.add("select-cursor"):9===g.currentTool&&u.handleChangeMouseStyle(e)},exportPng(){const e=document.createElement("a");e.download="image.png",e.href=g.canvas.toDataURL("image/png"),e.click()},computeScale(e=!0){const a=document.querySelector(".pixelBox");g.baseCanvas.width=null==a?void 0:a.clientWidth,g.baseCanvas.height=null==a?void 0:a.clientHeight;let r=null==a?void 0:a.clientHeight,l=Math.floor(r)/Math.max(g.canvasWidth-g.pindouScaleValue,g.canvasHeight-g.pindouScaleValue),n=sa(Math.floor(l))?Math.floor(l):Math.floor(l)-1;g.scale=Math.max(n,15),g.pinDouMode&&(g.scale=Math.max(g.scale,30)),g.canvas.width=(Number(g.canvasWidth)+g.pindouScaleValue)*g.scale,g.canvas.height=(Number(g.canvasHeight)+g.pindouScaleValue)*g.scale,g.bgCanvas.width=(Number(g.canvasWidth)+g.pindouScaleValue)*g.scale,g.bgCanvas.height=(Number(g.canvasHeight)+g.pindouScaleValue)*g.scale,g.gridCanvas.width=(Number(g.canvasWidth)+g.pindouScaleValue)*g.scale,g.gridCanvas.height=(Number(g.canvasHeight)+g.pindouScaleValue)*g.scale,g.moveCanvas.width=g.canvas.width,g.moveCanvas.height=g.canvas.height,"undefined"!=typeof OffscreenCanvas?g.worker.postMessage({type:0,canvasWidth:g.canvas.width,canvasHeight:g.canvas.height}):t.$message.warning("当前浏览器版本过低，将影响部分功能的使用"),e&&u.setCanvasCenter()},handleAddLayer(){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(g.isScaling&&u.handleCancelScale(),g.drawRecord[g.currentFrameIndex].layer.length>g.maxLayer)return t.$message.warning("图层数量达到上限");let e=JSON.parse(JSON.stringify(g.emptyLayerData)),a=g.historyLayerNameIndex[g.historyLayerNameIndex.length-1]+1,r={layerId:la.v4(),layerName:`图层${a+1}`,alpha:100,isLock:!1,currentLayerImg:g.layerGridImage,isRender:!0,layerData:e,layerNewData:{}};g.historyLayerNameIndex.push(a),g.drawRecord[g.currentFrameIndex].layer.unshift(r),u.handleChangeLayer(0),u.handleAddHistory()},handleLayerMerge(){if(g.isScaling&&u.handleCancelScale(),!Oe(g.selectData.selectMapList))return t.$message.warning("请先取消选中区域");if(g.selectLayerList.length>1){g.selectLayerList.sort(((e,a)=>a-e));let e=g.drawRecord[g.currentFrameIndex].layer[g.selectLayerList[0]];for(let t=1;t<g.selectLayerList.length;t++){let a=g.drawRecord[g.currentFrameIndex].layer[g.selectLayerList[t]].layerData;for(let t=0;t<a.length;t++)a[t][2]!==g.emptyColor&&(e.layerData[t][2]=a[t][2]);g.drawRecord[g.currentFrameIndex].layer.splice(g.selectLayerList[t],1)}let a=g.drawRecord[g.currentFrameIndex].layer.findIndex((a=>a.layerId===e.layerId));u.handleChangeLayer(a),u.handleCurrentLayerDataToLayerMapData((()=>{u.reDraw()}))}},handleChangeLayer(e){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");g.isScaling&&e!==g.currentLayerIndex&&u.handleCancelScale(),g.isShift?g.selectLayerList.includes(e)||g.selectLayerList.push(e):u.handleSaveMoveData(!0,(()=>{g.currentLayerIndex=e,g.currentLayerId=u.getCurrentLayerId(),g.historyLayerIndexRecord.push(g.currentLayerId),g.layerAlpha=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].alpha||100,g.selectLayerList=[g.currentLayerIndex]}))},handleChangeLayerVisible(e){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(g.isScaling&&u.handleCancelScale(),e<0){for(let e=0;e<g.drawRecord[g.currentFrameIndex].layer.length;e++)g.drawRecord[g.currentFrameIndex].layer[e].isRender=!g.currentFrameLayerVisible;return g.currentFrameLayerVisible=!g.currentFrameLayerVisible,void u.reDraw()}let a=g.drawRecord[g.currentFrameIndex].layer[e].isRender;if(g.drawRecord[g.currentFrameIndex].layer[e].isRender=!a,!Oe(g.selectData.selectMapList))return u.handleCancelSelect();u.reDraw(!0,!1)},handleLockLayer(e,a){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");g.drawRecord[g.currentFrameIndex].layer[e].isLock=a},handleDeleteLayer(e){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(g.isScaling&&u.handleCancelScale(),g.currentLayerIndex!==e&&!Oe(g.selectData.selectMapList))return t.$message.warning("请先取消选中区域");g.currentLayerIndex===e&&g.selectData.selectLayerId===g.currentLayerId&&u.handleCancelSelect(),g.drawRecord[g.currentFrameIndex].layer.splice(e,1);let a=g.drawRecord[g.currentFrameIndex].layer.findIndex((e=>g.historyLayerIndexRecord[g.historyLayerIndexRecord.length-1]===e.layerId));a<0&&(a=0),g.currentLayerIndex=a,g.layerAlpha=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].alpha||100,g.currentLayerId=u.getCurrentLayerId(),g.selectLayerList=[g.currentLayerIndex],u.reDraw()},handleCopyLayer(e){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");g.isScaling&&u.handleCancelScale();let a=da(g.drawRecord[g.currentFrameIndex].layer[e]);g.drawRecord[g.currentFrameIndex].layer.length,a.layerId=la.v4(),a.layerName=`${a.layerName} Copy`,g.drawRecord[g.currentFrameIndex].layer.splice(e,0,a),u.handleChangeLayer(e),u.handleAddHistory()},handleDoubleClickLayer(e,a){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");g.currentEditLayer.index=e,g.currentEditLayer.name=a},handleEditLayerName(){if(""===g.currentEditLayer.name.trim())return t.$message.warning("请填写图层名称");g.drawRecord[g.currentFrameIndex].layer[g.currentEditLayer.index].layerName=g.currentEditLayer.name,g.currentEditLayer={index:-1,name:""},u.handleAddHistory()},handleExportLayer(e=g.currentFrameIndex,a=g.currentLayerIndex,t=!0,r=1,l=g.exportStyleOptions,n="pic"){let{isShowGrid:s}=l;const o=g.drawRecord[e].layer[a].layerData;if(s)return void u.handleExportGridFrame(o,"layer",l);g.realCanvas.width=g.canvasWidth*r,g.realCanvas.height=g.canvasHeight*r,g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height),g.ctx3.globalAlpha=1;let i=Object.keys(g.drawRecord[e].layer[a].layerNewData);for(let c=0;c<i.length;c++){let t=g.drawRecord[e].layer[a].layerNewData[i[c]],l=i[c];"gif"===n&&"#000000ff"===l&&(l="#010101ff"),g.ctx3.fillStyle=l;for(const[e,a]of t){let e=a[0],t=a[1];g.ctx3.fillRect(e*r,t*r,r,r)}}t&&fa(g.realCanvas,`layer${a+1}`)},handleImportDragImage(e){if(!t.$congif.supportUploadImageType.includes(e.type))return t.$message.warning("导入文件格式不正确");"application"===e.type.split("/")[0]?u.handleImportImageLayer(e,"1"):u.handleImportImageLayer(e,"0")},handleImportImageLayer(e,a,r=1){if(Oe(g.selectData.selectMapList)||u.handleCancelSelect(),g.isScaling&&u.handleCancelScale(),"0"===a){g.loading=!0;const a=new Image,t=e;a.src=t,a.onload=function(){let e=Math.floor(a.width/r),l=Math.floor(a.height/r);e>g.canvasWidth||l>g.canvasHeight?u.handleTransfromPngToPixel(a,t,g.currentLayerIndex,!0):a.width<=g.canvasWidth&&a.height<=g.canvasHeight?u.handleTransfromPngToPixel(a,t,g.currentLayerIndex):u.handleTransformPngToPixel2(a,t,g.currentLayerIndex,r)}}else g.loading=!0,l.handleExcelToPixel(e,(e=>{if(!e.length)return;let a=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData;for(let t=0;t<e.length;t++)if(e[t][2]!==g.emptyColor){a[e[t][0]+e[t][1]*g.canvasWidth][2]=e[t][2]}u.handleCurrentLayerDataToLayerMapData((()=>{u.reDraw(),g.loading=!1}))}),(e=>{g.loading=!1,t.$message.error(e)}),{canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight})},handleImportLayer(e=g.currentLayerIndex){Oe(g.selectData.selectMapList)||u.handleCancelSelect(),g.isScaling&&u.handleCancelScale();const a=document.createElement("input");a.type="file",a.accept="image/png,image/jpg",a.addEventListener("change",(function(){const t=a.files[0];if(t){g.loading=!0;const a=new Image,r=URL.createObjectURL(t);a.src=r,a.onload=function(){a.width>g.canvasWidth||a.height>g.canvasHeight?u.handleTransfromPngToPixel(a,r,e,!0):u.handleTransfromPngToPixel(a,r,e)}}})),document.body.appendChild(a),a.click(),document.body.removeChild(a)},handleTransfromPngToPixel(e,a,t,r=!1){const l=document.createElement("canvas");l.width=g.canvasWidth,l.height=g.canvasHeight;const n=l.getContext("2d");if(r)return void h.resize(e,l,{unsharpAmount:100,unsharpRadius:.5,unsharpThreshold:6}).then((e=>{const r=n.getImageData(0,0,l.width,l.height);g.worker.postMessage({type:2,variables:r.data,currentLayerData:JSON.parse(JSON.stringify(g.drawRecord[g.currentFrameIndex].layer[t].layerData))}),g.worker.onmessage=e=>{URL.revokeObjectURL(a),g.drawRecord[g.currentFrameIndex].layer[t].layerData=e.data.layerData,g.drawRecord[g.currentFrameIndex].layer[t].layerNewData=e.data.layerNewData,g.loading=!1,u.reDraw()}})).catch((e=>{}));n.drawImage(e,0,0);const s=n.getImageData(0,0,l.width,l.height);g.worker.postMessage({type:2,variables:s.data,currentLayerData:JSON.parse(JSON.stringify(g.drawRecord[g.currentFrameIndex].layer[t].layerData))}),g.worker.onmessage=e=>{URL.revokeObjectURL(a),g.drawRecord[g.currentFrameIndex].layer[t].layerData=e.data.layerData,g.drawRecord[g.currentFrameIndex].layer[t].layerNewData=e.data.layerNewData,g.loading=!1,u.reDraw()}},handleTransformPngToPixel2(e,a,t,r=1){let l=Math.floor(e.width/r),n=Math.floor(e.height/r);const s=document.createElement("canvas");s.width=e.width,s.height=e.height;const o=s.getContext("2d");o.drawImage(e,0,0);const i=o.getImageData(0,0,s.width,s.height).data;g.worker.postMessage({type:11,variables:i,pxSize:r,options:{width:l,height:n,canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight,imageWidth:e.width,imageHeight:e.height},currentLayerData:JSON.parse(JSON.stringify(g.drawRecord[g.currentFrameIndex].layer[t].layerData))}),g.worker.onmessage=e=>{URL.revokeObjectURL(a),g.drawRecord[g.currentFrameIndex].layer[t].layerData=e.data.layerData,g.drawRecord[g.currentFrameIndex].layer[t].layerNewData=e.data.layerNewData,g.loading=!1,u.reDraw()}},handleChangeLayerAlpha(){g.loading=!0;let e=aa(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex]),a=i(o({},e),{layerNewData:ta(e.layerNewData)});g.worker.postMessage({type:5,variables:a,targetAlpha:g.layerAlpha}),g.worker.onmessage=e=>{g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData=e.data.layerData,g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData=e.data.layerNewData,g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].alpha=g.layerAlpha,g.loading=!1,u.reDraw()}},handleCopyLayerData(){var e;s.layerCopyData=da(null==(e=g.LayerMenu.contextData)?void 0:e.layerData),t.$message.success("复制成功")},handlePasteLayerData(){if(!s.layerCopyData)return t.$message.warning("数据不存在");let e=s.layerCopyData;g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerData=JSON.parse(JSON.stringify(e.layerData)),g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData=da(e.layerNewData),t.$message.success("粘贴成功"),u.reDraw(!0,!0)},handleAddFrame(){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(g.drawRecord.length>=g.maxFrame)return t.$message.warning("帧数量达到上限");if(!Oe(g.selectData.selectMapList))return t.$message.warning("请先取消选中区域");g.isScaling&&u.handleCancelScale();let e=JSON.parse(JSON.stringify(g.emptyLayerData)),a={frameId:la.v1(),currentFrameImg:null,layer:[{layerId:la.v4(),layerName:"图层1",alpha:100,isLock:!1,currentLayerImg:g.layerGridImage,isRender:!0,layerData:e,layerNewData:{}}]};g.drawRecord.push(a),u.handleChangeFrame(g.drawRecord.length-1)},handleChangeFrame:e=>g.pinDouMode?t.$message.warning("请先退出拼豆预览模式"):g.selectData.selectList.length&&e!==g.currentFrameIndex?t.$message.warning("请先取消选中区域"):(g.isScaling&&e!==g.currentFrameIndex&&u.handleCancelScale(),void(7===g.currentTool?u.handleSaveMoveData(!1,(()=>{setTimeout((()=>{g.currentTool=0,g.currentFrameIndex=e,g.currentFrameId=u.getCurrentFrameId(),g.historyFrameIndexRecord.push(g.currentFrameId),u.handleChangeLayer(0),u.reDraw(!0,!1)}),500)})):(g.currentFrameIndex=e,g.currentFrameId=u.getCurrentFrameId(),g.historyFrameIndexRecord.push(g.currentFrameId),u.handleChangeLayer(0),u.reDraw(!0,!1)))),handleCopyFrame(e,a="copy"){if("copyData"===a)s.frameCopyData=da(g.drawRecord[e]),t.$message.success("复制成功");else if("pasteData"===a){if(!s.frameCopyData)return t.$message.warning("数据不存在");let a=s.frameCopyData;if(a.frameId===g.drawRecord[e].frameId)g.drawRecord[e]=da(a);else{g.drawRecord[e].currentFrameImg=a.currentFrameImg,g.drawRecord[e].layer=da(a.layer);for(let a=0;a<g.drawRecord[e].layer.length;a++)g.drawRecord[e].layer[a].layerId=la.v4()}t.$message.success("粘贴成功"),e===g.currentFrameIndex&&u.reDraw(!0,!0)}else if("copy"===a){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(!Oe(g.selectData.selectMapList))return t.$message.warning("请先取消选中区域");if(g.isScaling&&u.handleCancelScale(),g.drawRecord.length>=g.maxFrame)return t.$message.warning("帧数量达到上限");let a=da(g.drawRecord[e]);a.frameId=la.v1();for(let e=0;e<a.layer.length;e++)a.layer[e].layerId=la.v4();g.drawRecord.splice(e,0,a),u.handleChangeFrame(e+1),u.handleAddHistory()}},handleDeleteFrame(e){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");g.selectData.selectList.length&&e===g.currentFrameIndex&&u.handleCancelSelect(),g.isScaling&&e===g.currentFrameIndex&&u.handleCancelScale(),g.drawRecord.splice(e,1);let a=g.drawRecord.findIndex((e=>g.historyFrameIndexRecord[g.historyFrameIndexRecord.length-1]===e.frameId));a<0&&(a=0),u.handleChangeFrame(a),u.handleAddHistory()},handleExportGridFrame(e,a,t=g.exportStyleOptions){let{gridBackgroundColor:r,gridColor:l}=t,n=t.gridSize;g.realCanvas.width=g.canvasWidth*n,g.realCanvas.height=g.canvasHeight*n,g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height),r!==g.emptyColor&&(g.ctx3.fillStyle=r,g.ctx3.fillRect(0,0,g.realCanvas.width,g.realCanvas.height));const s=n;g.ctx3.strokeStyle=l,g.ctx3.globalAlpha=1,g.ctx3.lineWidth=1;for(let o=0;o<=g.canvasHeight;o++)g.ctx3.beginPath(),g.ctx3.moveTo(0,o*s),g.ctx3.lineTo(g.canvasWidth*s,o*s),g.ctx3.stroke();for(let o=0;o<=g.canvasWidth;o++)g.ctx3.beginPath(),g.ctx3.moveTo(o*s,0),g.ctx3.lineTo(o*s,g.canvasHeight*s),g.ctx3.stroke();if("frame"===a){for(let o=e.length-1;o>=0;o--)if(e[o].isRender){let a=Object.keys(e[o].layerNewData);for(let t=0;t<a.length;t++){let r=e[o].layerNewData[a[t]],l=a[t];g.ctx3.fillStyle=l;for(const[e,a]of r){let e=a[0],t=a[1];g.ctx3.fillRect(e*s+1,t*s+1,s-2,s-2)}}}}else{let e=Object.keys(g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData);for(let a=0;a<e.length;a++){let t=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData[e[a]],r=e[a];g.ctx3.fillStyle=r;for(const[e,a]of t){let e=a[0],t=a[1];g.ctx3.fillRect(e*s+1,t*s+1,s-2,s-2)}}}},handleExportFrame(e,a=!0,t=1,r=g.exportStyleOptions,l="pic"){let{isShowGrid:n}=r;g.ctx3.globalAlpha=1;const s=g.drawRecord[e].layer;if(n)u.handleExportGridFrame(s,"frame",r);else{g.realCanvas.width=g.canvasWidth*t,g.realCanvas.height=g.canvasHeight*t,g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height);for(let e=s.length-1;e>=0;e--)if(s[e].isRender){let a=Object.keys(s[e].layerNewData);for(let r=0;r<a.length;r++){let n=s[e].layerNewData[a[r]],o=a[r];"gif"===l&&"#000000ff"===o&&(o="#010101ff"),g.ctx3.fillStyle=o;for(const[e,a]of n){let e=a[0],r=a[1];g.ctx3.fillRect(e*t,r*t,t,t)}}}a&&fa(g.realCanvas,`frame${e+1}`)}},handleExportFrameForBlock(e,a=!0,t=1,r=g.exportStyleOptions,l=.26){g.ctx3.globalAlpha=1;const n=g.drawRecord[e].layer,s=(t=28*l)/5;g.realCanvas.width=g.canvasWidth*t,g.realCanvas.height=g.canvasHeight*t,g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height);for(let o=n.length-1;o>=0;o--)if(n[o].isRender){let e=Object.keys(n[o].layerNewData);for(let a=0;a<e.length;a++){let r=n[o].layerNewData[e[a]],l=e[a];g.ctx3.fillStyle=l;for(const[e,a]of r){let e=a[0],r=a[1];g.ctx3.fillRect(e*t,r*t,t,t),g.ctx3.shadowColor="rgba(0, 0, 0, 0.8)",g.ctx3.shadowBlur=2,g.ctx3.shadowOffsetX=1,g.ctx3.shadowOffsetY=1,g.ctx3.beginPath(),g.ctx3.arc(e*t+t/2,r*t+t/2,s,0,2*Math.PI,!1),g.ctx3.closePath(),g.ctx3.fill()}}}a&&fa(g.realCanvas,`积木图${e+1}`)},handleExportFrameForPindou(e,a=!0,t=1,r=g.exportStyleOptions,l=.26){g.ctx3.globalAlpha=1;const n=g.drawRecord[e].layer,s=t=28*l,o=t/5;g.realCanvas.width=g.canvasWidth*t,g.realCanvas.height=g.canvasHeight*t,g.ctx3.clearRect(0,0,g.realCanvas.width,g.realCanvas.height),g.ctx3.shadowColor="rgba(0, 0, 0, 0.5)",g.ctx3.shadowBlur=2,g.ctx3.shadowOffsetX=1,g.ctx3.shadowOffsetY=1;for(let i=n.length-1;i>=0;i--)if(n[i].isRender){let e=Object.keys(n[i].layerNewData);for(let a=0;a<e.length;a++){let r=n[i].layerNewData[e[a]],l=e[a];for(const[e,a]of r){let e=a[0],r=a[1];g.ctx3.fillStyle=l,g.ctx3.beginPath(),g.ctx3.arc(e*t+s/2,r*t+s/2,s/2,0,2*Math.PI,!1),g.ctx3.closePath(),g.ctx3.fill(),g.ctx3.shadowColor="rgba(80, 80, 80, 0.5)",g.ctx3.shadowBlur=2,g.ctx3.shadowOffsetX=1,g.ctx3.shadowOffsetY=1,g.ctx3.fillStyle="rgba(0, 0, 0, 1)",g.ctx3.beginPath(),g.ctx3.arc(e*t+s/2,r*t+s/2,o,0,2*Math.PI,!1),g.ctx3.closePath(),g.ctx3.fill()}}}a&&fa(g.realCanvas,`拼豆图${e+1}`)},compressDrawRecordData(){let e=JSON.parse(JSON.stringify(g.drawRecord));for(let a=0;a<e.length;a++)for(let t=0;t<e[a].layer.length;t++){delete e[a].layer[t].layerNewData;for(let r=0;r<e[a].layer[t].layerData.length;r++){let l=e[a].layer[t].layerData[r][2];l===g.emptyColor?e[a].layer[t].layerData[r]=0:e[a].layer[t].layerData[r]=l}}return e},handleExportProject(e){g.exportLoaidng=!0;let a=i(o({},g.projectData),{width:g.canvasWidth,height:g.canvasHeight,data:null});a.data=u.compressDrawRecordData(),a.frameImg="@";const r=JSON.stringify(a),l=new Blob([r],{type:""});We.saveAs(l,`${e}.json`),t.$message.success("导出成功"),g.exportLoaidng=!1},handleImportProject(){const e=document.createElement("input");e.type="file",e.accept="application/json",e.addEventListener("change",(function(){const a=e.files[0];if(a){g.loading=!0;const e=new FileReader;e.onload=function(e){const a=JSON.parse(e.target.result);g.worker.postMessage({type:4,variables:a.data}),g.projectData.projectId=a.projectId,g.projectData.projectName=a.projectName,g.projectData.updateAt=a.updateAt,g.projectData.createAt=a.createAt,g.projectData.desc=a.desc,g.projectData.frameImg=a.frameImg,g.canvasWidth=a.width,g.canvasHeight=a.height,g.historyRecord=[],u.computeScale(),g.canvasBeginPos.x=g.bgCanvas.width/2-g.canvasWidth*g.scale/2,g.canvasBeginPos.y=g.bgCanvas.height/2-g.canvasHeight*g.scale/2,u.drawPixelArea(),g.worker.onmessage=e=>{g.drawRecord=e.data,u.reDraw(),g.loading=!1}},e.readAsText(a)}})),document.body.appendChild(e),e.click(),document.body.removeChild(e)},async handleExport(e,a,r=1,n=!1,i=g.exportStyleOptions,c=2,d=.26){if((![5,6].includes(e)||!s.checkVipFunction("gifExport"))&&(![7].includes(e)||!s.checkVipFunction("excelExport"))&&(g.previewLoading||!s.checkVipFunction("beitu",r)))if(n||(g.exportLoaidng=!0),g.isExportProject)u.handleExportProject(a);else{if(1===e){const e=document.createElement("canvas");e.width=g.canvasWidth*r*g.drawRecord.length,e.height=g.canvasHeight*r;const t=e.getContext("2d");g.realCanvas.width=g.canvasWidth*r,g.realCanvas.height=g.canvasHeight*r;for(let a=0;a<g.drawRecord.length;a++)u.handleExportFrame(a,!1,r),t.drawImage(g.realCanvas,a*g.canvasWidth*r,0);if(n)return e.toDataURL("image/png");fa(e,a)}else if(2===e){let e=0,t=[],l=[];for(let a=0;a<g.drawRecord.length;a++){t[a]=[];let l=g.drawRecord[a].layer.length;e<l&&(e=l);let n=0;for(let e=l-1;e>=0;e--)u.handleExportLayer(a,e,!1,r),t[a][n]=g.ctx3.getImageData(0,0,g.canvasWidth*r,g.canvasHeight*r),n++}for(let a=0;a<e;a++){const e=document.createElement("canvas");e.width=g.canvasWidth*r*g.drawRecord.length,e.height=g.canvasHeight*r;const n=e.getContext("2d");for(let l=0;l<t.length;l++)if(t[l][a]){let e=document.createElement("canvas");e.width=g.canvasWidth*r,e.height=g.canvasHeight*r,e.getContext("2d").putImageData(t[l][a],0,0),n.drawImage(e,l*g.canvasWidth*r,0)}else;l.push(e.toDataURL("image/png"))}ya(`${a}`,l)}else if(3===e){let e=[];for(let a=0;a<g.drawRecord.length;a++)u.handleExportFrame(a,!1,r,i),e.push(g.realCanvas.toDataURL("image/png"));1===e.length?va(e[0],a):ya(`${a}`,e)}else if(4===e){let e=[];for(let a=0;a<g.drawRecord.length;a++){for(let t=g.drawRecord[a].layer.length-1;t>=0;t--)g.drawRecord[a].layer[t].isRender&&(u.handleExportLayer(a,t,!1,r,i),e.push(g.realCanvas.toDataURL("image/png")))}1===e.length?va(e[0],a):ya(`${a}`,e)}else if(5===e){let e=[],t=new GIF({width:g.canvasWidth*r,height:g.canvasHeight*r,workerScript:"/gif-js/distt/gif.worker.js",workers:2,quality:10,transparent:0});for(let a=0;a<g.drawRecord.length;a++)u.handleExportFrame(a,!1,r,g.exportStyleOptions,"gif"),e.push(g.realCanvas.toDataURL("image/png"));let l=[];for(let a=0;a<e.length;a++){const t=document.createElement("img");t.src=e[a],t.width=g.canvasWidth*r,t.height=g.canvasHeight*r;let n=new Promise(((e,a)=>{t.onload=function(){e(t)}}));l.push(n)}let n=0;await Promise.all(l).then((async()=>{for(let e=0;e<l.length;e++){let a=await l[e];t.addFrame(a,{delay:100*c}),n++}n>=l.length&&t.render()})),t.on("finished",(function(e){Da(a,URL.createObjectURL(e)),t.abort()}))}else if(6===e){let e=0,t=[],l=[];const n=e=>new Promise(((a,t)=>{wa(e).then((e=>{a(e)}))}));for(let a=0;a<g.drawRecord.length;a++){t[a]=[];let l=g.drawRecord[a].layer.length;e<l&&(e=l);let n=0;for(let e=l-1;e>=0;e--)u.handleExportLayer(a,e,!1,r,g.exportStyleOptions,"gif"),t[a][n]=g.ctx3.getImageData(0,0,g.canvasWidth*r,g.canvasHeight*r),n++}for(let a=0;a<e;a++){let e=new GIF({width:g.canvasWidth*r,height:g.canvasHeight*r,workerScript:"/gif-js/distt/gif.worker.js",workers:2,quality:10,transparent:0});for(let l=0;l<t.length;l++)if(t[l][a]){let n=document.createElement("canvas");n.width=g.canvasWidth*r,n.height=g.canvasHeight*r,n.getContext("2d").putImageData(t[l][a],0,0),e.addFrame(n,{delay:100*c})}else;const s=await new Promise((a=>{e.on("finished",(function(t){a(t),e.abort()})),e.render()}));let o=await n(s);l.push(o)}await Promise.all(l).then((()=>{ya(`${a}`,l,"gif")}))}else if(7===e)l.handlePixelToExcel(JSON.parse(JSON.stringify(g.drawRecord)),o({canvasWidth:g.canvasWidth,canvasHeight:g.canvasHeight,filename:a},i),(e=>{t.$message.success(e)}),(e=>{t.$message.error(e)}));else if(8===e){let e=[];for(let a=0;a<g.drawRecord.length;a++)u.handleExportFrameForPindou(a,!1,1,i,d),e.push(g.realCanvas.toDataURL("image/png"));1===e.length?va(e[0],a):ya(`${a}`,e)}else if(9===e){let e=[];for(let a=0;a<g.drawRecord.length;a++)u.handleExportFrameForBlock(a,!1,1,i,d),e.push(g.realCanvas.toDataURL("image/png"));1===e.length?va(e[0],a):ya(`${a}`,e)}g.exportLoaidng=!1}},handleAddHistory(){for(g.historyRecord.length>=g.historyMaxLength&&g.historyRecord.shift();g.currentHistoryIndex<g.historyRecord.length-1;)g.historyRecord.pop();g.historyRecord.push({hid:la.v1(),record:da(g.drawRecord)}),g.isSaveProject=!1,g.currentHistoryIndex=g.historyRecord.length-1,g.currentHistoryIndex<0&&(g.currentHistoryIndex=0)},handleRevoke(){if(g.historyRecord.length){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(!Oe(g.selectData.selectMapList))return t.$message.warning("请先取消选中区域");g.isScaling&&u.handleCancelScale(),g.currentHistoryIndex=g.currentHistoryIndex-1,g.currentHistoryIndex<0&&t.$message.warning("暂无更多记录"),g.currentHistoryIndex<=0&&(g.currentHistoryIndex=0),g.drawRecord=da(g.historyRecord[g.currentHistoryIndex].record),u.reDraw(!0,!1)}},handleRecover(){if(g.historyRecord.length){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");if(!Oe(g.selectData.selectMapList))return t.$message.warning("请先取消选中区域");g.isScaling&&u.handleCancelScale(),g.currentHistoryIndex=g.currentHistoryIndex+1,g.currentHistoryIndex>g.historyRecord.length-1&&t.$message.warning("暂无更多记录"),g.currentHistoryIndex>=g.historyRecord.length-1&&(g.currentHistoryIndex=g.historyRecord.length-1),g.drawRecord=da(g.historyRecord[g.currentHistoryIndex].record),u.reDraw(!0,!1)}},handleOpenMyColorDialog(){t.$refs.MyColorDialog.handleOpen(),u.handleCancelKeyboardEvent()},handleOpenReplaceColorDialog(){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");g.isScaling&&u.handleCancelScale(),t.$refs.ReplaceColorDialog.handleOpen(),u.handleCancelKeyboardEvent()},async handleOpenPreviewDialog(){if(g.pinDouMode)return t.$message.warning("请先退出拼豆预览模式");g.previewLoading=!0;let e=Math.floor(512/Math.max(g.canvasHeight,g.canvasWidth));const a=await u.handleExport(1,"",e,!0);t.$refs.PreviewAnimDialog.handleOpen({imgUrl:a,width:g.canvasWidth*e,height:g.canvasHeight*e,frame:g.drawRecord.length}),g.previewLoading=!1},handleOpenMoveCanvas(){g.isSpace=!g.isSpace},handlekeyDownEvent(e){var a;if(t.$route.path.includes("/work")){if(" "===e.key)return e.preventDefault(),void(g.isSpace=!0);if(e.shiftKey&&(g.isShift=!0),e.altKey&&"c"===e.key&&g.selectData.selectList.length)u.handleCopySelectData();else if(e.altKey&&"q"===e.key)e.preventDefault(),u.drawTransform("scale");else if(e.altKey&&"d"===e.key)e.preventDefault(),u.handleRemoveSelect();else if(e.altKey&&"n"===e.key)u.handleCancelSelect();else if(e.altKey&&"z"===e.key)u.handleRevoke();else if(e.altKey&&"x"===e.key)u.handleRecover();else if((e.metaKey||e.ctrlKey)&&"s"===e.key)e.preventDefault(),u.handleSaveProject();else if((e.metaKey||e.ctrlKey)&&"p"===e.key)e.preventDefault(),u.handleExportDialog(!0);else if((e.metaKey||e.ctrlKey)&&"i"===e.key)e.preventDefault(),u.handleExportDialog(!1);else if(e.altKey&&"p"===e.key)u.handleOpenPreviewDialog();else if(e.altKey&&"f"===e.key)e.preventDefault(),u.handleScreenFull();else if(e.altKey&&"v"===e.key)u.handleResetCanvas();else if(e.altKey&&"g"===e.key)t.$refs.MyColorDialog.handleOpen();else if((e.metaKey||e.ctrlKey)&&"m"===e.key)e.preventDefault(),u.handleImportImage();else if((e.metaKey||e.ctrlKey)&&e.altKey&&"c"===e.key)e.preventDefault(),n.handleCopyColor(g.brushColor);else if((e.metaKey||e.ctrlKey)&&e.altKey&&"t"===e.key)e.preventDefault(),u.handleAddLayer();else if((e.metaKey||e.ctrlKey)&&e.altKey&&"h"===e.key)e.preventDefault(),u.handleLayerMerge();else if((e.metaKey||e.ctrlKey)&&"ArrowUp"===e.key)e.preventDefault(),u.drawTransform("hReverse");else if((e.metaKey||e.ctrlKey)&&"ArrowDown"===e.key)e.preventDefault(),u.drawTransform("vReverse");else if((e.metaKey||e.ctrlKey)&&"ArrowLeft"===e.key)e.preventDefault(),u.drawTransform("nsz");else if((e.metaKey||e.ctrlKey)&&"ArrowRight"===e.key)e.preventDefault(),u.drawTransform("ssz");else if((e.metaKey||e.ctrlKey)&&"="===e.key)e.preventDefault(),u.handleResizeCanvas(.05);else if((e.metaKey||e.ctrlKey)&&"-"===e.key)e.preventDefault(),u.handleResizeCanvas(-.05);else if((e.metaKey||e.ctrlKey)&&e.key);else if("q"===e.key)u.handleChangeTool(0);else if("w"===e.key)u.handleChangeTool(1);else if("e"===e.key)u.handleChangeTool(2);else if("r"===e.key)u.handleChangeTool(4);else if("t"===e.key)u.handleChangeTool(7);else if("y"===e.key)u.handleChangeTool(8),g.selectType="select";else if("p"===e.key)u.handleChangeTool(8),g.selectType="quickSelect";else if("j"===e.key)u.handleChangeTool(8),g.selectType="rangeSelect";else if("u"===e.key)u.handleOpenReplaceColorDialog();else if(e.altKey&&"s"===e.key)n.handleSaveColor(!0,g.brushColor);else if("i"===e.key)u.handleChangeTool(6);else if("o"===e.key)u.handlePindouMode("preview");else if("k"===e.key)u.handlePindouMode("draw");else if("l"===e.key)u.handleLinmoMode();else if("a"===e.key)u.handleChangeTool(3),u.drawShape("rect");else if("s"===e.key)u.handleChangeTool(3),u.drawShape("circle");else if("d"===e.key)u.handleChangeTool(3),u.drawShape("line");else if("f"===e.key)u.handleChangeTool(3),u.drawShape("fillRect");else if("z"===e.key)g.linmoMode&&g.linmoPhoto&&(t.$refs.LinmoModeDialog.isLockCanvas=!t.$refs.LinmoModeDialog.isLockCanvas,u.handleLinmoFitCanvas(t.$refs.LinmoModeDialog.isLockCanvas));else if("x"===e.key)g.linmoMode&&g.linmoPhoto&&(t.$refs.LinmoModeDialog.zIndex=!t.$refs.LinmoModeDialog.zIndex,t.$refs.LinmoModeDialog.updatelinmoPhotoStyle());else if("v"===e.key)g.linmoMode&&g.linmoPhoto&&(t.$refs.LinmoModeDialog.display=!t.$refs.LinmoModeDialog.display,t.$refs.LinmoModeDialog.updatelinmoPhotoStyle());else if("c"===e.key)g.linmoMode&&(t.$refs.LinmoModeDialog.isPickingColor||(t.$refs.LinmoModeDialog.opacityHistoryRecord=t.$refs.LinmoModeDialog.opacity,t.$refs.LinmoModeDialog.zIndexHistoryRecord=t.$refs.LinmoModeDialog.zIndex,t.$refs.LinmoModeDialog.opacity=100,t.$refs.LinmoModeDialog.zIndex||(t.$refs.LinmoModeDialog.zIndex=!0),t.$refs.LinmoModeDialog.updatelinmoPhotoStyle(),t.$refs.LinmoModeDialog.isPickingColor=!0,setTimeout((()=>{var e;null==(e=document.querySelector(".EyeDropper-color-picker"))||e.click()}),500)));else if(e.altKey&&"ArrowUp"===e.key){if(g.isShift)return;g.currentLayerIndex--,g.currentLayerIndex<0&&(g.currentLayerIndex=0),g.selectLayerList=[g.currentLayerIndex]}else if(e.altKey&&"ArrowDown"===e.key){if(g.isShift)return;g.currentLayerIndex++,g.currentLayerIndex>g.drawRecord[g.currentFrameIndex].layer.length-1&&(g.currentLayerIndex=g.drawRecord[g.currentFrameIndex].layer.length-1),g.selectLayerList=[g.currentLayerIndex]}else if(e.altKey&&"ArrowLeft"===e.key){if(e.preventDefault(),g.currentFrameIndex--,g.currentFrameIndex<0)return void(g.currentFrameIndex=0);u.handleChangeFrame(g.currentFrameIndex)}else if(e.altKey&&"ArrowRight"===e.key){if(e.preventDefault(),g.currentFrameIndex++,g.currentFrameIndex>g.drawRecord.length-1)return void(g.currentFrameIndex=g.drawRecord.length-1);u.handleChangeFrame(g.currentFrameIndex)}else["1","2","3","4","5","6","7","8","9"].includes(e.key)&&(g.brushColor=(null==(a=s.settingsOption.colorKeyOptions.find((a=>a.key==e.key)))?void 0:a.color)||"#000000ff");g.canvas.className="",u.addCursorClass()}},handleKeyUpEvent(e){t.$route.path.includes("/work")&&(" "===e.key&&(g.isSpace=!1,g.canvas.style.cursor=""),"Shift"===e.key&&(g.isShift=!1),"Shift"===e.key&&g.isSelecting&&g.selectData.selectList.length&&(g.isShift=!1,g.isMoving=!1,g.canvas.style.cursor=""),"Escape"!==e.key&&"Esc"!==e.key||(t.$refs.LinmoModeDialog.isPickingColor=!1,t.$refs.LinmoModeDialog.zIndex&&(t.$refs.LinmoModeDialog.zIndex=t.$refs.LinmoModeDialog.zIndexHistoryRecord,t.$refs.LinmoModeDialog.opacity=t.$refs.LinmoModeDialog.opacityHistoryRecord,t.$refs.LinmoModeDialog.updatelinmoPhotoStyle())))},addKeyBoardEvent(){window.addEventListener("keydown",u.handlekeyDownEvent),window.addEventListener("keyup",u.handleKeyUpEvent)},handleResizeWindowEvent(e){u.handleSaveMoveData(!0,(()=>{u.computeScale(),g.canvasBeginPos.centerX=g.canvasBeginPos.x+g.scale*g.canvasWidth/2,g.canvasBeginPos.centerY=g.canvasBeginPos.y+g.scale*g.canvasHeight/2,u.drawPixelArea(!0),g.pinDouMode?u.handleDrawPindou(g.ctx1):u.reDraw(!1,!1),g.linmoFitCanvasTimer&&clearTimeout(g.linmoFitCanvasTimer),g.linmoFitCanvasTimer=setTimeout((()=>{u.handleLinmoFitCanvas(),u.handleDrawReferenceLine(),u.handleScaleFrame()}),250)}))},handleResizeWindow(){window.addEventListener("resize",u.handleResizeWindowEvent)},onDragLayerEnd(e,a){let r=t.$refs[a],l=Array.from(r.children),n=[],s=g.drawRecord[g.currentFrameIndex].layer;for(let t=0;t<l.length;t++){let e=l[t].dataset.key,a=s.find((a=>a.layerId===e));n.push(a)}g.drawRecord[g.currentFrameIndex].layer=n,u.reDraw()},onDragFrameEnd(e,a){let r=t.$refs[a],l=Array.from(r.children),n=[],s=g.drawRecord;for(let t=0;t<l.length-1;t++){let e=l[t].dataset.key,a=s.find((a=>a.frameId===e));n.push(a)}g.drawRecord=n,u.handleChangeFrame(g.currentFrameIndex)},handleCopySelectData(){g.selectData.copySelectMapList=ta(g.selectData.selectMapList),g.selectData.copyList=JSON.parse(JSON.stringify(g.selectData.selectList)),t.$message.success("复制成功")},handleFilter(e,a=0){g.isScaling&&u.handleCancelScale(),g.loading=!0;r.handleFilter(e,g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex],g.selectData,g.canvasWidth,g.canvasHeight,((e=null,a)=>{g.loading=!1,u.reDraw(),u.handleLayerMapDataToLayerData(!0)}),a,g.worker)},handleExpand(){g.isExpandColorSelector=!g.isExpandColorSelector;let e=document.querySelector(".colorSelector"),a=document.querySelector(".back-icon");g.isExpandColorSelector?(e.style.transform="translateX(0)",a.children[0].style.transform="rotate(0deg)"):(e.style.transform="translateX(100%)",a.children[0].style.transform="rotate(180deg)")},handleTransformColorAsHex(e){let a=e;return ga(a)&&9===a.length?e:ga(a)&&7===a.length?a+"ff":ga(a)?Ne(He(a)):Ne(Ye(a))},handleConfirmReplaceColor(e,a){let r=u.handleTransformColorAsHex(e.replaceColor),l=u.handleTransformColorAsHex(e.newColor);if(1===e.type){let e=g.drawRecord[g.currentFrameIndex].layer[g.currentLayerIndex].layerNewData;e[r]?(e[l]=e[r],delete e[r]):t.$message.warning("替换颜色不存在")}else if(2===e.type){let e=g.drawRecord[g.currentFrameIndex].layer;for(let a=0;a<e.length;a++){let e=g.drawRecord[g.currentFrameIndex].layer[a].layerNewData;e[r]&&(e[l]=e[r],delete e[r])}}a(),u.reDraw(),u.handleLayerMapDataToLayerData(!0)},handleResetCanvas(){g.pindouScaleValue=0,g.canvasStyle.transform="translate3d(0, 0, 10px) scale(1)",u.handleResizeWindowEvent("")},handleInitData(){g.currentTool=0,g.historyRecord=[],g.currentFrameIndex=0,g.currentLayerIndex=0,g.currentFrameId=0,g.currentLayerId=0,g.shapeFillColor="#000000ff",g.brushColor="#000000ff",g.isCheckedRatio=!0,g.isShowReferenceLine=!1,g.isShowRuler=!1,g.isShowGridLine=!1,g.isVertical=!1,g.isHorizontal=!1,g.isCenter=!1,g.brushSize=1,g.eraserSize=1,g.widthHeightRatio=1,g.tolerance=0,g.selectType="select",g.currentDrawShape="rect",g.currentDrawTransform="hReverse",g.projectData=Ue(),g.pinDouMode=!1,g.pinDouDrawMode=!1,g.selectLayerList=[g.currentLayerIndex],g.pindouHighlight=null,g.pindouBrand="mard-v2",g.isHidePindouMode=!1,g.isScaling=!1,g.scaleWhitePointPos=[],g.scaleAreaData=null,g.scaleRatio=0,g.colorStatList=[],g.layerAlpha=100,g.isHideLinmoMode=!1,g.linmoMode=!1,g.linmoPhoto=null,g.currentHistoryIndex=0,g.canvasStyle={transform:"translate3d(0, 0, 10px) scale(1)",transformOrigin:"center center"},g.linmoPhotoStyle={width:"200px",height:"200px",transform:"translate3d(0px, 0px, 10px) rotate(0deg) scale(1, 1)",opacity:1,zIndex:0,display:"none",transformOrigin:"center center"},g.pindouScaleValue=0,g.isSpace=!1,g.searchColorValue="",g.searchColorList=[],g.drawAreaGridCanvas=null,g.layerGridImage=null,u.handleCancelSelect()},handleInitEmptyLayer(){g.emptyLayerData=[];for(let e=0;e<g.canvasHeight;e++)for(let a=0;a<g.canvasWidth;a++)g.emptyLayerData.push([a,e,g.emptyColor])},setCanvasCenter(){let e=g.baseCanvas.width/2-g.canvas.width/2,a=g.baseCanvas.height/2-g.canvas.height/2;g.canvas.style.left=`${e}px`,g.canvas.style.top=`${a}px`,g.moveBoxDom.style.left=`${e}px`,g.moveBoxDom.style.top=`${a}px`,g.bgCanvas.style.left=`${e}px`,g.bgCanvas.style.top=`${a}px`,g.gridCanvas.style.left=`${e}px`,g.gridCanvas.style.top=`${a}px`},handleReadProjectData(){let e=t.$route.params.projectId,a=JSON.parse(JSON.stringify(s.getProjectById(e)));if(a){let e=s.currentProjectId.split("A");e[e.length-1]!==a.projectId&&(u.handleInitData(),g.loading=!0,g.projectData.projectId=a.projectId,g.projectData.projectName=a.projectName,g.projectData.updateAt=a.updateAt,g.projectData.createAt=a.createAt,g.projectData.desc=a.desc,g.canvasWidth=Number(a.width),g.canvasHeight=Number(a.height),g.projectData.frameImg=a.frameImg,g.projectData.tip=a.tip,g.projectData.isTop=a.isTop,g.projectData.data=a.data,n.getMyColorList(),g.baseCanvas=document.getElementById("BaseCanvas"),g.canvas=document.getElementById("Canvas"),g.bgCanvas=document.getElementById("PixelCanvas"),g.realCanvas=document.createElement("canvas"),g.gridCanvas=document.getElementById("GridCanvas"),g.moveCanvas=document.getElementById("MoveCanvas"),g.moveBoxDom=document.querySelector(".MoveBox"),u.computeScale(),g.ctx0=g.baseCanvas.getContext("2d"),g.ctx1=g.canvas.getContext("2d"),g.ctx2=g.bgCanvas.getContext("2d"),g.ctx3=g.realCanvas.getContext("2d"),g.ctx4=g.gridCanvas.getContext("2d"),g.ctx5=g.moveCanvas.getContext("2d"),g.ctx1.lineCap="square",g.ctx1.save(),g.canvasBeginPos.centerX=g.canvasBeginPos.x+g.scale*g.canvasWidth/2,g.canvasBeginPos.centerY=g.canvasBeginPos.y+g.scale*g.canvasHeight/2,u.drawPixelArea(!0),u.handleInitEmptyLayer(),u.handleGridImg(),u.startDrawing(),u.addKeyBoardEvent(),u.handleResizeWindow(),g.projectData.data?(g.worker.postMessage({type:4,variables:JSON.parse(JSON.stringify(a.data)),canvasWidth:g.canvasWidth}),g.worker.onmessage=e=>{try{g.drawRecord=e.data,s.saveProjectId(g.projectData.projectId),g.drawRecord.length&&u.reDraw(),u.handleChangeLayer(g.currentLayerIndex),g.loading=!1}catch(a){t.$message.error("项目读取异常"),s.saveProjectId("0"),setTimeout((()=>{t.$router.replace("/project")}),1e3)}}):(s.saveProjectId(g.projectData.projectId),g.drawRecord=[],u.initCanvasRecord("init"),g.loading=!1))}else t.$message.error("项目不存在"),s.saveProjectId("0"),t.$router.replace("/project")},handleCancelKeyboardEvent(){window.removeEventListener("keydown",u.handlekeyDownEvent),window.removeEventListener("keyup",u.handleKeyUpEvent)},handleExportDialog(e){g.exportVisible=!0,g.isExportProject=e,u.handleCancelKeyboardEvent()},handleImportImage(){g.importLayerVisible=!0,u.handleCancelKeyboardEvent()},handleCloseDialog(e){g[e]=!1,u.addKeyBoardEvent()},closeMenu(){g.LayerMenu.visible=!1,g.MyColorMenu.visible=!1},handleMenu(e,a,t){g.pinDouMode||(u.closeMenu(),setTimeout((()=>{g[a].visible=!0,g[a].left=e.pageX,g[a].top=e.pageY,g[a].contextData=da(t),"LayerMenu"===a&&u.handleChangeLayer(t.index)}),100))},preventDefaults(e){e.preventDefault(),e.stopPropagation()},handleDragZoneEvent(){const e=document.getElementById("dropZone");["dragenter","dragover","dragleave","drop"].forEach((a=>{e.addEventListener(a,u.preventDefaults,!1),document.body.addEventListener(a,u.preventDefaults,!1)})),e.addEventListener("drop",u.handleDrop,!1)},handleDrop(e){const a=e.dataTransfer.files[0];u.handleImportDragImage(a)}});return Je((()=>n.data.addMyColorVisible),((e,a)=>{e?u.handleCancelKeyboardEvent():u.addKeyBoardEvent()})),Je((()=>g.isShowReferenceLine),((e,a)=>{u.handleDrawReferenceLine(),u.handleScaleFrame1()})),Je((()=>g.isShowRuler),((e,a)=>{u.handleDrawReferenceLine()})),Je((()=>g.isShowGridLine),((e,a)=>{u.handleDrawGridLine(),g.pinDouMode&&u.handlePindouBlockHighlight(g.pindouHighlightOptions)})),Je((()=>g.pinDouMode),((e,a)=>{!1===e?(Sa.closeAll(),g.currentTool=0,g.pindouHighlight=null,u.handleResetCanvas()):t.$message.warning("拼豆模式 - 超清预览",{duration:0,grouping:!0,icon:"Search",showClose:!0})})),Je((()=>s.themeValue),((e,a)=>{g.canvas&&g.bgCanvas&&(u.drawPixelArea(!0),u.handleScaleFrame1())})),Je((()=>s.isQueryProjectData),((e,a)=>{"1"===e?u.handleReadProjectData():"2"===e&&t.$router.replace("/project")})),_e((()=>{g.worker=new Ja,document.addEventListener("click",u.closeMenu),u.handleDragZoneEvent()})),Ge((()=>{"1"===s.isQueryProjectData&&u.handleReadProjectData(),g.canvas&&(u.startDrawing(),u.addKeyBoardEvent(),u.handleResizeWindow(),document.addEventListener("click",u.closeMenu),g.isHidePindouMode||!g.pinDouMode&&!g.pinDouDrawMode||(u.handleShowPindou(),g.pinDouMode&&(t.$message.warning("拼豆模式 - 超清预览",{duration:0,grouping:!0,icon:"Search"}),u.handleCancelKeyboardEvent())),!g.isHideLinmoMode&&g.linmoMode&&(g.isHideLinmoMode=!1,t.$refs.LinmoModeDialog.handleShow()))})),qe((()=>{var e;g.canvas&&(g.canvas.style.cursor="",g.canvas.classList="",g.canvas.removeEventListener("mousedown",u.start),g.canvas.removeEventListener("mousemove",u.draw),g.canvas.removeEventListener("mouseup",u.stop),g.canvas.removeEventListener("touchstart",u.mobileStart),g.canvas.removeEventListener("touchmove",u.mobileDraw),g.canvas.removeEventListener("touchend",u.stop),g.canvas.removeEventListener("mouseout",u.leave),g.canvas.removeEventListener("wheel",u.handleWheelEvent),g.moveCanvas.removeEventListener("wheel",u.handleWheelEvent),null==(e=document.getElementById("dropZone"))||e.removeEventListener("mousemove",u.handleChangeMouseStyle),window.removeEventListener("keydown",u.handlekeyDownEvent),window.removeEventListener("keyup",u.handleKeyUpEvent),window.removeEventListener("resize",u.handleResizeWindowEvent),document.removeEventListener("click",u.closeMenu),t.$refs.ReplaceColorDialog.handleClose(),t.$refs.MyColorDialog.handleClose(),t.$refs.PreviewAnimDialog.handleClose(),t.$refs.PindouDialog.dialogVisible=!1,t.$refs.LinmoModeDialog.dialogVisible=!1,Sa.closeAll())})),Ze((()=>{g.worker&&g.worker.terminate(),s.saveProjectId("0");const e=document.getElementById("dropZone");["dragenter","dragover","dragleave","drop"].forEach((a=>{e.removeEventListener(a,u.preventDefaults,!1),document.body.removeEventListener(a,u.preventDefaults,!1)})),e.removeEventListener("drop",u.handleDrop,!1)})),o(o(o(i(o(o(o({},Xe(g)),u),p),{editSpaceStore:s,copyText:Qe}),b()),Xe(n.data)),n.computedApi)}});const qa=e=>(Ua("data-v-39277fee"),e=e(),Ka(),e),Za={class:"scrollbar scrollX full-w draw-panel"},Qa={class:"back flex-start"},et={class:"oneline"},at={key:0,style:{color:"red"}},tt={class:"flex-end"},rt=Oa("导入图像 [Ctrl/⌘ + m]"),lt=Oa("保存项目 [Ctrl/⌘ + s]"),nt=Oa("导出项目 [Ctrl/⌘ + p]"),st=Oa("导出图像 [Ctrl/⌘ + i]"),ot={class:"flex-start flex-nowarp full-w",style:{flex:"1"}},it={class:"functionBox"},ct={class:"flex-column-start"},dt=["src"],ht=["src"],gt=["src"],pt=["src"],ut=["src"],mt=["src"],ft=Oa("矩 形 [a]"),yt=Oa("圆 形 [s]"),vt=Oa("直 线 [d]"),Dt=Oa("填充矩形 [f]"),wt=["src"],xt=Oa("手动选择 [y]"),Ct=Oa("快速选择 [p]"),Lt=Oa("区域选择 [j]"),St=Oa("取消选择 [Alt/⌥ + n]"),bt=Oa("复 制 [Alt/⌥ + c]"),kt=Oa("删 除 [Alt/⌥ + d]"),Rt=Oa("移 动 [Shift + 鼠标左键]"),It={class:"flex-column-end"},Mt=["src"],At=Oa("缩放 [Alt/⌥ + q]"),Ft=Oa("水平翻转 [Ctrl/⌘ + ↑]"),Tt=Oa("垂直翻转 [Ctrl/⌘ + ↓]"),Pt=Oa("顺时针旋转90度 [Ctrl/⌘ + →]"),Et=Oa("逆时针旋转90度 [Ctrl/⌘ + ←]"),Bt=["src"],$t=Oa("黑 白"),Ot=Oa("反 相"),Ht=Oa("BGRA"),Nt=["src"],Wt=["src"],Yt=["src"],jt=Oa("预览模式 [o]"),zt=Oa("绘图模式 [k]"),Vt=["src"],Xt={key:1,class:"gridInfo"},Ut={key:2,class:"colorSelector"},Kt={class:"color-body scrollbar full-layout"},Jt=["onClick"],_t=qa((()=>$a("div",{class:"text-center"},"帧",-1))),Gt=["onClick"],qt=["src"],Zt=Oa("复 制"),Qt=Oa("删 除"),er=Oa("复制帧数据"),ar=Oa("粘贴帧数据"),tr=Oa("导出为图像"),rr={class:"full-h flex-nowarp flex flex-column"},lr={style:{flex:"1"},class:"full-w"},nr=qa((()=>$a("h1",null,"功能面板",-1))),sr={class:"function-block function-block-between"},or={class:"flex-center"},ir=qa((()=>$a("span",{class:"function-label"},"画笔颜色",-1))),cr={class:"flex-center"},dr=Oa("保存"),hr=Oa("复制"),gr={class:"function-block function-block-between"},pr={class:"flex-center"},ur=qa((()=>$a("span",{class:"function-label",style:{width:"63px"}},"填充颜色",-1))),mr={key:0,class:"function-block-column",style:{"margin-top":"15px"}},fr={class:"flex-between full-w"},yr={class:"flex-start"},vr={class:"function-label",style:{"margin-right":"10px"}},Dr={class:"color-group-select-icon flex-center pointer"},wr={class:"flex-start flex-warp common-color scrollbar"},xr=["title","onContextmenu","onClick"],Cr={class:"mycolor flex-center",style:{"background-color":"var(--el-bg-color-second)"}},Lr={key:1,class:"function-block function-block-between"},Sr=qa((()=>$a("span",{class:"function-label"},"画笔大小",-1))),br={key:2,class:"function-block function-block-between"},kr=qa((()=>$a("span",{class:"function-label"},"橡皮擦大小",-1))),Rr={class:"function-block-column"},Ir={class:"flex-between flex-nowarp full-w"},Mr=qa((()=>$a("span",{class:"function-label",style:{margin:"0",width:"100px"}},"画布像素",-1))),Ar={style:{gap:"10px","margin-top":"10px"},class:"flex-start full-w"},Fr=Oa("宽"),Tr=Oa("高"),Pr={style:{"margin-top":"10px"},class:"flex-between symmetric-box full-w"},Er={style:{"margin-top":"10px"},class:"flex-between symmetric-box full-w"},Br={class:"function-block function-block-between"},$r=qa((()=>$a("div",{class:"function-label"}," 容 差 ",-1))),Or={class:"function-block function-block-between"},Hr=qa((()=>$a("div",{class:"function-label"}," 图层透明度 ",-1))),Nr={class:"function-block function-block-between flex-warp",style:{gap:"10px"}},Wr={key:0},Yr=Oa("复 制"),jr=Oa("删 除"),zr=Oa("取消选择"),Vr={key:1},Xr={key:0,style:{flex:"1","margin-top":"15px"},class:"full-w scrollHidden"},Ur={class:"flex-between"},Kr=Oa("图层面板 "),Jr={class:"flex-end"},_r=["data-key","disabled","onContextmenu","onClick"],Gr={class:"flex-start",style:{gap:"10px"}},qr=["onClick"],Zr=["src"],Qr={key:0,class:"layer-img flex-center"},el=["src"],al={key:1},tl=["onDblclick","title"],rl={class:"flex-end"},ll={class:"flex-between",style:{"margin-top":"10px"}},nl=Oa(" 新建分组 "),sl={class:"flex-end"},ol=Oa("取消"),il=Oa("保存"),cl={class:"dialog-footer"},dl=Oa("取 消"),hl=Oa("保 存");var gl=ba(Ga,[["render",function(e,a,t,r,l,n){const s=ka("ArrowLeftBold"),o=ka("el-icon"),i=ka("Loading"),c=ka("Back"),d=ka("el-tooltip"),h=ka("Right"),g=ka("ZoomIn"),p=ka("ZoomOut"),u=ka("Refresh"),m=ka("Pointer"),f=ka("VideoPlay"),y=ka("Folder"),v=ka("el-dropdown-item"),D=ka("el-dropdown-menu"),w=ka("el-dropdown"),x=ka("FullScreen"),C=ka("el-header"),L=ka("VueDragScale"),S=ka("Expand"),b=ka("Plus"),k=ka("el-footer"),R=ka("el-main"),I=ka("el-divider"),M=ka("sketch-picker"),A=ka("el-popover"),F=ka("el-link"),T=ka("CaretBottom"),P=ka("search"),E=ka("el-input"),B=ka("MoreFilled"),$=ka("el-slider"),O=ka("el-checkbox"),H=ka("el-input-number"),N=ka("el-button"),W=ka("Close"),Y=ka("Check"),j=ka("View"),z=ka("Hide"),V=ka("DocumentAdd"),X=ka("CirclePlus"),U=ka("Lock"),K=ka("Unlock"),J=ka("CopyDocument"),_=ka("Delete"),G=ka("el-popconfirm"),q=ka("el-aside"),Z=ka("el-container"),Q=ka("MyColorDialog"),ee=ka("ReplaceColorDialog"),ae=ka("ExportDialog"),te=ka("PreviewAnimDialog"),re=ka("PindouDialog"),le=ka("LayerMenu"),ne=ka("MyColorMenu"),se=ka("LinmoModeDialog"),oe=ka("UploadImageLayerDialog"),ie=ka("el-color-picker"),ce=ka("el-option"),de=ka("el-select"),he=ka("el-dialog"),ge=Ra("loading");return Ba(),Ia("div",{class:"container full-h",style:Ea(e.checkzIndex)},[Ma(Z,{class:"full-h flex-warp"},{default:Aa((()=>[$a("div",Za,[Ma(R,{class:"flex-column-center",style:{display:"flex",padding:"0","min-width":"500px"}},{default:Aa((()=>[Ma(C,{class:"flex-between"},{default:Aa((()=>[$a("div",Qa,[Ma(o,{onClick:e.handleBack},{default:Aa((()=>[Ma(s)])),_:1},8,["onClick"]),$a("h1",et,[Oa(Ha(e.projectData.projectName)+" ",1),e.isSaveProject?Ta("v-if",!0):(Ba(),Ia("span",at,"*"))]),e.editSpaceStore.isAutoBackuping?(Ba(),Fa(o,{key:0,style:{"margin-left":"10px"},color:"green",class:Na({"is-loading":e.editSpaceStore.isAutoBackuping})},{default:Aa((()=>[Ma(i)])),_:1},8,["class"])):Ta("v-if",!0)]),$a("div",tt,[Ma(d,{content:"撤销 [Alt/⌥ + z]",placement:"bottom"},{default:Aa((()=>[Ma(o,{style:{"margin-right":"20px"},onClick:e.handleRevoke,class:Na({isNotAllowed:!e.historyRecord.length||7===e.currentTool})},{default:Aa((()=>[Ma(c)])),_:1},8,["onClick","class"])])),_:1}),Ma(d,{content:"恢复 [Alt/⌥ + x]",placement:"bottom"},{default:Aa((()=>[Ma(o,{style:{"margin-right":"20px"},onClick:e.handleRecover,class:Na({isNotAllowed:!e.historyRecord.length||7===e.currentTool})},{default:Aa((()=>[Ma(h)])),_:1},8,["onClick","class"])])),_:1}),Ma(d,{content:"放大画布 [滚轮/Ctrl/⌘ + =]",placement:"bottom"},{default:Aa((()=>[Ma(o,{style:{"margin-right":"20px"},onClick:a[0]||(a[0]=a=>e.handleResizeCanvas(.05))},{default:Aa((()=>[Ma(g)])),_:1})])),_:1}),Ma(d,{content:"缩小画布 [滚轮/Ctrl/⌘ + -]",placement:"bottom"},{default:Aa((()=>[Ma(o,{style:{"margin-right":"20px"},onClick:a[1]||(a[1]=a=>e.handleResizeCanvas(-.05))},{default:Aa((()=>[Ma(p)])),_:1})])),_:1}),Ma(d,{content:"重置画布 [Alt/⌥ + v]",placement:"bottom"},{default:Aa((()=>[Ma(o,{style:{"margin-right":"20px"},onClick:e.handleResetCanvas},{default:Aa((()=>[Ma(u)])),_:1},8,["onClick"])])),_:1}),Ma(d,{content:"移动画布 [空格 + 鼠标]",placement:"bottom"},{default:Aa((()=>[Ta(' <el-icon style="margin-right: 20px; color: orange;" v-if="isSpace" @click="isSpace=false"><Pointer /></el-icon> '),Ma(o,{style:{"margin-right":"20px"},onClick:e.handleOpenMoveCanvas,class:Na({active:e.isSpace})},{default:Aa((()=>[Ma(m)])),_:1},8,["onClick","class"])])),_:1}),Ma(d,{content:e.previewLoading?"正在加载":"预览动画 [Alt/⌥ + p]",placement:"bottom"},{default:Aa((()=>[e.previewLoading?(Ba(),Fa(o,{key:1,style:{"margin-right":"20px"},class:"is-loading"},{default:Aa((()=>[Ma(i)])),_:1})):(Ba(),Fa(o,{key:0,style:{"margin-right":"20px"},onClick:e.handleOpenPreviewDialog},{default:Aa((()=>[Ma(f)])),_:1},8,["onClick"]))])),_:1},8,["content"]),Ta(' <el-tooltip\r\n                            content="导出"\r\n                            placement="bottom">\r\n                                <el-icon style="margin-right: 20px;" @click="exportVisible=true"><Files /></el-icon>\r\n                            </el-tooltip> '),Ma(w,{placement:"bottom",trigger:"hover"},{dropdown:Aa((()=>[Ma(D,null,{default:Aa((()=>[Ma(v,{onClick:e.handleImportImage,disabled:e.pinDouMode},{default:Aa((()=>[rt])),_:1},8,["onClick","disabled"]),Ma(v,{onClick:e.handleSaveProject,disabled:e.pinDouMode},{default:Aa((()=>[lt])),_:1},8,["onClick","disabled"]),Ta(' <el-dropdown-item @click="handleImportProject">导入项目</el-dropdown-item> '),Ma(v,{onClick:a[2]||(a[2]=a=>e.handleExportDialog(!0)),disabled:e.pinDouMode},{default:Aa((()=>[nt])),_:1},8,["disabled"]),Ma(v,{onClick:a[3]||(a[3]=a=>e.handleExportDialog(!1)),disabled:e.pinDouMode},{default:Aa((()=>[st])),_:1},8,["disabled"])])),_:1})])),default:Aa((()=>[Ma(o,{style:{"margin-right":"20px"},size:"16"},{default:Aa((()=>[Ma(y)])),_:1})])),_:1}),Ma(d,{content:"全屏 [Alt/⌥ + f]",placement:"bottom"},{default:Aa((()=>[Ma(o,{class:Na({active:e.editSpaceStore.isFullWork}),style:{"margin-right":"0px"},onClick:e.handleScreenFull},{default:Aa((()=>[Ma(x)])),_:1},8,["class","onClick"])])),_:1})])])),_:1}),$a("div",ot,[$a("div",it,[$a("div",ct,[Ma(d,{content:"画笔 [q]",placement:"right"},{default:Aa((()=>[$a("div",{class:Na(["pointer toolItem flex-center",{active:0===e.currentTool}]),style:{"margin-top":"0"},onClick:a[4]||(a[4]=a=>e.handleChangeTool(0))},[$a("img",{src:e.requireIcon("brush")},null,8,dt),Ta(" <span v-html=\"$iconSvg['brush']\"></span> ")],2)])),_:1}),Ma(d,{content:"橡皮擦 [w]",placement:"right"},{default:Aa((()=>[$a("div",{class:Na(["pointer toolItem",{active:1===e.currentTool}]),onClick:a[5]||(a[5]=a=>e.handleChangeTool(1))},[$a("img",{src:e.requireIcon("eraser")},null,8,ht),Ta(" <span v-html=\"$iconSvg['eraser']\"></span> ")],2)])),_:1}),Ma(d,{content:"吸管 [e]",placement:"right"},{default:Aa((()=>[$a("div",{class:Na(["pointer toolItem",{active:2===e.currentTool}]),onClick:a[6]||(a[6]=a=>e.handleChangeTool(2))},[Ta(" <span v-html=\"$iconSvg['straw']\"></span> "),$a("img",{src:e.requireIcon("straw")},null,8,gt)],2)])),_:1}),Ma(d,{content:"油漆桶 [r]",placement:"right"},{default:Aa((()=>[$a("div",{class:Na(["pointer toolItem",{active:4===e.currentTool}]),onClick:a[7]||(a[7]=a=>e.handleChangeTool(4))},[$a("img",{src:e.requireIcon("bucket")},null,8,pt)],2)])),_:1}),Ma(d,{content:"移动 [t]",placement:"right"},{default:Aa((()=>[$a("div",{class:Na(["pointer toolItem",{active:7===e.currentTool}]),onClick:a[8]||(a[8]=a=>e.handleChangeTool(7))},[$a("img",{src:e.requireIcon("move")},null,8,ut)],2)])),_:1}),Ma(d,{content:"形状",placement:"right"},{default:Aa((()=>[Ma(w,{placement:"bottom-start",trigger:"click"},{dropdown:Aa((()=>[Ma(D,null,{default:Aa((()=>[Ma(v,{onClick:a[10]||(a[10]=a=>e.drawShape("rect")),disabled:e.pinDouMode},{default:Aa((()=>[ft])),_:1},8,["disabled"]),Ma(v,{onClick:a[11]||(a[11]=a=>e.drawShape("circle")),disabled:e.pinDouMode},{default:Aa((()=>[yt])),_:1},8,["disabled"]),Ma(v,{onClick:a[12]||(a[12]=a=>e.drawShape("line")),disabled:e.pinDouMode},{default:Aa((()=>[vt])),_:1},8,["disabled"]),Ma(v,{onClick:a[13]||(a[13]=a=>e.drawShape("fillRect")),disabled:e.pinDouMode},{default:Aa((()=>[Dt])),_:1},8,["disabled"]),Ta("v-if",!0),Ta(" <el-dropdown-item @click=\"drawShape('fillCircle')\">填充圆形</el-dropdown-item> ")])),_:1})])),default:Aa((()=>[$a("div",{class:Na(["pointer toolItem",{active:3===e.currentTool}]),onClick:a[9]||(a[9]=a=>e.handleChangeTool(3))},[$a("img",{src:e.requireShapeImg},null,8,mt)],2)])),_:1})])),_:1}),Ma(d,{content:"选区",placement:"right"},{default:Aa((()=>[Ma(w,{placement:"bottom-start",trigger:"click"},{dropdown:Aa((()=>[Ma(D,null,{default:Aa((()=>[Ma(v,{onClick:a[16]||(a[16]=a=>e.selectType="select")},{default:Aa((()=>[xt])),_:1}),Ma(v,{onClick:a[17]||(a[17]=a=>e.selectType="quickSelect")},{default:Aa((()=>[Ct])),_:1}),Ma(v,{onClick:a[18]||(a[18]=a=>e.selectType="rangeSelect")},{default:Aa((()=>[Lt])),_:1}),Ma(v,{onClick:e.handleCancelSelect,disabled:!e.selectData.selectList.length},{default:Aa((()=>[St])),_:1},8,["onClick","disabled"]),Ma(v,{onClick:a[19]||(a[19]=a=>e.selectData.copyList=JSON.parse(JSON.stringify(e.selectData.selectList))),disabled:!e.selectData.selectList.length},{default:Aa((()=>[bt])),_:1},8,["disabled"]),Ta(" <el-dropdown-item @click=\"handleSelect('copy')\" disabled>粘 贴 [Alt/⌥ + v]</el-dropdown-item> "),Ma(v,{onClick:e.handleRemoveSelect,disabled:!e.selectData.selectList.length},{default:Aa((()=>[kt])),_:1},8,["onClick","disabled"]),Ma(v,{disabled:""},{default:Aa((()=>[Rt])),_:1})])),_:1})])),default:Aa((()=>[$a("div",{class:Na(["pointer toolItem",{active:8===e.currentTool}]),onClick:a[15]||(a[15]=a=>e.handleChangeTool(8))},[$a("img",{src:e.requireSelectImg},null,8,wt)],2)])),_:1})])),_:1}),Ta(' <el-tooltip\r\n                                content="魔棒 [p]"\r\n                                placement="right"\r\n                                >\r\n                                    <div class="pointer toolItem" @click="handleChangeTool(9)"\r\n                                    :class="{ \'active\': currentTool === 9 }">\r\n                                        <img :src="requireIcon(\'magicStick\')"/>\r\n                                    </div>\r\n                                </el-tooltip> ')]),$a("div",It,[Ma(d,{content:"变换",placement:"right"},{default:Aa((()=>[Ma(w,{placement:"top-start",trigger:"click",disabled:7===e.currentTool},{dropdown:Aa((()=>[Ma(D,null,{default:Aa((()=>[Ma(v,{onClick:a[20]||(a[20]=a=>e.drawTransform("scale")),disabled:e.pinDouMode},{default:Aa((()=>[At])),_:1},8,["disabled"]),Ma(v,{onClick:a[21]||(a[21]=a=>e.drawTransform("hReverse")),disabled:e.pinDouMode},{default:Aa((()=>[Ft])),_:1},8,["disabled"]),Ma(v,{onClick:a[22]||(a[22]=a=>e.drawTransform("vReverse")),disabled:e.pinDouMode},{default:Aa((()=>[Tt])),_:1},8,["disabled"]),Ma(v,{onClick:a[23]||(a[23]=a=>e.drawTransform("ssz")),disabled:e.pinDouMode||e.canvasWidth!==e.canvasHeight},{default:Aa((()=>[Pt])),_:1},8,["disabled"]),Ma(v,{onClick:a[24]||(a[24]=a=>e.drawTransform("nsz")),disabled:e.pinDouMode||e.canvasWidth!==e.canvasHeight},{default:Aa((()=>[Et])),_:1},8,["disabled"]),Ta(" <el-dropdown-item @click=\"drawShape('fillCircle')\">填充圆形</el-dropdown-item> ")])),_:1})])),default:Aa((()=>[$a("div",{class:Na(["pointer toolItem",{active:9===e.currentTool,isNotAllowed:7===e.currentTool}])},[$a("img",{src:e.requireTransformImg},null,8,Mt)],2)])),_:1},8,["disabled"])])),_:1}),Ma(d,{content:"滤镜",placement:"right"},{default:Aa((()=>[Ma(w,{placement:"top-start",trigger:"click",disabled:7===e.currentTool},{dropdown:Aa((()=>[Ma(D,null,{default:Aa((()=>[Ma(v,{onClick:a[25]||(a[25]=a=>e.handleFilter(1)),disabled:e.pinDouMode},{default:Aa((()=>[$t])),_:1},8,["disabled"]),Ma(v,{onClick:a[26]||(a[26]=a=>e.handleFilter(2)),disabled:e.pinDouMode},{default:Aa((()=>[Ot])),_:1},8,["disabled"]),Ma(v,{onClick:a[27]||(a[27]=a=>e.handleFilter(3)),disabled:e.pinDouMode},{default:Aa((()=>[Ht])),_:1},8,["disabled"]),Ta(' <el-dropdown-item @click="handleFilter(4, 16)" :disabled="pinDouMode">16色</el-dropdown-item>\r\n                                                <el-dropdown-item @click="handleFilter(4, 32)" :disabled="pinDouMode">32色</el-dropdown-item>\r\n                                                <el-dropdown-item @click="handleFilter(4, 64)" :disabled="pinDouMode">64色</el-dropdown-item>\r\n                                                <el-dropdown-item @click="handleFilter(4, 128)" :disabled="pinDouMode">128色</el-dropdown-item> '),Ta(" <el-dropdown-item @click=\"drawShape('fillCircle')\">填充圆形</el-dropdown-item> ")])),_:1})])),default:Aa((()=>[$a("div",{class:Na(["pointer toolItem",{isNotAllowed:7===e.currentTool}])},[$a("img",{src:e.requireIcon("filter")},null,8,Bt)],2)])),_:1},8,["disabled"])])),_:1}),Ma(d,{content:"替换颜色 [u]",placement:"right"},{default:Aa((()=>[$a("div",{class:Na(["pointer toolItem",{isNotAllowed:7===e.currentTool}]),onClick:a[28]||(a[28]=(...a)=>e.handleOpenReplaceColorDialog&&e.handleOpenReplaceColorDialog(...a))},[$a("img",{src:e.requireIcon("color")},null,8,Nt)],2)])),_:1}),Ma(d,{content:"清空图层 [i]",placement:"right"},{default:Aa((()=>[$a("div",{class:Na(["pointer toolItem",{isNotAllowed:7===e.currentTool}]),onClick:a[29]||(a[29]=a=>e.handleChangeTool(6))},[$a("img",{src:e.requireIcon("clear")},null,8,Wt)],2)])),_:1}),Ma(d,{content:"拼豆模式",placement:"right"},{default:Aa((()=>[Ma(w,{placement:"top-start",trigger:"hover",disabled:7===e.currentTool},{dropdown:Aa((()=>[Ma(D,null,{default:Aa((()=>[Ma(v,{onClick:a[31]||(a[31]=a=>e.handlePindouMode("preview")),disabled:e.pinDouMode},{default:Aa((()=>[jt])),_:1},8,["disabled"]),Ma(v,{onClick:a[32]||(a[32]=a=>e.handlePindouMode("draw")),disabled:e.pinDouMode},{default:Aa((()=>[zt])),_:1},8,["disabled"])])),_:1})])),default:Aa((()=>[$a("div",{class:Na(["pointer toolItem",{active:e.pinDouMode||e.pinDouDrawMode,isNotAllowed:7===e.currentTool}]),onClick:a[30]||(a[30]=a=>e.handlePindouMode("preview"))},[$a("img",{src:e.requireIcon("pindou")},null,8,Yt)],2)])),_:1},8,["disabled"])])),_:1}),Ma(d,{content:"临摹模式 [l]",placement:"right"},{default:Aa((()=>[$a("div",{class:Na(["pointer toolItem",{active:e.linmoMode}]),onClick:a[33]||(a[33]=(...a)=>e.handleLinmoMode&&e.handleLinmoMode(...a))},[$a("img",{src:e.requireIcon("copy")},null,8,Vt)],2)])),_:1}),Ta(' <el-tooltip\r\n                                    content="AI"\r\n                                    placement="right"\r\n                                >\r\n                                    <el-dropdown placement="top-start" trigger="click">\r\n                                        <div class="pointer toolItem">\r\n                                            <img :src="requireIcon(\'ai\')"/>\r\n                                        </div>\r\n                                        <template #dropdown>\r\n                                            <el-dropdown-menu>\r\n                                                <el-dropdown-item @click="handleFilter(1)" :disabled="pinDouMode">智能描边</el-dropdown-item>\r\n                                                <el-dropdown-item @click="handleFilter(2)" :disabled="pinDouMode">智能生图</el-dropdown-item>\r\n                                                \r\n                                            </el-dropdown-menu>\r\n                                        </template>\r\n                                    </el-dropdown>\r\n                                    \r\n                                </el-tooltip> ')])]),Wa((Ba(),Ia("div",{onContextmenu:a[42]||(a[42]=e=>e.preventDefault()),class:"pixelBox scrollbar",id:"dropZone","element-loading-background":"#00000000"},[e.linmoPhoto?(Ba(),Fa(L,{key:0,linmoPhotoStyle:e.linmoPhotoStyle,isHighPreview:e.isHighPreview,linmoPhoto:e.linmoPhoto,onUpdate:e.handleUpdateLinmoStyle},{default:Aa((()=>[Ta(' <img :src="linmoPhoto" draggable="false"/> ')])),_:1},8,["linmoPhotoStyle","isHighPreview","linmoPhoto","onUpdate"])):Ta("v-if",!0),Ta(' <img \r\n                            :src="linmoPhoto" \r\n                            v-show="linmoPhoto" draggable="false" \r\n                            :style="linmoPhotoStyle" class="linmoPhoto" id="linmoPhoto"/> '),$a("canvas",{id:"PixelCanvas",width:"512",height:"512",onContextmenu:a[34]||(a[34]=e=>e.preventDefault()),style:Ea(e.canvasStyle)},null,36),$a("canvas",{id:"Canvas",style:Ea(e.canvasStyle),width:"512",height:"512",onContextmenu:a[35]||(a[35]=e=>e.preventDefault())},null,36),Wa($a("div",{class:"MoveBox",style:Ea(e.canvasStyle)},[$a("canvas",{id:"MoveCanvas",onMousedown:a[36]||(a[36]=(...a)=>e.handleMoveCanvasMouseDown&&e.handleMoveCanvasMouseDown(...a)),onContextmenu:a[37]||(a[37]=e=>e.preventDefault())},null,32)],4),[[Ya,e.isMoving]]),$a("canvas",{id:"GridCanvas",style:Ea(e.canvasStyle),width:"512",height:"512",onContextmenu:a[38]||(a[38]=e=>e.preventDefault())},null,36),$a("canvas",{id:"BaseCanvas",width:"512",height:"512",onContextmenu:a[39]||(a[39]=e=>e.preventDefault())},null,32),"[]"!==e.gridInfo?(Ba(),Ia("p",Xt,Ha(e.gridInfo),1)):Ta("v-if",!0),Ta(' <div class="flex-center cancelSelect">\r\n                                <div v-if="selectData.selectList.length">\r\n                                    <el-dropdown placement="top">\r\n                                        <el-button type="primary" @click="handleRemoveSelect">旋 转</el-button>\r\n                                        <template #dropdown>\r\n                                            <el-dropdown-menu>\r\n                                                <el-dropdown-item>45度</el-dropdown-item>\r\n                                                <el-dropdown-item>90度</el-dropdown-item>\r\n                                                <el-dropdown-item>180度</el-dropdown-item>\r\n                                            </el-dropdown-menu>\r\n                                        </template>\r\n                                    </el-dropdown> \r\n                                    <el-button type="primary" @click="handleCopySelectData">复 制</el-button>\r\n                                    <el-button type="primary" @click="handleRemoveSelect">删 除</el-button>\r\n                                    <el-button type="primary" @click="handleCancelSelect">取消选择</el-button>\r\n                                </div>\r\n                                <div v-if="currentTool === 9 && scaleAreaData">\r\n                                    <el-button type="danger" @click="handleCancelScale">\r\n                                        <el-icon><Close /></el-icon>\r\n                                    </el-button>\r\n                                    <el-button type="success" @click="handleFinishScale">\r\n                                        <el-icon><Check /></el-icon>\r\n                                    </el-button>\r\n                                </div>\r\n                            </div> '),Object.keys(e.colorStatList).length?(Ba(),Ia("div",Ut,[$a("div",{class:"back-icon",onClick:a[40]||(a[40]=(...a)=>e.handleExpand&&e.handleExpand(...a))},[Ma(o,null,{default:Aa((()=>[Ma(S)])),_:1})]),$a("div",Kt,[(Ba(!0),Ia(ja,null,za(Object.keys(e.colorStatList),(a=>(Ba(),Ia("div",{class:Na(["colorItem",{active:e.brushColor===a}]),key:a,onClick:t=>e.brushColor=a,style:Ea({backgroundColor:a,display:e.colorStatList[a].size>0?"block":"none"})},null,14,Jt)))),128))])])):Ta("v-if",!0),e.isHidePindouMode?(Ba(),Ia("div",{key:3,class:"pindouBtn flex-center",onClick:a[41]||(a[41]=(...a)=>e.handleShowPindou&&e.handleShowPindou(...a))},Ha(e.pinDouMode?"预":"绘"),1)):Ta("v-if",!0)],32)),[[ge,e.loading]])]),Ma(k,{class:"flex-start"},{default:Aa((()=>[_t,$a("div",{class:"flex-start frame-list scrollbar",onDragstart:a[44]||(a[44]=a=>e.onDragStart(a,e.pinDouMode)),onDragover:a[45]||(a[45]=a=>e.onDragOver(a,"frameBox")),onDragend:a[46]||(a[46]=a=>e.onDragFrameEnd(a,"frameBox")),ref:"frameBox",id:"frame-box"},[(Ba(!0),Ia(ja,null,za(e.drawRecord,((a,t)=>(Ba(),Fa(w,{draggable:"true","data-key":a.frameId,"data-node":"LI",disabled:e.pinDouMode,key:a.frameId,trigger:"contextmenu"},{dropdown:Aa((()=>[Ma(D,null,{default:Aa((()=>[Ma(v,{onClick:a=>e.handleCopyFrame(t,"copy")},{default:Aa((()=>[Zt])),_:2},1032,["onClick"]),Ta(' <el-dropdown-item @click="handleExportFrame(index)">导出为帧数据</el-dropdown-item> '),0!==t?(Ba(),Fa(v,{key:0,onClick:a=>e.handleDeleteFrame(t)},{default:Aa((()=>[Qt])),_:2},1032,["onClick"])):Ta("v-if",!0),Ma(v,{onClick:a=>e.handleCopyFrame(t,"copyData")},{default:Aa((()=>[er])),_:2},1032,["onClick"]),Ma(v,{onClick:a=>e.handleCopyFrame(t,"pasteData")},{default:Aa((()=>[ar])),_:2},1032,["onClick"]),Ma(v,{onClick:a=>e.handleExportFrame(t)},{default:Aa((()=>[tr])),_:2},1032,["onClick"])])),_:2},1024)])),default:Aa((()=>[$a("div",{onClick:a=>e.handleChangeFrame(t),class:Na(["frame-item pointer",{active:e.currentFrameIndex===t}])},[a.currentFrameImg?(Ba(),Ia("img",{key:0,draggable:"false",src:a.currentFrameImg},null,8,qt)):Ta("v-if",!0)],10,Gt)])),_:2},1032,["data-key","disabled"])))),128)),e.drawRecord.length<e.maxFrame?(Ba(),Ia("div",{key:0,class:"frame-item pointer frame-add flex-center",onClick:a[43]||(a[43]=(...a)=>e.handleAddFrame&&e.handleAddFrame(...a))},[Ma(o,null,{default:Aa((()=>[Ma(b)])),_:1})])):Ta("v-if",!0)],544)])),_:1})])),_:1})]),Ma(q,null,{default:Aa((()=>[$a("div",rr,[$a("div",lr,[nr,Ma(I,{"border-style":"dashed"}),$a("div",sr,[$a("div",or,[ir,Ta(' <el-color-picker v-model="brushColor" show-alpha @active-change="(e) => brushColor = e"/> '),Ma(A,{placement:"bottom",width:224,visible:e.brushColorVisible},{reference:Aa((()=>[$a("div",{style:Ea({backgroundColor:e.brushColor}),class:"color-picker",onClick:a[47]||(a[47]=a=>e.brushColorVisible=!e.brushColorVisible)},null,4)])),default:Aa((()=>[Ma(M,{modelValue:e.brushColor,"onUpdate:modelValue":a[48]||(a[48]=a=>e.brushColor=a.hex8)},null,8,["modelValue"])])),_:1},8,["visible"])]),$a("div",cr,[Ma(d,{content:"保存颜色 [Alt/⌥ + s]",placement:"top"},{default:Aa((()=>[Ma(F,{type:"info",underline:!1,onClick:a[49]||(a[49]=a=>e.handleSaveColor(!1,e.brushColor))},{default:Aa((()=>[dr])),_:1})])),_:1}),Ma(d,{content:"复制颜色 [Ctrl/⌘ + Alt/⌥ + c]",placement:"top"},{default:Aa((()=>[Ma(F,{type:"info",underline:!1,style:{"margin-left":"10px"},onClick:a[50]||(a[50]=a=>e.handleCopyColor(e.brushColor))},{default:Aa((()=>[hr])),_:1})])),_:1})])]),Wa($a("div",gr,[$a("div",pr,[ur,Ta(' <el-color-picker v-model="shapeFillColor" show-alpha /> '),Ma(A,{placement:"bottom",width:224,visible:e.shapeFillColorVisible},{reference:Aa((()=>[$a("div",{style:Ea({backgroundColor:e.shapeFillColor}),class:"color-picker",onClick:a[51]||(a[51]=a=>e.shapeFillColorVisible=!e.shapeFillColorVisible)},null,4)])),default:Aa((()=>[Ma(M,{modelValue:e.shapeFillColor,"onUpdate:modelValue":a[52]||(a[52]=a=>e.shapeFillColor=a.hex8)},null,8,["modelValue"])])),_:1},8,["visible"])])],512),[[Ya,e.currentDrawShape.indexOf("fill")>=0&&3e3===e.currentTool]]),e.editSpaceStore.myColorList.length?(Ba(),Ia("div",mr,[$a("div",fr,[$a("div",yr,[$a("span",vr,Ha(e.editSpaceStore.myColorList.find((a=>a.id==e.currentColorGroup)).groupName||"常用颜色"),1),Ma(w,{trigger:"click"},{dropdown:Aa((()=>[Ma(D,null,{default:Aa((()=>[(Ba(!0),Ia(ja,null,za(e.editSpaceStore.myColorList,(a=>(Ba(),Fa(v,{key:a.id,onClick:t=>e.currentColorGroup=a.id},{default:Aa((()=>[Oa(Ha(a.groupName),1)])),_:2},1032,["onClick"])))),128))])),_:1})])),default:Aa((()=>[$a("div",Dr,[Ma(o,null,{default:Aa((()=>[Ma(T)])),_:1})])])),_:1})]),$a("div",null,[Ma(E,{modelValue:e.searchColorValue,"onUpdate:modelValue":a[53]||(a[53]=a=>e.searchColorValue=a),style:{width:"100px"},size:"small",placeholder:"搜索颜色",onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,onKeyup:a[54]||(a[54]=Va((a=>e.handleSearchColor(e.currentColorGroup)),["enter"]))},{prefix:Aa((()=>[Ma(o,{class:"el-input__icon"},{default:Aa((()=>[Ma(P)])),_:1})])),_:1},8,["modelValue","onFocus","onBlur"])])]),$a("div",wr,[Ta(' <el-dropdown v-for="(item, index) in myColorList[0].list" :key="item" trigger="hover">\r\n                                    <div :style="{backgroundColor: item}" class="mycolor" @click="brushColor=handleTransformColorAsHex(item)"></div>\r\n                                    <template #dropdown>\r\n                                        <el-dropdown-menu>\r\n                                            <el-dropdown-item @click="copyText(item)">复 制</el-dropdown-item>\r\n                                            <el-dropdown-item @click="handleEditMyColor(item, 1, index)">修 改</el-dropdown-item>\r\n                                            <el-dropdown-item @click="handleDeleteMyColor(index, 1)">删 除</el-dropdown-item>\r\n                                        </el-dropdown-menu>\r\n                                    </template>\r\n                                </el-dropdown> '),(Ba(!0),Ia(ja,null,za(e.searchColorList.length?e.searchColorList:e.editSpaceStore.myColorList.find((a=>a.id==e.currentColorGroup)).list||[],((a,t)=>(Ba(),Ia("div",{key:t,style:Ea({backgroundColor:(null==a?void 0:a.color)||a}),class:"mycolor",title:(null==a?void 0:a.label)||"",onContextmenu:Xa((r=>e.handleMenu(r,"MyColorMenu",{color:(null==a?void 0:a.color)||a,gid:e.currentColorGroup,index:t})),["prevent"]),onClick:t=>e.brushColor=e.handleTransformColorAsHex((null==a?void 0:a.color)||a)},null,44,xr)))),128)),$a("div",Cr,[Ma(o,{color:"#808080",onClick:a[55]||(a[55]=a=>e.handleAdd(e.currentColorGroup))},{default:Aa((()=>[Ma(b)])),_:1}),Ta(' <el-popover placement="bottom" :width="250" trigger="click" :visible="addMyColorVisible">\r\n                                        <template #reference>\r\n                                            <el-icon color="#808080" @click="addMyColorVisible=true;editMyColorMask=null"><Plus /></el-icon>\r\n                                        </template>\r\n                                        <div>\r\n                                            <p>{{editMyColorMask?\'修改颜色\':\'添加颜色\'}}</p>\r\n                                            <div class="flex-between" style="margin-top: 10px;">\r\n                                                <el-color-picker v-model="myColor" show-alpha/>\r\n                                                <el-select v-model="myColorGroup" placeholder="选择分组" style="width: 150px">\r\n                                                    <el-option\r\n                                                        v-for="item in editSpaceStore.myColorList"\r\n                                                        :key="item.id"\r\n                                                        :label="item.groupName"\r\n                                                        :value="item.id"\r\n                                                        />\r\n                                                        <template #footer>\r\n                                                            <el-button v-if="!isAddGroup" text bg size="small" @click="isAddGroup=true">\r\n                                                                新建分组\r\n                                                            </el-button>\r\n                                                            <template v-else>\r\n                                                                <el-input\r\n                                                                v-model="myGroupName"\r\n                                                                class="option-input"\r\n                                                                placeholder="请输入分组"\r\n                                                                size="small"\r\n                                                                maxlength="10"\r\n                                                                />\r\n                                                                <div class="flex-end">\r\n                                                                    <el-button size="small" @click="myGroupName=\'\';isAddGroup=false">取消</el-button>\r\n                                                                    <el-button type="primary" size="small" @click="addColorGroup">保存</el-button>  \r\n                                                                </div>\r\n                                                                \r\n                                                            </template>\r\n                                                        </template>\r\n                                                </el-select>\r\n                                            </div>\r\n                                            \r\n                                            <div class="flex-end" style="margin-top: 10px;">\r\n                                                <el-button @click="addMyColorVisible=false">取 消</el-button>\r\n                                                <el-button type="primary" @click="handleAddColor">保 存</el-button>\r\n                                            </div>\r\n                                        </div>\r\n                                    </el-popover> ')]),Ma(d,{content:"全部颜色 [Alt/⌥ + g]",placement:"bottom"},{default:Aa((()=>[$a("div",{class:"mycolor flex-center",style:{"background-color":"var(--el-bg-color-second)"},onClick:a[56]||(a[56]=(...a)=>e.handleOpenMyColorDialog&&e.handleOpenMyColorDialog(...a))},[Ma(o,{color:"#808080"},{default:Aa((()=>[Ma(B)])),_:1})])])),_:1})])])):Ta("v-if",!0),0===e.currentTool?(Ba(),Ia("div",Lr,[Sr,Ma($,{modelValue:e.brushSize,"onUpdate:modelValue":a[57]||(a[57]=a=>e.brushSize=a),step:1,max:5,min:1,size:"small","show-stops":""},null,8,["modelValue"])])):1===e.currentTool?(Ba(),Ia("div",br,[kr,Ma($,{modelValue:e.eraserSize,"onUpdate:modelValue":a[58]||(a[58]=a=>e.eraserSize=a),step:1,max:5,min:1,size:"small","show-stops":""},null,8,["modelValue"])])):Ta("v-if",!0),$a("div",Rr,[$a("div",Ir,[Mr,Ma(O,{modelValue:e.isCheckedRatio,"onUpdate:modelValue":a[59]||(a[59]=a=>e.isCheckedRatio=a),size:"small",label:"保持横纵比",onChange:e.handleChangeRatio,disabled:e.pinDouMode},null,8,["modelValue","onChange","disabled"])]),$a("div",Ar,[Ma(E,{modelValue:e.canvasWidth,"onUpdate:modelValue":a[60]||(a[60]=a=>e.canvasWidth=a),style:{"max-width":"100px"},type:"number",max:e.$config.canvasMaxSize,min:e.$config.canvasMinSize,size:"small",onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,disabled:e.pinDouMode||e.isScaling||e.selectData.selectList.length||7===e.currentTool,onChange:a[61]||(a[61]=a=>e.handleChangeCanvasSize(a,"canvasWidth"))},{prepend:Aa((()=>[Fr])),_:1},8,["modelValue","max","min","onFocus","onBlur","disabled"]),Ma(E,{modelValue:e.canvasHeight,"onUpdate:modelValue":a[62]||(a[62]=a=>e.canvasHeight=a),style:{"max-width":"100px"},type:"number",max:e.$config.canvasMaxSize,min:e.$config.canvasMinSize,onFocus:e.handleCancelKeyboardEvent,onBlur:e.addKeyBoardEvent,size:"small",disabled:e.pinDouMode||e.isScaling||e.selectData.selectList.length||7===e.currentTool,onChange:a[63]||(a[63]=a=>e.handleChangeCanvasSize(a,"canvasHeight"))},{prepend:Aa((()=>[Tr])),_:1},8,["modelValue","max","min","onFocus","onBlur","disabled"])]),$a("div",Pr,[Ma(O,{modelValue:e.isShowRuler,"onUpdate:modelValue":a[64]||(a[64]=a=>e.isShowRuler=a),size:"small",label:"显示标尺"},null,8,["modelValue"]),Ma(O,{modelValue:e.isShowReferenceLine,"onUpdate:modelValue":a[65]||(a[65]=a=>e.isShowReferenceLine=a),size:"small",label:"显示参考线"},null,8,["modelValue"]),Ma(O,{modelValue:e.isShowGridLine,"onUpdate:modelValue":a[66]||(a[66]=a=>e.isShowGridLine=a),size:"small",label:"显示网格线"},null,8,["modelValue"])]),Wa($a("div",Er,[Ma(O,{modelValue:e.isHorizontal,"onUpdate:modelValue":a[67]||(a[67]=a=>e.isHorizontal=a),size:"small",label:"水平对称",disabled:e.pinDouMode,onChange:a[68]||(a[68]=a=>e.handleChangeBrushSymmetric(a,"isHorizontal"))},null,8,["modelValue","disabled"]),Ma(O,{modelValue:e.isVertical,"onUpdate:modelValue":a[69]||(a[69]=a=>e.isVertical=a),size:"small",label:"垂直对称",disabled:e.pinDouMode,onChange:a[70]||(a[70]=a=>e.handleChangeBrushSymmetric(a,"isVertical"))},null,8,["modelValue","disabled"]),Ma(O,{modelValue:e.isCenter,"onUpdate:modelValue":a[71]||(a[71]=a=>e.isCenter=a),size:"small",label:"中心对称",disabled:e.pinDouMode,onChange:a[72]||(a[72]=a=>e.handleChangeBrushSymmetric(a,"isCenter"))},null,8,["modelValue","disabled"])],512),[[Ya,0===e.currentTool||1===e.currentTool]])]),Wa($a("div",Br,[$r,Ma(H,{modelValue:e.tolerance,"onUpdate:modelValue":a[73]||(a[73]=a=>e.tolerance=a),min:0,max:200,size:"small"},null,8,["modelValue"])],512),[[Ya,[2,4].includes(e.currentTool)||8===e.currentTool&&"quickSelect"===e.selectType]]),$a("div",Or,[Hr,Ma(H,{modelValue:e.layerAlpha,"onUpdate:modelValue":a[74]||(a[74]=a=>e.layerAlpha=a),min:0,max:100,size:"small",disabled:e.pinDouMode||7===e.currentTool,onChange:e.handleChangeLayerAlpha},null,8,["modelValue","disabled","onChange"])]),$a("div",Nr,[e.selectData.selectList.length?(Ba(),Ia("div",Wr,[Ma(N,{type:"success",size:"small",onClick:e.handleCopySelectData},{default:Aa((()=>[Yr])),_:1},8,["onClick"]),Ma(N,{type:"danger",size:"small",onClick:e.handleRemoveSelect},{default:Aa((()=>[jr])),_:1},8,["onClick"]),Ma(N,{type:"primary",size:"small",onClick:e.handleCancelSelect},{default:Aa((()=>[zr])),_:1},8,["onClick"])])):Ta("v-if",!0),9===e.currentTool&&e.scaleAreaData?(Ba(),Ia("div",Vr,[Ma(N,{type:"danger",size:"small",onClick:e.handleCancelScale},{default:Aa((()=>[Ma(o,null,{default:Aa((()=>[Ma(W)])),_:1})])),_:1},8,["onClick"]),Ma(N,{type:"success",size:"small",onClick:e.handleFinishScale},{default:Aa((()=>[Ma(o,null,{default:Aa((()=>[Ma(Y)])),_:1})])),_:1},8,["onClick"])])):Ta("v-if",!0)])]),e.drawRecord.length?(Ba(),Ia("div",Xr,[$a("h1",Ur,[Kr,$a("div",Jr,[e.currentFrameLayerVisible?(Ba(),Fa(o,{key:0,style:{"margin-right":"15px"},class:"pointer",onClick:a[75]||(a[75]=a=>e.handleChangeLayerVisible(-1))},{default:Aa((()=>[Ma(j)])),_:1})):(Ba(),Fa(o,{key:1,style:{"margin-right":"15px"},class:"pointer",onClick:a[76]||(a[76]=a=>e.handleChangeLayerVisible(-1))},{default:Aa((()=>[Ma(z)])),_:1})),Ma(d,{content:"合并图层 [Ctrl/⌘ + Alt/⌥ + h]",placement:"top"},{default:Aa((()=>[Ma(o,{style:{"margin-right":"15px"},class:"pointer",onClick:e.handleLayerMerge},{default:Aa((()=>[Ma(V)])),_:1},8,["onClick"])])),_:1}),Ma(d,{content:"新建图层 [Ctrl/⌘ + Alt/⌥ + t]",placement:"top"},{default:Aa((()=>[Ma(o,{style:{"margin-right":"10px"},class:"pointer",onClick:e.handleAddLayer},{default:Aa((()=>[Ma(X)])),_:1},8,["onClick"])])),_:1})])]),Ma(I,{"border-style":"dashed"}),$a("div",{ref:"layerBox",id:"layer-box",class:"scrollbar scrollY full-w layer-list",onDragstart:a[79]||(a[79]=a=>e.onDragStart(a,e.pinDouMode)),onDragover:a[80]||(a[80]=a=>e.onDragOver(a,"layerBox")),onDragend:a[81]||(a[81]=a=>e.onDragLayerEnd(a,"layerBox")),style:{height:"calc(100% - 50px)"}},[Ta(' <el-dropdown\r\n                            draggable="true"\r\n                            class="full-w"\r\n                            trigger="contextmenu"\r\n                            v-for="(item, index) in drawRecord[currentFrameIndex].layer"\r\n                            :data-key="item.layerId"\r\n                            :disabled="pinDouMode"\r\n                            data-node="LI"\r\n                            :key="item.layerId" > '),(Ba(!0),Ia(ja,null,za(e.drawRecord[e.currentFrameIndex].layer,((t,r)=>(Ba(),Ia("div",{draggable:"true","data-key":t.layerId,disabled:e.pinDouMode,"data-node":"LI",key:t.layerId,class:Na(["layer-item flex-between pointer full-w",{active:e.currentLayerIndex===r,select:e.selectLayerList.includes(r)}]),style:{gap:"10px"},onContextmenu:Xa((a=>e.handleMenu(a,"LayerMenu",{layerData:t,index:r,currentFrameIndex:e.currentFrameIndex})),["prevent"]),onClick:a=>e.handleChangeLayer(r)},[$a("div",Gr,[$a("div",{class:"pointer layer-pic",onClick:Xa((a=>e.handleChangeLayerVisible(r)),["stop"])},[$a("img",{src:e.requireVisibleImg(t.isRender)},null,8,Zr)],8,qr),t.currentLayerImg?(Ba(),Ia("div",Qr,[$a("img",{draggable:"false",src:t.currentLayerImg},null,8,el)])):Ta("v-if",!0),e.currentEditLayer.index===r?(Ba(),Ia("div",al,[Ma(E,{modelValue:e.currentEditLayer.name,"onUpdate:modelValue":a[77]||(a[77]=a=>e.currentEditLayer.name=a),maxlength:10,onClick:Xa((e=>null),["stop"]),onBlur:e.handleEditLayerName,onKeyup:Va(e.handleEditLayerName,["enter"]),placeholder:"请输入图层名称",size:"small"},null,8,["modelValue","onClick","onBlur","onKeyup"])])):(Ba(),Ia("div",{key:2,onDblclick:a=>e.handleDoubleClickLayer(r,t.layerName),title:t.layerName,class:"oneline"},Ha(t.layerName),41,tl))]),$a("div",rl,[t.isLock?(Ba(),Fa(o,{key:0,style:{"margin-right":"10px"},color:"#ff0000",class:"pointer",onClick:Xa((a=>e.handleLockLayer(r,!1)),["stop"])},{default:Aa((()=>[Ma(U)])),_:2},1032,["onClick"])):(Ba(),Fa(o,{key:1,style:{"margin-right":"10px"},class:"pointer",onClick:Xa((a=>e.handleLockLayer(r,!0)),["stop"])},{default:Aa((()=>[Ma(K)])),_:2},1032,["onClick"])),Ma(o,{style:{"margin-right":"10px"},class:"pointer",onClick:Xa((a=>e.handleCopyLayer(r)),["stop"])},{default:Aa((()=>[Ma(J)])),_:2},1032,["onClick"]),Ma(G,{title:"确认删除该图层？",width:"200",onConfirm:a=>e.handleDeleteLayer(r)},{reference:Aa((()=>[r!==e.drawRecord[e.currentFrameIndex].layer.length-1?(Ba(),Fa(o,{key:0,class:"pointer",onClick:a[78]||(a[78]=Xa((()=>{}),["stop"]))},{default:Aa((()=>[Ma(_)])),_:1})):Ta("v-if",!0)])),_:2},1032,["onConfirm"])])],42,_r)))),128)),Ta(' <template #dropdown>\r\n                                    <el-dropdown-menu>\r\n                                        <el-dropdown-item @click="handleImportLayer(index)">导入图像</el-dropdown-item>\r\n                                        <el-dropdown-item @click="handleExportLayer(currentFrameIndex, index)">导出为图像</el-dropdown-item>\r\n                                    </el-dropdown-menu>\r\n                                </template>\r\n                            </el-dropdown> ')],544)])):Ta("v-if",!0)])])),_:1})])),_:1}),(Ba(),Fa(Pa,{to:"body"},[Ma(Q,{ref:"MyColorDialog",onClose:e.addKeyBoardEvent,onDelete:a[82]||(a[82]=a=>e.currentColorGroup=1),onSelect:a[83]||(a[83]=a=>e.brushColor=a)},null,8,["onClose"]),Ma(ee,{onClose:e.addKeyBoardEvent,ref:"ReplaceColorDialog",onConfirm:e.handleConfirmReplaceColor},null,8,["onClose","onConfirm"]),e.exportVisible?(Ba(),Fa(ae,{key:0,loading:e.exportLoaidng,visible:e.exportVisible,isExportProject:e.isExportProject,canvasOptions:{canvasWidth:e.canvasWidth,canvasHeight:e.canvasHeight},onExport:e.handleExport,onClose:a[84]||(a[84]=a=>e.handleCloseDialog("exportVisible"))},null,8,["loading","visible","isExportProject","canvasOptions","onExport"])):Ta("v-if",!0),Ma(te,{ref:"PreviewAnimDialog"},null,512),Ma(re,{ref:"PindouDialog",canvasOptions:{width:e.canvasWidth,height:e.canvasHeight,isLargeCanvas:0},onBlockHighlight:e.handlePindouBlockHighlight,onClose:e.handleCloseDialog,onChange:e.handlePindouEvent,onReplace:e.handleReplacePindouColor,onHighlight:e.handlePindouHighlight,onSelect:e.handleChangeBrushColor,onRemoveKeyBoard:e.handleCancelKeyboardEvent,onAddKeyBoard:e.addKeyBoardEvent,onHide:a[85]||(a[85]=a=>e.isHidePindouMode=!0),onExportExcel:e.handleExportPindouToExcel,onSave:e.handleTransformColorToPindou,onExport:e.handleExportPindou},null,8,["canvasOptions","onBlockHighlight","onClose","onChange","onReplace","onHighlight","onSelect","onRemoveKeyBoard","onAddKeyBoard","onExportExcel","onSave","onExport"]),e.LayerMenu.visible?(Ba(),Fa(le,{key:1,visible:e.LayerMenu.visible,left:e.LayerMenu.left,top:e.LayerMenu.top,contextData:e.LayerMenu.contextData,onCopy:e.handleCopyLayerData,onPaste:e.handlePasteLayerData,onImport:e.handleImportImage,onExport:e.handleExportLayer},null,8,["visible","left","top","contextData","onCopy","onPaste","onImport","onExport"])):Ta("v-if",!0),e.MyColorMenu.visible?(Ba(),Fa(ne,{key:2,visible:e.MyColorMenu.visible,left:e.MyColorMenu.left,top:e.MyColorMenu.top,contextData:e.MyColorMenu.contextData,onCopy:a[86]||(a[86]=a=>e.handleCopyColor(a)),onEdit:e.handleEditMyColor,onDelete:e.handleDeleteMyColor},null,8,["visible","left","top","contextData","onEdit","onDelete"])):Ta("v-if",!0),Ma(se,{ref:"LinmoModeDialog",onClose:e.handleCloseDialog,onUpload:a[87]||(a[87]=a=>e.linmoPhoto=a),onUpdate:a[88]||(a[88]=a=>e.linmoPhotoStyle=a),onColor:a[89]||(a[89]=a=>e.brushColor=a),onHide:a[90]||(a[90]=a=>e.isHideLinmoMode=!0),onLock:e.handleLinmoFitCanvas,onHigh:a[91]||(a[91]=a=>e.isHighPreview=a)},null,8,["onClose","onLock"]),e.importLayerVisible?(Ba(),Fa(oe,{key:3,visible:e.importLayerVisible,onImport:e.handleImportImageLayer,onClose:a[92]||(a[92]=a=>e.handleCloseDialog("importLayerVisible"))},null,8,["visible","onImport"])):Ta("v-if",!0),Ma(he,{modelValue:e.addMyColorVisible,"onUpdate:modelValue":a[99]||(a[99]=a=>e.addMyColorVisible=a),width:"300",title:e.editMyColorMask?"修改颜色":"添加颜色","append-to-body":"",class:"z-dialog"},{footer:Aa((()=>[$a("div",cl,[Ma(N,{onClick:a[98]||(a[98]=a=>e.addMyColorVisible=!1)},{default:Aa((()=>[dl])),_:1}),Ma(N,{type:"primary",onClick:e.handleAddColor},{default:Aa((()=>[hl])),_:1},8,["onClick"])])])),default:Aa((()=>[$a("div",ll,[Ma(ie,{modelValue:e.myColor,"onUpdate:modelValue":a[93]||(a[93]=a=>e.myColor=a),"show-alpha":""},null,8,["modelValue"]),Ma(de,{modelValue:e.myColorGroup,"onUpdate:modelValue":a[97]||(a[97]=a=>e.myColorGroup=a),placeholder:"选择分组",style:{width:"200px"}},{footer:Aa((()=>[e.isAddGroup?(Ba(),Ia(ja,{key:1},[Ma(E,{modelValue:e.myGroupName,"onUpdate:modelValue":a[95]||(a[95]=a=>e.myGroupName=a),class:"option-input",placeholder:"请输入分组",size:"small",maxlength:"10"},null,8,["modelValue"]),$a("div",sl,[Ma(N,{size:"small",onClick:a[96]||(a[96]=a=>{e.myGroupName="",e.isAddGroup=!1})},{default:Aa((()=>[ol])),_:1}),Ma(N,{type:"primary",size:"small",onClick:e.addColorGroup},{default:Aa((()=>[il])),_:1},8,["onClick"])])],64)):(Ba(),Fa(N,{key:0,text:"",bg:"",size:"small",onClick:a[94]||(a[94]=a=>e.isAddGroup=!0)},{default:Aa((()=>[nl])),_:1}))])),default:Aa((()=>[(Ba(!0),Ia(ja,null,za(e.editSpaceStore.myColorList,(e=>(Ba(),Fa(ce,{key:e.id,label:e.groupName,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])])),_:1},8,["modelValue","title"])]))],4)}],["__scopeId","data-v-39277fee"],["__file","D:/project/pixel-grid/src/views/work/index.vue"]]);export{gl as default};
